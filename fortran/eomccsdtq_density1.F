      SUBROUTINE eomccsdtq_density1(d_d1,d_i0,d_t1,d_t2,d_t3,d_t4,d_x0,d
     &_x1,d_x2,d_x3,d_x4,d_y0,d_y1,d_y2,d_y3,d_y4,k_d1_offset,k_i0_offse
     &t,k_t1_offset,k_t2_offset,k_t3_offset,k_t4_offset,k_x0_offset,k_x1
     &_offset,k_x2_offset,k_x3_offset,k_x4_offset,k_y0_offset,k_y1_offse
     &t,k_y2_offset,k_y3_offset,k_y4_offset)
C     $Id$
C     This is a Fortran77 program generated by Tensor Contraction Engine v.1.0
C     
C     
C     i0 ( )_yxd + = 1 * Sum ( h2 p1 ) * d ( p1 h2 )_d * i1 ( h2 p1 )_yx
C         i1 ( h2 p1 )_yx + = 1 * x ( )_x * y ( h2 p1 )_y
C         i1 ( h2 p1 )_yx + = 1 * Sum ( h4 p3 ) * x ( p3 h4 )_x * y ( h2 h4 p1 p3 )_y
C         i1 ( h2 p1 )_yx + = 1/4 * Sum ( h6 h5 p4 p3 ) * x ( p3 p4 h5 h6 )_x * y ( h2 h5 h6 p1 p3 p4 )_y
C         i1 ( h2 p1 )_yx + = 1/36 * Sum ( h8 h7 h6 p5 p4 p3 ) * x ( p3 p4 p5 h6 h7 h8 )_x * y ( h2 h6 h7 h8 p1 p3 p4 p5 )_y
C     i0 ( )_dxy + = 1 * y ( )_y * i1 ( )_dx
C         i1 ( )_dx + = 1 * Sum ( h1 p2 ) * d ( h1 p2 )_d * x ( p2 h1 )_x
C         i1 ( )_dtx + = 1 * x ( )_x * i2 ( )_dt
C             i2 ( )_dt + = 1 * Sum ( h1 p2 ) * d ( h1 p2 )_d * t ( p2 h1 )_t
C     i0 ( )_yxd + = -1 * Sum ( h2 h1 ) * d ( h1 h2 )_d * i1 ( h2 h1 )_yx
C         i1 ( h2 h1 )_yx + = 1 * Sum ( p3 ) * x ( p3 h1 )_x * y ( h2 p3 )_y
C         i1 ( h2 h1 )_yx + = 1/2 * Sum ( h5 p4 p3 ) * x ( p3 p4 h1 h5 )_x * y ( h2 h5 p3 p4 )_y
C         i1 ( h2 h1 )_yx + = 1/12 * Sum ( h7 h6 p5 p4 p3 ) * x ( p3 p4 p5 h1 h6 h7 )_x * y ( h2 h6 h7 p3 p4 p5 )_y
C         i1 ( h2 h1 )_yx + = 1/144 * Sum ( h9 h8 h7 p6 p5 p4 p3 ) * x ( p3 p4 p5 p6 h1 h7 h8 h9 )_x * y ( h2 h7 h8 h9 p3 p4 p5 p6 )_y
C         i1 ( h2 h1 )_ytx + = 1 * x ( )_x * i2 ( h2 h1 )_yt
C             i2 ( h2 h1 )_yt + = 1 * Sum ( p3 ) * t ( p3 h1 )_t * y ( h2 p3 )_y
C             i2 ( h2 h1 )_yt + = 1/2 * Sum ( h5 p4 p3 ) * t ( p3 p4 h1 h5 )_t * y ( h2 h5 p3 p4 )_y
C             i2 ( h2 h1 )_yt + = 1/12 * Sum ( h7 h6 p5 p4 p3 ) * t ( p3 p4 p5 h1 h6 h7 )_t * y ( h2 h6 h7 p3 p4 p5 )_y
C             i2 ( h2 h1 )_yt + = 1/144 * Sum ( h9 h8 h7 p6 p5 p4 p3 ) * t ( p3 p4 p5 p6 h1 h7 h8 h9 )_t * y ( h2 h7 h8 h9 p3 p4 p5 p6 )_y
C         i1 ( h2 h1 )_yxt + = 1 * Sum ( p3 ) * t ( p3 h1 )_t * i2 ( h2 p3 )_yx
C             i2 ( h2 p3 )_yx + = 1 * Sum ( h5 p4 ) * x ( p4 h5 )_x * y ( h2 h5 p3 p4 )_y
C             i2 ( h2 p3 )_yx + = 1/4 * Sum ( h7 h6 p5 p4 ) * x ( p4 p5 h6 h7 )_x * y ( h2 h6 h7 p3 p4 p5 )_y
C             i2 ( h2 p3 )_yx + = 1/36 * Sum ( h9 h8 h7 p6 p5 p4 ) * x ( p4 p5 p6 h7 h8 h9 )_x * y ( h2 h7 h8 h9 p3 p4 p5 p6 )_y
C         i1 ( h2 h1 )_yxt + = 1/2 * Sum ( h5 p3 p4 ) * t ( p3 p4 h1 h5 )_t * i2 ( h2 h5 p3 p4 )_yx
C             i2 ( h2 h5 p3 p4 )_yx + = 1 * Sum ( h7 p6 ) * x ( p6 h7 )_x * y ( h2 h5 h7 p3 p4 p6 )_y
C             i2 ( h2 h5 p3 p4 )_yx + = 1/4 * Sum ( h9 h8 p7 p6 ) * x ( p6 p7 h8 h9 )_x * y ( h2 h5 h8 h9 p3 p4 p6 p7 )_y
C         i1 ( h2 h1 )_yxt + = 1/12 * Sum ( h6 h7 p3 p4 p5 ) * t ( p3 p4 p5 h1 h6 h7 )_t * i2 ( h2 h6 h7 p3 p4 p5 )_yx
C             i2 ( h2 h6 h7 p3 p4 p5 )_yx + = 1 * Sum ( h9 p8 ) * x ( p8 h9 )_x * y ( h2 h6 h7 h9 p3 p4 p5 p8 )_y
C     i0 ( )_dxy + = 1 * Sum ( p1 h3 ) * y ( h3 p1 )_y * i1 ( p1 h3 )_dx
C         i1 ( p1 h3 )_dx + = 1 * Sum ( p2 ) * d ( p1 p2 )_d * x ( p2 h3 )_x
C         i1 ( p1 h3 )_dtx + = 1 * x ( )_x * i2 ( p1 h3 )_dt
C             i2 ( p1 h3 )_dt + = 1 * Sum ( p2 ) * d ( p1 p2 )_d * t ( p2 h3 )_t
C     i0 ( )_yxd + = 1 * Sum ( p12 h11 ) * d ( h11 p12 )_d * i1 ( p12 h11 )_yx
C         i1 ( p12 h11 )_yx + = 1 * Sum ( h4 p3 ) * x ( p3 p12 h4 h11 )_x * y ( h4 p3 )_y
C         i1 ( p12 h11 )_yx + = 1/4 * Sum ( h6 h5 p4 p3 ) * x ( p3 p4 p12 h5 h6 h11 )_x * y ( h5 h6 p3 p4 )_y
C         i1 ( p12 h11 )_yx + = 1/36 * Sum ( h8 h7 h6 p5 p4 p3 ) * x ( p3 p4 p5 p12 h6 h7 h8 h11 )_x * y ( h6 h7 h8 p3 p4 p5 )_y
C         i1 ( p12 h11 )_yxt + = -1 * Sum ( h2 ) * t ( p12 h2 )_t * i2 ( h2 h11 )_yx
C             i2 ( h2 h11 )_yx + = 1 * Sum ( p4 ) * x ( p4 h11 )_x * y ( h2 p4 )_y
C             i2 ( h2 h11 )_yx + = -1/2 * Sum ( h6 p5 p4 ) * x ( p4 p5 h6 h11 )_x * y ( h2 h6 p4 p5 )_y
C             i2 ( h2 h11 )_yx + = 1/12 * Sum ( h8 h7 p6 p5 p4 ) * x ( p4 p5 p6 h7 h8 h11 )_x * y ( h2 h7 h8 p4 p5 p6 )_y
C             i2 ( h2 h11 )_yx + = -1/144 * Sum ( h10 h9 h8 p7 p6 p5 p4 ) * x ( p4 p5 p6 p7 h8 h9 h10 h11 )_x * y ( h2 h8 h9 h10 p4 p5 p6 p7 )_y
C             i2 ( h2 h11 )_ytx + = 1 * x ( )_x * i3 ( h2 h11 )_yt
C                 i3 ( h2 h11 )_yt + = 1 * Sum ( p3 ) * t ( p3 h11 )_t * y ( h2 p3 )_y
C                 i3 ( h2 h11 )_yt + = -1/2 * Sum ( h5 p4 p3 ) * t ( p3 p4 h5 h11 )_t * y ( h2 h5 p3 p4 )_y
C                 i3 ( h2 h11 )_yt + = 1/12 * Sum ( h7 h6 p5 p4 p3 ) * t ( p3 p4 p5 h6 h7 h11 )_t * y ( h2 h6 h7 p3 p4 p5 )_y
C                 i3 ( h2 h11 )_yt + = -1/144 * Sum ( h9 h8 h7 p6 p5 p4 p3 ) * t ( p3 p4 p5 p6 h7 h8 h9 h11 )_t * y ( h2 h7 h8 h9 p3 p4 p5 p6 )_y
C             i2 ( h2 h11 )_yxt + = 1 * Sum ( p3 ) * t ( p3 h11 )_t * i3 ( h2 p3 )_yx
C                 i3 ( h2 p3 )_yx + = 1 * Sum ( h6 p5 ) * x ( p5 h6 )_x * y ( h2 h6 p3 p5 )_y
C                 i3 ( h2 p3 )_yx + = 1/4 * Sum ( h8 h7 p6 p5 ) * x ( p5 p6 h7 h8 )_x * y ( h2 h7 h8 p3 p5 p6 )_y
C                 i3 ( h2 p3 )_yx + = 1/36 * Sum ( h10 h9 h8 p7 p6 p5 ) * x ( p5 p6 p7 h8 h9 h10 )_x * y ( h2 h8 h9 h10 p3 p5 p6 p7 )_y
C             i2 ( h2 h11 )_yxt + = 1/2 * Sum ( h5 p3 p4 ) * t ( p3 p4 h5 h11 )_t * i3 ( h2 h5 p3 p4 )_yx
C                 i3 ( h2 h5 p3 p4 )_yx + = -1 * Sum ( h8 p7 ) * x ( p7 h8 )_x * y ( h2 h5 h8 p3 p4 p7 )_y
C                 i3 ( h2 h5 p3 p4 )_yx + = -1/4 * Sum ( h10 h9 p8 p7 ) * x ( p7 p8 h9 h10 )_x * y ( h2 h5 h9 h10 p3 p4 p7 p8 )_y
C             i2 ( h2 h11 )_yxt + = 1/12 * Sum ( h6 h7 p3 p4 p5 ) * t ( p3 p4 p5 h6 h7 h11 )_t * i3 ( h2 h6 h7 p3 p4 p5 )_yx
C                 i3 ( h2 h6 h7 p3 p4 p5 )_yx + = 1 * Sum ( h10 p9 ) * x ( p9 h10 )_x * y ( h2 h6 h7 h10 p3 p4 p5 p9 )_y
C         i1 ( p12 h11 )_ytx + = -1 * Sum ( h1 ) * x ( p12 h1 )_x * i2 ( h1 h11 )_yt
C             i2 ( h1 h11 )_yt + = 1 * Sum ( p3 ) * t ( p3 h11 )_t * y ( h1 p3 )_y
C             i2 ( h1 h11 )_yt + = -1/2 * Sum ( h5 p4 p3 ) * t ( p3 p4 h5 h11 )_t * y ( h1 h5 p3 p4 )_y
C             i2 ( h1 h11 )_yt + = 1/12 * Sum ( h7 h6 p5 p4 p3 ) * t ( p3 p4 p5 h6 h7 h11 )_t * y ( h1 h6 h7 p3 p4 p5 )_y
C             i2 ( h1 h11 )_yt + = -1/144 * Sum ( h9 h8 h7 p6 p5 p4 p3 ) * t ( p3 p4 p5 p6 h7 h8 h9 h11 )_t * y ( h1 h7 h8 h9 p3 p4 p5 p6 )_y
C         i1 ( p12 h11 )_yxt + = 1 * t ( p12 h11 )_t * i2 ( )_yx
C             i2 ( )_yx + = 1 * Sum ( h4 p3 ) * x ( p3 h4 )_x * y ( h4 p3 )_y
C             i2 ( )_yx + = 1/4 * Sum ( h6 h5 p4 p3 ) * x ( p3 p4 h5 h6 )_x * y ( h5 h6 p3 p4 )_y
C             i2 ( )_yx + = 1/36 * Sum ( h8 h7 h6 p5 p4 p3 ) * x ( p3 p4 p5 h6 h7 h8 )_x * y ( h6 h7 h8 p3 p4 p5 )_y
C             i2 ( )_yx + = 1/576 * Sum ( h10 h9 h8 h7 p6 p5 p4 p3 ) * x ( p3 p4 p5 p6 h7 h8 h9 h10 )_x * y ( h7 h8 h9 h10 p3 p4 p5 p6 )_y
C         i1 ( p12 h11 )_ytx + = -1/2 * Sum ( h1 h2 p13 ) * x ( p12 p13 h1 h2 )_x * i2 ( h1 h2 h11 p13 )_yt
C             i2 ( h1 h2 h11 p13 )_yt + = 1 * Sum ( p3 ) * t ( p3 h11 )_t * y ( h1 h2 p3 p13 )_y
C             i2 ( h1 h2 h11 p13 )_yt + = 1/2 * Sum ( h5 p4 p3 ) * t ( p3 p4 h5 h11 )_t * y ( h1 h2 h5 p3 p4 p13 )_y
C             i2 ( h1 h2 h11 p13 )_yt + = 1/12 * Sum ( h7 h6 p5 p4 p3 ) * t ( p3 p4 p5 h6 h7 h11 )_t * y ( h1 h2 h6 h7 p3 p4 p5 p13 )_y
C         i1 ( p12 h11 )_ytx + = -1/12 * Sum ( h13 h6 h7 p1 p2 ) * x ( p1 p2 p12 h6 h7 h13 )_x * i2 ( h6 h7 h13 h11 p1 p2 )_yt
C             i2 ( h6 h7 h13 h11 p1 p2 )_yt + = 1 * Sum ( p3 ) * t ( p3 h11 )_t * y ( h6 h7 h13 p1 p2 p3 )_y
C             i2 ( h6 h7 h13 h11 p1 p2 )_yt + = 1/2 * Sum ( h5 p4 p3 ) * t ( p3 p4 h5 h11 )_t * y ( h5 h6 h7 h13 p1 p2 p3 p4 )_y
C         i1 ( p12 h11 )_ytx + = 1/144 * Sum ( h7 h8 h9 h10 p4 p5 p6 ) * x ( p4 p5 p6 p12 h7 h8 h9 h10 )_x * i2 ( h7 h8 h9 h10 h11 p4 p5 p6 )_yt
C             i2 ( h7 h8 h9 h10 h11 p4 p5 p6 )_yt + = 1 * Sum ( p3 ) * t ( p3 h11 )_t * y ( h7 h8 h9 h10 p3 p4 p5 p6 )_y
C         i1 ( p12 h11 )_yxt + = 1 * Sum ( h4 p3 ) * t ( p3 p12 h4 h11 )_t * i2 ( h4 p3 )_yx
C             i2 ( h4 p3 )_yx + = 1 * x ( )_x * y ( h4 p3 )_y
C             i2 ( h4 p3 )_yx + = 1 * Sum ( h6 p5 ) * x ( p5 h6 )_x * y ( h4 h6 p3 p5 )_y
C             i2 ( h4 p3 )_yx + = 1/4 * Sum ( h8 h7 p6 p5 ) * x ( p5 p6 h7 h8 )_x * y ( h4 h7 h8 p3 p5 p6 )_y
C             i2 ( h4 p3 )_yx + = 1/36 * Sum ( h10 h9 h8 p7 p6 p5 ) * x ( p5 p6 p7 h8 h9 h10 )_x * y ( h4 h8 h9 h10 p3 p5 p6 p7 )_y
C         i1 ( p12 h11 )_yxt + = -1/2 * Sum ( h2 h1 p13 ) * t ( p12 p13 h1 h2 )_t * i2 ( h1 h2 h11 p13 )_yx
C             i2 ( h1 h2 h11 p13 )_yx + = 1 * Sum ( p6 ) * x ( p6 h11 )_x * y ( h1 h2 p6 p13 )_y
C             i2 ( h1 h2 h11 p13 )_yx + = 1/2 * Sum ( h8 p7 p6 ) * x ( p6 p7 h8 h11 )_x * y ( h1 h2 h8 p6 p7 p13 )_y
C             i2 ( h1 h2 h11 p13 )_yx + = 1/12 * Sum ( h10 h9 p8 p7 p6 ) * x ( p6 p7 p8 h9 h10 h11 )_x * y ( h1 h2 h9 h10 p6 p7 p8 p13 )_y
C             i2 ( h1 h2 h11 p13 )_yxt + = -5/18 * Sum ( h7 p5 p6 ) * t ( p5 p6 h7 h11 )_t * i3 ( h1 h2 h7 p5 p6 p13 )_yx
C                 i3 ( h1 h2 h7 p5 p6 p13 )_yx + = 1 * Sum ( h10 p9 ) * x ( p9 h10 )_x * i4 ( h1 h2 h7 h10 p5 p6 p9 p13 )_y
C                     i4 ( h1 h2 h7 h10 p5 p6 p9 p13 )_y + = 1 * y ( h1 h2 h7 h10 p5 p6 p9 p13 )_y
C                     i4 ( h1 h2 h7 h10 p5 p6 p9 p13 )_y + = 4/5 * y ( h1 h2 h7 h10 p5 p6 p9 p13 )_y
C         i1 ( p12 h11 )_ytx + = 1/4 * x ( )_x * i2 ( p12 h11 )_yt
C             i2 ( p12 h11 )_yt + = 1 * Sum ( h6 h5 p4 p3 ) * t ( p3 p4 p12 h5 h6 h11 )_t * y ( h5 h6 p3 p4 )_y
C             i2 ( p12 h11 )_yt + = 1/9 * Sum ( h8 h7 h6 p5 p4 p3 ) * t ( p3 p4 p5 p12 h6 h7 h8 h11 )_t * y ( h6 h7 h8 p3 p4 p5 )_y
C             i2 ( p12 h11 )_ytt + = 2 * Sum ( h13 h2 p8 ) * t ( p8 p12 h2 h13 )_t * i3 ( h2 h13 h11 p8 )_yt
C                 i3 ( h2 h13 h11 p8 )_yt + = 1 * Sum ( p6 ) * t ( p6 h11 )_t * y ( h2 h13 p6 p8 )_y
C                 i3 ( h2 h13 h11 p8 )_yt + = -5/18 * Sum ( h7 p6 p5 ) * t ( p5 p6 h7 h11 )_t * i4 ( h2 h7 h13 p5 p6 p8 )_y
C                     i4 ( h2 h7 h13 p5 p6 p8 )_y + = 1 * y ( h2 h7 h13 p5 p6 p8 )_y
C                     i4 ( h2 h7 h13 p5 p6 p8 )_y + = 4/5 * y ( h2 h7 h13 p5 p6 p8 )_y
C                 i3 ( h2 h13 h11 p8 )_yt + = 1/12 * Sum ( h7 h6 p5 p4 p3 ) * t ( p3 p4 p5 h6 h7 h11 )_t * y ( h2 h6 h7 h13 p3 p4 p5 p8 )_y
C             i2 ( p12 h11 )_ytt + = -1/3 * Sum ( h5 h6 h7 p3 p4 ) * t ( p3 p4 p12 h5 h6 h7 )_t * i3 ( h5 h6 h7 h11 p3 p4 )_yt
C                 i3 ( h5 h6 h7 h11 p3 p4 )_yt + = 1 * Sum ( p8 ) * t ( p8 h11 )_t * y ( h5 h6 h7 p3 p4 p8 )_y
C                 i3 ( h5 h6 h7 h11 p3 p4 )_yt + = -1/2 * Sum ( h10 p9 p8 ) * t ( p8 p9 h10 h11 )_t * y ( h5 h6 h7 h10 p3 p4 p8 p9 )_y
C             i2 ( p12 h11 )_ytt + = -1/36 * Sum ( h6 h7 h8 h9 p3 p4 p5 ) * t ( p3 p4 p5 p12 h6 h7 h8 h9 )_t * i3 ( h6 h7 h8 h9 h11 p3 p4 p5 )_yt
C                 i3 ( h6 h7 h8 h9 h11 p3 p4 p5 )_yt + = 1 * Sum ( p10 ) * t ( p10 h11 )_t * y ( h6 h7 h8 h9 p3 p4 p5 p10 )_y
C         i1 ( p12 h11 )_yxt + = -1/12 * Sum ( h5 h6 h7 p3 p4 ) * t ( p3 p4 p12 h5 h6 h7 )_t * i2 ( h5 h6 h7 h11 p3 p4 )_yx
C             i2 ( h5 h6 h7 h11 p3 p4 )_yx + = 1 * Sum ( p8 ) * x ( p8 h11 )_x * y ( h5 h6 h7 p3 p4 p8 )_y
C             i2 ( h5 h6 h7 h11 p3 p4 )_yx + = -1/2 * Sum ( h10 p9 p8 ) * x ( p8 p9 h10 h11 )_x * y ( h5 h6 h7 h10 p3 p4 p8 p9 )_y
C         i1 ( p12 h11 )_yxt + = 1/4 * Sum ( h5 h6 p3 p4 ) * t ( p3 p4 p12 h5 h6 h11 )_t * i2 ( h5 h6 p3 p4 )_yx
C             i2 ( h5 h6 p3 p4 )_yx + = 1 * Sum ( h8 p7 ) * x ( p7 h8 )_x * y ( h5 h6 h8 p3 p4 p7 )_y
C             i2 ( h5 h6 p3 p4 )_yx + = 1/4 * Sum ( h10 h9 p8 p7 ) * x ( p7 p8 h9 h10 )_x * y ( h5 h6 h9 h10 p3 p4 p7 p8 )_y
C         i1 ( p12 h11 )_yxt + = -1/144 * Sum ( h6 h7 h8 h9 p3 p4 p5 ) * t ( p3 p4 p5 p12 h6 h7 h8 h9 )_t * i2 ( h6 h7 h8 h9 h11 p3 p4 p5 )_yx
C             i2 ( h6 h7 h8 h9 h11 p3 p4 p5 )_yx + = 1 * Sum ( p10 ) * x ( p10 h11 )_x * y ( h6 h7 h8 h9 p3 p4 p5 p10 )_y
C         i1 ( p12 h11 )_yxt + = 1/36 * Sum ( h6 h7 h8 p3 p4 p5 ) * t ( p3 p4 p5 p12 h6 h7 h8 h11 )_t * i2 ( h6 h7 h8 p3 p4 p5 )_yx
C             i2 ( h6 h7 h8 p3 p4 p5 )_yx + = 1 * Sum ( h10 p9 ) * x ( p9 h10 )_x * y ( h6 h7 h8 h10 p3 p4 p5 p9 )_y
C         i1 ( p12 h11 )_yxtt + = -1/2 * Sum ( p1 ) * t ( p1 h11 )_t * i2 ( p12 p1 )_yxt
C             i2 ( p12 p1 )_yxt + = 1 * Sum ( h4 h5 p3 ) * t ( p3 p12 h4 h5 )_t * i3 ( h4 h5 p1 p3 )_yx
C                 i3 ( h4 h5 p1 p3 )_yx + = -1 * Sum ( h8 p7 ) * x ( p7 h8 )_x * y ( h4 h5 h8 p1 p3 p7 )_y
C                 i3 ( h4 h5 p1 p3 )_yx + = -1/4 * Sum ( h10 h9 p8 p7 ) * x ( p7 p8 h9 h10 )_x * y ( h4 h5 h9 h10 p1 p3 p7 p8 )_y
C             i2 ( p12 p1 )_yxt + = 1/6 * Sum ( h5 h6 h7 p3 p4 ) * t ( p3 p4 p12 h5 h6 h7 )_t * i3 ( h5 h6 h7 p1 p3 p4 )_yx
C                 i3 ( h5 h6 h7 p1 p3 p4 )_yx + = 1 * Sum ( h10 p9 ) * x ( p9 h10 )_x * y ( h5 h6 h7 h10 p1 p3 p4 p9 )_y
C     i0 ( )_yxd + = -1/2 * Sum ( p2 p1 ) * d ( p1 p2 )_d * i1 ( p2 p1 )_yx
C         i1 ( p2 p1 )_yx + = -1 * Sum ( h5 h4 p3 ) * x ( p2 p3 h4 h5 )_x * y ( h4 h5 p1 p3 )_y
C         i1 ( p2 p1 )_yx + = -1/6 * Sum ( h7 h6 h5 p4 p3 ) * x ( p2 p3 p4 h5 h6 h7 )_x * y ( h5 h6 h7 p1 p3 p4 )_y
C         i1 ( p2 p1 )_yx + = -1/72 * Sum ( h9 h8 h7 h6 p5 p4 p3 ) * x ( p2 p3 p4 p5 h6 h7 h8 h9 )_x * y ( h6 h7 h8 h9 p1 p3 p4 p5 )_y
C         i1 ( p2 p1 )_yxt + = -2 * Sum ( h3 ) * t ( p2 h3 )_t * i2 ( h3 p1 )_yx
C             i2 ( h3 p1 )_yx + = 1 * Sum ( h5 p4 ) * x ( p4 h5 )_x * y ( h3 h5 p1 p4 )_y
C             i2 ( h3 p1 )_yx + = 1/4 * Sum ( h7 h6 p5 p4 ) * x ( p4 p5 h6 h7 )_x * y ( h3 h6 h7 p1 p4 p5 )_y
C             i2 ( h3 p1 )_yx + = 1/36 * Sum ( h9 h8 h7 p6 p5 p4 ) * x ( p4 p5 p6 h7 h8 h9 )_x * y ( h3 h7 h8 h9 p1 p4 p5 p6 )_y
C         i1 ( p2 p1 )_ytx + = 1 * x ( )_x * i2 ( p2 p1 )_yt
C             i2 ( p2 p1 )_yt + = -1 * Sum ( h5 h4 p3 ) * t ( p2 p3 h4 h5 )_t * y ( h4 h5 p1 p3 )_y
C             i2 ( p2 p1 )_yt + = -1/6 * Sum ( h7 h6 h5 p4 p3 ) * t ( p2 p3 p4 h5 h6 h7 )_t * y ( h5 h6 h7 p1 p3 p4 )_y
C             i2 ( p2 p1 )_yt + = -1/72 * Sum ( h9 h8 h7 h6 p5 p4 p3 ) * t ( p2 p3 p4 p5 h6 h7 h8 h9 )_t * y ( h6 h7 h8 h9 p1 p3 p4 p5 )_y
C         i1 ( p2 p1 )_yxt + = -1 * Sum ( h4 h5 p3 ) * t ( p2 p3 h4 h5 )_t * i2 ( h4 h5 p1 p3 )_yx
C             i2 ( h4 h5 p1 p3 )_yx + = 1 * Sum ( h7 p6 ) * x ( p6 h7 )_x * y ( h4 h5 h7 p1 p3 p6 )_y
C             i2 ( h4 h5 p1 p3 )_yx + = 1/4 * Sum ( h9 h8 p7 p6 ) * x ( p6 p7 h8 h9 )_x * y ( h4 h5 h8 h9 p1 p3 p6 p7 )_y
C         i1 ( p2 p1 )_yxt + = -1/6 * Sum ( h5 h6 h7 p3 p4 ) * t ( p2 p3 p4 h5 h6 h7 )_t * i2 ( h5 h6 h7 p1 p3 p4 )_yx
C             i2 ( h5 h6 h7 p1 p3 p4 )_yx + = 1 * Sum ( h9 p8 ) * x ( p8 h9 )_x * y ( h5 h6 h7 h9 p1 p3 p4 p8 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "util.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_i0
      INTEGER k_i0_offset
      INTEGER d_d1
      INTEGER k_d1_offset
      INTEGER d_i1
      INTEGER k_i1_offset
      INTEGER d_y0
      INTEGER k_y0_offset
      INTEGER d_y1
      INTEGER k_y1_offset
      INTEGER l_i1_offset
      INTEGER d_x0
      INTEGER k_x0_offset
      INTEGER d_x1
      INTEGER k_x1_offset
      INTEGER d_y2
      INTEGER k_y2_offset
      INTEGER d_x2
      INTEGER k_x2_offset
      INTEGER d_y3
      INTEGER k_y3_offset
      INTEGER d_x3
      INTEGER k_x3_offset
      INTEGER d_y4
      INTEGER k_y4_offset
      INTEGER d_i2
      INTEGER k_i2_offset
      INTEGER l_i2_offset
      INTEGER d_t1
      INTEGER k_t1_offset
      INTEGER d_x4
      INTEGER k_x4_offset
      INTEGER d_t2
      INTEGER k_t2_offset
      INTEGER d_t3
      INTEGER k_t3_offset
      INTEGER d_t4
      INTEGER k_t4_offset
      INTEGER d_i3
      INTEGER k_i3_offset
      INTEGER l_i3_offset
      INTEGER d_i4
      INTEGER k_i4_offset
      INTEGER l_i4_offset
      DOUBLE PRECISION size_i1
      DOUBLE PRECISION size_i2
      DOUBLE PRECISION size_i3
      DOUBLE PRECISION size_i4
      CHARACTER*255 filename
      CALL OFFSET_eomccsdtq_density1_1_1(l_i1_offset,k_i1_offset,size_i1
     &)
      CALL TCE_FILENAME('eomccsdtq_density1_1_1_i1',filename)
      CALL CREATEFILE(filename,d_i1,size_i1)
      CALL eomccsdtq_density1_1_1(d_x0,k_x0_offset,d_y1,k_y1_offset,d_i1
     &,k_i1_offset)
      CALL eomccsdtq_density1_1_2(d_x1,k_x1_offset,d_y2,k_y2_offset,d_i1
     &,k_i1_offset)
      CALL eomccsdtq_density1_1_3(d_x2,k_x2_offset,d_y3,k_y3_offset,d_i1
     &,k_i1_offset)
      CALL eomccsdtq_density1_1_4(d_x3,k_x3_offset,d_y4,k_y4_offset,d_i1
     &,k_i1_offset)
      CALL RECONCILEFILE(d_i1,size_i1)
      CALL eomccsdtq_density1_1(d_d1,k_d1_offset,d_i1,k_i1_offset,d_i0,k
     &_i0_offset)
      CALL DELETEFILE(d_i1)
      IF (.not.MA_POP_STACK(l_i1_offset)) CALL ERRQUIT('eomccsdtq_densit
     &y1',-1,MA_ERR)
      CALL OFFSET_eomccsdtq_density1_2_1(l_i1_offset,k_i1_offset,size_i1
     &)
      CALL TCE_FILENAME('eomccsdtq_density1_2_1_i1',filename)
      CALL CREATEFILE(filename,d_i1,size_i1)
      CALL eomccsdtq_density1_2_1(d_d1,k_d1_offset,d_x1,k_x1_offset,d_i1
     &,k_i1_offset)
      CALL OFFSET_eomccsdtq_density1_2_2_1(l_i2_offset,k_i2_offset,size_
     &i2)
      CALL TCE_FILENAME('eomccsdtq_density1_2_2_1_i2',filename)
      CALL CREATEFILE(filename,d_i2,size_i2)
      CALL eomccsdtq_density1_2_2_1(d_d1,k_d1_offset,d_t1,k_t1_offset,d_
     &i2,k_i2_offset)
      CALL RECONCILEFILE(d_i2,size_i2)
      CALL eomccsdtq_density1_2_2(d_x0,k_x0_offset,d_i2,k_i2_offset,d_i1
     &,k_i1_offset)
      CALL DELETEFILE(d_i2)
      IF (.not.MA_POP_STACK(l_i2_offset)) CALL ERRQUIT('eomccsdtq_densit
     &y1',-1,MA_ERR)
      CALL RECONCILEFILE(d_i1,size_i1)
      CALL eomccsdtq_density1_2(d_y0,k_y0_offset,d_i1,k_i1_offset,d_i0,k
     &_i0_offset)
      CALL DELETEFILE(d_i1)
      IF (.not.MA_POP_STACK(l_i1_offset)) CALL ERRQUIT('eomccsdtq_densit
     &y1',-1,MA_ERR)
      CALL OFFSET_eomccsdtq_density1_3_1(l_i1_offset,k_i1_offset,size_i1
     &)
      CALL TCE_FILENAME('eomccsdtq_density1_3_1_i1',filename)
      CALL CREATEFILE(filename,d_i1,size_i1)
      CALL eomccsdtq_density1_3_1(d_x1,k_x1_offset,d_y1,k_y1_offset,d_i1
     &,k_i1_offset)
      CALL eomccsdtq_density1_3_2(d_x2,k_x2_offset,d_y2,k_y2_offset,d_i1
     &,k_i1_offset)
      CALL eomccsdtq_density1_3_3(d_x3,k_x3_offset,d_y3,k_y3_offset,d_i1
     &,k_i1_offset)
      CALL eomccsdtq_density1_3_4(d_x4,k_x4_offset,d_y4,k_y4_offset,d_i1
     &,k_i1_offset)
      CALL OFFSET_eomccsdtq_density1_3_5_1(l_i2_offset,k_i2_offset,size_
     &i2)
      CALL TCE_FILENAME('eomccsdtq_density1_3_5_1_i2',filename)
      CALL CREATEFILE(filename,d_i2,size_i2)
      CALL eomccsdtq_density1_3_5_1(d_t1,k_t1_offset,d_y1,k_y1_offset,d_
     &i2,k_i2_offset)
      CALL eomccsdtq_density1_3_5_2(d_t2,k_t2_offset,d_y2,k_y2_offset,d_
     &i2,k_i2_offset)
      CALL eomccsdtq_density1_3_5_3(d_t3,k_t3_offset,d_y3,k_y3_offset,d_
     &i2,k_i2_offset)
      CALL eomccsdtq_density1_3_5_4(d_t4,k_t4_offset,d_y4,k_y4_offset,d_
     &i2,k_i2_offset)
      CALL RECONCILEFILE(d_i2,size_i2)
      CALL eomccsdtq_density1_3_5(d_x0,k_x0_offset,d_i2,k_i2_offset,d_i1
     &,k_i1_offset)
      CALL DELETEFILE(d_i2)
      IF (.not.MA_POP_STACK(l_i2_offset)) CALL ERRQUIT('eomccsdtq_densit
     &y1',-1,MA_ERR)
      CALL OFFSET_eomccsdtq_density1_3_6_1(l_i2_offset,k_i2_offset,size_
     &i2)
      CALL TCE_FILENAME('eomccsdtq_density1_3_6_1_i2',filename)
      CALL CREATEFILE(filename,d_i2,size_i2)
      CALL eomccsdtq_density1_3_6_1(d_x1,k_x1_offset,d_y2,k_y2_offset,d_
     &i2,k_i2_offset)
      CALL eomccsdtq_density1_3_6_2(d_x2,k_x2_offset,d_y3,k_y3_offset,d_
     &i2,k_i2_offset)
      CALL eomccsdtq_density1_3_6_3(d_x3,k_x3_offset,d_y4,k_y4_offset,d_
     &i2,k_i2_offset)
      CALL RECONCILEFILE(d_i2,size_i2)
      CALL eomccsdtq_density1_3_6(d_t1,k_t1_offset,d_i2,k_i2_offset,d_i1
     &,k_i1_offset)
      CALL DELETEFILE(d_i2)
      IF (.not.MA_POP_STACK(l_i2_offset)) CALL ERRQUIT('eomccsdtq_densit
     &y1',-1,MA_ERR)
      CALL OFFSET_eomccsdtq_density1_3_7_1(l_i2_offset,k_i2_offset,size_
     &i2)
      CALL TCE_FILENAME('eomccsdtq_density1_3_7_1_i2',filename)
      CALL CREATEFILE(filename,d_i2,size_i2)
      CALL eomccsdtq_density1_3_7_1(d_x1,k_x1_offset,d_y3,k_y3_offset,d_
     &i2,k_i2_offset)
      CALL eomccsdtq_density1_3_7_2(d_x2,k_x2_offset,d_y4,k_y4_offset,d_
     &i2,k_i2_offset)
      CALL RECONCILEFILE(d_i2,size_i2)
      CALL eomccsdtq_density1_3_7(d_t2,k_t2_offset,d_i2,k_i2_offset,d_i1
     &,k_i1_offset)
      CALL DELETEFILE(d_i2)
      IF (.not.MA_POP_STACK(l_i2_offset)) CALL ERRQUIT('eomccsdtq_densit
     &y1',-1,MA_ERR)
      CALL OFFSET_eomccsdtq_density1_3_8_1(l_i2_offset,k_i2_offset,size_
     &i2)
      CALL TCE_FILENAME('eomccsdtq_density1_3_8_1_i2',filename)
      CALL CREATEFILE(filename,d_i2,size_i2)
      CALL eomccsdtq_density1_3_8_1(d_x1,k_x1_offset,d_y4,k_y4_offset,d_
     &i2,k_i2_offset)
      CALL RECONCILEFILE(d_i2,size_i2)
      CALL eomccsdtq_density1_3_8(d_t3,k_t3_offset,d_i2,k_i2_offset,d_i1
     &,k_i1_offset)
      CALL DELETEFILE(d_i2)
      IF (.not.MA_POP_STACK(l_i2_offset)) CALL ERRQUIT('eomccsdtq_densit
     &y1',-1,MA_ERR)
      CALL RECONCILEFILE(d_i1,size_i1)
      CALL eomccsdtq_density1_3(d_d1,k_d1_offset,d_i1,k_i1_offset,d_i0,k
     &_i0_offset)
      CALL DELETEFILE(d_i1)
      IF (.not.MA_POP_STACK(l_i1_offset)) CALL ERRQUIT('eomccsdtq_densit
     &y1',-1,MA_ERR)
      CALL OFFSET_eomccsdtq_density1_4_1(l_i1_offset,k_i1_offset,size_i1
     &)
      CALL TCE_FILENAME('eomccsdtq_density1_4_1_i1',filename)
      CALL CREATEFILE(filename,d_i1,size_i1)
      CALL eomccsdtq_density1_4_1(d_d1,k_d1_offset,d_x1,k_x1_offset,d_i1
     &,k_i1_offset)
      CALL OFFSET_eomccsdtq_density1_4_2_1(l_i2_offset,k_i2_offset,size_
     &i2)
      CALL TCE_FILENAME('eomccsdtq_density1_4_2_1_i2',filename)
      CALL CREATEFILE(filename,d_i2,size_i2)
      CALL eomccsdtq_density1_4_2_1(d_d1,k_d1_offset,d_t1,k_t1_offset,d_
     &i2,k_i2_offset)
      CALL RECONCILEFILE(d_i2,size_i2)
      CALL eomccsdtq_density1_4_2(d_x0,k_x0_offset,d_i2,k_i2_offset,d_i1
     &,k_i1_offset)
      CALL DELETEFILE(d_i2)
      IF (.not.MA_POP_STACK(l_i2_offset)) CALL ERRQUIT('eomccsdtq_densit
     &y1',-1,MA_ERR)
      CALL RECONCILEFILE(d_i1,size_i1)
      CALL eomccsdtq_density1_4(d_y1,k_y1_offset,d_i1,k_i1_offset,d_i0,k
     &_i0_offset)
      CALL DELETEFILE(d_i1)
      IF (.not.MA_POP_STACK(l_i1_offset)) CALL ERRQUIT('eomccsdtq_densit
     &y1',-1,MA_ERR)
      CALL OFFSET_eomccsdtq_density1_5_1(l_i1_offset,k_i1_offset,size_i1
     &)
      CALL TCE_FILENAME('eomccsdtq_density1_5_1_i1',filename)
      CALL CREATEFILE(filename,d_i1,size_i1)
      CALL eomccsdtq_density1_5_1(d_x2,k_x2_offset,d_y1,k_y1_offset,d_i1
     &,k_i1_offset)
      CALL eomccsdtq_density1_5_2(d_x3,k_x3_offset,d_y2,k_y2_offset,d_i1
     &,k_i1_offset)
      CALL eomccsdtq_density1_5_3(d_x4,k_x4_offset,d_y3,k_y3_offset,d_i1
     &,k_i1_offset)
      CALL OFFSET_eomccsdtq_density1_5_4_1(l_i2_offset,k_i2_offset,size_
     &i2)
      CALL TCE_FILENAME('eomccsdtq_density1_5_4_1_i2',filename)
      CALL CREATEFILE(filename,d_i2,size_i2)
      CALL eomccsdtq_density1_5_4_1(d_x1,k_x1_offset,d_y1,k_y1_offset,d_
     &i2,k_i2_offset)
      CALL eomccsdtq_density1_5_4_2(d_x2,k_x2_offset,d_y2,k_y2_offset,d_
     &i2,k_i2_offset)
      CALL eomccsdtq_density1_5_4_3(d_x3,k_x3_offset,d_y3,k_y3_offset,d_
     &i2,k_i2_offset)
      CALL eomccsdtq_density1_5_4_4(d_x4,k_x4_offset,d_y4,k_y4_offset,d_
     &i2,k_i2_offset)
      CALL OFFSET_eomccsdtq_density1_5_4_5_1(l_i3_offset,k_i3_offset,siz
     &e_i3)
      CALL TCE_FILENAME('eomccsdtq_density1_5_4_5_1_i3',filename)
      CALL CREATEFILE(filename,d_i3,size_i3)
      CALL eomccsdtq_density1_5_4_5_1(d_t1,k_t1_offset,d_y1,k_y1_offset,
     &d_i3,k_i3_offset)
      CALL eomccsdtq_density1_5_4_5_2(d_t2,k_t2_offset,d_y2,k_y2_offset,
     &d_i3,k_i3_offset)
      CALL eomccsdtq_density1_5_4_5_3(d_t3,k_t3_offset,d_y3,k_y3_offset,
     &d_i3,k_i3_offset)
      CALL eomccsdtq_density1_5_4_5_4(d_t4,k_t4_offset,d_y4,k_y4_offset,
     &d_i3,k_i3_offset)
      CALL RECONCILEFILE(d_i3,size_i3)
      CALL eomccsdtq_density1_5_4_5(d_x0,k_x0_offset,d_i3,k_i3_offset,d_
     &i2,k_i2_offset)
      CALL DELETEFILE(d_i3)
      IF (.not.MA_POP_STACK(l_i3_offset)) CALL ERRQUIT('eomccsdtq_densit
     &y1',-1,MA_ERR)
      CALL OFFSET_eomccsdtq_density1_5_4_6_1(l_i3_offset,k_i3_offset,siz
     &e_i3)
      CALL TCE_FILENAME('eomccsdtq_density1_5_4_6_1_i3',filename)
      CALL CREATEFILE(filename,d_i3,size_i3)
      CALL eomccsdtq_density1_5_4_6_1(d_x1,k_x1_offset,d_y2,k_y2_offset,
     &d_i3,k_i3_offset)
      CALL eomccsdtq_density1_5_4_6_2(d_x2,k_x2_offset,d_y3,k_y3_offset,
     &d_i3,k_i3_offset)
      CALL eomccsdtq_density1_5_4_6_3(d_x3,k_x3_offset,d_y4,k_y4_offset,
     &d_i3,k_i3_offset)
      CALL RECONCILEFILE(d_i3,size_i3)
      CALL eomccsdtq_density1_5_4_6(d_t1,k_t1_offset,d_i3,k_i3_offset,d_
     &i2,k_i2_offset)
      CALL DELETEFILE(d_i3)
      IF (.not.MA_POP_STACK(l_i3_offset)) CALL ERRQUIT('eomccsdtq_densit
     &y1',-1,MA_ERR)
      CALL OFFSET_eomccsdtq_density1_5_4_7_1(l_i3_offset,k_i3_offset,siz
     &e_i3)
      CALL TCE_FILENAME('eomccsdtq_density1_5_4_7_1_i3',filename)
      CALL CREATEFILE(filename,d_i3,size_i3)
      CALL eomccsdtq_density1_5_4_7_1(d_x1,k_x1_offset,d_y3,k_y3_offset,
     &d_i3,k_i3_offset)
      CALL eomccsdtq_density1_5_4_7_2(d_x2,k_x2_offset,d_y4,k_y4_offset,
     &d_i3,k_i3_offset)
      CALL RECONCILEFILE(d_i3,size_i3)
      CALL eomccsdtq_density1_5_4_7(d_t2,k_t2_offset,d_i3,k_i3_offset,d_
     &i2,k_i2_offset)
      CALL DELETEFILE(d_i3)
      IF (.not.MA_POP_STACK(l_i3_offset)) CALL ERRQUIT('eomccsdtq_densit
     &y1',-1,MA_ERR)
      CALL OFFSET_eomccsdtq_density1_5_4_8_1(l_i3_offset,k_i3_offset,siz
     &e_i3)
      CALL TCE_FILENAME('eomccsdtq_density1_5_4_8_1_i3',filename)
      CALL CREATEFILE(filename,d_i3,size_i3)
      CALL eomccsdtq_density1_5_4_8_1(d_x1,k_x1_offset,d_y4,k_y4_offset,
     &d_i3,k_i3_offset)
      CALL RECONCILEFILE(d_i3,size_i3)
      CALL eomccsdtq_density1_5_4_8(d_t3,k_t3_offset,d_i3,k_i3_offset,d_
     &i2,k_i2_offset)
      CALL DELETEFILE(d_i3)
      IF (.not.MA_POP_STACK(l_i3_offset)) CALL ERRQUIT('eomccsdtq_densit
     &y1',-1,MA_ERR)
      CALL RECONCILEFILE(d_i2,size_i2)
      CALL eomccsdtq_density1_5_4(d_t1,k_t1_offset,d_i2,k_i2_offset,d_i1
     &,k_i1_offset)
      CALL DELETEFILE(d_i2)
      IF (.not.MA_POP_STACK(l_i2_offset)) CALL ERRQUIT('eomccsdtq_densit
     &y1',-1,MA_ERR)
      CALL OFFSET_eomccsdtq_density1_5_5_1(l_i2_offset,k_i2_offset,size_
     &i2)
      CALL TCE_FILENAME('eomccsdtq_density1_5_5_1_i2',filename)
      CALL CREATEFILE(filename,d_i2,size_i2)
      CALL eomccsdtq_density1_5_5_1(d_t1,k_t1_offset,d_y1,k_y1_offset,d_
     &i2,k_i2_offset)
      CALL eomccsdtq_density1_5_5_2(d_t2,k_t2_offset,d_y2,k_y2_offset,d_
     &i2,k_i2_offset)
      CALL eomccsdtq_density1_5_5_3(d_t3,k_t3_offset,d_y3,k_y3_offset,d_
     &i2,k_i2_offset)
      CALL eomccsdtq_density1_5_5_4(d_t4,k_t4_offset,d_y4,k_y4_offset,d_
     &i2,k_i2_offset)
      CALL RECONCILEFILE(d_i2,size_i2)
      CALL eomccsdtq_density1_5_5(d_x1,k_x1_offset,d_i2,k_i2_offset,d_i1
     &,k_i1_offset)
      CALL DELETEFILE(d_i2)
      IF (.not.MA_POP_STACK(l_i2_offset)) CALL ERRQUIT('eomccsdtq_densit
     &y1',-1,MA_ERR)
      CALL OFFSET_eomccsdtq_density1_5_6_1(l_i2_offset,k_i2_offset,size_
     &i2)
      CALL TCE_FILENAME('eomccsdtq_density1_5_6_1_i2',filename)
      CALL CREATEFILE(filename,d_i2,size_i2)
      CALL eomccsdtq_density1_5_6_1(d_x1,k_x1_offset,d_y1,k_y1_offset,d_
     &i2,k_i2_offset)
      CALL eomccsdtq_density1_5_6_2(d_x2,k_x2_offset,d_y2,k_y2_offset,d_
     &i2,k_i2_offset)
      CALL eomccsdtq_density1_5_6_3(d_x3,k_x3_offset,d_y3,k_y3_offset,d_
     &i2,k_i2_offset)
      CALL eomccsdtq_density1_5_6_4(d_x4,k_x4_offset,d_y4,k_y4_offset,d_
     &i2,k_i2_offset)
      CALL RECONCILEFILE(d_i2,size_i2)
      CALL eomccsdtq_density1_5_6(d_t1,k_t1_offset,d_i2,k_i2_offset,d_i1
     &,k_i1_offset)
      CALL DELETEFILE(d_i2)
      IF (.not.MA_POP_STACK(l_i2_offset)) CALL ERRQUIT('eomccsdtq_densit
     &y1',-1,MA_ERR)
      CALL OFFSET_eomccsdtq_density1_5_7_1(l_i2_offset,k_i2_offset,size_
     &i2)
      CALL TCE_FILENAME('eomccsdtq_density1_5_7_1_i2',filename)
      CALL CREATEFILE(filename,d_i2,size_i2)
      CALL eomccsdtq_density1_5_7_1(d_t1,k_t1_offset,d_y2,k_y2_offset,d_
     &i2,k_i2_offset)
      CALL eomccsdtq_density1_5_7_2(d_t2,k_t2_offset,d_y3,k_y3_offset,d_
     &i2,k_i2_offset)
      CALL eomccsdtq_density1_5_7_3(d_t3,k_t3_offset,d_y4,k_y4_offset,d_
     &i2,k_i2_offset)
      CALL RECONCILEFILE(d_i2,size_i2)
      CALL eomccsdtq_density1_5_7(d_x2,k_x2_offset,d_i2,k_i2_offset,d_i1
     &,k_i1_offset)
      CALL DELETEFILE(d_i2)
      IF (.not.MA_POP_STACK(l_i2_offset)) CALL ERRQUIT('eomccsdtq_densit
     &y1',-1,MA_ERR)
      CALL OFFSET_eomccsdtq_density1_5_8_1(l_i2_offset,k_i2_offset,size_
     &i2)
      CALL TCE_FILENAME('eomccsdtq_density1_5_8_1_i2',filename)
      CALL CREATEFILE(filename,d_i2,size_i2)
      CALL eomccsdtq_density1_5_8_1(d_t1,k_t1_offset,d_y3,k_y3_offset,d_
     &i2,k_i2_offset)
      CALL eomccsdtq_density1_5_8_2(d_t2,k_t2_offset,d_y4,k_y4_offset,d_
     &i2,k_i2_offset)
      CALL RECONCILEFILE(d_i2,size_i2)
      CALL eomccsdtq_density1_5_8(d_x3,k_x3_offset,d_i2,k_i2_offset,d_i1
     &,k_i1_offset)
      CALL DELETEFILE(d_i2)
      IF (.not.MA_POP_STACK(l_i2_offset)) CALL ERRQUIT('eomccsdtq_densit
     &y1',-1,MA_ERR)
      CALL OFFSET_eomccsdtq_density1_5_9_1(l_i2_offset,k_i2_offset,size_
     &i2)
      CALL TCE_FILENAME('eomccsdtq_density1_5_9_1_i2',filename)
      CALL CREATEFILE(filename,d_i2,size_i2)
      CALL eomccsdtq_density1_5_9_1(d_t1,k_t1_offset,d_y4,k_y4_offset,d_
     &i2,k_i2_offset)
      CALL RECONCILEFILE(d_i2,size_i2)
      CALL eomccsdtq_density1_5_9(d_x4,k_x4_offset,d_i2,k_i2_offset,d_i1
     &,k_i1_offset)
      CALL DELETEFILE(d_i2)
      IF (.not.MA_POP_STACK(l_i2_offset)) CALL ERRQUIT('eomccsdtq_densit
     &y1',-1,MA_ERR)
      CALL OFFSET_eomccsdtq_density1_5_10_1(l_i2_offset,k_i2_offset,size
     &_i2)
      CALL TCE_FILENAME('eomccsdtq_density1_5_10_1_i2',filename)
      CALL CREATEFILE(filename,d_i2,size_i2)
      CALL eomccsdtq_density1_5_10_1(d_x0,k_x0_offset,d_y1,k_y1_offset,d
     &_i2,k_i2_offset)
      CALL eomccsdtq_density1_5_10_2(d_x1,k_x1_offset,d_y2,k_y2_offset,d
     &_i2,k_i2_offset)
      CALL eomccsdtq_density1_5_10_3(d_x2,k_x2_offset,d_y3,k_y3_offset,d
     &_i2,k_i2_offset)
      CALL eomccsdtq_density1_5_10_4(d_x3,k_x3_offset,d_y4,k_y4_offset,d
     &_i2,k_i2_offset)
      CALL RECONCILEFILE(d_i2,size_i2)
      CALL eomccsdtq_density1_5_10(d_t2,k_t2_offset,d_i2,k_i2_offset,d_i
     &1,k_i1_offset)
      CALL DELETEFILE(d_i2)
      IF (.not.MA_POP_STACK(l_i2_offset)) CALL ERRQUIT('eomccsdtq_densit
     &y1',-1,MA_ERR)
      CALL OFFSET_eomccsdtq_density1_5_11_1(l_i2_offset,k_i2_offset,size
     &_i2)
      CALL TCE_FILENAME('eomccsdtq_density1_5_11_1_i2',filename)
      CALL CREATEFILE(filename,d_i2,size_i2)
      CALL eomccsdtq_density1_5_11_1(d_x1,k_x1_offset,d_y2,k_y2_offset,d
     &_i2,k_i2_offset)
      CALL eomccsdtq_density1_5_11_2(d_x2,k_x2_offset,d_y3,k_y3_offset,d
     &_i2,k_i2_offset)
      CALL eomccsdtq_density1_5_11_3(d_x3,k_x3_offset,d_y4,k_y4_offset,d
     &_i2,k_i2_offset)
      CALL OFFSET_eomccsdtq_density1_5_11_4_1(l_i3_offset,k_i3_offset,si
     &ze_i3)
      CALL TCE_FILENAME('eomccsdtq_density1_5_11_4_1_i3',filename)
      CALL CREATEFILE(filename,d_i3,size_i3)
      CALL OFFSET_eomccsdtq_density1_5_11_4_1_1(l_i4_offset,k_i4_offset,
     &size_i4)
      CALL TCE_FILENAME('eomccsdtq_density1_5_11_4_1_1_i4',filename)
      CALL CREATEFILE(filename,d_i4,size_i4)
      CALL eomccsdtq_density1_5_11_4_1_1(d_y4,k_y4_offset,d_i4,k_i4_offs
     &et)
      CALL eomccsdtq_density1_5_11_4_1_2(d_y4,k_y4_offset,d_i4,k_i4_offs
     &et)
      CALL RECONCILEFILE(d_i4,size_i4)
      CALL eomccsdtq_density1_5_11_4_1(d_x1,k_x1_offset,d_i4,k_i4_offset
     &,d_i3,k_i3_offset)
      CALL DELETEFILE(d_i4)
      IF (.not.MA_POP_STACK(l_i4_offset)) CALL ERRQUIT('eomccsdtq_densit
     &y1',-1,MA_ERR)
      CALL RECONCILEFILE(d_i3,size_i3)
      CALL eomccsdtq_density1_5_11_4(d_t2,k_t2_offset,d_i3,k_i3_offset,d
     &_i2,k_i2_offset)
      CALL DELETEFILE(d_i3)
      IF (.not.MA_POP_STACK(l_i3_offset)) CALL ERRQUIT('eomccsdtq_densit
     &y1',-1,MA_ERR)
      CALL RECONCILEFILE(d_i2,size_i2)
      CALL eomccsdtq_density1_5_11(d_t2,k_t2_offset,d_i2,k_i2_offset,d_i
     &1,k_i1_offset)
      CALL DELETEFILE(d_i2)
      IF (.not.MA_POP_STACK(l_i2_offset)) CALL ERRQUIT('eomccsdtq_densit
     &y1',-1,MA_ERR)
      CALL OFFSET_eomccsdtq_density1_5_12_1(l_i2_offset,k_i2_offset,size
     &_i2)
      CALL TCE_FILENAME('eomccsdtq_density1_5_12_1_i2',filename)
      CALL CREATEFILE(filename,d_i2,size_i2)
      CALL eomccsdtq_density1_5_12_1(d_t3,k_t3_offset,d_y2,k_y2_offset,d
     &_i2,k_i2_offset)
      CALL eomccsdtq_density1_5_12_2(d_t4,k_t4_offset,d_y3,k_y3_offset,d
     &_i2,k_i2_offset)
      CALL OFFSET_eomccsdtq_density1_5_12_3_1(l_i3_offset,k_i3_offset,si
     &ze_i3)
      CALL TCE_FILENAME('eomccsdtq_density1_5_12_3_1_i3',filename)
      CALL CREATEFILE(filename,d_i3,size_i3)
      CALL eomccsdtq_density1_5_12_3_1(d_t1,k_t1_offset,d_y2,k_y2_offset
     &,d_i3,k_i3_offset)
      CALL OFFSET_eomccsdtq_density1_5_12_3_2_1(l_i4_offset,k_i4_offset,
     &size_i4)
      CALL TCE_FILENAME('eomccsdtq_density1_5_12_3_2_1_i4',filename)
      CALL CREATEFILE(filename,d_i4,size_i4)
      CALL eomccsdtq_density1_5_12_3_2_1(d_y3,k_y3_offset,d_i4,k_i4_offs
     &et)
      CALL eomccsdtq_density1_5_12_3_2_2(d_y3,k_y3_offset,d_i4,k_i4_offs
     &et)
      CALL RECONCILEFILE(d_i4,size_i4)
      CALL eomccsdtq_density1_5_12_3_2(d_t2,k_t2_offset,d_i4,k_i4_offset
     &,d_i3,k_i3_offset)
      CALL DELETEFILE(d_i4)
      IF (.not.MA_POP_STACK(l_i4_offset)) CALL ERRQUIT('eomccsdtq_densit
     &y1',-1,MA_ERR)
      CALL eomccsdtq_density1_5_12_3_3(d_t3,k_t3_offset,d_y4,k_y4_offset
     &,d_i3,k_i3_offset)
      CALL RECONCILEFILE(d_i3,size_i3)
      CALL eomccsdtq_density1_5_12_3(d_t2,k_t2_offset,d_i3,k_i3_offset,d
     &_i2,k_i2_offset)
      CALL DELETEFILE(d_i3)
      IF (.not.MA_POP_STACK(l_i3_offset)) CALL ERRQUIT('eomccsdtq_densit
     &y1',-1,MA_ERR)
      CALL OFFSET_eomccsdtq_density1_5_12_4_1(l_i3_offset,k_i3_offset,si
     &ze_i3)
      CALL TCE_FILENAME('eomccsdtq_density1_5_12_4_1_i3',filename)
      CALL CREATEFILE(filename,d_i3,size_i3)
      CALL eomccsdtq_density1_5_12_4_1(d_t1,k_t1_offset,d_y3,k_y3_offset
     &,d_i3,k_i3_offset)
      CALL eomccsdtq_density1_5_12_4_2(d_t2,k_t2_offset,d_y4,k_y4_offset
     &,d_i3,k_i3_offset)
      CALL RECONCILEFILE(d_i3,size_i3)
      CALL eomccsdtq_density1_5_12_4(d_t3,k_t3_offset,d_i3,k_i3_offset,d
     &_i2,k_i2_offset)
      CALL DELETEFILE(d_i3)
      IF (.not.MA_POP_STACK(l_i3_offset)) CALL ERRQUIT('eomccsdtq_densit
     &y1',-1,MA_ERR)
      CALL OFFSET_eomccsdtq_density1_5_12_5_1(l_i3_offset,k_i3_offset,si
     &ze_i3)
      CALL TCE_FILENAME('eomccsdtq_density1_5_12_5_1_i3',filename)
      CALL CREATEFILE(filename,d_i3,size_i3)
      CALL eomccsdtq_density1_5_12_5_1(d_t1,k_t1_offset,d_y4,k_y4_offset
     &,d_i3,k_i3_offset)
      CALL RECONCILEFILE(d_i3,size_i3)
      CALL eomccsdtq_density1_5_12_5(d_t4,k_t4_offset,d_i3,k_i3_offset,d
     &_i2,k_i2_offset)
      CALL DELETEFILE(d_i3)
      IF (.not.MA_POP_STACK(l_i3_offset)) CALL ERRQUIT('eomccsdtq_densit
     &y1',-1,MA_ERR)
      CALL RECONCILEFILE(d_i2,size_i2)
      CALL eomccsdtq_density1_5_12(d_x0,k_x0_offset,d_i2,k_i2_offset,d_i
     &1,k_i1_offset)
      CALL DELETEFILE(d_i2)
      IF (.not.MA_POP_STACK(l_i2_offset)) CALL ERRQUIT('eomccsdtq_densit
     &y1',-1,MA_ERR)
      CALL OFFSET_eomccsdtq_density1_5_13_1(l_i2_offset,k_i2_offset,size
     &_i2)
      CALL TCE_FILENAME('eomccsdtq_density1_5_13_1_i2',filename)
      CALL CREATEFILE(filename,d_i2,size_i2)
      CALL eomccsdtq_density1_5_13_1(d_x1,k_x1_offset,d_y3,k_y3_offset,d
     &_i2,k_i2_offset)
      CALL eomccsdtq_density1_5_13_2(d_x2,k_x2_offset,d_y4,k_y4_offset,d
     &_i2,k_i2_offset)
      CALL RECONCILEFILE(d_i2,size_i2)
      CALL eomccsdtq_density1_5_13(d_t3,k_t3_offset,d_i2,k_i2_offset,d_i
     &1,k_i1_offset)
      CALL DELETEFILE(d_i2)
      IF (.not.MA_POP_STACK(l_i2_offset)) CALL ERRQUIT('eomccsdtq_densit
     &y1',-1,MA_ERR)
      CALL OFFSET_eomccsdtq_density1_5_14_1(l_i2_offset,k_i2_offset,size
     &_i2)
      CALL TCE_FILENAME('eomccsdtq_density1_5_14_1_i2',filename)
      CALL CREATEFILE(filename,d_i2,size_i2)
      CALL eomccsdtq_density1_5_14_1(d_x1,k_x1_offset,d_y3,k_y3_offset,d
     &_i2,k_i2_offset)
      CALL eomccsdtq_density1_5_14_2(d_x2,k_x2_offset,d_y4,k_y4_offset,d
     &_i2,k_i2_offset)
      CALL RECONCILEFILE(d_i2,size_i2)
      CALL eomccsdtq_density1_5_14(d_t3,k_t3_offset,d_i2,k_i2_offset,d_i
     &1,k_i1_offset)
      CALL DELETEFILE(d_i2)
      IF (.not.MA_POP_STACK(l_i2_offset)) CALL ERRQUIT('eomccsdtq_densit
     &y1',-1,MA_ERR)
      CALL OFFSET_eomccsdtq_density1_5_15_1(l_i2_offset,k_i2_offset,size
     &_i2)
      CALL TCE_FILENAME('eomccsdtq_density1_5_15_1_i2',filename)
      CALL CREATEFILE(filename,d_i2,size_i2)
      CALL eomccsdtq_density1_5_15_1(d_x1,k_x1_offset,d_y4,k_y4_offset,d
     &_i2,k_i2_offset)
      CALL RECONCILEFILE(d_i2,size_i2)
      CALL eomccsdtq_density1_5_15(d_t4,k_t4_offset,d_i2,k_i2_offset,d_i
     &1,k_i1_offset)
      CALL DELETEFILE(d_i2)
      IF (.not.MA_POP_STACK(l_i2_offset)) CALL ERRQUIT('eomccsdtq_densit
     &y1',-1,MA_ERR)
      CALL OFFSET_eomccsdtq_density1_5_16_1(l_i2_offset,k_i2_offset,size
     &_i2)
      CALL TCE_FILENAME('eomccsdtq_density1_5_16_1_i2',filename)
      CALL CREATEFILE(filename,d_i2,size_i2)
      CALL eomccsdtq_density1_5_16_1(d_x1,k_x1_offset,d_y4,k_y4_offset,d
     &_i2,k_i2_offset)
      CALL RECONCILEFILE(d_i2,size_i2)
      CALL eomccsdtq_density1_5_16(d_t4,k_t4_offset,d_i2,k_i2_offset,d_i
     &1,k_i1_offset)
      CALL DELETEFILE(d_i2)
      IF (.not.MA_POP_STACK(l_i2_offset)) CALL ERRQUIT('eomccsdtq_densit
     &y1',-1,MA_ERR)
      CALL OFFSET_eomccsdtq_density1_5_17_1(l_i2_offset,k_i2_offset,size
     &_i2)
      CALL TCE_FILENAME('eomccsdtq_density1_5_17_1_i2',filename)
      CALL CREATEFILE(filename,d_i2,size_i2)
      CALL OFFSET_eomccsdtq_density1_5_17_1_1(l_i3_offset,k_i3_offset,si
     &ze_i3)
      CALL TCE_FILENAME('eomccsdtq_density1_5_17_1_1_i3',filename)
      CALL CREATEFILE(filename,d_i3,size_i3)
      CALL eomccsdtq_density1_5_17_1_1(d_x1,k_x1_offset,d_y3,k_y3_offset
     &,d_i3,k_i3_offset)
      CALL eomccsdtq_density1_5_17_1_2(d_x2,k_x2_offset,d_y4,k_y4_offset
     &,d_i3,k_i3_offset)
      CALL RECONCILEFILE(d_i3,size_i3)
      CALL eomccsdtq_density1_5_17_1(d_t2,k_t2_offset,d_i3,k_i3_offset,d
     &_i2,k_i2_offset)
      CALL DELETEFILE(d_i3)
      IF (.not.MA_POP_STACK(l_i3_offset)) CALL ERRQUIT('eomccsdtq_densit
     &y1',-1,MA_ERR)
      CALL OFFSET_eomccsdtq_density1_5_17_2_1(l_i3_offset,k_i3_offset,si
     &ze_i3)
      CALL TCE_FILENAME('eomccsdtq_density1_5_17_2_1_i3',filename)
      CALL CREATEFILE(filename,d_i3,size_i3)
      CALL eomccsdtq_density1_5_17_2_1(d_x1,k_x1_offset,d_y4,k_y4_offset
     &,d_i3,k_i3_offset)
      CALL RECONCILEFILE(d_i3,size_i3)
      CALL eomccsdtq_density1_5_17_2(d_t3,k_t3_offset,d_i3,k_i3_offset,d
     &_i2,k_i2_offset)
      CALL DELETEFILE(d_i3)
      IF (.not.MA_POP_STACK(l_i3_offset)) CALL ERRQUIT('eomccsdtq_densit
     &y1',-1,MA_ERR)
      CALL RECONCILEFILE(d_i2,size_i2)
      CALL eomccsdtq_density1_5_17(d_t1,k_t1_offset,d_i2,k_i2_offset,d_i
     &1,k_i1_offset)
      CALL DELETEFILE(d_i2)
      IF (.not.MA_POP_STACK(l_i2_offset)) CALL ERRQUIT('eomccsdtq_densit
     &y1',-1,MA_ERR)
      CALL RECONCILEFILE(d_i1,size_i1)
      CALL eomccsdtq_density1_5(d_d1,k_d1_offset,d_i1,k_i1_offset,d_i0,k
     &_i0_offset)
      CALL DELETEFILE(d_i1)
      IF (.not.MA_POP_STACK(l_i1_offset)) CALL ERRQUIT('eomccsdtq_densit
     &y1',-1,MA_ERR)
      CALL OFFSET_eomccsdtq_density1_6_1(l_i1_offset,k_i1_offset,size_i1
     &)
      CALL TCE_FILENAME('eomccsdtq_density1_6_1_i1',filename)
      CALL CREATEFILE(filename,d_i1,size_i1)
      CALL eomccsdtq_density1_6_1(d_x2,k_x2_offset,d_y2,k_y2_offset,d_i1
     &,k_i1_offset)
      CALL eomccsdtq_density1_6_2(d_x3,k_x3_offset,d_y3,k_y3_offset,d_i1
     &,k_i1_offset)
      CALL eomccsdtq_density1_6_3(d_x4,k_x4_offset,d_y4,k_y4_offset,d_i1
     &,k_i1_offset)
      CALL OFFSET_eomccsdtq_density1_6_4_1(l_i2_offset,k_i2_offset,size_
     &i2)
      CALL TCE_FILENAME('eomccsdtq_density1_6_4_1_i2',filename)
      CALL CREATEFILE(filename,d_i2,size_i2)
      CALL eomccsdtq_density1_6_4_1(d_x1,k_x1_offset,d_y2,k_y2_offset,d_
     &i2,k_i2_offset)
      CALL eomccsdtq_density1_6_4_2(d_x2,k_x2_offset,d_y3,k_y3_offset,d_
     &i2,k_i2_offset)
      CALL eomccsdtq_density1_6_4_3(d_x3,k_x3_offset,d_y4,k_y4_offset,d_
     &i2,k_i2_offset)
      CALL RECONCILEFILE(d_i2,size_i2)
      CALL eomccsdtq_density1_6_4(d_t1,k_t1_offset,d_i2,k_i2_offset,d_i1
     &,k_i1_offset)
      CALL DELETEFILE(d_i2)
      IF (.not.MA_POP_STACK(l_i2_offset)) CALL ERRQUIT('eomccsdtq_densit
     &y1',-1,MA_ERR)
      CALL OFFSET_eomccsdtq_density1_6_5_1(l_i2_offset,k_i2_offset,size_
     &i2)
      CALL TCE_FILENAME('eomccsdtq_density1_6_5_1_i2',filename)
      CALL CREATEFILE(filename,d_i2,size_i2)
      CALL eomccsdtq_density1_6_5_1(d_t2,k_t2_offset,d_y2,k_y2_offset,d_
     &i2,k_i2_offset)
      CALL eomccsdtq_density1_6_5_2(d_t3,k_t3_offset,d_y3,k_y3_offset,d_
     &i2,k_i2_offset)
      CALL eomccsdtq_density1_6_5_3(d_t4,k_t4_offset,d_y4,k_y4_offset,d_
     &i2,k_i2_offset)
      CALL RECONCILEFILE(d_i2,size_i2)
      CALL eomccsdtq_density1_6_5(d_x0,k_x0_offset,d_i2,k_i2_offset,d_i1
     &,k_i1_offset)
      CALL DELETEFILE(d_i2)
      IF (.not.MA_POP_STACK(l_i2_offset)) CALL ERRQUIT('eomccsdtq_densit
     &y1',-1,MA_ERR)
      CALL OFFSET_eomccsdtq_density1_6_6_1(l_i2_offset,k_i2_offset,size_
     &i2)
      CALL TCE_FILENAME('eomccsdtq_density1_6_6_1_i2',filename)
      CALL CREATEFILE(filename,d_i2,size_i2)
      CALL eomccsdtq_density1_6_6_1(d_x1,k_x1_offset,d_y3,k_y3_offset,d_
     &i2,k_i2_offset)
      CALL eomccsdtq_density1_6_6_2(d_x2,k_x2_offset,d_y4,k_y4_offset,d_
     &i2,k_i2_offset)
      CALL RECONCILEFILE(d_i2,size_i2)
      CALL eomccsdtq_density1_6_6(d_t2,k_t2_offset,d_i2,k_i2_offset,d_i1
     &,k_i1_offset)
      CALL DELETEFILE(d_i2)
      IF (.not.MA_POP_STACK(l_i2_offset)) CALL ERRQUIT('eomccsdtq_densit
     &y1',-1,MA_ERR)
      CALL OFFSET_eomccsdtq_density1_6_7_1(l_i2_offset,k_i2_offset,size_
     &i2)
      CALL TCE_FILENAME('eomccsdtq_density1_6_7_1_i2',filename)
      CALL CREATEFILE(filename,d_i2,size_i2)
      CALL eomccsdtq_density1_6_7_1(d_x1,k_x1_offset,d_y4,k_y4_offset,d_
     &i2,k_i2_offset)
      CALL RECONCILEFILE(d_i2,size_i2)
      CALL eomccsdtq_density1_6_7(d_t3,k_t3_offset,d_i2,k_i2_offset,d_i1
     &,k_i1_offset)
      CALL DELETEFILE(d_i2)
      IF (.not.MA_POP_STACK(l_i2_offset)) CALL ERRQUIT('eomccsdtq_densit
     &y1',-1,MA_ERR)
      CALL RECONCILEFILE(d_i1,size_i1)
      CALL eomccsdtq_density1_6(d_d1,k_d1_offset,d_i1,k_i1_offset,d_i0,k
     &_i0_offset)
      CALL DELETEFILE(d_i1)
      IF (.not.MA_POP_STACK(l_i1_offset)) CALL ERRQUIT('eomccsdtq_densit
     &y1',-1,MA_ERR)
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_1(d_a,k_a_offset,d_b,k_b_offset,d_c,
     &k_c_offset)
C     i0 ( )_yxd + = 1 * Sum ( h2 p1 ) * d ( p1 h2 )_d * i1 ( h2 p1 )_yx
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p1b
      INTEGER h2b
      INTEGER p1b_1
      INTEGER h2b_1
      INTEGER h2b_2
      INTEGER p1b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      IF (next .eq. count) THEN
      IF (0 .eq. ieor(irrep_y,ieor(irrep_x,irrep_d))) THEN
      dimc = 1
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_1',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p1b = noab+1,noab+nvab
      DO h2b = 1,noab
      IF (int_mb(k_spin+p1b-1) .eq. int_mb(k_spin+h2b-1)) THEN
      IF (ieor(int_mb(k_sym+p1b-1),int_mb(k_sym+h2b-1)) .eq. irrep_d) TH
     &EN
      CALL TCE_RESTRICTED_2(p1b,h2b,p1b_1,h2b_1)
      CALL TCE_RESTRICTED_2(h2b,p1b,h2b_2,p1b_2)
      dim_common = int_mb(k_range+p1b-1) * int_mb(k_range+h2b-1)
      dima_sort = 1
      dima = dim_common * dima_sort
      dimb_sort = 1
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_1',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_1',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h2b_1
     & - 1 + (noab+nvab) * (p1b_1 - 1)))
      CALL TCE_SORT_2(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p1b-1)
     &,int_mb(k_range+h2b-1),2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_1',3,
     &MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_1',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_1',5,MA_ERR)
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p1b_2
     & - noab - 1 + nvab * (h2b_2 - 1)))
      CALL TCE_SORT_2(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+p1b-1),1,2,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_1',6,
     &MA_ERR)
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,1.0d0,dbl_mb
     &(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c
     &_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &1',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &1',8,MA_ERR)
      END IF
      END IF
      END IF
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_1',9,MA_ERR)
      CALL TCE_SORT_0(dbl_mb(k_c_sort),dbl_mb(k_c),1.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),0)
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_1',10
     &,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &1',11,MA_ERR)
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_1_1(d_a,k_a_offset,d_b,k_b_offset,d_
     &c,k_c_offset)
C     i1 ( h2 p1 )_yx + = 1 * x ( )_x * y ( h2 p1 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h2b
      INTEGER p1b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER h2b_2
      INTEGER p1b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h2b = 1,noab
      DO p1b = noab+1,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+p1b-1
     &).ne.4)) THEN
      IF (int_mb(k_spin+h2b-1) .eq. int_mb(k_spin+p1b-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),int_mb(k_sym+p1b-1)) .eq. ieor(irrep_
     &y,irrep_x)) THEN
      dimc = int_mb(k_range+h2b-1) * int_mb(k_range+p1b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_1_1',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      IF (0 .eq. irrep_x) THEN
      CALL TCE_RESTRICTED_2(h2b,p1b,h2b_2,p1b_2)
      dim_common = 1
      dima_sort = 1
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h2b-1) * int_mb(k_range+p1b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_1_1',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_1_1',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),0)
      CALL TCE_SORT_0(dbl_mb(k_a),dbl_mb(k_a_sort),1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_1_1',
     &3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_1_1',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_1_1',5,MA_ERR)
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p1b_2
     & - noab - 1 + nvab * (h2b_2 - 1)))
      CALL TCE_SORT_2(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+p1b-1),2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_1_1',
     &6,MA_ERR)
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,1.0d0,dbl_mb
     &(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c
     &_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &1_1',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &1_1',8,MA_ERR)
      END IF
      END IF
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_1_1',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p1b-1)
     &,int_mb(k_range+h2b-1),2,1,1.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p1b -
     & noab - 1 + nvab * (h2b - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_1_1',
     &10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &1_1',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE OFFSET_eomccsdtq_density1_1_1(l_a_offset,k_a_offset,siz
     &e)
C     i1 ( h2 p1 )_yx
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER l_a_offset
      INTEGER k_a_offset
      INTEGER length
      INTEGER addr
      INTEGER h2b
      INTEGER p1b
      DOUBLE PRECISION size
      length = 0
      DO h2b = 1,noab
      DO p1b = noab+1,noab+nvab
      IF (int_mb(k_spin+h2b-1) .eq. int_mb(k_spin+p1b-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),int_mb(k_sym+p1b-1)) .eq. ieor(irrep_
     &y,irrep_x)) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+p1b-1
     &).ne.4)) THEN
      length = length + 1
      END IF
      END IF
      END IF
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,2*length+1,'noname',l_a_offset,k_a_off
     &set)) CALL ERRQUIT('eomccsdtq_density1_1_1',0,MA_ERR)
      dbl_mb(k_a_offset) = dfloat(length)
      addr = 0
      size = 0.0d0
      DO h2b = 1,noab
      DO p1b = noab+1,noab+nvab
      IF (int_mb(k_spin+h2b-1) .eq. int_mb(k_spin+p1b-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),int_mb(k_sym+p1b-1)) .eq. ieor(irrep_
     &y,irrep_x)) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+p1b-1
     &).ne.4)) THEN
      addr = addr + 1
      dbl_mb(k_a_offset+addr) = dfloat(p1b - noab - 1 + nvab * (h2b - 1)
     &)
      dbl_mb(k_a_offset+length+addr) = size
      size = size + dfloat(int_mb(k_range+h2b-1)) * dfloat(int_mb(k_rang
     &e+p1b-1))
      END IF
      END IF
      END IF
      END DO
      END DO
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_1_2(d_a,k_a_offset,d_b,k_b_offset,d_
     &c,k_c_offset)
C     i1 ( h2 p1 )_yx + = 1 * Sum ( h4 p3 ) * x ( p3 h4 )_x * y ( h2 h4 p1 p3 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h2b
      INTEGER p1b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p3b
      INTEGER h4b
      INTEGER p3b_1
      INTEGER h4b_1
      INTEGER h2b_2
      INTEGER h4b_2
      INTEGER p1b_2
      INTEGER p3b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h2b = 1,noab
      DO p1b = noab+1,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+p1b-1
     &).ne.4)) THEN
      IF (int_mb(k_spin+h2b-1) .eq. int_mb(k_spin+p1b-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),int_mb(k_sym+p1b-1)) .eq. ieor(irrep_
     &y,irrep_x)) THEN
      dimc = int_mb(k_range+h2b-1) * int_mb(k_range+p1b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_1_2',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p3b = noab+1,noab+nvab
      DO h4b = 1,noab
      IF (int_mb(k_spin+p3b-1) .eq. int_mb(k_spin+h4b-1)) THEN
      IF (ieor(int_mb(k_sym+p3b-1),int_mb(k_sym+h4b-1)) .eq. irrep_x) TH
     &EN
      CALL TCE_RESTRICTED_2(p3b,h4b,p3b_1,h4b_1)
      CALL TCE_RESTRICTED_4(h2b,h4b,p1b,p3b,h2b_2,h4b_2,p1b_2,p3b_2)
      dim_common = int_mb(k_range+p3b-1) * int_mb(k_range+h4b-1)
      dima_sort = 1
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h2b-1) * int_mb(k_range+p1b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_1_2',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_1_2',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h4b_1
     & - 1 + noab * (p3b_1 - noab - 1)))
      CALL TCE_SORT_2(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+h4b-1),2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_1_2',
     &3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_1_2',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_1_2',5,MA_ERR)
      IF ((h4b .lt. h2b) .and. (p3b .lt. p1b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p1b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (h2b_2 - 1 + noab 
     &* (h4b_2 - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+p3b-1),int_mb(k_range+p1b-1)
     &,4,2,1,3,1.0d0,.false.)
      END IF
      IF ((h4b .lt. h2b) .and. (p1b .le. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p1b_2 - noab - 1 + nvab * (h2b_2 - 1 + noab 
     &* (h4b_2 - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+p1b-1),int_mb(k_range+p3b-1)
     &,3,2,1,4,-1.0d0,.false.)
      END IF
      IF ((h2b .le. h4b) .and. (p3b .lt. p1b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p1b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (h4b_2 - 1 + noab 
     &* (h2b_2 - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h4b-1),int_mb(k_range+p3b-1),int_mb(k_range+p1b-1)
     &,4,1,2,3,-1.0d0,.false.)
      END IF
      IF ((h2b .le. h4b) .and. (p1b .le. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p1b_2 - noab - 1 + nvab * (h4b_2 - 1 + noab 
     &* (h2b_2 - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h4b-1),int_mb(k_range+p1b-1),int_mb(k_range+p3b-1)
     &,3,1,2,4,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_1_2',
     &6,MA_ERR)
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,1.0d0,dbl_mb
     &(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c
     &_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &1_2',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &1_2',8,MA_ERR)
      END IF
      END IF
      END IF
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_1_2',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p1b-1)
     &,int_mb(k_range+h2b-1),2,1,1.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p1b -
     & noab - 1 + nvab * (h2b - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_1_2',
     &10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &1_2',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_1_3(d_a,k_a_offset,d_b,k_b_offset,d_
     &c,k_c_offset)
C     i1 ( h2 p1 )_yx + = 1/4 * Sum ( h6 h5 p4 p3 ) * x ( p3 p4 h5 h6 )_x * y ( h2 h5 h6 p1 p3 p4 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h2b
      INTEGER p1b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p3b
      INTEGER p4b
      INTEGER h5b
      INTEGER h6b
      INTEGER p3b_1
      INTEGER p4b_1
      INTEGER h5b_1
      INTEGER h6b_1
      INTEGER h2b_2
      INTEGER h5b_2
      INTEGER h6b_2
      INTEGER p1b_2
      INTEGER p3b_2
      INTEGER p4b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(2)
      INTEGER isuperp
      INTEGER nsubh(2)
      INTEGER isubh
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h2b = 1,noab
      DO p1b = noab+1,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+p1b-1
     &).ne.4)) THEN
      IF (int_mb(k_spin+h2b-1) .eq. int_mb(k_spin+p1b-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),int_mb(k_sym+p1b-1)) .eq. ieor(irrep_
     &y,irrep_x)) THEN
      dimc = int_mb(k_range+h2b-1) * int_mb(k_range+p1b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_1_3',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      DO h5b = 1,noab
      DO h6b = h5b,noab
      IF (int_mb(k_active+h2b-1)+int_mb(k_active+h5b-1)+int_mb(k_active+
     &h6b-1) .ge. numact) THEN
      IF (int_mb(k_active+p1b-1)+int_mb(k_active+p3b-1)+int_mb(k_active+
     &p4b-1) .ge. numact) THEN
      IF (int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1) .eq. int_mb(k_spin+h
     &5b-1)+int_mb(k_spin+h6b-1)) THEN
      IF (ieor(int_mb(k_sym+p3b-1),ieor(int_mb(k_sym+p4b-1),ieor(int_mb(
     &k_sym+h5b-1),int_mb(k_sym+h6b-1)))) .eq. irrep_x) THEN
      CALL TCE_RESTRICTED_4(p3b,p4b,h5b,h6b,p3b_1,p4b_1,h5b_1,h6b_1)
      CALL TCE_RESTRICTED_6(h2b,h5b,h6b,p1b,p3b,p4b,h2b_2,h5b_2,h6b_2,p1
     &b_2,p3b_2,p4b_2)
      dim_common = int_mb(k_range+p3b-1) * int_mb(k_range+p4b-1) * int_m
     &b(k_range+h5b-1) * int_mb(k_range+h6b-1)
      dima_sort = 1
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h2b-1) * int_mb(k_range+p1b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_1_3',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_1_3',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h6b_1
     & - 1 + noab * (h5b_1 - 1 + noab * (p4b_1 - noab - 1 + nvab * (p3b_
     &1 - noab - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+h5b-1),int_mb(k_range+h6b-1)
     &,4,3,2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_1_3',
     &3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_1_3',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_1_3',5,MA_ERR)
      IF ((h6b .lt. h2b) .and. (p4b .lt. p1b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p1b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h2b_2 - 1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h2b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p1b-1),6,3,2,1,5,4,1.0d0,.fa
     &lse.)
      END IF
      IF ((h6b .lt. h2b) .and. (p3b .lt. p1b) .and. (p1b .le. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p1b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h2b_2 - 1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h2b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p1b-1),int_mb(k_range+p4b-1),5,3,2,1,6,4,-1.0d0,.f
     &alse.)
      END IF
      IF ((h6b .lt. h2b) .and. (p1b .le. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (h2b_2 - 1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h2b-1),int_mb(k_range+p1b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),4,3,2,1,6,5,1.0d0,.fa
     &lse.)
      END IF
      IF ((h5b .lt. h2b) .and. (h2b .le. h6b) .and. (p4b .lt. p1b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p1b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h6b_2 - 1 + noab * (h2b_2 - 1 + noab * (h5b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h6b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p1b-1),6,2,3,1,5,4,-1.0d0,.f
     &alse.)
      END IF
      IF ((h5b .lt. h2b) .and. (h2b .le. h6b) .and. (p3b .lt. p1b) .and.
     & (p1b .le. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p1b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h6b_2 - 1 + noab * (h2b_2 - 1 + noab * (h5b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h6b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p1b-1),int_mb(k_range+p4b-1),5,2,3,1,6,4,1.0d0,.fa
     &lse.)
      END IF
      IF ((h5b .lt. h2b) .and. (h2b .le. h6b) .and. (p1b .le. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (h6b_2 - 1 + noab * (h2b_2 - 1 + noab * (h5b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h6b-1),int_mb(k_range+p1b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),4,2,3,1,6,5,-1.0d0,.f
     &alse.)
      END IF
      IF ((h2b .le. h5b) .and. (p4b .lt. p1b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p1b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h6b_2 - 1 + noab * (h5b_2 - 1 + noab * (h2b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h6b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p1b-1),6,1,3,2,5,4,1.0d0,.fa
     &lse.)
      END IF
      IF ((h2b .le. h5b) .and. (p3b .lt. p1b) .and. (p1b .le. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p1b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h6b_2 - 1 + noab * (h5b_2 - 1 + noab * (h2b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h6b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p1b-1),int_mb(k_range+p4b-1),5,1,3,2,6,4,-1.0d0,.f
     &alse.)
      END IF
      IF ((h2b .le. h5b) .and. (p1b .le. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (h6b_2 - 1 + noab * (h5b_2 - 1 + noab * (h2b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h6b-1),int_mb(k_range+p1b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),4,1,3,2,6,5,1.0d0,.fa
     &lse.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_1_3',
     &6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      isuperp = 1
      IF (p3b .eq. p4b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      nsubh(1) = 1
      nsubh(2) = 1
      isubh = 1
      IF (h5b .eq. h6b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,4.0d0/FACTOR
     &IAL(nsuperp(1))/FACTORIAL(nsuperp(2))/FACTORIAL(nsubh(1))/FACTORIA
     &L(nsubh(2)),dbl_mb(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_commo
     &n,1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &1_3',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &1_3',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_1_3',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p1b-1)
     &,int_mb(k_range+h2b-1),2,1,1.0d0/4.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p1b -
     & noab - 1 + nvab * (h2b - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_1_3',
     &10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &1_3',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_1_4(d_a,k_a_offset,d_b,k_b_offset,d_
     &c,k_c_offset)
C     i1 ( h2 p1 )_yx + = 1/36 * Sum ( h8 h7 h6 p5 p4 p3 ) * x ( p3 p4 p5 h6 h7 h8 )_x * y ( h2 h6 h7 h8 p1 p3 p4 p5 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h2b
      INTEGER p1b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p3b
      INTEGER p4b
      INTEGER p5b
      INTEGER h6b
      INTEGER h7b
      INTEGER h8b
      INTEGER p3b_1
      INTEGER p4b_1
      INTEGER p5b_1
      INTEGER h6b_1
      INTEGER h7b_1
      INTEGER h8b_1
      INTEGER h2b_2
      INTEGER h6b_2
      INTEGER h7b_2
      INTEGER h8b_2
      INTEGER p1b_2
      INTEGER p3b_2
      INTEGER p4b_2
      INTEGER p5b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(3)
      INTEGER isuperp
      INTEGER nsubh(3)
      INTEGER isubh
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h2b = 1,noab
      DO p1b = noab+1,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+p1b-1
     &).ne.4)) THEN
      IF (int_mb(k_spin+h2b-1) .eq. int_mb(k_spin+p1b-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),int_mb(k_sym+p1b-1)) .eq. ieor(irrep_
     &y,irrep_x)) THEN
      dimc = int_mb(k_range+h2b-1) * int_mb(k_range+p1b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_1_4',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      DO p5b = p4b,noab+nvab
      DO h6b = 1,noab
      DO h7b = h6b,noab
      DO h8b = h7b,noab
      IF (int_mb(k_active+p3b-1)+int_mb(k_active+p4b-1)+int_mb(k_active+
     &p5b-1) .ge. numact) THEN
      IF (int_mb(k_active+h6b-1)+int_mb(k_active+h7b-1)+int_mb(k_active+
     &h8b-1) .ge. numact) THEN
      IF (int_mb(k_active+h2b-1)+int_mb(k_active+h6b-1)+int_mb(k_active+
     &h7b-1)+int_mb(k_active+h8b-1) .ge. numacq) THEN
      IF (int_mb(k_active+p1b-1)+int_mb(k_active+p3b-1)+int_mb(k_active+
     &p4b-1)+int_mb(k_active+p5b-1) .ge. numacq) THEN
      IF (int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1)+int_mb(k_spin+p5b-1)
     & .eq. int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b-1)+int_mb(k_spin+h8b-
     &1)) THEN
      IF (ieor(int_mb(k_sym+p3b-1),ieor(int_mb(k_sym+p4b-1),ieor(int_mb(
     &k_sym+p5b-1),ieor(int_mb(k_sym+h6b-1),ieor(int_mb(k_sym+h7b-1),int
     &_mb(k_sym+h8b-1)))))) .eq. irrep_x) THEN
      CALL TCE_RESTRICTED_6(p3b,p4b,p5b,h6b,h7b,h8b,p3b_1,p4b_1,p5b_1,h6
     &b_1,h7b_1,h8b_1)
      CALL TCE_RESTRICTED_8(h2b,h6b,h7b,h8b,p1b,p3b,p4b,p5b,h2b_2,h6b_2,
     &h7b_2,h8b_2,p1b_2,p3b_2,p4b_2,p5b_2)
      dim_common = int_mb(k_range+p3b-1) * int_mb(k_range+p4b-1) * int_m
     &b(k_range+p5b-1) * int_mb(k_range+h6b-1) * int_mb(k_range+h7b-1) *
     & int_mb(k_range+h8b-1)
      dima_sort = 1
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h2b-1) * int_mb(k_range+p1b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_1_4',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_1_4',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h8b_1
     & - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 + noab * (p5b_1 - noa
     &b - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),6,5,4,3,2,1,1.0d0,.fa
     &lse.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_1_4',
     &3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_1_4',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_1_4',5,MA_ERR)
      IF ((h8b .lt. h2b) .and. (p5b .lt. p1b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p1b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h2b_2 - 1 + noab * (h8b_2 - 1
     & + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),int_mb(k_range+h2b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p1b-1),8,4,3,2,1,7,6,5,1.0d0,.false.)
      END IF
      IF ((h8b .lt. h2b) .and. (p4b .lt. p1b) .and. (p1b .le. p5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p1b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h2b_2 - 1 + noab * (h8b_2 - 1
     & + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),int_mb(k_range+h2b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p1b-1)
     &,int_mb(k_range+p5b-1),7,4,3,2,1,8,6,5,-1.0d0,.false.)
      END IF
      IF ((h8b .lt. h2b) .and. (p3b .lt. p1b) .and. (p1b .le. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h2b_2 - 1 + noab * (h8b_2 - 1
     & + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),int_mb(k_range+h2b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p1b-1),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p5b-1),6,4,3,2,1,8,7,5,1.0d0,.false.)
      END IF
      IF ((h8b .lt. h2b) .and. (p1b .le. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h2b_2 - 1 + noab * (h8b_2 - 1
     & + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),int_mb(k_range+h2b-1)
     &,int_mb(k_range+p1b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p5b-1),5,4,3,2,1,8,7,6,-1.0d0,.false.)
      END IF
      IF ((h7b .lt. h2b) .and. (h2b .le. h8b) .and. (p5b .lt. p1b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p1b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h8b_2 - 1 + noab * (h2b_2 - 1
     & + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h2b-1),int_mb(k_range+h8b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p1b-1),8,3,4,2,1,7,6,5,-1.0d0,.false.)
      END IF
      IF ((h7b .lt. h2b) .and. (h2b .le. h8b) .and. (p4b .lt. p1b) .and.
     & (p1b .le. p5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p1b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h8b_2 - 1 + noab * (h2b_2 - 1
     & + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h2b-1),int_mb(k_range+h8b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p1b-1)
     &,int_mb(k_range+p5b-1),7,3,4,2,1,8,6,5,1.0d0,.false.)
      END IF
      IF ((h7b .lt. h2b) .and. (h2b .le. h8b) .and. (p3b .lt. p1b) .and.
     & (p1b .le. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h8b_2 - 1 + noab * (h2b_2 - 1
     & + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h2b-1),int_mb(k_range+h8b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p1b-1),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p5b-1),6,3,4,2,1,8,7,5,-1.0d0,.false.)
      END IF
      IF ((h7b .lt. h2b) .and. (h2b .le. h8b) .and. (p1b .le. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h8b_2 - 1 + noab * (h2b_2 - 1
     & + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h2b-1),int_mb(k_range+h8b-1)
     &,int_mb(k_range+p1b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p5b-1),5,3,4,2,1,8,7,6,1.0d0,.false.)
      END IF
      IF ((h6b .lt. h2b) .and. (h2b .le. h7b) .and. (p5b .lt. p1b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p1b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h8b_2 - 1 + noab * (h7b_2 - 1
     & + noab * (h2b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h7b-1),int_mb(k_range+h8b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p1b-1),8,2,4,3,1,7,6,5,1.0d0,.false.)
      END IF
      IF ((h6b .lt. h2b) .and. (h2b .le. h7b) .and. (p4b .lt. p1b) .and.
     & (p1b .le. p5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p1b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h8b_2 - 1 + noab * (h7b_2 - 1
     & + noab * (h2b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h7b-1),int_mb(k_range+h8b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p1b-1)
     &,int_mb(k_range+p5b-1),7,2,4,3,1,8,6,5,-1.0d0,.false.)
      END IF
      IF ((h6b .lt. h2b) .and. (h2b .le. h7b) .and. (p3b .lt. p1b) .and.
     & (p1b .le. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h8b_2 - 1 + noab * (h7b_2 - 1
     & + noab * (h2b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h7b-1),int_mb(k_range+h8b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p1b-1),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p5b-1),6,2,4,3,1,8,7,5,1.0d0,.false.)
      END IF
      IF ((h6b .lt. h2b) .and. (h2b .le. h7b) .and. (p1b .le. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h8b_2 - 1 + noab * (h7b_2 - 1
     & + noab * (h2b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h7b-1),int_mb(k_range+h8b-1)
     &,int_mb(k_range+p1b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p5b-1),5,2,4,3,1,8,7,6,-1.0d0,.false.)
      END IF
      IF ((h2b .le. h6b) .and. (p5b .lt. p1b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p1b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h8b_2 - 1 + noab * (h7b_2 - 1
     & + noab * (h6b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h8b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p1b-1),8,1,4,3,2,7,6,5,-1.0d0,.false.)
      END IF
      IF ((h2b .le. h6b) .and. (p4b .lt. p1b) .and. (p1b .le. p5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p1b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h8b_2 - 1 + noab * (h7b_2 - 1
     & + noab * (h6b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h8b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p1b-1)
     &,int_mb(k_range+p5b-1),7,1,4,3,2,8,6,5,1.0d0,.false.)
      END IF
      IF ((h2b .le. h6b) .and. (p3b .lt. p1b) .and. (p1b .le. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h8b_2 - 1 + noab * (h7b_2 - 1
     & + noab * (h6b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h8b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p1b-1),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p5b-1),6,1,4,3,2,8,7,5,-1.0d0,.false.)
      END IF
      IF ((h2b .le. h6b) .and. (p1b .le. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h8b_2 - 1 + noab * (h7b_2 - 1
     & + noab * (h6b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h8b-1)
     &,int_mb(k_range+p1b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p5b-1),5,1,4,3,2,8,7,6,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_1_4',
     &6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      nsuperp(3) = 1
      isuperp = 1
      IF (p3b .eq. p4b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      IF (p4b .eq. p5b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      nsubh(1) = 1
      nsubh(2) = 1
      nsubh(3) = 1
      isubh = 1
      IF (h6b .eq. h7b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      IF (h7b .eq. h8b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,36.0d0/FACTO
     &RIAL(nsuperp(1))/FACTORIAL(nsuperp(2))/FACTORIAL(nsuperp(3))/FACTO
     &RIAL(nsubh(1))/FACTORIAL(nsubh(2))/FACTORIAL(nsubh(3)),dbl_mb(k_a_
     &sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c_sort
     &),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &1_4',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &1_4',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_1_4',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p1b-1)
     &,int_mb(k_range+h2b-1),2,1,1.0d0/36.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p1b -
     & noab - 1 + nvab * (h2b - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_1_4',
     &10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &1_4',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_2(d_a,k_a_offset,d_b,k_b_offset,d_c,
     &k_c_offset)
C     i0 ( )_dxy + = 1 * y ( )_y * i1 ( )_dx
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      IF (next .eq. count) THEN
      IF (0 .eq. ieor(irrep_d,ieor(irrep_x,irrep_y))) THEN
      dimc = 1
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_2',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      IF (0 .eq. irrep_y) THEN
      dim_common = 1
      dima_sort = 1
      dima = dim_common * dima_sort
      dimb_sort = 1
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_2',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_2',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),0)
      CALL TCE_SORT_0(dbl_mb(k_a),dbl_mb(k_a_sort),1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_2',3,
     &MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_2',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_2',5,MA_ERR)
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),0)
      CALL TCE_SORT_0(dbl_mb(k_b),dbl_mb(k_b_sort),1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_2',6,
     &MA_ERR)
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,1.0d0,dbl_mb
     &(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c
     &_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &2',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &2',8,MA_ERR)
      END IF
      END IF
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_2',9,MA_ERR)
      CALL TCE_SORT_0(dbl_mb(k_c_sort),dbl_mb(k_c),1.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),0)
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_2',10
     &,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &2',11,MA_ERR)
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_2_1(d_a,k_a_offset,d_b,k_b_offset,d_
     &c,k_c_offset)
C     i1 ( )_dx + = 1 * Sum ( h1 p2 ) * d ( h1 p2 )_d * x ( p2 h1 )_x
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER h1b
      INTEGER p2b
      INTEGER h1b_1
      INTEGER p2b_1
      INTEGER p2b_2
      INTEGER h1b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      IF (next .eq. count) THEN
      IF (0 .eq. ieor(irrep_d,irrep_x)) THEN
      dimc = 1
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_2_1',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO h1b = 1,noab
      DO p2b = noab+1,noab+nvab
      IF (int_mb(k_spin+h1b-1) .eq. int_mb(k_spin+p2b-1)) THEN
      IF (ieor(int_mb(k_sym+h1b-1),int_mb(k_sym+p2b-1)) .eq. irrep_d) TH
     &EN
      CALL TCE_RESTRICTED_2(h1b,p2b,h1b_1,p2b_1)
      CALL TCE_RESTRICTED_2(p2b,h1b,p2b_2,h1b_2)
      dim_common = int_mb(k_range+h1b-1) * int_mb(k_range+p2b-1)
      dima_sort = 1
      dima = dim_common * dima_sort
      dimb_sort = 1
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_2_1',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_2_1',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(p2b_1
     & - 1 + (noab+nvab) * (h1b_1 - 1)))
      CALL TCE_SORT_2(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+p2b-1),2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_2_1',
     &3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_2_1',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_2_1',5,MA_ERR)
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(h1b_2
     & - 1 + noab * (p2b_2 - noab - 1)))
      CALL TCE_SORT_2(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+p2b-1)
     &,int_mb(k_range+h1b-1),1,2,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_2_1',
     &6,MA_ERR)
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,1.0d0,dbl_mb
     &(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c
     &_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &2_1',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &2_1',8,MA_ERR)
      END IF
      END IF
      END IF
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_2_1',9,MA_ERR)
      CALL TCE_SORT_0(dbl_mb(k_c_sort),dbl_mb(k_c),1.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),0)
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_2_1',
     &10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &2_1',11,MA_ERR)
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE OFFSET_eomccsdtq_density1_2_1(l_a_offset,k_a_offset,siz
     &e)
C     i1 ( )_dx
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER l_a_offset
      INTEGER k_a_offset
      INTEGER length
      INTEGER addr
      DOUBLE PRECISION size
      length = 0
      IF (0 .eq. ieor(irrep_d,irrep_x)) THEN
      length = length + 1
      END IF
      IF (.not.MA_PUSH_GET(mt_dbl,2*length+1,'noname',l_a_offset,k_a_off
     &set)) CALL ERRQUIT('eomccsdtq_density1_2_1',0,MA_ERR)
      dbl_mb(k_a_offset) = dfloat(length)
      addr = 0
      size = 0.0d0
      IF (0 .eq. ieor(irrep_d,irrep_x)) THEN
      addr = addr + 1
      dbl_mb(k_a_offset+addr) = dfloat(0)
      dbl_mb(k_a_offset+length+addr) = size
      size = 1.0d0
      END IF
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_2_2(d_a,k_a_offset,d_b,k_b_offset,d_
     &c,k_c_offset)
C     i1 ( )_dtx + = 1 * x ( )_x * i2 ( )_dt
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      IF (next .eq. count) THEN
      IF (0 .eq. ieor(irrep_d,ieor(irrep_t,irrep_x))) THEN
      dimc = 1
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_2_2',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      IF (0 .eq. irrep_x) THEN
      dim_common = 1
      dima_sort = 1
      dima = dim_common * dima_sort
      dimb_sort = 1
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_2_2',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_2_2',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),0)
      CALL TCE_SORT_0(dbl_mb(k_a),dbl_mb(k_a_sort),1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_2_2',
     &3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_2_2',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_2_2',5,MA_ERR)
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),0)
      CALL TCE_SORT_0(dbl_mb(k_b),dbl_mb(k_b_sort),1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_2_2',
     &6,MA_ERR)
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,1.0d0,dbl_mb
     &(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c
     &_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &2_2',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &2_2',8,MA_ERR)
      END IF
      END IF
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_2_2',9,MA_ERR)
      CALL TCE_SORT_0(dbl_mb(k_c_sort),dbl_mb(k_c),1.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),0)
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_2_2',
     &10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &2_2',11,MA_ERR)
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_2_2_1(d_a,k_a_offset,d_b,k_b_offset,
     &d_c,k_c_offset)
C     i2 ( )_dt + = 1 * Sum ( h1 p2 ) * d ( h1 p2 )_d * t ( p2 h1 )_t
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER h1b
      INTEGER p2b
      INTEGER h1b_1
      INTEGER p2b_1
      INTEGER p2b_2
      INTEGER h1b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      IF (next .eq. count) THEN
      IF (0 .eq. ieor(irrep_d,irrep_t)) THEN
      dimc = 1
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_2_2_1',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO h1b = 1,noab
      DO p2b = noab+1,noab+nvab
      IF (int_mb(k_spin+h1b-1) .eq. int_mb(k_spin+p2b-1)) THEN
      IF (ieor(int_mb(k_sym+h1b-1),int_mb(k_sym+p2b-1)) .eq. irrep_d) TH
     &EN
      CALL TCE_RESTRICTED_2(h1b,p2b,h1b_1,p2b_1)
      CALL TCE_RESTRICTED_2(p2b,h1b,p2b_2,h1b_2)
      dim_common = int_mb(k_range+h1b-1) * int_mb(k_range+p2b-1)
      dima_sort = 1
      dima = dim_common * dima_sort
      dimb_sort = 1
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_2_2_1',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_2_2_1',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(p2b_1
     & - 1 + (noab+nvab) * (h1b_1 - 1)))
      CALL TCE_SORT_2(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+p2b-1),2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_2_2_1
     &',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_2_2_1',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_2_2_1',5,MA_ERR)
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(h1b_2
     & - 1 + noab * (p2b_2 - noab - 1)))
      CALL TCE_SORT_2(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+p2b-1)
     &,int_mb(k_range+h1b-1),1,2,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_2_2_1
     &',6,MA_ERR)
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,1.0d0,dbl_mb
     &(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c
     &_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &2_2_1',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &2_2_1',8,MA_ERR)
      END IF
      END IF
      END IF
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_2_2_1',9,MA_ERR)
      CALL TCE_SORT_0(dbl_mb(k_c_sort),dbl_mb(k_c),1.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),0)
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_2_2_1
     &',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &2_2_1',11,MA_ERR)
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE OFFSET_eomccsdtq_density1_2_2_1(l_a_offset,k_a_offset,s
     &ize)
C     i2 ( )_dt
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER l_a_offset
      INTEGER k_a_offset
      INTEGER length
      INTEGER addr
      DOUBLE PRECISION size
      length = 0
      IF (0 .eq. ieor(irrep_d,irrep_t)) THEN
      length = length + 1
      END IF
      IF (.not.MA_PUSH_GET(mt_dbl,2*length+1,'noname',l_a_offset,k_a_off
     &set)) CALL ERRQUIT('eomccsdtq_density1_2_2_1',0,MA_ERR)
      dbl_mb(k_a_offset) = dfloat(length)
      addr = 0
      size = 0.0d0
      IF (0 .eq. ieor(irrep_d,irrep_t)) THEN
      addr = addr + 1
      dbl_mb(k_a_offset+addr) = dfloat(0)
      dbl_mb(k_a_offset+length+addr) = size
      size = 1.0d0
      END IF
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_3(d_a,k_a_offset,d_b,k_b_offset,d_c,
     &k_c_offset)
C     i0 ( )_yxd + = -1 * Sum ( h2 h1 ) * d ( h1 h2 )_d * i1 ( h2 h1 )_yx
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER h1b
      INTEGER h2b
      INTEGER h1b_1
      INTEGER h2b_1
      INTEGER h2b_2
      INTEGER h1b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      IF (next .eq. count) THEN
      IF (0 .eq. ieor(irrep_y,ieor(irrep_x,irrep_d))) THEN
      dimc = 1
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_3',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO h1b = 1,noab
      DO h2b = 1,noab
      IF (int_mb(k_spin+h1b-1) .eq. int_mb(k_spin+h2b-1)) THEN
      IF (ieor(int_mb(k_sym+h1b-1),int_mb(k_sym+h2b-1)) .eq. irrep_d) TH
     &EN
      CALL TCE_RESTRICTED_2(h1b,h2b,h1b_1,h2b_1)
      CALL TCE_RESTRICTED_2(h2b,h1b,h2b_2,h1b_2)
      dim_common = int_mb(k_range+h1b-1) * int_mb(k_range+h2b-1)
      dima_sort = 1
      dima = dim_common * dima_sort
      dimb_sort = 1
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_3',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_3',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h2b_1
     & - 1 + (noab+nvab) * (h1b_1 - 1)))
      CALL TCE_SORT_2(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h2b-1),2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_3',3,
     &MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_3',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_3',5,MA_ERR)
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(h1b_2
     & - 1 + noab * (h2b_2 - 1)))
      CALL TCE_SORT_2(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h1b-1),1,2,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_3',6,
     &MA_ERR)
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,1.0d0,dbl_mb
     &(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c
     &_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &3',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &3',8,MA_ERR)
      END IF
      END IF
      END IF
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_3',9,MA_ERR)
      CALL TCE_SORT_0(dbl_mb(k_c_sort),dbl_mb(k_c),-1.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),0)
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_3',10
     &,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &3',11,MA_ERR)
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_3_1(d_a,k_a_offset,d_b,k_b_offset,d_
     &c,k_c_offset)
C     i1 ( h2 h1 )_yx + = 1 * Sum ( p3 ) * x ( p3 h1 )_x * y ( h2 p3 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h2b
      INTEGER h1b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p3b
      INTEGER p3b_1
      INTEGER h1b_1
      INTEGER h2b_2
      INTEGER p3b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h2b = 1,noab
      DO h1b = 1,noab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+h1b-1
     &).ne.4)) THEN
      IF (int_mb(k_spin+h2b-1) .eq. int_mb(k_spin+h1b-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),int_mb(k_sym+h1b-1)) .eq. ieor(irrep_
     &y,irrep_x)) THEN
      dimc = int_mb(k_range+h2b-1) * int_mb(k_range+h1b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_3_1',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p3b = noab+1,noab+nvab
      IF (int_mb(k_spin+p3b-1) .eq. int_mb(k_spin+h1b-1)) THEN
      IF (ieor(int_mb(k_sym+p3b-1),int_mb(k_sym+h1b-1)) .eq. irrep_x) TH
     &EN
      CALL TCE_RESTRICTED_2(p3b,h1b,p3b_1,h1b_1)
      CALL TCE_RESTRICTED_2(h2b,p3b,h2b_2,p3b_2)
      dim_common = int_mb(k_range+p3b-1)
      dima_sort = int_mb(k_range+h1b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h2b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_3_1',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_3_1',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h1b_1
     & - 1 + noab * (p3b_1 - noab - 1)))
      CALL TCE_SORT_2(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+h1b-1),2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_3_1',
     &3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_3_1',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_3_1',5,MA_ERR)
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (h2b_2 - 1)))
      CALL TCE_SORT_2(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+p3b-1),1,2,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_3_1',
     &6,MA_ERR)
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,1.0d0,dbl_mb
     &(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c
     &_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &3_1',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &3_1',8,MA_ERR)
      END IF
      END IF
      END IF
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_3_1',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h1b-1),1,2,1.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(h1b -
     & 1 + noab * (h2b - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_3_1',
     &10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &3_1',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE OFFSET_eomccsdtq_density1_3_1(l_a_offset,k_a_offset,siz
     &e)
C     i1 ( h2 h1 )_yx
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER l_a_offset
      INTEGER k_a_offset
      INTEGER length
      INTEGER addr
      INTEGER h2b
      INTEGER h1b
      DOUBLE PRECISION size
      length = 0
      DO h2b = 1,noab
      DO h1b = 1,noab
      IF (int_mb(k_spin+h2b-1) .eq. int_mb(k_spin+h1b-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),int_mb(k_sym+h1b-1)) .eq. ieor(irrep_
     &y,irrep_x)) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+h1b-1
     &).ne.4)) THEN
      length = length + 1
      END IF
      END IF
      END IF
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,2*length+1,'noname',l_a_offset,k_a_off
     &set)) CALL ERRQUIT('eomccsdtq_density1_3_1',0,MA_ERR)
      dbl_mb(k_a_offset) = dfloat(length)
      addr = 0
      size = 0.0d0
      DO h2b = 1,noab
      DO h1b = 1,noab
      IF (int_mb(k_spin+h2b-1) .eq. int_mb(k_spin+h1b-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),int_mb(k_sym+h1b-1)) .eq. ieor(irrep_
     &y,irrep_x)) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+h1b-1
     &).ne.4)) THEN
      addr = addr + 1
      dbl_mb(k_a_offset+addr) = dfloat(h1b - 1 + noab * (h2b - 1))
      dbl_mb(k_a_offset+length+addr) = size
      size = size + dfloat(int_mb(k_range+h2b-1)) * dfloat(int_mb(k_rang
     &e+h1b-1))
      END IF
      END IF
      END IF
      END DO
      END DO
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_3_2(d_a,k_a_offset,d_b,k_b_offset,d_
     &c,k_c_offset)
C     i1 ( h2 h1 )_yx + = 1/2 * Sum ( h5 p4 p3 ) * x ( p3 p4 h1 h5 )_x * y ( h2 h5 p3 p4 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h2b
      INTEGER h1b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p3b
      INTEGER p4b
      INTEGER h5b
      INTEGER p3b_1
      INTEGER p4b_1
      INTEGER h1b_1
      INTEGER h5b_1
      INTEGER h2b_2
      INTEGER h5b_2
      INTEGER p3b_2
      INTEGER p4b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(2)
      INTEGER isuperp
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h2b = 1,noab
      DO h1b = 1,noab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+h1b-1
     &).ne.4)) THEN
      IF (int_mb(k_spin+h2b-1) .eq. int_mb(k_spin+h1b-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),int_mb(k_sym+h1b-1)) .eq. ieor(irrep_
     &y,irrep_x)) THEN
      dimc = int_mb(k_range+h2b-1) * int_mb(k_range+h1b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_3_2',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      DO h5b = 1,noab
      IF (int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1) .eq. int_mb(k_spin+h
     &1b-1)+int_mb(k_spin+h5b-1)) THEN
      IF (ieor(int_mb(k_sym+p3b-1),ieor(int_mb(k_sym+p4b-1),ieor(int_mb(
     &k_sym+h1b-1),int_mb(k_sym+h5b-1)))) .eq. irrep_x) THEN
      CALL TCE_RESTRICTED_4(p3b,p4b,h1b,h5b,p3b_1,p4b_1,h1b_1,h5b_1)
      CALL TCE_RESTRICTED_4(h2b,h5b,p3b,p4b,h2b_2,h5b_2,p3b_2,p4b_2)
      dim_common = int_mb(k_range+p3b-1) * int_mb(k_range+p4b-1) * int_m
     &b(k_range+h5b-1)
      dima_sort = int_mb(k_range+h1b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h2b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_3_2',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_3_2',2,MA_ERR)
      IF ((h5b .lt. h1b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h1b_1
     & - 1 + noab * (h5b_1 - 1 + noab * (p4b_1 - noab - 1 + nvab * (p3b_
     &1 - noab - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+h5b-1),int_mb(k_range+h1b-1)
     &,4,3,2,1,-1.0d0,.false.)
      END IF
      IF ((h1b .le. h5b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h5b_1
     & - 1 + noab * (h1b_1 - 1 + noab * (p4b_1 - noab - 1 + nvab * (p3b_
     &1 - noab - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+h1b-1),int_mb(k_range+h5b-1)
     &,3,4,2,1,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_3_2',
     &3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_3_2',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_3_2',5,MA_ERR)
      IF ((h5b .lt. h2b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (h2b_2 - 1 + noab 
     &* (h5b_2 - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1)
     &,2,1,4,3,-1.0d0,.false.)
      END IF
      IF ((h2b .le. h5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab 
     &* (h2b_2 - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1)
     &,1,2,4,3,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_3_2',
     &6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      isuperp = 1
      IF (p3b .eq. p4b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,2.0d0/FACTOR
     &IAL(nsuperp(1))/FACTORIAL(nsuperp(2)),dbl_mb(k_a_sort),dim_common,
     &dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &3_2',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &3_2',8,MA_ERR)
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_3_2',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h1b-1),1,2,1.0d0/2.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(h1b -
     & 1 + noab * (h2b - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_3_2',
     &10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &3_2',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_3_3(d_a,k_a_offset,d_b,k_b_offset,d_
     &c,k_c_offset)
C     i1 ( h2 h1 )_yx + = 1/12 * Sum ( h7 h6 p5 p4 p3 ) * x ( p3 p4 p5 h1 h6 h7 )_x * y ( h2 h6 h7 p3 p4 p5 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h2b
      INTEGER h1b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p3b
      INTEGER p4b
      INTEGER p5b
      INTEGER h6b
      INTEGER h7b
      INTEGER p3b_1
      INTEGER p4b_1
      INTEGER p5b_1
      INTEGER h1b_1
      INTEGER h6b_1
      INTEGER h7b_1
      INTEGER h2b_2
      INTEGER h6b_2
      INTEGER h7b_2
      INTEGER p3b_2
      INTEGER p4b_2
      INTEGER p5b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(3)
      INTEGER isuperp
      INTEGER nsubh(2)
      INTEGER isubh
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h2b = 1,noab
      DO h1b = 1,noab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+h1b-1
     &).ne.4)) THEN
      IF (int_mb(k_spin+h2b-1) .eq. int_mb(k_spin+h1b-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),int_mb(k_sym+h1b-1)) .eq. ieor(irrep_
     &y,irrep_x)) THEN
      dimc = int_mb(k_range+h2b-1) * int_mb(k_range+h1b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_3_3',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      DO p5b = p4b,noab+nvab
      DO h6b = 1,noab
      DO h7b = h6b,noab
      IF (int_mb(k_active+p3b-1)+int_mb(k_active+p4b-1)+int_mb(k_active+
     &p5b-1) .ge. numact) THEN
      IF (int_mb(k_active+h1b-1)+int_mb(k_active+h6b-1)+int_mb(k_active+
     &h7b-1) .ge. numact) THEN
      IF (int_mb(k_active+h2b-1)+int_mb(k_active+h6b-1)+int_mb(k_active+
     &h7b-1) .ge. numact) THEN
      IF (int_mb(k_active+p3b-1)+int_mb(k_active+p4b-1)+int_mb(k_active+
     &p5b-1) .ge. numact) THEN
      IF (int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1)+int_mb(k_spin+p5b-1)
     & .eq. int_mb(k_spin+h1b-1)+int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b-
     &1)) THEN
      IF (ieor(int_mb(k_sym+p3b-1),ieor(int_mb(k_sym+p4b-1),ieor(int_mb(
     &k_sym+p5b-1),ieor(int_mb(k_sym+h1b-1),ieor(int_mb(k_sym+h6b-1),int
     &_mb(k_sym+h7b-1)))))) .eq. irrep_x) THEN
      CALL TCE_RESTRICTED_6(p3b,p4b,p5b,h1b,h6b,h7b,p3b_1,p4b_1,p5b_1,h1
     &b_1,h6b_1,h7b_1)
      CALL TCE_RESTRICTED_6(h2b,h6b,h7b,p3b,p4b,p5b,h2b_2,h6b_2,h7b_2,p3
     &b_2,p4b_2,p5b_2)
      dim_common = int_mb(k_range+p3b-1) * int_mb(k_range+p4b-1) * int_m
     &b(k_range+p5b-1) * int_mb(k_range+h6b-1) * int_mb(k_range+h7b-1)
      dima_sort = int_mb(k_range+h1b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h2b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_3_3',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_3_3',2,MA_ERR)
      IF ((h7b .lt. h1b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h1b_1
     & - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 + noab * (p5b_1 - noa
     &b - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h1b-1),6,5,4,3,2,1,1.0d0,.fa
     &lse.)
      END IF
      IF ((h6b .lt. h1b) .and. (h1b .le. h7b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h7b_1
     & - 1 + noab * (h1b_1 - 1 + noab * (h6b_1 - 1 + noab * (p5b_1 - noa
     &b - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h1b-1),int_mb(k_range+h7b-1),5,6,4,3,2,1,-1.0d0,.f
     &alse.)
      END IF
      IF ((h1b .le. h6b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h7b_1
     & - 1 + noab * (h6b_1 - 1 + noab * (h1b_1 - 1 + noab * (p5b_1 - noa
     &b - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),4,6,5,3,2,1,1.0d0,.fa
     &lse.)
      END IF
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_3_3',
     &3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_3_3',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_3_3',5,MA_ERR)
      IF ((h7b .lt. h2b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h2b_2 - 1 + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h2b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),3,2,1,6,5,4,1.0d0,.fa
     &lse.)
      END IF
      IF ((h6b .lt. h2b) .and. (h2b .le. h7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h7b_2 - 1 + noab * (h2b_2 - 1 + noab * (h6b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h7b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),2,3,1,6,5,4,-1.0d0,.f
     &alse.)
      END IF
      IF ((h2b .le. h6b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h7b_2 - 1 + noab * (h6b_2 - 1 + noab * (h2b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),1,3,2,6,5,4,1.0d0,.fa
     &lse.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_3_3',
     &6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      nsuperp(3) = 1
      isuperp = 1
      IF (p3b .eq. p4b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      IF (p4b .eq. p5b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      nsubh(1) = 1
      nsubh(2) = 1
      isubh = 1
      IF (h6b .eq. h7b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,12.0d0/FACTO
     &RIAL(nsuperp(1))/FACTORIAL(nsuperp(2))/FACTORIAL(nsuperp(3))/FACTO
     &RIAL(nsubh(1))/FACTORIAL(nsubh(2)),dbl_mb(k_a_sort),dim_common,dbl
     &_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &3_3',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &3_3',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_3_3',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h1b-1),1,2,1.0d0/12.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(h1b -
     & 1 + noab * (h2b - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_3_3',
     &10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &3_3',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_3_4(d_a,k_a_offset,d_b,k_b_offset,d_
     &c,k_c_offset)
C     i1 ( h2 h1 )_yx + = 1/144 * Sum ( h9 h8 h7 p6 p5 p4 p3 ) * x ( p3 p4 p5 p6 h1 h7 h8 h9 )_x * y ( h2 h7 h8 h9 p3 p4 p5 p6 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h2b
      INTEGER h1b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p3b
      INTEGER p4b
      INTEGER p5b
      INTEGER p6b
      INTEGER h7b
      INTEGER h8b
      INTEGER h9b
      INTEGER p3b_1
      INTEGER p4b_1
      INTEGER p5b_1
      INTEGER p6b_1
      INTEGER h1b_1
      INTEGER h7b_1
      INTEGER h8b_1
      INTEGER h9b_1
      INTEGER h2b_2
      INTEGER h7b_2
      INTEGER h8b_2
      INTEGER h9b_2
      INTEGER p3b_2
      INTEGER p4b_2
      INTEGER p5b_2
      INTEGER p6b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(4)
      INTEGER isuperp
      INTEGER nsubh(3)
      INTEGER isubh
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h2b = 1,noab
      DO h1b = 1,noab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+h1b-1
     &).ne.4)) THEN
      IF (int_mb(k_spin+h2b-1) .eq. int_mb(k_spin+h1b-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),int_mb(k_sym+h1b-1)) .eq. ieor(irrep_
     &y,irrep_x)) THEN
      dimc = int_mb(k_range+h2b-1) * int_mb(k_range+h1b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_3_4',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      DO p5b = p4b,noab+nvab
      DO p6b = p5b,noab+nvab
      DO h7b = 1,noab
      DO h8b = h7b,noab
      DO h9b = h8b,noab
      IF (int_mb(k_active+p3b-1)+int_mb(k_active+p4b-1)+int_mb(k_active+
     &p5b-1)+int_mb(k_active+p6b-1) .ge. numacq) THEN
      IF (int_mb(k_active+h1b-1)+int_mb(k_active+h7b-1)+int_mb(k_active+
     &h8b-1)+int_mb(k_active+h9b-1) .ge. numacq) THEN
      IF (int_mb(k_active+h2b-1)+int_mb(k_active+h7b-1)+int_mb(k_active+
     &h8b-1)+int_mb(k_active+h9b-1) .ge. numacq) THEN
      IF (int_mb(k_active+p3b-1)+int_mb(k_active+p4b-1)+int_mb(k_active+
     &p5b-1)+int_mb(k_active+p6b-1) .ge. numacq) THEN
      IF (int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1)+int_mb(k_spin+p5b-1)
     &+int_mb(k_spin+p6b-1) .eq. int_mb(k_spin+h1b-1)+int_mb(k_spin+h7b-
     &1)+int_mb(k_spin+h8b-1)+int_mb(k_spin+h9b-1)) THEN
      IF (ieor(int_mb(k_sym+p3b-1),ieor(int_mb(k_sym+p4b-1),ieor(int_mb(
     &k_sym+p5b-1),ieor(int_mb(k_sym+p6b-1),ieor(int_mb(k_sym+h1b-1),ieo
     &r(int_mb(k_sym+h7b-1),ieor(int_mb(k_sym+h8b-1),int_mb(k_sym+h9b-1)
     &))))))) .eq. irrep_x) THEN
      CALL TCE_RESTRICTED_8(p3b,p4b,p5b,p6b,h1b,h7b,h8b,h9b,p3b_1,p4b_1,
     &p5b_1,p6b_1,h1b_1,h7b_1,h8b_1,h9b_1)
      CALL TCE_RESTRICTED_8(h2b,h7b,h8b,h9b,p3b,p4b,p5b,p6b,h2b_2,h7b_2,
     &h8b_2,h9b_2,p3b_2,p4b_2,p5b_2,p6b_2)
      dim_common = int_mb(k_range+p3b-1) * int_mb(k_range+p4b-1) * int_m
     &b(k_range+p5b-1) * int_mb(k_range+p6b-1) * int_mb(k_range+h7b-1) *
     & int_mb(k_range+h8b-1) * int_mb(k_range+h9b-1)
      dima_sort = int_mb(k_range+h1b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h2b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_3_4',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_3_4',2,MA_ERR)
      IF ((h9b .lt. h1b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h1b_1
     & - 1 + noab * (h9b_1 - 1 + noab * (h8b_1 - 1 + noab * (h7b_1 - 1 +
     & noab * (p6b_1 - noab - 1 + nvab * (p5b_1 - noab - 1 + nvab * (p4b
     &_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h1b-1),8,7,6,5,4,3,2,1,-1.0d0,.false.)
      END IF
      IF ((h8b .lt. h1b) .and. (h1b .le. h9b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h9b_1
     & - 1 + noab * (h1b_1 - 1 + noab * (h8b_1 - 1 + noab * (h7b_1 - 1 +
     & noab * (p6b_1 - noab - 1 + nvab * (p5b_1 - noab - 1 + nvab * (p4b
     &_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h9b-1),7,8,6,5,4,3,2,1,1.0d0,.false.)
      END IF
      IF ((h7b .lt. h1b) .and. (h1b .le. h8b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h9b_1
     & - 1 + noab * (h8b_1 - 1 + noab * (h1b_1 - 1 + noab * (h7b_1 - 1 +
     & noab * (p6b_1 - noab - 1 + nvab * (p5b_1 - noab - 1 + nvab * (p4b
     &_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h1b-1),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h9b-1),6,8,7,5,4,3,2,1,-1.0d0,.false.)
      END IF
      IF ((h1b .le. h7b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h9b_1
     & - 1 + noab * (h8b_1 - 1 + noab * (h7b_1 - 1 + noab * (h1b_1 - 1 +
     & noab * (p6b_1 - noab - 1 + nvab * (p5b_1 - noab - 1 + nvab * (p4b
     &_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1)
     &,int_mb(k_range+h1b-1),int_mb(k_range+h7b-1),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h9b-1),5,8,7,6,4,3,2,1,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_3_4',
     &3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_3_4',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_3_4',5,MA_ERR)
      IF ((h9b .lt. h2b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h2b_2 - 1 + noab * (h9b_2 - 1
     & + noab * (h8b_2 - 1 + noab * (h7b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h9b-1),int_mb(k_range+h2b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p6b-1),4,3,2,1,8,7,6,5,-1.0d0,.false.)
      END IF
      IF ((h8b .lt. h2b) .and. (h2b .le. h9b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h2b_2 - 1
     & + noab * (h8b_2 - 1 + noab * (h7b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h2b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p6b-1),3,4,2,1,8,7,6,5,1.0d0,.false.)
      END IF
      IF ((h7b .lt. h2b) .and. (h2b .le. h8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h8b_2 - 1
     & + noab * (h2b_2 - 1 + noab * (h7b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p6b-1),2,4,3,1,8,7,6,5,-1.0d0,.false.)
      END IF
      IF ((h2b .le. h7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h8b_2 - 1
     & + noab * (h7b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p6b-1),1,4,3,2,8,7,6,5,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_3_4',
     &6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      nsuperp(3) = 1
      nsuperp(4) = 1
      isuperp = 1
      IF (p3b .eq. p4b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      IF (p4b .eq. p5b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      IF (p5b .eq. p6b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      nsubh(1) = 1
      nsubh(2) = 1
      nsubh(3) = 1
      isubh = 1
      IF (h7b .eq. h8b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      IF (h8b .eq. h9b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,144.0d0/FACT
     &ORIAL(nsuperp(1))/FACTORIAL(nsuperp(2))/FACTORIAL(nsuperp(3))/FACT
     &ORIAL(nsuperp(4))/FACTORIAL(nsubh(1))/FACTORIAL(nsubh(2))/FACTORIA
     &L(nsubh(3)),dbl_mb(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_commo
     &n,1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &3_4',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &3_4',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_3_4',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h1b-1),1,2,1.0d0/144.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(h1b -
     & 1 + noab * (h2b - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_3_4',
     &10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &3_4',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_3_5(d_a,k_a_offset,d_b,k_b_offset,d_
     &c,k_c_offset)
C     i1 ( h2 h1 )_ytx + = 1 * x ( )_x * i2 ( h2 h1 )_yt
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h2b
      INTEGER h1b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER h2b_2
      INTEGER h1b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h2b = 1,noab
      DO h1b = 1,noab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+h1b-1
     &).ne.4)) THEN
      IF (int_mb(k_spin+h2b-1) .eq. int_mb(k_spin+h1b-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),int_mb(k_sym+h1b-1)) .eq. ieor(irrep_
     &y,ieor(irrep_t,irrep_x))) THEN
      dimc = int_mb(k_range+h2b-1) * int_mb(k_range+h1b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_3_5',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      IF (0 .eq. irrep_x) THEN
      CALL TCE_RESTRICTED_2(h2b,h1b,h2b_2,h1b_2)
      dim_common = 1
      dima_sort = 1
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h2b-1) * int_mb(k_range+h1b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_3_5',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_3_5',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),0)
      CALL TCE_SORT_0(dbl_mb(k_a),dbl_mb(k_a_sort),1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_3_5',
     &3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_3_5',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_3_5',5,MA_ERR)
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(h1b_2
     & - 1 + noab * (h2b_2 - 1)))
      CALL TCE_SORT_2(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h1b-1),2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_3_5',
     &6,MA_ERR)
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,1.0d0,dbl_mb
     &(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c
     &_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &3_5',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &3_5',8,MA_ERR)
      END IF
      END IF
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_3_5',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h2b-1),2,1,1.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(h1b -
     & 1 + noab * (h2b - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_3_5',
     &10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &3_5',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_3_5_1(d_a,k_a_offset,d_b,k_b_offset,
     &d_c,k_c_offset)
C     i2 ( h2 h1 )_yt + = 1 * Sum ( p3 ) * t ( p3 h1 )_t * y ( h2 p3 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h2b
      INTEGER h1b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p3b
      INTEGER p3b_1
      INTEGER h1b_1
      INTEGER h2b_2
      INTEGER p3b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h2b = 1,noab
      DO h1b = 1,noab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+h1b-1
     &).ne.4)) THEN
      IF (int_mb(k_spin+h2b-1) .eq. int_mb(k_spin+h1b-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),int_mb(k_sym+h1b-1)) .eq. ieor(irrep_
     &y,irrep_t)) THEN
      dimc = int_mb(k_range+h2b-1) * int_mb(k_range+h1b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_3_5_1',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p3b = noab+1,noab+nvab
      IF (int_mb(k_spin+p3b-1) .eq. int_mb(k_spin+h1b-1)) THEN
      IF (ieor(int_mb(k_sym+p3b-1),int_mb(k_sym+h1b-1)) .eq. irrep_t) TH
     &EN
      CALL TCE_RESTRICTED_2(p3b,h1b,p3b_1,h1b_1)
      CALL TCE_RESTRICTED_2(h2b,p3b,h2b_2,p3b_2)
      dim_common = int_mb(k_range+p3b-1)
      dima_sort = int_mb(k_range+h1b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h2b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_3_5_1',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_3_5_1',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h1b_1
     & - 1 + noab * (p3b_1 - noab - 1)))
      CALL TCE_SORT_2(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+h1b-1),2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_3_5_1
     &',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_3_5_1',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_3_5_1',5,MA_ERR)
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (h2b_2 - 1)))
      CALL TCE_SORT_2(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+p3b-1),1,2,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_3_5_1
     &',6,MA_ERR)
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,1.0d0,dbl_mb
     &(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c
     &_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &3_5_1',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &3_5_1',8,MA_ERR)
      END IF
      END IF
      END IF
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_3_5_1',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h1b-1),1,2,1.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(h1b -
     & 1 + noab * (h2b - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_3_5_1
     &',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &3_5_1',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE OFFSET_eomccsdtq_density1_3_5_1(l_a_offset,k_a_offset,s
     &ize)
C     i2 ( h2 h1 )_yt
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER l_a_offset
      INTEGER k_a_offset
      INTEGER length
      INTEGER addr
      INTEGER h2b
      INTEGER h1b
      DOUBLE PRECISION size
      length = 0
      DO h2b = 1,noab
      DO h1b = 1,noab
      IF (int_mb(k_spin+h2b-1) .eq. int_mb(k_spin+h1b-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),int_mb(k_sym+h1b-1)) .eq. ieor(irrep_
     &y,irrep_t)) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+h1b-1
     &).ne.4)) THEN
      length = length + 1
      END IF
      END IF
      END IF
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,2*length+1,'noname',l_a_offset,k_a_off
     &set)) CALL ERRQUIT('eomccsdtq_density1_3_5_1',0,MA_ERR)
      dbl_mb(k_a_offset) = dfloat(length)
      addr = 0
      size = 0.0d0
      DO h2b = 1,noab
      DO h1b = 1,noab
      IF (int_mb(k_spin+h2b-1) .eq. int_mb(k_spin+h1b-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),int_mb(k_sym+h1b-1)) .eq. ieor(irrep_
     &y,irrep_t)) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+h1b-1
     &).ne.4)) THEN
      addr = addr + 1
      dbl_mb(k_a_offset+addr) = dfloat(h1b - 1 + noab * (h2b - 1))
      dbl_mb(k_a_offset+length+addr) = size
      size = size + dfloat(int_mb(k_range+h2b-1)) * dfloat(int_mb(k_rang
     &e+h1b-1))
      END IF
      END IF
      END IF
      END DO
      END DO
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_3_5_2(d_a,k_a_offset,d_b,k_b_offset,
     &d_c,k_c_offset)
C     i2 ( h2 h1 )_yt + = 1/2 * Sum ( h5 p4 p3 ) * t ( p3 p4 h1 h5 )_t * y ( h2 h5 p3 p4 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h2b
      INTEGER h1b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p3b
      INTEGER p4b
      INTEGER h5b
      INTEGER p3b_1
      INTEGER p4b_1
      INTEGER h1b_1
      INTEGER h5b_1
      INTEGER h2b_2
      INTEGER h5b_2
      INTEGER p3b_2
      INTEGER p4b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(2)
      INTEGER isuperp
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h2b = 1,noab
      DO h1b = 1,noab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+h1b-1
     &).ne.4)) THEN
      IF (int_mb(k_spin+h2b-1) .eq. int_mb(k_spin+h1b-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),int_mb(k_sym+h1b-1)) .eq. ieor(irrep_
     &y,irrep_t)) THEN
      dimc = int_mb(k_range+h2b-1) * int_mb(k_range+h1b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_3_5_2',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      DO h5b = 1,noab
      IF (int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1) .eq. int_mb(k_spin+h
     &1b-1)+int_mb(k_spin+h5b-1)) THEN
      IF (ieor(int_mb(k_sym+p3b-1),ieor(int_mb(k_sym+p4b-1),ieor(int_mb(
     &k_sym+h1b-1),int_mb(k_sym+h5b-1)))) .eq. irrep_t) THEN
      CALL TCE_RESTRICTED_4(p3b,p4b,h1b,h5b,p3b_1,p4b_1,h1b_1,h5b_1)
      CALL TCE_RESTRICTED_4(h2b,h5b,p3b,p4b,h2b_2,h5b_2,p3b_2,p4b_2)
      dim_common = int_mb(k_range+p3b-1) * int_mb(k_range+p4b-1) * int_m
     &b(k_range+h5b-1)
      dima_sort = int_mb(k_range+h1b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h2b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_3_5_2',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_3_5_2',2,MA_ERR)
      IF ((h5b .lt. h1b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h1b_1
     & - 1 + noab * (h5b_1 - 1 + noab * (p4b_1 - noab - 1 + nvab * (p3b_
     &1 - noab - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+h5b-1),int_mb(k_range+h1b-1)
     &,4,3,2,1,-1.0d0,.false.)
      END IF
      IF ((h1b .le. h5b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h5b_1
     & - 1 + noab * (h1b_1 - 1 + noab * (p4b_1 - noab - 1 + nvab * (p3b_
     &1 - noab - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+h1b-1),int_mb(k_range+h5b-1)
     &,3,4,2,1,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_3_5_2
     &',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_3_5_2',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_3_5_2',5,MA_ERR)
      IF ((h5b .lt. h2b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (h2b_2 - 1 + noab 
     &* (h5b_2 - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1)
     &,2,1,4,3,-1.0d0,.false.)
      END IF
      IF ((h2b .le. h5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab 
     &* (h2b_2 - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1)
     &,1,2,4,3,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_3_5_2
     &',6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      isuperp = 1
      IF (p3b .eq. p4b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,2.0d0/FACTOR
     &IAL(nsuperp(1))/FACTORIAL(nsuperp(2)),dbl_mb(k_a_sort),dim_common,
     &dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &3_5_2',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &3_5_2',8,MA_ERR)
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_3_5_2',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h1b-1),1,2,1.0d0/2.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(h1b -
     & 1 + noab * (h2b - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_3_5_2
     &',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &3_5_2',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_3_5_3(d_a,k_a_offset,d_b,k_b_offset,
     &d_c,k_c_offset)
C     i2 ( h2 h1 )_yt + = 1/12 * Sum ( h7 h6 p5 p4 p3 ) * t ( p3 p4 p5 h1 h6 h7 )_t * y ( h2 h6 h7 p3 p4 p5 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h2b
      INTEGER h1b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p3b
      INTEGER p4b
      INTEGER p5b
      INTEGER h6b
      INTEGER h7b
      INTEGER p3b_1
      INTEGER p4b_1
      INTEGER p5b_1
      INTEGER h1b_1
      INTEGER h6b_1
      INTEGER h7b_1
      INTEGER h2b_2
      INTEGER h6b_2
      INTEGER h7b_2
      INTEGER p3b_2
      INTEGER p4b_2
      INTEGER p5b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(3)
      INTEGER isuperp
      INTEGER nsubh(2)
      INTEGER isubh
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h2b = 1,noab
      DO h1b = 1,noab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+h1b-1
     &).ne.4)) THEN
      IF (int_mb(k_spin+h2b-1) .eq. int_mb(k_spin+h1b-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),int_mb(k_sym+h1b-1)) .eq. ieor(irrep_
     &y,irrep_t)) THEN
      dimc = int_mb(k_range+h2b-1) * int_mb(k_range+h1b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_3_5_3',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      DO p5b = p4b,noab+nvab
      DO h6b = 1,noab
      DO h7b = h6b,noab
      IF (int_mb(k_active+p3b-1)+int_mb(k_active+p4b-1)+int_mb(k_active+
     &p5b-1) .ge. numact) THEN
      IF (int_mb(k_active+h1b-1)+int_mb(k_active+h6b-1)+int_mb(k_active+
     &h7b-1) .ge. numact) THEN
      IF (int_mb(k_active+h2b-1)+int_mb(k_active+h6b-1)+int_mb(k_active+
     &h7b-1) .ge. numact) THEN
      IF (int_mb(k_active+p3b-1)+int_mb(k_active+p4b-1)+int_mb(k_active+
     &p5b-1) .ge. numact) THEN
      IF (int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1)+int_mb(k_spin+p5b-1)
     & .eq. int_mb(k_spin+h1b-1)+int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b-
     &1)) THEN
      IF (ieor(int_mb(k_sym+p3b-1),ieor(int_mb(k_sym+p4b-1),ieor(int_mb(
     &k_sym+p5b-1),ieor(int_mb(k_sym+h1b-1),ieor(int_mb(k_sym+h6b-1),int
     &_mb(k_sym+h7b-1)))))) .eq. irrep_t) THEN
      CALL TCE_RESTRICTED_6(p3b,p4b,p5b,h1b,h6b,h7b,p3b_1,p4b_1,p5b_1,h1
     &b_1,h6b_1,h7b_1)
      CALL TCE_RESTRICTED_6(h2b,h6b,h7b,p3b,p4b,p5b,h2b_2,h6b_2,h7b_2,p3
     &b_2,p4b_2,p5b_2)
      dim_common = int_mb(k_range+p3b-1) * int_mb(k_range+p4b-1) * int_m
     &b(k_range+p5b-1) * int_mb(k_range+h6b-1) * int_mb(k_range+h7b-1)
      dima_sort = int_mb(k_range+h1b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h2b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_3_5_3',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_3_5_3',2,MA_ERR)
      IF ((h7b .lt. h1b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h1b_1
     & - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 + noab * (p5b_1 - noa
     &b - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h1b-1),6,5,4,3,2,1,1.0d0,.fa
     &lse.)
      END IF
      IF ((h6b .lt. h1b) .and. (h1b .le. h7b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h7b_1
     & - 1 + noab * (h1b_1 - 1 + noab * (h6b_1 - 1 + noab * (p5b_1 - noa
     &b - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h1b-1),int_mb(k_range+h7b-1),5,6,4,3,2,1,-1.0d0,.f
     &alse.)
      END IF
      IF ((h1b .le. h6b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h7b_1
     & - 1 + noab * (h6b_1 - 1 + noab * (h1b_1 - 1 + noab * (p5b_1 - noa
     &b - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),4,6,5,3,2,1,1.0d0,.fa
     &lse.)
      END IF
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_3_5_3
     &',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_3_5_3',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_3_5_3',5,MA_ERR)
      IF ((h7b .lt. h2b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h2b_2 - 1 + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h2b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),3,2,1,6,5,4,1.0d0,.fa
     &lse.)
      END IF
      IF ((h6b .lt. h2b) .and. (h2b .le. h7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h7b_2 - 1 + noab * (h2b_2 - 1 + noab * (h6b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h7b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),2,3,1,6,5,4,-1.0d0,.f
     &alse.)
      END IF
      IF ((h2b .le. h6b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h7b_2 - 1 + noab * (h6b_2 - 1 + noab * (h2b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),1,3,2,6,5,4,1.0d0,.fa
     &lse.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_3_5_3
     &',6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      nsuperp(3) = 1
      isuperp = 1
      IF (p3b .eq. p4b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      IF (p4b .eq. p5b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      nsubh(1) = 1
      nsubh(2) = 1
      isubh = 1
      IF (h6b .eq. h7b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,12.0d0/FACTO
     &RIAL(nsuperp(1))/FACTORIAL(nsuperp(2))/FACTORIAL(nsuperp(3))/FACTO
     &RIAL(nsubh(1))/FACTORIAL(nsubh(2)),dbl_mb(k_a_sort),dim_common,dbl
     &_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &3_5_3',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &3_5_3',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_3_5_3',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h1b-1),1,2,1.0d0/12.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(h1b -
     & 1 + noab * (h2b - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_3_5_3
     &',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &3_5_3',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_3_5_4(d_a,k_a_offset,d_b,k_b_offset,
     &d_c,k_c_offset)
C     i2 ( h2 h1 )_yt + = 1/144 * Sum ( h9 h8 h7 p6 p5 p4 p3 ) * t ( p3 p4 p5 p6 h1 h7 h8 h9 )_t * y ( h2 h7 h8 h9 p3 p4 p5 p6 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h2b
      INTEGER h1b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p3b
      INTEGER p4b
      INTEGER p5b
      INTEGER p6b
      INTEGER h7b
      INTEGER h8b
      INTEGER h9b
      INTEGER p3b_1
      INTEGER p4b_1
      INTEGER p5b_1
      INTEGER p6b_1
      INTEGER h1b_1
      INTEGER h7b_1
      INTEGER h8b_1
      INTEGER h9b_1
      INTEGER h2b_2
      INTEGER h7b_2
      INTEGER h8b_2
      INTEGER h9b_2
      INTEGER p3b_2
      INTEGER p4b_2
      INTEGER p5b_2
      INTEGER p6b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(4)
      INTEGER isuperp
      INTEGER nsubh(3)
      INTEGER isubh
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h2b = 1,noab
      DO h1b = 1,noab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+h1b-1
     &).ne.4)) THEN
      IF (int_mb(k_spin+h2b-1) .eq. int_mb(k_spin+h1b-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),int_mb(k_sym+h1b-1)) .eq. ieor(irrep_
     &y,irrep_t)) THEN
      dimc = int_mb(k_range+h2b-1) * int_mb(k_range+h1b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_3_5_4',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      DO p5b = p4b,noab+nvab
      DO p6b = p5b,noab+nvab
      DO h7b = 1,noab
      DO h8b = h7b,noab
      DO h9b = h8b,noab
      IF (int_mb(k_active+p3b-1)+int_mb(k_active+p4b-1)+int_mb(k_active+
     &p5b-1)+int_mb(k_active+p6b-1) .ge. numacq) THEN
      IF (int_mb(k_active+h1b-1)+int_mb(k_active+h7b-1)+int_mb(k_active+
     &h8b-1)+int_mb(k_active+h9b-1) .ge. numacq) THEN
      IF (int_mb(k_active+h2b-1)+int_mb(k_active+h7b-1)+int_mb(k_active+
     &h8b-1)+int_mb(k_active+h9b-1) .ge. numacq) THEN
      IF (int_mb(k_active+p3b-1)+int_mb(k_active+p4b-1)+int_mb(k_active+
     &p5b-1)+int_mb(k_active+p6b-1) .ge. numacq) THEN
      IF (int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1)+int_mb(k_spin+p5b-1)
     &+int_mb(k_spin+p6b-1) .eq. int_mb(k_spin+h1b-1)+int_mb(k_spin+h7b-
     &1)+int_mb(k_spin+h8b-1)+int_mb(k_spin+h9b-1)) THEN
      IF (ieor(int_mb(k_sym+p3b-1),ieor(int_mb(k_sym+p4b-1),ieor(int_mb(
     &k_sym+p5b-1),ieor(int_mb(k_sym+p6b-1),ieor(int_mb(k_sym+h1b-1),ieo
     &r(int_mb(k_sym+h7b-1),ieor(int_mb(k_sym+h8b-1),int_mb(k_sym+h9b-1)
     &))))))) .eq. irrep_t) THEN
      CALL TCE_RESTRICTED_8(p3b,p4b,p5b,p6b,h1b,h7b,h8b,h9b,p3b_1,p4b_1,
     &p5b_1,p6b_1,h1b_1,h7b_1,h8b_1,h9b_1)
      CALL TCE_RESTRICTED_8(h2b,h7b,h8b,h9b,p3b,p4b,p5b,p6b,h2b_2,h7b_2,
     &h8b_2,h9b_2,p3b_2,p4b_2,p5b_2,p6b_2)
      dim_common = int_mb(k_range+p3b-1) * int_mb(k_range+p4b-1) * int_m
     &b(k_range+p5b-1) * int_mb(k_range+p6b-1) * int_mb(k_range+h7b-1) *
     & int_mb(k_range+h8b-1) * int_mb(k_range+h9b-1)
      dima_sort = int_mb(k_range+h1b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h2b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_3_5_4',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_3_5_4',2,MA_ERR)
      IF ((h9b .lt. h1b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h1b_1
     & - 1 + noab * (h9b_1 - 1 + noab * (h8b_1 - 1 + noab * (h7b_1 - 1 +
     & noab * (p6b_1 - noab - 1 + nvab * (p5b_1 - noab - 1 + nvab * (p4b
     &_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h1b-1),8,7,6,5,4,3,2,1,-1.0d0,.false.)
      END IF
      IF ((h8b .lt. h1b) .and. (h1b .le. h9b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h9b_1
     & - 1 + noab * (h1b_1 - 1 + noab * (h8b_1 - 1 + noab * (h7b_1 - 1 +
     & noab * (p6b_1 - noab - 1 + nvab * (p5b_1 - noab - 1 + nvab * (p4b
     &_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h9b-1),7,8,6,5,4,3,2,1,1.0d0,.false.)
      END IF
      IF ((h7b .lt. h1b) .and. (h1b .le. h8b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h9b_1
     & - 1 + noab * (h8b_1 - 1 + noab * (h1b_1 - 1 + noab * (h7b_1 - 1 +
     & noab * (p6b_1 - noab - 1 + nvab * (p5b_1 - noab - 1 + nvab * (p4b
     &_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h1b-1),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h9b-1),6,8,7,5,4,3,2,1,-1.0d0,.false.)
      END IF
      IF ((h1b .le. h7b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h9b_1
     & - 1 + noab * (h8b_1 - 1 + noab * (h7b_1 - 1 + noab * (h1b_1 - 1 +
     & noab * (p6b_1 - noab - 1 + nvab * (p5b_1 - noab - 1 + nvab * (p4b
     &_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1)
     &,int_mb(k_range+h1b-1),int_mb(k_range+h7b-1),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h9b-1),5,8,7,6,4,3,2,1,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_3_5_4
     &',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_3_5_4',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_3_5_4',5,MA_ERR)
      IF ((h9b .lt. h2b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h2b_2 - 1 + noab * (h9b_2 - 1
     & + noab * (h8b_2 - 1 + noab * (h7b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h9b-1),int_mb(k_range+h2b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p6b-1),4,3,2,1,8,7,6,5,-1.0d0,.false.)
      END IF
      IF ((h8b .lt. h2b) .and. (h2b .le. h9b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h2b_2 - 1
     & + noab * (h8b_2 - 1 + noab * (h7b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h2b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p6b-1),3,4,2,1,8,7,6,5,1.0d0,.false.)
      END IF
      IF ((h7b .lt. h2b) .and. (h2b .le. h8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h8b_2 - 1
     & + noab * (h2b_2 - 1 + noab * (h7b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p6b-1),2,4,3,1,8,7,6,5,-1.0d0,.false.)
      END IF
      IF ((h2b .le. h7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h8b_2 - 1
     & + noab * (h7b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p6b-1),1,4,3,2,8,7,6,5,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_3_5_4
     &',6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      nsuperp(3) = 1
      nsuperp(4) = 1
      isuperp = 1
      IF (p3b .eq. p4b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      IF (p4b .eq. p5b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      IF (p5b .eq. p6b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      nsubh(1) = 1
      nsubh(2) = 1
      nsubh(3) = 1
      isubh = 1
      IF (h7b .eq. h8b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      IF (h8b .eq. h9b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,144.0d0/FACT
     &ORIAL(nsuperp(1))/FACTORIAL(nsuperp(2))/FACTORIAL(nsuperp(3))/FACT
     &ORIAL(nsuperp(4))/FACTORIAL(nsubh(1))/FACTORIAL(nsubh(2))/FACTORIA
     &L(nsubh(3)),dbl_mb(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_commo
     &n,1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &3_5_4',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &3_5_4',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_3_5_4',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h1b-1),1,2,1.0d0/144.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(h1b -
     & 1 + noab * (h2b - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_3_5_4
     &',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &3_5_4',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_3_6(d_a,k_a_offset,d_b,k_b_offset,d_
     &c,k_c_offset)
C     i1 ( h2 h1 )_yxt + = 1 * Sum ( p3 ) * t ( p3 h1 )_t * i2 ( h2 p3 )_yx
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h2b
      INTEGER h1b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p3b
      INTEGER p3b_1
      INTEGER h1b_1
      INTEGER h2b_2
      INTEGER p3b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h2b = 1,noab
      DO h1b = 1,noab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+h1b-1
     &).ne.4)) THEN
      IF (int_mb(k_spin+h2b-1) .eq. int_mb(k_spin+h1b-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),int_mb(k_sym+h1b-1)) .eq. ieor(irrep_
     &y,ieor(irrep_x,irrep_t))) THEN
      dimc = int_mb(k_range+h2b-1) * int_mb(k_range+h1b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_3_6',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p3b = noab+1,noab+nvab
      IF (int_mb(k_spin+p3b-1) .eq. int_mb(k_spin+h1b-1)) THEN
      IF (ieor(int_mb(k_sym+p3b-1),int_mb(k_sym+h1b-1)) .eq. irrep_t) TH
     &EN
      CALL TCE_RESTRICTED_2(p3b,h1b,p3b_1,h1b_1)
      CALL TCE_RESTRICTED_2(h2b,p3b,h2b_2,p3b_2)
      dim_common = int_mb(k_range+p3b-1)
      dima_sort = int_mb(k_range+h1b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h2b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_3_6',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_3_6',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h1b_1
     & - 1 + noab * (p3b_1 - noab - 1)))
      CALL TCE_SORT_2(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+h1b-1),2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_3_6',
     &3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_3_6',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_3_6',5,MA_ERR)
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (h2b_2 - 1)))
      CALL TCE_SORT_2(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+p3b-1),1,2,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_3_6',
     &6,MA_ERR)
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,1.0d0,dbl_mb
     &(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c
     &_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &3_6',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &3_6',8,MA_ERR)
      END IF
      END IF
      END IF
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_3_6',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h1b-1),1,2,1.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(h1b -
     & 1 + noab * (h2b - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_3_6',
     &10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &3_6',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_3_6_1(d_a,k_a_offset,d_b,k_b_offset,
     &d_c,k_c_offset)
C     i2 ( h2 p3 )_yx + = 1 * Sum ( h5 p4 ) * x ( p4 h5 )_x * y ( h2 h5 p3 p4 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h2b
      INTEGER p3b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p4b
      INTEGER h5b
      INTEGER p4b_1
      INTEGER h5b_1
      INTEGER h2b_2
      INTEGER h5b_2
      INTEGER p3b_2
      INTEGER p4b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h2b = 1,noab
      DO p3b = noab+1,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+p3b-1
     &).ne.4)) THEN
      IF (int_mb(k_spin+h2b-1) .eq. int_mb(k_spin+p3b-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),int_mb(k_sym+p3b-1)) .eq. ieor(irrep_
     &y,irrep_x)) THEN
      dimc = int_mb(k_range+h2b-1) * int_mb(k_range+p3b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_3_6_1',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p4b = noab+1,noab+nvab
      DO h5b = 1,noab
      IF (int_mb(k_spin+p4b-1) .eq. int_mb(k_spin+h5b-1)) THEN
      IF (ieor(int_mb(k_sym+p4b-1),int_mb(k_sym+h5b-1)) .eq. irrep_x) TH
     &EN
      CALL TCE_RESTRICTED_2(p4b,h5b,p4b_1,h5b_1)
      CALL TCE_RESTRICTED_4(h2b,h5b,p3b,p4b,h2b_2,h5b_2,p3b_2,p4b_2)
      dim_common = int_mb(k_range+p4b-1) * int_mb(k_range+h5b-1)
      dima_sort = 1
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h2b-1) * int_mb(k_range+p3b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_3_6_1',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_3_6_1',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h5b_1
     & - 1 + noab * (p4b_1 - noab - 1)))
      CALL TCE_SORT_2(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p4b-1)
     &,int_mb(k_range+h5b-1),2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_3_6_1
     &',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_3_6_1',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_3_6_1',5,MA_ERR)
      IF ((h5b .lt. h2b) .and. (p4b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (h2b_2 - 1 + noab 
     &* (h5b_2 - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+p4b-1),int_mb(k_range+p3b-1)
     &,4,2,1,3,1.0d0,.false.)
      END IF
      IF ((h5b .lt. h2b) .and. (p3b .le. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (h2b_2 - 1 + noab 
     &* (h5b_2 - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1)
     &,3,2,1,4,-1.0d0,.false.)
      END IF
      IF ((h2b .le. h5b) .and. (p4b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab 
     &* (h2b_2 - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+p4b-1),int_mb(k_range+p3b-1)
     &,4,1,2,3,-1.0d0,.false.)
      END IF
      IF ((h2b .le. h5b) .and. (p3b .le. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab 
     &* (h2b_2 - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1)
     &,3,1,2,4,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_3_6_1
     &',6,MA_ERR)
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,1.0d0,dbl_mb
     &(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c
     &_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &3_6_1',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &3_6_1',8,MA_ERR)
      END IF
      END IF
      END IF
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_3_6_1',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p3b-1)
     &,int_mb(k_range+h2b-1),2,1,1.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p3b -
     & noab - 1 + nvab * (h2b - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_3_6_1
     &',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &3_6_1',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE OFFSET_eomccsdtq_density1_3_6_1(l_a_offset,k_a_offset,s
     &ize)
C     i2 ( h2 p3 )_yx
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER l_a_offset
      INTEGER k_a_offset
      INTEGER length
      INTEGER addr
      INTEGER h2b
      INTEGER p3b
      DOUBLE PRECISION size
      length = 0
      DO h2b = 1,noab
      DO p3b = noab+1,noab+nvab
      IF (int_mb(k_spin+h2b-1) .eq. int_mb(k_spin+p3b-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),int_mb(k_sym+p3b-1)) .eq. ieor(irrep_
     &y,irrep_x)) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+p3b-1
     &).ne.4)) THEN
      length = length + 1
      END IF
      END IF
      END IF
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,2*length+1,'noname',l_a_offset,k_a_off
     &set)) CALL ERRQUIT('eomccsdtq_density1_3_6_1',0,MA_ERR)
      dbl_mb(k_a_offset) = dfloat(length)
      addr = 0
      size = 0.0d0
      DO h2b = 1,noab
      DO p3b = noab+1,noab+nvab
      IF (int_mb(k_spin+h2b-1) .eq. int_mb(k_spin+p3b-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),int_mb(k_sym+p3b-1)) .eq. ieor(irrep_
     &y,irrep_x)) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+p3b-1
     &).ne.4)) THEN
      addr = addr + 1
      dbl_mb(k_a_offset+addr) = dfloat(p3b - noab - 1 + nvab * (h2b - 1)
     &)
      dbl_mb(k_a_offset+length+addr) = size
      size = size + dfloat(int_mb(k_range+h2b-1)) * dfloat(int_mb(k_rang
     &e+p3b-1))
      END IF
      END IF
      END IF
      END DO
      END DO
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_3_6_2(d_a,k_a_offset,d_b,k_b_offset,
     &d_c,k_c_offset)
C     i2 ( h2 p3 )_yx + = 1/4 * Sum ( h7 h6 p5 p4 ) * x ( p4 p5 h6 h7 )_x * y ( h2 h6 h7 p3 p4 p5 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h2b
      INTEGER p3b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p4b
      INTEGER p5b
      INTEGER h6b
      INTEGER h7b
      INTEGER p4b_1
      INTEGER p5b_1
      INTEGER h6b_1
      INTEGER h7b_1
      INTEGER h2b_2
      INTEGER h6b_2
      INTEGER h7b_2
      INTEGER p3b_2
      INTEGER p4b_2
      INTEGER p5b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(2)
      INTEGER isuperp
      INTEGER nsubh(2)
      INTEGER isubh
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h2b = 1,noab
      DO p3b = noab+1,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+p3b-1
     &).ne.4)) THEN
      IF (int_mb(k_spin+h2b-1) .eq. int_mb(k_spin+p3b-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),int_mb(k_sym+p3b-1)) .eq. ieor(irrep_
     &y,irrep_x)) THEN
      dimc = int_mb(k_range+h2b-1) * int_mb(k_range+p3b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_3_6_2',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p4b = noab+1,noab+nvab
      DO p5b = p4b,noab+nvab
      DO h6b = 1,noab
      DO h7b = h6b,noab
      IF (int_mb(k_active+h2b-1)+int_mb(k_active+h6b-1)+int_mb(k_active+
     &h7b-1) .ge. numact) THEN
      IF (int_mb(k_active+p3b-1)+int_mb(k_active+p4b-1)+int_mb(k_active+
     &p5b-1) .ge. numact) THEN
      IF (int_mb(k_spin+p4b-1)+int_mb(k_spin+p5b-1) .eq. int_mb(k_spin+h
     &6b-1)+int_mb(k_spin+h7b-1)) THEN
      IF (ieor(int_mb(k_sym+p4b-1),ieor(int_mb(k_sym+p5b-1),ieor(int_mb(
     &k_sym+h6b-1),int_mb(k_sym+h7b-1)))) .eq. irrep_x) THEN
      CALL TCE_RESTRICTED_4(p4b,p5b,h6b,h7b,p4b_1,p5b_1,h6b_1,h7b_1)
      CALL TCE_RESTRICTED_6(h2b,h6b,h7b,p3b,p4b,p5b,h2b_2,h6b_2,h7b_2,p3
     &b_2,p4b_2,p5b_2)
      dim_common = int_mb(k_range+p4b-1) * int_mb(k_range+p5b-1) * int_m
     &b(k_range+h6b-1) * int_mb(k_range+h7b-1)
      dima_sort = 1
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h2b-1) * int_mb(k_range+p3b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_3_6_2',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_3_6_2',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h7b_1
     & - 1 + noab * (h6b_1 - 1 + noab * (p5b_1 - noab - 1 + nvab * (p4b_
     &1 - noab - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p5b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1)
     &,4,3,2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_3_6_2
     &',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_3_6_2',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_3_6_2',5,MA_ERR)
      IF ((h7b .lt. h2b) .and. (p5b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (h2b_2 - 1 + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h2b-1),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p5b-1),int_mb(k_range+p3b-1),6,3,2,1,5,4,1.0d0,.fa
     &lse.)
      END IF
      IF ((h7b .lt. h2b) .and. (p4b .lt. p3b) .and. (p3b .le. p5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (h2b_2 - 1 + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h2b-1),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p5b-1),5,3,2,1,6,4,-1.0d0,.f
     &alse.)
      END IF
      IF ((h7b .lt. h2b) .and. (p3b .le. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h2b_2 - 1 + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h2b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),4,3,2,1,6,5,1.0d0,.fa
     &lse.)
      END IF
      IF ((h6b .lt. h2b) .and. (h2b .le. h7b) .and. (p5b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (h7b_2 - 1 + noab * (h2b_2 - 1 + noab * (h6b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h7b-1),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p5b-1),int_mb(k_range+p3b-1),6,2,3,1,5,4,-1.0d0,.f
     &alse.)
      END IF
      IF ((h6b .lt. h2b) .and. (h2b .le. h7b) .and. (p4b .lt. p3b) .and.
     & (p3b .le. p5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (h7b_2 - 1 + noab * (h2b_2 - 1 + noab * (h6b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h7b-1),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p5b-1),5,2,3,1,6,4,1.0d0,.fa
     &lse.)
      END IF
      IF ((h6b .lt. h2b) .and. (h2b .le. h7b) .and. (p3b .le. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h7b_2 - 1 + noab * (h2b_2 - 1 + noab * (h6b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h7b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),4,2,3,1,6,5,-1.0d0,.f
     &alse.)
      END IF
      IF ((h2b .le. h6b) .and. (p5b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (h7b_2 - 1 + noab * (h6b_2 - 1 + noab * (h2b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p5b-1),int_mb(k_range+p3b-1),6,1,3,2,5,4,1.0d0,.fa
     &lse.)
      END IF
      IF ((h2b .le. h6b) .and. (p4b .lt. p3b) .and. (p3b .le. p5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (h7b_2 - 1 + noab * (h6b_2 - 1 + noab * (h2b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p5b-1),5,1,3,2,6,4,-1.0d0,.f
     &alse.)
      END IF
      IF ((h2b .le. h6b) .and. (p3b .le. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h7b_2 - 1 + noab * (h6b_2 - 1 + noab * (h2b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),4,1,3,2,6,5,1.0d0,.fa
     &lse.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_3_6_2
     &',6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      isuperp = 1
      IF (p4b .eq. p5b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      nsubh(1) = 1
      nsubh(2) = 1
      isubh = 1
      IF (h6b .eq. h7b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,4.0d0/FACTOR
     &IAL(nsuperp(1))/FACTORIAL(nsuperp(2))/FACTORIAL(nsubh(1))/FACTORIA
     &L(nsubh(2)),dbl_mb(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_commo
     &n,1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &3_6_2',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &3_6_2',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_3_6_2',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p3b-1)
     &,int_mb(k_range+h2b-1),2,1,1.0d0/4.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p3b -
     & noab - 1 + nvab * (h2b - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_3_6_2
     &',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &3_6_2',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_3_6_3(d_a,k_a_offset,d_b,k_b_offset,
     &d_c,k_c_offset)
C     i2 ( h2 p3 )_yx + = 1/36 * Sum ( h9 h8 h7 p6 p5 p4 ) * x ( p4 p5 p6 h7 h8 h9 )_x * y ( h2 h7 h8 h9 p3 p4 p5 p6 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h2b
      INTEGER p3b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p4b
      INTEGER p5b
      INTEGER p6b
      INTEGER h7b
      INTEGER h8b
      INTEGER h9b
      INTEGER p4b_1
      INTEGER p5b_1
      INTEGER p6b_1
      INTEGER h7b_1
      INTEGER h8b_1
      INTEGER h9b_1
      INTEGER h2b_2
      INTEGER h7b_2
      INTEGER h8b_2
      INTEGER h9b_2
      INTEGER p3b_2
      INTEGER p4b_2
      INTEGER p5b_2
      INTEGER p6b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(3)
      INTEGER isuperp
      INTEGER nsubh(3)
      INTEGER isubh
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h2b = 1,noab
      DO p3b = noab+1,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+p3b-1
     &).ne.4)) THEN
      IF (int_mb(k_spin+h2b-1) .eq. int_mb(k_spin+p3b-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),int_mb(k_sym+p3b-1)) .eq. ieor(irrep_
     &y,irrep_x)) THEN
      dimc = int_mb(k_range+h2b-1) * int_mb(k_range+p3b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_3_6_3',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p4b = noab+1,noab+nvab
      DO p5b = p4b,noab+nvab
      DO p6b = p5b,noab+nvab
      DO h7b = 1,noab
      DO h8b = h7b,noab
      DO h9b = h8b,noab
      IF (int_mb(k_active+p4b-1)+int_mb(k_active+p5b-1)+int_mb(k_active+
     &p6b-1) .ge. numact) THEN
      IF (int_mb(k_active+h7b-1)+int_mb(k_active+h8b-1)+int_mb(k_active+
     &h9b-1) .ge. numact) THEN
      IF (int_mb(k_active+h2b-1)+int_mb(k_active+h7b-1)+int_mb(k_active+
     &h8b-1)+int_mb(k_active+h9b-1) .ge. numacq) THEN
      IF (int_mb(k_active+p3b-1)+int_mb(k_active+p4b-1)+int_mb(k_active+
     &p5b-1)+int_mb(k_active+p6b-1) .ge. numacq) THEN
      IF (int_mb(k_spin+p4b-1)+int_mb(k_spin+p5b-1)+int_mb(k_spin+p6b-1)
     & .eq. int_mb(k_spin+h7b-1)+int_mb(k_spin+h8b-1)+int_mb(k_spin+h9b-
     &1)) THEN
      IF (ieor(int_mb(k_sym+p4b-1),ieor(int_mb(k_sym+p5b-1),ieor(int_mb(
     &k_sym+p6b-1),ieor(int_mb(k_sym+h7b-1),ieor(int_mb(k_sym+h8b-1),int
     &_mb(k_sym+h9b-1)))))) .eq. irrep_x) THEN
      CALL TCE_RESTRICTED_6(p4b,p5b,p6b,h7b,h8b,h9b,p4b_1,p5b_1,p6b_1,h7
     &b_1,h8b_1,h9b_1)
      CALL TCE_RESTRICTED_8(h2b,h7b,h8b,h9b,p3b,p4b,p5b,p6b,h2b_2,h7b_2,
     &h8b_2,h9b_2,p3b_2,p4b_2,p5b_2,p6b_2)
      dim_common = int_mb(k_range+p4b-1) * int_mb(k_range+p5b-1) * int_m
     &b(k_range+p6b-1) * int_mb(k_range+h7b-1) * int_mb(k_range+h8b-1) *
     & int_mb(k_range+h9b-1)
      dima_sort = 1
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h2b-1) * int_mb(k_range+p3b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_3_6_3',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_3_6_3',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h9b_1
     & - 1 + noab * (h8b_1 - 1 + noab * (h7b_1 - 1 + noab * (p6b_1 - noa
     &b - 1 + nvab * (p5b_1 - noab - 1 + nvab * (p4b_1 - noab - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p5b-1),int_mb(k_range+p6b-1),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h9b-1),6,5,4,3,2,1,1.0d0,.fa
     &lse.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_3_6_3
     &',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_3_6_3',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_3_6_3',5,MA_ERR)
      IF ((h9b .lt. h2b) .and. (p6b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p5b_2 - noab - 1 
     &+ nvab * (p4b_2 - noab - 1 + nvab * (h2b_2 - 1 + noab * (h9b_2 - 1
     & + noab * (h8b_2 - 1 + noab * (h7b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h9b-1),int_mb(k_range+h2b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1)
     &,int_mb(k_range+p3b-1),8,4,3,2,1,7,6,5,1.0d0,.false.)
      END IF
      IF ((h9b .lt. h2b) .and. (p5b .lt. p3b) .and. (p3b .le. p6b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p5b_2 - noab - 1 
     &+ nvab * (p4b_2 - noab - 1 + nvab * (h2b_2 - 1 + noab * (h9b_2 - 1
     & + noab * (h8b_2 - 1 + noab * (h7b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h9b-1),int_mb(k_range+h2b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p6b-1),7,4,3,2,1,8,6,5,-1.0d0,.false.)
      END IF
      IF ((h9b .lt. h2b) .and. (p4b .lt. p3b) .and. (p3b .le. p5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p4b_2 - noab - 1 + nvab * (h2b_2 - 1 + noab * (h9b_2 - 1
     & + noab * (h8b_2 - 1 + noab * (h7b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h9b-1),int_mb(k_range+h2b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p3b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p6b-1),6,4,3,2,1,8,7,5,1.0d0,.false.)
      END IF
      IF ((h9b .lt. h2b) .and. (p3b .le. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h2b_2 - 1 + noab * (h9b_2 - 1
     & + noab * (h8b_2 - 1 + noab * (h7b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h9b-1),int_mb(k_range+h2b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p6b-1),5,4,3,2,1,8,7,6,-1.0d0,.false.)
      END IF
      IF ((h8b .lt. h2b) .and. (h2b .le. h9b) .and. (p6b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p5b_2 - noab - 1 
     &+ nvab * (p4b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h2b_2 - 1
     & + noab * (h8b_2 - 1 + noab * (h7b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h2b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1)
     &,int_mb(k_range+p3b-1),8,3,4,2,1,7,6,5,-1.0d0,.false.)
      END IF
      IF ((h8b .lt. h2b) .and. (h2b .le. h9b) .and. (p5b .lt. p3b) .and.
     & (p3b .le. p6b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p5b_2 - noab - 1 
     &+ nvab * (p4b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h2b_2 - 1
     & + noab * (h8b_2 - 1 + noab * (h7b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h2b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p6b-1),7,3,4,2,1,8,6,5,1.0d0,.false.)
      END IF
      IF ((h8b .lt. h2b) .and. (h2b .le. h9b) .and. (p4b .lt. p3b) .and.
     & (p3b .le. p5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p4b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h2b_2 - 1
     & + noab * (h8b_2 - 1 + noab * (h7b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h2b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p3b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p6b-1),6,3,4,2,1,8,7,5,-1.0d0,.false.)
      END IF
      IF ((h8b .lt. h2b) .and. (h2b .le. h9b) .and. (p3b .le. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h2b_2 - 1
     & + noab * (h8b_2 - 1 + noab * (h7b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h2b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p6b-1),5,3,4,2,1,8,7,6,1.0d0,.false.)
      END IF
      IF ((h7b .lt. h2b) .and. (h2b .le. h8b) .and. (p6b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p5b_2 - noab - 1 
     &+ nvab * (p4b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h8b_2 - 1
     & + noab * (h2b_2 - 1 + noab * (h7b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1)
     &,int_mb(k_range+p3b-1),8,2,4,3,1,7,6,5,1.0d0,.false.)
      END IF
      IF ((h7b .lt. h2b) .and. (h2b .le. h8b) .and. (p5b .lt. p3b) .and.
     & (p3b .le. p6b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p5b_2 - noab - 1 
     &+ nvab * (p4b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h8b_2 - 1
     & + noab * (h2b_2 - 1 + noab * (h7b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p6b-1),7,2,4,3,1,8,6,5,-1.0d0,.false.)
      END IF
      IF ((h7b .lt. h2b) .and. (h2b .le. h8b) .and. (p4b .lt. p3b) .and.
     & (p3b .le. p5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p4b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h8b_2 - 1
     & + noab * (h2b_2 - 1 + noab * (h7b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p3b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p6b-1),6,2,4,3,1,8,7,5,1.0d0,.false.)
      END IF
      IF ((h7b .lt. h2b) .and. (h2b .le. h8b) .and. (p3b .le. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h8b_2 - 1
     & + noab * (h2b_2 - 1 + noab * (h7b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p6b-1),5,2,4,3,1,8,7,6,-1.0d0,.false.)
      END IF
      IF ((h2b .le. h7b) .and. (p6b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p5b_2 - noab - 1 
     &+ nvab * (p4b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h8b_2 - 1
     & + noab * (h7b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1)
     &,int_mb(k_range+p3b-1),8,1,4,3,2,7,6,5,-1.0d0,.false.)
      END IF
      IF ((h2b .le. h7b) .and. (p5b .lt. p3b) .and. (p3b .le. p6b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p5b_2 - noab - 1 
     &+ nvab * (p4b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h8b_2 - 1
     & + noab * (h7b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p6b-1),7,1,4,3,2,8,6,5,1.0d0,.false.)
      END IF
      IF ((h2b .le. h7b) .and. (p4b .lt. p3b) .and. (p3b .le. p5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p4b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h8b_2 - 1
     & + noab * (h7b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p3b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p6b-1),6,1,4,3,2,8,7,5,-1.0d0,.false.)
      END IF
      IF ((h2b .le. h7b) .and. (p3b .le. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h8b_2 - 1
     & + noab * (h7b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p6b-1),5,1,4,3,2,8,7,6,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_3_6_3
     &',6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      nsuperp(3) = 1
      isuperp = 1
      IF (p4b .eq. p5b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      IF (p5b .eq. p6b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      nsubh(1) = 1
      nsubh(2) = 1
      nsubh(3) = 1
      isubh = 1
      IF (h7b .eq. h8b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      IF (h8b .eq. h9b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,36.0d0/FACTO
     &RIAL(nsuperp(1))/FACTORIAL(nsuperp(2))/FACTORIAL(nsuperp(3))/FACTO
     &RIAL(nsubh(1))/FACTORIAL(nsubh(2))/FACTORIAL(nsubh(3)),dbl_mb(k_a_
     &sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c_sort
     &),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &3_6_3',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &3_6_3',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_3_6_3',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p3b-1)
     &,int_mb(k_range+h2b-1),2,1,1.0d0/36.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p3b -
     & noab - 1 + nvab * (h2b - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_3_6_3
     &',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &3_6_3',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_3_7(d_a,k_a_offset,d_b,k_b_offset,d_
     &c,k_c_offset)
C     i1 ( h2 h1 )_yxt + = 1/2 * Sum ( h5 p3 p4 ) * t ( p3 p4 h1 h5 )_t * i2 ( h2 h5 p3 p4 )_yx
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h2b
      INTEGER h1b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p3b
      INTEGER p4b
      INTEGER h5b
      INTEGER p3b_1
      INTEGER p4b_1
      INTEGER h1b_1
      INTEGER h5b_1
      INTEGER h2b_2
      INTEGER h5b_2
      INTEGER p3b_2
      INTEGER p4b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(2)
      INTEGER isuperp
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h2b = 1,noab
      DO h1b = 1,noab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+h1b-1
     &).ne.4)) THEN
      IF (int_mb(k_spin+h2b-1) .eq. int_mb(k_spin+h1b-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),int_mb(k_sym+h1b-1)) .eq. ieor(irrep_
     &y,ieor(irrep_x,irrep_t))) THEN
      dimc = int_mb(k_range+h2b-1) * int_mb(k_range+h1b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_3_7',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      DO h5b = 1,noab
      IF (int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1) .eq. int_mb(k_spin+h
     &1b-1)+int_mb(k_spin+h5b-1)) THEN
      IF (ieor(int_mb(k_sym+p3b-1),ieor(int_mb(k_sym+p4b-1),ieor(int_mb(
     &k_sym+h1b-1),int_mb(k_sym+h5b-1)))) .eq. irrep_t) THEN
      CALL TCE_RESTRICTED_4(p3b,p4b,h1b,h5b,p3b_1,p4b_1,h1b_1,h5b_1)
      CALL TCE_RESTRICTED_4(h2b,h5b,p3b,p4b,h2b_2,h5b_2,p3b_2,p4b_2)
      dim_common = int_mb(k_range+p3b-1) * int_mb(k_range+p4b-1) * int_m
     &b(k_range+h5b-1)
      dima_sort = int_mb(k_range+h1b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h2b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_3_7',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_3_7',2,MA_ERR)
      IF ((h5b .lt. h1b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h1b_1
     & - 1 + noab * (h5b_1 - 1 + noab * (p4b_1 - noab - 1 + nvab * (p3b_
     &1 - noab - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+h5b-1),int_mb(k_range+h1b-1)
     &,4,3,2,1,-1.0d0,.false.)
      END IF
      IF ((h1b .le. h5b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h5b_1
     & - 1 + noab * (h1b_1 - 1 + noab * (p4b_1 - noab - 1 + nvab * (p3b_
     &1 - noab - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+h1b-1),int_mb(k_range+h5b-1)
     &,3,4,2,1,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_3_7',
     &3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_3_7',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_3_7',5,MA_ERR)
      IF ((h5b .lt. h2b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (h2b_2 - 1 + noab 
     &* (h5b_2 - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1)
     &,2,1,4,3,-1.0d0,.false.)
      END IF
      IF ((h2b .le. h5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab 
     &* (h2b_2 - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1)
     &,1,2,4,3,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_3_7',
     &6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      isuperp = 1
      IF (p3b .eq. p4b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,2.0d0/FACTOR
     &IAL(nsuperp(1))/FACTORIAL(nsuperp(2)),dbl_mb(k_a_sort),dim_common,
     &dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &3_7',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &3_7',8,MA_ERR)
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_3_7',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h1b-1),1,2,1.0d0/2.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(h1b -
     & 1 + noab * (h2b - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_3_7',
     &10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &3_7',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_3_7_1(d_a,k_a_offset,d_b,k_b_offset,
     &d_c,k_c_offset)
C     i2 ( h2 h5 p3 p4 )_yx + = 1 * Sum ( h7 p6 ) * x ( p6 h7 )_x * y ( h2 h5 h7 p3 p4 p6 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h2b
      INTEGER h5b
      INTEGER p3b
      INTEGER p4b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p6b
      INTEGER h7b
      INTEGER p6b_1
      INTEGER h7b_1
      INTEGER h2b_2
      INTEGER h5b_2
      INTEGER h7b_2
      INTEGER p3b_2
      INTEGER p4b_2
      INTEGER p6b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h2b = 1,noab
      DO h5b = h2b,noab
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+h5b-1
     &)+int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1).ne.8)) THEN
      IF (int_mb(k_spin+h2b-1)+int_mb(k_spin+h5b-1) .eq. int_mb(k_spin+p
     &3b-1)+int_mb(k_spin+p4b-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),ieor(int_mb(k_sym+h5b-1),ieor(int_mb(
     &k_sym+p3b-1),int_mb(k_sym+p4b-1)))) .eq. ieor(irrep_y,irrep_x)) TH
     &EN
      dimc = int_mb(k_range+h2b-1) * int_mb(k_range+h5b-1) * int_mb(k_ra
     &nge+p3b-1) * int_mb(k_range+p4b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_3_7_1',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p6b = noab+1,noab+nvab
      DO h7b = 1,noab
      IF (int_mb(k_active+h2b-1)+int_mb(k_active+h5b-1)+int_mb(k_active+
     &h7b-1) .ge. numact) THEN
      IF (int_mb(k_active+p3b-1)+int_mb(k_active+p4b-1)+int_mb(k_active+
     &p6b-1) .ge. numact) THEN
      IF (int_mb(k_spin+p6b-1) .eq. int_mb(k_spin+h7b-1)) THEN
      IF (ieor(int_mb(k_sym+p6b-1),int_mb(k_sym+h7b-1)) .eq. irrep_x) TH
     &EN
      CALL TCE_RESTRICTED_2(p6b,h7b,p6b_1,h7b_1)
      CALL TCE_RESTRICTED_6(h2b,h5b,h7b,p3b,p4b,p6b,h2b_2,h5b_2,h7b_2,p3
     &b_2,p4b_2,p6b_2)
      dim_common = int_mb(k_range+p6b-1) * int_mb(k_range+h7b-1)
      dima_sort = 1
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h2b-1) * int_mb(k_range+h5b-1) * int_mb
     &(k_range+p3b-1) * int_mb(k_range+p4b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_3_7_1',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_3_7_1',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h7b_1
     & - 1 + noab * (p6b_1 - noab - 1)))
      CALL TCE_SORT_2(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p6b-1)
     &,int_mb(k_range+h7b-1),2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_3_7_1
     &',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_3_7_1',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_3_7_1',5,MA_ERR)
      IF ((h7b .lt. h2b) .and. (p6b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p6b_2 - noab - 1 
     &+ nvab * (h5b_2 - 1 + noab * (h2b_2 - 1 + noab * (h7b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h5b-1),int_mb(k_range+p6b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),6,5,3,2,1,4,1.0d0,.fa
     &lse.)
      END IF
      IF ((h7b .lt. h2b) .and. (p3b .le. p6b) .and. (p6b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h5b_2 - 1 + noab * (h2b_2 - 1 + noab * (h7b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h5b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p6b-1),int_mb(k_range+p4b-1),6,4,3,2,1,5,-1.0d0,.f
     &alse.)
      END IF
      IF ((h7b .lt. h2b) .and. (p4b .le. p6b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h5b_2 - 1 + noab * (h2b_2 - 1 + noab * (h7b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h5b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p6b-1),5,4,3,2,1,6,1.0d0,.fa
     &lse.)
      END IF
      IF ((h2b .le. h7b) .and. (h7b .lt. h5b) .and. (p6b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p6b_2 - noab - 1 
     &+ nvab * (h5b_2 - 1 + noab * (h7b_2 - 1 + noab * (h2b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h5b-1),int_mb(k_range+p6b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),6,5,3,1,2,4,-1.0d0,.f
     &alse.)
      END IF
      IF ((h2b .le. h7b) .and. (h7b .lt. h5b) .and. (p3b .le. p6b) .and.
     & (p6b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h5b_2 - 1 + noab * (h7b_2 - 1 + noab * (h2b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h5b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p6b-1),int_mb(k_range+p4b-1),6,4,3,1,2,5,1.0d0,.fa
     &lse.)
      END IF
      IF ((h2b .le. h7b) .and. (h7b .lt. h5b) .and. (p4b .le. p6b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h5b_2 - 1 + noab * (h7b_2 - 1 + noab * (h2b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h5b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p6b-1),5,4,3,1,2,6,-1.0d0,.f
     &alse.)
      END IF
      IF ((h5b .le. h7b) .and. (p6b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p6b_2 - noab - 1 
     &+ nvab * (h7b_2 - 1 + noab * (h5b_2 - 1 + noab * (h2b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h7b-1),int_mb(k_range+p6b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),6,5,2,1,3,4,1.0d0,.fa
     &lse.)
      END IF
      IF ((h5b .le. h7b) .and. (p3b .le. p6b) .and. (p6b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h7b_2 - 1 + noab * (h5b_2 - 1 + noab * (h2b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h7b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p6b-1),int_mb(k_range+p4b-1),6,4,2,1,3,5,-1.0d0,.f
     &alse.)
      END IF
      IF ((h5b .le. h7b) .and. (p4b .le. p6b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h7b_2 - 1 + noab * (h5b_2 - 1 + noab * (h2b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h7b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p6b-1),5,4,2,1,3,6,1.0d0,.fa
     &lse.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_3_7_1
     &',6,MA_ERR)
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,1.0d0,dbl_mb
     &(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c
     &_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &3_7_1',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &3_7_1',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_3_7_1',9,MA_ERR)
      CALL TCE_SORT_4(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+h5b-1),int_mb(k_range+h2b-1)
     &,4,3,2,1,1.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p4b -
     & noab - 1 + nvab * (p3b - noab - 1 + nvab * (h5b - 1 + noab * (h2b
     & - 1)))))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_3_7_1
     &',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &3_7_1',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE OFFSET_eomccsdtq_density1_3_7_1(l_a_offset,k_a_offset,s
     &ize)
C     i2 ( h2 h5 p3 p4 )_yx
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER l_a_offset
      INTEGER k_a_offset
      INTEGER length
      INTEGER addr
      INTEGER h2b
      INTEGER h5b
      INTEGER p3b
      INTEGER p4b
      DOUBLE PRECISION size
      length = 0
      DO h2b = 1,noab
      DO h5b = h2b,noab
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      IF (int_mb(k_spin+h2b-1)+int_mb(k_spin+h5b-1) .eq. int_mb(k_spin+p
     &3b-1)+int_mb(k_spin+p4b-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),ieor(int_mb(k_sym+h5b-1),ieor(int_mb(
     &k_sym+p3b-1),int_mb(k_sym+p4b-1)))) .eq. ieor(irrep_y,irrep_x)) TH
     &EN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+h5b-1
     &)+int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1).ne.8)) THEN
      length = length + 1
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,2*length+1,'noname',l_a_offset,k_a_off
     &set)) CALL ERRQUIT('eomccsdtq_density1_3_7_1',0,MA_ERR)
      dbl_mb(k_a_offset) = dfloat(length)
      addr = 0
      size = 0.0d0
      DO h2b = 1,noab
      DO h5b = h2b,noab
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      IF (int_mb(k_spin+h2b-1)+int_mb(k_spin+h5b-1) .eq. int_mb(k_spin+p
     &3b-1)+int_mb(k_spin+p4b-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),ieor(int_mb(k_sym+h5b-1),ieor(int_mb(
     &k_sym+p3b-1),int_mb(k_sym+p4b-1)))) .eq. ieor(irrep_y,irrep_x)) TH
     &EN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+h5b-1
     &)+int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1).ne.8)) THEN
      addr = addr + 1
      dbl_mb(k_a_offset+addr) = dfloat(p4b - noab - 1 + nvab * (p3b - no
     &ab - 1 + nvab * (h5b - 1 + noab * (h2b - 1))))
      dbl_mb(k_a_offset+length+addr) = size
      size = size + dfloat(int_mb(k_range+h2b-1)) * dfloat(int_mb(k_rang
     &e+h5b-1)) * dfloat(int_mb(k_range+p3b-1)) * dfloat(int_mb(k_range+
     &p4b-1))
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_3_7_2(d_a,k_a_offset,d_b,k_b_offset,
     &d_c,k_c_offset)
C     i2 ( h2 h5 p3 p4 )_yx + = 1/4 * Sum ( h9 h8 p7 p6 ) * x ( p6 p7 h8 h9 )_x * y ( h2 h5 h8 h9 p3 p4 p6 p7 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h2b
      INTEGER h5b
      INTEGER p3b
      INTEGER p4b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p6b
      INTEGER p7b
      INTEGER h8b
      INTEGER h9b
      INTEGER p6b_1
      INTEGER p7b_1
      INTEGER h8b_1
      INTEGER h9b_1
      INTEGER h2b_2
      INTEGER h5b_2
      INTEGER h8b_2
      INTEGER h9b_2
      INTEGER p3b_2
      INTEGER p4b_2
      INTEGER p6b_2
      INTEGER p7b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(2)
      INTEGER isuperp
      INTEGER nsubh(2)
      INTEGER isubh
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h2b = 1,noab
      DO h5b = h2b,noab
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+h5b-1
     &)+int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1).ne.8)) THEN
      IF (int_mb(k_spin+h2b-1)+int_mb(k_spin+h5b-1) .eq. int_mb(k_spin+p
     &3b-1)+int_mb(k_spin+p4b-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),ieor(int_mb(k_sym+h5b-1),ieor(int_mb(
     &k_sym+p3b-1),int_mb(k_sym+p4b-1)))) .eq. ieor(irrep_y,irrep_x)) TH
     &EN
      dimc = int_mb(k_range+h2b-1) * int_mb(k_range+h5b-1) * int_mb(k_ra
     &nge+p3b-1) * int_mb(k_range+p4b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_3_7_2',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p6b = noab+1,noab+nvab
      DO p7b = p6b,noab+nvab
      DO h8b = 1,noab
      DO h9b = h8b,noab
      IF (int_mb(k_active+h2b-1)+int_mb(k_active+h5b-1)+int_mb(k_active+
     &h8b-1)+int_mb(k_active+h9b-1) .ge. numacq) THEN
      IF (int_mb(k_active+p3b-1)+int_mb(k_active+p4b-1)+int_mb(k_active+
     &p6b-1)+int_mb(k_active+p7b-1) .ge. numacq) THEN
      IF (int_mb(k_spin+p6b-1)+int_mb(k_spin+p7b-1) .eq. int_mb(k_spin+h
     &8b-1)+int_mb(k_spin+h9b-1)) THEN
      IF (ieor(int_mb(k_sym+p6b-1),ieor(int_mb(k_sym+p7b-1),ieor(int_mb(
     &k_sym+h8b-1),int_mb(k_sym+h9b-1)))) .eq. irrep_x) THEN
      CALL TCE_RESTRICTED_4(p6b,p7b,h8b,h9b,p6b_1,p7b_1,h8b_1,h9b_1)
      CALL TCE_RESTRICTED_8(h2b,h5b,h8b,h9b,p3b,p4b,p6b,p7b,h2b_2,h5b_2,
     &h8b_2,h9b_2,p3b_2,p4b_2,p6b_2,p7b_2)
      dim_common = int_mb(k_range+p6b-1) * int_mb(k_range+p7b-1) * int_m
     &b(k_range+h8b-1) * int_mb(k_range+h9b-1)
      dima_sort = 1
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h2b-1) * int_mb(k_range+h5b-1) * int_mb
     &(k_range+p3b-1) * int_mb(k_range+p4b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_3_7_2',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_3_7_2',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h9b_1
     & - 1 + noab * (h8b_1 - 1 + noab * (p7b_1 - noab - 1 + nvab * (p6b_
     &1 - noab - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p6b-1)
     &,int_mb(k_range+p7b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1)
     &,4,3,2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_3_7_2
     &',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_3_7_2',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_3_7_2',5,MA_ERR)
      IF ((h9b .lt. h2b) .and. (p7b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p7b_2 - noab - 1 
     &+ nvab * (p6b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h2b_2 - 1
     & + noab * (h9b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h2b-1),int_mb(k_range+h5b-1)
     &,int_mb(k_range+p6b-1),int_mb(k_range+p7b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),8,7,4,3,2,1,6,5,1.0d0,.false.)
      END IF
      IF ((h9b .lt. h2b) .and. (p6b .lt. p3b) .and. (p3b .le. p7b) .and.
     & (p7b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p6b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h2b_2 - 1
     & + noab * (h9b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h2b-1),int_mb(k_range+h5b-1)
     &,int_mb(k_range+p6b-1),int_mb(k_range+p3b-1),int_mb(k_range+p7b-1)
     &,int_mb(k_range+p4b-1),8,6,4,3,2,1,7,5,-1.0d0,.false.)
      END IF
      IF ((h9b .lt. h2b) .and. (p6b .lt. p3b) .and. (p4b .le. p7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p6b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h2b_2 - 1
     & + noab * (h9b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h2b-1),int_mb(k_range+h5b-1)
     &,int_mb(k_range+p6b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p7b-1),7,6,4,3,2,1,8,5,1.0d0,.false.)
      END IF
      IF ((h9b .lt. h2b) .and. (p3b .le. p6b) .and. (p7b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p6b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h2b_2 - 1
     & + noab * (h9b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h2b-1),int_mb(k_range+h5b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p6b-1),int_mb(k_range+p7b-1)
     &,int_mb(k_range+p4b-1),8,5,4,3,2,1,7,6,1.0d0,.false.)
      END IF
      IF ((h9b .lt. h2b) .and. (p3b .le. p6b) .and. (p6b .lt. p4b) .and.
     & (p4b .le. p7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p6b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h2b_2 - 1
     & + noab * (h9b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h2b-1),int_mb(k_range+h5b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p6b-1),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p7b-1),7,5,4,3,2,1,8,6,-1.0d0,.false.)
      END IF
      IF ((h9b .lt. h2b) .and. (p4b .le. p6b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h2b_2 - 1
     & + noab * (h9b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h2b-1),int_mb(k_range+h5b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p6b-1)
     &,int_mb(k_range+p7b-1),6,5,4,3,2,1,8,7,1.0d0,.false.)
      END IF
      IF ((h8b .lt. h2b) .and. (h2b .le. h9b) .and. (h9b .lt. h5b) .and.
     & (p7b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p7b_2 - noab - 1 
     &+ nvab * (p6b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h9b_2 - 1
     & + noab * (h2b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h9b-1),int_mb(k_range+h5b-1)
     &,int_mb(k_range+p6b-1),int_mb(k_range+p7b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),8,7,4,2,3,1,6,5,-1.0d0,.false.)
      END IF
      IF ((h8b .lt. h2b) .and. (h2b .le. h9b) .and. (h9b .lt. h5b) .and.
     & (p6b .lt. p3b) .and. (p3b .le. p7b) .and. (p7b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p6b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h9b_2 - 1
     & + noab * (h2b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h9b-1),int_mb(k_range+h5b-1)
     &,int_mb(k_range+p6b-1),int_mb(k_range+p3b-1),int_mb(k_range+p7b-1)
     &,int_mb(k_range+p4b-1),8,6,4,2,3,1,7,5,1.0d0,.false.)
      END IF
      IF ((h8b .lt. h2b) .and. (h2b .le. h9b) .and. (h9b .lt. h5b) .and.
     & (p6b .lt. p3b) .and. (p4b .le. p7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p6b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h9b_2 - 1
     & + noab * (h2b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h9b-1),int_mb(k_range+h5b-1)
     &,int_mb(k_range+p6b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p7b-1),7,6,4,2,3,1,8,5,-1.0d0,.false.)
      END IF
      IF ((h8b .lt. h2b) .and. (h2b .le. h9b) .and. (h9b .lt. h5b) .and.
     & (p3b .le. p6b) .and. (p7b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p6b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h9b_2 - 1
     & + noab * (h2b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h9b-1),int_mb(k_range+h5b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p6b-1),int_mb(k_range+p7b-1)
     &,int_mb(k_range+p4b-1),8,5,4,2,3,1,7,6,-1.0d0,.false.)
      END IF
      IF ((h8b .lt. h2b) .and. (h2b .le. h9b) .and. (h9b .lt. h5b) .and.
     & (p3b .le. p6b) .and. (p6b .lt. p4b) .and. (p4b .le. p7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p6b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h9b_2 - 1
     & + noab * (h2b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h9b-1),int_mb(k_range+h5b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p6b-1),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p7b-1),7,5,4,2,3,1,8,6,1.0d0,.false.)
      END IF
      IF ((h8b .lt. h2b) .and. (h2b .le. h9b) .and. (h9b .lt. h5b) .and.
     & (p4b .le. p6b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h9b_2 - 1
     & + noab * (h2b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h9b-1),int_mb(k_range+h5b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p6b-1)
     &,int_mb(k_range+p7b-1),6,5,4,2,3,1,8,7,-1.0d0,.false.)
      END IF
      IF ((h8b .lt. h2b) .and. (h5b .le. h9b) .and. (p7b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p7b_2 - noab - 1 
     &+ nvab * (p6b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h5b_2 - 1
     & + noab * (h2b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h5b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p6b-1),int_mb(k_range+p7b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),8,7,3,2,4,1,6,5,1.0d0,.false.)
      END IF
      IF ((h8b .lt. h2b) .and. (h5b .le. h9b) .and. (p6b .lt. p3b) .and.
     & (p3b .le. p7b) .and. (p7b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p6b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h5b_2 - 1
     & + noab * (h2b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h5b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p6b-1),int_mb(k_range+p3b-1),int_mb(k_range+p7b-1)
     &,int_mb(k_range+p4b-1),8,6,3,2,4,1,7,5,-1.0d0,.false.)
      END IF
      IF ((h8b .lt. h2b) .and. (h5b .le. h9b) .and. (p6b .lt. p3b) .and.
     & (p4b .le. p7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p6b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h5b_2 - 1
     & + noab * (h2b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h5b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p6b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p7b-1),7,6,3,2,4,1,8,5,1.0d0,.false.)
      END IF
      IF ((h8b .lt. h2b) .and. (h5b .le. h9b) .and. (p3b .le. p6b) .and.
     & (p7b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p6b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h5b_2 - 1
     & + noab * (h2b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h5b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p6b-1),int_mb(k_range+p7b-1)
     &,int_mb(k_range+p4b-1),8,5,3,2,4,1,7,6,1.0d0,.false.)
      END IF
      IF ((h8b .lt. h2b) .and. (h5b .le. h9b) .and. (p3b .le. p6b) .and.
     & (p6b .lt. p4b) .and. (p4b .le. p7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p6b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h5b_2 - 1
     & + noab * (h2b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h5b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p6b-1),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p7b-1),7,5,3,2,4,1,8,6,-1.0d0,.false.)
      END IF
      IF ((h8b .lt. h2b) .and. (h5b .le. h9b) .and. (p4b .le. p6b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h5b_2 - 1
     & + noab * (h2b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h5b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p6b-1)
     &,int_mb(k_range+p7b-1),6,5,3,2,4,1,8,7,1.0d0,.false.)
      END IF
      IF ((h2b .le. h8b) .and. (h9b .lt. h5b) .and. (p7b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p7b_2 - noab - 1 
     &+ nvab * (p6b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h9b_2 - 1
     & + noab * (h8b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h9b-1),int_mb(k_range+h5b-1)
     &,int_mb(k_range+p6b-1),int_mb(k_range+p7b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),8,7,4,1,3,2,6,5,1.0d0,.false.)
      END IF
      IF ((h2b .le. h8b) .and. (h9b .lt. h5b) .and. (p6b .lt. p3b) .and.
     & (p3b .le. p7b) .and. (p7b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p6b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h9b_2 - 1
     & + noab * (h8b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h9b-1),int_mb(k_range+h5b-1)
     &,int_mb(k_range+p6b-1),int_mb(k_range+p3b-1),int_mb(k_range+p7b-1)
     &,int_mb(k_range+p4b-1),8,6,4,1,3,2,7,5,-1.0d0,.false.)
      END IF
      IF ((h2b .le. h8b) .and. (h9b .lt. h5b) .and. (p6b .lt. p3b) .and.
     & (p4b .le. p7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p6b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h9b_2 - 1
     & + noab * (h8b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h9b-1),int_mb(k_range+h5b-1)
     &,int_mb(k_range+p6b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p7b-1),7,6,4,1,3,2,8,5,1.0d0,.false.)
      END IF
      IF ((h2b .le. h8b) .and. (h9b .lt. h5b) .and. (p3b .le. p6b) .and.
     & (p7b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p6b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h9b_2 - 1
     & + noab * (h8b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h9b-1),int_mb(k_range+h5b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p6b-1),int_mb(k_range+p7b-1)
     &,int_mb(k_range+p4b-1),8,5,4,1,3,2,7,6,1.0d0,.false.)
      END IF
      IF ((h2b .le. h8b) .and. (h9b .lt. h5b) .and. (p3b .le. p6b) .and.
     & (p6b .lt. p4b) .and. (p4b .le. p7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p6b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h9b_2 - 1
     & + noab * (h8b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h9b-1),int_mb(k_range+h5b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p6b-1),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p7b-1),7,5,4,1,3,2,8,6,-1.0d0,.false.)
      END IF
      IF ((h2b .le. h8b) .and. (h9b .lt. h5b) .and. (p4b .le. p6b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h9b_2 - 1
     & + noab * (h8b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h9b-1),int_mb(k_range+h5b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p6b-1)
     &,int_mb(k_range+p7b-1),6,5,4,1,3,2,8,7,1.0d0,.false.)
      END IF
      IF ((h2b .le. h8b) .and. (h8b .lt. h5b) .and. (h5b .le. h9b) .and.
     & (p7b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p7b_2 - noab - 1 
     &+ nvab * (p6b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h5b_2 - 1
     & + noab * (h8b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h5b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p6b-1),int_mb(k_range+p7b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),8,7,3,1,4,2,6,5,-1.0d0,.false.)
      END IF
      IF ((h2b .le. h8b) .and. (h8b .lt. h5b) .and. (h5b .le. h9b) .and.
     & (p6b .lt. p3b) .and. (p3b .le. p7b) .and. (p7b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p6b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h5b_2 - 1
     & + noab * (h8b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h5b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p6b-1),int_mb(k_range+p3b-1),int_mb(k_range+p7b-1)
     &,int_mb(k_range+p4b-1),8,6,3,1,4,2,7,5,1.0d0,.false.)
      END IF
      IF ((h2b .le. h8b) .and. (h8b .lt. h5b) .and. (h5b .le. h9b) .and.
     & (p6b .lt. p3b) .and. (p4b .le. p7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p6b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h5b_2 - 1
     & + noab * (h8b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h5b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p6b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p7b-1),7,6,3,1,4,2,8,5,-1.0d0,.false.)
      END IF
      IF ((h2b .le. h8b) .and. (h8b .lt. h5b) .and. (h5b .le. h9b) .and.
     & (p3b .le. p6b) .and. (p7b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p6b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h5b_2 - 1
     & + noab * (h8b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h5b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p6b-1),int_mb(k_range+p7b-1)
     &,int_mb(k_range+p4b-1),8,5,3,1,4,2,7,6,-1.0d0,.false.)
      END IF
      IF ((h2b .le. h8b) .and. (h8b .lt. h5b) .and. (h5b .le. h9b) .and.
     & (p3b .le. p6b) .and. (p6b .lt. p4b) .and. (p4b .le. p7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p6b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h5b_2 - 1
     & + noab * (h8b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h5b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p6b-1),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p7b-1),7,5,3,1,4,2,8,6,1.0d0,.false.)
      END IF
      IF ((h2b .le. h8b) .and. (h8b .lt. h5b) .and. (h5b .le. h9b) .and.
     & (p4b .le. p6b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h5b_2 - 1
     & + noab * (h8b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h5b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p6b-1)
     &,int_mb(k_range+p7b-1),6,5,3,1,4,2,8,7,-1.0d0,.false.)
      END IF
      IF ((h5b .le. h8b) .and. (p7b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p7b_2 - noab - 1 
     &+ nvab * (p6b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h8b_2 - 1
     & + noab * (h5b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p6b-1),int_mb(k_range+p7b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),8,7,2,1,4,3,6,5,1.0d0,.false.)
      END IF
      IF ((h5b .le. h8b) .and. (p6b .lt. p3b) .and. (p3b .le. p7b) .and.
     & (p7b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p6b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h8b_2 - 1
     & + noab * (h5b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p6b-1),int_mb(k_range+p3b-1),int_mb(k_range+p7b-1)
     &,int_mb(k_range+p4b-1),8,6,2,1,4,3,7,5,-1.0d0,.false.)
      END IF
      IF ((h5b .le. h8b) .and. (p6b .lt. p3b) .and. (p4b .le. p7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p6b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h8b_2 - 1
     & + noab * (h5b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p6b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p7b-1),7,6,2,1,4,3,8,5,1.0d0,.false.)
      END IF
      IF ((h5b .le. h8b) .and. (p3b .le. p6b) .and. (p7b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p6b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h8b_2 - 1
     & + noab * (h5b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p6b-1),int_mb(k_range+p7b-1)
     &,int_mb(k_range+p4b-1),8,5,2,1,4,3,7,6,1.0d0,.false.)
      END IF
      IF ((h5b .le. h8b) .and. (p3b .le. p6b) .and. (p6b .lt. p4b) .and.
     & (p4b .le. p7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p6b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h8b_2 - 1
     & + noab * (h5b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p6b-1),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p7b-1),7,5,2,1,4,3,8,6,-1.0d0,.false.)
      END IF
      IF ((h5b .le. h8b) .and. (p4b .le. p6b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h8b_2 - 1
     & + noab * (h5b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p6b-1)
     &,int_mb(k_range+p7b-1),6,5,2,1,4,3,8,7,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_3_7_2
     &',6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      isuperp = 1
      IF (p6b .eq. p7b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      nsubh(1) = 1
      nsubh(2) = 1
      isubh = 1
      IF (h8b .eq. h9b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,4.0d0/FACTOR
     &IAL(nsuperp(1))/FACTORIAL(nsuperp(2))/FACTORIAL(nsubh(1))/FACTORIA
     &L(nsubh(2)),dbl_mb(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_commo
     &n,1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &3_7_2',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &3_7_2',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_3_7_2',9,MA_ERR)
      CALL TCE_SORT_4(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+h5b-1),int_mb(k_range+h2b-1)
     &,4,3,2,1,1.0d0/4.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p4b -
     & noab - 1 + nvab * (p3b - noab - 1 + nvab * (h5b - 1 + noab * (h2b
     & - 1)))))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_3_7_2
     &',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &3_7_2',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_3_8(d_a,k_a_offset,d_b,k_b_offset,d_
     &c,k_c_offset)
C     i1 ( h2 h1 )_yxt + = 1/12 * Sum ( h6 h7 p3 p4 p5 ) * t ( p3 p4 p5 h1 h6 h7 )_t * i2 ( h2 h6 h7 p3 p4 p5 )_yx
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h2b
      INTEGER h1b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p3b
      INTEGER p4b
      INTEGER p5b
      INTEGER h6b
      INTEGER h7b
      INTEGER p3b_1
      INTEGER p4b_1
      INTEGER p5b_1
      INTEGER h1b_1
      INTEGER h6b_1
      INTEGER h7b_1
      INTEGER h2b_2
      INTEGER h6b_2
      INTEGER h7b_2
      INTEGER p3b_2
      INTEGER p4b_2
      INTEGER p5b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(3)
      INTEGER isuperp
      INTEGER nsubh(2)
      INTEGER isubh
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h2b = 1,noab
      DO h1b = 1,noab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+h1b-1
     &).ne.4)) THEN
      IF (int_mb(k_spin+h2b-1) .eq. int_mb(k_spin+h1b-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),int_mb(k_sym+h1b-1)) .eq. ieor(irrep_
     &y,ieor(irrep_x,irrep_t))) THEN
      dimc = int_mb(k_range+h2b-1) * int_mb(k_range+h1b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_3_8',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      DO p5b = p4b,noab+nvab
      DO h6b = 1,noab
      DO h7b = h6b,noab
      IF (int_mb(k_active+p3b-1)+int_mb(k_active+p4b-1)+int_mb(k_active+
     &p5b-1) .ge. numact) THEN
      IF (int_mb(k_active+h1b-1)+int_mb(k_active+h6b-1)+int_mb(k_active+
     &h7b-1) .ge. numact) THEN
      IF (int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1)+int_mb(k_spin+p5b-1)
     & .eq. int_mb(k_spin+h1b-1)+int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b-
     &1)) THEN
      IF (ieor(int_mb(k_sym+p3b-1),ieor(int_mb(k_sym+p4b-1),ieor(int_mb(
     &k_sym+p5b-1),ieor(int_mb(k_sym+h1b-1),ieor(int_mb(k_sym+h6b-1),int
     &_mb(k_sym+h7b-1)))))) .eq. irrep_t) THEN
      CALL TCE_RESTRICTED_6(p3b,p4b,p5b,h1b,h6b,h7b,p3b_1,p4b_1,p5b_1,h1
     &b_1,h6b_1,h7b_1)
      CALL TCE_RESTRICTED_6(h2b,h6b,h7b,p3b,p4b,p5b,h2b_2,h6b_2,h7b_2,p3
     &b_2,p4b_2,p5b_2)
      dim_common = int_mb(k_range+p3b-1) * int_mb(k_range+p4b-1) * int_m
     &b(k_range+p5b-1) * int_mb(k_range+h6b-1) * int_mb(k_range+h7b-1)
      dima_sort = int_mb(k_range+h1b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h2b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_3_8',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_3_8',2,MA_ERR)
      IF ((h7b .lt. h1b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h1b_1
     & - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 + noab * (p5b_1 - noa
     &b - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h1b-1),6,5,4,3,2,1,1.0d0,.fa
     &lse.)
      END IF
      IF ((h6b .lt. h1b) .and. (h1b .le. h7b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h7b_1
     & - 1 + noab * (h1b_1 - 1 + noab * (h6b_1 - 1 + noab * (p5b_1 - noa
     &b - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h1b-1),int_mb(k_range+h7b-1),5,6,4,3,2,1,-1.0d0,.f
     &alse.)
      END IF
      IF ((h1b .le. h6b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h7b_1
     & - 1 + noab * (h6b_1 - 1 + noab * (h1b_1 - 1 + noab * (p5b_1 - noa
     &b - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),4,6,5,3,2,1,1.0d0,.fa
     &lse.)
      END IF
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_3_8',
     &3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_3_8',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_3_8',5,MA_ERR)
      IF ((h7b .lt. h2b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h2b_2 - 1 + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h2b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),3,2,1,6,5,4,1.0d0,.fa
     &lse.)
      END IF
      IF ((h6b .lt. h2b) .and. (h2b .le. h7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h7b_2 - 1 + noab * (h2b_2 - 1 + noab * (h6b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h7b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),2,3,1,6,5,4,-1.0d0,.f
     &alse.)
      END IF
      IF ((h2b .le. h6b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h7b_2 - 1 + noab * (h6b_2 - 1 + noab * (h2b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),1,3,2,6,5,4,1.0d0,.fa
     &lse.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_3_8',
     &6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      nsuperp(3) = 1
      isuperp = 1
      IF (p3b .eq. p4b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      IF (p4b .eq. p5b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      nsubh(1) = 1
      nsubh(2) = 1
      isubh = 1
      IF (h6b .eq. h7b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,12.0d0/FACTO
     &RIAL(nsuperp(1))/FACTORIAL(nsuperp(2))/FACTORIAL(nsuperp(3))/FACTO
     &RIAL(nsubh(1))/FACTORIAL(nsubh(2)),dbl_mb(k_a_sort),dim_common,dbl
     &_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &3_8',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &3_8',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_3_8',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h1b-1),1,2,1.0d0/12.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(h1b -
     & 1 + noab * (h2b - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_3_8',
     &10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &3_8',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_3_8_1(d_a,k_a_offset,d_b,k_b_offset,
     &d_c,k_c_offset)
C     i2 ( h2 h6 h7 p3 p4 p5 )_yx + = 1 * Sum ( h9 p8 ) * x ( p8 h9 )_x * y ( h2 h6 h7 h9 p3 p4 p5 p8 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h2b
      INTEGER h6b
      INTEGER h7b
      INTEGER p3b
      INTEGER p4b
      INTEGER p5b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p8b
      INTEGER h9b
      INTEGER p8b_1
      INTEGER h9b_1
      INTEGER h2b_2
      INTEGER h6b_2
      INTEGER h7b_2
      INTEGER h9b_2
      INTEGER p3b_2
      INTEGER p4b_2
      INTEGER p5b_2
      INTEGER p8b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h2b = 1,noab
      DO h6b = h2b,noab
      DO h7b = h6b,noab
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      DO p5b = p4b,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+h6b-1
     &)+int_mb(k_spin+h7b-1)+int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1)+i
     &nt_mb(k_spin+p5b-1).ne.12)) THEN
      IF (int_mb(k_spin+h2b-1)+int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b-1)
     & .eq. int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1)+int_mb(k_spin+p5b-
     &1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),ieor(int_mb(k_sym+h6b-1),ieor(int_mb(
     &k_sym+h7b-1),ieor(int_mb(k_sym+p3b-1),ieor(int_mb(k_sym+p4b-1),int
     &_mb(k_sym+p5b-1)))))) .eq. ieor(irrep_y,irrep_x)) THEN
      dimc = int_mb(k_range+h2b-1) * int_mb(k_range+h6b-1) * int_mb(k_ra
     &nge+h7b-1) * int_mb(k_range+p3b-1) * int_mb(k_range+p4b-1) * int_m
     &b(k_range+p5b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_3_8_1',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p8b = noab+1,noab+nvab
      DO h9b = 1,noab
      IF (int_mb(k_active+h2b-1)+int_mb(k_active+h6b-1)+int_mb(k_active+
     &h7b-1)+int_mb(k_active+h9b-1) .ge. numacq) THEN
      IF (int_mb(k_active+p3b-1)+int_mb(k_active+p4b-1)+int_mb(k_active+
     &p5b-1)+int_mb(k_active+p8b-1) .ge. numacq) THEN
      IF (int_mb(k_spin+p8b-1) .eq. int_mb(k_spin+h9b-1)) THEN
      IF (ieor(int_mb(k_sym+p8b-1),int_mb(k_sym+h9b-1)) .eq. irrep_x) TH
     &EN
      CALL TCE_RESTRICTED_2(p8b,h9b,p8b_1,h9b_1)
      CALL TCE_RESTRICTED_8(h2b,h6b,h7b,h9b,p3b,p4b,p5b,p8b,h2b_2,h6b_2,
     &h7b_2,h9b_2,p3b_2,p4b_2,p5b_2,p8b_2)
      dim_common = int_mb(k_range+p8b-1) * int_mb(k_range+h9b-1)
      dima_sort = 1
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h2b-1) * int_mb(k_range+h6b-1) * int_mb
     &(k_range+h7b-1) * int_mb(k_range+p3b-1) * int_mb(k_range+p4b-1) * 
     &int_mb(k_range+p5b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_3_8_1',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_3_8_1',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h9b_1
     & - 1 + noab * (p8b_1 - noab - 1)))
      CALL TCE_SORT_2(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p8b-1)
     &,int_mb(k_range+h9b-1),2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_3_8_1
     &',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_3_8_1',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_3_8_1',5,MA_ERR)
      IF ((h9b .lt. h2b) .and. (p8b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p8b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 1
     & + noab * (h2b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1)
     &,int_mb(k_range+p8b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p5b-1),8,7,6,4,3,2,1,5,1.0d0,.false.)
      END IF
      IF ((h9b .lt. h2b) .and. (p3b .le. p8b) .and. (p8b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p8b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 1
     & + noab * (h2b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p8b-1),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p5b-1),8,7,5,4,3,2,1,6,-1.0d0,.false.)
      END IF
      IF ((h9b .lt. h2b) .and. (p4b .le. p8b) .and. (p8b .lt. p5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 1
     & + noab * (h2b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p8b-1)
     &,int_mb(k_range+p5b-1),8,6,5,4,3,2,1,7,1.0d0,.false.)
      END IF
      IF ((h9b .lt. h2b) .and. (p5b .le. p8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 1
     & + noab * (h2b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p8b-1),7,6,5,4,3,2,1,8,-1.0d0,.false.)
      END IF
      IF ((h2b .le. h9b) .and. (h9b .lt. h6b) .and. (p8b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p8b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 1
     & + noab * (h9b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1)
     &,int_mb(k_range+p8b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p5b-1),8,7,6,4,3,1,2,5,-1.0d0,.false.)
      END IF
      IF ((h2b .le. h9b) .and. (h9b .lt. h6b) .and. (p3b .le. p8b) .and.
     & (p8b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p8b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 1
     & + noab * (h9b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p8b-1),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p5b-1),8,7,5,4,3,1,2,6,1.0d0,.false.)
      END IF
      IF ((h2b .le. h9b) .and. (h9b .lt. h6b) .and. (p4b .le. p8b) .and.
     & (p8b .lt. p5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 1
     & + noab * (h9b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p8b-1)
     &,int_mb(k_range+p5b-1),8,6,5,4,3,1,2,7,-1.0d0,.false.)
      END IF
      IF ((h2b .le. h9b) .and. (h9b .lt. h6b) .and. (p5b .le. p8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 1
     & + noab * (h9b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p8b-1),7,6,5,4,3,1,2,8,1.0d0,.false.)
      END IF
      IF ((h6b .le. h9b) .and. (h9b .lt. h7b) .and. (p8b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p8b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h9b_2 - 1
     & + noab * (h6b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h9b-1),int_mb(k_range+h7b-1)
     &,int_mb(k_range+p8b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p5b-1),8,7,6,4,2,1,3,5,1.0d0,.false.)
      END IF
      IF ((h6b .le. h9b) .and. (h9b .lt. h7b) .and. (p3b .le. p8b) .and.
     & (p8b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p8b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h9b_2 - 1
     & + noab * (h6b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h9b-1),int_mb(k_range+h7b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p8b-1),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p5b-1),8,7,5,4,2,1,3,6,-1.0d0,.false.)
      END IF
      IF ((h6b .le. h9b) .and. (h9b .lt. h7b) .and. (p4b .le. p8b) .and.
     & (p8b .lt. p5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h9b_2 - 1
     & + noab * (h6b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h9b-1),int_mb(k_range+h7b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p8b-1)
     &,int_mb(k_range+p5b-1),8,6,5,4,2,1,3,7,1.0d0,.false.)
      END IF
      IF ((h6b .le. h9b) .and. (h9b .lt. h7b) .and. (p5b .le. p8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h9b_2 - 1
     & + noab * (h6b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h9b-1),int_mb(k_range+h7b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p8b-1),7,6,5,4,2,1,3,8,-1.0d0,.false.)
      END IF
      IF ((h7b .le. h9b) .and. (p8b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p8b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h7b_2 - 1
     & + noab * (h6b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p8b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p5b-1),8,7,6,3,2,1,4,5,-1.0d0,.false.)
      END IF
      IF ((h7b .le. h9b) .and. (p3b .le. p8b) .and. (p8b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p8b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h7b_2 - 1
     & + noab * (h6b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p8b-1),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p5b-1),8,7,5,3,2,1,4,6,1.0d0,.false.)
      END IF
      IF ((h7b .le. h9b) .and. (p4b .le. p8b) .and. (p8b .lt. p5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h7b_2 - 1
     & + noab * (h6b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p8b-1)
     &,int_mb(k_range+p5b-1),8,6,5,3,2,1,4,7,-1.0d0,.false.)
      END IF
      IF ((h7b .le. h9b) .and. (p5b .le. p8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h7b_2 - 1
     & + noab * (h6b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p8b-1),7,6,5,3,2,1,4,8,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_3_8_1
     &',6,MA_ERR)
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,1.0d0,dbl_mb
     &(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c
     &_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &3_8_1',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &3_8_1',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_3_8_1',9,MA_ERR)
      CALL TCE_SORT_6(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p3b-1),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h2b-1),6,5,4,3,2,1,1.0d0,.fa
     &lse.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p5b -
     & noab - 1 + nvab * (p4b - noab - 1 + nvab * (p3b - noab - 1 + nvab
     & * (h7b - 1 + noab * (h6b - 1 + noab * (h2b - 1)))))))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_3_8_1
     &',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &3_8_1',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE OFFSET_eomccsdtq_density1_3_8_1(l_a_offset,k_a_offset,s
     &ize)
C     i2 ( h2 h6 h7 p3 p4 p5 )_yx
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER l_a_offset
      INTEGER k_a_offset
      INTEGER length
      INTEGER addr
      INTEGER h2b
      INTEGER h6b
      INTEGER h7b
      INTEGER p3b
      INTEGER p4b
      INTEGER p5b
      DOUBLE PRECISION size
      length = 0
      DO h2b = 1,noab
      DO h6b = h2b,noab
      DO h7b = h6b,noab
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      DO p5b = p4b,noab+nvab
      IF (int_mb(k_spin+h2b-1)+int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b-1)
     & .eq. int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1)+int_mb(k_spin+p5b-
     &1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),ieor(int_mb(k_sym+h6b-1),ieor(int_mb(
     &k_sym+h7b-1),ieor(int_mb(k_sym+p3b-1),ieor(int_mb(k_sym+p4b-1),int
     &_mb(k_sym+p5b-1)))))) .eq. ieor(irrep_y,irrep_x)) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+h6b-1
     &)+int_mb(k_spin+h7b-1)+int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1)+i
     &nt_mb(k_spin+p5b-1).ne.12)) THEN
      length = length + 1
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,2*length+1,'noname',l_a_offset,k_a_off
     &set)) CALL ERRQUIT('eomccsdtq_density1_3_8_1',0,MA_ERR)
      dbl_mb(k_a_offset) = dfloat(length)
      addr = 0
      size = 0.0d0
      DO h2b = 1,noab
      DO h6b = h2b,noab
      DO h7b = h6b,noab
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      DO p5b = p4b,noab+nvab
      IF (int_mb(k_spin+h2b-1)+int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b-1)
     & .eq. int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1)+int_mb(k_spin+p5b-
     &1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),ieor(int_mb(k_sym+h6b-1),ieor(int_mb(
     &k_sym+h7b-1),ieor(int_mb(k_sym+p3b-1),ieor(int_mb(k_sym+p4b-1),int
     &_mb(k_sym+p5b-1)))))) .eq. ieor(irrep_y,irrep_x)) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+h6b-1
     &)+int_mb(k_spin+h7b-1)+int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1)+i
     &nt_mb(k_spin+p5b-1).ne.12)) THEN
      addr = addr + 1
      dbl_mb(k_a_offset+addr) = dfloat(p5b - noab - 1 + nvab * (p4b - no
     &ab - 1 + nvab * (p3b - noab - 1 + nvab * (h7b - 1 + noab * (h6b - 
     &1 + noab * (h2b - 1))))))
      dbl_mb(k_a_offset+length+addr) = size
      size = size + dfloat(int_mb(k_range+h2b-1)) * dfloat(int_mb(k_rang
     &e+h6b-1)) * dfloat(int_mb(k_range+h7b-1)) * dfloat(int_mb(k_range+
     &p3b-1)) * dfloat(int_mb(k_range+p4b-1)) * dfloat(int_mb(k_range+p5
     &b-1))
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_4(d_a,k_a_offset,d_b,k_b_offset,d_c,
     &k_c_offset)
C     i0 ( )_dxy + = 1 * Sum ( p1 h3 ) * y ( h3 p1 )_y * i1 ( p1 h3 )_dx
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER h3b
      INTEGER p1b
      INTEGER h3b_1
      INTEGER p1b_1
      INTEGER p1b_2
      INTEGER h3b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      IF (next .eq. count) THEN
      IF (0 .eq. ieor(irrep_d,ieor(irrep_x,irrep_y))) THEN
      dimc = 1
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_4',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO h3b = 1,noab
      DO p1b = noab+1,noab+nvab
      IF (int_mb(k_spin+h3b-1) .eq. int_mb(k_spin+p1b-1)) THEN
      IF (ieor(int_mb(k_sym+h3b-1),int_mb(k_sym+p1b-1)) .eq. irrep_y) TH
     &EN
      CALL TCE_RESTRICTED_2(h3b,p1b,h3b_1,p1b_1)
      CALL TCE_RESTRICTED_2(p1b,h3b,p1b_2,h3b_2)
      dim_common = int_mb(k_range+h3b-1) * int_mb(k_range+p1b-1)
      dima_sort = 1
      dima = dim_common * dima_sort
      dimb_sort = 1
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_4',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_4',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(p1b_1
     & - noab - 1 + nvab * (h3b_1 - 1)))
      CALL TCE_SORT_2(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+h3b-1)
     &,int_mb(k_range+p1b-1),2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_4',3,
     &MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_4',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_4',5,MA_ERR)
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(h3b_2
     & - 1 + noab * (p1b_2 - noab - 1)))
      CALL TCE_SORT_2(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+p1b-1)
     &,int_mb(k_range+h3b-1),1,2,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_4',6,
     &MA_ERR)
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,1.0d0,dbl_mb
     &(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c
     &_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &4',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &4',8,MA_ERR)
      END IF
      END IF
      END IF
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_4',9,MA_ERR)
      CALL TCE_SORT_0(dbl_mb(k_c_sort),dbl_mb(k_c),1.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),0)
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_4',10
     &,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &4',11,MA_ERR)
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_4_1(d_a,k_a_offset,d_b,k_b_offset,d_
     &c,k_c_offset)
C     i1 ( p1 h3 )_dx + = 1 * Sum ( p2 ) * d ( p1 p2 )_d * x ( p2 h3 )_x
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER p1b
      INTEGER h3b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p2b
      INTEGER p1b_1
      INTEGER p2b_1
      INTEGER p2b_2
      INTEGER h3b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO p1b = noab+1,noab+nvab
      DO h3b = 1,noab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+p1b-1)+int_mb(k_spin+h3b-1
     &).ne.4)) THEN
      IF (int_mb(k_spin+p1b-1) .eq. int_mb(k_spin+h3b-1)) THEN
      IF (ieor(int_mb(k_sym+p1b-1),int_mb(k_sym+h3b-1)) .eq. ieor(irrep_
     &d,irrep_x)) THEN
      dimc = int_mb(k_range+p1b-1) * int_mb(k_range+h3b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_4_1',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p2b = noab+1,noab+nvab
      IF (int_mb(k_spin+p1b-1) .eq. int_mb(k_spin+p2b-1)) THEN
      IF (ieor(int_mb(k_sym+p1b-1),int_mb(k_sym+p2b-1)) .eq. irrep_d) TH
     &EN
      CALL TCE_RESTRICTED_2(p1b,p2b,p1b_1,p2b_1)
      CALL TCE_RESTRICTED_2(p2b,h3b,p2b_2,h3b_2)
      dim_common = int_mb(k_range+p2b-1)
      dima_sort = int_mb(k_range+p1b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h3b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_4_1',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_4_1',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(p2b_1
     & - 1 + (noab+nvab) * (p1b_1 - 1)))
      CALL TCE_SORT_2(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p1b-1)
     &,int_mb(k_range+p2b-1),1,2,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_4_1',
     &3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_4_1',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_4_1',5,MA_ERR)
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(h3b_2
     & - 1 + noab * (p2b_2 - noab - 1)))
      CALL TCE_SORT_2(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+p2b-1)
     &,int_mb(k_range+h3b-1),2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_4_1',
     &6,MA_ERR)
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,1.0d0,dbl_mb
     &(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c
     &_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &4_1',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &4_1',8,MA_ERR)
      END IF
      END IF
      END IF
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_4_1',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+h3b-1)
     &,int_mb(k_range+p1b-1),2,1,1.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(h3b -
     & 1 + noab * (p1b - noab - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_4_1',
     &10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &4_1',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE OFFSET_eomccsdtq_density1_4_1(l_a_offset,k_a_offset,siz
     &e)
C     i1 ( p1 h3 )_dx
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER l_a_offset
      INTEGER k_a_offset
      INTEGER length
      INTEGER addr
      INTEGER p1b
      INTEGER h3b
      DOUBLE PRECISION size
      length = 0
      DO p1b = noab+1,noab+nvab
      DO h3b = 1,noab
      IF (int_mb(k_spin+p1b-1) .eq. int_mb(k_spin+h3b-1)) THEN
      IF (ieor(int_mb(k_sym+p1b-1),int_mb(k_sym+h3b-1)) .eq. ieor(irrep_
     &d,irrep_x)) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+p1b-1)+int_mb(k_spin+h3b-1
     &).ne.4)) THEN
      length = length + 1
      END IF
      END IF
      END IF
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,2*length+1,'noname',l_a_offset,k_a_off
     &set)) CALL ERRQUIT('eomccsdtq_density1_4_1',0,MA_ERR)
      dbl_mb(k_a_offset) = dfloat(length)
      addr = 0
      size = 0.0d0
      DO p1b = noab+1,noab+nvab
      DO h3b = 1,noab
      IF (int_mb(k_spin+p1b-1) .eq. int_mb(k_spin+h3b-1)) THEN
      IF (ieor(int_mb(k_sym+p1b-1),int_mb(k_sym+h3b-1)) .eq. ieor(irrep_
     &d,irrep_x)) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+p1b-1)+int_mb(k_spin+h3b-1
     &).ne.4)) THEN
      addr = addr + 1
      dbl_mb(k_a_offset+addr) = dfloat(h3b - 1 + noab * (p1b - noab - 1)
     &)
      dbl_mb(k_a_offset+length+addr) = size
      size = size + dfloat(int_mb(k_range+p1b-1)) * dfloat(int_mb(k_rang
     &e+h3b-1))
      END IF
      END IF
      END IF
      END DO
      END DO
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_4_2(d_a,k_a_offset,d_b,k_b_offset,d_
     &c,k_c_offset)
C     i1 ( p1 h3 )_dtx + = 1 * x ( )_x * i2 ( p1 h3 )_dt
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER p1b
      INTEGER h3b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p1b_2
      INTEGER h3b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO p1b = noab+1,noab+nvab
      DO h3b = 1,noab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+p1b-1)+int_mb(k_spin+h3b-1
     &).ne.4)) THEN
      IF (int_mb(k_spin+p1b-1) .eq. int_mb(k_spin+h3b-1)) THEN
      IF (ieor(int_mb(k_sym+p1b-1),int_mb(k_sym+h3b-1)) .eq. ieor(irrep_
     &d,ieor(irrep_t,irrep_x))) THEN
      dimc = int_mb(k_range+p1b-1) * int_mb(k_range+h3b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_4_2',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      IF (0 .eq. irrep_x) THEN
      CALL TCE_RESTRICTED_2(p1b,h3b,p1b_2,h3b_2)
      dim_common = 1
      dima_sort = 1
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+p1b-1) * int_mb(k_range+h3b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_4_2',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_4_2',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),0)
      CALL TCE_SORT_0(dbl_mb(k_a),dbl_mb(k_a_sort),1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_4_2',
     &3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_4_2',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_4_2',5,MA_ERR)
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(h3b_2
     & - 1 + noab * (p1b_2 - noab - 1)))
      CALL TCE_SORT_2(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+p1b-1)
     &,int_mb(k_range+h3b-1),2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_4_2',
     &6,MA_ERR)
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,1.0d0,dbl_mb
     &(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c
     &_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &4_2',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &4_2',8,MA_ERR)
      END IF
      END IF
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_4_2',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+h3b-1)
     &,int_mb(k_range+p1b-1),2,1,1.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(h3b -
     & 1 + noab * (p1b - noab - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_4_2',
     &10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &4_2',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_4_2_1(d_a,k_a_offset,d_b,k_b_offset,
     &d_c,k_c_offset)
C     i2 ( p1 h3 )_dt + = 1 * Sum ( p2 ) * d ( p1 p2 )_d * t ( p2 h3 )_t
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER p1b
      INTEGER h3b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p2b
      INTEGER p1b_1
      INTEGER p2b_1
      INTEGER p2b_2
      INTEGER h3b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO p1b = noab+1,noab+nvab
      DO h3b = 1,noab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+p1b-1)+int_mb(k_spin+h3b-1
     &).ne.4)) THEN
      IF (int_mb(k_spin+p1b-1) .eq. int_mb(k_spin+h3b-1)) THEN
      IF (ieor(int_mb(k_sym+p1b-1),int_mb(k_sym+h3b-1)) .eq. ieor(irrep_
     &d,irrep_t)) THEN
      dimc = int_mb(k_range+p1b-1) * int_mb(k_range+h3b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_4_2_1',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p2b = noab+1,noab+nvab
      IF (int_mb(k_spin+p1b-1) .eq. int_mb(k_spin+p2b-1)) THEN
      IF (ieor(int_mb(k_sym+p1b-1),int_mb(k_sym+p2b-1)) .eq. irrep_d) TH
     &EN
      CALL TCE_RESTRICTED_2(p1b,p2b,p1b_1,p2b_1)
      CALL TCE_RESTRICTED_2(p2b,h3b,p2b_2,h3b_2)
      dim_common = int_mb(k_range+p2b-1)
      dima_sort = int_mb(k_range+p1b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h3b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_4_2_1',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_4_2_1',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(p2b_1
     & - 1 + (noab+nvab) * (p1b_1 - 1)))
      CALL TCE_SORT_2(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p1b-1)
     &,int_mb(k_range+p2b-1),1,2,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_4_2_1
     &',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_4_2_1',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_4_2_1',5,MA_ERR)
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(h3b_2
     & - 1 + noab * (p2b_2 - noab - 1)))
      CALL TCE_SORT_2(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+p2b-1)
     &,int_mb(k_range+h3b-1),2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_4_2_1
     &',6,MA_ERR)
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,1.0d0,dbl_mb
     &(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c
     &_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &4_2_1',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &4_2_1',8,MA_ERR)
      END IF
      END IF
      END IF
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_4_2_1',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+h3b-1)
     &,int_mb(k_range+p1b-1),2,1,1.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(h3b -
     & 1 + noab * (p1b - noab - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_4_2_1
     &',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &4_2_1',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE OFFSET_eomccsdtq_density1_4_2_1(l_a_offset,k_a_offset,s
     &ize)
C     i2 ( p1 h3 )_dt
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER l_a_offset
      INTEGER k_a_offset
      INTEGER length
      INTEGER addr
      INTEGER p1b
      INTEGER h3b
      DOUBLE PRECISION size
      length = 0
      DO p1b = noab+1,noab+nvab
      DO h3b = 1,noab
      IF (int_mb(k_spin+p1b-1) .eq. int_mb(k_spin+h3b-1)) THEN
      IF (ieor(int_mb(k_sym+p1b-1),int_mb(k_sym+h3b-1)) .eq. ieor(irrep_
     &d,irrep_t)) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+p1b-1)+int_mb(k_spin+h3b-1
     &).ne.4)) THEN
      length = length + 1
      END IF
      END IF
      END IF
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,2*length+1,'noname',l_a_offset,k_a_off
     &set)) CALL ERRQUIT('eomccsdtq_density1_4_2_1',0,MA_ERR)
      dbl_mb(k_a_offset) = dfloat(length)
      addr = 0
      size = 0.0d0
      DO p1b = noab+1,noab+nvab
      DO h3b = 1,noab
      IF (int_mb(k_spin+p1b-1) .eq. int_mb(k_spin+h3b-1)) THEN
      IF (ieor(int_mb(k_sym+p1b-1),int_mb(k_sym+h3b-1)) .eq. ieor(irrep_
     &d,irrep_t)) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+p1b-1)+int_mb(k_spin+h3b-1
     &).ne.4)) THEN
      addr = addr + 1
      dbl_mb(k_a_offset+addr) = dfloat(h3b - 1 + noab * (p1b - noab - 1)
     &)
      dbl_mb(k_a_offset+length+addr) = size
      size = size + dfloat(int_mb(k_range+p1b-1)) * dfloat(int_mb(k_rang
     &e+h3b-1))
      END IF
      END IF
      END IF
      END DO
      END DO
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5(d_a,k_a_offset,d_b,k_b_offset,d_c,
     &k_c_offset)
C     i0 ( )_yxd + = 1 * Sum ( p12 h11 ) * d ( h11 p12 )_d * i1 ( p12 h11 )_yx
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER h11b
      INTEGER p12b
      INTEGER h11b_1
      INTEGER p12b_1
      INTEGER p12b_2
      INTEGER h11b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      IF (next .eq. count) THEN
      IF (0 .eq. ieor(irrep_y,ieor(irrep_x,irrep_d))) THEN
      dimc = 1
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO h11b = 1,noab
      DO p12b = noab+1,noab+nvab
      IF (int_mb(k_spin+h11b-1) .eq. int_mb(k_spin+p12b-1)) THEN
      IF (ieor(int_mb(k_sym+h11b-1),int_mb(k_sym+p12b-1)) .eq. irrep_d) 
     &THEN
      CALL TCE_RESTRICTED_2(h11b,p12b,h11b_1,p12b_1)
      CALL TCE_RESTRICTED_2(p12b,h11b,p12b_2,h11b_2)
      dim_common = int_mb(k_range+h11b-1) * int_mb(k_range+p12b-1)
      dima_sort = 1
      dima = dim_common * dima_sort
      dimb_sort = 1
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(p12b_
     &1 - 1 + (noab+nvab) * (h11b_1 - 1)))
      CALL TCE_SORT_2(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+h11b-1
     &),int_mb(k_range+p12b-1),2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5',3,
     &MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5',5,MA_ERR)
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(h11b_
     &2 - 1 + noab * (p12b_2 - noab - 1)))
      CALL TCE_SORT_2(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+p12b-1
     &),int_mb(k_range+h11b-1),1,2,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5',6,
     &MA_ERR)
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,1.0d0,dbl_mb
     &(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c
     &_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5',8,MA_ERR)
      END IF
      END IF
      END IF
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5',9,MA_ERR)
      CALL TCE_SORT_0(dbl_mb(k_c_sort),dbl_mb(k_c),1.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),0)
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5',10
     &,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5',11,MA_ERR)
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_1(d_a,k_a_offset,d_b,k_b_offset,d_
     &c,k_c_offset)
C     i1 ( p12 h11 )_yx + = 1 * Sum ( h4 p3 ) * x ( p3 p12 h4 h11 )_x * y ( h4 p3 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER p12b
      INTEGER h11b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p3b
      INTEGER h4b
      INTEGER p12b_1
      INTEGER p3b_1
      INTEGER h11b_1
      INTEGER h4b_1
      INTEGER h4b_2
      INTEGER p3b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO p12b = noab+1,noab+nvab
      DO h11b = 1,noab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+p12b-1)+int_mb(k_spin+h11b
     &-1).ne.4)) THEN
      IF (int_mb(k_spin+p12b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+p12b-1),int_mb(k_sym+h11b-1)) .eq. ieor(irre
     &p_y,irrep_x)) THEN
      dimc = int_mb(k_range+p12b-1) * int_mb(k_range+h11b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_1',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p3b = noab+1,noab+nvab
      DO h4b = 1,noab
      IF (int_mb(k_spin+p12b-1)+int_mb(k_spin+p3b-1) .eq. int_mb(k_spin+
     &h11b-1)+int_mb(k_spin+h4b-1)) THEN
      IF (ieor(int_mb(k_sym+p12b-1),ieor(int_mb(k_sym+p3b-1),ieor(int_mb
     &(k_sym+h11b-1),int_mb(k_sym+h4b-1)))) .eq. irrep_x) THEN
      CALL TCE_RESTRICTED_4(p12b,p3b,h11b,h4b,p12b_1,p3b_1,h11b_1,h4b_1)
      CALL TCE_RESTRICTED_2(h4b,p3b,h4b_2,p3b_2)
      dim_common = int_mb(k_range+p3b-1) * int_mb(k_range+h4b-1)
      dima_sort = int_mb(k_range+p12b-1) * int_mb(k_range+h11b-1)
      dima = dim_common * dima_sort
      dimb_sort = 1
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_1',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_1',2,MA_ERR)
      IF ((p3b .le. p12b) .and. (h4b .le. h11b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h11b_
     &1 - 1 + noab * (h4b_1 - 1 + noab * (p12b_1 - noab - 1 + nvab * (p3
     &b_1 - noab - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p12b-1),int_mb(k_range+h4b-1),int_mb(k_range+h11b-
     &1),4,2,3,1,1.0d0,.false.)
      END IF
      IF ((p3b .le. p12b) .and. (h11b .lt. h4b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h4b_1
     & - 1 + noab * (h11b_1 - 1 + noab * (p12b_1 - noab - 1 + nvab * (p3
     &b_1 - noab - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p12b-1),int_mb(k_range+h11b-1),int_mb(k_range+h4b-
     &1),3,2,4,1,-1.0d0,.false.)
      END IF
      IF ((p12b .lt. p3b) .and. (h4b .le. h11b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h11b_
     &1 - 1 + noab * (h4b_1 - 1 + noab * (p3b_1 - noab - 1 + nvab * (p12
     &b_1 - noab - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p12b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+h4b-1),int_mb(k_range+h11b-
     &1),4,1,3,2,-1.0d0,.false.)
      END IF
      IF ((p12b .lt. p3b) .and. (h11b .lt. h4b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h4b_1
     & - 1 + noab * (h11b_1 - 1 + noab * (p3b_1 - noab - 1 + nvab * (p12
     &b_1 - noab - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p12b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+h11b-1),int_mb(k_range+h4b-
     &1),3,1,4,2,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_1',
     &3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_1',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_1',5,MA_ERR)
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (h4b_2 - 1)))
      CALL TCE_SORT_2(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+p3b-1),1,2,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_1',
     &6,MA_ERR)
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,1.0d0,dbl_mb
     &(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c
     &_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_1',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_1',8,MA_ERR)
      END IF
      END IF
      END IF
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_1',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+h11b-1
     &),int_mb(k_range+p12b-1),2,1,1.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(h11b 
     &- 1 + noab * (p12b - noab - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_1',
     &10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_1',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE OFFSET_eomccsdtq_density1_5_1(l_a_offset,k_a_offset,siz
     &e)
C     i1 ( p12 h11 )_yx
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER l_a_offset
      INTEGER k_a_offset
      INTEGER length
      INTEGER addr
      INTEGER p12b
      INTEGER h11b
      DOUBLE PRECISION size
      length = 0
      DO p12b = noab+1,noab+nvab
      DO h11b = 1,noab
      IF (int_mb(k_spin+p12b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+p12b-1),int_mb(k_sym+h11b-1)) .eq. ieor(irre
     &p_y,irrep_x)) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+p12b-1)+int_mb(k_spin+h11b
     &-1).ne.4)) THEN
      length = length + 1
      END IF
      END IF
      END IF
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,2*length+1,'noname',l_a_offset,k_a_off
     &set)) CALL ERRQUIT('eomccsdtq_density1_5_1',0,MA_ERR)
      dbl_mb(k_a_offset) = dfloat(length)
      addr = 0
      size = 0.0d0
      DO p12b = noab+1,noab+nvab
      DO h11b = 1,noab
      IF (int_mb(k_spin+p12b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+p12b-1),int_mb(k_sym+h11b-1)) .eq. ieor(irre
     &p_y,irrep_x)) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+p12b-1)+int_mb(k_spin+h11b
     &-1).ne.4)) THEN
      addr = addr + 1
      dbl_mb(k_a_offset+addr) = dfloat(h11b - 1 + noab * (p12b - noab - 
     &1))
      dbl_mb(k_a_offset+length+addr) = size
      size = size + dfloat(int_mb(k_range+p12b-1)) * dfloat(int_mb(k_ran
     &ge+h11b-1))
      END IF
      END IF
      END IF
      END DO
      END DO
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_2(d_a,k_a_offset,d_b,k_b_offset,d_
     &c,k_c_offset)
C     i1 ( p12 h11 )_yx + = 1/4 * Sum ( h6 h5 p4 p3 ) * x ( p3 p4 p12 h5 h6 h11 )_x * y ( h5 h6 p3 p4 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER p12b
      INTEGER h11b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p3b
      INTEGER p4b
      INTEGER h5b
      INTEGER h6b
      INTEGER p12b_1
      INTEGER p3b_1
      INTEGER p4b_1
      INTEGER h11b_1
      INTEGER h5b_1
      INTEGER h6b_1
      INTEGER h5b_2
      INTEGER h6b_2
      INTEGER p3b_2
      INTEGER p4b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(2)
      INTEGER isuperp
      INTEGER nsubh(2)
      INTEGER isubh
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO p12b = noab+1,noab+nvab
      DO h11b = 1,noab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+p12b-1)+int_mb(k_spin+h11b
     &-1).ne.4)) THEN
      IF (int_mb(k_spin+p12b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+p12b-1),int_mb(k_sym+h11b-1)) .eq. ieor(irre
     &p_y,irrep_x)) THEN
      dimc = int_mb(k_range+p12b-1) * int_mb(k_range+h11b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_2',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      DO h5b = 1,noab
      DO h6b = h5b,noab
      IF (int_mb(k_active+p12b-1)+int_mb(k_active+p3b-1)+int_mb(k_active
     &+p4b-1) .ge. numact) THEN
      IF (int_mb(k_active+h11b-1)+int_mb(k_active+h5b-1)+int_mb(k_active
     &+h6b-1) .ge. numact) THEN
      IF (int_mb(k_spin+p12b-1)+int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1
     &) .eq. int_mb(k_spin+h11b-1)+int_mb(k_spin+h5b-1)+int_mb(k_spin+h6
     &b-1)) THEN
      IF (ieor(int_mb(k_sym+p12b-1),ieor(int_mb(k_sym+p3b-1),ieor(int_mb
     &(k_sym+p4b-1),ieor(int_mb(k_sym+h11b-1),ieor(int_mb(k_sym+h5b-1),i
     &nt_mb(k_sym+h6b-1)))))) .eq. irrep_x) THEN
      CALL TCE_RESTRICTED_6(p12b,p3b,p4b,h11b,h5b,h6b,p12b_1,p3b_1,p4b_1
     &,h11b_1,h5b_1,h6b_1)
      CALL TCE_RESTRICTED_4(h5b,h6b,p3b,p4b,h5b_2,h6b_2,p3b_2,p4b_2)
      dim_common = int_mb(k_range+p3b-1) * int_mb(k_range+p4b-1) * int_m
     &b(k_range+h5b-1) * int_mb(k_range+h6b-1)
      dima_sort = int_mb(k_range+p12b-1) * int_mb(k_range+h11b-1)
      dima = dim_common * dima_sort
      dimb_sort = 1
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_2',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_2',2,MA_ERR)
      IF ((p4b .le. p12b) .and. (h6b .le. h11b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h11b_
     &1 - 1 + noab * (h6b_1 - 1 + noab * (h5b_1 - 1 + noab * (p12b_1 - n
     &oab - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))
     &))
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p12b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h11b-1),6,3,5,4,2,1,1.0d0,.
     &false.)
      END IF
      IF ((p4b .le. p12b) .and. (h5b .le. h11b) .and. (h11b .lt. h6b)) T
     &HEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h6b_1
     & - 1 + noab * (h11b_1 - 1 + noab * (h5b_1 - 1 + noab * (p12b_1 - n
     &oab - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))
     &))
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p12b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+h11b-1),int_mb(k_range+h6b-1),5,3,6,4,2,1,-1.0d0,
     &.false.)
      END IF
      IF ((p4b .le. p12b) .and. (h11b .lt. h5b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h6b_1
     & - 1 + noab * (h5b_1 - 1 + noab * (h11b_1 - 1 + noab * (p12b_1 - n
     &oab - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))
     &))
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p12b-1),int_mb(k_range+h11b-
     &1),int_mb(k_range+h5b-1),int_mb(k_range+h6b-1),4,3,6,5,2,1,1.0d0,.
     &false.)
      END IF
      IF ((p3b .le. p12b) .and. (p12b .lt. p4b) .and. (h6b .le. h11b)) T
     &HEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h11b_
     &1 - 1 + noab * (h6b_1 - 1 + noab * (h5b_1 - 1 + noab * (p4b_1 - no
     &ab - 1 + nvab * (p12b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))
     &))
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p12b-1),int_mb(k_range+p4b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h11b-1),6,2,5,4,3,1,-1.0d0,
     &.false.)
      END IF
      IF ((p3b .le. p12b) .and. (p12b .lt. p4b) .and. (h5b .le. h11b) .a
     &nd. (h11b .lt. h6b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h6b_1
     & - 1 + noab * (h11b_1 - 1 + noab * (h5b_1 - 1 + noab * (p4b_1 - no
     &ab - 1 + nvab * (p12b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))
     &))
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p12b-1),int_mb(k_range+p4b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+h11b-1),int_mb(k_range+h6b-1),5,2,6,4,3,1,1.0d0,.
     &false.)
      END IF
      IF ((p3b .le. p12b) .and. (p12b .lt. p4b) .and. (h11b .lt. h5b)) T
     &HEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h6b_1
     & - 1 + noab * (h5b_1 - 1 + noab * (h11b_1 - 1 + noab * (p4b_1 - no
     &ab - 1 + nvab * (p12b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))
     &))
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p12b-1),int_mb(k_range+p4b-1),int_mb(k_range+h11b-
     &1),int_mb(k_range+h5b-1),int_mb(k_range+h6b-1),4,2,6,5,3,1,-1.0d0,
     &.false.)
      END IF
      IF ((p12b .lt. p3b) .and. (h6b .le. h11b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h11b_
     &1 - 1 + noab * (h6b_1 - 1 + noab * (h5b_1 - 1 + noab * (p4b_1 - no
     &ab - 1 + nvab * (p3b_1 - noab - 1 + nvab * (p12b_1 - noab - 1)))))
     &))
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p12b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h11b-1),6,1,5,4,3,2,1.0d0,.
     &false.)
      END IF
      IF ((p12b .lt. p3b) .and. (h5b .le. h11b) .and. (h11b .lt. h6b)) T
     &HEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h6b_1
     & - 1 + noab * (h11b_1 - 1 + noab * (h5b_1 - 1 + noab * (p4b_1 - no
     &ab - 1 + nvab * (p3b_1 - noab - 1 + nvab * (p12b_1 - noab - 1)))))
     &))
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p12b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+h11b-1),int_mb(k_range+h6b-1),5,1,6,4,3,2,-1.0d0,
     &.false.)
      END IF
      IF ((p12b .lt. p3b) .and. (h11b .lt. h5b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h6b_1
     & - 1 + noab * (h5b_1 - 1 + noab * (h11b_1 - 1 + noab * (p4b_1 - no
     &ab - 1 + nvab * (p3b_1 - noab - 1 + nvab * (p12b_1 - noab - 1)))))
     &))
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p12b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+h11b-
     &1),int_mb(k_range+h5b-1),int_mb(k_range+h6b-1),4,1,6,5,3,2,1.0d0,.
     &false.)
      END IF
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_2',
     &3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_2',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_2',5,MA_ERR)
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (h6b_2 - 1 + noab 
     &* (h5b_2 - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1)
     &,2,1,4,3,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_2',
     &6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      isuperp = 1
      IF (p3b .eq. p4b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      nsubh(1) = 1
      nsubh(2) = 1
      isubh = 1
      IF (h5b .eq. h6b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,4.0d0/FACTOR
     &IAL(nsuperp(1))/FACTORIAL(nsuperp(2))/FACTORIAL(nsubh(1))/FACTORIA
     &L(nsubh(2)),dbl_mb(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_commo
     &n,1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_2',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_2',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_2',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+h11b-1
     &),int_mb(k_range+p12b-1),2,1,1.0d0/4.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(h11b 
     &- 1 + noab * (p12b - noab - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_2',
     &10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_2',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_3(d_a,k_a_offset,d_b,k_b_offset,d_
     &c,k_c_offset)
C     i1 ( p12 h11 )_yx + = 1/36 * Sum ( h8 h7 h6 p5 p4 p3 ) * x ( p3 p4 p5 p12 h6 h7 h8 h11 )_x * y ( h6 h7 h8 p3 p4 p5 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER p12b
      INTEGER h11b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p3b
      INTEGER p4b
      INTEGER p5b
      INTEGER h6b
      INTEGER h7b
      INTEGER h8b
      INTEGER p12b_1
      INTEGER p3b_1
      INTEGER p4b_1
      INTEGER p5b_1
      INTEGER h11b_1
      INTEGER h6b_1
      INTEGER h7b_1
      INTEGER h8b_1
      INTEGER h6b_2
      INTEGER h7b_2
      INTEGER h8b_2
      INTEGER p3b_2
      INTEGER p4b_2
      INTEGER p5b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(3)
      INTEGER isuperp
      INTEGER nsubh(3)
      INTEGER isubh
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO p12b = noab+1,noab+nvab
      DO h11b = 1,noab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+p12b-1)+int_mb(k_spin+h11b
     &-1).ne.4)) THEN
      IF (int_mb(k_spin+p12b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+p12b-1),int_mb(k_sym+h11b-1)) .eq. ieor(irre
     &p_y,irrep_x)) THEN
      dimc = int_mb(k_range+p12b-1) * int_mb(k_range+h11b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_3',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      DO p5b = p4b,noab+nvab
      DO h6b = 1,noab
      DO h7b = h6b,noab
      DO h8b = h7b,noab
      IF (int_mb(k_active+p12b-1)+int_mb(k_active+p3b-1)+int_mb(k_active
     &+p4b-1)+int_mb(k_active+p5b-1) .ge. numacq) THEN
      IF (int_mb(k_active+h11b-1)+int_mb(k_active+h6b-1)+int_mb(k_active
     &+h7b-1)+int_mb(k_active+h8b-1) .ge. numacq) THEN
      IF (int_mb(k_active+h6b-1)+int_mb(k_active+h7b-1)+int_mb(k_active+
     &h8b-1) .ge. numact) THEN
      IF (int_mb(k_active+p3b-1)+int_mb(k_active+p4b-1)+int_mb(k_active+
     &p5b-1) .ge. numact) THEN
      IF (int_mb(k_spin+p12b-1)+int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1
     &)+int_mb(k_spin+p5b-1) .eq. int_mb(k_spin+h11b-1)+int_mb(k_spin+h6
     &b-1)+int_mb(k_spin+h7b-1)+int_mb(k_spin+h8b-1)) THEN
      IF (ieor(int_mb(k_sym+p12b-1),ieor(int_mb(k_sym+p3b-1),ieor(int_mb
     &(k_sym+p4b-1),ieor(int_mb(k_sym+p5b-1),ieor(int_mb(k_sym+h11b-1),i
     &eor(int_mb(k_sym+h6b-1),ieor(int_mb(k_sym+h7b-1),int_mb(k_sym+h8b-
     &1)))))))) .eq. irrep_x) THEN
      CALL TCE_RESTRICTED_8(p12b,p3b,p4b,p5b,h11b,h6b,h7b,h8b,p12b_1,p3b
     &_1,p4b_1,p5b_1,h11b_1,h6b_1,h7b_1,h8b_1)
      CALL TCE_RESTRICTED_6(h6b,h7b,h8b,p3b,p4b,p5b,h6b_2,h7b_2,h8b_2,p3
     &b_2,p4b_2,p5b_2)
      dim_common = int_mb(k_range+p3b-1) * int_mb(k_range+p4b-1) * int_m
     &b(k_range+p5b-1) * int_mb(k_range+h6b-1) * int_mb(k_range+h7b-1) *
     & int_mb(k_range+h8b-1)
      dima_sort = int_mb(k_range+p12b-1) * int_mb(k_range+h11b-1)
      dima = dim_common * dima_sort
      dimb_sort = 1
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_3',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_3',2,MA_ERR)
      IF ((p5b .le. p12b) .and. (h8b .le. h11b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h11b_
     &1 - 1 + noab * (h8b_1 - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 
     &+ noab * (p12b_1 - noab - 1 + nvab * (p5b_1 - noab - 1 + nvab * (p
     &4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+p12b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h8b-1
     &),int_mb(k_range+h11b-1),8,4,7,6,5,3,2,1,1.0d0,.false.)
      END IF
      IF ((p5b .le. p12b) .and. (h7b .le. h11b) .and. (h11b .lt. h8b)) T
     &HEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h8b_1
     & - 1 + noab * (h11b_1 - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 
     &+ noab * (p12b_1 - noab - 1 + nvab * (p5b_1 - noab - 1 + nvab * (p
     &4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+p12b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h11b-
     &1),int_mb(k_range+h8b-1),7,4,8,6,5,3,2,1,-1.0d0,.false.)
      END IF
      IF ((p5b .le. p12b) .and. (h6b .le. h11b) .and. (h11b .lt. h7b)) T
     &HEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h8b_1
     & - 1 + noab * (h7b_1 - 1 + noab * (h11b_1 - 1 + noab * (h6b_1 - 1 
     &+ noab * (p12b_1 - noab - 1 + nvab * (p5b_1 - noab - 1 + nvab * (p
     &4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+p12b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h11b-1),int_mb(k_range+h7b-
     &1),int_mb(k_range+h8b-1),6,4,8,7,5,3,2,1,1.0d0,.false.)
      END IF
      IF ((p5b .le. p12b) .and. (h11b .lt. h6b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h8b_1
     & - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 + noab * (h11b_1 - 1 
     &+ noab * (p12b_1 - noab - 1 + nvab * (p5b_1 - noab - 1 + nvab * (p
     &4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+p12b-1
     &),int_mb(k_range+h11b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-
     &1),int_mb(k_range+h8b-1),5,4,8,7,6,3,2,1,-1.0d0,.false.)
      END IF
      IF ((p4b .le. p12b) .and. (p12b .lt. p5b) .and. (h8b .le. h11b)) T
     &HEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h11b_
     &1 - 1 + noab * (h8b_1 - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 
     &+ noab * (p5b_1 - noab - 1 + nvab * (p12b_1 - noab - 1 + nvab * (p
     &4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p12b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h8b-1
     &),int_mb(k_range+h11b-1),8,3,7,6,5,4,2,1,-1.0d0,.false.)
      END IF
      IF ((p4b .le. p12b) .and. (p12b .lt. p5b) .and. (h7b .le. h11b) .a
     &nd. (h11b .lt. h8b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h8b_1
     & - 1 + noab * (h11b_1 - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 
     &+ noab * (p5b_1 - noab - 1 + nvab * (p12b_1 - noab - 1 + nvab * (p
     &4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p12b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h11b-
     &1),int_mb(k_range+h8b-1),7,3,8,6,5,4,2,1,1.0d0,.false.)
      END IF
      IF ((p4b .le. p12b) .and. (p12b .lt. p5b) .and. (h6b .le. h11b) .a
     &nd. (h11b .lt. h7b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h8b_1
     & - 1 + noab * (h7b_1 - 1 + noab * (h11b_1 - 1 + noab * (h6b_1 - 1 
     &+ noab * (p5b_1 - noab - 1 + nvab * (p12b_1 - noab - 1 + nvab * (p
     &4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p12b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h11b-1),int_mb(k_range+h7b-
     &1),int_mb(k_range+h8b-1),6,3,8,7,5,4,2,1,-1.0d0,.false.)
      END IF
      IF ((p4b .le. p12b) .and. (p12b .lt. p5b) .and. (h11b .lt. h6b)) T
     &HEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h8b_1
     & - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 + noab * (h11b_1 - 1 
     &+ noab * (p5b_1 - noab - 1 + nvab * (p12b_1 - noab - 1 + nvab * (p
     &4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p12b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+h11b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-
     &1),int_mb(k_range+h8b-1),5,3,8,7,6,4,2,1,1.0d0,.false.)
      END IF
      IF ((p3b .le. p12b) .and. (p12b .lt. p4b) .and. (h8b .le. h11b)) T
     &HEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h11b_
     &1 - 1 + noab * (h8b_1 - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 
     &+ noab * (p5b_1 - noab - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p1
     &2b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p12b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h8b-1
     &),int_mb(k_range+h11b-1),8,2,7,6,5,4,3,1,1.0d0,.false.)
      END IF
      IF ((p3b .le. p12b) .and. (p12b .lt. p4b) .and. (h7b .le. h11b) .a
     &nd. (h11b .lt. h8b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h8b_1
     & - 1 + noab * (h11b_1 - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 
     &+ noab * (p5b_1 - noab - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p1
     &2b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p12b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h11b-
     &1),int_mb(k_range+h8b-1),7,2,8,6,5,4,3,1,-1.0d0,.false.)
      END IF
      IF ((p3b .le. p12b) .and. (p12b .lt. p4b) .and. (h6b .le. h11b) .a
     &nd. (h11b .lt. h7b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h8b_1
     & - 1 + noab * (h7b_1 - 1 + noab * (h11b_1 - 1 + noab * (h6b_1 - 1 
     &+ noab * (p5b_1 - noab - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p1
     &2b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p12b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h11b-1),int_mb(k_range+h7b-
     &1),int_mb(k_range+h8b-1),6,2,8,7,5,4,3,1,1.0d0,.false.)
      END IF
      IF ((p3b .le. p12b) .and. (p12b .lt. p4b) .and. (h11b .lt. h6b)) T
     &HEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h8b_1
     & - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 + noab * (h11b_1 - 1 
     &+ noab * (p5b_1 - noab - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p1
     &2b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p12b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+h11b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-
     &1),int_mb(k_range+h8b-1),5,2,8,7,6,4,3,1,-1.0d0,.false.)
      END IF
      IF ((p12b .lt. p3b) .and. (h8b .le. h11b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h11b_
     &1 - 1 + noab * (h8b_1 - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 
     &+ noab * (p5b_1 - noab - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p3
     &b_1 - noab - 1 + nvab * (p12b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p12b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h8b-1
     &),int_mb(k_range+h11b-1),8,1,7,6,5,4,3,2,-1.0d0,.false.)
      END IF
      IF ((p12b .lt. p3b) .and. (h7b .le. h11b) .and. (h11b .lt. h8b)) T
     &HEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h8b_1
     & - 1 + noab * (h11b_1 - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 
     &+ noab * (p5b_1 - noab - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p3
     &b_1 - noab - 1 + nvab * (p12b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p12b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h11b-
     &1),int_mb(k_range+h8b-1),7,1,8,6,5,4,3,2,1.0d0,.false.)
      END IF
      IF ((p12b .lt. p3b) .and. (h6b .le. h11b) .and. (h11b .lt. h7b)) T
     &HEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h8b_1
     & - 1 + noab * (h7b_1 - 1 + noab * (h11b_1 - 1 + noab * (h6b_1 - 1 
     &+ noab * (p5b_1 - noab - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p3
     &b_1 - noab - 1 + nvab * (p12b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p12b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h11b-1),int_mb(k_range+h7b-
     &1),int_mb(k_range+h8b-1),6,1,8,7,5,4,3,2,-1.0d0,.false.)
      END IF
      IF ((p12b .lt. p3b) .and. (h11b .lt. h6b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h8b_1
     & - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 + noab * (h11b_1 - 1 
     &+ noab * (p5b_1 - noab - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p3
     &b_1 - noab - 1 + nvab * (p12b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p12b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+h11b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-
     &1),int_mb(k_range+h8b-1),5,1,8,7,6,4,3,2,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_3',
     &3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_3',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_3',5,MA_ERR)
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h8b_2 - 1 + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),3,2,1,6,5,4,1.0d0,.fa
     &lse.)
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_3',
     &6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      nsuperp(3) = 1
      isuperp = 1
      IF (p3b .eq. p4b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      IF (p4b .eq. p5b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      nsubh(1) = 1
      nsubh(2) = 1
      nsubh(3) = 1
      isubh = 1
      IF (h6b .eq. h7b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      IF (h7b .eq. h8b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,36.0d0/FACTO
     &RIAL(nsuperp(1))/FACTORIAL(nsuperp(2))/FACTORIAL(nsuperp(3))/FACTO
     &RIAL(nsubh(1))/FACTORIAL(nsubh(2))/FACTORIAL(nsubh(3)),dbl_mb(k_a_
     &sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c_sort
     &),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_3',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_3',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_3',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+h11b-1
     &),int_mb(k_range+p12b-1),2,1,1.0d0/36.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(h11b 
     &- 1 + noab * (p12b - noab - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_3',
     &10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_3',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_4(d_a,k_a_offset,d_b,k_b_offset,d_
     &c,k_c_offset)
C     i1 ( p12 h11 )_yxt + = -1 * Sum ( h2 ) * t ( p12 h2 )_t * i2 ( h2 h11 )_yx
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER p12b
      INTEGER h11b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER h2b
      INTEGER p12b_1
      INTEGER h2b_1
      INTEGER h2b_2
      INTEGER h11b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO p12b = noab+1,noab+nvab
      DO h11b = 1,noab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+p12b-1)+int_mb(k_spin+h11b
     &-1).ne.4)) THEN
      IF (int_mb(k_spin+p12b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+p12b-1),int_mb(k_sym+h11b-1)) .eq. ieor(irre
     &p_y,ieor(irrep_x,irrep_t))) THEN
      dimc = int_mb(k_range+p12b-1) * int_mb(k_range+h11b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_4',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO h2b = 1,noab
      IF (int_mb(k_spin+p12b-1) .eq. int_mb(k_spin+h2b-1)) THEN
      IF (ieor(int_mb(k_sym+p12b-1),int_mb(k_sym+h2b-1)) .eq. irrep_t) T
     &HEN
      CALL TCE_RESTRICTED_2(p12b,h2b,p12b_1,h2b_1)
      CALL TCE_RESTRICTED_2(h2b,h11b,h2b_2,h11b_2)
      dim_common = int_mb(k_range+h2b-1)
      dima_sort = int_mb(k_range+p12b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h11b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_4',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_4',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h2b_1
     & - 1 + noab * (p12b_1 - noab - 1)))
      CALL TCE_SORT_2(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p12b-1
     &),int_mb(k_range+h2b-1),1,2,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_4',
     &3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_4',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_4',5,MA_ERR)
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(h11b_
     &2 - 1 + noab * (h2b_2 - 1)))
      CALL TCE_SORT_2(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h11b-1),2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_4',
     &6,MA_ERR)
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,1.0d0,dbl_mb
     &(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c
     &_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_4',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_4',8,MA_ERR)
      END IF
      END IF
      END IF
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_4',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+h11b-1
     &),int_mb(k_range+p12b-1),2,1,-1.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(h11b 
     &- 1 + noab * (p12b - noab - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_4',
     &10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_4',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_4_1(d_a,k_a_offset,d_b,k_b_offset,
     &d_c,k_c_offset)
C     i2 ( h2 h11 )_yx + = 1 * Sum ( p4 ) * x ( p4 h11 )_x * y ( h2 p4 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h2b
      INTEGER h11b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p4b
      INTEGER p4b_1
      INTEGER h11b_1
      INTEGER h2b_2
      INTEGER p4b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h2b = 1,noab
      DO h11b = 1,noab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+h11b-
     &1).ne.4)) THEN
      IF (int_mb(k_spin+h2b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),int_mb(k_sym+h11b-1)) .eq. ieor(irrep
     &_y,irrep_x)) THEN
      dimc = int_mb(k_range+h2b-1) * int_mb(k_range+h11b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_4_1',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p4b = noab+1,noab+nvab
      IF (int_mb(k_spin+p4b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+p4b-1),int_mb(k_sym+h11b-1)) .eq. irrep_x) T
     &HEN
      CALL TCE_RESTRICTED_2(p4b,h11b,p4b_1,h11b_1)
      CALL TCE_RESTRICTED_2(h2b,p4b,h2b_2,p4b_2)
      dim_common = int_mb(k_range+p4b-1)
      dima_sort = int_mb(k_range+h11b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h2b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_4_1',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_4_1',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h11b_
     &1 - 1 + noab * (p4b_1 - noab - 1)))
      CALL TCE_SORT_2(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p4b-1)
     &,int_mb(k_range+h11b-1),2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_4_1
     &',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_4_1',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_4_1',5,MA_ERR)
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (h2b_2 - 1)))
      CALL TCE_SORT_2(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+p4b-1),1,2,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_4_1
     &',6,MA_ERR)
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,1.0d0,dbl_mb
     &(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c
     &_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_4_1',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_4_1',8,MA_ERR)
      END IF
      END IF
      END IF
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_4_1',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h11b-1),1,2,1.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(h11b 
     &- 1 + noab * (h2b - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_4_1
     &',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_4_1',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE OFFSET_eomccsdtq_density1_5_4_1(l_a_offset,k_a_offset,s
     &ize)
C     i2 ( h2 h11 )_yx
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER l_a_offset
      INTEGER k_a_offset
      INTEGER length
      INTEGER addr
      INTEGER h2b
      INTEGER h11b
      DOUBLE PRECISION size
      length = 0
      DO h2b = 1,noab
      DO h11b = 1,noab
      IF (int_mb(k_spin+h2b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),int_mb(k_sym+h11b-1)) .eq. ieor(irrep
     &_y,irrep_x)) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+h11b-
     &1).ne.4)) THEN
      length = length + 1
      END IF
      END IF
      END IF
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,2*length+1,'noname',l_a_offset,k_a_off
     &set)) CALL ERRQUIT('eomccsdtq_density1_5_4_1',0,MA_ERR)
      dbl_mb(k_a_offset) = dfloat(length)
      addr = 0
      size = 0.0d0
      DO h2b = 1,noab
      DO h11b = 1,noab
      IF (int_mb(k_spin+h2b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),int_mb(k_sym+h11b-1)) .eq. ieor(irrep
     &_y,irrep_x)) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+h11b-
     &1).ne.4)) THEN
      addr = addr + 1
      dbl_mb(k_a_offset+addr) = dfloat(h11b - 1 + noab * (h2b - 1))
      dbl_mb(k_a_offset+length+addr) = size
      size = size + dfloat(int_mb(k_range+h2b-1)) * dfloat(int_mb(k_rang
     &e+h11b-1))
      END IF
      END IF
      END IF
      END DO
      END DO
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_4_2(d_a,k_a_offset,d_b,k_b_offset,
     &d_c,k_c_offset)
C     i2 ( h2 h11 )_yx + = -1/2 * Sum ( h6 p5 p4 ) * x ( p4 p5 h6 h11 )_x * y ( h2 h6 p4 p5 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h2b
      INTEGER h11b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p4b
      INTEGER p5b
      INTEGER h6b
      INTEGER p4b_1
      INTEGER p5b_1
      INTEGER h11b_1
      INTEGER h6b_1
      INTEGER h2b_2
      INTEGER h6b_2
      INTEGER p4b_2
      INTEGER p5b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(2)
      INTEGER isuperp
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h2b = 1,noab
      DO h11b = 1,noab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+h11b-
     &1).ne.4)) THEN
      IF (int_mb(k_spin+h2b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),int_mb(k_sym+h11b-1)) .eq. ieor(irrep
     &_y,irrep_x)) THEN
      dimc = int_mb(k_range+h2b-1) * int_mb(k_range+h11b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_4_2',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p4b = noab+1,noab+nvab
      DO p5b = p4b,noab+nvab
      DO h6b = 1,noab
      IF (int_mb(k_spin+p4b-1)+int_mb(k_spin+p5b-1) .eq. int_mb(k_spin+h
     &11b-1)+int_mb(k_spin+h6b-1)) THEN
      IF (ieor(int_mb(k_sym+p4b-1),ieor(int_mb(k_sym+p5b-1),ieor(int_mb(
     &k_sym+h11b-1),int_mb(k_sym+h6b-1)))) .eq. irrep_x) THEN
      CALL TCE_RESTRICTED_4(p4b,p5b,h11b,h6b,p4b_1,p5b_1,h11b_1,h6b_1)
      CALL TCE_RESTRICTED_4(h2b,h6b,p4b,p5b,h2b_2,h6b_2,p4b_2,p5b_2)
      dim_common = int_mb(k_range+p4b-1) * int_mb(k_range+p5b-1) * int_m
     &b(k_range+h6b-1)
      dima_sort = int_mb(k_range+h11b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h2b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_4_2',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_4_2',2,MA_ERR)
      IF ((h6b .le. h11b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h11b_
     &1 - 1 + noab * (h6b_1 - 1 + noab * (p5b_1 - noab - 1 + nvab * (p4b
     &_1 - noab - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p5b-1),int_mb(k_range+h6b-1),int_mb(k_range+h11b-1
     &),4,3,2,1,1.0d0,.false.)
      END IF
      IF ((h11b .lt. h6b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h6b_1
     & - 1 + noab * (h11b_1 - 1 + noab * (p5b_1 - noab - 1 + nvab * (p4b
     &_1 - noab - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p5b-1),int_mb(k_range+h11b-1),int_mb(k_range+h6b-1
     &),3,4,2,1,-1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_4_2
     &',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_4_2',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_4_2',5,MA_ERR)
      IF ((h6b .lt. h2b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (h2b_2 - 1 + noab 
     &* (h6b_2 - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1)
     &,2,1,4,3,-1.0d0,.false.)
      END IF
      IF ((h2b .le. h6b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (h6b_2 - 1 + noab 
     &* (h2b_2 - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1)
     &,1,2,4,3,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_4_2
     &',6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      isuperp = 1
      IF (p4b .eq. p5b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,2.0d0/FACTOR
     &IAL(nsuperp(1))/FACTORIAL(nsuperp(2)),dbl_mb(k_a_sort),dim_common,
     &dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_4_2',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_4_2',8,MA_ERR)
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_4_2',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h11b-1),1,2,-1.0d0/2.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(h11b 
     &- 1 + noab * (h2b - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_4_2
     &',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_4_2',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_4_3(d_a,k_a_offset,d_b,k_b_offset,
     &d_c,k_c_offset)
C     i2 ( h2 h11 )_yx + = 1/12 * Sum ( h8 h7 p6 p5 p4 ) * x ( p4 p5 p6 h7 h8 h11 )_x * y ( h2 h7 h8 p4 p5 p6 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h2b
      INTEGER h11b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p4b
      INTEGER p5b
      INTEGER p6b
      INTEGER h7b
      INTEGER h8b
      INTEGER p4b_1
      INTEGER p5b_1
      INTEGER p6b_1
      INTEGER h11b_1
      INTEGER h7b_1
      INTEGER h8b_1
      INTEGER h2b_2
      INTEGER h7b_2
      INTEGER h8b_2
      INTEGER p4b_2
      INTEGER p5b_2
      INTEGER p6b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(3)
      INTEGER isuperp
      INTEGER nsubh(2)
      INTEGER isubh
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h2b = 1,noab
      DO h11b = 1,noab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+h11b-
     &1).ne.4)) THEN
      IF (int_mb(k_spin+h2b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),int_mb(k_sym+h11b-1)) .eq. ieor(irrep
     &_y,irrep_x)) THEN
      dimc = int_mb(k_range+h2b-1) * int_mb(k_range+h11b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_4_3',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p4b = noab+1,noab+nvab
      DO p5b = p4b,noab+nvab
      DO p6b = p5b,noab+nvab
      DO h7b = 1,noab
      DO h8b = h7b,noab
      IF (int_mb(k_active+p4b-1)+int_mb(k_active+p5b-1)+int_mb(k_active+
     &p6b-1) .ge. numact) THEN
      IF (int_mb(k_active+h11b-1)+int_mb(k_active+h7b-1)+int_mb(k_active
     &+h8b-1) .ge. numact) THEN
      IF (int_mb(k_active+h2b-1)+int_mb(k_active+h7b-1)+int_mb(k_active+
     &h8b-1) .ge. numact) THEN
      IF (int_mb(k_active+p4b-1)+int_mb(k_active+p5b-1)+int_mb(k_active+
     &p6b-1) .ge. numact) THEN
      IF (int_mb(k_spin+p4b-1)+int_mb(k_spin+p5b-1)+int_mb(k_spin+p6b-1)
     & .eq. int_mb(k_spin+h11b-1)+int_mb(k_spin+h7b-1)+int_mb(k_spin+h8b
     &-1)) THEN
      IF (ieor(int_mb(k_sym+p4b-1),ieor(int_mb(k_sym+p5b-1),ieor(int_mb(
     &k_sym+p6b-1),ieor(int_mb(k_sym+h11b-1),ieor(int_mb(k_sym+h7b-1),in
     &t_mb(k_sym+h8b-1)))))) .eq. irrep_x) THEN
      CALL TCE_RESTRICTED_6(p4b,p5b,p6b,h11b,h7b,h8b,p4b_1,p5b_1,p6b_1,h
     &11b_1,h7b_1,h8b_1)
      CALL TCE_RESTRICTED_6(h2b,h7b,h8b,p4b,p5b,p6b,h2b_2,h7b_2,h8b_2,p4
     &b_2,p5b_2,p6b_2)
      dim_common = int_mb(k_range+p4b-1) * int_mb(k_range+p5b-1) * int_m
     &b(k_range+p6b-1) * int_mb(k_range+h7b-1) * int_mb(k_range+h8b-1)
      dima_sort = int_mb(k_range+h11b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h2b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_4_3',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_4_3',2,MA_ERR)
      IF ((h8b .le. h11b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h11b_
     &1 - 1 + noab * (h8b_1 - 1 + noab * (h7b_1 - 1 + noab * (p6b_1 - no
     &ab - 1 + nvab * (p5b_1 - noab - 1 + nvab * (p4b_1 - noab - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p5b-1),int_mb(k_range+p6b-1),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h11b-1),6,5,4,3,2,1,1.0d0,.f
     &alse.)
      END IF
      IF ((h7b .le. h11b) .and. (h11b .lt. h8b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h8b_1
     & - 1 + noab * (h11b_1 - 1 + noab * (h7b_1 - 1 + noab * (p6b_1 - no
     &ab - 1 + nvab * (p5b_1 - noab - 1 + nvab * (p4b_1 - noab - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p5b-1),int_mb(k_range+p6b-1),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h11b-1),int_mb(k_range+h8b-1),5,6,4,3,2,1,-1.0d0,.
     &false.)
      END IF
      IF ((h11b .lt. h7b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h8b_1
     & - 1 + noab * (h7b_1 - 1 + noab * (h11b_1 - 1 + noab * (p6b_1 - no
     &ab - 1 + nvab * (p5b_1 - noab - 1 + nvab * (p4b_1 - noab - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p5b-1),int_mb(k_range+p6b-1),int_mb(k_range+h11b-1
     &),int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),4,6,5,3,2,1,1.0d0,.f
     &alse.)
      END IF
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_4_3
     &',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_4_3',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_4_3',5,MA_ERR)
      IF ((h8b .lt. h2b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (h2b_2 - 1 + noab * (h8b_2 - 1 + noab * (h7b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h2b-1),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p5b-1),int_mb(k_range+p6b-1),3,2,1,6,5,4,1.0d0,.fa
     &lse.)
      END IF
      IF ((h7b .lt. h2b) .and. (h2b .le. h8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (h8b_2 - 1 + noab * (h2b_2 - 1 + noab * (h7b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h8b-1),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p5b-1),int_mb(k_range+p6b-1),2,3,1,6,5,4,-1.0d0,.f
     &alse.)
      END IF
      IF ((h2b .le. h7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (h8b_2 - 1 + noab * (h7b_2 - 1 + noab * (h2b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p5b-1),int_mb(k_range+p6b-1),1,3,2,6,5,4,1.0d0,.fa
     &lse.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_4_3
     &',6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      nsuperp(3) = 1
      isuperp = 1
      IF (p4b .eq. p5b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      IF (p5b .eq. p6b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      nsubh(1) = 1
      nsubh(2) = 1
      isubh = 1
      IF (h7b .eq. h8b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,12.0d0/FACTO
     &RIAL(nsuperp(1))/FACTORIAL(nsuperp(2))/FACTORIAL(nsuperp(3))/FACTO
     &RIAL(nsubh(1))/FACTORIAL(nsubh(2)),dbl_mb(k_a_sort),dim_common,dbl
     &_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_4_3',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_4_3',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_4_3',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h11b-1),1,2,1.0d0/12.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(h11b 
     &- 1 + noab * (h2b - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_4_3
     &',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_4_3',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_4_4(d_a,k_a_offset,d_b,k_b_offset,
     &d_c,k_c_offset)
C     i2 ( h2 h11 )_yx + = -1/144 * Sum ( h10 h9 h8 p7 p6 p5 p4 ) * x ( p4 p5 p6 p7 h8 h9 h10 h11 )_x * y ( h2 h8 h9 h10 p4 p5 p6 p7 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h2b
      INTEGER h11b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p4b
      INTEGER p5b
      INTEGER p6b
      INTEGER p7b
      INTEGER h8b
      INTEGER h9b
      INTEGER h10b
      INTEGER p4b_1
      INTEGER p5b_1
      INTEGER p6b_1
      INTEGER p7b_1
      INTEGER h11b_1
      INTEGER h8b_1
      INTEGER h9b_1
      INTEGER h10b_1
      INTEGER h2b_2
      INTEGER h8b_2
      INTEGER h9b_2
      INTEGER h10b_2
      INTEGER p4b_2
      INTEGER p5b_2
      INTEGER p6b_2
      INTEGER p7b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(4)
      INTEGER isuperp
      INTEGER nsubh(3)
      INTEGER isubh
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h2b = 1,noab
      DO h11b = 1,noab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+h11b-
     &1).ne.4)) THEN
      IF (int_mb(k_spin+h2b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),int_mb(k_sym+h11b-1)) .eq. ieor(irrep
     &_y,irrep_x)) THEN
      dimc = int_mb(k_range+h2b-1) * int_mb(k_range+h11b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_4_4',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p4b = noab+1,noab+nvab
      DO p5b = p4b,noab+nvab
      DO p6b = p5b,noab+nvab
      DO p7b = p6b,noab+nvab
      DO h8b = 1,noab
      DO h9b = h8b,noab
      DO h10b = h9b,noab
      IF (int_mb(k_active+p4b-1)+int_mb(k_active+p5b-1)+int_mb(k_active+
     &p6b-1)+int_mb(k_active+p7b-1) .ge. numacq) THEN
      IF (int_mb(k_active+h11b-1)+int_mb(k_active+h8b-1)+int_mb(k_active
     &+h9b-1)+int_mb(k_active+h10b-1) .ge. numacq) THEN
      IF (int_mb(k_active+h2b-1)+int_mb(k_active+h8b-1)+int_mb(k_active+
     &h9b-1)+int_mb(k_active+h10b-1) .ge. numacq) THEN
      IF (int_mb(k_active+p4b-1)+int_mb(k_active+p5b-1)+int_mb(k_active+
     &p6b-1)+int_mb(k_active+p7b-1) .ge. numacq) THEN
      IF (int_mb(k_spin+p4b-1)+int_mb(k_spin+p5b-1)+int_mb(k_spin+p6b-1)
     &+int_mb(k_spin+p7b-1) .eq. int_mb(k_spin+h11b-1)+int_mb(k_spin+h8b
     &-1)+int_mb(k_spin+h9b-1)+int_mb(k_spin+h10b-1)) THEN
      IF (ieor(int_mb(k_sym+p4b-1),ieor(int_mb(k_sym+p5b-1),ieor(int_mb(
     &k_sym+p6b-1),ieor(int_mb(k_sym+p7b-1),ieor(int_mb(k_sym+h11b-1),ie
     &or(int_mb(k_sym+h8b-1),ieor(int_mb(k_sym+h9b-1),int_mb(k_sym+h10b-
     &1)))))))) .eq. irrep_x) THEN
      CALL TCE_RESTRICTED_8(p4b,p5b,p6b,p7b,h11b,h8b,h9b,h10b,p4b_1,p5b_
     &1,p6b_1,p7b_1,h11b_1,h8b_1,h9b_1,h10b_1)
      CALL TCE_RESTRICTED_8(h2b,h8b,h9b,h10b,p4b,p5b,p6b,p7b,h2b_2,h8b_2
     &,h9b_2,h10b_2,p4b_2,p5b_2,p6b_2,p7b_2)
      dim_common = int_mb(k_range+p4b-1) * int_mb(k_range+p5b-1) * int_m
     &b(k_range+p6b-1) * int_mb(k_range+p7b-1) * int_mb(k_range+h8b-1) *
     & int_mb(k_range+h9b-1) * int_mb(k_range+h10b-1)
      dima_sort = int_mb(k_range+h11b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h2b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_4_4',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_4_4',2,MA_ERR)
      IF ((h10b .le. h11b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h11b_
     &1 - 1 + noab * (h10b_1 - 1 + noab * (h9b_1 - 1 + noab * (h8b_1 - 1
     & + noab * (p7b_1 - noab - 1 + nvab * (p6b_1 - noab - 1 + nvab * (p
     &5b_1 - noab - 1 + nvab * (p4b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p5b-1),int_mb(k_range+p6b-1),int_mb(k_range+p7b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h9b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+h11b-1),8,7,6,5,4,3,2,1,1.0d0,.false.)
      END IF
      IF ((h9b .le. h11b) .and. (h11b .lt. h10b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h10b_
     &1 - 1 + noab * (h11b_1 - 1 + noab * (h9b_1 - 1 + noab * (h8b_1 - 1
     & + noab * (p7b_1 - noab - 1 + nvab * (p6b_1 - noab - 1 + nvab * (p
     &5b_1 - noab - 1 + nvab * (p4b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p5b-1),int_mb(k_range+p6b-1),int_mb(k_range+p7b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h9b-1),int_mb(k_range+h11b-1
     &),int_mb(k_range+h10b-1),7,8,6,5,4,3,2,1,-1.0d0,.false.)
      END IF
      IF ((h8b .le. h11b) .and. (h11b .lt. h9b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h10b_
     &1 - 1 + noab * (h9b_1 - 1 + noab * (h11b_1 - 1 + noab * (h8b_1 - 1
     & + noab * (p7b_1 - noab - 1 + nvab * (p6b_1 - noab - 1 + nvab * (p
     &5b_1 - noab - 1 + nvab * (p4b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p5b-1),int_mb(k_range+p6b-1),int_mb(k_range+p7b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h11b-1),int_mb(k_range+h9b-1
     &),int_mb(k_range+h10b-1),6,8,7,5,4,3,2,1,1.0d0,.false.)
      END IF
      IF ((h11b .lt. h8b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h10b_
     &1 - 1 + noab * (h9b_1 - 1 + noab * (h8b_1 - 1 + noab * (h11b_1 - 1
     & + noab * (p7b_1 - noab - 1 + nvab * (p6b_1 - noab - 1 + nvab * (p
     &5b_1 - noab - 1 + nvab * (p4b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p5b-1),int_mb(k_range+p6b-1),int_mb(k_range+p7b-1)
     &,int_mb(k_range+h11b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1
     &),int_mb(k_range+h10b-1),5,8,7,6,4,3,2,1,-1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_4_4
     &',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_4_4',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_4_4',5,MA_ERR)
      IF ((h10b .lt. h2b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p5b_2 - noab - 1 
     &+ nvab * (p4b_2 - noab - 1 + nvab * (h2b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h9b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h10b-1),int_mb(k_range+h2b-1
     &),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1
     &),int_mb(k_range+p7b-1),4,3,2,1,8,7,6,5,-1.0d0,.false.)
      END IF
      IF ((h9b .lt. h2b) .and. (h2b .le. h10b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p5b_2 - noab - 1 
     &+ nvab * (p4b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h2b_2 - 
     &1 + noab * (h9b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h2b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1
     &),int_mb(k_range+p7b-1),3,4,2,1,8,7,6,5,1.0d0,.false.)
      END IF
      IF ((h8b .lt. h2b) .and. (h2b .le. h9b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p5b_2 - noab - 1 
     &+ nvab * (p4b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h9b_2 - 
     &1 + noab * (h2b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h9b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1
     &),int_mb(k_range+p7b-1),2,4,3,1,8,7,6,5,-1.0d0,.false.)
      END IF
      IF ((h2b .le. h8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p5b_2 - noab - 1 
     &+ nvab * (p4b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h9b_2 - 
     &1 + noab * (h8b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h9b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1
     &),int_mb(k_range+p7b-1),1,4,3,2,8,7,6,5,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_4_4
     &',6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      nsuperp(3) = 1
      nsuperp(4) = 1
      isuperp = 1
      IF (p4b .eq. p5b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      IF (p5b .eq. p6b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      IF (p6b .eq. p7b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      nsubh(1) = 1
      nsubh(2) = 1
      nsubh(3) = 1
      isubh = 1
      IF (h8b .eq. h9b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      IF (h9b .eq. h10b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,144.0d0/FACT
     &ORIAL(nsuperp(1))/FACTORIAL(nsuperp(2))/FACTORIAL(nsuperp(3))/FACT
     &ORIAL(nsuperp(4))/FACTORIAL(nsubh(1))/FACTORIAL(nsubh(2))/FACTORIA
     &L(nsubh(3)),dbl_mb(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_commo
     &n,1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_4_4',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_4_4',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_4_4',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h11b-1),1,2,-1.0d0/144.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(h11b 
     &- 1 + noab * (h2b - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_4_4
     &',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_4_4',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_4_5(d_a,k_a_offset,d_b,k_b_offset,
     &d_c,k_c_offset)
C     i2 ( h2 h11 )_ytx + = 1 * x ( )_x * i3 ( h2 h11 )_yt
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h2b
      INTEGER h11b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER h2b_2
      INTEGER h11b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h2b = 1,noab
      DO h11b = 1,noab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+h11b-
     &1).ne.4)) THEN
      IF (int_mb(k_spin+h2b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),int_mb(k_sym+h11b-1)) .eq. ieor(irrep
     &_y,ieor(irrep_t,irrep_x))) THEN
      dimc = int_mb(k_range+h2b-1) * int_mb(k_range+h11b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_4_5',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      IF (0 .eq. irrep_x) THEN
      CALL TCE_RESTRICTED_2(h2b,h11b,h2b_2,h11b_2)
      dim_common = 1
      dima_sort = 1
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h2b-1) * int_mb(k_range+h11b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_4_5',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_4_5',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),0)
      CALL TCE_SORT_0(dbl_mb(k_a),dbl_mb(k_a_sort),1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_4_5
     &',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_4_5',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_4_5',5,MA_ERR)
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(h11b_
     &2 - 1 + noab * (h2b_2 - 1)))
      CALL TCE_SORT_2(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h11b-1),2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_4_5
     &',6,MA_ERR)
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,1.0d0,dbl_mb
     &(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c
     &_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_4_5',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_4_5',8,MA_ERR)
      END IF
      END IF
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_4_5',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+h11b-1
     &),int_mb(k_range+h2b-1),2,1,1.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(h11b 
     &- 1 + noab * (h2b - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_4_5
     &',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_4_5',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_4_5_1(d_a,k_a_offset,d_b,k_b_offse
     &t,d_c,k_c_offset)
C     i3 ( h2 h11 )_yt + = 1 * Sum ( p3 ) * t ( p3 h11 )_t * y ( h2 p3 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h2b
      INTEGER h11b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p3b
      INTEGER p3b_1
      INTEGER h11b_1
      INTEGER h2b_2
      INTEGER p3b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h2b = 1,noab
      DO h11b = 1,noab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+h11b-
     &1).ne.4)) THEN
      IF (int_mb(k_spin+h2b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),int_mb(k_sym+h11b-1)) .eq. ieor(irrep
     &_y,irrep_t)) THEN
      dimc = int_mb(k_range+h2b-1) * int_mb(k_range+h11b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_4_5_1',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p3b = noab+1,noab+nvab
      IF (int_mb(k_spin+p3b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+p3b-1),int_mb(k_sym+h11b-1)) .eq. irrep_t) T
     &HEN
      CALL TCE_RESTRICTED_2(p3b,h11b,p3b_1,h11b_1)
      CALL TCE_RESTRICTED_2(h2b,p3b,h2b_2,p3b_2)
      dim_common = int_mb(k_range+p3b-1)
      dima_sort = int_mb(k_range+h11b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h2b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_4_5_1',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_4_5_1',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h11b_
     &1 - 1 + noab * (p3b_1 - noab - 1)))
      CALL TCE_SORT_2(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+h11b-1),2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_4_5
     &_1',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_4_5_1',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_4_5_1',5,MA_ERR)
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (h2b_2 - 1)))
      CALL TCE_SORT_2(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+p3b-1),1,2,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_4_5
     &_1',6,MA_ERR)
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,1.0d0,dbl_mb
     &(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c
     &_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_4_5_1',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_4_5_1',8,MA_ERR)
      END IF
      END IF
      END IF
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_4_5_1',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h11b-1),1,2,1.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(h11b 
     &- 1 + noab * (h2b - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_4_5
     &_1',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_4_5_1',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE OFFSET_eomccsdtq_density1_5_4_5_1(l_a_offset,k_a_offset
     &,size)
C     i3 ( h2 h11 )_yt
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER l_a_offset
      INTEGER k_a_offset
      INTEGER length
      INTEGER addr
      INTEGER h2b
      INTEGER h11b
      DOUBLE PRECISION size
      length = 0
      DO h2b = 1,noab
      DO h11b = 1,noab
      IF (int_mb(k_spin+h2b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),int_mb(k_sym+h11b-1)) .eq. ieor(irrep
     &_y,irrep_t)) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+h11b-
     &1).ne.4)) THEN
      length = length + 1
      END IF
      END IF
      END IF
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,2*length+1,'noname',l_a_offset,k_a_off
     &set)) CALL ERRQUIT('eomccsdtq_density1_5_4_5_1',0,MA_ERR)
      dbl_mb(k_a_offset) = dfloat(length)
      addr = 0
      size = 0.0d0
      DO h2b = 1,noab
      DO h11b = 1,noab
      IF (int_mb(k_spin+h2b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),int_mb(k_sym+h11b-1)) .eq. ieor(irrep
     &_y,irrep_t)) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+h11b-
     &1).ne.4)) THEN
      addr = addr + 1
      dbl_mb(k_a_offset+addr) = dfloat(h11b - 1 + noab * (h2b - 1))
      dbl_mb(k_a_offset+length+addr) = size
      size = size + dfloat(int_mb(k_range+h2b-1)) * dfloat(int_mb(k_rang
     &e+h11b-1))
      END IF
      END IF
      END IF
      END DO
      END DO
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_4_5_2(d_a,k_a_offset,d_b,k_b_offse
     &t,d_c,k_c_offset)
C     i3 ( h2 h11 )_yt + = -1/2 * Sum ( h5 p4 p3 ) * t ( p3 p4 h5 h11 )_t * y ( h2 h5 p3 p4 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h2b
      INTEGER h11b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p3b
      INTEGER p4b
      INTEGER h5b
      INTEGER p3b_1
      INTEGER p4b_1
      INTEGER h11b_1
      INTEGER h5b_1
      INTEGER h2b_2
      INTEGER h5b_2
      INTEGER p3b_2
      INTEGER p4b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(2)
      INTEGER isuperp
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h2b = 1,noab
      DO h11b = 1,noab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+h11b-
     &1).ne.4)) THEN
      IF (int_mb(k_spin+h2b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),int_mb(k_sym+h11b-1)) .eq. ieor(irrep
     &_y,irrep_t)) THEN
      dimc = int_mb(k_range+h2b-1) * int_mb(k_range+h11b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_4_5_2',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      DO h5b = 1,noab
      IF (int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1) .eq. int_mb(k_spin+h
     &11b-1)+int_mb(k_spin+h5b-1)) THEN
      IF (ieor(int_mb(k_sym+p3b-1),ieor(int_mb(k_sym+p4b-1),ieor(int_mb(
     &k_sym+h11b-1),int_mb(k_sym+h5b-1)))) .eq. irrep_t) THEN
      CALL TCE_RESTRICTED_4(p3b,p4b,h11b,h5b,p3b_1,p4b_1,h11b_1,h5b_1)
      CALL TCE_RESTRICTED_4(h2b,h5b,p3b,p4b,h2b_2,h5b_2,p3b_2,p4b_2)
      dim_common = int_mb(k_range+p3b-1) * int_mb(k_range+p4b-1) * int_m
     &b(k_range+h5b-1)
      dima_sort = int_mb(k_range+h11b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h2b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_4_5_2',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_4_5_2',2,MA_ERR)
      IF ((h5b .le. h11b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h11b_
     &1 - 1 + noab * (h5b_1 - 1 + noab * (p4b_1 - noab - 1 + nvab * (p3b
     &_1 - noab - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+h5b-1),int_mb(k_range+h11b-1
     &),4,3,2,1,1.0d0,.false.)
      END IF
      IF ((h11b .lt. h5b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h5b_1
     & - 1 + noab * (h11b_1 - 1 + noab * (p4b_1 - noab - 1 + nvab * (p3b
     &_1 - noab - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+h11b-1),int_mb(k_range+h5b-1
     &),3,4,2,1,-1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_4_5
     &_2',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_4_5_2',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_4_5_2',5,MA_ERR)
      IF ((h5b .lt. h2b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (h2b_2 - 1 + noab 
     &* (h5b_2 - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1)
     &,2,1,4,3,-1.0d0,.false.)
      END IF
      IF ((h2b .le. h5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab 
     &* (h2b_2 - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1)
     &,1,2,4,3,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_4_5
     &_2',6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      isuperp = 1
      IF (p3b .eq. p4b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,2.0d0/FACTOR
     &IAL(nsuperp(1))/FACTORIAL(nsuperp(2)),dbl_mb(k_a_sort),dim_common,
     &dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_4_5_2',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_4_5_2',8,MA_ERR)
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_4_5_2',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h11b-1),1,2,-1.0d0/2.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(h11b 
     &- 1 + noab * (h2b - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_4_5
     &_2',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_4_5_2',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_4_5_3(d_a,k_a_offset,d_b,k_b_offse
     &t,d_c,k_c_offset)
C     i3 ( h2 h11 )_yt + = 1/12 * Sum ( h7 h6 p5 p4 p3 ) * t ( p3 p4 p5 h6 h7 h11 )_t * y ( h2 h6 h7 p3 p4 p5 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h2b
      INTEGER h11b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p3b
      INTEGER p4b
      INTEGER p5b
      INTEGER h6b
      INTEGER h7b
      INTEGER p3b_1
      INTEGER p4b_1
      INTEGER p5b_1
      INTEGER h11b_1
      INTEGER h6b_1
      INTEGER h7b_1
      INTEGER h2b_2
      INTEGER h6b_2
      INTEGER h7b_2
      INTEGER p3b_2
      INTEGER p4b_2
      INTEGER p5b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(3)
      INTEGER isuperp
      INTEGER nsubh(2)
      INTEGER isubh
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h2b = 1,noab
      DO h11b = 1,noab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+h11b-
     &1).ne.4)) THEN
      IF (int_mb(k_spin+h2b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),int_mb(k_sym+h11b-1)) .eq. ieor(irrep
     &_y,irrep_t)) THEN
      dimc = int_mb(k_range+h2b-1) * int_mb(k_range+h11b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_4_5_3',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      DO p5b = p4b,noab+nvab
      DO h6b = 1,noab
      DO h7b = h6b,noab
      IF (int_mb(k_active+p3b-1)+int_mb(k_active+p4b-1)+int_mb(k_active+
     &p5b-1) .ge. numact) THEN
      IF (int_mb(k_active+h11b-1)+int_mb(k_active+h6b-1)+int_mb(k_active
     &+h7b-1) .ge. numact) THEN
      IF (int_mb(k_active+h2b-1)+int_mb(k_active+h6b-1)+int_mb(k_active+
     &h7b-1) .ge. numact) THEN
      IF (int_mb(k_active+p3b-1)+int_mb(k_active+p4b-1)+int_mb(k_active+
     &p5b-1) .ge. numact) THEN
      IF (int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1)+int_mb(k_spin+p5b-1)
     & .eq. int_mb(k_spin+h11b-1)+int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b
     &-1)) THEN
      IF (ieor(int_mb(k_sym+p3b-1),ieor(int_mb(k_sym+p4b-1),ieor(int_mb(
     &k_sym+p5b-1),ieor(int_mb(k_sym+h11b-1),ieor(int_mb(k_sym+h6b-1),in
     &t_mb(k_sym+h7b-1)))))) .eq. irrep_t) THEN
      CALL TCE_RESTRICTED_6(p3b,p4b,p5b,h11b,h6b,h7b,p3b_1,p4b_1,p5b_1,h
     &11b_1,h6b_1,h7b_1)
      CALL TCE_RESTRICTED_6(h2b,h6b,h7b,p3b,p4b,p5b,h2b_2,h6b_2,h7b_2,p3
     &b_2,p4b_2,p5b_2)
      dim_common = int_mb(k_range+p3b-1) * int_mb(k_range+p4b-1) * int_m
     &b(k_range+p5b-1) * int_mb(k_range+h6b-1) * int_mb(k_range+h7b-1)
      dima_sort = int_mb(k_range+h11b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h2b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_4_5_3',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_4_5_3',2,MA_ERR)
      IF ((h7b .le. h11b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h11b_
     &1 - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 + noab * (p5b_1 - no
     &ab - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h11b-1),6,5,4,3,2,1,1.0d0,.f
     &alse.)
      END IF
      IF ((h6b .le. h11b) .and. (h11b .lt. h7b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h7b_1
     & - 1 + noab * (h11b_1 - 1 + noab * (h6b_1 - 1 + noab * (p5b_1 - no
     &ab - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h11b-1),int_mb(k_range+h7b-1),5,6,4,3,2,1,-1.0d0,.
     &false.)
      END IF
      IF ((h11b .lt. h6b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h7b_1
     & - 1 + noab * (h6b_1 - 1 + noab * (h11b_1 - 1 + noab * (p5b_1 - no
     &ab - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+h11b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),4,6,5,3,2,1,1.0d0,.f
     &alse.)
      END IF
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_4_5
     &_3',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_4_5_3',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_4_5_3',5,MA_ERR)
      IF ((h7b .lt. h2b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h2b_2 - 1 + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h2b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),3,2,1,6,5,4,1.0d0,.fa
     &lse.)
      END IF
      IF ((h6b .lt. h2b) .and. (h2b .le. h7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h7b_2 - 1 + noab * (h2b_2 - 1 + noab * (h6b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h7b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),2,3,1,6,5,4,-1.0d0,.f
     &alse.)
      END IF
      IF ((h2b .le. h6b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h7b_2 - 1 + noab * (h6b_2 - 1 + noab * (h2b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),1,3,2,6,5,4,1.0d0,.fa
     &lse.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_4_5
     &_3',6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      nsuperp(3) = 1
      isuperp = 1
      IF (p3b .eq. p4b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      IF (p4b .eq. p5b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      nsubh(1) = 1
      nsubh(2) = 1
      isubh = 1
      IF (h6b .eq. h7b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,12.0d0/FACTO
     &RIAL(nsuperp(1))/FACTORIAL(nsuperp(2))/FACTORIAL(nsuperp(3))/FACTO
     &RIAL(nsubh(1))/FACTORIAL(nsubh(2)),dbl_mb(k_a_sort),dim_common,dbl
     &_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_4_5_3',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_4_5_3',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_4_5_3',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h11b-1),1,2,1.0d0/12.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(h11b 
     &- 1 + noab * (h2b - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_4_5
     &_3',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_4_5_3',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_4_5_4(d_a,k_a_offset,d_b,k_b_offse
     &t,d_c,k_c_offset)
C     i3 ( h2 h11 )_yt + = -1/144 * Sum ( h9 h8 h7 p6 p5 p4 p3 ) * t ( p3 p4 p5 p6 h7 h8 h9 h11 )_t * y ( h2 h7 h8 h9 p3 p4 p5 p6 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h2b
      INTEGER h11b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p3b
      INTEGER p4b
      INTEGER p5b
      INTEGER p6b
      INTEGER h7b
      INTEGER h8b
      INTEGER h9b
      INTEGER p3b_1
      INTEGER p4b_1
      INTEGER p5b_1
      INTEGER p6b_1
      INTEGER h11b_1
      INTEGER h7b_1
      INTEGER h8b_1
      INTEGER h9b_1
      INTEGER h2b_2
      INTEGER h7b_2
      INTEGER h8b_2
      INTEGER h9b_2
      INTEGER p3b_2
      INTEGER p4b_2
      INTEGER p5b_2
      INTEGER p6b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(4)
      INTEGER isuperp
      INTEGER nsubh(3)
      INTEGER isubh
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h2b = 1,noab
      DO h11b = 1,noab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+h11b-
     &1).ne.4)) THEN
      IF (int_mb(k_spin+h2b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),int_mb(k_sym+h11b-1)) .eq. ieor(irrep
     &_y,irrep_t)) THEN
      dimc = int_mb(k_range+h2b-1) * int_mb(k_range+h11b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_4_5_4',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      DO p5b = p4b,noab+nvab
      DO p6b = p5b,noab+nvab
      DO h7b = 1,noab
      DO h8b = h7b,noab
      DO h9b = h8b,noab
      IF (int_mb(k_active+p3b-1)+int_mb(k_active+p4b-1)+int_mb(k_active+
     &p5b-1)+int_mb(k_active+p6b-1) .ge. numacq) THEN
      IF (int_mb(k_active+h11b-1)+int_mb(k_active+h7b-1)+int_mb(k_active
     &+h8b-1)+int_mb(k_active+h9b-1) .ge. numacq) THEN
      IF (int_mb(k_active+h2b-1)+int_mb(k_active+h7b-1)+int_mb(k_active+
     &h8b-1)+int_mb(k_active+h9b-1) .ge. numacq) THEN
      IF (int_mb(k_active+p3b-1)+int_mb(k_active+p4b-1)+int_mb(k_active+
     &p5b-1)+int_mb(k_active+p6b-1) .ge. numacq) THEN
      IF (int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1)+int_mb(k_spin+p5b-1)
     &+int_mb(k_spin+p6b-1) .eq. int_mb(k_spin+h11b-1)+int_mb(k_spin+h7b
     &-1)+int_mb(k_spin+h8b-1)+int_mb(k_spin+h9b-1)) THEN
      IF (ieor(int_mb(k_sym+p3b-1),ieor(int_mb(k_sym+p4b-1),ieor(int_mb(
     &k_sym+p5b-1),ieor(int_mb(k_sym+p6b-1),ieor(int_mb(k_sym+h11b-1),ie
     &or(int_mb(k_sym+h7b-1),ieor(int_mb(k_sym+h8b-1),int_mb(k_sym+h9b-1
     &)))))))) .eq. irrep_t) THEN
      CALL TCE_RESTRICTED_8(p3b,p4b,p5b,p6b,h11b,h7b,h8b,h9b,p3b_1,p4b_1
     &,p5b_1,p6b_1,h11b_1,h7b_1,h8b_1,h9b_1)
      CALL TCE_RESTRICTED_8(h2b,h7b,h8b,h9b,p3b,p4b,p5b,p6b,h2b_2,h7b_2,
     &h8b_2,h9b_2,p3b_2,p4b_2,p5b_2,p6b_2)
      dim_common = int_mb(k_range+p3b-1) * int_mb(k_range+p4b-1) * int_m
     &b(k_range+p5b-1) * int_mb(k_range+p6b-1) * int_mb(k_range+h7b-1) *
     & int_mb(k_range+h8b-1) * int_mb(k_range+h9b-1)
      dima_sort = int_mb(k_range+h11b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h2b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_4_5_4',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_4_5_4',2,MA_ERR)
      IF ((h9b .le. h11b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h11b_
     &1 - 1 + noab * (h9b_1 - 1 + noab * (h8b_1 - 1 + noab * (h7b_1 - 1 
     &+ noab * (p6b_1 - noab - 1 + nvab * (p5b_1 - noab - 1 + nvab * (p4
     &b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h11b-1),8,7,6,5,4,3,2,1,1.0d0,.false.)
      END IF
      IF ((h8b .le. h11b) .and. (h11b .lt. h9b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h9b_1
     & - 1 + noab * (h11b_1 - 1 + noab * (h8b_1 - 1 + noab * (h7b_1 - 1 
     &+ noab * (p6b_1 - noab - 1 + nvab * (p5b_1 - noab - 1 + nvab * (p4
     &b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),int_mb(k_range+h11b-1
     &),int_mb(k_range+h9b-1),7,8,6,5,4,3,2,1,-1.0d0,.false.)
      END IF
      IF ((h7b .le. h11b) .and. (h11b .lt. h8b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h9b_1
     & - 1 + noab * (h8b_1 - 1 + noab * (h11b_1 - 1 + noab * (h7b_1 - 1 
     &+ noab * (p6b_1 - noab - 1 + nvab * (p5b_1 - noab - 1 + nvab * (p4
     &b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h11b-1),int_mb(k_range+h8b-1
     &),int_mb(k_range+h9b-1),6,8,7,5,4,3,2,1,1.0d0,.false.)
      END IF
      IF ((h11b .lt. h7b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h9b_1
     & - 1 + noab * (h8b_1 - 1 + noab * (h7b_1 - 1 + noab * (h11b_1 - 1 
     &+ noab * (p6b_1 - noab - 1 + nvab * (p5b_1 - noab - 1 + nvab * (p4
     &b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1)
     &,int_mb(k_range+h11b-1),int_mb(k_range+h7b-1),int_mb(k_range+h8b-1
     &),int_mb(k_range+h9b-1),5,8,7,6,4,3,2,1,-1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_4_5
     &_4',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_4_5_4',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_4_5_4',5,MA_ERR)
      IF ((h9b .lt. h2b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h2b_2 - 1 + noab * (h9b_2 - 1
     & + noab * (h8b_2 - 1 + noab * (h7b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h9b-1),int_mb(k_range+h2b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p6b-1),4,3,2,1,8,7,6,5,-1.0d0,.false.)
      END IF
      IF ((h8b .lt. h2b) .and. (h2b .le. h9b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h2b_2 - 1
     & + noab * (h8b_2 - 1 + noab * (h7b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h2b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p6b-1),3,4,2,1,8,7,6,5,1.0d0,.false.)
      END IF
      IF ((h7b .lt. h2b) .and. (h2b .le. h8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h8b_2 - 1
     & + noab * (h2b_2 - 1 + noab * (h7b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p6b-1),2,4,3,1,8,7,6,5,-1.0d0,.false.)
      END IF
      IF ((h2b .le. h7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h8b_2 - 1
     & + noab * (h7b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p6b-1),1,4,3,2,8,7,6,5,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_4_5
     &_4',6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      nsuperp(3) = 1
      nsuperp(4) = 1
      isuperp = 1
      IF (p3b .eq. p4b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      IF (p4b .eq. p5b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      IF (p5b .eq. p6b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      nsubh(1) = 1
      nsubh(2) = 1
      nsubh(3) = 1
      isubh = 1
      IF (h7b .eq. h8b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      IF (h8b .eq. h9b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,144.0d0/FACT
     &ORIAL(nsuperp(1))/FACTORIAL(nsuperp(2))/FACTORIAL(nsuperp(3))/FACT
     &ORIAL(nsuperp(4))/FACTORIAL(nsubh(1))/FACTORIAL(nsubh(2))/FACTORIA
     &L(nsubh(3)),dbl_mb(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_commo
     &n,1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_4_5_4',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_4_5_4',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_4_5_4',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h11b-1),1,2,-1.0d0/144.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(h11b 
     &- 1 + noab * (h2b - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_4_5
     &_4',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_4_5_4',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_4_6(d_a,k_a_offset,d_b,k_b_offset,
     &d_c,k_c_offset)
C     i2 ( h2 h11 )_yxt + = 1 * Sum ( p3 ) * t ( p3 h11 )_t * i3 ( h2 p3 )_yx
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h2b
      INTEGER h11b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p3b
      INTEGER p3b_1
      INTEGER h11b_1
      INTEGER h2b_2
      INTEGER p3b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h2b = 1,noab
      DO h11b = 1,noab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+h11b-
     &1).ne.4)) THEN
      IF (int_mb(k_spin+h2b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),int_mb(k_sym+h11b-1)) .eq. ieor(irrep
     &_y,ieor(irrep_x,irrep_t))) THEN
      dimc = int_mb(k_range+h2b-1) * int_mb(k_range+h11b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_4_6',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p3b = noab+1,noab+nvab
      IF (int_mb(k_spin+p3b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+p3b-1),int_mb(k_sym+h11b-1)) .eq. irrep_t) T
     &HEN
      CALL TCE_RESTRICTED_2(p3b,h11b,p3b_1,h11b_1)
      CALL TCE_RESTRICTED_2(h2b,p3b,h2b_2,p3b_2)
      dim_common = int_mb(k_range+p3b-1)
      dima_sort = int_mb(k_range+h11b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h2b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_4_6',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_4_6',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h11b_
     &1 - 1 + noab * (p3b_1 - noab - 1)))
      CALL TCE_SORT_2(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+h11b-1),2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_4_6
     &',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_4_6',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_4_6',5,MA_ERR)
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (h2b_2 - 1)))
      CALL TCE_SORT_2(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+p3b-1),1,2,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_4_6
     &',6,MA_ERR)
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,1.0d0,dbl_mb
     &(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c
     &_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_4_6',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_4_6',8,MA_ERR)
      END IF
      END IF
      END IF
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_4_6',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h11b-1),1,2,1.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(h11b 
     &- 1 + noab * (h2b - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_4_6
     &',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_4_6',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_4_6_1(d_a,k_a_offset,d_b,k_b_offse
     &t,d_c,k_c_offset)
C     i3 ( h2 p3 )_yx + = 1 * Sum ( h6 p5 ) * x ( p5 h6 )_x * y ( h2 h6 p3 p5 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h2b
      INTEGER p3b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p5b
      INTEGER h6b
      INTEGER p5b_1
      INTEGER h6b_1
      INTEGER h2b_2
      INTEGER h6b_2
      INTEGER p3b_2
      INTEGER p5b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h2b = 1,noab
      DO p3b = noab+1,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+p3b-1
     &).ne.4)) THEN
      IF (int_mb(k_spin+h2b-1) .eq. int_mb(k_spin+p3b-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),int_mb(k_sym+p3b-1)) .eq. ieor(irrep_
     &y,irrep_x)) THEN
      dimc = int_mb(k_range+h2b-1) * int_mb(k_range+p3b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_4_6_1',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p5b = noab+1,noab+nvab
      DO h6b = 1,noab
      IF (int_mb(k_spin+p5b-1) .eq. int_mb(k_spin+h6b-1)) THEN
      IF (ieor(int_mb(k_sym+p5b-1),int_mb(k_sym+h6b-1)) .eq. irrep_x) TH
     &EN
      CALL TCE_RESTRICTED_2(p5b,h6b,p5b_1,h6b_1)
      CALL TCE_RESTRICTED_4(h2b,h6b,p3b,p5b,h2b_2,h6b_2,p3b_2,p5b_2)
      dim_common = int_mb(k_range+p5b-1) * int_mb(k_range+h6b-1)
      dima_sort = 1
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h2b-1) * int_mb(k_range+p3b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_4_6_1',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_4_6_1',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h6b_1
     & - 1 + noab * (p5b_1 - noab - 1)))
      CALL TCE_SORT_2(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p5b-1)
     &,int_mb(k_range+h6b-1),2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_4_6
     &_1',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_4_6_1',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_4_6_1',5,MA_ERR)
      IF ((h6b .lt. h2b) .and. (p5b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (h2b_2 - 1 + noab 
     &* (h6b_2 - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+p5b-1),int_mb(k_range+p3b-1)
     &,4,2,1,3,1.0d0,.false.)
      END IF
      IF ((h6b .lt. h2b) .and. (p3b .le. p5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (h2b_2 - 1 + noab 
     &* (h6b_2 - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+p3b-1),int_mb(k_range+p5b-1)
     &,3,2,1,4,-1.0d0,.false.)
      END IF
      IF ((h2b .le. h6b) .and. (p5b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (h6b_2 - 1 + noab 
     &* (h2b_2 - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+p5b-1),int_mb(k_range+p3b-1)
     &,4,1,2,3,-1.0d0,.false.)
      END IF
      IF ((h2b .le. h6b) .and. (p3b .le. p5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (h6b_2 - 1 + noab 
     &* (h2b_2 - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+p3b-1),int_mb(k_range+p5b-1)
     &,3,1,2,4,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_4_6
     &_1',6,MA_ERR)
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,1.0d0,dbl_mb
     &(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c
     &_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_4_6_1',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_4_6_1',8,MA_ERR)
      END IF
      END IF
      END IF
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_4_6_1',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p3b-1)
     &,int_mb(k_range+h2b-1),2,1,1.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p3b -
     & noab - 1 + nvab * (h2b - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_4_6
     &_1',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_4_6_1',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE OFFSET_eomccsdtq_density1_5_4_6_1(l_a_offset,k_a_offset
     &,size)
C     i3 ( h2 p3 )_yx
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER l_a_offset
      INTEGER k_a_offset
      INTEGER length
      INTEGER addr
      INTEGER h2b
      INTEGER p3b
      DOUBLE PRECISION size
      length = 0
      DO h2b = 1,noab
      DO p3b = noab+1,noab+nvab
      IF (int_mb(k_spin+h2b-1) .eq. int_mb(k_spin+p3b-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),int_mb(k_sym+p3b-1)) .eq. ieor(irrep_
     &y,irrep_x)) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+p3b-1
     &).ne.4)) THEN
      length = length + 1
      END IF
      END IF
      END IF
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,2*length+1,'noname',l_a_offset,k_a_off
     &set)) CALL ERRQUIT('eomccsdtq_density1_5_4_6_1',0,MA_ERR)
      dbl_mb(k_a_offset) = dfloat(length)
      addr = 0
      size = 0.0d0
      DO h2b = 1,noab
      DO p3b = noab+1,noab+nvab
      IF (int_mb(k_spin+h2b-1) .eq. int_mb(k_spin+p3b-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),int_mb(k_sym+p3b-1)) .eq. ieor(irrep_
     &y,irrep_x)) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+p3b-1
     &).ne.4)) THEN
      addr = addr + 1
      dbl_mb(k_a_offset+addr) = dfloat(p3b - noab - 1 + nvab * (h2b - 1)
     &)
      dbl_mb(k_a_offset+length+addr) = size
      size = size + dfloat(int_mb(k_range+h2b-1)) * dfloat(int_mb(k_rang
     &e+p3b-1))
      END IF
      END IF
      END IF
      END DO
      END DO
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_4_6_2(d_a,k_a_offset,d_b,k_b_offse
     &t,d_c,k_c_offset)
C     i3 ( h2 p3 )_yx + = 1/4 * Sum ( h8 h7 p6 p5 ) * x ( p5 p6 h7 h8 )_x * y ( h2 h7 h8 p3 p5 p6 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h2b
      INTEGER p3b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p5b
      INTEGER p6b
      INTEGER h7b
      INTEGER h8b
      INTEGER p5b_1
      INTEGER p6b_1
      INTEGER h7b_1
      INTEGER h8b_1
      INTEGER h2b_2
      INTEGER h7b_2
      INTEGER h8b_2
      INTEGER p3b_2
      INTEGER p5b_2
      INTEGER p6b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(2)
      INTEGER isuperp
      INTEGER nsubh(2)
      INTEGER isubh
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h2b = 1,noab
      DO p3b = noab+1,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+p3b-1
     &).ne.4)) THEN
      IF (int_mb(k_spin+h2b-1) .eq. int_mb(k_spin+p3b-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),int_mb(k_sym+p3b-1)) .eq. ieor(irrep_
     &y,irrep_x)) THEN
      dimc = int_mb(k_range+h2b-1) * int_mb(k_range+p3b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_4_6_2',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p5b = noab+1,noab+nvab
      DO p6b = p5b,noab+nvab
      DO h7b = 1,noab
      DO h8b = h7b,noab
      IF (int_mb(k_active+h2b-1)+int_mb(k_active+h7b-1)+int_mb(k_active+
     &h8b-1) .ge. numact) THEN
      IF (int_mb(k_active+p3b-1)+int_mb(k_active+p5b-1)+int_mb(k_active+
     &p6b-1) .ge. numact) THEN
      IF (int_mb(k_spin+p5b-1)+int_mb(k_spin+p6b-1) .eq. int_mb(k_spin+h
     &7b-1)+int_mb(k_spin+h8b-1)) THEN
      IF (ieor(int_mb(k_sym+p5b-1),ieor(int_mb(k_sym+p6b-1),ieor(int_mb(
     &k_sym+h7b-1),int_mb(k_sym+h8b-1)))) .eq. irrep_x) THEN
      CALL TCE_RESTRICTED_4(p5b,p6b,h7b,h8b,p5b_1,p6b_1,h7b_1,h8b_1)
      CALL TCE_RESTRICTED_6(h2b,h7b,h8b,p3b,p5b,p6b,h2b_2,h7b_2,h8b_2,p3
     &b_2,p5b_2,p6b_2)
      dim_common = int_mb(k_range+p5b-1) * int_mb(k_range+p6b-1) * int_m
     &b(k_range+h7b-1) * int_mb(k_range+h8b-1)
      dima_sort = 1
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h2b-1) * int_mb(k_range+p3b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_4_6_2',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_4_6_2',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h8b_1
     & - 1 + noab * (h7b_1 - 1 + noab * (p6b_1 - noab - 1 + nvab * (p5b_
     &1 - noab - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h8b-1)
     &,4,3,2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_4_6
     &_2',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_4_6_2',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_4_6_2',5,MA_ERR)
      IF ((h8b .lt. h2b) .and. (p6b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p5b_2 - noab - 1 
     &+ nvab * (h2b_2 - 1 + noab * (h8b_2 - 1 + noab * (h7b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h2b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p6b-1),int_mb(k_range+p3b-1),6,3,2,1,5,4,1.0d0,.fa
     &lse.)
      END IF
      IF ((h8b .lt. h2b) .and. (p5b .lt. p3b) .and. (p3b .le. p6b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p5b_2 - noab - 1 
     &+ nvab * (h2b_2 - 1 + noab * (h8b_2 - 1 + noab * (h7b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h2b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p6b-1),5,3,2,1,6,4,-1.0d0,.f
     &alse.)
      END IF
      IF ((h8b .lt. h2b) .and. (p3b .le. p5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h2b_2 - 1 + noab * (h8b_2 - 1 + noab * (h7b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h2b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p5b-1),int_mb(k_range+p6b-1),4,3,2,1,6,5,1.0d0,.fa
     &lse.)
      END IF
      IF ((h7b .lt. h2b) .and. (h2b .le. h8b) .and. (p6b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p5b_2 - noab - 1 
     &+ nvab * (h8b_2 - 1 + noab * (h2b_2 - 1 + noab * (h7b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h8b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p6b-1),int_mb(k_range+p3b-1),6,2,3,1,5,4,-1.0d0,.f
     &alse.)
      END IF
      IF ((h7b .lt. h2b) .and. (h2b .le. h8b) .and. (p5b .lt. p3b) .and.
     & (p3b .le. p6b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p5b_2 - noab - 1 
     &+ nvab * (h8b_2 - 1 + noab * (h2b_2 - 1 + noab * (h7b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h8b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p6b-1),5,2,3,1,6,4,1.0d0,.fa
     &lse.)
      END IF
      IF ((h7b .lt. h2b) .and. (h2b .le. h8b) .and. (p3b .le. p5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h8b_2 - 1 + noab * (h2b_2 - 1 + noab * (h7b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h8b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p5b-1),int_mb(k_range+p6b-1),4,2,3,1,6,5,-1.0d0,.f
     &alse.)
      END IF
      IF ((h2b .le. h7b) .and. (p6b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p5b_2 - noab - 1 
     &+ nvab * (h8b_2 - 1 + noab * (h7b_2 - 1 + noab * (h2b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p6b-1),int_mb(k_range+p3b-1),6,1,3,2,5,4,1.0d0,.fa
     &lse.)
      END IF
      IF ((h2b .le. h7b) .and. (p5b .lt. p3b) .and. (p3b .le. p6b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p5b_2 - noab - 1 
     &+ nvab * (h8b_2 - 1 + noab * (h7b_2 - 1 + noab * (h2b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p6b-1),5,1,3,2,6,4,-1.0d0,.f
     &alse.)
      END IF
      IF ((h2b .le. h7b) .and. (p3b .le. p5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h8b_2 - 1 + noab * (h7b_2 - 1 + noab * (h2b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p5b-1),int_mb(k_range+p6b-1),4,1,3,2,6,5,1.0d0,.fa
     &lse.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_4_6
     &_2',6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      isuperp = 1
      IF (p5b .eq. p6b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      nsubh(1) = 1
      nsubh(2) = 1
      isubh = 1
      IF (h7b .eq. h8b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,4.0d0/FACTOR
     &IAL(nsuperp(1))/FACTORIAL(nsuperp(2))/FACTORIAL(nsubh(1))/FACTORIA
     &L(nsubh(2)),dbl_mb(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_commo
     &n,1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_4_6_2',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_4_6_2',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_4_6_2',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p3b-1)
     &,int_mb(k_range+h2b-1),2,1,1.0d0/4.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p3b -
     & noab - 1 + nvab * (h2b - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_4_6
     &_2',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_4_6_2',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_4_6_3(d_a,k_a_offset,d_b,k_b_offse
     &t,d_c,k_c_offset)
C     i3 ( h2 p3 )_yx + = 1/36 * Sum ( h10 h9 h8 p7 p6 p5 ) * x ( p5 p6 p7 h8 h9 h10 )_x * y ( h2 h8 h9 h10 p3 p5 p6 p7 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h2b
      INTEGER p3b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p5b
      INTEGER p6b
      INTEGER p7b
      INTEGER h8b
      INTEGER h9b
      INTEGER h10b
      INTEGER p5b_1
      INTEGER p6b_1
      INTEGER p7b_1
      INTEGER h8b_1
      INTEGER h9b_1
      INTEGER h10b_1
      INTEGER h2b_2
      INTEGER h8b_2
      INTEGER h9b_2
      INTEGER h10b_2
      INTEGER p3b_2
      INTEGER p5b_2
      INTEGER p6b_2
      INTEGER p7b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(3)
      INTEGER isuperp
      INTEGER nsubh(3)
      INTEGER isubh
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h2b = 1,noab
      DO p3b = noab+1,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+p3b-1
     &).ne.4)) THEN
      IF (int_mb(k_spin+h2b-1) .eq. int_mb(k_spin+p3b-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),int_mb(k_sym+p3b-1)) .eq. ieor(irrep_
     &y,irrep_x)) THEN
      dimc = int_mb(k_range+h2b-1) * int_mb(k_range+p3b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_4_6_3',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p5b = noab+1,noab+nvab
      DO p6b = p5b,noab+nvab
      DO p7b = p6b,noab+nvab
      DO h8b = 1,noab
      DO h9b = h8b,noab
      DO h10b = h9b,noab
      IF (int_mb(k_active+p5b-1)+int_mb(k_active+p6b-1)+int_mb(k_active+
     &p7b-1) .ge. numact) THEN
      IF (int_mb(k_active+h8b-1)+int_mb(k_active+h9b-1)+int_mb(k_active+
     &h10b-1) .ge. numact) THEN
      IF (int_mb(k_active+h2b-1)+int_mb(k_active+h8b-1)+int_mb(k_active+
     &h9b-1)+int_mb(k_active+h10b-1) .ge. numacq) THEN
      IF (int_mb(k_active+p3b-1)+int_mb(k_active+p5b-1)+int_mb(k_active+
     &p6b-1)+int_mb(k_active+p7b-1) .ge. numacq) THEN
      IF (int_mb(k_spin+p5b-1)+int_mb(k_spin+p6b-1)+int_mb(k_spin+p7b-1)
     & .eq. int_mb(k_spin+h8b-1)+int_mb(k_spin+h9b-1)+int_mb(k_spin+h10b
     &-1)) THEN
      IF (ieor(int_mb(k_sym+p5b-1),ieor(int_mb(k_sym+p6b-1),ieor(int_mb(
     &k_sym+p7b-1),ieor(int_mb(k_sym+h8b-1),ieor(int_mb(k_sym+h9b-1),int
     &_mb(k_sym+h10b-1)))))) .eq. irrep_x) THEN
      CALL TCE_RESTRICTED_6(p5b,p6b,p7b,h8b,h9b,h10b,p5b_1,p6b_1,p7b_1,h
     &8b_1,h9b_1,h10b_1)
      CALL TCE_RESTRICTED_8(h2b,h8b,h9b,h10b,p3b,p5b,p6b,p7b,h2b_2,h8b_2
     &,h9b_2,h10b_2,p3b_2,p5b_2,p6b_2,p7b_2)
      dim_common = int_mb(k_range+p5b-1) * int_mb(k_range+p6b-1) * int_m
     &b(k_range+p7b-1) * int_mb(k_range+h8b-1) * int_mb(k_range+h9b-1) *
     & int_mb(k_range+h10b-1)
      dima_sort = 1
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h2b-1) * int_mb(k_range+p3b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_4_6_3',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_4_6_3',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h10b_
     &1 - 1 + noab * (h9b_1 - 1 + noab * (h8b_1 - 1 + noab * (p7b_1 - no
     &ab - 1 + nvab * (p6b_1 - noab - 1 + nvab * (p5b_1 - noab - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p6b-1),int_mb(k_range+p7b-1),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h10b-1),6,5,4,3,2,1,1.0d0,.f
     &alse.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_4_6
     &_3',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_4_6_3',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_4_6_3',5,MA_ERR)
      IF ((h10b .lt. h2b) .and. (p7b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p6b_2 - noab - 1 
     &+ nvab * (p5b_2 - noab - 1 + nvab * (h2b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h9b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h10b-1),int_mb(k_range+h2b-1
     &),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1),int_mb(k_range+p7b-1
     &),int_mb(k_range+p3b-1),8,4,3,2,1,7,6,5,1.0d0,.false.)
      END IF
      IF ((h10b .lt. h2b) .and. (p6b .lt. p3b) .and. (p3b .le. p7b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p6b_2 - noab - 1 
     &+ nvab * (p5b_2 - noab - 1 + nvab * (h2b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h9b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h10b-1),int_mb(k_range+h2b-1
     &),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1),int_mb(k_range+p3b-1
     &),int_mb(k_range+p7b-1),7,4,3,2,1,8,6,5,-1.0d0,.false.)
      END IF
      IF ((h10b .lt. h2b) .and. (p5b .lt. p3b) .and. (p3b .le. p6b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p5b_2 - noab - 1 + nvab * (h2b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h9b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h10b-1),int_mb(k_range+h2b-1
     &),int_mb(k_range+p5b-1),int_mb(k_range+p3b-1),int_mb(k_range+p6b-1
     &),int_mb(k_range+p7b-1),6,4,3,2,1,8,7,5,1.0d0,.false.)
      END IF
      IF ((h10b .lt. h2b) .and. (p3b .le. p5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p5b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h2b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h9b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h10b-1),int_mb(k_range+h2b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1
     &),int_mb(k_range+p7b-1),5,4,3,2,1,8,7,6,-1.0d0,.false.)
      END IF
      IF ((h9b .lt. h2b) .and. (h2b .le. h10b) .and. (p7b .lt. p3b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p6b_2 - noab - 1 
     &+ nvab * (p5b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h2b_2 - 
     &1 + noab * (h9b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h2b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1),int_mb(k_range+p7b-1
     &),int_mb(k_range+p3b-1),8,3,4,2,1,7,6,5,-1.0d0,.false.)
      END IF
      IF ((h9b .lt. h2b) .and. (h2b .le. h10b) .and. (p6b .lt. p3b) .and
     &. (p3b .le. p7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p6b_2 - noab - 1 
     &+ nvab * (p5b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h2b_2 - 
     &1 + noab * (h9b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h2b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1),int_mb(k_range+p3b-1
     &),int_mb(k_range+p7b-1),7,3,4,2,1,8,6,5,1.0d0,.false.)
      END IF
      IF ((h9b .lt. h2b) .and. (h2b .le. h10b) .and. (p5b .lt. p3b) .and
     &. (p3b .le. p6b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p5b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h2b_2 - 
     &1 + noab * (h9b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h2b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p5b-1),int_mb(k_range+p3b-1),int_mb(k_range+p6b-1
     &),int_mb(k_range+p7b-1),6,3,4,2,1,8,7,5,-1.0d0,.false.)
      END IF
      IF ((h9b .lt. h2b) .and. (h2b .le. h10b) .and. (p3b .le. p5b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p5b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h2b_2 - 
     &1 + noab * (h9b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h2b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1
     &),int_mb(k_range+p7b-1),5,3,4,2,1,8,7,6,1.0d0,.false.)
      END IF
      IF ((h8b .lt. h2b) .and. (h2b .le. h9b) .and. (p7b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p6b_2 - noab - 1 
     &+ nvab * (p5b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h9b_2 - 
     &1 + noab * (h2b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h9b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1),int_mb(k_range+p7b-1
     &),int_mb(k_range+p3b-1),8,2,4,3,1,7,6,5,1.0d0,.false.)
      END IF
      IF ((h8b .lt. h2b) .and. (h2b .le. h9b) .and. (p6b .lt. p3b) .and.
     & (p3b .le. p7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p6b_2 - noab - 1 
     &+ nvab * (p5b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h9b_2 - 
     &1 + noab * (h2b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h9b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1),int_mb(k_range+p3b-1
     &),int_mb(k_range+p7b-1),7,2,4,3,1,8,6,5,-1.0d0,.false.)
      END IF
      IF ((h8b .lt. h2b) .and. (h2b .le. h9b) .and. (p5b .lt. p3b) .and.
     & (p3b .le. p6b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p5b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h9b_2 - 
     &1 + noab * (h2b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h9b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p5b-1),int_mb(k_range+p3b-1),int_mb(k_range+p6b-1
     &),int_mb(k_range+p7b-1),6,2,4,3,1,8,7,5,1.0d0,.false.)
      END IF
      IF ((h8b .lt. h2b) .and. (h2b .le. h9b) .and. (p3b .le. p5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p5b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h9b_2 - 
     &1 + noab * (h2b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h9b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1
     &),int_mb(k_range+p7b-1),5,2,4,3,1,8,7,6,-1.0d0,.false.)
      END IF
      IF ((h2b .le. h8b) .and. (p7b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p6b_2 - noab - 1 
     &+ nvab * (p5b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h9b_2 - 
     &1 + noab * (h8b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h9b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1),int_mb(k_range+p7b-1
     &),int_mb(k_range+p3b-1),8,1,4,3,2,7,6,5,-1.0d0,.false.)
      END IF
      IF ((h2b .le. h8b) .and. (p6b .lt. p3b) .and. (p3b .le. p7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p6b_2 - noab - 1 
     &+ nvab * (p5b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h9b_2 - 
     &1 + noab * (h8b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h9b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1),int_mb(k_range+p3b-1
     &),int_mb(k_range+p7b-1),7,1,4,3,2,8,6,5,1.0d0,.false.)
      END IF
      IF ((h2b .le. h8b) .and. (p5b .lt. p3b) .and. (p3b .le. p6b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p5b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h9b_2 - 
     &1 + noab * (h8b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h9b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p5b-1),int_mb(k_range+p3b-1),int_mb(k_range+p6b-1
     &),int_mb(k_range+p7b-1),6,1,4,3,2,8,7,5,-1.0d0,.false.)
      END IF
      IF ((h2b .le. h8b) .and. (p3b .le. p5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p5b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h9b_2 - 
     &1 + noab * (h8b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h9b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1
     &),int_mb(k_range+p7b-1),5,1,4,3,2,8,7,6,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_4_6
     &_3',6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      nsuperp(3) = 1
      isuperp = 1
      IF (p5b .eq. p6b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      IF (p6b .eq. p7b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      nsubh(1) = 1
      nsubh(2) = 1
      nsubh(3) = 1
      isubh = 1
      IF (h8b .eq. h9b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      IF (h9b .eq. h10b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,36.0d0/FACTO
     &RIAL(nsuperp(1))/FACTORIAL(nsuperp(2))/FACTORIAL(nsuperp(3))/FACTO
     &RIAL(nsubh(1))/FACTORIAL(nsubh(2))/FACTORIAL(nsubh(3)),dbl_mb(k_a_
     &sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c_sort
     &),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_4_6_3',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_4_6_3',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_4_6_3',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p3b-1)
     &,int_mb(k_range+h2b-1),2,1,1.0d0/36.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p3b -
     & noab - 1 + nvab * (h2b - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_4_6
     &_3',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_4_6_3',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_4_7(d_a,k_a_offset,d_b,k_b_offset,
     &d_c,k_c_offset)
C     i2 ( h2 h11 )_yxt + = 1/2 * Sum ( h5 p3 p4 ) * t ( p3 p4 h5 h11 )_t * i3 ( h2 h5 p3 p4 )_yx
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h2b
      INTEGER h11b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p3b
      INTEGER p4b
      INTEGER h5b
      INTEGER p3b_1
      INTEGER p4b_1
      INTEGER h11b_1
      INTEGER h5b_1
      INTEGER h2b_2
      INTEGER h5b_2
      INTEGER p3b_2
      INTEGER p4b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(2)
      INTEGER isuperp
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h2b = 1,noab
      DO h11b = 1,noab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+h11b-
     &1).ne.4)) THEN
      IF (int_mb(k_spin+h2b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),int_mb(k_sym+h11b-1)) .eq. ieor(irrep
     &_y,ieor(irrep_x,irrep_t))) THEN
      dimc = int_mb(k_range+h2b-1) * int_mb(k_range+h11b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_4_7',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      DO h5b = 1,noab
      IF (int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1) .eq. int_mb(k_spin+h
     &11b-1)+int_mb(k_spin+h5b-1)) THEN
      IF (ieor(int_mb(k_sym+p3b-1),ieor(int_mb(k_sym+p4b-1),ieor(int_mb(
     &k_sym+h11b-1),int_mb(k_sym+h5b-1)))) .eq. irrep_t) THEN
      CALL TCE_RESTRICTED_4(p3b,p4b,h11b,h5b,p3b_1,p4b_1,h11b_1,h5b_1)
      CALL TCE_RESTRICTED_4(h2b,h5b,p3b,p4b,h2b_2,h5b_2,p3b_2,p4b_2)
      dim_common = int_mb(k_range+p3b-1) * int_mb(k_range+p4b-1) * int_m
     &b(k_range+h5b-1)
      dima_sort = int_mb(k_range+h11b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h2b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_4_7',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_4_7',2,MA_ERR)
      IF ((h5b .le. h11b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h11b_
     &1 - 1 + noab * (h5b_1 - 1 + noab * (p4b_1 - noab - 1 + nvab * (p3b
     &_1 - noab - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+h5b-1),int_mb(k_range+h11b-1
     &),4,3,2,1,1.0d0,.false.)
      END IF
      IF ((h11b .lt. h5b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h5b_1
     & - 1 + noab * (h11b_1 - 1 + noab * (p4b_1 - noab - 1 + nvab * (p3b
     &_1 - noab - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+h11b-1),int_mb(k_range+h5b-1
     &),3,4,2,1,-1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_4_7
     &',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_4_7',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_4_7',5,MA_ERR)
      IF ((h5b .lt. h2b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (h2b_2 - 1 + noab 
     &* (h5b_2 - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1)
     &,2,1,4,3,-1.0d0,.false.)
      END IF
      IF ((h2b .le. h5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab 
     &* (h2b_2 - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1)
     &,1,2,4,3,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_4_7
     &',6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      isuperp = 1
      IF (p3b .eq. p4b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,2.0d0/FACTOR
     &IAL(nsuperp(1))/FACTORIAL(nsuperp(2)),dbl_mb(k_a_sort),dim_common,
     &dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_4_7',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_4_7',8,MA_ERR)
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_4_7',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h11b-1),1,2,1.0d0/2.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(h11b 
     &- 1 + noab * (h2b - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_4_7
     &',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_4_7',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_4_7_1(d_a,k_a_offset,d_b,k_b_offse
     &t,d_c,k_c_offset)
C     i3 ( h2 h5 p3 p4 )_yx + = -1 * Sum ( h8 p7 ) * x ( p7 h8 )_x * y ( h2 h5 h8 p3 p4 p7 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h2b
      INTEGER h5b
      INTEGER p3b
      INTEGER p4b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p7b
      INTEGER h8b
      INTEGER p7b_1
      INTEGER h8b_1
      INTEGER h2b_2
      INTEGER h5b_2
      INTEGER h8b_2
      INTEGER p3b_2
      INTEGER p4b_2
      INTEGER p7b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h2b = 1,noab
      DO h5b = h2b,noab
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+h5b-1
     &)+int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1).ne.8)) THEN
      IF (int_mb(k_spin+h2b-1)+int_mb(k_spin+h5b-1) .eq. int_mb(k_spin+p
     &3b-1)+int_mb(k_spin+p4b-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),ieor(int_mb(k_sym+h5b-1),ieor(int_mb(
     &k_sym+p3b-1),int_mb(k_sym+p4b-1)))) .eq. ieor(irrep_y,irrep_x)) TH
     &EN
      dimc = int_mb(k_range+h2b-1) * int_mb(k_range+h5b-1) * int_mb(k_ra
     &nge+p3b-1) * int_mb(k_range+p4b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_4_7_1',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p7b = noab+1,noab+nvab
      DO h8b = 1,noab
      IF (int_mb(k_active+h2b-1)+int_mb(k_active+h5b-1)+int_mb(k_active+
     &h8b-1) .ge. numact) THEN
      IF (int_mb(k_active+p3b-1)+int_mb(k_active+p4b-1)+int_mb(k_active+
     &p7b-1) .ge. numact) THEN
      IF (int_mb(k_spin+p7b-1) .eq. int_mb(k_spin+h8b-1)) THEN
      IF (ieor(int_mb(k_sym+p7b-1),int_mb(k_sym+h8b-1)) .eq. irrep_x) TH
     &EN
      CALL TCE_RESTRICTED_2(p7b,h8b,p7b_1,h8b_1)
      CALL TCE_RESTRICTED_6(h2b,h5b,h8b,p3b,p4b,p7b,h2b_2,h5b_2,h8b_2,p3
     &b_2,p4b_2,p7b_2)
      dim_common = int_mb(k_range+p7b-1) * int_mb(k_range+h8b-1)
      dima_sort = 1
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h2b-1) * int_mb(k_range+h5b-1) * int_mb
     &(k_range+p3b-1) * int_mb(k_range+p4b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_4_7_1',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_4_7_1',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h8b_1
     & - 1 + noab * (p7b_1 - noab - 1)))
      CALL TCE_SORT_2(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p7b-1)
     &,int_mb(k_range+h8b-1),2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_4_7
     &_1',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_4_7_1',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_4_7_1',5,MA_ERR)
      IF ((h8b .lt. h2b) .and. (p7b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p7b_2 - noab - 1 
     &+ nvab * (h5b_2 - 1 + noab * (h2b_2 - 1 + noab * (h8b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h5b-1),int_mb(k_range+p7b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),6,5,3,2,1,4,1.0d0,.fa
     &lse.)
      END IF
      IF ((h8b .lt. h2b) .and. (p3b .le. p7b) .and. (p7b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h5b_2 - 1 + noab * (h2b_2 - 1 + noab * (h8b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h5b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p7b-1),int_mb(k_range+p4b-1),6,4,3,2,1,5,-1.0d0,.f
     &alse.)
      END IF
      IF ((h8b .lt. h2b) .and. (p4b .le. p7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h5b_2 - 1 + noab * (h2b_2 - 1 + noab * (h8b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h5b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p7b-1),5,4,3,2,1,6,1.0d0,.fa
     &lse.)
      END IF
      IF ((h2b .le. h8b) .and. (h8b .lt. h5b) .and. (p7b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p7b_2 - noab - 1 
     &+ nvab * (h5b_2 - 1 + noab * (h8b_2 - 1 + noab * (h2b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h5b-1),int_mb(k_range+p7b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),6,5,3,1,2,4,-1.0d0,.f
     &alse.)
      END IF
      IF ((h2b .le. h8b) .and. (h8b .lt. h5b) .and. (p3b .le. p7b) .and.
     & (p7b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h5b_2 - 1 + noab * (h8b_2 - 1 + noab * (h2b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h5b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p7b-1),int_mb(k_range+p4b-1),6,4,3,1,2,5,1.0d0,.fa
     &lse.)
      END IF
      IF ((h2b .le. h8b) .and. (h8b .lt. h5b) .and. (p4b .le. p7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h5b_2 - 1 + noab * (h8b_2 - 1 + noab * (h2b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h5b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p7b-1),5,4,3,1,2,6,-1.0d0,.f
     &alse.)
      END IF
      IF ((h5b .le. h8b) .and. (p7b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p7b_2 - noab - 1 
     &+ nvab * (h8b_2 - 1 + noab * (h5b_2 - 1 + noab * (h2b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h8b-1),int_mb(k_range+p7b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),6,5,2,1,3,4,1.0d0,.fa
     &lse.)
      END IF
      IF ((h5b .le. h8b) .and. (p3b .le. p7b) .and. (p7b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h8b_2 - 1 + noab * (h5b_2 - 1 + noab * (h2b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h8b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p7b-1),int_mb(k_range+p4b-1),6,4,2,1,3,5,-1.0d0,.f
     &alse.)
      END IF
      IF ((h5b .le. h8b) .and. (p4b .le. p7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h8b_2 - 1 + noab * (h5b_2 - 1 + noab * (h2b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h8b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p7b-1),5,4,2,1,3,6,1.0d0,.fa
     &lse.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_4_7
     &_1',6,MA_ERR)
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,1.0d0,dbl_mb
     &(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c
     &_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_4_7_1',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_4_7_1',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_4_7_1',9,MA_ERR)
      CALL TCE_SORT_4(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+h5b-1),int_mb(k_range+h2b-1)
     &,4,3,2,1,-1.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p4b -
     & noab - 1 + nvab * (p3b - noab - 1 + nvab * (h5b - 1 + noab * (h2b
     & - 1)))))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_4_7
     &_1',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_4_7_1',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE OFFSET_eomccsdtq_density1_5_4_7_1(l_a_offset,k_a_offset
     &,size)
C     i3 ( h2 h5 p3 p4 )_yx
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER l_a_offset
      INTEGER k_a_offset
      INTEGER length
      INTEGER addr
      INTEGER h2b
      INTEGER h5b
      INTEGER p3b
      INTEGER p4b
      DOUBLE PRECISION size
      length = 0
      DO h2b = 1,noab
      DO h5b = h2b,noab
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      IF (int_mb(k_spin+h2b-1)+int_mb(k_spin+h5b-1) .eq. int_mb(k_spin+p
     &3b-1)+int_mb(k_spin+p4b-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),ieor(int_mb(k_sym+h5b-1),ieor(int_mb(
     &k_sym+p3b-1),int_mb(k_sym+p4b-1)))) .eq. ieor(irrep_y,irrep_x)) TH
     &EN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+h5b-1
     &)+int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1).ne.8)) THEN
      length = length + 1
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,2*length+1,'noname',l_a_offset,k_a_off
     &set)) CALL ERRQUIT('eomccsdtq_density1_5_4_7_1',0,MA_ERR)
      dbl_mb(k_a_offset) = dfloat(length)
      addr = 0
      size = 0.0d0
      DO h2b = 1,noab
      DO h5b = h2b,noab
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      IF (int_mb(k_spin+h2b-1)+int_mb(k_spin+h5b-1) .eq. int_mb(k_spin+p
     &3b-1)+int_mb(k_spin+p4b-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),ieor(int_mb(k_sym+h5b-1),ieor(int_mb(
     &k_sym+p3b-1),int_mb(k_sym+p4b-1)))) .eq. ieor(irrep_y,irrep_x)) TH
     &EN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+h5b-1
     &)+int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1).ne.8)) THEN
      addr = addr + 1
      dbl_mb(k_a_offset+addr) = dfloat(p4b - noab - 1 + nvab * (p3b - no
     &ab - 1 + nvab * (h5b - 1 + noab * (h2b - 1))))
      dbl_mb(k_a_offset+length+addr) = size
      size = size + dfloat(int_mb(k_range+h2b-1)) * dfloat(int_mb(k_rang
     &e+h5b-1)) * dfloat(int_mb(k_range+p3b-1)) * dfloat(int_mb(k_range+
     &p4b-1))
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_4_7_2(d_a,k_a_offset,d_b,k_b_offse
     &t,d_c,k_c_offset)
C     i3 ( h2 h5 p3 p4 )_yx + = -1/4 * Sum ( h10 h9 p8 p7 ) * x ( p7 p8 h9 h10 )_x * y ( h2 h5 h9 h10 p3 p4 p7 p8 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h2b
      INTEGER h5b
      INTEGER p3b
      INTEGER p4b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p7b
      INTEGER p8b
      INTEGER h9b
      INTEGER h10b
      INTEGER p7b_1
      INTEGER p8b_1
      INTEGER h9b_1
      INTEGER h10b_1
      INTEGER h2b_2
      INTEGER h5b_2
      INTEGER h9b_2
      INTEGER h10b_2
      INTEGER p3b_2
      INTEGER p4b_2
      INTEGER p7b_2
      INTEGER p8b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(2)
      INTEGER isuperp
      INTEGER nsubh(2)
      INTEGER isubh
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h2b = 1,noab
      DO h5b = h2b,noab
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+h5b-1
     &)+int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1).ne.8)) THEN
      IF (int_mb(k_spin+h2b-1)+int_mb(k_spin+h5b-1) .eq. int_mb(k_spin+p
     &3b-1)+int_mb(k_spin+p4b-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),ieor(int_mb(k_sym+h5b-1),ieor(int_mb(
     &k_sym+p3b-1),int_mb(k_sym+p4b-1)))) .eq. ieor(irrep_y,irrep_x)) TH
     &EN
      dimc = int_mb(k_range+h2b-1) * int_mb(k_range+h5b-1) * int_mb(k_ra
     &nge+p3b-1) * int_mb(k_range+p4b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_4_7_2',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p7b = noab+1,noab+nvab
      DO p8b = p7b,noab+nvab
      DO h9b = 1,noab
      DO h10b = h9b,noab
      IF (int_mb(k_active+h2b-1)+int_mb(k_active+h5b-1)+int_mb(k_active+
     &h9b-1)+int_mb(k_active+h10b-1) .ge. numacq) THEN
      IF (int_mb(k_active+p3b-1)+int_mb(k_active+p4b-1)+int_mb(k_active+
     &p7b-1)+int_mb(k_active+p8b-1) .ge. numacq) THEN
      IF (int_mb(k_spin+p7b-1)+int_mb(k_spin+p8b-1) .eq. int_mb(k_spin+h
     &9b-1)+int_mb(k_spin+h10b-1)) THEN
      IF (ieor(int_mb(k_sym+p7b-1),ieor(int_mb(k_sym+p8b-1),ieor(int_mb(
     &k_sym+h9b-1),int_mb(k_sym+h10b-1)))) .eq. irrep_x) THEN
      CALL TCE_RESTRICTED_4(p7b,p8b,h9b,h10b,p7b_1,p8b_1,h9b_1,h10b_1)
      CALL TCE_RESTRICTED_8(h2b,h5b,h9b,h10b,p3b,p4b,p7b,p8b,h2b_2,h5b_2
     &,h9b_2,h10b_2,p3b_2,p4b_2,p7b_2,p8b_2)
      dim_common = int_mb(k_range+p7b-1) * int_mb(k_range+p8b-1) * int_m
     &b(k_range+h9b-1) * int_mb(k_range+h10b-1)
      dima_sort = 1
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h2b-1) * int_mb(k_range+h5b-1) * int_mb
     &(k_range+p3b-1) * int_mb(k_range+p4b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_4_7_2',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_4_7_2',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h10b_
     &1 - 1 + noab * (h9b_1 - 1 + noab * (p8b_1 - noab - 1 + nvab * (p7b
     &_1 - noab - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p7b-1)
     &,int_mb(k_range+p8b-1),int_mb(k_range+h9b-1),int_mb(k_range+h10b-1
     &),4,3,2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_4_7
     &_2',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_4_7_2',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_4_7_2',5,MA_ERR)
      IF ((h10b .lt. h2b) .and. (p8b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p8b_2 - noab - 1 
     &+ nvab * (p7b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h2b_2 - 1
     & + noab * (h10b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h10b-1),int_mb(k_range+h2b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+p7b-1),int_mb(k_range+p8b-1),int_mb(k_range+p3b-1
     &),int_mb(k_range+p4b-1),8,7,4,3,2,1,6,5,1.0d0,.false.)
      END IF
      IF ((h10b .lt. h2b) .and. (p7b .lt. p3b) .and. (p3b .le. p8b) .and
     &. (p8b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p7b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h2b_2 - 1
     & + noab * (h10b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h10b-1),int_mb(k_range+h2b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+p7b-1),int_mb(k_range+p3b-1),int_mb(k_range+p8b-1
     &),int_mb(k_range+p4b-1),8,6,4,3,2,1,7,5,-1.0d0,.false.)
      END IF
      IF ((h10b .lt. h2b) .and. (p7b .lt. p3b) .and. (p4b .le. p8b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p7b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h2b_2 - 1
     & + noab * (h10b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h10b-1),int_mb(k_range+h2b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+p7b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p8b-1),7,6,4,3,2,1,8,5,1.0d0,.false.)
      END IF
      IF ((h10b .lt. h2b) .and. (p3b .le. p7b) .and. (p8b .lt. p4b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p7b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h2b_2 - 1
     & + noab * (h10b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h10b-1),int_mb(k_range+h2b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p7b-1),int_mb(k_range+p8b-1
     &),int_mb(k_range+p4b-1),8,5,4,3,2,1,7,6,1.0d0,.false.)
      END IF
      IF ((h10b .lt. h2b) .and. (p3b .le. p7b) .and. (p7b .lt. p4b) .and
     &. (p4b .le. p8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p7b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h2b_2 - 1
     & + noab * (h10b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h10b-1),int_mb(k_range+h2b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p7b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p8b-1),7,5,4,3,2,1,8,6,-1.0d0,.false.)
      END IF
      IF ((h10b .lt. h2b) .and. (p4b .le. p7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h2b_2 - 1
     & + noab * (h10b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h10b-1),int_mb(k_range+h2b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p7b-1
     &),int_mb(k_range+p8b-1),6,5,4,3,2,1,8,7,1.0d0,.false.)
      END IF
      IF ((h9b .lt. h2b) .and. (h2b .le. h10b) .and. (h10b .lt. h5b) .an
     &d. (p8b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p8b_2 - noab - 1 
     &+ nvab * (p7b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h2b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h10b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+p7b-1),int_mb(k_range+p8b-1),int_mb(k_range+p3b-1
     &),int_mb(k_range+p4b-1),8,7,4,2,3,1,6,5,-1.0d0,.false.)
      END IF
      IF ((h9b .lt. h2b) .and. (h2b .le. h10b) .and. (h10b .lt. h5b) .an
     &d. (p7b .lt. p3b) .and. (p3b .le. p8b) .and. (p8b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p7b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h2b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h10b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+p7b-1),int_mb(k_range+p3b-1),int_mb(k_range+p8b-1
     &),int_mb(k_range+p4b-1),8,6,4,2,3,1,7,5,1.0d0,.false.)
      END IF
      IF ((h9b .lt. h2b) .and. (h2b .le. h10b) .and. (h10b .lt. h5b) .an
     &d. (p7b .lt. p3b) .and. (p4b .le. p8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p7b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h2b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h10b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+p7b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p8b-1),7,6,4,2,3,1,8,5,-1.0d0,.false.)
      END IF
      IF ((h9b .lt. h2b) .and. (h2b .le. h10b) .and. (h10b .lt. h5b) .an
     &d. (p3b .le. p7b) .and. (p8b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p7b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h2b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h10b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p7b-1),int_mb(k_range+p8b-1
     &),int_mb(k_range+p4b-1),8,5,4,2,3,1,7,6,-1.0d0,.false.)
      END IF
      IF ((h9b .lt. h2b) .and. (h2b .le. h10b) .and. (h10b .lt. h5b) .an
     &d. (p3b .le. p7b) .and. (p7b .lt. p4b) .and. (p4b .le. p8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p7b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h2b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h10b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p7b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p8b-1),7,5,4,2,3,1,8,6,1.0d0,.false.)
      END IF
      IF ((h9b .lt. h2b) .and. (h2b .le. h10b) .and. (h10b .lt. h5b) .an
     &d. (p4b .le. p7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h2b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h10b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p7b-1
     &),int_mb(k_range+p8b-1),6,5,4,2,3,1,8,7,-1.0d0,.false.)
      END IF
      IF ((h9b .lt. h2b) .and. (h5b .le. h10b) .and. (p8b .lt. p3b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p8b_2 - noab - 1 
     &+ nvab * (p7b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h5b_2 - 
     &1 + noab * (h2b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h5b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p7b-1),int_mb(k_range+p8b-1),int_mb(k_range+p3b-1
     &),int_mb(k_range+p4b-1),8,7,3,2,4,1,6,5,1.0d0,.false.)
      END IF
      IF ((h9b .lt. h2b) .and. (h5b .le. h10b) .and. (p7b .lt. p3b) .and
     &. (p3b .le. p8b) .and. (p8b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p7b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h5b_2 - 
     &1 + noab * (h2b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h5b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p7b-1),int_mb(k_range+p3b-1),int_mb(k_range+p8b-1
     &),int_mb(k_range+p4b-1),8,6,3,2,4,1,7,5,-1.0d0,.false.)
      END IF
      IF ((h9b .lt. h2b) .and. (h5b .le. h10b) .and. (p7b .lt. p3b) .and
     &. (p4b .le. p8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p7b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h5b_2 - 
     &1 + noab * (h2b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h5b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p7b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p8b-1),7,6,3,2,4,1,8,5,1.0d0,.false.)
      END IF
      IF ((h9b .lt. h2b) .and. (h5b .le. h10b) .and. (p3b .le. p7b) .and
     &. (p8b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p7b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h5b_2 - 
     &1 + noab * (h2b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h5b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p7b-1),int_mb(k_range+p8b-1
     &),int_mb(k_range+p4b-1),8,5,3,2,4,1,7,6,1.0d0,.false.)
      END IF
      IF ((h9b .lt. h2b) .and. (h5b .le. h10b) .and. (p3b .le. p7b) .and
     &. (p7b .lt. p4b) .and. (p4b .le. p8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p7b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h5b_2 - 
     &1 + noab * (h2b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h5b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p7b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p8b-1),7,5,3,2,4,1,8,6,-1.0d0,.false.)
      END IF
      IF ((h9b .lt. h2b) .and. (h5b .le. h10b) .and. (p4b .le. p7b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h5b_2 - 
     &1 + noab * (h2b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h5b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p7b-1
     &),int_mb(k_range+p8b-1),6,5,3,2,4,1,8,7,1.0d0,.false.)
      END IF
      IF ((h2b .le. h9b) .and. (h10b .lt. h5b) .and. (p8b .lt. p3b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p8b_2 - noab - 1 
     &+ nvab * (p7b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h9b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h10b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+p7b-1),int_mb(k_range+p8b-1),int_mb(k_range+p3b-1
     &),int_mb(k_range+p4b-1),8,7,4,1,3,2,6,5,1.0d0,.false.)
      END IF
      IF ((h2b .le. h9b) .and. (h10b .lt. h5b) .and. (p7b .lt. p3b) .and
     &. (p3b .le. p8b) .and. (p8b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p7b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h9b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h10b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+p7b-1),int_mb(k_range+p3b-1),int_mb(k_range+p8b-1
     &),int_mb(k_range+p4b-1),8,6,4,1,3,2,7,5,-1.0d0,.false.)
      END IF
      IF ((h2b .le. h9b) .and. (h10b .lt. h5b) .and. (p7b .lt. p3b) .and
     &. (p4b .le. p8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p7b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h9b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h10b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+p7b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p8b-1),7,6,4,1,3,2,8,5,1.0d0,.false.)
      END IF
      IF ((h2b .le. h9b) .and. (h10b .lt. h5b) .and. (p3b .le. p7b) .and
     &. (p8b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p7b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h9b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h10b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p7b-1),int_mb(k_range+p8b-1
     &),int_mb(k_range+p4b-1),8,5,4,1,3,2,7,6,1.0d0,.false.)
      END IF
      IF ((h2b .le. h9b) .and. (h10b .lt. h5b) .and. (p3b .le. p7b) .and
     &. (p7b .lt. p4b) .and. (p4b .le. p8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p7b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h9b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h10b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p7b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p8b-1),7,5,4,1,3,2,8,6,-1.0d0,.false.)
      END IF
      IF ((h2b .le. h9b) .and. (h10b .lt. h5b) .and. (p4b .le. p7b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h9b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h10b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p7b-1
     &),int_mb(k_range+p8b-1),6,5,4,1,3,2,8,7,1.0d0,.false.)
      END IF
      IF ((h2b .le. h9b) .and. (h9b .lt. h5b) .and. (h5b .le. h10b) .and
     &. (p8b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p8b_2 - noab - 1 
     &+ nvab * (p7b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h5b_2 - 
     &1 + noab * (h9b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h5b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p7b-1),int_mb(k_range+p8b-1),int_mb(k_range+p3b-1
     &),int_mb(k_range+p4b-1),8,7,3,1,4,2,6,5,-1.0d0,.false.)
      END IF
      IF ((h2b .le. h9b) .and. (h9b .lt. h5b) .and. (h5b .le. h10b) .and
     &. (p7b .lt. p3b) .and. (p3b .le. p8b) .and. (p8b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p7b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h5b_2 - 
     &1 + noab * (h9b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h5b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p7b-1),int_mb(k_range+p3b-1),int_mb(k_range+p8b-1
     &),int_mb(k_range+p4b-1),8,6,3,1,4,2,7,5,1.0d0,.false.)
      END IF
      IF ((h2b .le. h9b) .and. (h9b .lt. h5b) .and. (h5b .le. h10b) .and
     &. (p7b .lt. p3b) .and. (p4b .le. p8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p7b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h5b_2 - 
     &1 + noab * (h9b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h5b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p7b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p8b-1),7,6,3,1,4,2,8,5,-1.0d0,.false.)
      END IF
      IF ((h2b .le. h9b) .and. (h9b .lt. h5b) .and. (h5b .le. h10b) .and
     &. (p3b .le. p7b) .and. (p8b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p7b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h5b_2 - 
     &1 + noab * (h9b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h5b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p7b-1),int_mb(k_range+p8b-1
     &),int_mb(k_range+p4b-1),8,5,3,1,4,2,7,6,-1.0d0,.false.)
      END IF
      IF ((h2b .le. h9b) .and. (h9b .lt. h5b) .and. (h5b .le. h10b) .and
     &. (p3b .le. p7b) .and. (p7b .lt. p4b) .and. (p4b .le. p8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p7b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h5b_2 - 
     &1 + noab * (h9b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h5b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p7b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p8b-1),7,5,3,1,4,2,8,6,1.0d0,.false.)
      END IF
      IF ((h2b .le. h9b) .and. (h9b .lt. h5b) .and. (h5b .le. h10b) .and
     &. (p4b .le. p7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h5b_2 - 
     &1 + noab * (h9b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h5b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p7b-1
     &),int_mb(k_range+p8b-1),6,5,3,1,4,2,8,7,-1.0d0,.false.)
      END IF
      IF ((h5b .le. h9b) .and. (p8b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p8b_2 - noab - 1 
     &+ nvab * (p7b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h9b_2 - 
     &1 + noab * (h5b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h9b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p7b-1),int_mb(k_range+p8b-1),int_mb(k_range+p3b-1
     &),int_mb(k_range+p4b-1),8,7,2,1,4,3,6,5,1.0d0,.false.)
      END IF
      IF ((h5b .le. h9b) .and. (p7b .lt. p3b) .and. (p3b .le. p8b) .and.
     & (p8b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p7b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h9b_2 - 
     &1 + noab * (h5b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h9b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p7b-1),int_mb(k_range+p3b-1),int_mb(k_range+p8b-1
     &),int_mb(k_range+p4b-1),8,6,2,1,4,3,7,5,-1.0d0,.false.)
      END IF
      IF ((h5b .le. h9b) .and. (p7b .lt. p3b) .and. (p4b .le. p8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p7b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h9b_2 - 
     &1 + noab * (h5b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h9b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p7b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p8b-1),7,6,2,1,4,3,8,5,1.0d0,.false.)
      END IF
      IF ((h5b .le. h9b) .and. (p3b .le. p7b) .and. (p8b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p7b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h9b_2 - 
     &1 + noab * (h5b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h9b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p7b-1),int_mb(k_range+p8b-1
     &),int_mb(k_range+p4b-1),8,5,2,1,4,3,7,6,1.0d0,.false.)
      END IF
      IF ((h5b .le. h9b) .and. (p3b .le. p7b) .and. (p7b .lt. p4b) .and.
     & (p4b .le. p8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p7b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h9b_2 - 
     &1 + noab * (h5b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h9b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p7b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p8b-1),7,5,2,1,4,3,8,6,-1.0d0,.false.)
      END IF
      IF ((h5b .le. h9b) .and. (p4b .le. p7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h9b_2 - 
     &1 + noab * (h5b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h9b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p7b-1
     &),int_mb(k_range+p8b-1),6,5,2,1,4,3,8,7,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_4_7
     &_2',6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      isuperp = 1
      IF (p7b .eq. p8b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      nsubh(1) = 1
      nsubh(2) = 1
      isubh = 1
      IF (h9b .eq. h10b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,4.0d0/FACTOR
     &IAL(nsuperp(1))/FACTORIAL(nsuperp(2))/FACTORIAL(nsubh(1))/FACTORIA
     &L(nsubh(2)),dbl_mb(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_commo
     &n,1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_4_7_2',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_4_7_2',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_4_7_2',9,MA_ERR)
      CALL TCE_SORT_4(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+h5b-1),int_mb(k_range+h2b-1)
     &,4,3,2,1,-1.0d0/4.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p4b -
     & noab - 1 + nvab * (p3b - noab - 1 + nvab * (h5b - 1 + noab * (h2b
     & - 1)))))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_4_7
     &_2',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_4_7_2',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_4_8(d_a,k_a_offset,d_b,k_b_offset,
     &d_c,k_c_offset)
C     i2 ( h2 h11 )_yxt + = 1/12 * Sum ( h6 h7 p3 p4 p5 ) * t ( p3 p4 p5 h6 h7 h11 )_t * i3 ( h2 h6 h7 p3 p4 p5 )_yx
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h2b
      INTEGER h11b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p3b
      INTEGER p4b
      INTEGER p5b
      INTEGER h6b
      INTEGER h7b
      INTEGER p3b_1
      INTEGER p4b_1
      INTEGER p5b_1
      INTEGER h11b_1
      INTEGER h6b_1
      INTEGER h7b_1
      INTEGER h2b_2
      INTEGER h6b_2
      INTEGER h7b_2
      INTEGER p3b_2
      INTEGER p4b_2
      INTEGER p5b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(3)
      INTEGER isuperp
      INTEGER nsubh(2)
      INTEGER isubh
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h2b = 1,noab
      DO h11b = 1,noab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+h11b-
     &1).ne.4)) THEN
      IF (int_mb(k_spin+h2b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),int_mb(k_sym+h11b-1)) .eq. ieor(irrep
     &_y,ieor(irrep_x,irrep_t))) THEN
      dimc = int_mb(k_range+h2b-1) * int_mb(k_range+h11b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_4_8',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      DO p5b = p4b,noab+nvab
      DO h6b = 1,noab
      DO h7b = h6b,noab
      IF (int_mb(k_active+p3b-1)+int_mb(k_active+p4b-1)+int_mb(k_active+
     &p5b-1) .ge. numact) THEN
      IF (int_mb(k_active+h11b-1)+int_mb(k_active+h6b-1)+int_mb(k_active
     &+h7b-1) .ge. numact) THEN
      IF (int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1)+int_mb(k_spin+p5b-1)
     & .eq. int_mb(k_spin+h11b-1)+int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b
     &-1)) THEN
      IF (ieor(int_mb(k_sym+p3b-1),ieor(int_mb(k_sym+p4b-1),ieor(int_mb(
     &k_sym+p5b-1),ieor(int_mb(k_sym+h11b-1),ieor(int_mb(k_sym+h6b-1),in
     &t_mb(k_sym+h7b-1)))))) .eq. irrep_t) THEN
      CALL TCE_RESTRICTED_6(p3b,p4b,p5b,h11b,h6b,h7b,p3b_1,p4b_1,p5b_1,h
     &11b_1,h6b_1,h7b_1)
      CALL TCE_RESTRICTED_6(h2b,h6b,h7b,p3b,p4b,p5b,h2b_2,h6b_2,h7b_2,p3
     &b_2,p4b_2,p5b_2)
      dim_common = int_mb(k_range+p3b-1) * int_mb(k_range+p4b-1) * int_m
     &b(k_range+p5b-1) * int_mb(k_range+h6b-1) * int_mb(k_range+h7b-1)
      dima_sort = int_mb(k_range+h11b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h2b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_4_8',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_4_8',2,MA_ERR)
      IF ((h7b .le. h11b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h11b_
     &1 - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 + noab * (p5b_1 - no
     &ab - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h11b-1),6,5,4,3,2,1,1.0d0,.f
     &alse.)
      END IF
      IF ((h6b .le. h11b) .and. (h11b .lt. h7b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h7b_1
     & - 1 + noab * (h11b_1 - 1 + noab * (h6b_1 - 1 + noab * (p5b_1 - no
     &ab - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h11b-1),int_mb(k_range+h7b-1),5,6,4,3,2,1,-1.0d0,.
     &false.)
      END IF
      IF ((h11b .lt. h6b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h7b_1
     & - 1 + noab * (h6b_1 - 1 + noab * (h11b_1 - 1 + noab * (p5b_1 - no
     &ab - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+h11b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),4,6,5,3,2,1,1.0d0,.f
     &alse.)
      END IF
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_4_8
     &',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_4_8',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_4_8',5,MA_ERR)
      IF ((h7b .lt. h2b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h2b_2 - 1 + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h2b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),3,2,1,6,5,4,1.0d0,.fa
     &lse.)
      END IF
      IF ((h6b .lt. h2b) .and. (h2b .le. h7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h7b_2 - 1 + noab * (h2b_2 - 1 + noab * (h6b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h7b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),2,3,1,6,5,4,-1.0d0,.f
     &alse.)
      END IF
      IF ((h2b .le. h6b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h7b_2 - 1 + noab * (h6b_2 - 1 + noab * (h2b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),1,3,2,6,5,4,1.0d0,.fa
     &lse.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_4_8
     &',6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      nsuperp(3) = 1
      isuperp = 1
      IF (p3b .eq. p4b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      IF (p4b .eq. p5b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      nsubh(1) = 1
      nsubh(2) = 1
      isubh = 1
      IF (h6b .eq. h7b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,12.0d0/FACTO
     &RIAL(nsuperp(1))/FACTORIAL(nsuperp(2))/FACTORIAL(nsuperp(3))/FACTO
     &RIAL(nsubh(1))/FACTORIAL(nsubh(2)),dbl_mb(k_a_sort),dim_common,dbl
     &_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_4_8',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_4_8',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_4_8',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h11b-1),1,2,1.0d0/12.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(h11b 
     &- 1 + noab * (h2b - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_4_8
     &',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_4_8',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_4_8_1(d_a,k_a_offset,d_b,k_b_offse
     &t,d_c,k_c_offset)
C     i3 ( h2 h6 h7 p3 p4 p5 )_yx + = 1 * Sum ( h10 p9 ) * x ( p9 h10 )_x * y ( h2 h6 h7 h10 p3 p4 p5 p9 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h2b
      INTEGER h6b
      INTEGER h7b
      INTEGER p3b
      INTEGER p4b
      INTEGER p5b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p9b
      INTEGER h10b
      INTEGER p9b_1
      INTEGER h10b_1
      INTEGER h2b_2
      INTEGER h6b_2
      INTEGER h7b_2
      INTEGER h10b_2
      INTEGER p3b_2
      INTEGER p4b_2
      INTEGER p5b_2
      INTEGER p9b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h2b = 1,noab
      DO h6b = h2b,noab
      DO h7b = h6b,noab
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      DO p5b = p4b,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+h6b-1
     &)+int_mb(k_spin+h7b-1)+int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1)+i
     &nt_mb(k_spin+p5b-1).ne.12)) THEN
      IF (int_mb(k_spin+h2b-1)+int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b-1)
     & .eq. int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1)+int_mb(k_spin+p5b-
     &1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),ieor(int_mb(k_sym+h6b-1),ieor(int_mb(
     &k_sym+h7b-1),ieor(int_mb(k_sym+p3b-1),ieor(int_mb(k_sym+p4b-1),int
     &_mb(k_sym+p5b-1)))))) .eq. ieor(irrep_y,irrep_x)) THEN
      dimc = int_mb(k_range+h2b-1) * int_mb(k_range+h6b-1) * int_mb(k_ra
     &nge+h7b-1) * int_mb(k_range+p3b-1) * int_mb(k_range+p4b-1) * int_m
     &b(k_range+p5b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_4_8_1',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p9b = noab+1,noab+nvab
      DO h10b = 1,noab
      IF (int_mb(k_active+h2b-1)+int_mb(k_active+h6b-1)+int_mb(k_active+
     &h7b-1)+int_mb(k_active+h10b-1) .ge. numacq) THEN
      IF (int_mb(k_active+p3b-1)+int_mb(k_active+p4b-1)+int_mb(k_active+
     &p5b-1)+int_mb(k_active+p9b-1) .ge. numacq) THEN
      IF (int_mb(k_spin+p9b-1) .eq. int_mb(k_spin+h10b-1)) THEN
      IF (ieor(int_mb(k_sym+p9b-1),int_mb(k_sym+h10b-1)) .eq. irrep_x) T
     &HEN
      CALL TCE_RESTRICTED_2(p9b,h10b,p9b_1,h10b_1)
      CALL TCE_RESTRICTED_8(h2b,h6b,h7b,h10b,p3b,p4b,p5b,p9b,h2b_2,h6b_2
     &,h7b_2,h10b_2,p3b_2,p4b_2,p5b_2,p9b_2)
      dim_common = int_mb(k_range+p9b-1) * int_mb(k_range+h10b-1)
      dima_sort = 1
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h2b-1) * int_mb(k_range+h6b-1) * int_mb
     &(k_range+h7b-1) * int_mb(k_range+p3b-1) * int_mb(k_range+p4b-1) * 
     &int_mb(k_range+p5b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_4_8_1',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_4_8_1',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h10b_
     &1 - 1 + noab * (p9b_1 - noab - 1)))
      CALL TCE_SORT_2(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p9b-1)
     &,int_mb(k_range+h10b-1),2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_4_8
     &_1',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_4_8_1',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_4_8_1',5,MA_ERR)
      IF ((h10b .lt. h2b) .and. (p9b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p9b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 1
     & + noab * (h2b_2 - 1 + noab * (h10b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h10b-1
     &),int_mb(k_range+h2b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p9b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p5b-1),8,7,6,4,3,2,1,5,1.0d0,.false.)
      END IF
      IF ((h10b .lt. h2b) .and. (p3b .le. p9b) .and. (p9b .lt. p4b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p9b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 1
     & + noab * (h2b_2 - 1 + noab * (h10b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h10b-1
     &),int_mb(k_range+h2b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p9b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p5b-1),8,7,5,4,3,2,1,6,-1.0d0,.false.)
      END IF
      IF ((h10b .lt. h2b) .and. (p4b .le. p9b) .and. (p9b .lt. p5b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p9b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 1
     & + noab * (h2b_2 - 1 + noab * (h10b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h10b-1
     &),int_mb(k_range+h2b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p9b-1
     &),int_mb(k_range+p5b-1),8,6,5,4,3,2,1,7,1.0d0,.false.)
      END IF
      IF ((h10b .lt. h2b) .and. (p5b .le. p9b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p9b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 1
     & + noab * (h2b_2 - 1 + noab * (h10b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h10b-1
     &),int_mb(k_range+h2b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+p9b-1),7,6,5,4,3,2,1,8,-1.0d0,.false.)
      END IF
      IF ((h2b .le. h10b) .and. (h10b .lt. h6b) .and. (p9b .lt. p3b)) TH
     &EN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p9b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 1
     & + noab * (h10b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h10b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p9b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p5b-1),8,7,6,4,3,1,2,5,-1.0d0,.false.)
      END IF
      IF ((h2b .le. h10b) .and. (h10b .lt. h6b) .and. (p3b .le. p9b) .an
     &d. (p9b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p9b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 1
     & + noab * (h10b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h10b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p9b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p5b-1),8,7,5,4,3,1,2,6,1.0d0,.false.)
      END IF
      IF ((h2b .le. h10b) .and. (h10b .lt. h6b) .and. (p4b .le. p9b) .an
     &d. (p9b .lt. p5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p9b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 1
     & + noab * (h10b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h10b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p9b-1
     &),int_mb(k_range+p5b-1),8,6,5,4,3,1,2,7,-1.0d0,.false.)
      END IF
      IF ((h2b .le. h10b) .and. (h10b .lt. h6b) .and. (p5b .le. p9b)) TH
     &EN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p9b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 1
     & + noab * (h10b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h10b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+p9b-1),7,6,5,4,3,1,2,8,1.0d0,.false.)
      END IF
      IF ((h6b .le. h10b) .and. (h10b .lt. h7b) .and. (p9b .lt. p3b)) TH
     &EN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p9b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h10b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p9b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p5b-1),8,7,6,4,2,1,3,5,1.0d0,.false.)
      END IF
      IF ((h6b .le. h10b) .and. (h10b .lt. h7b) .and. (p3b .le. p9b) .an
     &d. (p9b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p9b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h10b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p9b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p5b-1),8,7,5,4,2,1,3,6,-1.0d0,.false.)
      END IF
      IF ((h6b .le. h10b) .and. (h10b .lt. h7b) .and. (p4b .le. p9b) .an
     &d. (p9b .lt. p5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p9b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h10b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p9b-1
     &),int_mb(k_range+p5b-1),8,6,5,4,2,1,3,7,1.0d0,.false.)
      END IF
      IF ((h6b .le. h10b) .and. (h10b .lt. h7b) .and. (p5b .le. p9b)) TH
     &EN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p9b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h10b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+p9b-1),7,6,5,4,2,1,3,8,-1.0d0,.false.)
      END IF
      IF ((h7b .le. h10b) .and. (p9b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p9b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h7b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p9b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p5b-1),8,7,6,3,2,1,4,5,-1.0d0,.false.)
      END IF
      IF ((h7b .le. h10b) .and. (p3b .le. p9b) .and. (p9b .lt. p4b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p9b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h7b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p9b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p5b-1),8,7,5,3,2,1,4,6,1.0d0,.false.)
      END IF
      IF ((h7b .le. h10b) .and. (p4b .le. p9b) .and. (p9b .lt. p5b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p9b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h7b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p9b-1
     &),int_mb(k_range+p5b-1),8,6,5,3,2,1,4,7,-1.0d0,.false.)
      END IF
      IF ((h7b .le. h10b) .and. (p5b .le. p9b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p9b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h7b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+p9b-1),7,6,5,3,2,1,4,8,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_4_8
     &_1',6,MA_ERR)
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,1.0d0,dbl_mb
     &(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c
     &_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_4_8_1',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_4_8_1',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_4_8_1',9,MA_ERR)
      CALL TCE_SORT_6(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p3b-1),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h2b-1),6,5,4,3,2,1,1.0d0,.fa
     &lse.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p5b -
     & noab - 1 + nvab * (p4b - noab - 1 + nvab * (p3b - noab - 1 + nvab
     & * (h7b - 1 + noab * (h6b - 1 + noab * (h2b - 1)))))))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_4_8
     &_1',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_4_8_1',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE OFFSET_eomccsdtq_density1_5_4_8_1(l_a_offset,k_a_offset
     &,size)
C     i3 ( h2 h6 h7 p3 p4 p5 )_yx
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER l_a_offset
      INTEGER k_a_offset
      INTEGER length
      INTEGER addr
      INTEGER h2b
      INTEGER h6b
      INTEGER h7b
      INTEGER p3b
      INTEGER p4b
      INTEGER p5b
      DOUBLE PRECISION size
      length = 0
      DO h2b = 1,noab
      DO h6b = h2b,noab
      DO h7b = h6b,noab
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      DO p5b = p4b,noab+nvab
      IF (int_mb(k_spin+h2b-1)+int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b-1)
     & .eq. int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1)+int_mb(k_spin+p5b-
     &1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),ieor(int_mb(k_sym+h6b-1),ieor(int_mb(
     &k_sym+h7b-1),ieor(int_mb(k_sym+p3b-1),ieor(int_mb(k_sym+p4b-1),int
     &_mb(k_sym+p5b-1)))))) .eq. ieor(irrep_y,irrep_x)) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+h6b-1
     &)+int_mb(k_spin+h7b-1)+int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1)+i
     &nt_mb(k_spin+p5b-1).ne.12)) THEN
      length = length + 1
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,2*length+1,'noname',l_a_offset,k_a_off
     &set)) CALL ERRQUIT('eomccsdtq_density1_5_4_8_1',0,MA_ERR)
      dbl_mb(k_a_offset) = dfloat(length)
      addr = 0
      size = 0.0d0
      DO h2b = 1,noab
      DO h6b = h2b,noab
      DO h7b = h6b,noab
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      DO p5b = p4b,noab+nvab
      IF (int_mb(k_spin+h2b-1)+int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b-1)
     & .eq. int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1)+int_mb(k_spin+p5b-
     &1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),ieor(int_mb(k_sym+h6b-1),ieor(int_mb(
     &k_sym+h7b-1),ieor(int_mb(k_sym+p3b-1),ieor(int_mb(k_sym+p4b-1),int
     &_mb(k_sym+p5b-1)))))) .eq. ieor(irrep_y,irrep_x)) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+h6b-1
     &)+int_mb(k_spin+h7b-1)+int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1)+i
     &nt_mb(k_spin+p5b-1).ne.12)) THEN
      addr = addr + 1
      dbl_mb(k_a_offset+addr) = dfloat(p5b - noab - 1 + nvab * (p4b - no
     &ab - 1 + nvab * (p3b - noab - 1 + nvab * (h7b - 1 + noab * (h6b - 
     &1 + noab * (h2b - 1))))))
      dbl_mb(k_a_offset+length+addr) = size
      size = size + dfloat(int_mb(k_range+h2b-1)) * dfloat(int_mb(k_rang
     &e+h6b-1)) * dfloat(int_mb(k_range+h7b-1)) * dfloat(int_mb(k_range+
     &p3b-1)) * dfloat(int_mb(k_range+p4b-1)) * dfloat(int_mb(k_range+p5
     &b-1))
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_5(d_a,k_a_offset,d_b,k_b_offset,d_
     &c,k_c_offset)
C     i1 ( p12 h11 )_ytx + = -1 * Sum ( h1 ) * x ( p12 h1 )_x * i2 ( h1 h11 )_yt
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER p12b
      INTEGER h11b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER h1b
      INTEGER p12b_1
      INTEGER h1b_1
      INTEGER h1b_2
      INTEGER h11b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO p12b = noab+1,noab+nvab
      DO h11b = 1,noab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+p12b-1)+int_mb(k_spin+h11b
     &-1).ne.4)) THEN
      IF (int_mb(k_spin+p12b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+p12b-1),int_mb(k_sym+h11b-1)) .eq. ieor(irre
     &p_y,ieor(irrep_t,irrep_x))) THEN
      dimc = int_mb(k_range+p12b-1) * int_mb(k_range+h11b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_5',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO h1b = 1,noab
      IF (int_mb(k_spin+p12b-1) .eq. int_mb(k_spin+h1b-1)) THEN
      IF (ieor(int_mb(k_sym+p12b-1),int_mb(k_sym+h1b-1)) .eq. irrep_x) T
     &HEN
      CALL TCE_RESTRICTED_2(p12b,h1b,p12b_1,h1b_1)
      CALL TCE_RESTRICTED_2(h1b,h11b,h1b_2,h11b_2)
      dim_common = int_mb(k_range+h1b-1)
      dima_sort = int_mb(k_range+p12b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h11b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_5',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_5',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h1b_1
     & - 1 + noab * (p12b_1 - noab - 1)))
      CALL TCE_SORT_2(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p12b-1
     &),int_mb(k_range+h1b-1),1,2,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_5',
     &3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_5',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_5',5,MA_ERR)
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(h11b_
     &2 - 1 + noab * (h1b_2 - 1)))
      CALL TCE_SORT_2(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h11b-1),2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_5',
     &6,MA_ERR)
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,1.0d0,dbl_mb
     &(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c
     &_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_5',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_5',8,MA_ERR)
      END IF
      END IF
      END IF
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_5',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+h11b-1
     &),int_mb(k_range+p12b-1),2,1,-1.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(h11b 
     &- 1 + noab * (p12b - noab - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_5',
     &10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_5',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_5_1(d_a,k_a_offset,d_b,k_b_offset,
     &d_c,k_c_offset)
C     i2 ( h1 h11 )_yt + = 1 * Sum ( p3 ) * t ( p3 h11 )_t * y ( h1 p3 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h1b
      INTEGER h11b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p3b
      INTEGER p3b_1
      INTEGER h11b_1
      INTEGER h1b_2
      INTEGER p3b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h1b = 1,noab
      DO h11b = 1,noab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h1b-1)+int_mb(k_spin+h11b-
     &1).ne.4)) THEN
      IF (int_mb(k_spin+h1b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+h1b-1),int_mb(k_sym+h11b-1)) .eq. ieor(irrep
     &_y,irrep_t)) THEN
      dimc = int_mb(k_range+h1b-1) * int_mb(k_range+h11b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_5_1',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p3b = noab+1,noab+nvab
      IF (int_mb(k_spin+p3b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+p3b-1),int_mb(k_sym+h11b-1)) .eq. irrep_t) T
     &HEN
      CALL TCE_RESTRICTED_2(p3b,h11b,p3b_1,h11b_1)
      CALL TCE_RESTRICTED_2(h1b,p3b,h1b_2,p3b_2)
      dim_common = int_mb(k_range+p3b-1)
      dima_sort = int_mb(k_range+h11b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h1b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_5_1',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_5_1',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h11b_
     &1 - 1 + noab * (p3b_1 - noab - 1)))
      CALL TCE_SORT_2(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+h11b-1),2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_5_1
     &',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_5_1',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_5_1',5,MA_ERR)
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (h1b_2 - 1)))
      CALL TCE_SORT_2(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+p3b-1),1,2,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_5_1
     &',6,MA_ERR)
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,1.0d0,dbl_mb
     &(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c
     &_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_5_1',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_5_1',8,MA_ERR)
      END IF
      END IF
      END IF
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_5_1',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h11b-1),1,2,1.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(h11b 
     &- 1 + noab * (h1b - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_5_1
     &',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_5_1',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE OFFSET_eomccsdtq_density1_5_5_1(l_a_offset,k_a_offset,s
     &ize)
C     i2 ( h1 h11 )_yt
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER l_a_offset
      INTEGER k_a_offset
      INTEGER length
      INTEGER addr
      INTEGER h1b
      INTEGER h11b
      DOUBLE PRECISION size
      length = 0
      DO h1b = 1,noab
      DO h11b = 1,noab
      IF (int_mb(k_spin+h1b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+h1b-1),int_mb(k_sym+h11b-1)) .eq. ieor(irrep
     &_y,irrep_t)) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h1b-1)+int_mb(k_spin+h11b-
     &1).ne.4)) THEN
      length = length + 1
      END IF
      END IF
      END IF
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,2*length+1,'noname',l_a_offset,k_a_off
     &set)) CALL ERRQUIT('eomccsdtq_density1_5_5_1',0,MA_ERR)
      dbl_mb(k_a_offset) = dfloat(length)
      addr = 0
      size = 0.0d0
      DO h1b = 1,noab
      DO h11b = 1,noab
      IF (int_mb(k_spin+h1b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+h1b-1),int_mb(k_sym+h11b-1)) .eq. ieor(irrep
     &_y,irrep_t)) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h1b-1)+int_mb(k_spin+h11b-
     &1).ne.4)) THEN
      addr = addr + 1
      dbl_mb(k_a_offset+addr) = dfloat(h11b - 1 + noab * (h1b - 1))
      dbl_mb(k_a_offset+length+addr) = size
      size = size + dfloat(int_mb(k_range+h1b-1)) * dfloat(int_mb(k_rang
     &e+h11b-1))
      END IF
      END IF
      END IF
      END DO
      END DO
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_5_2(d_a,k_a_offset,d_b,k_b_offset,
     &d_c,k_c_offset)
C     i2 ( h1 h11 )_yt + = -1/2 * Sum ( h5 p4 p3 ) * t ( p3 p4 h5 h11 )_t * y ( h1 h5 p3 p4 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h1b
      INTEGER h11b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p3b
      INTEGER p4b
      INTEGER h5b
      INTEGER p3b_1
      INTEGER p4b_1
      INTEGER h11b_1
      INTEGER h5b_1
      INTEGER h1b_2
      INTEGER h5b_2
      INTEGER p3b_2
      INTEGER p4b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(2)
      INTEGER isuperp
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h1b = 1,noab
      DO h11b = 1,noab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h1b-1)+int_mb(k_spin+h11b-
     &1).ne.4)) THEN
      IF (int_mb(k_spin+h1b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+h1b-1),int_mb(k_sym+h11b-1)) .eq. ieor(irrep
     &_y,irrep_t)) THEN
      dimc = int_mb(k_range+h1b-1) * int_mb(k_range+h11b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_5_2',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      DO h5b = 1,noab
      IF (int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1) .eq. int_mb(k_spin+h
     &11b-1)+int_mb(k_spin+h5b-1)) THEN
      IF (ieor(int_mb(k_sym+p3b-1),ieor(int_mb(k_sym+p4b-1),ieor(int_mb(
     &k_sym+h11b-1),int_mb(k_sym+h5b-1)))) .eq. irrep_t) THEN
      CALL TCE_RESTRICTED_4(p3b,p4b,h11b,h5b,p3b_1,p4b_1,h11b_1,h5b_1)
      CALL TCE_RESTRICTED_4(h1b,h5b,p3b,p4b,h1b_2,h5b_2,p3b_2,p4b_2)
      dim_common = int_mb(k_range+p3b-1) * int_mb(k_range+p4b-1) * int_m
     &b(k_range+h5b-1)
      dima_sort = int_mb(k_range+h11b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h1b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_5_2',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_5_2',2,MA_ERR)
      IF ((h5b .le. h11b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h11b_
     &1 - 1 + noab * (h5b_1 - 1 + noab * (p4b_1 - noab - 1 + nvab * (p3b
     &_1 - noab - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+h5b-1),int_mb(k_range+h11b-1
     &),4,3,2,1,1.0d0,.false.)
      END IF
      IF ((h11b .lt. h5b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h5b_1
     & - 1 + noab * (h11b_1 - 1 + noab * (p4b_1 - noab - 1 + nvab * (p3b
     &_1 - noab - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+h11b-1),int_mb(k_range+h5b-1
     &),3,4,2,1,-1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_5_2
     &',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_5_2',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_5_2',5,MA_ERR)
      IF ((h5b .lt. h1b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (h1b_2 - 1 + noab 
     &* (h5b_2 - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h1b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1)
     &,2,1,4,3,-1.0d0,.false.)
      END IF
      IF ((h1b .le. h5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab 
     &* (h1b_2 - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1)
     &,1,2,4,3,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_5_2
     &',6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      isuperp = 1
      IF (p3b .eq. p4b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,2.0d0/FACTOR
     &IAL(nsuperp(1))/FACTORIAL(nsuperp(2)),dbl_mb(k_a_sort),dim_common,
     &dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_5_2',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_5_2',8,MA_ERR)
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_5_2',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h11b-1),1,2,-1.0d0/2.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(h11b 
     &- 1 + noab * (h1b - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_5_2
     &',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_5_2',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_5_3(d_a,k_a_offset,d_b,k_b_offset,
     &d_c,k_c_offset)
C     i2 ( h1 h11 )_yt + = 1/12 * Sum ( h7 h6 p5 p4 p3 ) * t ( p3 p4 p5 h6 h7 h11 )_t * y ( h1 h6 h7 p3 p4 p5 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h1b
      INTEGER h11b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p3b
      INTEGER p4b
      INTEGER p5b
      INTEGER h6b
      INTEGER h7b
      INTEGER p3b_1
      INTEGER p4b_1
      INTEGER p5b_1
      INTEGER h11b_1
      INTEGER h6b_1
      INTEGER h7b_1
      INTEGER h1b_2
      INTEGER h6b_2
      INTEGER h7b_2
      INTEGER p3b_2
      INTEGER p4b_2
      INTEGER p5b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(3)
      INTEGER isuperp
      INTEGER nsubh(2)
      INTEGER isubh
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h1b = 1,noab
      DO h11b = 1,noab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h1b-1)+int_mb(k_spin+h11b-
     &1).ne.4)) THEN
      IF (int_mb(k_spin+h1b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+h1b-1),int_mb(k_sym+h11b-1)) .eq. ieor(irrep
     &_y,irrep_t)) THEN
      dimc = int_mb(k_range+h1b-1) * int_mb(k_range+h11b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_5_3',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      DO p5b = p4b,noab+nvab
      DO h6b = 1,noab
      DO h7b = h6b,noab
      IF (int_mb(k_active+p3b-1)+int_mb(k_active+p4b-1)+int_mb(k_active+
     &p5b-1) .ge. numact) THEN
      IF (int_mb(k_active+h11b-1)+int_mb(k_active+h6b-1)+int_mb(k_active
     &+h7b-1) .ge. numact) THEN
      IF (int_mb(k_active+h1b-1)+int_mb(k_active+h6b-1)+int_mb(k_active+
     &h7b-1) .ge. numact) THEN
      IF (int_mb(k_active+p3b-1)+int_mb(k_active+p4b-1)+int_mb(k_active+
     &p5b-1) .ge. numact) THEN
      IF (int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1)+int_mb(k_spin+p5b-1)
     & .eq. int_mb(k_spin+h11b-1)+int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b
     &-1)) THEN
      IF (ieor(int_mb(k_sym+p3b-1),ieor(int_mb(k_sym+p4b-1),ieor(int_mb(
     &k_sym+p5b-1),ieor(int_mb(k_sym+h11b-1),ieor(int_mb(k_sym+h6b-1),in
     &t_mb(k_sym+h7b-1)))))) .eq. irrep_t) THEN
      CALL TCE_RESTRICTED_6(p3b,p4b,p5b,h11b,h6b,h7b,p3b_1,p4b_1,p5b_1,h
     &11b_1,h6b_1,h7b_1)
      CALL TCE_RESTRICTED_6(h1b,h6b,h7b,p3b,p4b,p5b,h1b_2,h6b_2,h7b_2,p3
     &b_2,p4b_2,p5b_2)
      dim_common = int_mb(k_range+p3b-1) * int_mb(k_range+p4b-1) * int_m
     &b(k_range+p5b-1) * int_mb(k_range+h6b-1) * int_mb(k_range+h7b-1)
      dima_sort = int_mb(k_range+h11b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h1b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_5_3',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_5_3',2,MA_ERR)
      IF ((h7b .le. h11b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h11b_
     &1 - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 + noab * (p5b_1 - no
     &ab - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h11b-1),6,5,4,3,2,1,1.0d0,.f
     &alse.)
      END IF
      IF ((h6b .le. h11b) .and. (h11b .lt. h7b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h7b_1
     & - 1 + noab * (h11b_1 - 1 + noab * (h6b_1 - 1 + noab * (p5b_1 - no
     &ab - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h11b-1),int_mb(k_range+h7b-1),5,6,4,3,2,1,-1.0d0,.
     &false.)
      END IF
      IF ((h11b .lt. h6b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h7b_1
     & - 1 + noab * (h6b_1 - 1 + noab * (h11b_1 - 1 + noab * (p5b_1 - no
     &ab - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+h11b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),4,6,5,3,2,1,1.0d0,.f
     &alse.)
      END IF
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_5_3
     &',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_5_3',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_5_3',5,MA_ERR)
      IF ((h7b .lt. h1b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h1b_2 - 1 + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h1b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),3,2,1,6,5,4,1.0d0,.fa
     &lse.)
      END IF
      IF ((h6b .lt. h1b) .and. (h1b .le. h7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h7b_2 - 1 + noab * (h1b_2 - 1 + noab * (h6b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h1b-1),int_mb(k_range+h7b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),2,3,1,6,5,4,-1.0d0,.f
     &alse.)
      END IF
      IF ((h1b .le. h6b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h7b_2 - 1 + noab * (h6b_2 - 1 + noab * (h1b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),1,3,2,6,5,4,1.0d0,.fa
     &lse.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_5_3
     &',6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      nsuperp(3) = 1
      isuperp = 1
      IF (p3b .eq. p4b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      IF (p4b .eq. p5b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      nsubh(1) = 1
      nsubh(2) = 1
      isubh = 1
      IF (h6b .eq. h7b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,12.0d0/FACTO
     &RIAL(nsuperp(1))/FACTORIAL(nsuperp(2))/FACTORIAL(nsuperp(3))/FACTO
     &RIAL(nsubh(1))/FACTORIAL(nsubh(2)),dbl_mb(k_a_sort),dim_common,dbl
     &_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_5_3',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_5_3',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_5_3',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h11b-1),1,2,1.0d0/12.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(h11b 
     &- 1 + noab * (h1b - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_5_3
     &',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_5_3',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_5_4(d_a,k_a_offset,d_b,k_b_offset,
     &d_c,k_c_offset)
C     i2 ( h1 h11 )_yt + = -1/144 * Sum ( h9 h8 h7 p6 p5 p4 p3 ) * t ( p3 p4 p5 p6 h7 h8 h9 h11 )_t * y ( h1 h7 h8 h9 p3 p4 p5 p6 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h1b
      INTEGER h11b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p3b
      INTEGER p4b
      INTEGER p5b
      INTEGER p6b
      INTEGER h7b
      INTEGER h8b
      INTEGER h9b
      INTEGER p3b_1
      INTEGER p4b_1
      INTEGER p5b_1
      INTEGER p6b_1
      INTEGER h11b_1
      INTEGER h7b_1
      INTEGER h8b_1
      INTEGER h9b_1
      INTEGER h1b_2
      INTEGER h7b_2
      INTEGER h8b_2
      INTEGER h9b_2
      INTEGER p3b_2
      INTEGER p4b_2
      INTEGER p5b_2
      INTEGER p6b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(4)
      INTEGER isuperp
      INTEGER nsubh(3)
      INTEGER isubh
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h1b = 1,noab
      DO h11b = 1,noab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h1b-1)+int_mb(k_spin+h11b-
     &1).ne.4)) THEN
      IF (int_mb(k_spin+h1b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+h1b-1),int_mb(k_sym+h11b-1)) .eq. ieor(irrep
     &_y,irrep_t)) THEN
      dimc = int_mb(k_range+h1b-1) * int_mb(k_range+h11b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_5_4',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      DO p5b = p4b,noab+nvab
      DO p6b = p5b,noab+nvab
      DO h7b = 1,noab
      DO h8b = h7b,noab
      DO h9b = h8b,noab
      IF (int_mb(k_active+p3b-1)+int_mb(k_active+p4b-1)+int_mb(k_active+
     &p5b-1)+int_mb(k_active+p6b-1) .ge. numacq) THEN
      IF (int_mb(k_active+h11b-1)+int_mb(k_active+h7b-1)+int_mb(k_active
     &+h8b-1)+int_mb(k_active+h9b-1) .ge. numacq) THEN
      IF (int_mb(k_active+h1b-1)+int_mb(k_active+h7b-1)+int_mb(k_active+
     &h8b-1)+int_mb(k_active+h9b-1) .ge. numacq) THEN
      IF (int_mb(k_active+p3b-1)+int_mb(k_active+p4b-1)+int_mb(k_active+
     &p5b-1)+int_mb(k_active+p6b-1) .ge. numacq) THEN
      IF (int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1)+int_mb(k_spin+p5b-1)
     &+int_mb(k_spin+p6b-1) .eq. int_mb(k_spin+h11b-1)+int_mb(k_spin+h7b
     &-1)+int_mb(k_spin+h8b-1)+int_mb(k_spin+h9b-1)) THEN
      IF (ieor(int_mb(k_sym+p3b-1),ieor(int_mb(k_sym+p4b-1),ieor(int_mb(
     &k_sym+p5b-1),ieor(int_mb(k_sym+p6b-1),ieor(int_mb(k_sym+h11b-1),ie
     &or(int_mb(k_sym+h7b-1),ieor(int_mb(k_sym+h8b-1),int_mb(k_sym+h9b-1
     &)))))))) .eq. irrep_t) THEN
      CALL TCE_RESTRICTED_8(p3b,p4b,p5b,p6b,h11b,h7b,h8b,h9b,p3b_1,p4b_1
     &,p5b_1,p6b_1,h11b_1,h7b_1,h8b_1,h9b_1)
      CALL TCE_RESTRICTED_8(h1b,h7b,h8b,h9b,p3b,p4b,p5b,p6b,h1b_2,h7b_2,
     &h8b_2,h9b_2,p3b_2,p4b_2,p5b_2,p6b_2)
      dim_common = int_mb(k_range+p3b-1) * int_mb(k_range+p4b-1) * int_m
     &b(k_range+p5b-1) * int_mb(k_range+p6b-1) * int_mb(k_range+h7b-1) *
     & int_mb(k_range+h8b-1) * int_mb(k_range+h9b-1)
      dima_sort = int_mb(k_range+h11b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h1b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_5_4',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_5_4',2,MA_ERR)
      IF ((h9b .le. h11b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h11b_
     &1 - 1 + noab * (h9b_1 - 1 + noab * (h8b_1 - 1 + noab * (h7b_1 - 1 
     &+ noab * (p6b_1 - noab - 1 + nvab * (p5b_1 - noab - 1 + nvab * (p4
     &b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h11b-1),8,7,6,5,4,3,2,1,1.0d0,.false.)
      END IF
      IF ((h8b .le. h11b) .and. (h11b .lt. h9b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h9b_1
     & - 1 + noab * (h11b_1 - 1 + noab * (h8b_1 - 1 + noab * (h7b_1 - 1 
     &+ noab * (p6b_1 - noab - 1 + nvab * (p5b_1 - noab - 1 + nvab * (p4
     &b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),int_mb(k_range+h11b-1
     &),int_mb(k_range+h9b-1),7,8,6,5,4,3,2,1,-1.0d0,.false.)
      END IF
      IF ((h7b .le. h11b) .and. (h11b .lt. h8b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h9b_1
     & - 1 + noab * (h8b_1 - 1 + noab * (h11b_1 - 1 + noab * (h7b_1 - 1 
     &+ noab * (p6b_1 - noab - 1 + nvab * (p5b_1 - noab - 1 + nvab * (p4
     &b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h11b-1),int_mb(k_range+h8b-1
     &),int_mb(k_range+h9b-1),6,8,7,5,4,3,2,1,1.0d0,.false.)
      END IF
      IF ((h11b .lt. h7b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h9b_1
     & - 1 + noab * (h8b_1 - 1 + noab * (h7b_1 - 1 + noab * (h11b_1 - 1 
     &+ noab * (p6b_1 - noab - 1 + nvab * (p5b_1 - noab - 1 + nvab * (p4
     &b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1)
     &,int_mb(k_range+h11b-1),int_mb(k_range+h7b-1),int_mb(k_range+h8b-1
     &),int_mb(k_range+h9b-1),5,8,7,6,4,3,2,1,-1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_5_4
     &',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_5_4',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_5_4',5,MA_ERR)
      IF ((h9b .lt. h1b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h1b_2 - 1 + noab * (h9b_2 - 1
     & + noab * (h8b_2 - 1 + noab * (h7b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h9b-1),int_mb(k_range+h1b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p6b-1),4,3,2,1,8,7,6,5,-1.0d0,.false.)
      END IF
      IF ((h8b .lt. h1b) .and. (h1b .le. h9b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h1b_2 - 1
     & + noab * (h8b_2 - 1 + noab * (h7b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h1b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p6b-1),3,4,2,1,8,7,6,5,1.0d0,.false.)
      END IF
      IF ((h7b .lt. h1b) .and. (h1b .le. h8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h8b_2 - 1
     & + noab * (h1b_2 - 1 + noab * (h7b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h1b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p6b-1),2,4,3,1,8,7,6,5,-1.0d0,.false.)
      END IF
      IF ((h1b .le. h7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h8b_2 - 1
     & + noab * (h7b_2 - 1 + noab * (h1b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p6b-1),1,4,3,2,8,7,6,5,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_5_4
     &',6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      nsuperp(3) = 1
      nsuperp(4) = 1
      isuperp = 1
      IF (p3b .eq. p4b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      IF (p4b .eq. p5b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      IF (p5b .eq. p6b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      nsubh(1) = 1
      nsubh(2) = 1
      nsubh(3) = 1
      isubh = 1
      IF (h7b .eq. h8b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      IF (h8b .eq. h9b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,144.0d0/FACT
     &ORIAL(nsuperp(1))/FACTORIAL(nsuperp(2))/FACTORIAL(nsuperp(3))/FACT
     &ORIAL(nsuperp(4))/FACTORIAL(nsubh(1))/FACTORIAL(nsubh(2))/FACTORIA
     &L(nsubh(3)),dbl_mb(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_commo
     &n,1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_5_4',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_5_4',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_5_4',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h11b-1),1,2,-1.0d0/144.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(h11b 
     &- 1 + noab * (h1b - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_5_4
     &',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_5_4',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_6(d_a,k_a_offset,d_b,k_b_offset,d_
     &c,k_c_offset)
C     i1 ( p12 h11 )_yxt + = 1 * t ( p12 h11 )_t * i2 ( )_yx
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER p12b
      INTEGER h11b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p12b_1
      INTEGER h11b_1
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO p12b = noab+1,noab+nvab
      DO h11b = 1,noab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+p12b-1)+int_mb(k_spin+h11b
     &-1).ne.4)) THEN
      IF (int_mb(k_spin+p12b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+p12b-1),int_mb(k_sym+h11b-1)) .eq. ieor(irre
     &p_y,ieor(irrep_x,irrep_t))) THEN
      dimc = int_mb(k_range+p12b-1) * int_mb(k_range+h11b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_6',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      IF (int_mb(k_spin+p12b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+p12b-1),int_mb(k_sym+h11b-1)) .eq. irrep_t) 
     &THEN
      CALL TCE_RESTRICTED_2(p12b,h11b,p12b_1,h11b_1)
      dim_common = 1
      dima_sort = int_mb(k_range+p12b-1) * int_mb(k_range+h11b-1)
      dima = dim_common * dima_sort
      dimb_sort = 1
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_6',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_6',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h11b_
     &1 - 1 + noab * (p12b_1 - noab - 1)))
      CALL TCE_SORT_2(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p12b-1
     &),int_mb(k_range+h11b-1),2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_6',
     &3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_6',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_6',5,MA_ERR)
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),0)
      CALL TCE_SORT_0(dbl_mb(k_b),dbl_mb(k_b_sort),1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_6',
     &6,MA_ERR)
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,1.0d0,dbl_mb
     &(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c
     &_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_6',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_6',8,MA_ERR)
      END IF
      END IF
      END IF
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_6',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+h11b-1
     &),int_mb(k_range+p12b-1),2,1,1.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(h11b 
     &- 1 + noab * (p12b - noab - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_6',
     &10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_6',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_6_1(d_a,k_a_offset,d_b,k_b_offset,
     &d_c,k_c_offset)
C     i2 ( )_yx + = 1 * Sum ( h4 p3 ) * x ( p3 h4 )_x * y ( h4 p3 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p3b
      INTEGER h4b
      INTEGER p3b_1
      INTEGER h4b_1
      INTEGER h4b_2
      INTEGER p3b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      IF (next .eq. count) THEN
      IF (0 .eq. ieor(irrep_y,irrep_x)) THEN
      dimc = 1
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_6_1',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p3b = noab+1,noab+nvab
      DO h4b = 1,noab
      IF (int_mb(k_spin+p3b-1) .eq. int_mb(k_spin+h4b-1)) THEN
      IF (ieor(int_mb(k_sym+p3b-1),int_mb(k_sym+h4b-1)) .eq. irrep_x) TH
     &EN
      CALL TCE_RESTRICTED_2(p3b,h4b,p3b_1,h4b_1)
      CALL TCE_RESTRICTED_2(h4b,p3b,h4b_2,p3b_2)
      dim_common = int_mb(k_range+p3b-1) * int_mb(k_range+h4b-1)
      dima_sort = 1
      dima = dim_common * dima_sort
      dimb_sort = 1
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_6_1',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_6_1',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h4b_1
     & - 1 + noab * (p3b_1 - noab - 1)))
      CALL TCE_SORT_2(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+h4b-1),2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_6_1
     &',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_6_1',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_6_1',5,MA_ERR)
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (h4b_2 - 1)))
      CALL TCE_SORT_2(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+p3b-1),1,2,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_6_1
     &',6,MA_ERR)
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,1.0d0,dbl_mb
     &(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c
     &_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_6_1',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_6_1',8,MA_ERR)
      END IF
      END IF
      END IF
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_6_1',9,MA_ERR)
      CALL TCE_SORT_0(dbl_mb(k_c_sort),dbl_mb(k_c),1.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),0)
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_6_1
     &',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_6_1',11,MA_ERR)
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE OFFSET_eomccsdtq_density1_5_6_1(l_a_offset,k_a_offset,s
     &ize)
C     i2 ( )_yx
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER l_a_offset
      INTEGER k_a_offset
      INTEGER length
      INTEGER addr
      DOUBLE PRECISION size
      length = 0
      IF (0 .eq. ieor(irrep_y,irrep_x)) THEN
      length = length + 1
      END IF
      IF (.not.MA_PUSH_GET(mt_dbl,2*length+1,'noname',l_a_offset,k_a_off
     &set)) CALL ERRQUIT('eomccsdtq_density1_5_6_1',0,MA_ERR)
      dbl_mb(k_a_offset) = dfloat(length)
      addr = 0
      size = 0.0d0
      IF (0 .eq. ieor(irrep_y,irrep_x)) THEN
      addr = addr + 1
      dbl_mb(k_a_offset+addr) = dfloat(0)
      dbl_mb(k_a_offset+length+addr) = size
      size = 1.0d0
      END IF
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_6_2(d_a,k_a_offset,d_b,k_b_offset,
     &d_c,k_c_offset)
C     i2 ( )_yx + = 1/4 * Sum ( h6 h5 p4 p3 ) * x ( p3 p4 h5 h6 )_x * y ( h5 h6 p3 p4 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p3b
      INTEGER p4b
      INTEGER h5b
      INTEGER h6b
      INTEGER p3b_1
      INTEGER p4b_1
      INTEGER h5b_1
      INTEGER h6b_1
      INTEGER h5b_2
      INTEGER h6b_2
      INTEGER p3b_2
      INTEGER p4b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(2)
      INTEGER isuperp
      INTEGER nsubh(2)
      INTEGER isubh
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      IF (next .eq. count) THEN
      IF (0 .eq. ieor(irrep_y,irrep_x)) THEN
      dimc = 1
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_6_2',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      DO h5b = 1,noab
      DO h6b = h5b,noab
      IF (int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1) .eq. int_mb(k_spin+h
     &5b-1)+int_mb(k_spin+h6b-1)) THEN
      IF (ieor(int_mb(k_sym+p3b-1),ieor(int_mb(k_sym+p4b-1),ieor(int_mb(
     &k_sym+h5b-1),int_mb(k_sym+h6b-1)))) .eq. irrep_x) THEN
      CALL TCE_RESTRICTED_4(p3b,p4b,h5b,h6b,p3b_1,p4b_1,h5b_1,h6b_1)
      CALL TCE_RESTRICTED_4(h5b,h6b,p3b,p4b,h5b_2,h6b_2,p3b_2,p4b_2)
      dim_common = int_mb(k_range+p3b-1) * int_mb(k_range+p4b-1) * int_m
     &b(k_range+h5b-1) * int_mb(k_range+h6b-1)
      dima_sort = 1
      dima = dim_common * dima_sort
      dimb_sort = 1
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_6_2',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_6_2',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h6b_1
     & - 1 + noab * (h5b_1 - 1 + noab * (p4b_1 - noab - 1 + nvab * (p3b_
     &1 - noab - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+h5b-1),int_mb(k_range+h6b-1)
     &,4,3,2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_6_2
     &',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_6_2',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_6_2',5,MA_ERR)
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (h6b_2 - 1 + noab 
     &* (h5b_2 - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1)
     &,2,1,4,3,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_6_2
     &',6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      isuperp = 1
      IF (p3b .eq. p4b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      nsubh(1) = 1
      nsubh(2) = 1
      isubh = 1
      IF (h5b .eq. h6b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,4.0d0/FACTOR
     &IAL(nsuperp(1))/FACTORIAL(nsuperp(2))/FACTORIAL(nsubh(1))/FACTORIA
     &L(nsubh(2)),dbl_mb(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_commo
     &n,1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_6_2',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_6_2',8,MA_ERR)
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_6_2',9,MA_ERR)
      CALL TCE_SORT_0(dbl_mb(k_c_sort),dbl_mb(k_c),1.0d0/4.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),0)
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_6_2
     &',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_6_2',11,MA_ERR)
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_6_3(d_a,k_a_offset,d_b,k_b_offset,
     &d_c,k_c_offset)
C     i2 ( )_yx + = 1/36 * Sum ( h8 h7 h6 p5 p4 p3 ) * x ( p3 p4 p5 h6 h7 h8 )_x * y ( h6 h7 h8 p3 p4 p5 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p3b
      INTEGER p4b
      INTEGER p5b
      INTEGER h6b
      INTEGER h7b
      INTEGER h8b
      INTEGER p3b_1
      INTEGER p4b_1
      INTEGER p5b_1
      INTEGER h6b_1
      INTEGER h7b_1
      INTEGER h8b_1
      INTEGER h6b_2
      INTEGER h7b_2
      INTEGER h8b_2
      INTEGER p3b_2
      INTEGER p4b_2
      INTEGER p5b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(3)
      INTEGER isuperp
      INTEGER nsubh(3)
      INTEGER isubh
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      IF (next .eq. count) THEN
      IF (0 .eq. ieor(irrep_y,irrep_x)) THEN
      dimc = 1
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_6_3',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      DO p5b = p4b,noab+nvab
      DO h6b = 1,noab
      DO h7b = h6b,noab
      DO h8b = h7b,noab
      IF (int_mb(k_active+p3b-1)+int_mb(k_active+p4b-1)+int_mb(k_active+
     &p5b-1) .ge. numact) THEN
      IF (int_mb(k_active+h6b-1)+int_mb(k_active+h7b-1)+int_mb(k_active+
     &h8b-1) .ge. numact) THEN
      IF (int_mb(k_active+h6b-1)+int_mb(k_active+h7b-1)+int_mb(k_active+
     &h8b-1) .ge. numact) THEN
      IF (int_mb(k_active+p3b-1)+int_mb(k_active+p4b-1)+int_mb(k_active+
     &p5b-1) .ge. numact) THEN
      IF (int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1)+int_mb(k_spin+p5b-1)
     & .eq. int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b-1)+int_mb(k_spin+h8b-
     &1)) THEN
      IF (ieor(int_mb(k_sym+p3b-1),ieor(int_mb(k_sym+p4b-1),ieor(int_mb(
     &k_sym+p5b-1),ieor(int_mb(k_sym+h6b-1),ieor(int_mb(k_sym+h7b-1),int
     &_mb(k_sym+h8b-1)))))) .eq. irrep_x) THEN
      CALL TCE_RESTRICTED_6(p3b,p4b,p5b,h6b,h7b,h8b,p3b_1,p4b_1,p5b_1,h6
     &b_1,h7b_1,h8b_1)
      CALL TCE_RESTRICTED_6(h6b,h7b,h8b,p3b,p4b,p5b,h6b_2,h7b_2,h8b_2,p3
     &b_2,p4b_2,p5b_2)
      dim_common = int_mb(k_range+p3b-1) * int_mb(k_range+p4b-1) * int_m
     &b(k_range+p5b-1) * int_mb(k_range+h6b-1) * int_mb(k_range+h7b-1) *
     & int_mb(k_range+h8b-1)
      dima_sort = 1
      dima = dim_common * dima_sort
      dimb_sort = 1
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_6_3',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_6_3',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h8b_1
     & - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 + noab * (p5b_1 - noa
     &b - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),6,5,4,3,2,1,1.0d0,.fa
     &lse.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_6_3
     &',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_6_3',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_6_3',5,MA_ERR)
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h8b_2 - 1 + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),3,2,1,6,5,4,1.0d0,.fa
     &lse.)
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_6_3
     &',6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      nsuperp(3) = 1
      isuperp = 1
      IF (p3b .eq. p4b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      IF (p4b .eq. p5b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      nsubh(1) = 1
      nsubh(2) = 1
      nsubh(3) = 1
      isubh = 1
      IF (h6b .eq. h7b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      IF (h7b .eq. h8b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,36.0d0/FACTO
     &RIAL(nsuperp(1))/FACTORIAL(nsuperp(2))/FACTORIAL(nsuperp(3))/FACTO
     &RIAL(nsubh(1))/FACTORIAL(nsubh(2))/FACTORIAL(nsubh(3)),dbl_mb(k_a_
     &sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c_sort
     &),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_6_3',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_6_3',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_6_3',9,MA_ERR)
      CALL TCE_SORT_0(dbl_mb(k_c_sort),dbl_mb(k_c),1.0d0/36.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),0)
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_6_3
     &',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_6_3',11,MA_ERR)
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_6_4(d_a,k_a_offset,d_b,k_b_offset,
     &d_c,k_c_offset)
C     i2 ( )_yx + = 1/576 * Sum ( h10 h9 h8 h7 p6 p5 p4 p3 ) * x ( p3 p4 p5 p6 h7 h8 h9 h10 )_x * y ( h7 h8 h9 h10 p3 p4 p5 p6 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p3b
      INTEGER p4b
      INTEGER p5b
      INTEGER p6b
      INTEGER h7b
      INTEGER h8b
      INTEGER h9b
      INTEGER h10b
      INTEGER p3b_1
      INTEGER p4b_1
      INTEGER p5b_1
      INTEGER p6b_1
      INTEGER h7b_1
      INTEGER h8b_1
      INTEGER h9b_1
      INTEGER h10b_1
      INTEGER h7b_2
      INTEGER h8b_2
      INTEGER h9b_2
      INTEGER h10b_2
      INTEGER p3b_2
      INTEGER p4b_2
      INTEGER p5b_2
      INTEGER p6b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(4)
      INTEGER isuperp
      INTEGER nsubh(4)
      INTEGER isubh
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      IF (next .eq. count) THEN
      IF (0 .eq. ieor(irrep_y,irrep_x)) THEN
      dimc = 1
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_6_4',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      DO p5b = p4b,noab+nvab
      DO p6b = p5b,noab+nvab
      DO h7b = 1,noab
      DO h8b = h7b,noab
      DO h9b = h8b,noab
      DO h10b = h9b,noab
      IF (int_mb(k_active+p3b-1)+int_mb(k_active+p4b-1)+int_mb(k_active+
     &p5b-1)+int_mb(k_active+p6b-1) .ge. numacq) THEN
      IF (int_mb(k_active+h7b-1)+int_mb(k_active+h8b-1)+int_mb(k_active+
     &h9b-1)+int_mb(k_active+h10b-1) .ge. numacq) THEN
      IF (int_mb(k_active+h7b-1)+int_mb(k_active+h8b-1)+int_mb(k_active+
     &h9b-1)+int_mb(k_active+h10b-1) .ge. numacq) THEN
      IF (int_mb(k_active+p3b-1)+int_mb(k_active+p4b-1)+int_mb(k_active+
     &p5b-1)+int_mb(k_active+p6b-1) .ge. numacq) THEN
      IF (int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1)+int_mb(k_spin+p5b-1)
     &+int_mb(k_spin+p6b-1) .eq. int_mb(k_spin+h7b-1)+int_mb(k_spin+h8b-
     &1)+int_mb(k_spin+h9b-1)+int_mb(k_spin+h10b-1)) THEN
      IF (ieor(int_mb(k_sym+p3b-1),ieor(int_mb(k_sym+p4b-1),ieor(int_mb(
     &k_sym+p5b-1),ieor(int_mb(k_sym+p6b-1),ieor(int_mb(k_sym+h7b-1),ieo
     &r(int_mb(k_sym+h8b-1),ieor(int_mb(k_sym+h9b-1),int_mb(k_sym+h10b-1
     &)))))))) .eq. irrep_x) THEN
      CALL TCE_RESTRICTED_8(p3b,p4b,p5b,p6b,h7b,h8b,h9b,h10b,p3b_1,p4b_1
     &,p5b_1,p6b_1,h7b_1,h8b_1,h9b_1,h10b_1)
      CALL TCE_RESTRICTED_8(h7b,h8b,h9b,h10b,p3b,p4b,p5b,p6b,h7b_2,h8b_2
     &,h9b_2,h10b_2,p3b_2,p4b_2,p5b_2,p6b_2)
      dim_common = int_mb(k_range+p3b-1) * int_mb(k_range+p4b-1) * int_m
     &b(k_range+p5b-1) * int_mb(k_range+p6b-1) * int_mb(k_range+h7b-1) *
     & int_mb(k_range+h8b-1) * int_mb(k_range+h9b-1) * int_mb(k_range+h1
     &0b-1)
      dima_sort = 1
      dima = dim_common * dima_sort
      dimb_sort = 1
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_6_4',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_6_4',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h10b_
     &1 - 1 + noab * (h9b_1 - 1 + noab * (h8b_1 - 1 + noab * (h7b_1 - 1 
     &+ noab * (p6b_1 - noab - 1 + nvab * (p5b_1 - noab - 1 + nvab * (p4
     &b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h10b-1),8,7,6,5,4,3,2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_6_4
     &',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_6_4',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_6_4',5,MA_ERR)
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h9b_2 - 
     &1 + noab * (h8b_2 - 1 + noab * (h7b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h9b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+p6b-1),4,3,2,1,8,7,6,5,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_6_4
     &',6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      nsuperp(3) = 1
      nsuperp(4) = 1
      isuperp = 1
      IF (p3b .eq. p4b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      IF (p4b .eq. p5b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      IF (p5b .eq. p6b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      nsubh(1) = 1
      nsubh(2) = 1
      nsubh(3) = 1
      nsubh(4) = 1
      isubh = 1
      IF (h7b .eq. h8b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      IF (h8b .eq. h9b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      IF (h9b .eq. h10b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,576.0d0/FACT
     &ORIAL(nsuperp(1))/FACTORIAL(nsuperp(2))/FACTORIAL(nsuperp(3))/FACT
     &ORIAL(nsuperp(4))/FACTORIAL(nsubh(1))/FACTORIAL(nsubh(2))/FACTORIA
     &L(nsubh(3))/FACTORIAL(nsubh(4)),dbl_mb(k_a_sort),dim_common,dbl_mb
     &(k_b_sort),dim_common,1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_6_4',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_6_4',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_6_4',9,MA_ERR)
      CALL TCE_SORT_0(dbl_mb(k_c_sort),dbl_mb(k_c),1.0d0/576.0d0,.false.
     &)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),0)
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_6_4
     &',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_6_4',11,MA_ERR)
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_7(d_a,k_a_offset,d_b,k_b_offset,d_
     &c,k_c_offset)
C     i1 ( p12 h11 )_ytx + = -1/2 * Sum ( h1 h2 p13 ) * x ( p12 p13 h1 h2 )_x * i2 ( h1 h2 h11 p13 )_yt
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER p12b
      INTEGER h11b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p13b
      INTEGER h1b
      INTEGER h2b
      INTEGER p12b_1
      INTEGER p13b_1
      INTEGER h1b_1
      INTEGER h2b_1
      INTEGER h1b_2
      INTEGER h2b_2
      INTEGER h11b_2
      INTEGER p13b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsubh(2)
      INTEGER isubh
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO p12b = noab+1,noab+nvab
      DO h11b = 1,noab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+p12b-1)+int_mb(k_spin+h11b
     &-1).ne.4)) THEN
      IF (int_mb(k_spin+p12b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+p12b-1),int_mb(k_sym+h11b-1)) .eq. ieor(irre
     &p_y,ieor(irrep_t,irrep_x))) THEN
      dimc = int_mb(k_range+p12b-1) * int_mb(k_range+h11b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_7',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p13b = noab+1,noab+nvab
      DO h1b = 1,noab
      DO h2b = h1b,noab
      IF (int_mb(k_spin+p12b-1)+int_mb(k_spin+p13b-1) .eq. int_mb(k_spin
     &+h1b-1)+int_mb(k_spin+h2b-1)) THEN
      IF (ieor(int_mb(k_sym+p12b-1),ieor(int_mb(k_sym+p13b-1),ieor(int_m
     &b(k_sym+h1b-1),int_mb(k_sym+h2b-1)))) .eq. irrep_x) THEN
      CALL TCE_RESTRICTED_4(p12b,p13b,h1b,h2b,p12b_1,p13b_1,h1b_1,h2b_1)
      CALL TCE_RESTRICTED_4(h1b,h2b,h11b,p13b,h1b_2,h2b_2,h11b_2,p13b_2)
      dim_common = int_mb(k_range+p13b-1) * int_mb(k_range+h1b-1) * int_
     &mb(k_range+h2b-1)
      dima_sort = int_mb(k_range+p12b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h11b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_7',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_7',2,MA_ERR)
      IF ((p13b .lt. p12b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h2b_1
     & - 1 + noab * (h1b_1 - 1 + noab * (p12b_1 - noab - 1 + nvab * (p13
     &b_1 - noab - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p13b-1
     &),int_mb(k_range+p12b-1),int_mb(k_range+h1b-1),int_mb(k_range+h2b-
     &1),2,4,3,1,-1.0d0,.false.)
      END IF
      IF ((p12b .le. p13b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h2b_1
     & - 1 + noab * (h1b_1 - 1 + noab * (p13b_1 - noab - 1 + nvab * (p12
     &b_1 - noab - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p12b-1
     &),int_mb(k_range+p13b-1),int_mb(k_range+h1b-1),int_mb(k_range+h2b-
     &1),1,4,3,2,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_7',
     &3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_7',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_7',5,MA_ERR)
      IF ((h11b .le. p13b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p13b_
     &2 - noab - 1 + nvab * (h11b_2 - 1 + noab * (h2b_2 - 1 + noab * (h1
     &b_2 - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h11b-1),int_mb(k_range+p13b-
     &1),3,2,1,4,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_7',
     &6,MA_ERR)
      nsubh(1) = 1
      nsubh(2) = 1
      isubh = 1
      IF (h1b .eq. h2b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,2.0d0/FACTOR
     &IAL(nsubh(1))/FACTORIAL(nsubh(2)),dbl_mb(k_a_sort),dim_common,dbl_
     &mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_7',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_7',8,MA_ERR)
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_7',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+h11b-1
     &),int_mb(k_range+p12b-1),2,1,-1.0d0/2.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(h11b 
     &- 1 + noab * (p12b - noab - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_7',
     &10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_7',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_7_1(d_a,k_a_offset,d_b,k_b_offset,
     &d_c,k_c_offset)
C     i2 ( h1 h2 h11 p13 )_yt + = 1 * Sum ( p3 ) * t ( p3 h11 )_t * y ( h1 h2 p3 p13 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h1b
      INTEGER h2b
      INTEGER h11b
      INTEGER p13b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p3b
      INTEGER p3b_1
      INTEGER h11b_1
      INTEGER h1b_2
      INTEGER h2b_2
      INTEGER p13b_2
      INTEGER p3b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h1b = 1,noab
      DO h2b = h1b,noab
      DO h11b = 1,noab
      DO p13b = noab+1,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h1b-1)+int_mb(k_spin+h2b-1
     &)+int_mb(k_spin+h11b-1)+int_mb(k_spin+p13b-1).ne.8)) THEN
      IF (int_mb(k_spin+h1b-1)+int_mb(k_spin+h2b-1) .eq. int_mb(k_spin+h
     &11b-1)+int_mb(k_spin+p13b-1)) THEN
      IF (ieor(int_mb(k_sym+h1b-1),ieor(int_mb(k_sym+h2b-1),ieor(int_mb(
     &k_sym+h11b-1),int_mb(k_sym+p13b-1)))) .eq. ieor(irrep_y,irrep_t)) 
     &THEN
      dimc = int_mb(k_range+h1b-1) * int_mb(k_range+h2b-1) * int_mb(k_ra
     &nge+h11b-1) * int_mb(k_range+p13b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_7_1',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p3b = noab+1,noab+nvab
      IF (int_mb(k_spin+p3b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+p3b-1),int_mb(k_sym+h11b-1)) .eq. irrep_t) T
     &HEN
      CALL TCE_RESTRICTED_2(p3b,h11b,p3b_1,h11b_1)
      CALL TCE_RESTRICTED_4(h1b,h2b,p13b,p3b,h1b_2,h2b_2,p13b_2,p3b_2)
      dim_common = int_mb(k_range+p3b-1)
      dima_sort = int_mb(k_range+h11b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h1b-1) * int_mb(k_range+h2b-1) * int_mb
     &(k_range+p13b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_7_1',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_7_1',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h11b_
     &1 - 1 + noab * (p3b_1 - noab - 1)))
      CALL TCE_SORT_2(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+h11b-1),2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_7_1
     &',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_7_1',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_7_1',5,MA_ERR)
      IF ((p3b .le. p13b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p13b_
     &2 - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (h2b_2 - 1 + noab
     & * (h1b_2 - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+p3b-1),int_mb(k_range+p13b-1
     &),4,2,1,3,1.0d0,.false.)
      END IF
      IF ((p13b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p13b_2 - noab - 1 + nvab * (h2b_2 - 1 + noab
     & * (h1b_2 - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+p13b-1),int_mb(k_range+p3b-1
     &),3,2,1,4,-1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_7_1
     &',6,MA_ERR)
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,1.0d0,dbl_mb
     &(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c
     &_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_7_1',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_7_1',8,MA_ERR)
      END IF
      END IF
      END IF
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_7_1',9,MA_ERR)
      CALL TCE_SORT_4(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p13b-1
     &),int_mb(k_range+h2b-1),int_mb(k_range+h1b-1),int_mb(k_range+h11b-
     &1),3,2,4,1,1.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p13b 
     &- noab - 1 + nvab * (h11b - 1 + noab * (h2b - 1 + noab * (h1b - 1)
     &))))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_7_1
     &',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_7_1',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE OFFSET_eomccsdtq_density1_5_7_1(l_a_offset,k_a_offset,s
     &ize)
C     i2 ( h1 h2 h11 p13 )_yt
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER l_a_offset
      INTEGER k_a_offset
      INTEGER length
      INTEGER addr
      INTEGER h1b
      INTEGER h2b
      INTEGER h11b
      INTEGER p13b
      DOUBLE PRECISION size
      length = 0
      DO h1b = 1,noab
      DO h2b = h1b,noab
      DO h11b = 1,noab
      DO p13b = noab+1,noab+nvab
      IF (int_mb(k_spin+h1b-1)+int_mb(k_spin+h2b-1) .eq. int_mb(k_spin+h
     &11b-1)+int_mb(k_spin+p13b-1)) THEN
      IF (ieor(int_mb(k_sym+h1b-1),ieor(int_mb(k_sym+h2b-1),ieor(int_mb(
     &k_sym+h11b-1),int_mb(k_sym+p13b-1)))) .eq. ieor(irrep_y,irrep_t)) 
     &THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h1b-1)+int_mb(k_spin+h2b-1
     &)+int_mb(k_spin+h11b-1)+int_mb(k_spin+p13b-1).ne.8)) THEN
      length = length + 1
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,2*length+1,'noname',l_a_offset,k_a_off
     &set)) CALL ERRQUIT('eomccsdtq_density1_5_7_1',0,MA_ERR)
      dbl_mb(k_a_offset) = dfloat(length)
      addr = 0
      size = 0.0d0
      DO h1b = 1,noab
      DO h2b = h1b,noab
      DO h11b = 1,noab
      DO p13b = noab+1,noab+nvab
      IF (int_mb(k_spin+h1b-1)+int_mb(k_spin+h2b-1) .eq. int_mb(k_spin+h
     &11b-1)+int_mb(k_spin+p13b-1)) THEN
      IF (ieor(int_mb(k_sym+h1b-1),ieor(int_mb(k_sym+h2b-1),ieor(int_mb(
     &k_sym+h11b-1),int_mb(k_sym+p13b-1)))) .eq. ieor(irrep_y,irrep_t)) 
     &THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h1b-1)+int_mb(k_spin+h2b-1
     &)+int_mb(k_spin+h11b-1)+int_mb(k_spin+p13b-1).ne.8)) THEN
      addr = addr + 1
      dbl_mb(k_a_offset+addr) = dfloat(p13b - noab - 1 + nvab * (h11b - 
     &1 + noab * (h2b - 1 + noab * (h1b - 1))))
      dbl_mb(k_a_offset+length+addr) = size
      size = size + dfloat(int_mb(k_range+h1b-1)) * dfloat(int_mb(k_rang
     &e+h2b-1)) * dfloat(int_mb(k_range+h11b-1)) * dfloat(int_mb(k_range
     &+p13b-1))
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_7_2(d_a,k_a_offset,d_b,k_b_offset,
     &d_c,k_c_offset)
C     i2 ( h1 h2 h11 p13 )_yt + = 1/2 * Sum ( h5 p4 p3 ) * t ( p3 p4 h5 h11 )_t * y ( h1 h2 h5 p3 p4 p13 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h1b
      INTEGER h2b
      INTEGER h11b
      INTEGER p13b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p3b
      INTEGER p4b
      INTEGER h5b
      INTEGER p3b_1
      INTEGER p4b_1
      INTEGER h11b_1
      INTEGER h5b_1
      INTEGER h1b_2
      INTEGER h2b_2
      INTEGER h5b_2
      INTEGER p13b_2
      INTEGER p3b_2
      INTEGER p4b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(2)
      INTEGER isuperp
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h1b = 1,noab
      DO h2b = h1b,noab
      DO h11b = 1,noab
      DO p13b = noab+1,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h1b-1)+int_mb(k_spin+h2b-1
     &)+int_mb(k_spin+h11b-1)+int_mb(k_spin+p13b-1).ne.8)) THEN
      IF (int_mb(k_spin+h1b-1)+int_mb(k_spin+h2b-1) .eq. int_mb(k_spin+h
     &11b-1)+int_mb(k_spin+p13b-1)) THEN
      IF (ieor(int_mb(k_sym+h1b-1),ieor(int_mb(k_sym+h2b-1),ieor(int_mb(
     &k_sym+h11b-1),int_mb(k_sym+p13b-1)))) .eq. ieor(irrep_y,irrep_t)) 
     &THEN
      dimc = int_mb(k_range+h1b-1) * int_mb(k_range+h2b-1) * int_mb(k_ra
     &nge+h11b-1) * int_mb(k_range+p13b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_7_2',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      DO h5b = 1,noab
      IF (int_mb(k_active+h1b-1)+int_mb(k_active+h2b-1)+int_mb(k_active+
     &h5b-1) .ge. numact) THEN
      IF (int_mb(k_active+p13b-1)+int_mb(k_active+p3b-1)+int_mb(k_active
     &+p4b-1) .ge. numact) THEN
      IF (int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1) .eq. int_mb(k_spin+h
     &11b-1)+int_mb(k_spin+h5b-1)) THEN
      IF (ieor(int_mb(k_sym+p3b-1),ieor(int_mb(k_sym+p4b-1),ieor(int_mb(
     &k_sym+h11b-1),int_mb(k_sym+h5b-1)))) .eq. irrep_t) THEN
      CALL TCE_RESTRICTED_4(p3b,p4b,h11b,h5b,p3b_1,p4b_1,h11b_1,h5b_1)
      CALL TCE_RESTRICTED_6(h1b,h2b,h5b,p13b,p3b,p4b,h1b_2,h2b_2,h5b_2,p
     &13b_2,p3b_2,p4b_2)
      dim_common = int_mb(k_range+p3b-1) * int_mb(k_range+p4b-1) * int_m
     &b(k_range+h5b-1)
      dima_sort = int_mb(k_range+h11b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h1b-1) * int_mb(k_range+h2b-1) * int_mb
     &(k_range+p13b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_7_2',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_7_2',2,MA_ERR)
      IF ((h5b .le. h11b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h11b_
     &1 - 1 + noab * (h5b_1 - 1 + noab * (p4b_1 - noab - 1 + nvab * (p3b
     &_1 - noab - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+h5b-1),int_mb(k_range+h11b-1
     &),4,3,2,1,1.0d0,.false.)
      END IF
      IF ((h11b .lt. h5b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h5b_1
     & - 1 + noab * (h11b_1 - 1 + noab * (p4b_1 - noab - 1 + nvab * (p3b
     &_1 - noab - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+h11b-1),int_mb(k_range+h5b-1
     &),3,4,2,1,-1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_7_2
     &',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_7_2',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_7_2',5,MA_ERR)
      IF ((h5b .lt. h1b) .and. (p4b .le. p13b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p13b_
     &2 - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1
     & + nvab * (h2b_2 - 1 + noab * (h1b_2 - 1 + noab * (h5b_2 - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h1b-1),int_mb(k_range+h2b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p13b-1),6,3,2,1,5,4,1.0d0,.f
     &alse.)
      END IF
      IF ((h5b .lt. h1b) .and. (p3b .le. p13b) .and. (p13b .lt. p4b)) TH
     &EN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p13b_2 - noab - 1 + nvab * (p3b_2 - noab - 1
     & + nvab * (h2b_2 - 1 + noab * (h1b_2 - 1 + noab * (h5b_2 - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h1b-1),int_mb(k_range+h2b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p13b-1),int_mb(k_range+p4b-1),5,3,2,1,6,4,-1.0d0,.
     &false.)
      END IF
      IF ((h5b .lt. h1b) .and. (p13b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p13b_2 - noab - 1
     & + nvab * (h2b_2 - 1 + noab * (h1b_2 - 1 + noab * (h5b_2 - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h1b-1),int_mb(k_range+h2b-1),int_mb(k_range+p13b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),4,3,2,1,6,5,1.0d0,.f
     &alse.)
      END IF
      IF ((h1b .le. h5b) .and. (h5b .lt. h2b) .and. (p4b .le. p13b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p13b_
     &2 - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1
     & + nvab * (h2b_2 - 1 + noab * (h5b_2 - 1 + noab * (h1b_2 - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h2b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p13b-1),6,3,1,2,5,4,-1.0d0,.
     &false.)
      END IF
      IF ((h1b .le. h5b) .and. (h5b .lt. h2b) .and. (p3b .le. p13b) .and
     &. (p13b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p13b_2 - noab - 1 + nvab * (p3b_2 - noab - 1
     & + nvab * (h2b_2 - 1 + noab * (h5b_2 - 1 + noab * (h1b_2 - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h2b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p13b-1),int_mb(k_range+p4b-1),5,3,1,2,6,4,1.0d0,.f
     &alse.)
      END IF
      IF ((h1b .le. h5b) .and. (h5b .lt. h2b) .and. (p13b .lt. p3b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p13b_2 - noab - 1
     & + nvab * (h2b_2 - 1 + noab * (h5b_2 - 1 + noab * (h1b_2 - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h2b-1),int_mb(k_range+p13b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),4,3,1,2,6,5,-1.0d0,.
     &false.)
      END IF
      IF ((h2b .le. h5b) .and. (p4b .le. p13b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p13b_
     &2 - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1
     & + nvab * (h5b_2 - 1 + noab * (h2b_2 - 1 + noab * (h1b_2 - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h5b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p13b-1),6,2,1,3,5,4,1.0d0,.f
     &alse.)
      END IF
      IF ((h2b .le. h5b) .and. (p3b .le. p13b) .and. (p13b .lt. p4b)) TH
     &EN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p13b_2 - noab - 1 + nvab * (p3b_2 - noab - 1
     & + nvab * (h5b_2 - 1 + noab * (h2b_2 - 1 + noab * (h1b_2 - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h5b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p13b-1),int_mb(k_range+p4b-1),5,2,1,3,6,4,-1.0d0,.
     &false.)
      END IF
      IF ((h2b .le. h5b) .and. (p13b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p13b_2 - noab - 1
     & + nvab * (h5b_2 - 1 + noab * (h2b_2 - 1 + noab * (h1b_2 - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h5b-1),int_mb(k_range+p13b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),4,2,1,3,6,5,1.0d0,.f
     &alse.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_7_2
     &',6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      isuperp = 1
      IF (p3b .eq. p4b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,2.0d0/FACTOR
     &IAL(nsuperp(1))/FACTORIAL(nsuperp(2)),dbl_mb(k_a_sort),dim_common,
     &dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_7_2',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_7_2',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_7_2',9,MA_ERR)
      CALL TCE_SORT_4(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p13b-1
     &),int_mb(k_range+h2b-1),int_mb(k_range+h1b-1),int_mb(k_range+h11b-
     &1),3,2,4,1,1.0d0/2.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p13b 
     &- noab - 1 + nvab * (h11b - 1 + noab * (h2b - 1 + noab * (h1b - 1)
     &))))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_7_2
     &',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_7_2',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_7_3(d_a,k_a_offset,d_b,k_b_offset,
     &d_c,k_c_offset)
C     i2 ( h1 h2 h11 p13 )_yt + = 1/12 * Sum ( h7 h6 p5 p4 p3 ) * t ( p3 p4 p5 h6 h7 h11 )_t * y ( h1 h2 h6 h7 p3 p4 p5 p13 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h1b
      INTEGER h2b
      INTEGER h11b
      INTEGER p13b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p3b
      INTEGER p4b
      INTEGER p5b
      INTEGER h6b
      INTEGER h7b
      INTEGER p3b_1
      INTEGER p4b_1
      INTEGER p5b_1
      INTEGER h11b_1
      INTEGER h6b_1
      INTEGER h7b_1
      INTEGER h1b_2
      INTEGER h2b_2
      INTEGER h6b_2
      INTEGER h7b_2
      INTEGER p13b_2
      INTEGER p3b_2
      INTEGER p4b_2
      INTEGER p5b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(3)
      INTEGER isuperp
      INTEGER nsubh(2)
      INTEGER isubh
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h1b = 1,noab
      DO h2b = h1b,noab
      DO h11b = 1,noab
      DO p13b = noab+1,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h1b-1)+int_mb(k_spin+h2b-1
     &)+int_mb(k_spin+h11b-1)+int_mb(k_spin+p13b-1).ne.8)) THEN
      IF (int_mb(k_spin+h1b-1)+int_mb(k_spin+h2b-1) .eq. int_mb(k_spin+h
     &11b-1)+int_mb(k_spin+p13b-1)) THEN
      IF (ieor(int_mb(k_sym+h1b-1),ieor(int_mb(k_sym+h2b-1),ieor(int_mb(
     &k_sym+h11b-1),int_mb(k_sym+p13b-1)))) .eq. ieor(irrep_y,irrep_t)) 
     &THEN
      dimc = int_mb(k_range+h1b-1) * int_mb(k_range+h2b-1) * int_mb(k_ra
     &nge+h11b-1) * int_mb(k_range+p13b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_7_3',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      DO p5b = p4b,noab+nvab
      DO h6b = 1,noab
      DO h7b = h6b,noab
      IF (int_mb(k_active+p3b-1)+int_mb(k_active+p4b-1)+int_mb(k_active+
     &p5b-1) .ge. numact) THEN
      IF (int_mb(k_active+h11b-1)+int_mb(k_active+h6b-1)+int_mb(k_active
     &+h7b-1) .ge. numact) THEN
      IF (int_mb(k_active+h1b-1)+int_mb(k_active+h2b-1)+int_mb(k_active+
     &h6b-1)+int_mb(k_active+h7b-1) .ge. numacq) THEN
      IF (int_mb(k_active+p13b-1)+int_mb(k_active+p3b-1)+int_mb(k_active
     &+p4b-1)+int_mb(k_active+p5b-1) .ge. numacq) THEN
      IF (int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1)+int_mb(k_spin+p5b-1)
     & .eq. int_mb(k_spin+h11b-1)+int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b
     &-1)) THEN
      IF (ieor(int_mb(k_sym+p3b-1),ieor(int_mb(k_sym+p4b-1),ieor(int_mb(
     &k_sym+p5b-1),ieor(int_mb(k_sym+h11b-1),ieor(int_mb(k_sym+h6b-1),in
     &t_mb(k_sym+h7b-1)))))) .eq. irrep_t) THEN
      CALL TCE_RESTRICTED_6(p3b,p4b,p5b,h11b,h6b,h7b,p3b_1,p4b_1,p5b_1,h
     &11b_1,h6b_1,h7b_1)
      CALL TCE_RESTRICTED_8(h1b,h2b,h6b,h7b,p13b,p3b,p4b,p5b,h1b_2,h2b_2
     &,h6b_2,h7b_2,p13b_2,p3b_2,p4b_2,p5b_2)
      dim_common = int_mb(k_range+p3b-1) * int_mb(k_range+p4b-1) * int_m
     &b(k_range+p5b-1) * int_mb(k_range+h6b-1) * int_mb(k_range+h7b-1)
      dima_sort = int_mb(k_range+h11b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h1b-1) * int_mb(k_range+h2b-1) * int_mb
     &(k_range+p13b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_7_3',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_7_3',2,MA_ERR)
      IF ((h7b .le. h11b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h11b_
     &1 - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 + noab * (p5b_1 - no
     &ab - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h11b-1),6,5,4,3,2,1,1.0d0,.f
     &alse.)
      END IF
      IF ((h6b .le. h11b) .and. (h11b .lt. h7b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h7b_1
     & - 1 + noab * (h11b_1 - 1 + noab * (h6b_1 - 1 + noab * (p5b_1 - no
     &ab - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h11b-1),int_mb(k_range+h7b-1),5,6,4,3,2,1,-1.0d0,.
     &false.)
      END IF
      IF ((h11b .lt. h6b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h7b_1
     & - 1 + noab * (h6b_1 - 1 + noab * (h11b_1 - 1 + noab * (p5b_1 - no
     &ab - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+h11b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),4,6,5,3,2,1,1.0d0,.f
     &alse.)
      END IF
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_7_3
     &',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_7_3',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_7_3',5,MA_ERR)
      IF ((h7b .lt. h1b) .and. (p5b .le. p13b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p13b_
     &2 - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1
     & + nvab * (p3b_2 - noab - 1 + nvab * (h2b_2 - 1 + noab * (h1b_2 - 
     &1 + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h1b-1),int_mb(k_range+h2b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p13b-1),8,4,3,2,1,7,6,5,1.0d0,.false.)
      END IF
      IF ((h7b .lt. h1b) .and. (p4b .le. p13b) .and. (p13b .lt. p5b)) TH
     &EN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p13b_2 - noab - 1 + nvab * (p4b_2 - noab - 1
     & + nvab * (p3b_2 - noab - 1 + nvab * (h2b_2 - 1 + noab * (h1b_2 - 
     &1 + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h1b-1),int_mb(k_range+h2b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p13b-1
     &),int_mb(k_range+p5b-1),7,4,3,2,1,8,6,5,-1.0d0,.false.)
      END IF
      IF ((h7b .lt. h1b) .and. (p3b .le. p13b) .and. (p13b .lt. p4b)) TH
     &EN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p13b_2 - noab - 1
     & + nvab * (p3b_2 - noab - 1 + nvab * (h2b_2 - 1 + noab * (h1b_2 - 
     &1 + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h1b-1),int_mb(k_range+h2b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p13b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p5b-1),6,4,3,2,1,8,7,5,1.0d0,.false.)
      END IF
      IF ((h7b .lt. h1b) .and. (p13b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p13b_2 - noab - 1 + nvab * (h2b_2 - 1 + noab * (h1b_2 - 
     &1 + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h1b-1),int_mb(k_range+h2b-1)
     &,int_mb(k_range+p13b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p5b-1),5,4,3,2,1,8,7,6,-1.0d0,.false.)
      END IF
      IF ((h6b .lt. h1b) .and. (h1b .le. h7b) .and. (h7b .lt. h2b) .and.
     & (p5b .le. p13b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p13b_
     &2 - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1
     & + nvab * (p3b_2 - noab - 1 + nvab * (h2b_2 - 1 + noab * (h7b_2 - 
     &1 + noab * (h1b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h1b-1),int_mb(k_range+h7b-1),int_mb(k_range+h2b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p13b-1),8,4,2,3,1,7,6,5,-1.0d0,.false.)
      END IF
      IF ((h6b .lt. h1b) .and. (h1b .le. h7b) .and. (h7b .lt. h2b) .and.
     & (p4b .le. p13b) .and. (p13b .lt. p5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p13b_2 - noab - 1 + nvab * (p4b_2 - noab - 1
     & + nvab * (p3b_2 - noab - 1 + nvab * (h2b_2 - 1 + noab * (h7b_2 - 
     &1 + noab * (h1b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h1b-1),int_mb(k_range+h7b-1),int_mb(k_range+h2b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p13b-1
     &),int_mb(k_range+p5b-1),7,4,2,3,1,8,6,5,1.0d0,.false.)
      END IF
      IF ((h6b .lt. h1b) .and. (h1b .le. h7b) .and. (h7b .lt. h2b) .and.
     & (p3b .le. p13b) .and. (p13b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p13b_2 - noab - 1
     & + nvab * (p3b_2 - noab - 1 + nvab * (h2b_2 - 1 + noab * (h7b_2 - 
     &1 + noab * (h1b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h1b-1),int_mb(k_range+h7b-1),int_mb(k_range+h2b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p13b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p5b-1),6,4,2,3,1,8,7,5,-1.0d0,.false.)
      END IF
      IF ((h6b .lt. h1b) .and. (h1b .le. h7b) .and. (h7b .lt. h2b) .and.
     & (p13b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p13b_2 - noab - 1 + nvab * (h2b_2 - 1 + noab * (h7b_2 - 
     &1 + noab * (h1b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h1b-1),int_mb(k_range+h7b-1),int_mb(k_range+h2b-1)
     &,int_mb(k_range+p13b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p5b-1),5,4,2,3,1,8,7,6,1.0d0,.false.)
      END IF
      IF ((h6b .lt. h1b) .and. (h2b .le. h7b) .and. (p5b .le. p13b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p13b_
     &2 - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1
     & + nvab * (p3b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h2b_2 - 
     &1 + noab * (h1b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h1b-1),int_mb(k_range+h2b-1),int_mb(k_range+h7b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p13b-1),8,3,2,4,1,7,6,5,1.0d0,.false.)
      END IF
      IF ((h6b .lt. h1b) .and. (h2b .le. h7b) .and. (p4b .le. p13b) .and
     &. (p13b .lt. p5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p13b_2 - noab - 1 + nvab * (p4b_2 - noab - 1
     & + nvab * (p3b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h2b_2 - 
     &1 + noab * (h1b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h1b-1),int_mb(k_range+h2b-1),int_mb(k_range+h7b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p13b-1
     &),int_mb(k_range+p5b-1),7,3,2,4,1,8,6,5,-1.0d0,.false.)
      END IF
      IF ((h6b .lt. h1b) .and. (h2b .le. h7b) .and. (p3b .le. p13b) .and
     &. (p13b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p13b_2 - noab - 1
     & + nvab * (p3b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h2b_2 - 
     &1 + noab * (h1b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h1b-1),int_mb(k_range+h2b-1),int_mb(k_range+h7b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p13b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p5b-1),6,3,2,4,1,8,7,5,1.0d0,.false.)
      END IF
      IF ((h6b .lt. h1b) .and. (h2b .le. h7b) .and. (p13b .lt. p3b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p13b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h2b_2 - 
     &1 + noab * (h1b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h1b-1),int_mb(k_range+h2b-1),int_mb(k_range+h7b-1)
     &,int_mb(k_range+p13b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p5b-1),5,3,2,4,1,8,7,6,-1.0d0,.false.)
      END IF
      IF ((h1b .le. h6b) .and. (h7b .lt. h2b) .and. (p5b .le. p13b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p13b_
     &2 - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1
     & + nvab * (p3b_2 - noab - 1 + nvab * (h2b_2 - 1 + noab * (h7b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h1b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h2b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p13b-1),8,4,1,3,2,7,6,5,1.0d0,.false.)
      END IF
      IF ((h1b .le. h6b) .and. (h7b .lt. h2b) .and. (p4b .le. p13b) .and
     &. (p13b .lt. p5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p13b_2 - noab - 1 + nvab * (p4b_2 - noab - 1
     & + nvab * (p3b_2 - noab - 1 + nvab * (h2b_2 - 1 + noab * (h7b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h1b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h2b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p13b-1
     &),int_mb(k_range+p5b-1),7,4,1,3,2,8,6,5,-1.0d0,.false.)
      END IF
      IF ((h1b .le. h6b) .and. (h7b .lt. h2b) .and. (p3b .le. p13b) .and
     &. (p13b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p13b_2 - noab - 1
     & + nvab * (p3b_2 - noab - 1 + nvab * (h2b_2 - 1 + noab * (h7b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h1b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h2b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p13b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p5b-1),6,4,1,3,2,8,7,5,1.0d0,.false.)
      END IF
      IF ((h1b .le. h6b) .and. (h7b .lt. h2b) .and. (p13b .lt. p3b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p13b_2 - noab - 1 + nvab * (h2b_2 - 1 + noab * (h7b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h1b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h2b-1)
     &,int_mb(k_range+p13b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p5b-1),5,4,1,3,2,8,7,6,-1.0d0,.false.)
      END IF
      IF ((h1b .le. h6b) .and. (h6b .lt. h2b) .and. (h2b .le. h7b) .and.
     & (p5b .le. p13b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p13b_
     &2 - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1
     & + nvab * (p3b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h2b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h1b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h2b-1),int_mb(k_range+h7b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p13b-1),8,3,1,4,2,7,6,5,-1.0d0,.false.)
      END IF
      IF ((h1b .le. h6b) .and. (h6b .lt. h2b) .and. (h2b .le. h7b) .and.
     & (p4b .le. p13b) .and. (p13b .lt. p5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p13b_2 - noab - 1 + nvab * (p4b_2 - noab - 1
     & + nvab * (p3b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h2b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h1b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h2b-1),int_mb(k_range+h7b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p13b-1
     &),int_mb(k_range+p5b-1),7,3,1,4,2,8,6,5,1.0d0,.false.)
      END IF
      IF ((h1b .le. h6b) .and. (h6b .lt. h2b) .and. (h2b .le. h7b) .and.
     & (p3b .le. p13b) .and. (p13b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p13b_2 - noab - 1
     & + nvab * (p3b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h2b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h1b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h2b-1),int_mb(k_range+h7b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p13b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p5b-1),6,3,1,4,2,8,7,5,-1.0d0,.false.)
      END IF
      IF ((h1b .le. h6b) .and. (h6b .lt. h2b) .and. (h2b .le. h7b) .and.
     & (p13b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p13b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h2b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h1b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h2b-1),int_mb(k_range+h7b-1)
     &,int_mb(k_range+p13b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p5b-1),5,3,1,4,2,8,7,6,1.0d0,.false.)
      END IF
      IF ((h2b .le. h6b) .and. (p5b .le. p13b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p13b_
     &2 - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1
     & + nvab * (p3b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 
     &1 + noab * (h2b_2 - 1 + noab * (h1b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p13b-1),8,2,1,4,3,7,6,5,1.0d0,.false.)
      END IF
      IF ((h2b .le. h6b) .and. (p4b .le. p13b) .and. (p13b .lt. p5b)) TH
     &EN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p13b_2 - noab - 1 + nvab * (p4b_2 - noab - 1
     & + nvab * (p3b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 
     &1 + noab * (h2b_2 - 1 + noab * (h1b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p13b-1
     &),int_mb(k_range+p5b-1),7,2,1,4,3,8,6,5,-1.0d0,.false.)
      END IF
      IF ((h2b .le. h6b) .and. (p3b .le. p13b) .and. (p13b .lt. p4b)) TH
     &EN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p13b_2 - noab - 1
     & + nvab * (p3b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 
     &1 + noab * (h2b_2 - 1 + noab * (h1b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p13b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p5b-1),6,2,1,4,3,8,7,5,1.0d0,.false.)
      END IF
      IF ((h2b .le. h6b) .and. (p13b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p13b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 
     &1 + noab * (h2b_2 - 1 + noab * (h1b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1)
     &,int_mb(k_range+p13b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p5b-1),5,2,1,4,3,8,7,6,-1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_7_3
     &',6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      nsuperp(3) = 1
      isuperp = 1
      IF (p3b .eq. p4b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      IF (p4b .eq. p5b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      nsubh(1) = 1
      nsubh(2) = 1
      isubh = 1
      IF (h6b .eq. h7b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,12.0d0/FACTO
     &RIAL(nsuperp(1))/FACTORIAL(nsuperp(2))/FACTORIAL(nsuperp(3))/FACTO
     &RIAL(nsubh(1))/FACTORIAL(nsubh(2)),dbl_mb(k_a_sort),dim_common,dbl
     &_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_7_3',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_7_3',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_7_3',9,MA_ERR)
      CALL TCE_SORT_4(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p13b-1
     &),int_mb(k_range+h2b-1),int_mb(k_range+h1b-1),int_mb(k_range+h11b-
     &1),3,2,4,1,1.0d0/12.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p13b 
     &- noab - 1 + nvab * (h11b - 1 + noab * (h2b - 1 + noab * (h1b - 1)
     &))))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_7_3
     &',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_7_3',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_8(d_a,k_a_offset,d_b,k_b_offset,d_
     &c,k_c_offset)
C     i1 ( p12 h11 )_ytx + = -1/12 * Sum ( h13 h6 h7 p1 p2 ) * x ( p1 p2 p12 h6 h7 h13 )_x * i2 ( h6 h7 h13 h11 p1 p2 )_yt
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER p12b
      INTEGER h11b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p1b
      INTEGER p2b
      INTEGER h6b
      INTEGER h7b
      INTEGER h13b
      INTEGER p12b_1
      INTEGER p1b_1
      INTEGER p2b_1
      INTEGER h6b_1
      INTEGER h7b_1
      INTEGER h13b_1
      INTEGER h6b_2
      INTEGER h7b_2
      INTEGER h13b_2
      INTEGER h11b_2
      INTEGER p1b_2
      INTEGER p2b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(2)
      INTEGER isuperp
      INTEGER nsubh(3)
      INTEGER isubh
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO p12b = noab+1,noab+nvab
      DO h11b = 1,noab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+p12b-1)+int_mb(k_spin+h11b
     &-1).ne.4)) THEN
      IF (int_mb(k_spin+p12b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+p12b-1),int_mb(k_sym+h11b-1)) .eq. ieor(irre
     &p_y,ieor(irrep_t,irrep_x))) THEN
      dimc = int_mb(k_range+p12b-1) * int_mb(k_range+h11b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_8',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p1b = noab+1,noab+nvab
      DO p2b = p1b,noab+nvab
      DO h6b = 1,noab
      DO h7b = h6b,noab
      DO h13b = h7b,noab
      IF (int_mb(k_active+p12b-1)+int_mb(k_active+p1b-1)+int_mb(k_active
     &+p2b-1) .ge. numact) THEN
      IF (int_mb(k_active+h6b-1)+int_mb(k_active+h7b-1)+int_mb(k_active+
     &h13b-1) .ge. numact) THEN
      IF (int_mb(k_spin+p12b-1)+int_mb(k_spin+p1b-1)+int_mb(k_spin+p2b-1
     &) .eq. int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b-1)+int_mb(k_spin+h13
     &b-1)) THEN
      IF (ieor(int_mb(k_sym+p12b-1),ieor(int_mb(k_sym+p1b-1),ieor(int_mb
     &(k_sym+p2b-1),ieor(int_mb(k_sym+h6b-1),ieor(int_mb(k_sym+h7b-1),in
     &t_mb(k_sym+h13b-1)))))) .eq. irrep_x) THEN
      CALL TCE_RESTRICTED_6(p12b,p1b,p2b,h6b,h7b,h13b,p12b_1,p1b_1,p2b_1
     &,h6b_1,h7b_1,h13b_1)
      CALL TCE_RESTRICTED_6(h6b,h7b,h13b,h11b,p1b,p2b,h6b_2,h7b_2,h13b_2
     &,h11b_2,p1b_2,p2b_2)
      dim_common = int_mb(k_range+p1b-1) * int_mb(k_range+p2b-1) * int_m
     &b(k_range+h6b-1) * int_mb(k_range+h7b-1) * int_mb(k_range+h13b-1)
      dima_sort = int_mb(k_range+p12b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h11b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_8',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_8',2,MA_ERR)
      IF ((p2b .le. p12b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h13b_
     &1 - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 + noab * (p12b_1 - n
     &oab - 1 + nvab * (p2b_1 - noab - 1 + nvab * (p1b_1 - noab - 1)))))
     &))
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p1b-1)
     &,int_mb(k_range+p2b-1),int_mb(k_range+p12b-1),int_mb(k_range+h6b-1
     &),int_mb(k_range+h7b-1),int_mb(k_range+h13b-1),3,6,5,4,2,1,1.0d0,.
     &false.)
      END IF
      IF ((p1b .le. p12b) .and. (p12b .lt. p2b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h13b_
     &1 - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 + noab * (p2b_1 - no
     &ab - 1 + nvab * (p12b_1 - noab - 1 + nvab * (p1b_1 - noab - 1)))))
     &))
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p1b-1)
     &,int_mb(k_range+p12b-1),int_mb(k_range+p2b-1),int_mb(k_range+h6b-1
     &),int_mb(k_range+h7b-1),int_mb(k_range+h13b-1),2,6,5,4,3,1,-1.0d0,
     &.false.)
      END IF
      IF ((p12b .lt. p1b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h13b_
     &1 - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 + noab * (p2b_1 - no
     &ab - 1 + nvab * (p1b_1 - noab - 1 + nvab * (p12b_1 - noab - 1)))))
     &))
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p12b-1
     &),int_mb(k_range+p1b-1),int_mb(k_range+p2b-1),int_mb(k_range+h6b-1
     &),int_mb(k_range+h7b-1),int_mb(k_range+h13b-1),1,6,5,4,3,2,1.0d0,.
     &false.)
      END IF
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_8',
     &3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_8',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_8',5,MA_ERR)
      IF ((h11b .le. p1b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p2b_2
     & - noab - 1 + nvab * (p1b_2 - noab - 1 + nvab * (h11b_2 - 1 + noab
     & * (h13b_2 - 1 + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h13b-1),int_mb(k_range+h11b-
     &1),int_mb(k_range+p1b-1),int_mb(k_range+p2b-1),4,3,2,1,6,5,1.0d0,.
     &false.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_8',
     &6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      isuperp = 1
      IF (p1b .eq. p2b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      nsubh(1) = 1
      nsubh(2) = 1
      nsubh(3) = 1
      isubh = 1
      IF (h6b .eq. h7b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      IF (h7b .eq. h13b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,12.0d0/FACTO
     &RIAL(nsuperp(1))/FACTORIAL(nsuperp(2))/FACTORIAL(nsubh(1))/FACTORI
     &AL(nsubh(2))/FACTORIAL(nsubh(3)),dbl_mb(k_a_sort),dim_common,dbl_m
     &b(k_b_sort),dim_common,1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_8',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_8',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_8',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+h11b-1
     &),int_mb(k_range+p12b-1),2,1,-1.0d0/12.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(h11b 
     &- 1 + noab * (p12b - noab - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_8',
     &10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_8',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_8_1(d_a,k_a_offset,d_b,k_b_offset,
     &d_c,k_c_offset)
C     i2 ( h6 h7 h13 h11 p1 p2 )_yt + = 1 * Sum ( p3 ) * t ( p3 h11 )_t * y ( h6 h7 h13 p1 p2 p3 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h6b
      INTEGER h7b
      INTEGER h13b
      INTEGER h11b
      INTEGER p1b
      INTEGER p2b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p3b
      INTEGER p3b_1
      INTEGER h11b_1
      INTEGER h6b_2
      INTEGER h7b_2
      INTEGER h13b_2
      INTEGER p1b_2
      INTEGER p2b_2
      INTEGER p3b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h6b = 1,noab
      DO h7b = h6b,noab
      DO h13b = h7b,noab
      DO h11b = 1,noab
      DO p1b = noab+1,noab+nvab
      DO p2b = p1b,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b-1
     &)+int_mb(k_spin+h13b-1)+int_mb(k_spin+h11b-1)+int_mb(k_spin+p1b-1)
     &+int_mb(k_spin+p2b-1).ne.12)) THEN
      IF (int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b-1)+int_mb(k_spin+h13b-1
     &) .eq. int_mb(k_spin+h11b-1)+int_mb(k_spin+p1b-1)+int_mb(k_spin+p2
     &b-1)) THEN
      IF (ieor(int_mb(k_sym+h6b-1),ieor(int_mb(k_sym+h7b-1),ieor(int_mb(
     &k_sym+h13b-1),ieor(int_mb(k_sym+h11b-1),ieor(int_mb(k_sym+p1b-1),i
     &nt_mb(k_sym+p2b-1)))))) .eq. ieor(irrep_y,irrep_t)) THEN
      dimc = int_mb(k_range+h6b-1) * int_mb(k_range+h7b-1) * int_mb(k_ra
     &nge+h13b-1) * int_mb(k_range+h11b-1) * int_mb(k_range+p1b-1) * int
     &_mb(k_range+p2b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_8_1',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p3b = noab+1,noab+nvab
      IF (int_mb(k_active+h6b-1)+int_mb(k_active+h7b-1)+int_mb(k_active+
     &h13b-1) .ge. numact) THEN
      IF (int_mb(k_active+p1b-1)+int_mb(k_active+p2b-1)+int_mb(k_active+
     &p3b-1) .ge. numact) THEN
      IF (int_mb(k_spin+p3b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+p3b-1),int_mb(k_sym+h11b-1)) .eq. irrep_t) T
     &HEN
      CALL TCE_RESTRICTED_2(p3b,h11b,p3b_1,h11b_1)
      CALL TCE_RESTRICTED_6(h6b,h7b,h13b,p1b,p2b,p3b,h6b_2,h7b_2,h13b_2,
     &p1b_2,p2b_2,p3b_2)
      dim_common = int_mb(k_range+p3b-1)
      dima_sort = int_mb(k_range+h11b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h6b-1) * int_mb(k_range+h7b-1) * int_mb
     &(k_range+h13b-1) * int_mb(k_range+p1b-1) * int_mb(k_range+p2b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_8_1',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_8_1',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h11b_
     &1 - 1 + noab * (p3b_1 - noab - 1)))
      CALL TCE_SORT_2(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+h11b-1),2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_8_1
     &',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_8_1',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_8_1',5,MA_ERR)
      IF ((p3b .lt. p1b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p2b_2
     & - noab - 1 + nvab * (p1b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h13b_2 - 1 + noab * (h7b_2 - 1 + noab * (h6b_2 - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h13b-1),int_mb(k_range+p3b-1
     &),int_mb(k_range+p1b-1),int_mb(k_range+p2b-1),6,5,3,2,1,4,1.0d0,.f
     &alse.)
      END IF
      IF ((p1b .le. p3b) .and. (p3b .lt. p2b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p2b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (h13b_2 - 1 + noab * (h7b_2 - 1 + noab * (h6b_2 - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h13b-1),int_mb(k_range+p1b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p2b-1),6,4,3,2,1,5,-1.0d0,.
     &false.)
      END IF
      IF ((p2b .le. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p2b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (h13b_2 - 1 + noab * (h7b_2 - 1 + noab * (h6b_2 - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h13b-1),int_mb(k_range+p1b-1
     &),int_mb(k_range+p2b-1),int_mb(k_range+p3b-1),5,4,3,2,1,6,1.0d0,.f
     &alse.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_8_1
     &',6,MA_ERR)
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,1.0d0,dbl_mb
     &(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c
     &_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_8_1',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_8_1',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_8_1',9,MA_ERR)
      CALL TCE_SORT_6(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p2b-1)
     &,int_mb(k_range+p1b-1),int_mb(k_range+h13b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h11b-1),5,4,3,6,2,1,1.0d0,.
     &false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p2b -
     & noab - 1 + nvab * (p1b - noab - 1 + nvab * (h11b - 1 + noab * (h1
     &3b - 1 + noab * (h7b - 1 + noab * (h6b - 1)))))))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_8_1
     &',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_8_1',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE OFFSET_eomccsdtq_density1_5_8_1(l_a_offset,k_a_offset,s
     &ize)
C     i2 ( h6 h7 h13 h11 p1 p2 )_yt
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER l_a_offset
      INTEGER k_a_offset
      INTEGER length
      INTEGER addr
      INTEGER h6b
      INTEGER h7b
      INTEGER h13b
      INTEGER h11b
      INTEGER p1b
      INTEGER p2b
      DOUBLE PRECISION size
      length = 0
      DO h6b = 1,noab
      DO h7b = h6b,noab
      DO h13b = h7b,noab
      DO h11b = 1,noab
      DO p1b = noab+1,noab+nvab
      DO p2b = p1b,noab+nvab
      IF (int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b-1)+int_mb(k_spin+h13b-1
     &) .eq. int_mb(k_spin+h11b-1)+int_mb(k_spin+p1b-1)+int_mb(k_spin+p2
     &b-1)) THEN
      IF (ieor(int_mb(k_sym+h6b-1),ieor(int_mb(k_sym+h7b-1),ieor(int_mb(
     &k_sym+h13b-1),ieor(int_mb(k_sym+h11b-1),ieor(int_mb(k_sym+p1b-1),i
     &nt_mb(k_sym+p2b-1)))))) .eq. ieor(irrep_y,irrep_t)) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b-1
     &)+int_mb(k_spin+h13b-1)+int_mb(k_spin+h11b-1)+int_mb(k_spin+p1b-1)
     &+int_mb(k_spin+p2b-1).ne.12)) THEN
      length = length + 1
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,2*length+1,'noname',l_a_offset,k_a_off
     &set)) CALL ERRQUIT('eomccsdtq_density1_5_8_1',0,MA_ERR)
      dbl_mb(k_a_offset) = dfloat(length)
      addr = 0
      size = 0.0d0
      DO h6b = 1,noab
      DO h7b = h6b,noab
      DO h13b = h7b,noab
      DO h11b = 1,noab
      DO p1b = noab+1,noab+nvab
      DO p2b = p1b,noab+nvab
      IF (int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b-1)+int_mb(k_spin+h13b-1
     &) .eq. int_mb(k_spin+h11b-1)+int_mb(k_spin+p1b-1)+int_mb(k_spin+p2
     &b-1)) THEN
      IF (ieor(int_mb(k_sym+h6b-1),ieor(int_mb(k_sym+h7b-1),ieor(int_mb(
     &k_sym+h13b-1),ieor(int_mb(k_sym+h11b-1),ieor(int_mb(k_sym+p1b-1),i
     &nt_mb(k_sym+p2b-1)))))) .eq. ieor(irrep_y,irrep_t)) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b-1
     &)+int_mb(k_spin+h13b-1)+int_mb(k_spin+h11b-1)+int_mb(k_spin+p1b-1)
     &+int_mb(k_spin+p2b-1).ne.12)) THEN
      addr = addr + 1
      dbl_mb(k_a_offset+addr) = dfloat(p2b - noab - 1 + nvab * (p1b - no
     &ab - 1 + nvab * (h11b - 1 + noab * (h13b - 1 + noab * (h7b - 1 + n
     &oab * (h6b - 1))))))
      dbl_mb(k_a_offset+length+addr) = size
      size = size + dfloat(int_mb(k_range+h6b-1)) * dfloat(int_mb(k_rang
     &e+h7b-1)) * dfloat(int_mb(k_range+h13b-1)) * dfloat(int_mb(k_range
     &+h11b-1)) * dfloat(int_mb(k_range+p1b-1)) * dfloat(int_mb(k_range+
     &p2b-1))
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_8_2(d_a,k_a_offset,d_b,k_b_offset,
     &d_c,k_c_offset)
C     i2 ( h6 h7 h13 h11 p1 p2 )_yt + = 1/2 * Sum ( h5 p4 p3 ) * t ( p3 p4 h5 h11 )_t * y ( h5 h6 h7 h13 p1 p2 p3 p4 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h6b
      INTEGER h7b
      INTEGER h13b
      INTEGER h11b
      INTEGER p1b
      INTEGER p2b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p3b
      INTEGER p4b
      INTEGER h5b
      INTEGER p3b_1
      INTEGER p4b_1
      INTEGER h11b_1
      INTEGER h5b_1
      INTEGER h6b_2
      INTEGER h7b_2
      INTEGER h13b_2
      INTEGER h5b_2
      INTEGER p1b_2
      INTEGER p2b_2
      INTEGER p3b_2
      INTEGER p4b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(2)
      INTEGER isuperp
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h6b = 1,noab
      DO h7b = h6b,noab
      DO h13b = h7b,noab
      DO h11b = 1,noab
      DO p1b = noab+1,noab+nvab
      DO p2b = p1b,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b-1
     &)+int_mb(k_spin+h13b-1)+int_mb(k_spin+h11b-1)+int_mb(k_spin+p1b-1)
     &+int_mb(k_spin+p2b-1).ne.12)) THEN
      IF (int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b-1)+int_mb(k_spin+h13b-1
     &) .eq. int_mb(k_spin+h11b-1)+int_mb(k_spin+p1b-1)+int_mb(k_spin+p2
     &b-1)) THEN
      IF (ieor(int_mb(k_sym+h6b-1),ieor(int_mb(k_sym+h7b-1),ieor(int_mb(
     &k_sym+h13b-1),ieor(int_mb(k_sym+h11b-1),ieor(int_mb(k_sym+p1b-1),i
     &nt_mb(k_sym+p2b-1)))))) .eq. ieor(irrep_y,irrep_t)) THEN
      dimc = int_mb(k_range+h6b-1) * int_mb(k_range+h7b-1) * int_mb(k_ra
     &nge+h13b-1) * int_mb(k_range+h11b-1) * int_mb(k_range+p1b-1) * int
     &_mb(k_range+p2b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_8_2',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      DO h5b = 1,noab
      IF (int_mb(k_active+h6b-1)+int_mb(k_active+h7b-1)+int_mb(k_active+
     &h13b-1)+int_mb(k_active+h5b-1) .ge. numacq) THEN
      IF (int_mb(k_active+p1b-1)+int_mb(k_active+p2b-1)+int_mb(k_active+
     &p3b-1)+int_mb(k_active+p4b-1) .ge. numacq) THEN
      IF (int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1) .eq. int_mb(k_spin+h
     &11b-1)+int_mb(k_spin+h5b-1)) THEN
      IF (ieor(int_mb(k_sym+p3b-1),ieor(int_mb(k_sym+p4b-1),ieor(int_mb(
     &k_sym+h11b-1),int_mb(k_sym+h5b-1)))) .eq. irrep_t) THEN
      CALL TCE_RESTRICTED_4(p3b,p4b,h11b,h5b,p3b_1,p4b_1,h11b_1,h5b_1)
      CALL TCE_RESTRICTED_8(h6b,h7b,h13b,h5b,p1b,p2b,p3b,p4b,h6b_2,h7b_2
     &,h13b_2,h5b_2,p1b_2,p2b_2,p3b_2,p4b_2)
      dim_common = int_mb(k_range+p3b-1) * int_mb(k_range+p4b-1) * int_m
     &b(k_range+h5b-1)
      dima_sort = int_mb(k_range+h11b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h6b-1) * int_mb(k_range+h7b-1) * int_mb
     &(k_range+h13b-1) * int_mb(k_range+p1b-1) * int_mb(k_range+p2b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_8_2',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_8_2',2,MA_ERR)
      IF ((h5b .le. h11b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h11b_
     &1 - 1 + noab * (h5b_1 - 1 + noab * (p4b_1 - noab - 1 + nvab * (p3b
     &_1 - noab - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+h5b-1),int_mb(k_range+h11b-1
     &),4,3,2,1,1.0d0,.false.)
      END IF
      IF ((h11b .lt. h5b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h5b_1
     & - 1 + noab * (h11b_1 - 1 + noab * (p4b_1 - noab - 1 + nvab * (p3b
     &_1 - noab - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+h11b-1),int_mb(k_range+h5b-1
     &),3,4,2,1,-1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_8_2
     &',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_8_2',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_8_2',5,MA_ERR)
      IF ((h5b .le. h6b) .and. (p4b .lt. p1b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p2b_2
     & - noab - 1 + nvab * (p1b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h13b_2 - 1 + noab * (h7b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h13b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p1b-1
     &),int_mb(k_range+p2b-1),8,7,4,3,2,1,6,5,1.0d0,.false.)
      END IF
      IF ((h5b .le. h6b) .and. (p3b .lt. p1b) .and. (p1b .le. p4b) .and.
     & (p4b .lt. p2b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p2b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h13b_2 - 1 + noab * (h7b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h13b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p1b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p2b-1),8,6,4,3,2,1,7,5,-1.0d0,.false.)
      END IF
      IF ((h5b .le. h6b) .and. (p3b .lt. p1b) .and. (p2b .le. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p2b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h13b_2 - 1 + noab * (h7b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h13b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p1b-1),int_mb(k_range+p2b-1
     &),int_mb(k_range+p4b-1),7,6,4,3,2,1,8,5,1.0d0,.false.)
      END IF
      IF ((h5b .le. h6b) .and. (p1b .le. p3b) .and. (p4b .lt. p2b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p2b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h13b_2 - 1 + noab * (h7b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h13b-1
     &),int_mb(k_range+p1b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p2b-1),8,5,4,3,2,1,7,6,1.0d0,.false.)
      END IF
      IF ((h5b .le. h6b) .and. (p1b .le. p3b) .and. (p3b .lt. p2b) .and.
     & (p2b .le. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p2b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h13b_2 - 1 + noab * (h7b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h13b-1
     &),int_mb(k_range+p1b-1),int_mb(k_range+p3b-1),int_mb(k_range+p2b-1
     &),int_mb(k_range+p4b-1),7,5,4,3,2,1,8,6,-1.0d0,.false.)
      END IF
      IF ((h5b .le. h6b) .and. (p2b .le. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p2b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h13b_2 - 1 + noab * (h7b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h13b-1
     &),int_mb(k_range+p1b-1),int_mb(k_range+p2b-1),int_mb(k_range+p3b-1
     &),int_mb(k_range+p4b-1),6,5,4,3,2,1,8,7,1.0d0,.false.)
      END IF
      IF ((h6b .lt. h5b) .and. (h5b .le. h7b) .and. (p4b .lt. p1b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p2b_2
     & - noab - 1 + nvab * (p1b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h13b_2 - 1 + noab * (h7b_2 - 
     &1 + noab * (h5b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h7b-1),int_mb(k_range+h13b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p1b-1
     &),int_mb(k_range+p2b-1),8,7,4,3,1,2,6,5,-1.0d0,.false.)
      END IF
      IF ((h6b .lt. h5b) .and. (h5b .le. h7b) .and. (p3b .lt. p1b) .and.
     & (p1b .le. p4b) .and. (p4b .lt. p2b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p2b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h13b_2 - 1 + noab * (h7b_2 - 
     &1 + noab * (h5b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h7b-1),int_mb(k_range+h13b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p1b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p2b-1),8,6,4,3,1,2,7,5,1.0d0,.false.)
      END IF
      IF ((h6b .lt. h5b) .and. (h5b .le. h7b) .and. (p3b .lt. p1b) .and.
     & (p2b .le. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p2b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h13b_2 - 1 + noab * (h7b_2 - 
     &1 + noab * (h5b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h7b-1),int_mb(k_range+h13b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p1b-1),int_mb(k_range+p2b-1
     &),int_mb(k_range+p4b-1),7,6,4,3,1,2,8,5,-1.0d0,.false.)
      END IF
      IF ((h6b .lt. h5b) .and. (h5b .le. h7b) .and. (p1b .le. p3b) .and.
     & (p4b .lt. p2b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p2b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h13b_2 - 1 + noab * (h7b_2 - 
     &1 + noab * (h5b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h7b-1),int_mb(k_range+h13b-1
     &),int_mb(k_range+p1b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p2b-1),8,5,4,3,1,2,7,6,-1.0d0,.false.)
      END IF
      IF ((h6b .lt. h5b) .and. (h5b .le. h7b) .and. (p1b .le. p3b) .and.
     & (p3b .lt. p2b) .and. (p2b .le. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p2b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h13b_2 - 1 + noab * (h7b_2 - 
     &1 + noab * (h5b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h7b-1),int_mb(k_range+h13b-1
     &),int_mb(k_range+p1b-1),int_mb(k_range+p3b-1),int_mb(k_range+p2b-1
     &),int_mb(k_range+p4b-1),7,5,4,3,1,2,8,6,1.0d0,.false.)
      END IF
      IF ((h6b .lt. h5b) .and. (h5b .le. h7b) .and. (p2b .le. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p2b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h13b_2 - 1 + noab * (h7b_2 - 
     &1 + noab * (h5b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h7b-1),int_mb(k_range+h13b-1
     &),int_mb(k_range+p1b-1),int_mb(k_range+p2b-1),int_mb(k_range+p3b-1
     &),int_mb(k_range+p4b-1),6,5,4,3,1,2,8,7,-1.0d0,.false.)
      END IF
      IF ((h7b .lt. h5b) .and. (h5b .le. h13b) .and. (p4b .lt. p1b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p2b_2
     & - noab - 1 + nvab * (p1b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h13b_2 - 1 + noab * (h5b_2 - 
     &1 + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h5b-1),int_mb(k_range+h13b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p1b-1
     &),int_mb(k_range+p2b-1),8,7,4,2,1,3,6,5,1.0d0,.false.)
      END IF
      IF ((h7b .lt. h5b) .and. (h5b .le. h13b) .and. (p3b .lt. p1b) .and
     &. (p1b .le. p4b) .and. (p4b .lt. p2b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p2b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h13b_2 - 1 + noab * (h5b_2 - 
     &1 + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h5b-1),int_mb(k_range+h13b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p1b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p2b-1),8,6,4,2,1,3,7,5,-1.0d0,.false.)
      END IF
      IF ((h7b .lt. h5b) .and. (h5b .le. h13b) .and. (p3b .lt. p1b) .and
     &. (p2b .le. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p2b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h13b_2 - 1 + noab * (h5b_2 - 
     &1 + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h5b-1),int_mb(k_range+h13b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p1b-1),int_mb(k_range+p2b-1
     &),int_mb(k_range+p4b-1),7,6,4,2,1,3,8,5,1.0d0,.false.)
      END IF
      IF ((h7b .lt. h5b) .and. (h5b .le. h13b) .and. (p1b .le. p3b) .and
     &. (p4b .lt. p2b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p2b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h13b_2 - 1 + noab * (h5b_2 - 
     &1 + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h5b-1),int_mb(k_range+h13b-1
     &),int_mb(k_range+p1b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p2b-1),8,5,4,2,1,3,7,6,1.0d0,.false.)
      END IF
      IF ((h7b .lt. h5b) .and. (h5b .le. h13b) .and. (p1b .le. p3b) .and
     &. (p3b .lt. p2b) .and. (p2b .le. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p2b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h13b_2 - 1 + noab * (h5b_2 - 
     &1 + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h5b-1),int_mb(k_range+h13b-1
     &),int_mb(k_range+p1b-1),int_mb(k_range+p3b-1),int_mb(k_range+p2b-1
     &),int_mb(k_range+p4b-1),7,5,4,2,1,3,8,6,-1.0d0,.false.)
      END IF
      IF ((h7b .lt. h5b) .and. (h5b .le. h13b) .and. (p2b .le. p3b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p2b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h13b_2 - 1 + noab * (h5b_2 - 
     &1 + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h5b-1),int_mb(k_range+h13b-1
     &),int_mb(k_range+p1b-1),int_mb(k_range+p2b-1),int_mb(k_range+p3b-1
     &),int_mb(k_range+p4b-1),6,5,4,2,1,3,8,7,1.0d0,.false.)
      END IF
      IF ((h13b .lt. h5b) .and. (p4b .lt. p1b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p2b_2
     & - noab - 1 + nvab * (p1b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h13b_2 - 
     &1 + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h13b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p1b-1
     &),int_mb(k_range+p2b-1),8,7,3,2,1,4,6,5,-1.0d0,.false.)
      END IF
      IF ((h13b .lt. h5b) .and. (p3b .lt. p1b) .and. (p1b .le. p4b) .and
     &. (p4b .lt. p2b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p2b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h13b_2 - 
     &1 + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h13b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p1b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p2b-1),8,6,3,2,1,4,7,5,1.0d0,.false.)
      END IF
      IF ((h13b .lt. h5b) .and. (p3b .lt. p1b) .and. (p2b .le. p4b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p2b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h13b_2 - 
     &1 + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h13b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p1b-1),int_mb(k_range+p2b-1
     &),int_mb(k_range+p4b-1),7,6,3,2,1,4,8,5,-1.0d0,.false.)
      END IF
      IF ((h13b .lt. h5b) .and. (p1b .le. p3b) .and. (p4b .lt. p2b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p2b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h13b_2 - 
     &1 + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h13b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+p1b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p2b-1),8,5,3,2,1,4,7,6,-1.0d0,.false.)
      END IF
      IF ((h13b .lt. h5b) .and. (p1b .le. p3b) .and. (p3b .lt. p2b) .and
     &. (p2b .le. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p2b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h13b_2 - 
     &1 + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h13b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+p1b-1),int_mb(k_range+p3b-1),int_mb(k_range+p2b-1
     &),int_mb(k_range+p4b-1),7,5,3,2,1,4,8,6,1.0d0,.false.)
      END IF
      IF ((h13b .lt. h5b) .and. (p2b .le. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p2b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h13b_2 - 
     &1 + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h13b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+p1b-1),int_mb(k_range+p2b-1),int_mb(k_range+p3b-1
     &),int_mb(k_range+p4b-1),6,5,3,2,1,4,8,7,-1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_8_2
     &',6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      isuperp = 1
      IF (p3b .eq. p4b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,2.0d0/FACTOR
     &IAL(nsuperp(1))/FACTORIAL(nsuperp(2)),dbl_mb(k_a_sort),dim_common,
     &dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_8_2',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_8_2',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_8_2',9,MA_ERR)
      CALL TCE_SORT_6(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p2b-1)
     &,int_mb(k_range+p1b-1),int_mb(k_range+h13b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h11b-1),5,4,3,6,2,1,1.0d0/2
     &.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p2b -
     & noab - 1 + nvab * (p1b - noab - 1 + nvab * (h11b - 1 + noab * (h1
     &3b - 1 + noab * (h7b - 1 + noab * (h6b - 1)))))))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_8_2
     &',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_8_2',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_9(d_a,k_a_offset,d_b,k_b_offset,d_
     &c,k_c_offset)
C     i1 ( p12 h11 )_ytx + = 1/144 * Sum ( h7 h8 h9 h10 p4 p5 p6 ) * x ( p4 p5 p6 p12 h7 h8 h9 h10 )_x * i2 ( h7 h8 h9 h10 h11 p4 p5 p6 )_yt
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER p12b
      INTEGER h11b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p4b
      INTEGER p5b
      INTEGER p6b
      INTEGER h7b
      INTEGER h8b
      INTEGER h9b
      INTEGER h10b
      INTEGER p12b_1
      INTEGER p4b_1
      INTEGER p5b_1
      INTEGER p6b_1
      INTEGER h7b_1
      INTEGER h8b_1
      INTEGER h9b_1
      INTEGER h10b_1
      INTEGER h7b_2
      INTEGER h8b_2
      INTEGER h9b_2
      INTEGER h10b_2
      INTEGER h11b_2
      INTEGER p4b_2
      INTEGER p5b_2
      INTEGER p6b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(3)
      INTEGER isuperp
      INTEGER nsubh(4)
      INTEGER isubh
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO p12b = noab+1,noab+nvab
      DO h11b = 1,noab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+p12b-1)+int_mb(k_spin+h11b
     &-1).ne.4)) THEN
      IF (int_mb(k_spin+p12b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+p12b-1),int_mb(k_sym+h11b-1)) .eq. ieor(irre
     &p_y,ieor(irrep_t,irrep_x))) THEN
      dimc = int_mb(k_range+p12b-1) * int_mb(k_range+h11b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_9',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p4b = noab+1,noab+nvab
      DO p5b = p4b,noab+nvab
      DO p6b = p5b,noab+nvab
      DO h7b = 1,noab
      DO h8b = h7b,noab
      DO h9b = h8b,noab
      DO h10b = h9b,noab
      IF (int_mb(k_active+p12b-1)+int_mb(k_active+p4b-1)+int_mb(k_active
     &+p5b-1)+int_mb(k_active+p6b-1) .ge. numacq) THEN
      IF (int_mb(k_active+h7b-1)+int_mb(k_active+h8b-1)+int_mb(k_active+
     &h9b-1)+int_mb(k_active+h10b-1) .ge. numacq) THEN
      IF (int_mb(k_spin+p12b-1)+int_mb(k_spin+p4b-1)+int_mb(k_spin+p5b-1
     &)+int_mb(k_spin+p6b-1) .eq. int_mb(k_spin+h7b-1)+int_mb(k_spin+h8b
     &-1)+int_mb(k_spin+h9b-1)+int_mb(k_spin+h10b-1)) THEN
      IF (ieor(int_mb(k_sym+p12b-1),ieor(int_mb(k_sym+p4b-1),ieor(int_mb
     &(k_sym+p5b-1),ieor(int_mb(k_sym+p6b-1),ieor(int_mb(k_sym+h7b-1),ie
     &or(int_mb(k_sym+h8b-1),ieor(int_mb(k_sym+h9b-1),int_mb(k_sym+h10b-
     &1)))))))) .eq. irrep_x) THEN
      CALL TCE_RESTRICTED_8(p12b,p4b,p5b,p6b,h7b,h8b,h9b,h10b,p12b_1,p4b
     &_1,p5b_1,p6b_1,h7b_1,h8b_1,h9b_1,h10b_1)
      CALL TCE_RESTRICTED_8(h7b,h8b,h9b,h10b,h11b,p4b,p5b,p6b,h7b_2,h8b_
     &2,h9b_2,h10b_2,h11b_2,p4b_2,p5b_2,p6b_2)
      dim_common = int_mb(k_range+p4b-1) * int_mb(k_range+p5b-1) * int_m
     &b(k_range+p6b-1) * int_mb(k_range+h7b-1) * int_mb(k_range+h8b-1) *
     & int_mb(k_range+h9b-1) * int_mb(k_range+h10b-1)
      dima_sort = int_mb(k_range+p12b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h11b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_9',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_9',2,MA_ERR)
      IF ((p6b .le. p12b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h10b_
     &1 - 1 + noab * (h9b_1 - 1 + noab * (h8b_1 - 1 + noab * (h7b_1 - 1 
     &+ noab * (p12b_1 - noab - 1 + nvab * (p6b_1 - noab - 1 + nvab * (p
     &5b_1 - noab - 1 + nvab * (p4b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p5b-1),int_mb(k_range+p6b-1),int_mb(k_range+p12b-1
     &),int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1
     &),int_mb(k_range+h10b-1),4,8,7,6,5,3,2,1,1.0d0,.false.)
      END IF
      IF ((p5b .le. p12b) .and. (p12b .lt. p6b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h10b_
     &1 - 1 + noab * (h9b_1 - 1 + noab * (h8b_1 - 1 + noab * (h7b_1 - 1 
     &+ noab * (p6b_1 - noab - 1 + nvab * (p12b_1 - noab - 1 + nvab * (p
     &5b_1 - noab - 1 + nvab * (p4b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p5b-1),int_mb(k_range+p12b-1),int_mb(k_range+p6b-1
     &),int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1
     &),int_mb(k_range+h10b-1),3,8,7,6,5,4,2,1,-1.0d0,.false.)
      END IF
      IF ((p4b .le. p12b) .and. (p12b .lt. p5b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h10b_
     &1 - 1 + noab * (h9b_1 - 1 + noab * (h8b_1 - 1 + noab * (h7b_1 - 1 
     &+ noab * (p6b_1 - noab - 1 + nvab * (p5b_1 - noab - 1 + nvab * (p1
     &2b_1 - noab - 1 + nvab * (p4b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p12b-1),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1
     &),int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1
     &),int_mb(k_range+h10b-1),2,8,7,6,5,4,3,1,1.0d0,.false.)
      END IF
      IF ((p12b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h10b_
     &1 - 1 + noab * (h9b_1 - 1 + noab * (h8b_1 - 1 + noab * (h7b_1 - 1 
     &+ noab * (p6b_1 - noab - 1 + nvab * (p5b_1 - noab - 1 + nvab * (p4
     &b_1 - noab - 1 + nvab * (p12b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p12b-1
     &),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1
     &),int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1
     &),int_mb(k_range+h10b-1),1,8,7,6,5,4,3,2,-1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_9',
     &3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_9',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_9',5,MA_ERR)
      IF ((h11b .le. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (h11b_2 - 1 + noab * (h10b_2 - 1 + noab * (h9b_2 - 1 + no
     &ab * (h8b_2 - 1 + noab * (h7b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h9b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+h11b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-
     &1),int_mb(k_range+p6b-1),5,4,3,2,1,8,7,6,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_9',
     &6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      nsuperp(3) = 1
      isuperp = 1
      IF (p4b .eq. p5b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      IF (p5b .eq. p6b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      nsubh(1) = 1
      nsubh(2) = 1
      nsubh(3) = 1
      nsubh(4) = 1
      isubh = 1
      IF (h7b .eq. h8b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      IF (h8b .eq. h9b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      IF (h9b .eq. h10b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,144.0d0/FACT
     &ORIAL(nsuperp(1))/FACTORIAL(nsuperp(2))/FACTORIAL(nsuperp(3))/FACT
     &ORIAL(nsubh(1))/FACTORIAL(nsubh(2))/FACTORIAL(nsubh(3))/FACTORIAL(
     &nsubh(4)),dbl_mb(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,
     &1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_9',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_9',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_9',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+h11b-1
     &),int_mb(k_range+p12b-1),2,1,1.0d0/144.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(h11b 
     &- 1 + noab * (p12b - noab - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_9',
     &10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_9',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_9_1(d_a,k_a_offset,d_b,k_b_offset,
     &d_c,k_c_offset)
C     i2 ( h7 h8 h9 h10 h11 p4 p5 p6 )_yt + = 1 * Sum ( p3 ) * t ( p3 h11 )_t * y ( h7 h8 h9 h10 p3 p4 p5 p6 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h7b
      INTEGER h8b
      INTEGER h9b
      INTEGER h10b
      INTEGER h11b
      INTEGER p4b
      INTEGER p5b
      INTEGER p6b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p3b
      INTEGER p3b_1
      INTEGER h11b_1
      INTEGER h7b_2
      INTEGER h8b_2
      INTEGER h9b_2
      INTEGER h10b_2
      INTEGER p4b_2
      INTEGER p5b_2
      INTEGER p6b_2
      INTEGER p3b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h7b = 1,noab
      DO h8b = h7b,noab
      DO h9b = h8b,noab
      DO h10b = h9b,noab
      DO h11b = 1,noab
      DO p4b = noab+1,noab+nvab
      DO p5b = p4b,noab+nvab
      DO p6b = p5b,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h7b-1)+int_mb(k_spin+h8b-1
     &)+int_mb(k_spin+h9b-1)+int_mb(k_spin+h10b-1)+int_mb(k_spin+h11b-1)
     &+int_mb(k_spin+p4b-1)+int_mb(k_spin+p5b-1)+int_mb(k_spin+p6b-1).ne
     &.16)) THEN
      IF (int_mb(k_spin+h7b-1)+int_mb(k_spin+h8b-1)+int_mb(k_spin+h9b-1)
     &+int_mb(k_spin+h10b-1) .eq. int_mb(k_spin+h11b-1)+int_mb(k_spin+p4
     &b-1)+int_mb(k_spin+p5b-1)+int_mb(k_spin+p6b-1)) THEN
      IF (ieor(int_mb(k_sym+h7b-1),ieor(int_mb(k_sym+h8b-1),ieor(int_mb(
     &k_sym+h9b-1),ieor(int_mb(k_sym+h10b-1),ieor(int_mb(k_sym+h11b-1),i
     &eor(int_mb(k_sym+p4b-1),ieor(int_mb(k_sym+p5b-1),int_mb(k_sym+p6b-
     &1)))))))) .eq. ieor(irrep_y,irrep_t)) THEN
      dimc = int_mb(k_range+h7b-1) * int_mb(k_range+h8b-1) * int_mb(k_ra
     &nge+h9b-1) * int_mb(k_range+h10b-1) * int_mb(k_range+h11b-1) * int
     &_mb(k_range+p4b-1) * int_mb(k_range+p5b-1) * int_mb(k_range+p6b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_9_1',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p3b = noab+1,noab+nvab
      IF (int_mb(k_active+h7b-1)+int_mb(k_active+h8b-1)+int_mb(k_active+
     &h9b-1)+int_mb(k_active+h10b-1) .ge. numacq) THEN
      IF (int_mb(k_active+p4b-1)+int_mb(k_active+p5b-1)+int_mb(k_active+
     &p6b-1)+int_mb(k_active+p3b-1) .ge. numacq) THEN
      IF (int_mb(k_spin+p3b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+p3b-1),int_mb(k_sym+h11b-1)) .eq. irrep_t) T
     &HEN
      CALL TCE_RESTRICTED_2(p3b,h11b,p3b_1,h11b_1)
      CALL TCE_RESTRICTED_8(h7b,h8b,h9b,h10b,p4b,p5b,p6b,p3b,h7b_2,h8b_2
     &,h9b_2,h10b_2,p4b_2,p5b_2,p6b_2,p3b_2)
      dim_common = int_mb(k_range+p3b-1)
      dima_sort = int_mb(k_range+h11b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h7b-1) * int_mb(k_range+h8b-1) * int_mb
     &(k_range+h9b-1) * int_mb(k_range+h10b-1) * int_mb(k_range+p4b-1) *
     & int_mb(k_range+p5b-1) * int_mb(k_range+p6b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_9_1',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_9_1',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h11b_
     &1 - 1 + noab * (p3b_1 - noab - 1)))
      CALL TCE_SORT_2(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+h11b-1),2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_9_1
     &',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_9_1',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_9_1',5,MA_ERR)
      IF ((p3b .le. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h9b_2 - 
     &1 + noab * (h8b_2 - 1 + noab * (h7b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h9b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+p6b-1),8,7,6,4,3,2,1,5,1.0d0,.false.)
      END IF
      IF ((p4b .lt. p3b) .and. (p3b .le. p5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p4b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h9b_2 - 
     &1 + noab * (h8b_2 - 1 + noab * (h7b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h9b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p4b-1),int_mb(k_range+p3b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+p6b-1),8,7,5,4,3,2,1,6,-1.0d0,.false.)
      END IF
      IF ((p5b .lt. p3b) .and. (p3b .le. p6b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p5b_2 - noab - 1 
     &+ nvab * (p4b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h9b_2 - 
     &1 + noab * (h8b_2 - 1 + noab * (h7b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h9b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+p3b-1
     &),int_mb(k_range+p6b-1),8,6,5,4,3,2,1,7,1.0d0,.false.)
      END IF
      IF ((p6b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p5b_2 - noab - 1 
     &+ nvab * (p4b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h9b_2 - 
     &1 + noab * (h8b_2 - 1 + noab * (h7b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h9b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1
     &),int_mb(k_range+p3b-1),7,6,5,4,3,2,1,8,-1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_9_1
     &',6,MA_ERR)
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,1.0d0,dbl_mb
     &(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c
     &_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_9_1',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_9_1',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_9_1',9,MA_ERR)
      CALL TCE_SORT_8(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p6b-1)
     &,int_mb(k_range+p5b-1),int_mb(k_range+p4b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+h9b-1),int_mb(k_range+h8b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+h11b-1),7,6,5,4,8,3,2,1,1.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p6b -
     & noab - 1 + nvab * (p5b - noab - 1 + nvab * (p4b - noab - 1 + nvab
     & * (h11b - 1 + noab * (h10b - 1 + noab * (h9b - 1 + noab * (h8b - 
     &1 + noab * (h7b - 1)))))))))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_9_1
     &',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_9_1',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE OFFSET_eomccsdtq_density1_5_9_1(l_a_offset,k_a_offset,s
     &ize)
C     i2 ( h7 h8 h9 h10 h11 p4 p5 p6 )_yt
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER l_a_offset
      INTEGER k_a_offset
      INTEGER length
      INTEGER addr
      INTEGER h7b
      INTEGER h8b
      INTEGER h9b
      INTEGER h10b
      INTEGER h11b
      INTEGER p4b
      INTEGER p5b
      INTEGER p6b
      DOUBLE PRECISION size
      length = 0
      DO h7b = 1,noab
      DO h8b = h7b,noab
      DO h9b = h8b,noab
      DO h10b = h9b,noab
      DO h11b = 1,noab
      DO p4b = noab+1,noab+nvab
      DO p5b = p4b,noab+nvab
      DO p6b = p5b,noab+nvab
      IF (int_mb(k_spin+h7b-1)+int_mb(k_spin+h8b-1)+int_mb(k_spin+h9b-1)
     &+int_mb(k_spin+h10b-1) .eq. int_mb(k_spin+h11b-1)+int_mb(k_spin+p4
     &b-1)+int_mb(k_spin+p5b-1)+int_mb(k_spin+p6b-1)) THEN
      IF (ieor(int_mb(k_sym+h7b-1),ieor(int_mb(k_sym+h8b-1),ieor(int_mb(
     &k_sym+h9b-1),ieor(int_mb(k_sym+h10b-1),ieor(int_mb(k_sym+h11b-1),i
     &eor(int_mb(k_sym+p4b-1),ieor(int_mb(k_sym+p5b-1),int_mb(k_sym+p6b-
     &1)))))))) .eq. ieor(irrep_y,irrep_t)) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h7b-1)+int_mb(k_spin+h8b-1
     &)+int_mb(k_spin+h9b-1)+int_mb(k_spin+h10b-1)+int_mb(k_spin+h11b-1)
     &+int_mb(k_spin+p4b-1)+int_mb(k_spin+p5b-1)+int_mb(k_spin+p6b-1).ne
     &.16)) THEN
      length = length + 1
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,2*length+1,'noname',l_a_offset,k_a_off
     &set)) CALL ERRQUIT('eomccsdtq_density1_5_9_1',0,MA_ERR)
      dbl_mb(k_a_offset) = dfloat(length)
      addr = 0
      size = 0.0d0
      DO h7b = 1,noab
      DO h8b = h7b,noab
      DO h9b = h8b,noab
      DO h10b = h9b,noab
      DO h11b = 1,noab
      DO p4b = noab+1,noab+nvab
      DO p5b = p4b,noab+nvab
      DO p6b = p5b,noab+nvab
      IF (int_mb(k_spin+h7b-1)+int_mb(k_spin+h8b-1)+int_mb(k_spin+h9b-1)
     &+int_mb(k_spin+h10b-1) .eq. int_mb(k_spin+h11b-1)+int_mb(k_spin+p4
     &b-1)+int_mb(k_spin+p5b-1)+int_mb(k_spin+p6b-1)) THEN
      IF (ieor(int_mb(k_sym+h7b-1),ieor(int_mb(k_sym+h8b-1),ieor(int_mb(
     &k_sym+h9b-1),ieor(int_mb(k_sym+h10b-1),ieor(int_mb(k_sym+h11b-1),i
     &eor(int_mb(k_sym+p4b-1),ieor(int_mb(k_sym+p5b-1),int_mb(k_sym+p6b-
     &1)))))))) .eq. ieor(irrep_y,irrep_t)) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h7b-1)+int_mb(k_spin+h8b-1
     &)+int_mb(k_spin+h9b-1)+int_mb(k_spin+h10b-1)+int_mb(k_spin+h11b-1)
     &+int_mb(k_spin+p4b-1)+int_mb(k_spin+p5b-1)+int_mb(k_spin+p6b-1).ne
     &.16)) THEN
      addr = addr + 1
      dbl_mb(k_a_offset+addr) = dfloat(p6b - noab - 1 + nvab * (p5b - no
     &ab - 1 + nvab * (p4b - noab - 1 + nvab * (h11b - 1 + noab * (h10b 
     &- 1 + noab * (h9b - 1 + noab * (h8b - 1 + noab * (h7b - 1))))))))
      dbl_mb(k_a_offset+length+addr) = size
      size = size + dfloat(int_mb(k_range+h7b-1)) * dfloat(int_mb(k_rang
     &e+h8b-1)) * dfloat(int_mb(k_range+h9b-1)) * dfloat(int_mb(k_range+
     &h10b-1)) * dfloat(int_mb(k_range+h11b-1)) * dfloat(int_mb(k_range+
     &p4b-1)) * dfloat(int_mb(k_range+p5b-1)) * dfloat(int_mb(k_range+p6
     &b-1))
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_10(d_a,k_a_offset,d_b,k_b_offset,d
     &_c,k_c_offset)
C     i1 ( p12 h11 )_yxt + = 1 * Sum ( h4 p3 ) * t ( p3 p12 h4 h11 )_t * i2 ( h4 p3 )_yx
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER p12b
      INTEGER h11b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p3b
      INTEGER h4b
      INTEGER p12b_1
      INTEGER p3b_1
      INTEGER h11b_1
      INTEGER h4b_1
      INTEGER h4b_2
      INTEGER p3b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO p12b = noab+1,noab+nvab
      DO h11b = 1,noab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+p12b-1)+int_mb(k_spin+h11b
     &-1).ne.4)) THEN
      IF (int_mb(k_spin+p12b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+p12b-1),int_mb(k_sym+h11b-1)) .eq. ieor(irre
     &p_y,ieor(irrep_x,irrep_t))) THEN
      dimc = int_mb(k_range+p12b-1) * int_mb(k_range+h11b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_10',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p3b = noab+1,noab+nvab
      DO h4b = 1,noab
      IF (int_mb(k_spin+p12b-1)+int_mb(k_spin+p3b-1) .eq. int_mb(k_spin+
     &h11b-1)+int_mb(k_spin+h4b-1)) THEN
      IF (ieor(int_mb(k_sym+p12b-1),ieor(int_mb(k_sym+p3b-1),ieor(int_mb
     &(k_sym+h11b-1),int_mb(k_sym+h4b-1)))) .eq. irrep_t) THEN
      CALL TCE_RESTRICTED_4(p12b,p3b,h11b,h4b,p12b_1,p3b_1,h11b_1,h4b_1)
      CALL TCE_RESTRICTED_2(h4b,p3b,h4b_2,p3b_2)
      dim_common = int_mb(k_range+p3b-1) * int_mb(k_range+h4b-1)
      dima_sort = int_mb(k_range+p12b-1) * int_mb(k_range+h11b-1)
      dima = dim_common * dima_sort
      dimb_sort = 1
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_10',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_10',2,MA_ERR)
      IF ((p3b .le. p12b) .and. (h4b .le. h11b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h11b_
     &1 - 1 + noab * (h4b_1 - 1 + noab * (p12b_1 - noab - 1 + nvab * (p3
     &b_1 - noab - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p12b-1),int_mb(k_range+h4b-1),int_mb(k_range+h11b-
     &1),4,2,3,1,1.0d0,.false.)
      END IF
      IF ((p3b .le. p12b) .and. (h11b .lt. h4b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h4b_1
     & - 1 + noab * (h11b_1 - 1 + noab * (p12b_1 - noab - 1 + nvab * (p3
     &b_1 - noab - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p12b-1),int_mb(k_range+h11b-1),int_mb(k_range+h4b-
     &1),3,2,4,1,-1.0d0,.false.)
      END IF
      IF ((p12b .lt. p3b) .and. (h4b .le. h11b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h11b_
     &1 - 1 + noab * (h4b_1 - 1 + noab * (p3b_1 - noab - 1 + nvab * (p12
     &b_1 - noab - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p12b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+h4b-1),int_mb(k_range+h11b-
     &1),4,1,3,2,-1.0d0,.false.)
      END IF
      IF ((p12b .lt. p3b) .and. (h11b .lt. h4b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h4b_1
     & - 1 + noab * (h11b_1 - 1 + noab * (p3b_1 - noab - 1 + nvab * (p12
     &b_1 - noab - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p12b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+h11b-1),int_mb(k_range+h4b-
     &1),3,1,4,2,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_10'
     &,3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_10',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_10',5,MA_ERR)
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (h4b_2 - 1)))
      CALL TCE_SORT_2(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+p3b-1),1,2,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_10'
     &,6,MA_ERR)
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,1.0d0,dbl_mb
     &(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c
     &_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_10',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_10',8,MA_ERR)
      END IF
      END IF
      END IF
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_10',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+h11b-1
     &),int_mb(k_range+p12b-1),2,1,1.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(h11b 
     &- 1 + noab * (p12b - noab - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_10'
     &,10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_10',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_10_1(d_a,k_a_offset,d_b,k_b_offset
     &,d_c,k_c_offset)
C     i2 ( h4 p3 )_yx + = 1 * x ( )_x * y ( h4 p3 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h4b
      INTEGER p3b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER h4b_2
      INTEGER p3b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h4b = 1,noab
      DO p3b = noab+1,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h4b-1)+int_mb(k_spin+p3b-1
     &).ne.4)) THEN
      IF (int_mb(k_spin+h4b-1) .eq. int_mb(k_spin+p3b-1)) THEN
      IF (ieor(int_mb(k_sym+h4b-1),int_mb(k_sym+p3b-1)) .eq. ieor(irrep_
     &y,irrep_x)) THEN
      dimc = int_mb(k_range+h4b-1) * int_mb(k_range+p3b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_10_1',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      IF (0 .eq. irrep_x) THEN
      CALL TCE_RESTRICTED_2(h4b,p3b,h4b_2,p3b_2)
      dim_common = 1
      dima_sort = 1
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h4b-1) * int_mb(k_range+p3b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_10_1',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_10_1',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),0)
      CALL TCE_SORT_0(dbl_mb(k_a),dbl_mb(k_a_sort),1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_10_
     &1',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_10_1',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_10_1',5,MA_ERR)
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (h4b_2 - 1)))
      CALL TCE_SORT_2(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+p3b-1),2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_10_
     &1',6,MA_ERR)
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,1.0d0,dbl_mb
     &(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c
     &_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_10_1',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_10_1',8,MA_ERR)
      END IF
      END IF
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_10_1',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p3b-1)
     &,int_mb(k_range+h4b-1),2,1,1.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p3b -
     & noab - 1 + nvab * (h4b - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_10_
     &1',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_10_1',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE OFFSET_eomccsdtq_density1_5_10_1(l_a_offset,k_a_offset,
     &size)
C     i2 ( h4 p3 )_yx
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER l_a_offset
      INTEGER k_a_offset
      INTEGER length
      INTEGER addr
      INTEGER h4b
      INTEGER p3b
      DOUBLE PRECISION size
      length = 0
      DO h4b = 1,noab
      DO p3b = noab+1,noab+nvab
      IF (int_mb(k_spin+h4b-1) .eq. int_mb(k_spin+p3b-1)) THEN
      IF (ieor(int_mb(k_sym+h4b-1),int_mb(k_sym+p3b-1)) .eq. ieor(irrep_
     &y,irrep_x)) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h4b-1)+int_mb(k_spin+p3b-1
     &).ne.4)) THEN
      length = length + 1
      END IF
      END IF
      END IF
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,2*length+1,'noname',l_a_offset,k_a_off
     &set)) CALL ERRQUIT('eomccsdtq_density1_5_10_1',0,MA_ERR)
      dbl_mb(k_a_offset) = dfloat(length)
      addr = 0
      size = 0.0d0
      DO h4b = 1,noab
      DO p3b = noab+1,noab+nvab
      IF (int_mb(k_spin+h4b-1) .eq. int_mb(k_spin+p3b-1)) THEN
      IF (ieor(int_mb(k_sym+h4b-1),int_mb(k_sym+p3b-1)) .eq. ieor(irrep_
     &y,irrep_x)) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h4b-1)+int_mb(k_spin+p3b-1
     &).ne.4)) THEN
      addr = addr + 1
      dbl_mb(k_a_offset+addr) = dfloat(p3b - noab - 1 + nvab * (h4b - 1)
     &)
      dbl_mb(k_a_offset+length+addr) = size
      size = size + dfloat(int_mb(k_range+h4b-1)) * dfloat(int_mb(k_rang
     &e+p3b-1))
      END IF
      END IF
      END IF
      END DO
      END DO
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_10_2(d_a,k_a_offset,d_b,k_b_offset
     &,d_c,k_c_offset)
C     i2 ( h4 p3 )_yx + = 1 * Sum ( h6 p5 ) * x ( p5 h6 )_x * y ( h4 h6 p3 p5 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h4b
      INTEGER p3b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p5b
      INTEGER h6b
      INTEGER p5b_1
      INTEGER h6b_1
      INTEGER h4b_2
      INTEGER h6b_2
      INTEGER p3b_2
      INTEGER p5b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h4b = 1,noab
      DO p3b = noab+1,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h4b-1)+int_mb(k_spin+p3b-1
     &).ne.4)) THEN
      IF (int_mb(k_spin+h4b-1) .eq. int_mb(k_spin+p3b-1)) THEN
      IF (ieor(int_mb(k_sym+h4b-1),int_mb(k_sym+p3b-1)) .eq. ieor(irrep_
     &y,irrep_x)) THEN
      dimc = int_mb(k_range+h4b-1) * int_mb(k_range+p3b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_10_2',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p5b = noab+1,noab+nvab
      DO h6b = 1,noab
      IF (int_mb(k_spin+p5b-1) .eq. int_mb(k_spin+h6b-1)) THEN
      IF (ieor(int_mb(k_sym+p5b-1),int_mb(k_sym+h6b-1)) .eq. irrep_x) TH
     &EN
      CALL TCE_RESTRICTED_2(p5b,h6b,p5b_1,h6b_1)
      CALL TCE_RESTRICTED_4(h4b,h6b,p3b,p5b,h4b_2,h6b_2,p3b_2,p5b_2)
      dim_common = int_mb(k_range+p5b-1) * int_mb(k_range+h6b-1)
      dima_sort = 1
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h4b-1) * int_mb(k_range+p3b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_10_2',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_10_2',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h6b_1
     & - 1 + noab * (p5b_1 - noab - 1)))
      CALL TCE_SORT_2(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p5b-1)
     &,int_mb(k_range+h6b-1),2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_10_
     &2',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_10_2',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_10_2',5,MA_ERR)
      IF ((h6b .lt. h4b) .and. (p5b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (h4b_2 - 1 + noab 
     &* (h6b_2 - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h4b-1),int_mb(k_range+p5b-1),int_mb(k_range+p3b-1)
     &,4,2,1,3,1.0d0,.false.)
      END IF
      IF ((h6b .lt. h4b) .and. (p3b .le. p5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (h4b_2 - 1 + noab 
     &* (h6b_2 - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h4b-1),int_mb(k_range+p3b-1),int_mb(k_range+p5b-1)
     &,3,2,1,4,-1.0d0,.false.)
      END IF
      IF ((h4b .le. h6b) .and. (p5b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (h6b_2 - 1 + noab 
     &* (h4b_2 - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+p5b-1),int_mb(k_range+p3b-1)
     &,4,1,2,3,-1.0d0,.false.)
      END IF
      IF ((h4b .le. h6b) .and. (p3b .le. p5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (h6b_2 - 1 + noab 
     &* (h4b_2 - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+p3b-1),int_mb(k_range+p5b-1)
     &,3,1,2,4,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_10_
     &2',6,MA_ERR)
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,1.0d0,dbl_mb
     &(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c
     &_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_10_2',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_10_2',8,MA_ERR)
      END IF
      END IF
      END IF
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_10_2',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p3b-1)
     &,int_mb(k_range+h4b-1),2,1,1.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p3b -
     & noab - 1 + nvab * (h4b - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_10_
     &2',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_10_2',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_10_3(d_a,k_a_offset,d_b,k_b_offset
     &,d_c,k_c_offset)
C     i2 ( h4 p3 )_yx + = 1/4 * Sum ( h8 h7 p6 p5 ) * x ( p5 p6 h7 h8 )_x * y ( h4 h7 h8 p3 p5 p6 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h4b
      INTEGER p3b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p5b
      INTEGER p6b
      INTEGER h7b
      INTEGER h8b
      INTEGER p5b_1
      INTEGER p6b_1
      INTEGER h7b_1
      INTEGER h8b_1
      INTEGER h4b_2
      INTEGER h7b_2
      INTEGER h8b_2
      INTEGER p3b_2
      INTEGER p5b_2
      INTEGER p6b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(2)
      INTEGER isuperp
      INTEGER nsubh(2)
      INTEGER isubh
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h4b = 1,noab
      DO p3b = noab+1,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h4b-1)+int_mb(k_spin+p3b-1
     &).ne.4)) THEN
      IF (int_mb(k_spin+h4b-1) .eq. int_mb(k_spin+p3b-1)) THEN
      IF (ieor(int_mb(k_sym+h4b-1),int_mb(k_sym+p3b-1)) .eq. ieor(irrep_
     &y,irrep_x)) THEN
      dimc = int_mb(k_range+h4b-1) * int_mb(k_range+p3b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_10_3',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p5b = noab+1,noab+nvab
      DO p6b = p5b,noab+nvab
      DO h7b = 1,noab
      DO h8b = h7b,noab
      IF (int_mb(k_active+h4b-1)+int_mb(k_active+h7b-1)+int_mb(k_active+
     &h8b-1) .ge. numact) THEN
      IF (int_mb(k_active+p3b-1)+int_mb(k_active+p5b-1)+int_mb(k_active+
     &p6b-1) .ge. numact) THEN
      IF (int_mb(k_spin+p5b-1)+int_mb(k_spin+p6b-1) .eq. int_mb(k_spin+h
     &7b-1)+int_mb(k_spin+h8b-1)) THEN
      IF (ieor(int_mb(k_sym+p5b-1),ieor(int_mb(k_sym+p6b-1),ieor(int_mb(
     &k_sym+h7b-1),int_mb(k_sym+h8b-1)))) .eq. irrep_x) THEN
      CALL TCE_RESTRICTED_4(p5b,p6b,h7b,h8b,p5b_1,p6b_1,h7b_1,h8b_1)
      CALL TCE_RESTRICTED_6(h4b,h7b,h8b,p3b,p5b,p6b,h4b_2,h7b_2,h8b_2,p3
     &b_2,p5b_2,p6b_2)
      dim_common = int_mb(k_range+p5b-1) * int_mb(k_range+p6b-1) * int_m
     &b(k_range+h7b-1) * int_mb(k_range+h8b-1)
      dima_sort = 1
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h4b-1) * int_mb(k_range+p3b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_10_3',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_10_3',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h8b_1
     & - 1 + noab * (h7b_1 - 1 + noab * (p6b_1 - noab - 1 + nvab * (p5b_
     &1 - noab - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h8b-1)
     &,4,3,2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_10_
     &3',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_10_3',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_10_3',5,MA_ERR)
      IF ((h8b .lt. h4b) .and. (p6b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p5b_2 - noab - 1 
     &+ nvab * (h4b_2 - 1 + noab * (h8b_2 - 1 + noab * (h7b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h4b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p6b-1),int_mb(k_range+p3b-1),6,3,2,1,5,4,1.0d0,.fa
     &lse.)
      END IF
      IF ((h8b .lt. h4b) .and. (p5b .lt. p3b) .and. (p3b .le. p6b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p5b_2 - noab - 1 
     &+ nvab * (h4b_2 - 1 + noab * (h8b_2 - 1 + noab * (h7b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h4b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p6b-1),5,3,2,1,6,4,-1.0d0,.f
     &alse.)
      END IF
      IF ((h8b .lt. h4b) .and. (p3b .le. p5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h4b_2 - 1 + noab * (h8b_2 - 1 + noab * (h7b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h4b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p5b-1),int_mb(k_range+p6b-1),4,3,2,1,6,5,1.0d0,.fa
     &lse.)
      END IF
      IF ((h7b .lt. h4b) .and. (h4b .le. h8b) .and. (p6b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p5b_2 - noab - 1 
     &+ nvab * (h8b_2 - 1 + noab * (h4b_2 - 1 + noab * (h7b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h4b-1),int_mb(k_range+h8b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p6b-1),int_mb(k_range+p3b-1),6,2,3,1,5,4,-1.0d0,.f
     &alse.)
      END IF
      IF ((h7b .lt. h4b) .and. (h4b .le. h8b) .and. (p5b .lt. p3b) .and.
     & (p3b .le. p6b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p5b_2 - noab - 1 
     &+ nvab * (h8b_2 - 1 + noab * (h4b_2 - 1 + noab * (h7b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h4b-1),int_mb(k_range+h8b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p6b-1),5,2,3,1,6,4,1.0d0,.fa
     &lse.)
      END IF
      IF ((h7b .lt. h4b) .and. (h4b .le. h8b) .and. (p3b .le. p5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h8b_2 - 1 + noab * (h4b_2 - 1 + noab * (h7b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h4b-1),int_mb(k_range+h8b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p5b-1),int_mb(k_range+p6b-1),4,2,3,1,6,5,-1.0d0,.f
     &alse.)
      END IF
      IF ((h4b .le. h7b) .and. (p6b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p5b_2 - noab - 1 
     &+ nvab * (h8b_2 - 1 + noab * (h7b_2 - 1 + noab * (h4b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p6b-1),int_mb(k_range+p3b-1),6,1,3,2,5,4,1.0d0,.fa
     &lse.)
      END IF
      IF ((h4b .le. h7b) .and. (p5b .lt. p3b) .and. (p3b .le. p6b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p5b_2 - noab - 1 
     &+ nvab * (h8b_2 - 1 + noab * (h7b_2 - 1 + noab * (h4b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p6b-1),5,1,3,2,6,4,-1.0d0,.f
     &alse.)
      END IF
      IF ((h4b .le. h7b) .and. (p3b .le. p5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h8b_2 - 1 + noab * (h7b_2 - 1 + noab * (h4b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p5b-1),int_mb(k_range+p6b-1),4,1,3,2,6,5,1.0d0,.fa
     &lse.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_10_
     &3',6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      isuperp = 1
      IF (p5b .eq. p6b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      nsubh(1) = 1
      nsubh(2) = 1
      isubh = 1
      IF (h7b .eq. h8b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,4.0d0/FACTOR
     &IAL(nsuperp(1))/FACTORIAL(nsuperp(2))/FACTORIAL(nsubh(1))/FACTORIA
     &L(nsubh(2)),dbl_mb(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_commo
     &n,1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_10_3',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_10_3',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_10_3',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p3b-1)
     &,int_mb(k_range+h4b-1),2,1,1.0d0/4.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p3b -
     & noab - 1 + nvab * (h4b - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_10_
     &3',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_10_3',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_10_4(d_a,k_a_offset,d_b,k_b_offset
     &,d_c,k_c_offset)
C     i2 ( h4 p3 )_yx + = 1/36 * Sum ( h10 h9 h8 p7 p6 p5 ) * x ( p5 p6 p7 h8 h9 h10 )_x * y ( h4 h8 h9 h10 p3 p5 p6 p7 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h4b
      INTEGER p3b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p5b
      INTEGER p6b
      INTEGER p7b
      INTEGER h8b
      INTEGER h9b
      INTEGER h10b
      INTEGER p5b_1
      INTEGER p6b_1
      INTEGER p7b_1
      INTEGER h8b_1
      INTEGER h9b_1
      INTEGER h10b_1
      INTEGER h4b_2
      INTEGER h8b_2
      INTEGER h9b_2
      INTEGER h10b_2
      INTEGER p3b_2
      INTEGER p5b_2
      INTEGER p6b_2
      INTEGER p7b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(3)
      INTEGER isuperp
      INTEGER nsubh(3)
      INTEGER isubh
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h4b = 1,noab
      DO p3b = noab+1,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h4b-1)+int_mb(k_spin+p3b-1
     &).ne.4)) THEN
      IF (int_mb(k_spin+h4b-1) .eq. int_mb(k_spin+p3b-1)) THEN
      IF (ieor(int_mb(k_sym+h4b-1),int_mb(k_sym+p3b-1)) .eq. ieor(irrep_
     &y,irrep_x)) THEN
      dimc = int_mb(k_range+h4b-1) * int_mb(k_range+p3b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_10_4',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p5b = noab+1,noab+nvab
      DO p6b = p5b,noab+nvab
      DO p7b = p6b,noab+nvab
      DO h8b = 1,noab
      DO h9b = h8b,noab
      DO h10b = h9b,noab
      IF (int_mb(k_active+p5b-1)+int_mb(k_active+p6b-1)+int_mb(k_active+
     &p7b-1) .ge. numact) THEN
      IF (int_mb(k_active+h8b-1)+int_mb(k_active+h9b-1)+int_mb(k_active+
     &h10b-1) .ge. numact) THEN
      IF (int_mb(k_active+h4b-1)+int_mb(k_active+h8b-1)+int_mb(k_active+
     &h9b-1)+int_mb(k_active+h10b-1) .ge. numacq) THEN
      IF (int_mb(k_active+p3b-1)+int_mb(k_active+p5b-1)+int_mb(k_active+
     &p6b-1)+int_mb(k_active+p7b-1) .ge. numacq) THEN
      IF (int_mb(k_spin+p5b-1)+int_mb(k_spin+p6b-1)+int_mb(k_spin+p7b-1)
     & .eq. int_mb(k_spin+h8b-1)+int_mb(k_spin+h9b-1)+int_mb(k_spin+h10b
     &-1)) THEN
      IF (ieor(int_mb(k_sym+p5b-1),ieor(int_mb(k_sym+p6b-1),ieor(int_mb(
     &k_sym+p7b-1),ieor(int_mb(k_sym+h8b-1),ieor(int_mb(k_sym+h9b-1),int
     &_mb(k_sym+h10b-1)))))) .eq. irrep_x) THEN
      CALL TCE_RESTRICTED_6(p5b,p6b,p7b,h8b,h9b,h10b,p5b_1,p6b_1,p7b_1,h
     &8b_1,h9b_1,h10b_1)
      CALL TCE_RESTRICTED_8(h4b,h8b,h9b,h10b,p3b,p5b,p6b,p7b,h4b_2,h8b_2
     &,h9b_2,h10b_2,p3b_2,p5b_2,p6b_2,p7b_2)
      dim_common = int_mb(k_range+p5b-1) * int_mb(k_range+p6b-1) * int_m
     &b(k_range+p7b-1) * int_mb(k_range+h8b-1) * int_mb(k_range+h9b-1) *
     & int_mb(k_range+h10b-1)
      dima_sort = 1
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h4b-1) * int_mb(k_range+p3b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_10_4',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_10_4',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h10b_
     &1 - 1 + noab * (h9b_1 - 1 + noab * (h8b_1 - 1 + noab * (p7b_1 - no
     &ab - 1 + nvab * (p6b_1 - noab - 1 + nvab * (p5b_1 - noab - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p6b-1),int_mb(k_range+p7b-1),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h10b-1),6,5,4,3,2,1,1.0d0,.f
     &alse.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_10_
     &4',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_10_4',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_10_4',5,MA_ERR)
      IF ((h10b .lt. h4b) .and. (p7b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p6b_2 - noab - 1 
     &+ nvab * (p5b_2 - noab - 1 + nvab * (h4b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h9b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h10b-1),int_mb(k_range+h4b-1
     &),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1),int_mb(k_range+p7b-1
     &),int_mb(k_range+p3b-1),8,4,3,2,1,7,6,5,1.0d0,.false.)
      END IF
      IF ((h10b .lt. h4b) .and. (p6b .lt. p3b) .and. (p3b .le. p7b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p6b_2 - noab - 1 
     &+ nvab * (p5b_2 - noab - 1 + nvab * (h4b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h9b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h10b-1),int_mb(k_range+h4b-1
     &),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1),int_mb(k_range+p3b-1
     &),int_mb(k_range+p7b-1),7,4,3,2,1,8,6,5,-1.0d0,.false.)
      END IF
      IF ((h10b .lt. h4b) .and. (p5b .lt. p3b) .and. (p3b .le. p6b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p5b_2 - noab - 1 + nvab * (h4b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h9b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h10b-1),int_mb(k_range+h4b-1
     &),int_mb(k_range+p5b-1),int_mb(k_range+p3b-1),int_mb(k_range+p6b-1
     &),int_mb(k_range+p7b-1),6,4,3,2,1,8,7,5,1.0d0,.false.)
      END IF
      IF ((h10b .lt. h4b) .and. (p3b .le. p5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p5b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h4b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h9b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h10b-1),int_mb(k_range+h4b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1
     &),int_mb(k_range+p7b-1),5,4,3,2,1,8,7,6,-1.0d0,.false.)
      END IF
      IF ((h9b .lt. h4b) .and. (h4b .le. h10b) .and. (p7b .lt. p3b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p6b_2 - noab - 1 
     &+ nvab * (p5b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h4b_2 - 
     &1 + noab * (h9b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h4b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1),int_mb(k_range+p7b-1
     &),int_mb(k_range+p3b-1),8,3,4,2,1,7,6,5,-1.0d0,.false.)
      END IF
      IF ((h9b .lt. h4b) .and. (h4b .le. h10b) .and. (p6b .lt. p3b) .and
     &. (p3b .le. p7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p6b_2 - noab - 1 
     &+ nvab * (p5b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h4b_2 - 
     &1 + noab * (h9b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h4b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1),int_mb(k_range+p3b-1
     &),int_mb(k_range+p7b-1),7,3,4,2,1,8,6,5,1.0d0,.false.)
      END IF
      IF ((h9b .lt. h4b) .and. (h4b .le. h10b) .and. (p5b .lt. p3b) .and
     &. (p3b .le. p6b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p5b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h4b_2 - 
     &1 + noab * (h9b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h4b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p5b-1),int_mb(k_range+p3b-1),int_mb(k_range+p6b-1
     &),int_mb(k_range+p7b-1),6,3,4,2,1,8,7,5,-1.0d0,.false.)
      END IF
      IF ((h9b .lt. h4b) .and. (h4b .le. h10b) .and. (p3b .le. p5b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p5b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h4b_2 - 
     &1 + noab * (h9b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h4b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1
     &),int_mb(k_range+p7b-1),5,3,4,2,1,8,7,6,1.0d0,.false.)
      END IF
      IF ((h8b .lt. h4b) .and. (h4b .le. h9b) .and. (p7b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p6b_2 - noab - 1 
     &+ nvab * (p5b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h9b_2 - 
     &1 + noab * (h4b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h4b-1),int_mb(k_range+h9b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1),int_mb(k_range+p7b-1
     &),int_mb(k_range+p3b-1),8,2,4,3,1,7,6,5,1.0d0,.false.)
      END IF
      IF ((h8b .lt. h4b) .and. (h4b .le. h9b) .and. (p6b .lt. p3b) .and.
     & (p3b .le. p7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p6b_2 - noab - 1 
     &+ nvab * (p5b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h9b_2 - 
     &1 + noab * (h4b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h4b-1),int_mb(k_range+h9b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1),int_mb(k_range+p3b-1
     &),int_mb(k_range+p7b-1),7,2,4,3,1,8,6,5,-1.0d0,.false.)
      END IF
      IF ((h8b .lt. h4b) .and. (h4b .le. h9b) .and. (p5b .lt. p3b) .and.
     & (p3b .le. p6b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p5b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h9b_2 - 
     &1 + noab * (h4b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h4b-1),int_mb(k_range+h9b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p5b-1),int_mb(k_range+p3b-1),int_mb(k_range+p6b-1
     &),int_mb(k_range+p7b-1),6,2,4,3,1,8,7,5,1.0d0,.false.)
      END IF
      IF ((h8b .lt. h4b) .and. (h4b .le. h9b) .and. (p3b .le. p5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p5b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h9b_2 - 
     &1 + noab * (h4b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h4b-1),int_mb(k_range+h9b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1
     &),int_mb(k_range+p7b-1),5,2,4,3,1,8,7,6,-1.0d0,.false.)
      END IF
      IF ((h4b .le. h8b) .and. (p7b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p6b_2 - noab - 1 
     &+ nvab * (p5b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h9b_2 - 
     &1 + noab * (h8b_2 - 1 + noab * (h4b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h9b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1),int_mb(k_range+p7b-1
     &),int_mb(k_range+p3b-1),8,1,4,3,2,7,6,5,-1.0d0,.false.)
      END IF
      IF ((h4b .le. h8b) .and. (p6b .lt. p3b) .and. (p3b .le. p7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p6b_2 - noab - 1 
     &+ nvab * (p5b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h9b_2 - 
     &1 + noab * (h8b_2 - 1 + noab * (h4b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h9b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1),int_mb(k_range+p3b-1
     &),int_mb(k_range+p7b-1),7,1,4,3,2,8,6,5,1.0d0,.false.)
      END IF
      IF ((h4b .le. h8b) .and. (p5b .lt. p3b) .and. (p3b .le. p6b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p5b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h9b_2 - 
     &1 + noab * (h8b_2 - 1 + noab * (h4b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h9b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p5b-1),int_mb(k_range+p3b-1),int_mb(k_range+p6b-1
     &),int_mb(k_range+p7b-1),6,1,4,3,2,8,7,5,-1.0d0,.false.)
      END IF
      IF ((h4b .le. h8b) .and. (p3b .le. p5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p5b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h9b_2 - 
     &1 + noab * (h8b_2 - 1 + noab * (h4b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h9b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1
     &),int_mb(k_range+p7b-1),5,1,4,3,2,8,7,6,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_10_
     &4',6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      nsuperp(3) = 1
      isuperp = 1
      IF (p5b .eq. p6b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      IF (p6b .eq. p7b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      nsubh(1) = 1
      nsubh(2) = 1
      nsubh(3) = 1
      isubh = 1
      IF (h8b .eq. h9b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      IF (h9b .eq. h10b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,36.0d0/FACTO
     &RIAL(nsuperp(1))/FACTORIAL(nsuperp(2))/FACTORIAL(nsuperp(3))/FACTO
     &RIAL(nsubh(1))/FACTORIAL(nsubh(2))/FACTORIAL(nsubh(3)),dbl_mb(k_a_
     &sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c_sort
     &),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_10_4',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_10_4',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_10_4',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p3b-1)
     &,int_mb(k_range+h4b-1),2,1,1.0d0/36.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p3b -
     & noab - 1 + nvab * (h4b - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_10_
     &4',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_10_4',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_11(d_a,k_a_offset,d_b,k_b_offset,d
     &_c,k_c_offset)
C     i1 ( p12 h11 )_yxt + = -1/2 * Sum ( h2 h1 p13 ) * t ( p12 p13 h1 h2 )_t * i2 ( h1 h2 h11 p13 )_yx
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER p12b
      INTEGER h11b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p13b
      INTEGER h1b
      INTEGER h2b
      INTEGER p12b_1
      INTEGER p13b_1
      INTEGER h1b_1
      INTEGER h2b_1
      INTEGER h1b_2
      INTEGER h2b_2
      INTEGER h11b_2
      INTEGER p13b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsubh(2)
      INTEGER isubh
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO p12b = noab+1,noab+nvab
      DO h11b = 1,noab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+p12b-1)+int_mb(k_spin+h11b
     &-1).ne.4)) THEN
      IF (int_mb(k_spin+p12b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+p12b-1),int_mb(k_sym+h11b-1)) .eq. ieor(irre
     &p_y,ieor(irrep_x,irrep_t))) THEN
      dimc = int_mb(k_range+p12b-1) * int_mb(k_range+h11b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_11',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p13b = noab+1,noab+nvab
      DO h1b = 1,noab
      DO h2b = h1b,noab
      IF (int_mb(k_spin+p12b-1)+int_mb(k_spin+p13b-1) .eq. int_mb(k_spin
     &+h1b-1)+int_mb(k_spin+h2b-1)) THEN
      IF (ieor(int_mb(k_sym+p12b-1),ieor(int_mb(k_sym+p13b-1),ieor(int_m
     &b(k_sym+h1b-1),int_mb(k_sym+h2b-1)))) .eq. irrep_t) THEN
      CALL TCE_RESTRICTED_4(p12b,p13b,h1b,h2b,p12b_1,p13b_1,h1b_1,h2b_1)
      CALL TCE_RESTRICTED_4(h1b,h2b,h11b,p13b,h1b_2,h2b_2,h11b_2,p13b_2)
      dim_common = int_mb(k_range+p13b-1) * int_mb(k_range+h1b-1) * int_
     &mb(k_range+h2b-1)
      dima_sort = int_mb(k_range+p12b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h11b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_11',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_11',2,MA_ERR)
      IF ((p13b .lt. p12b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h2b_1
     & - 1 + noab * (h1b_1 - 1 + noab * (p12b_1 - noab - 1 + nvab * (p13
     &b_1 - noab - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p13b-1
     &),int_mb(k_range+p12b-1),int_mb(k_range+h1b-1),int_mb(k_range+h2b-
     &1),2,4,3,1,-1.0d0,.false.)
      END IF
      IF ((p12b .le. p13b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h2b_1
     & - 1 + noab * (h1b_1 - 1 + noab * (p13b_1 - noab - 1 + nvab * (p12
     &b_1 - noab - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p12b-1
     &),int_mb(k_range+p13b-1),int_mb(k_range+h1b-1),int_mb(k_range+h2b-
     &1),1,4,3,2,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_11'
     &,3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_11',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_11',5,MA_ERR)
      IF ((h11b .le. p13b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p13b_
     &2 - noab - 1 + nvab * (h11b_2 - 1 + noab * (h2b_2 - 1 + noab * (h1
     &b_2 - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h11b-1),int_mb(k_range+p13b-
     &1),3,2,1,4,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_11'
     &,6,MA_ERR)
      nsubh(1) = 1
      nsubh(2) = 1
      isubh = 1
      IF (h1b .eq. h2b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,2.0d0/FACTOR
     &IAL(nsubh(1))/FACTORIAL(nsubh(2)),dbl_mb(k_a_sort),dim_common,dbl_
     &mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_11',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_11',8,MA_ERR)
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_11',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+h11b-1
     &),int_mb(k_range+p12b-1),2,1,-1.0d0/2.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(h11b 
     &- 1 + noab * (p12b - noab - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_11'
     &,10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_11',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_11_1(d_a,k_a_offset,d_b,k_b_offset
     &,d_c,k_c_offset)
C     i2 ( h1 h2 h11 p13 )_yx + = 1 * Sum ( p6 ) * x ( p6 h11 )_x * y ( h1 h2 p6 p13 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h1b
      INTEGER h2b
      INTEGER h11b
      INTEGER p13b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p6b
      INTEGER p6b_1
      INTEGER h11b_1
      INTEGER h1b_2
      INTEGER h2b_2
      INTEGER p13b_2
      INTEGER p6b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h1b = 1,noab
      DO h2b = h1b,noab
      DO h11b = 1,noab
      DO p13b = noab+1,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h1b-1)+int_mb(k_spin+h2b-1
     &)+int_mb(k_spin+h11b-1)+int_mb(k_spin+p13b-1).ne.8)) THEN
      IF (int_mb(k_spin+h1b-1)+int_mb(k_spin+h2b-1) .eq. int_mb(k_spin+h
     &11b-1)+int_mb(k_spin+p13b-1)) THEN
      IF (ieor(int_mb(k_sym+h1b-1),ieor(int_mb(k_sym+h2b-1),ieor(int_mb(
     &k_sym+h11b-1),int_mb(k_sym+p13b-1)))) .eq. ieor(irrep_y,irrep_x)) 
     &THEN
      dimc = int_mb(k_range+h1b-1) * int_mb(k_range+h2b-1) * int_mb(k_ra
     &nge+h11b-1) * int_mb(k_range+p13b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_11_1',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p6b = noab+1,noab+nvab
      IF (int_mb(k_spin+p6b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+p6b-1),int_mb(k_sym+h11b-1)) .eq. irrep_x) T
     &HEN
      CALL TCE_RESTRICTED_2(p6b,h11b,p6b_1,h11b_1)
      CALL TCE_RESTRICTED_4(h1b,h2b,p13b,p6b,h1b_2,h2b_2,p13b_2,p6b_2)
      dim_common = int_mb(k_range+p6b-1)
      dima_sort = int_mb(k_range+h11b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h1b-1) * int_mb(k_range+h2b-1) * int_mb
     &(k_range+p13b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_11_1',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_11_1',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h11b_
     &1 - 1 + noab * (p6b_1 - noab - 1)))
      CALL TCE_SORT_2(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p6b-1)
     &,int_mb(k_range+h11b-1),2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_11_
     &1',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_11_1',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_11_1',5,MA_ERR)
      IF ((p6b .le. p13b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p13b_
     &2 - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (h2b_2 - 1 + noab
     & * (h1b_2 - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+p6b-1),int_mb(k_range+p13b-1
     &),4,2,1,3,1.0d0,.false.)
      END IF
      IF ((p13b .lt. p6b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p13b_2 - noab - 1 + nvab * (h2b_2 - 1 + noab
     & * (h1b_2 - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+p13b-1),int_mb(k_range+p6b-1
     &),3,2,1,4,-1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_11_
     &1',6,MA_ERR)
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,1.0d0,dbl_mb
     &(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c
     &_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_11_1',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_11_1',8,MA_ERR)
      END IF
      END IF
      END IF
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_11_1',9,MA_ERR)
      CALL TCE_SORT_4(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p13b-1
     &),int_mb(k_range+h2b-1),int_mb(k_range+h1b-1),int_mb(k_range+h11b-
     &1),3,2,4,1,1.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p13b 
     &- noab - 1 + nvab * (h11b - 1 + noab * (h2b - 1 + noab * (h1b - 1)
     &))))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_11_
     &1',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_11_1',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE OFFSET_eomccsdtq_density1_5_11_1(l_a_offset,k_a_offset,
     &size)
C     i2 ( h1 h2 h11 p13 )_yx
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER l_a_offset
      INTEGER k_a_offset
      INTEGER length
      INTEGER addr
      INTEGER h1b
      INTEGER h2b
      INTEGER h11b
      INTEGER p13b
      DOUBLE PRECISION size
      length = 0
      DO h1b = 1,noab
      DO h2b = h1b,noab
      DO h11b = 1,noab
      DO p13b = noab+1,noab+nvab
      IF (int_mb(k_spin+h1b-1)+int_mb(k_spin+h2b-1) .eq. int_mb(k_spin+h
     &11b-1)+int_mb(k_spin+p13b-1)) THEN
      IF (ieor(int_mb(k_sym+h1b-1),ieor(int_mb(k_sym+h2b-1),ieor(int_mb(
     &k_sym+h11b-1),int_mb(k_sym+p13b-1)))) .eq. ieor(irrep_y,irrep_x)) 
     &THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h1b-1)+int_mb(k_spin+h2b-1
     &)+int_mb(k_spin+h11b-1)+int_mb(k_spin+p13b-1).ne.8)) THEN
      length = length + 1
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,2*length+1,'noname',l_a_offset,k_a_off
     &set)) CALL ERRQUIT('eomccsdtq_density1_5_11_1',0,MA_ERR)
      dbl_mb(k_a_offset) = dfloat(length)
      addr = 0
      size = 0.0d0
      DO h1b = 1,noab
      DO h2b = h1b,noab
      DO h11b = 1,noab
      DO p13b = noab+1,noab+nvab
      IF (int_mb(k_spin+h1b-1)+int_mb(k_spin+h2b-1) .eq. int_mb(k_spin+h
     &11b-1)+int_mb(k_spin+p13b-1)) THEN
      IF (ieor(int_mb(k_sym+h1b-1),ieor(int_mb(k_sym+h2b-1),ieor(int_mb(
     &k_sym+h11b-1),int_mb(k_sym+p13b-1)))) .eq. ieor(irrep_y,irrep_x)) 
     &THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h1b-1)+int_mb(k_spin+h2b-1
     &)+int_mb(k_spin+h11b-1)+int_mb(k_spin+p13b-1).ne.8)) THEN
      addr = addr + 1
      dbl_mb(k_a_offset+addr) = dfloat(p13b - noab - 1 + nvab * (h11b - 
     &1 + noab * (h2b - 1 + noab * (h1b - 1))))
      dbl_mb(k_a_offset+length+addr) = size
      size = size + dfloat(int_mb(k_range+h1b-1)) * dfloat(int_mb(k_rang
     &e+h2b-1)) * dfloat(int_mb(k_range+h11b-1)) * dfloat(int_mb(k_range
     &+p13b-1))
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_11_2(d_a,k_a_offset,d_b,k_b_offset
     &,d_c,k_c_offset)
C     i2 ( h1 h2 h11 p13 )_yx + = 1/2 * Sum ( h8 p7 p6 ) * x ( p6 p7 h8 h11 )_x * y ( h1 h2 h8 p6 p7 p13 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h1b
      INTEGER h2b
      INTEGER h11b
      INTEGER p13b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p6b
      INTEGER p7b
      INTEGER h8b
      INTEGER p6b_1
      INTEGER p7b_1
      INTEGER h11b_1
      INTEGER h8b_1
      INTEGER h1b_2
      INTEGER h2b_2
      INTEGER h8b_2
      INTEGER p13b_2
      INTEGER p6b_2
      INTEGER p7b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(2)
      INTEGER isuperp
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h1b = 1,noab
      DO h2b = h1b,noab
      DO h11b = 1,noab
      DO p13b = noab+1,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h1b-1)+int_mb(k_spin+h2b-1
     &)+int_mb(k_spin+h11b-1)+int_mb(k_spin+p13b-1).ne.8)) THEN
      IF (int_mb(k_spin+h1b-1)+int_mb(k_spin+h2b-1) .eq. int_mb(k_spin+h
     &11b-1)+int_mb(k_spin+p13b-1)) THEN
      IF (ieor(int_mb(k_sym+h1b-1),ieor(int_mb(k_sym+h2b-1),ieor(int_mb(
     &k_sym+h11b-1),int_mb(k_sym+p13b-1)))) .eq. ieor(irrep_y,irrep_x)) 
     &THEN
      dimc = int_mb(k_range+h1b-1) * int_mb(k_range+h2b-1) * int_mb(k_ra
     &nge+h11b-1) * int_mb(k_range+p13b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_11_2',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p6b = noab+1,noab+nvab
      DO p7b = p6b,noab+nvab
      DO h8b = 1,noab
      IF (int_mb(k_active+h1b-1)+int_mb(k_active+h2b-1)+int_mb(k_active+
     &h8b-1) .ge. numact) THEN
      IF (int_mb(k_active+p13b-1)+int_mb(k_active+p6b-1)+int_mb(k_active
     &+p7b-1) .ge. numact) THEN
      IF (int_mb(k_spin+p6b-1)+int_mb(k_spin+p7b-1) .eq. int_mb(k_spin+h
     &11b-1)+int_mb(k_spin+h8b-1)) THEN
      IF (ieor(int_mb(k_sym+p6b-1),ieor(int_mb(k_sym+p7b-1),ieor(int_mb(
     &k_sym+h11b-1),int_mb(k_sym+h8b-1)))) .eq. irrep_x) THEN
      CALL TCE_RESTRICTED_4(p6b,p7b,h11b,h8b,p6b_1,p7b_1,h11b_1,h8b_1)
      CALL TCE_RESTRICTED_6(h1b,h2b,h8b,p13b,p6b,p7b,h1b_2,h2b_2,h8b_2,p
     &13b_2,p6b_2,p7b_2)
      dim_common = int_mb(k_range+p6b-1) * int_mb(k_range+p7b-1) * int_m
     &b(k_range+h8b-1)
      dima_sort = int_mb(k_range+h11b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h1b-1) * int_mb(k_range+h2b-1) * int_mb
     &(k_range+p13b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_11_2',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_11_2',2,MA_ERR)
      IF ((h8b .le. h11b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h11b_
     &1 - 1 + noab * (h8b_1 - 1 + noab * (p7b_1 - noab - 1 + nvab * (p6b
     &_1 - noab - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p6b-1)
     &,int_mb(k_range+p7b-1),int_mb(k_range+h8b-1),int_mb(k_range+h11b-1
     &),4,3,2,1,1.0d0,.false.)
      END IF
      IF ((h11b .lt. h8b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h8b_1
     & - 1 + noab * (h11b_1 - 1 + noab * (p7b_1 - noab - 1 + nvab * (p6b
     &_1 - noab - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p6b-1)
     &,int_mb(k_range+p7b-1),int_mb(k_range+h11b-1),int_mb(k_range+h8b-1
     &),3,4,2,1,-1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_11_
     &2',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_11_2',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_11_2',5,MA_ERR)
      IF ((h8b .lt. h1b) .and. (p7b .le. p13b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p13b_
     &2 - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p6b_2 - noab - 1
     & + nvab * (h2b_2 - 1 + noab * (h1b_2 - 1 + noab * (h8b_2 - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h1b-1),int_mb(k_range+h2b-1),int_mb(k_range+p6b-1)
     &,int_mb(k_range+p7b-1),int_mb(k_range+p13b-1),6,3,2,1,5,4,1.0d0,.f
     &alse.)
      END IF
      IF ((h8b .lt. h1b) .and. (p6b .le. p13b) .and. (p13b .lt. p7b)) TH
     &EN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p13b_2 - noab - 1 + nvab * (p6b_2 - noab - 1
     & + nvab * (h2b_2 - 1 + noab * (h1b_2 - 1 + noab * (h8b_2 - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h1b-1),int_mb(k_range+h2b-1),int_mb(k_range+p6b-1)
     &,int_mb(k_range+p13b-1),int_mb(k_range+p7b-1),5,3,2,1,6,4,-1.0d0,.
     &false.)
      END IF
      IF ((h8b .lt. h1b) .and. (p13b .lt. p6b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p13b_2 - noab - 1
     & + nvab * (h2b_2 - 1 + noab * (h1b_2 - 1 + noab * (h8b_2 - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h1b-1),int_mb(k_range+h2b-1),int_mb(k_range+p13b-1
     &),int_mb(k_range+p6b-1),int_mb(k_range+p7b-1),4,3,2,1,6,5,1.0d0,.f
     &alse.)
      END IF
      IF ((h1b .le. h8b) .and. (h8b .lt. h2b) .and. (p7b .le. p13b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p13b_
     &2 - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p6b_2 - noab - 1
     & + nvab * (h2b_2 - 1 + noab * (h8b_2 - 1 + noab * (h1b_2 - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h2b-1),int_mb(k_range+p6b-1)
     &,int_mb(k_range+p7b-1),int_mb(k_range+p13b-1),6,3,1,2,5,4,-1.0d0,.
     &false.)
      END IF
      IF ((h1b .le. h8b) .and. (h8b .lt. h2b) .and. (p6b .le. p13b) .and
     &. (p13b .lt. p7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p13b_2 - noab - 1 + nvab * (p6b_2 - noab - 1
     & + nvab * (h2b_2 - 1 + noab * (h8b_2 - 1 + noab * (h1b_2 - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h2b-1),int_mb(k_range+p6b-1)
     &,int_mb(k_range+p13b-1),int_mb(k_range+p7b-1),5,3,1,2,6,4,1.0d0,.f
     &alse.)
      END IF
      IF ((h1b .le. h8b) .and. (h8b .lt. h2b) .and. (p13b .lt. p6b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p13b_2 - noab - 1
     & + nvab * (h2b_2 - 1 + noab * (h8b_2 - 1 + noab * (h1b_2 - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h2b-1),int_mb(k_range+p13b-1
     &),int_mb(k_range+p6b-1),int_mb(k_range+p7b-1),4,3,1,2,6,5,-1.0d0,.
     &false.)
      END IF
      IF ((h2b .le. h8b) .and. (p7b .le. p13b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p13b_
     &2 - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p6b_2 - noab - 1
     & + nvab * (h8b_2 - 1 + noab * (h2b_2 - 1 + noab * (h1b_2 - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h8b-1),int_mb(k_range+p6b-1)
     &,int_mb(k_range+p7b-1),int_mb(k_range+p13b-1),6,2,1,3,5,4,1.0d0,.f
     &alse.)
      END IF
      IF ((h2b .le. h8b) .and. (p6b .le. p13b) .and. (p13b .lt. p7b)) TH
     &EN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p13b_2 - noab - 1 + nvab * (p6b_2 - noab - 1
     & + nvab * (h8b_2 - 1 + noab * (h2b_2 - 1 + noab * (h1b_2 - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h8b-1),int_mb(k_range+p6b-1)
     &,int_mb(k_range+p13b-1),int_mb(k_range+p7b-1),5,2,1,3,6,4,-1.0d0,.
     &false.)
      END IF
      IF ((h2b .le. h8b) .and. (p13b .lt. p6b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p13b_2 - noab - 1
     & + nvab * (h8b_2 - 1 + noab * (h2b_2 - 1 + noab * (h1b_2 - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h8b-1),int_mb(k_range+p13b-1
     &),int_mb(k_range+p6b-1),int_mb(k_range+p7b-1),4,2,1,3,6,5,1.0d0,.f
     &alse.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_11_
     &2',6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      isuperp = 1
      IF (p6b .eq. p7b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,2.0d0/FACTOR
     &IAL(nsuperp(1))/FACTORIAL(nsuperp(2)),dbl_mb(k_a_sort),dim_common,
     &dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_11_2',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_11_2',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_11_2',9,MA_ERR)
      CALL TCE_SORT_4(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p13b-1
     &),int_mb(k_range+h2b-1),int_mb(k_range+h1b-1),int_mb(k_range+h11b-
     &1),3,2,4,1,1.0d0/2.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p13b 
     &- noab - 1 + nvab * (h11b - 1 + noab * (h2b - 1 + noab * (h1b - 1)
     &))))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_11_
     &2',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_11_2',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_11_3(d_a,k_a_offset,d_b,k_b_offset
     &,d_c,k_c_offset)
C     i2 ( h1 h2 h11 p13 )_yx + = 1/12 * Sum ( h10 h9 p8 p7 p6 ) * x ( p6 p7 p8 h9 h10 h11 )_x * y ( h1 h2 h9 h10 p6 p7 p8 p13 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h1b
      INTEGER h2b
      INTEGER h11b
      INTEGER p13b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p6b
      INTEGER p7b
      INTEGER p8b
      INTEGER h9b
      INTEGER h10b
      INTEGER p6b_1
      INTEGER p7b_1
      INTEGER p8b_1
      INTEGER h11b_1
      INTEGER h9b_1
      INTEGER h10b_1
      INTEGER h1b_2
      INTEGER h2b_2
      INTEGER h9b_2
      INTEGER h10b_2
      INTEGER p13b_2
      INTEGER p6b_2
      INTEGER p7b_2
      INTEGER p8b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(3)
      INTEGER isuperp
      INTEGER nsubh(2)
      INTEGER isubh
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h1b = 1,noab
      DO h2b = h1b,noab
      DO h11b = 1,noab
      DO p13b = noab+1,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h1b-1)+int_mb(k_spin+h2b-1
     &)+int_mb(k_spin+h11b-1)+int_mb(k_spin+p13b-1).ne.8)) THEN
      IF (int_mb(k_spin+h1b-1)+int_mb(k_spin+h2b-1) .eq. int_mb(k_spin+h
     &11b-1)+int_mb(k_spin+p13b-1)) THEN
      IF (ieor(int_mb(k_sym+h1b-1),ieor(int_mb(k_sym+h2b-1),ieor(int_mb(
     &k_sym+h11b-1),int_mb(k_sym+p13b-1)))) .eq. ieor(irrep_y,irrep_x)) 
     &THEN
      dimc = int_mb(k_range+h1b-1) * int_mb(k_range+h2b-1) * int_mb(k_ra
     &nge+h11b-1) * int_mb(k_range+p13b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_11_3',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p6b = noab+1,noab+nvab
      DO p7b = p6b,noab+nvab
      DO p8b = p7b,noab+nvab
      DO h9b = 1,noab
      DO h10b = h9b,noab
      IF (int_mb(k_active+p6b-1)+int_mb(k_active+p7b-1)+int_mb(k_active+
     &p8b-1) .ge. numact) THEN
      IF (int_mb(k_active+h11b-1)+int_mb(k_active+h9b-1)+int_mb(k_active
     &+h10b-1) .ge. numact) THEN
      IF (int_mb(k_active+h1b-1)+int_mb(k_active+h2b-1)+int_mb(k_active+
     &h9b-1)+int_mb(k_active+h10b-1) .ge. numacq) THEN
      IF (int_mb(k_active+p13b-1)+int_mb(k_active+p6b-1)+int_mb(k_active
     &+p7b-1)+int_mb(k_active+p8b-1) .ge. numacq) THEN
      IF (int_mb(k_spin+p6b-1)+int_mb(k_spin+p7b-1)+int_mb(k_spin+p8b-1)
     & .eq. int_mb(k_spin+h11b-1)+int_mb(k_spin+h9b-1)+int_mb(k_spin+h10
     &b-1)) THEN
      IF (ieor(int_mb(k_sym+p6b-1),ieor(int_mb(k_sym+p7b-1),ieor(int_mb(
     &k_sym+p8b-1),ieor(int_mb(k_sym+h11b-1),ieor(int_mb(k_sym+h9b-1),in
     &t_mb(k_sym+h10b-1)))))) .eq. irrep_x) THEN
      CALL TCE_RESTRICTED_6(p6b,p7b,p8b,h11b,h9b,h10b,p6b_1,p7b_1,p8b_1,
     &h11b_1,h9b_1,h10b_1)
      CALL TCE_RESTRICTED_8(h1b,h2b,h9b,h10b,p13b,p6b,p7b,p8b,h1b_2,h2b_
     &2,h9b_2,h10b_2,p13b_2,p6b_2,p7b_2,p8b_2)
      dim_common = int_mb(k_range+p6b-1) * int_mb(k_range+p7b-1) * int_m
     &b(k_range+p8b-1) * int_mb(k_range+h9b-1) * int_mb(k_range+h10b-1)
      dima_sort = int_mb(k_range+h11b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h1b-1) * int_mb(k_range+h2b-1) * int_mb
     &(k_range+p13b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_11_3',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_11_3',2,MA_ERR)
      IF ((h10b .le. h11b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h11b_
     &1 - 1 + noab * (h10b_1 - 1 + noab * (h9b_1 - 1 + noab * (p8b_1 - n
     &oab - 1 + nvab * (p7b_1 - noab - 1 + nvab * (p6b_1 - noab - 1)))))
     &))
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p6b-1)
     &,int_mb(k_range+p7b-1),int_mb(k_range+p8b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h10b-1),int_mb(k_range+h11b-1),6,5,4,3,2,1,1.0d0,.
     &false.)
      END IF
      IF ((h9b .le. h11b) .and. (h11b .lt. h10b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h10b_
     &1 - 1 + noab * (h11b_1 - 1 + noab * (h9b_1 - 1 + noab * (p8b_1 - n
     &oab - 1 + nvab * (p7b_1 - noab - 1 + nvab * (p6b_1 - noab - 1)))))
     &))
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p6b-1)
     &,int_mb(k_range+p7b-1),int_mb(k_range+p8b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h11b-1),int_mb(k_range+h10b-1),5,6,4,3,2,1,-1.0d0,
     &.false.)
      END IF
      IF ((h11b .lt. h9b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h10b_
     &1 - 1 + noab * (h9b_1 - 1 + noab * (h11b_1 - 1 + noab * (p8b_1 - n
     &oab - 1 + nvab * (p7b_1 - noab - 1 + nvab * (p6b_1 - noab - 1)))))
     &))
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p6b-1)
     &,int_mb(k_range+p7b-1),int_mb(k_range+p8b-1),int_mb(k_range+h11b-1
     &),int_mb(k_range+h9b-1),int_mb(k_range+h10b-1),4,6,5,3,2,1,1.0d0,.
     &false.)
      END IF
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_11_
     &3',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_11_3',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_11_3',5,MA_ERR)
      IF ((h10b .lt. h1b) .and. (p8b .le. p13b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p13b_
     &2 - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p7b_2 - noab - 1
     & + nvab * (p6b_2 - noab - 1 + nvab * (h2b_2 - 1 + noab * (h1b_2 - 
     &1 + noab * (h10b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h10b-1),int_mb(k_range+h1b-1),int_mb(k_range+h2b-1
     &),int_mb(k_range+p6b-1),int_mb(k_range+p7b-1),int_mb(k_range+p8b-1
     &),int_mb(k_range+p13b-1),8,4,3,2,1,7,6,5,1.0d0,.false.)
      END IF
      IF ((h10b .lt. h1b) .and. (p7b .le. p13b) .and. (p13b .lt. p8b)) T
     &HEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p13b_2 - noab - 1 + nvab * (p7b_2 - noab - 1
     & + nvab * (p6b_2 - noab - 1 + nvab * (h2b_2 - 1 + noab * (h1b_2 - 
     &1 + noab * (h10b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h10b-1),int_mb(k_range+h1b-1),int_mb(k_range+h2b-1
     &),int_mb(k_range+p6b-1),int_mb(k_range+p7b-1),int_mb(k_range+p13b-
     &1),int_mb(k_range+p8b-1),7,4,3,2,1,8,6,5,-1.0d0,.false.)
      END IF
      IF ((h10b .lt. h1b) .and. (p6b .le. p13b) .and. (p13b .lt. p7b)) T
     &HEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p13b_2 - noab - 1
     & + nvab * (p6b_2 - noab - 1 + nvab * (h2b_2 - 1 + noab * (h1b_2 - 
     &1 + noab * (h10b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h10b-1),int_mb(k_range+h1b-1),int_mb(k_range+h2b-1
     &),int_mb(k_range+p6b-1),int_mb(k_range+p13b-1),int_mb(k_range+p7b-
     &1),int_mb(k_range+p8b-1),6,4,3,2,1,8,7,5,1.0d0,.false.)
      END IF
      IF ((h10b .lt. h1b) .and. (p13b .lt. p6b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p6b_2 - noab - 1 
     &+ nvab * (p13b_2 - noab - 1 + nvab * (h2b_2 - 1 + noab * (h1b_2 - 
     &1 + noab * (h10b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h10b-1),int_mb(k_range+h1b-1),int_mb(k_range+h2b-1
     &),int_mb(k_range+p13b-1),int_mb(k_range+p6b-1),int_mb(k_range+p7b-
     &1),int_mb(k_range+p8b-1),5,4,3,2,1,8,7,6,-1.0d0,.false.)
      END IF
      IF ((h9b .lt. h1b) .and. (h1b .le. h10b) .and. (h10b .lt. h2b) .an
     &d. (p8b .le. p13b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p13b_
     &2 - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p7b_2 - noab - 1
     & + nvab * (p6b_2 - noab - 1 + nvab * (h2b_2 - 1 + noab * (h10b_2 -
     & 1 + noab * (h1b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h1b-1),int_mb(k_range+h10b-1),int_mb(k_range+h2b-1
     &),int_mb(k_range+p6b-1),int_mb(k_range+p7b-1),int_mb(k_range+p8b-1
     &),int_mb(k_range+p13b-1),8,4,2,3,1,7,6,5,-1.0d0,.false.)
      END IF
      IF ((h9b .lt. h1b) .and. (h1b .le. h10b) .and. (h10b .lt. h2b) .an
     &d. (p7b .le. p13b) .and. (p13b .lt. p8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p13b_2 - noab - 1 + nvab * (p7b_2 - noab - 1
     & + nvab * (p6b_2 - noab - 1 + nvab * (h2b_2 - 1 + noab * (h10b_2 -
     & 1 + noab * (h1b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h1b-1),int_mb(k_range+h10b-1),int_mb(k_range+h2b-1
     &),int_mb(k_range+p6b-1),int_mb(k_range+p7b-1),int_mb(k_range+p13b-
     &1),int_mb(k_range+p8b-1),7,4,2,3,1,8,6,5,1.0d0,.false.)
      END IF
      IF ((h9b .lt. h1b) .and. (h1b .le. h10b) .and. (h10b .lt. h2b) .an
     &d. (p6b .le. p13b) .and. (p13b .lt. p7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p13b_2 - noab - 1
     & + nvab * (p6b_2 - noab - 1 + nvab * (h2b_2 - 1 + noab * (h10b_2 -
     & 1 + noab * (h1b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h1b-1),int_mb(k_range+h10b-1),int_mb(k_range+h2b-1
     &),int_mb(k_range+p6b-1),int_mb(k_range+p13b-1),int_mb(k_range+p7b-
     &1),int_mb(k_range+p8b-1),6,4,2,3,1,8,7,5,-1.0d0,.false.)
      END IF
      IF ((h9b .lt. h1b) .and. (h1b .le. h10b) .and. (h10b .lt. h2b) .an
     &d. (p13b .lt. p6b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p6b_2 - noab - 1 
     &+ nvab * (p13b_2 - noab - 1 + nvab * (h2b_2 - 1 + noab * (h10b_2 -
     & 1 + noab * (h1b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h1b-1),int_mb(k_range+h10b-1),int_mb(k_range+h2b-1
     &),int_mb(k_range+p13b-1),int_mb(k_range+p6b-1),int_mb(k_range+p7b-
     &1),int_mb(k_range+p8b-1),5,4,2,3,1,8,7,6,1.0d0,.false.)
      END IF
      IF ((h9b .lt. h1b) .and. (h2b .le. h10b) .and. (p8b .le. p13b)) TH
     &EN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p13b_
     &2 - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p7b_2 - noab - 1
     & + nvab * (p6b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h2b_2 -
     & 1 + noab * (h1b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h1b-1),int_mb(k_range+h2b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p6b-1),int_mb(k_range+p7b-1),int_mb(k_range+p8b-1
     &),int_mb(k_range+p13b-1),8,3,2,4,1,7,6,5,1.0d0,.false.)
      END IF
      IF ((h9b .lt. h1b) .and. (h2b .le. h10b) .and. (p7b .le. p13b) .an
     &d. (p13b .lt. p8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p13b_2 - noab - 1 + nvab * (p7b_2 - noab - 1
     & + nvab * (p6b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h2b_2 -
     & 1 + noab * (h1b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h1b-1),int_mb(k_range+h2b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p6b-1),int_mb(k_range+p7b-1),int_mb(k_range+p13b-
     &1),int_mb(k_range+p8b-1),7,3,2,4,1,8,6,5,-1.0d0,.false.)
      END IF
      IF ((h9b .lt. h1b) .and. (h2b .le. h10b) .and. (p6b .le. p13b) .an
     &d. (p13b .lt. p7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p13b_2 - noab - 1
     & + nvab * (p6b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h2b_2 -
     & 1 + noab * (h1b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h1b-1),int_mb(k_range+h2b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p6b-1),int_mb(k_range+p13b-1),int_mb(k_range+p7b-
     &1),int_mb(k_range+p8b-1),6,3,2,4,1,8,7,5,1.0d0,.false.)
      END IF
      IF ((h9b .lt. h1b) .and. (h2b .le. h10b) .and. (p13b .lt. p6b)) TH
     &EN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p6b_2 - noab - 1 
     &+ nvab * (p13b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h2b_2 -
     & 1 + noab * (h1b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h1b-1),int_mb(k_range+h2b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p13b-1),int_mb(k_range+p6b-1),int_mb(k_range+p7b-
     &1),int_mb(k_range+p8b-1),5,3,2,4,1,8,7,6,-1.0d0,.false.)
      END IF
      IF ((h1b .le. h9b) .and. (h10b .lt. h2b) .and. (p8b .le. p13b)) TH
     &EN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p13b_
     &2 - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p7b_2 - noab - 1
     & + nvab * (p6b_2 - noab - 1 + nvab * (h2b_2 - 1 + noab * (h10b_2 -
     & 1 + noab * (h9b_2 - 1 + noab * (h1b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h10b-1),int_mb(k_range+h2b-1
     &),int_mb(k_range+p6b-1),int_mb(k_range+p7b-1),int_mb(k_range+p8b-1
     &),int_mb(k_range+p13b-1),8,4,1,3,2,7,6,5,1.0d0,.false.)
      END IF
      IF ((h1b .le. h9b) .and. (h10b .lt. h2b) .and. (p7b .le. p13b) .an
     &d. (p13b .lt. p8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p13b_2 - noab - 1 + nvab * (p7b_2 - noab - 1
     & + nvab * (p6b_2 - noab - 1 + nvab * (h2b_2 - 1 + noab * (h10b_2 -
     & 1 + noab * (h9b_2 - 1 + noab * (h1b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h10b-1),int_mb(k_range+h2b-1
     &),int_mb(k_range+p6b-1),int_mb(k_range+p7b-1),int_mb(k_range+p13b-
     &1),int_mb(k_range+p8b-1),7,4,1,3,2,8,6,5,-1.0d0,.false.)
      END IF
      IF ((h1b .le. h9b) .and. (h10b .lt. h2b) .and. (p6b .le. p13b) .an
     &d. (p13b .lt. p7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p13b_2 - noab - 1
     & + nvab * (p6b_2 - noab - 1 + nvab * (h2b_2 - 1 + noab * (h10b_2 -
     & 1 + noab * (h9b_2 - 1 + noab * (h1b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h10b-1),int_mb(k_range+h2b-1
     &),int_mb(k_range+p6b-1),int_mb(k_range+p13b-1),int_mb(k_range+p7b-
     &1),int_mb(k_range+p8b-1),6,4,1,3,2,8,7,5,1.0d0,.false.)
      END IF
      IF ((h1b .le. h9b) .and. (h10b .lt. h2b) .and. (p13b .lt. p6b)) TH
     &EN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p6b_2 - noab - 1 
     &+ nvab * (p13b_2 - noab - 1 + nvab * (h2b_2 - 1 + noab * (h10b_2 -
     & 1 + noab * (h9b_2 - 1 + noab * (h1b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h10b-1),int_mb(k_range+h2b-1
     &),int_mb(k_range+p13b-1),int_mb(k_range+p6b-1),int_mb(k_range+p7b-
     &1),int_mb(k_range+p8b-1),5,4,1,3,2,8,7,6,-1.0d0,.false.)
      END IF
      IF ((h1b .le. h9b) .and. (h9b .lt. h2b) .and. (h2b .le. h10b) .and
     &. (p8b .le. p13b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p13b_
     &2 - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p7b_2 - noab - 1
     & + nvab * (p6b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h2b_2 -
     & 1 + noab * (h9b_2 - 1 + noab * (h1b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h2b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p6b-1),int_mb(k_range+p7b-1),int_mb(k_range+p8b-1
     &),int_mb(k_range+p13b-1),8,3,1,4,2,7,6,5,-1.0d0,.false.)
      END IF
      IF ((h1b .le. h9b) .and. (h9b .lt. h2b) .and. (h2b .le. h10b) .and
     &. (p7b .le. p13b) .and. (p13b .lt. p8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p13b_2 - noab - 1 + nvab * (p7b_2 - noab - 1
     & + nvab * (p6b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h2b_2 -
     & 1 + noab * (h9b_2 - 1 + noab * (h1b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h2b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p6b-1),int_mb(k_range+p7b-1),int_mb(k_range+p13b-
     &1),int_mb(k_range+p8b-1),7,3,1,4,2,8,6,5,1.0d0,.false.)
      END IF
      IF ((h1b .le. h9b) .and. (h9b .lt. h2b) .and. (h2b .le. h10b) .and
     &. (p6b .le. p13b) .and. (p13b .lt. p7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p13b_2 - noab - 1
     & + nvab * (p6b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h2b_2 -
     & 1 + noab * (h9b_2 - 1 + noab * (h1b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h2b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p6b-1),int_mb(k_range+p13b-1),int_mb(k_range+p7b-
     &1),int_mb(k_range+p8b-1),6,3,1,4,2,8,7,5,-1.0d0,.false.)
      END IF
      IF ((h1b .le. h9b) .and. (h9b .lt. h2b) .and. (h2b .le. h10b) .and
     &. (p13b .lt. p6b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p6b_2 - noab - 1 
     &+ nvab * (p13b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h2b_2 -
     & 1 + noab * (h9b_2 - 1 + noab * (h1b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h2b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p13b-1),int_mb(k_range+p6b-1),int_mb(k_range+p7b-
     &1),int_mb(k_range+p8b-1),5,3,1,4,2,8,7,6,1.0d0,.false.)
      END IF
      IF ((h2b .le. h9b) .and. (p8b .le. p13b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p13b_
     &2 - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p7b_2 - noab - 1
     & + nvab * (p6b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h9b_2 -
     & 1 + noab * (h2b_2 - 1 + noab * (h1b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h9b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p6b-1),int_mb(k_range+p7b-1),int_mb(k_range+p8b-1
     &),int_mb(k_range+p13b-1),8,2,1,4,3,7,6,5,1.0d0,.false.)
      END IF
      IF ((h2b .le. h9b) .and. (p7b .le. p13b) .and. (p13b .lt. p8b)) TH
     &EN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p13b_2 - noab - 1 + nvab * (p7b_2 - noab - 1
     & + nvab * (p6b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h9b_2 -
     & 1 + noab * (h2b_2 - 1 + noab * (h1b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h9b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p6b-1),int_mb(k_range+p7b-1),int_mb(k_range+p13b-
     &1),int_mb(k_range+p8b-1),7,2,1,4,3,8,6,5,-1.0d0,.false.)
      END IF
      IF ((h2b .le. h9b) .and. (p6b .le. p13b) .and. (p13b .lt. p7b)) TH
     &EN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p13b_2 - noab - 1
     & + nvab * (p6b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h9b_2 -
     & 1 + noab * (h2b_2 - 1 + noab * (h1b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h9b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p6b-1),int_mb(k_range+p13b-1),int_mb(k_range+p7b-
     &1),int_mb(k_range+p8b-1),6,2,1,4,3,8,7,5,1.0d0,.false.)
      END IF
      IF ((h2b .le. h9b) .and. (p13b .lt. p6b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p6b_2 - noab - 1 
     &+ nvab * (p13b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h9b_2 -
     & 1 + noab * (h2b_2 - 1 + noab * (h1b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h9b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p13b-1),int_mb(k_range+p6b-1),int_mb(k_range+p7b-
     &1),int_mb(k_range+p8b-1),5,2,1,4,3,8,7,6,-1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_11_
     &3',6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      nsuperp(3) = 1
      isuperp = 1
      IF (p6b .eq. p7b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      IF (p7b .eq. p8b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      nsubh(1) = 1
      nsubh(2) = 1
      isubh = 1
      IF (h9b .eq. h10b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,12.0d0/FACTO
     &RIAL(nsuperp(1))/FACTORIAL(nsuperp(2))/FACTORIAL(nsuperp(3))/FACTO
     &RIAL(nsubh(1))/FACTORIAL(nsubh(2)),dbl_mb(k_a_sort),dim_common,dbl
     &_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_11_3',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_11_3',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_11_3',9,MA_ERR)
      CALL TCE_SORT_4(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p13b-1
     &),int_mb(k_range+h2b-1),int_mb(k_range+h1b-1),int_mb(k_range+h11b-
     &1),3,2,4,1,1.0d0/12.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p13b 
     &- noab - 1 + nvab * (h11b - 1 + noab * (h2b - 1 + noab * (h1b - 1)
     &))))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_11_
     &3',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_11_3',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_11_4(d_a,k_a_offset,d_b,k_b_offset
     &,d_c,k_c_offset)
C     i2 ( h1 h2 h11 p13 )_yxt + = -5/18 * Sum ( h7 p5 p6 ) * t ( p5 p6 h7 h11 )_t * i3 ( h1 h2 h7 p5 p6 p13 )_yx
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h1b
      INTEGER h2b
      INTEGER h11b
      INTEGER p13b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p5b
      INTEGER p6b
      INTEGER h7b
      INTEGER p5b_1
      INTEGER p6b_1
      INTEGER h11b_1
      INTEGER h7b_1
      INTEGER h1b_2
      INTEGER h2b_2
      INTEGER h7b_2
      INTEGER p13b_2
      INTEGER p5b_2
      INTEGER p6b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(2)
      INTEGER isuperp
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h1b = 1,noab
      DO h2b = h1b,noab
      DO h11b = 1,noab
      DO p13b = noab+1,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h1b-1)+int_mb(k_spin+h2b-1
     &)+int_mb(k_spin+h11b-1)+int_mb(k_spin+p13b-1).ne.8)) THEN
      IF (int_mb(k_spin+h1b-1)+int_mb(k_spin+h2b-1) .eq. int_mb(k_spin+h
     &11b-1)+int_mb(k_spin+p13b-1)) THEN
      IF (ieor(int_mb(k_sym+h1b-1),ieor(int_mb(k_sym+h2b-1),ieor(int_mb(
     &k_sym+h11b-1),int_mb(k_sym+p13b-1)))) .eq. ieor(irrep_y,ieor(irrep
     &_x,irrep_t))) THEN
      dimc = int_mb(k_range+h1b-1) * int_mb(k_range+h2b-1) * int_mb(k_ra
     &nge+h11b-1) * int_mb(k_range+p13b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_11_4',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p5b = noab+1,noab+nvab
      DO p6b = p5b,noab+nvab
      DO h7b = 1,noab
      IF (int_mb(k_spin+p5b-1)+int_mb(k_spin+p6b-1) .eq. int_mb(k_spin+h
     &11b-1)+int_mb(k_spin+h7b-1)) THEN
      IF (ieor(int_mb(k_sym+p5b-1),ieor(int_mb(k_sym+p6b-1),ieor(int_mb(
     &k_sym+h11b-1),int_mb(k_sym+h7b-1)))) .eq. irrep_t) THEN
      CALL TCE_RESTRICTED_4(p5b,p6b,h11b,h7b,p5b_1,p6b_1,h11b_1,h7b_1)
      CALL TCE_RESTRICTED_6(h1b,h2b,h7b,p13b,p5b,p6b,h1b_2,h2b_2,h7b_2,p
     &13b_2,p5b_2,p6b_2)
      dim_common = int_mb(k_range+p5b-1) * int_mb(k_range+p6b-1) * int_m
     &b(k_range+h7b-1)
      dima_sort = int_mb(k_range+h11b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h1b-1) * int_mb(k_range+h2b-1) * int_mb
     &(k_range+p13b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_11_4',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_11_4',2,MA_ERR)
      IF ((h7b .le. h11b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h11b_
     &1 - 1 + noab * (h7b_1 - 1 + noab * (p6b_1 - noab - 1 + nvab * (p5b
     &_1 - noab - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h11b-1
     &),4,3,2,1,1.0d0,.false.)
      END IF
      IF ((h11b .lt. h7b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h7b_1
     & - 1 + noab * (h11b_1 - 1 + noab * (p6b_1 - noab - 1 + nvab * (p5b
     &_1 - noab - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p6b-1),int_mb(k_range+h11b-1),int_mb(k_range+h7b-1
     &),3,4,2,1,-1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_11_
     &4',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_11_4',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_11_4',5,MA_ERR)
      IF ((h7b .lt. h1b) .and. (p6b .le. p13b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p13b_
     &2 - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p5b_2 - noab - 1
     & + nvab * (h2b_2 - 1 + noab * (h1b_2 - 1 + noab * (h7b_2 - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h1b-1),int_mb(k_range+h2b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p6b-1),int_mb(k_range+p13b-1),6,3,2,1,5,4,1.0d0,.f
     &alse.)
      END IF
      IF ((h7b .lt. h1b) .and. (p5b .le. p13b) .and. (p13b .lt. p6b)) TH
     &EN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p13b_2 - noab - 1 + nvab * (p5b_2 - noab - 1
     & + nvab * (h2b_2 - 1 + noab * (h1b_2 - 1 + noab * (h7b_2 - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h1b-1),int_mb(k_range+h2b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p13b-1),int_mb(k_range+p6b-1),5,3,2,1,6,4,-1.0d0,.
     &false.)
      END IF
      IF ((h7b .lt. h1b) .and. (p13b .lt. p5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p13b_2 - noab - 1
     & + nvab * (h2b_2 - 1 + noab * (h1b_2 - 1 + noab * (h7b_2 - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h1b-1),int_mb(k_range+h2b-1),int_mb(k_range+p13b-1
     &),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1),4,3,2,1,6,5,1.0d0,.f
     &alse.)
      END IF
      IF ((h1b .le. h7b) .and. (h7b .lt. h2b) .and. (p6b .le. p13b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p13b_
     &2 - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p5b_2 - noab - 1
     & + nvab * (h2b_2 - 1 + noab * (h7b_2 - 1 + noab * (h1b_2 - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h2b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p6b-1),int_mb(k_range+p13b-1),6,3,1,2,5,4,-1.0d0,.
     &false.)
      END IF
      IF ((h1b .le. h7b) .and. (h7b .lt. h2b) .and. (p5b .le. p13b) .and
     &. (p13b .lt. p6b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p13b_2 - noab - 1 + nvab * (p5b_2 - noab - 1
     & + nvab * (h2b_2 - 1 + noab * (h7b_2 - 1 + noab * (h1b_2 - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h2b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p13b-1),int_mb(k_range+p6b-1),5,3,1,2,6,4,1.0d0,.f
     &alse.)
      END IF
      IF ((h1b .le. h7b) .and. (h7b .lt. h2b) .and. (p13b .lt. p5b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p13b_2 - noab - 1
     & + nvab * (h2b_2 - 1 + noab * (h7b_2 - 1 + noab * (h1b_2 - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h2b-1),int_mb(k_range+p13b-1
     &),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1),4,3,1,2,6,5,-1.0d0,.
     &false.)
      END IF
      IF ((h2b .le. h7b) .and. (p6b .le. p13b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p13b_
     &2 - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p5b_2 - noab - 1
     & + nvab * (h7b_2 - 1 + noab * (h2b_2 - 1 + noab * (h1b_2 - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h7b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p6b-1),int_mb(k_range+p13b-1),6,2,1,3,5,4,1.0d0,.f
     &alse.)
      END IF
      IF ((h2b .le. h7b) .and. (p5b .le. p13b) .and. (p13b .lt. p6b)) TH
     &EN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p13b_2 - noab - 1 + nvab * (p5b_2 - noab - 1
     & + nvab * (h7b_2 - 1 + noab * (h2b_2 - 1 + noab * (h1b_2 - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h7b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p13b-1),int_mb(k_range+p6b-1),5,2,1,3,6,4,-1.0d0,.
     &false.)
      END IF
      IF ((h2b .le. h7b) .and. (p13b .lt. p5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p13b_2 - noab - 1
     & + nvab * (h7b_2 - 1 + noab * (h2b_2 - 1 + noab * (h1b_2 - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h7b-1),int_mb(k_range+p13b-1
     &),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1),4,2,1,3,6,5,1.0d0,.f
     &alse.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_11_
     &4',6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      isuperp = 1
      IF (p5b .eq. p6b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,2.0d0/FACTOR
     &IAL(nsuperp(1))/FACTORIAL(nsuperp(2)),dbl_mb(k_a_sort),dim_common,
     &dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_11_4',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_11_4',8,MA_ERR)
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_11_4',9,MA_ERR)
      CALL TCE_SORT_4(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p13b-1
     &),int_mb(k_range+h2b-1),int_mb(k_range+h1b-1),int_mb(k_range+h11b-
     &1),3,2,4,1,-5.0d0/18.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p13b 
     &- noab - 1 + nvab * (h11b - 1 + noab * (h2b - 1 + noab * (h1b - 1)
     &))))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_11_
     &4',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_11_4',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_11_4_1(d_a,k_a_offset,d_b,k_b_offs
     &et,d_c,k_c_offset)
C     i3 ( h1 h2 h7 p5 p6 p13 )_yx + = 1 * Sum ( h10 p9 ) * x ( p9 h10 )_x * i4 ( h1 h2 h7 h10 p5 p6 p9 p13 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h1b
      INTEGER h2b
      INTEGER h7b
      INTEGER p5b
      INTEGER p6b
      INTEGER p13b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p9b
      INTEGER h10b
      INTEGER p9b_1
      INTEGER h10b_1
      INTEGER h1b_2
      INTEGER h2b_2
      INTEGER h7b_2
      INTEGER h10b_2
      INTEGER p5b_2
      INTEGER p6b_2
      INTEGER p13b_2
      INTEGER p9b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h1b = 1,noab
      DO h2b = h1b,noab
      DO h7b = h2b,noab
      DO p5b = noab+1,noab+nvab
      DO p6b = p5b,noab+nvab
      DO p13b = p6b,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h1b-1)+int_mb(k_spin+h2b-1
     &)+int_mb(k_spin+h7b-1)+int_mb(k_spin+p5b-1)+int_mb(k_spin+p6b-1)+i
     &nt_mb(k_spin+p13b-1).ne.12)) THEN
      IF (int_mb(k_spin+h1b-1)+int_mb(k_spin+h2b-1)+int_mb(k_spin+h7b-1)
     & .eq. int_mb(k_spin+p5b-1)+int_mb(k_spin+p6b-1)+int_mb(k_spin+p13b
     &-1)) THEN
      IF (ieor(int_mb(k_sym+h1b-1),ieor(int_mb(k_sym+h2b-1),ieor(int_mb(
     &k_sym+h7b-1),ieor(int_mb(k_sym+p5b-1),ieor(int_mb(k_sym+p6b-1),int
     &_mb(k_sym+p13b-1)))))) .eq. ieor(irrep_y,irrep_x)) THEN
      dimc = int_mb(k_range+h1b-1) * int_mb(k_range+h2b-1) * int_mb(k_ra
     &nge+h7b-1) * int_mb(k_range+p5b-1) * int_mb(k_range+p6b-1) * int_m
     &b(k_range+p13b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_11_4_1',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p9b = noab+1,noab+nvab
      DO h10b = 1,noab
      IF (int_mb(k_spin+p9b-1) .eq. int_mb(k_spin+h10b-1)) THEN
      IF (ieor(int_mb(k_sym+p9b-1),int_mb(k_sym+h10b-1)) .eq. irrep_x) T
     &HEN
      CALL TCE_RESTRICTED_2(p9b,h10b,p9b_1,h10b_1)
      CALL TCE_RESTRICTED_8(h1b,h2b,h7b,h10b,p5b,p6b,p13b,p9b,h1b_2,h2b_
     &2,h7b_2,h10b_2,p5b_2,p6b_2,p13b_2,p9b_2)
      dim_common = int_mb(k_range+p9b-1) * int_mb(k_range+h10b-1)
      dima_sort = 1
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h1b-1) * int_mb(k_range+h2b-1) * int_mb
     &(k_range+h7b-1) * int_mb(k_range+p5b-1) * int_mb(k_range+p6b-1) * 
     &int_mb(k_range+p13b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_11_4_1',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_11_4_1',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h10b_
     &1 - 1 + noab * (p9b_1 - noab - 1)))
      CALL TCE_SORT_2(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p9b-1)
     &,int_mb(k_range+h10b-1),2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_11_
     &4_1',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_11_4_1',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_11_4_1',5,MA_ERR)
      IF ((h10b .lt. h1b) .and. (p9b .lt. p5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p13b_
     &2 - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p5b_2 - noab - 1
     & + nvab * (p9b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h2b_2 - 
     &1 + noab * (h1b_2 - 1 + noab * (h10b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h10b-1
     &),int_mb(k_range+h1b-1),int_mb(k_range+h2b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p9b-1),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1
     &),int_mb(k_range+p13b-1),8,7,6,4,3,2,1,5,-1.0d0,.false.)
      END IF
      IF ((h10b .lt. h1b) .and. (p5b .le. p9b) .and. (p9b .lt. p6b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p13b_
     &2 - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p9b_2 - noab - 1
     & + nvab * (p5b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h2b_2 - 
     &1 + noab * (h1b_2 - 1 + noab * (h10b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h10b-1
     &),int_mb(k_range+h1b-1),int_mb(k_range+h2b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p5b-1),int_mb(k_range+p9b-1),int_mb(k_range+p6b-1
     &),int_mb(k_range+p13b-1),8,7,5,4,3,2,1,6,1.0d0,.false.)
      END IF
      IF ((h10b .lt. h1b) .and. (p6b .le. p9b) .and. (p9b .le. p13b)) TH
     &EN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p13b_
     &2 - noab - 1 + nvab * (p9b_2 - noab - 1 + nvab * (p6b_2 - noab - 1
     & + nvab * (p5b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h2b_2 - 
     &1 + noab * (h1b_2 - 1 + noab * (h10b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h10b-1
     &),int_mb(k_range+h1b-1),int_mb(k_range+h2b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1),int_mb(k_range+p9b-1
     &),int_mb(k_range+p13b-1),8,6,5,4,3,2,1,7,-1.0d0,.false.)
      END IF
      IF ((h10b .lt. h1b) .and. (p13b .lt. p9b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p9b_2
     & - noab - 1 + nvab * (p13b_2 - noab - 1 + nvab * (p6b_2 - noab - 1
     & + nvab * (p5b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h2b_2 - 
     &1 + noab * (h1b_2 - 1 + noab * (h10b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h10b-1
     &),int_mb(k_range+h1b-1),int_mb(k_range+h2b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1),int_mb(k_range+p13b-
     &1),int_mb(k_range+p9b-1),7,6,5,4,3,2,1,8,1.0d0,.false.)
      END IF
      IF ((h1b .le. h10b) .and. (h10b .lt. h2b) .and. (p9b .lt. p5b)) TH
     &EN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p13b_
     &2 - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p5b_2 - noab - 1
     & + nvab * (p9b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h2b_2 - 
     &1 + noab * (h10b_2 - 1 + noab * (h1b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h10b-1),int_mb(k_range+h2b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p9b-1),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1
     &),int_mb(k_range+p13b-1),8,7,6,4,3,1,2,5,1.0d0,.false.)
      END IF
      IF ((h1b .le. h10b) .and. (h10b .lt. h2b) .and. (p5b .le. p9b) .an
     &d. (p9b .lt. p6b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p13b_
     &2 - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p9b_2 - noab - 1
     & + nvab * (p5b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h2b_2 - 
     &1 + noab * (h10b_2 - 1 + noab * (h1b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h10b-1),int_mb(k_range+h2b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p5b-1),int_mb(k_range+p9b-1),int_mb(k_range+p6b-1
     &),int_mb(k_range+p13b-1),8,7,5,4,3,1,2,6,-1.0d0,.false.)
      END IF
      IF ((h1b .le. h10b) .and. (h10b .lt. h2b) .and. (p6b .le. p9b) .an
     &d. (p9b .le. p13b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p13b_
     &2 - noab - 1 + nvab * (p9b_2 - noab - 1 + nvab * (p6b_2 - noab - 1
     & + nvab * (p5b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h2b_2 - 
     &1 + noab * (h10b_2 - 1 + noab * (h1b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h10b-1),int_mb(k_range+h2b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1),int_mb(k_range+p9b-1
     &),int_mb(k_range+p13b-1),8,6,5,4,3,1,2,7,1.0d0,.false.)
      END IF
      IF ((h1b .le. h10b) .and. (h10b .lt. h2b) .and. (p13b .lt. p9b)) T
     &HEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p9b_2
     & - noab - 1 + nvab * (p13b_2 - noab - 1 + nvab * (p6b_2 - noab - 1
     & + nvab * (p5b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h2b_2 - 
     &1 + noab * (h10b_2 - 1 + noab * (h1b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h10b-1),int_mb(k_range+h2b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1),int_mb(k_range+p13b-
     &1),int_mb(k_range+p9b-1),7,6,5,4,3,1,2,8,-1.0d0,.false.)
      END IF
      IF ((h2b .le. h10b) .and. (h10b .lt. h7b) .and. (p9b .lt. p5b)) TH
     &EN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p13b_
     &2 - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p5b_2 - noab - 1
     & + nvab * (p9b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h10b_2 -
     & 1 + noab * (h2b_2 - 1 + noab * (h1b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h10b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p9b-1),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1
     &),int_mb(k_range+p13b-1),8,7,6,4,2,1,3,5,-1.0d0,.false.)
      END IF
      IF ((h2b .le. h10b) .and. (h10b .lt. h7b) .and. (p5b .le. p9b) .an
     &d. (p9b .lt. p6b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p13b_
     &2 - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p9b_2 - noab - 1
     & + nvab * (p5b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h10b_2 -
     & 1 + noab * (h2b_2 - 1 + noab * (h1b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h10b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p5b-1),int_mb(k_range+p9b-1),int_mb(k_range+p6b-1
     &),int_mb(k_range+p13b-1),8,7,5,4,2,1,3,6,1.0d0,.false.)
      END IF
      IF ((h2b .le. h10b) .and. (h10b .lt. h7b) .and. (p6b .le. p9b) .an
     &d. (p9b .le. p13b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p13b_
     &2 - noab - 1 + nvab * (p9b_2 - noab - 1 + nvab * (p6b_2 - noab - 1
     & + nvab * (p5b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h10b_2 -
     & 1 + noab * (h2b_2 - 1 + noab * (h1b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h10b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1),int_mb(k_range+p9b-1
     &),int_mb(k_range+p13b-1),8,6,5,4,2,1,3,7,-1.0d0,.false.)
      END IF
      IF ((h2b .le. h10b) .and. (h10b .lt. h7b) .and. (p13b .lt. p9b)) T
     &HEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p9b_2
     & - noab - 1 + nvab * (p13b_2 - noab - 1 + nvab * (p6b_2 - noab - 1
     & + nvab * (p5b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h10b_2 -
     & 1 + noab * (h2b_2 - 1 + noab * (h1b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h10b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1),int_mb(k_range+p13b-
     &1),int_mb(k_range+p9b-1),7,6,5,4,2,1,3,8,1.0d0,.false.)
      END IF
      IF ((h7b .le. h10b) .and. (p9b .lt. p5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p13b_
     &2 - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p5b_2 - noab - 1
     & + nvab * (p9b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h7b_2 -
     & 1 + noab * (h2b_2 - 1 + noab * (h1b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h7b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p9b-1),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1
     &),int_mb(k_range+p13b-1),8,7,6,3,2,1,4,5,1.0d0,.false.)
      END IF
      IF ((h7b .le. h10b) .and. (p5b .le. p9b) .and. (p9b .lt. p6b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p13b_
     &2 - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p9b_2 - noab - 1
     & + nvab * (p5b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h7b_2 -
     & 1 + noab * (h2b_2 - 1 + noab * (h1b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h7b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p5b-1),int_mb(k_range+p9b-1),int_mb(k_range+p6b-1
     &),int_mb(k_range+p13b-1),8,7,5,3,2,1,4,6,-1.0d0,.false.)
      END IF
      IF ((h7b .le. h10b) .and. (p6b .le. p9b) .and. (p9b .le. p13b)) TH
     &EN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p13b_
     &2 - noab - 1 + nvab * (p9b_2 - noab - 1 + nvab * (p6b_2 - noab - 1
     & + nvab * (p5b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h7b_2 -
     & 1 + noab * (h2b_2 - 1 + noab * (h1b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h7b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1),int_mb(k_range+p9b-1
     &),int_mb(k_range+p13b-1),8,6,5,3,2,1,4,7,1.0d0,.false.)
      END IF
      IF ((h7b .le. h10b) .and. (p13b .lt. p9b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p9b_2
     & - noab - 1 + nvab * (p13b_2 - noab - 1 + nvab * (p6b_2 - noab - 1
     & + nvab * (p5b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h7b_2 -
     & 1 + noab * (h2b_2 - 1 + noab * (h1b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h7b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1),int_mb(k_range+p13b-
     &1),int_mb(k_range+p9b-1),7,6,5,3,2,1,4,8,-1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_11_
     &4_1',6,MA_ERR)
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,1.0d0,dbl_mb
     &(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c
     &_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_11_4_1',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_11_4_1',8,MA_ERR)
      END IF
      END IF
      END IF
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_11_4_1',9,MA_ERR)
      CALL TCE_SORT_6(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p13b-1
     &),int_mb(k_range+p6b-1),int_mb(k_range+p5b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+h2b-1),int_mb(k_range+h1b-1),6,5,4,3,2,1,1.0d0,.f
     &alse.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p13b 
     &- noab - 1 + nvab * (p6b - noab - 1 + nvab * (p5b - noab - 1 + nva
     &b * (h7b - 1 + noab * (h2b - 1 + noab * (h1b - 1)))))))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_11_
     &4_1',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_11_4_1',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE OFFSET_eomccsdtq_density1_5_11_4_1(l_a_offset,k_a_offse
     &t,size)
C     i3 ( h1 h2 h7 p5 p6 p13 )_yx
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER l_a_offset
      INTEGER k_a_offset
      INTEGER length
      INTEGER addr
      INTEGER h1b
      INTEGER h2b
      INTEGER h7b
      INTEGER p5b
      INTEGER p6b
      INTEGER p13b
      DOUBLE PRECISION size
      length = 0
      DO h1b = 1,noab
      DO h2b = h1b,noab
      DO h7b = h2b,noab
      DO p5b = noab+1,noab+nvab
      DO p6b = p5b,noab+nvab
      DO p13b = p6b,noab+nvab
      IF (int_mb(k_spin+h1b-1)+int_mb(k_spin+h2b-1)+int_mb(k_spin+h7b-1)
     & .eq. int_mb(k_spin+p5b-1)+int_mb(k_spin+p6b-1)+int_mb(k_spin+p13b
     &-1)) THEN
      IF (ieor(int_mb(k_sym+h1b-1),ieor(int_mb(k_sym+h2b-1),ieor(int_mb(
     &k_sym+h7b-1),ieor(int_mb(k_sym+p5b-1),ieor(int_mb(k_sym+p6b-1),int
     &_mb(k_sym+p13b-1)))))) .eq. ieor(irrep_y,irrep_x)) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h1b-1)+int_mb(k_spin+h2b-1
     &)+int_mb(k_spin+h7b-1)+int_mb(k_spin+p5b-1)+int_mb(k_spin+p6b-1)+i
     &nt_mb(k_spin+p13b-1).ne.12)) THEN
      length = length + 1
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,2*length+1,'noname',l_a_offset,k_a_off
     &set)) CALL ERRQUIT('eomccsdtq_density1_5_11_4_1',0,MA_ERR)
      dbl_mb(k_a_offset) = dfloat(length)
      addr = 0
      size = 0.0d0
      DO h1b = 1,noab
      DO h2b = h1b,noab
      DO h7b = h2b,noab
      DO p5b = noab+1,noab+nvab
      DO p6b = p5b,noab+nvab
      DO p13b = p6b,noab+nvab
      IF (int_mb(k_spin+h1b-1)+int_mb(k_spin+h2b-1)+int_mb(k_spin+h7b-1)
     & .eq. int_mb(k_spin+p5b-1)+int_mb(k_spin+p6b-1)+int_mb(k_spin+p13b
     &-1)) THEN
      IF (ieor(int_mb(k_sym+h1b-1),ieor(int_mb(k_sym+h2b-1),ieor(int_mb(
     &k_sym+h7b-1),ieor(int_mb(k_sym+p5b-1),ieor(int_mb(k_sym+p6b-1),int
     &_mb(k_sym+p13b-1)))))) .eq. ieor(irrep_y,irrep_x)) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h1b-1)+int_mb(k_spin+h2b-1
     &)+int_mb(k_spin+h7b-1)+int_mb(k_spin+p5b-1)+int_mb(k_spin+p6b-1)+i
     &nt_mb(k_spin+p13b-1).ne.12)) THEN
      addr = addr + 1
      dbl_mb(k_a_offset+addr) = dfloat(p13b - noab - 1 + nvab * (p6b - n
     &oab - 1 + nvab * (p5b - noab - 1 + nvab * (h7b - 1 + noab * (h2b -
     & 1 + noab * (h1b - 1))))))
      dbl_mb(k_a_offset+length+addr) = size
      size = size + dfloat(int_mb(k_range+h1b-1)) * dfloat(int_mb(k_rang
     &e+h2b-1)) * dfloat(int_mb(k_range+h7b-1)) * dfloat(int_mb(k_range+
     &p5b-1)) * dfloat(int_mb(k_range+p6b-1)) * dfloat(int_mb(k_range+p1
     &3b-1))
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_11_4_1_1(d_a,k_a_offset,d_c,k_c_of
     &fset)
C     i4 ( h1 h2 h7 h10 p5 p6 p9 p13 )_y + = 1 * y ( h1 h2 h7 h10 p5 p6 p9 p13 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h1b
      INTEGER h2b
      INTEGER h7b
      INTEGER h10b
      INTEGER p5b
      INTEGER p6b
      INTEGER p9b
      INTEGER p13b
      INTEGER dimc
      INTEGER h1b_1
      INTEGER h2b_1
      INTEGER h7b_1
      INTEGER h10b_1
      INTEGER p5b_1
      INTEGER p6b_1
      INTEGER p9b_1
      INTEGER p13b_1
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h1b = 1,noab
      DO h2b = h1b,noab
      DO h7b = h2b,noab
      DO h10b = h7b,noab
      DO p5b = noab+1,noab+nvab
      DO p6b = p5b,noab+nvab
      DO p9b = p6b,noab+nvab
      DO p13b = p9b,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h1b-1)+int_mb(k_spin+h2b-1
     &)+int_mb(k_spin+h7b-1)+int_mb(k_spin+h10b-1)+int_mb(k_spin+p5b-1)+
     &int_mb(k_spin+p6b-1)+int_mb(k_spin+p9b-1)+int_mb(k_spin+p13b-1).ne
     &.16)) THEN
      IF (int_mb(k_active+h1b-1)+int_mb(k_active+h2b-1)+int_mb(k_active+
     &h7b-1)+int_mb(k_active+h10b-1) .ge. numacq) THEN
      IF (int_mb(k_active+p5b-1)+int_mb(k_active+p6b-1)+int_mb(k_active+
     &p9b-1)+int_mb(k_active+p13b-1) .ge. numacq) THEN
      IF (int_mb(k_spin+h1b-1)+int_mb(k_spin+h2b-1)+int_mb(k_spin+h7b-1)
     &+int_mb(k_spin+h10b-1) .eq. int_mb(k_spin+p5b-1)+int_mb(k_spin+p6b
     &-1)+int_mb(k_spin+p9b-1)+int_mb(k_spin+p13b-1)) THEN
      IF (ieor(int_mb(k_sym+h1b-1),ieor(int_mb(k_sym+h2b-1),ieor(int_mb(
     &k_sym+h7b-1),ieor(int_mb(k_sym+h10b-1),ieor(int_mb(k_sym+p5b-1),ie
     &or(int_mb(k_sym+p6b-1),ieor(int_mb(k_sym+p9b-1),int_mb(k_sym+p13b-
     &1)))))))) .eq. irrep_y) THEN
      dimc = int_mb(k_range+h1b-1) * int_mb(k_range+h2b-1) * int_mb(k_ra
     &nge+h7b-1) * int_mb(k_range+h10b-1) * int_mb(k_range+p5b-1) * int_
     &mb(k_range+p6b-1) * int_mb(k_range+p9b-1) * int_mb(k_range+p13b-1)
      CALL TCE_RESTRICTED_8(h1b,h2b,h7b,h10b,p5b,p6b,p9b,p13b,h1b_1,h2b_
     &1,h7b_1,h10b_1,p5b_1,p6b_1,p9b_1,p13b_1)
      dim_common = 1
      dima_sort = int_mb(k_range+h1b-1) * int_mb(k_range+h2b-1) * int_mb
     &(k_range+h7b-1) * int_mb(k_range+h10b-1) * int_mb(k_range+p5b-1) *
     & int_mb(k_range+p6b-1) * int_mb(k_range+p9b-1) * int_mb(k_range+p1
     &3b-1)
      dima = dim_common * dima_sort
      IF (dima .gt. 0) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_11_4_1_1',0,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_11_4_1_1',1,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(p13b_
     &1 - noab - 1 + nvab * (p9b_1 - noab - 1 + nvab * (p6b_1 - noab - 1
     & + nvab * (p5b_1 - noab - 1 + nvab * (h10b_1 - 1 + noab * (h7b_1 -
     & 1 + noab * (h2b_1 - 1 + noab * (h1b_1 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h7b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1),int_mb(k_range+p9b-1
     &),int_mb(k_range+p13b-1),8,7,6,5,4,3,2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_11_
     &4_1_1',2,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_11_4_1_1',3,MA_ERR)
      CALL TCE_SORT_8(dbl_mb(k_a_sort),dbl_mb(k_c),int_mb(k_range+p13b-1
     &),int_mb(k_range+p9b-1),int_mb(k_range+p6b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+h10b-1),int_mb(k_range+h7b-1),int_mb(k_range+h2b-
     &1),int_mb(k_range+h1b-1),8,7,6,5,4,3,2,1,1.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p13b 
     &- noab - 1 + nvab * (p9b - noab - 1 + nvab * (p6b - noab - 1 + nva
     &b * (p5b - noab - 1 + nvab * (h10b - 1 + noab * (h7b - 1 + noab * 
     &(h2b - 1 + noab * (h1b - 1)))))))))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_11_
     &4_1_1',4,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_11_4_1_1',5,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE OFFSET_eomccsdtq_density1_5_11_4_1_1(l_a_offset,k_a_off
     &set,size)
C     i4 ( h1 h2 h7 h10 p5 p6 p9 p13 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER l_a_offset
      INTEGER k_a_offset
      INTEGER length
      INTEGER addr
      INTEGER h1b
      INTEGER h2b
      INTEGER h7b
      INTEGER h10b
      INTEGER p5b
      INTEGER p6b
      INTEGER p9b
      INTEGER p13b
      DOUBLE PRECISION size
      length = 0
      DO h1b = 1,noab
      DO h2b = h1b,noab
      DO h7b = h2b,noab
      DO h10b = h7b,noab
      DO p5b = noab+1,noab+nvab
      DO p6b = p5b,noab+nvab
      DO p9b = p6b,noab+nvab
      DO p13b = p9b,noab+nvab
      IF (int_mb(k_spin+h1b-1)+int_mb(k_spin+h2b-1)+int_mb(k_spin+h7b-1)
     &+int_mb(k_spin+h10b-1) .eq. int_mb(k_spin+p5b-1)+int_mb(k_spin+p6b
     &-1)+int_mb(k_spin+p9b-1)+int_mb(k_spin+p13b-1)) THEN
      IF (ieor(int_mb(k_sym+h1b-1),ieor(int_mb(k_sym+h2b-1),ieor(int_mb(
     &k_sym+h7b-1),ieor(int_mb(k_sym+h10b-1),ieor(int_mb(k_sym+p5b-1),ie
     &or(int_mb(k_sym+p6b-1),ieor(int_mb(k_sym+p9b-1),int_mb(k_sym+p13b-
     &1)))))))) .eq. irrep_y) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h1b-1)+int_mb(k_spin+h2b-1
     &)+int_mb(k_spin+h7b-1)+int_mb(k_spin+h10b-1)+int_mb(k_spin+p5b-1)+
     &int_mb(k_spin+p6b-1)+int_mb(k_spin+p9b-1)+int_mb(k_spin+p13b-1).ne
     &.16)) THEN
      length = length + 1
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,2*length+1,'noname',l_a_offset,k_a_off
     &set)) CALL ERRQUIT('eomccsdtq_density1_5_11_4_1_1',0,MA_ERR)
      dbl_mb(k_a_offset) = dfloat(length)
      addr = 0
      size = 0.0d0
      DO h1b = 1,noab
      DO h2b = h1b,noab
      DO h7b = h2b,noab
      DO h10b = h7b,noab
      DO p5b = noab+1,noab+nvab
      DO p6b = p5b,noab+nvab
      DO p9b = p6b,noab+nvab
      DO p13b = p9b,noab+nvab
      IF (int_mb(k_spin+h1b-1)+int_mb(k_spin+h2b-1)+int_mb(k_spin+h7b-1)
     &+int_mb(k_spin+h10b-1) .eq. int_mb(k_spin+p5b-1)+int_mb(k_spin+p6b
     &-1)+int_mb(k_spin+p9b-1)+int_mb(k_spin+p13b-1)) THEN
      IF (ieor(int_mb(k_sym+h1b-1),ieor(int_mb(k_sym+h2b-1),ieor(int_mb(
     &k_sym+h7b-1),ieor(int_mb(k_sym+h10b-1),ieor(int_mb(k_sym+p5b-1),ie
     &or(int_mb(k_sym+p6b-1),ieor(int_mb(k_sym+p9b-1),int_mb(k_sym+p13b-
     &1)))))))) .eq. irrep_y) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h1b-1)+int_mb(k_spin+h2b-1
     &)+int_mb(k_spin+h7b-1)+int_mb(k_spin+h10b-1)+int_mb(k_spin+p5b-1)+
     &int_mb(k_spin+p6b-1)+int_mb(k_spin+p9b-1)+int_mb(k_spin+p13b-1).ne
     &.16)) THEN
      addr = addr + 1
      dbl_mb(k_a_offset+addr) = dfloat(p13b - noab - 1 + nvab * (p9b - n
     &oab - 1 + nvab * (p6b - noab - 1 + nvab * (p5b - noab - 1 + nvab *
     & (h10b - 1 + noab * (h7b - 1 + noab * (h2b - 1 + noab * (h1b - 1))
     &))))))
      dbl_mb(k_a_offset+length+addr) = size
      size = size + dfloat(int_mb(k_range+h1b-1)) * dfloat(int_mb(k_rang
     &e+h2b-1)) * dfloat(int_mb(k_range+h7b-1)) * dfloat(int_mb(k_range+
     &h10b-1)) * dfloat(int_mb(k_range+p5b-1)) * dfloat(int_mb(k_range+p
     &6b-1)) * dfloat(int_mb(k_range+p9b-1)) * dfloat(int_mb(k_range+p13
     &b-1))
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_11_4_1_2(d_a,k_a_offset,d_c,k_c_of
     &fset)
C     i4 ( h1 h2 h7 h10 p5 p6 p9 p13 )_y + = 4/5 * y ( h1 h2 h7 h10 p5 p6 p9 p13 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h1b
      INTEGER h2b
      INTEGER h7b
      INTEGER h10b
      INTEGER p5b
      INTEGER p6b
      INTEGER p9b
      INTEGER p13b
      INTEGER dimc
      INTEGER h1b_1
      INTEGER h2b_1
      INTEGER h7b_1
      INTEGER h10b_1
      INTEGER p5b_1
      INTEGER p6b_1
      INTEGER p9b_1
      INTEGER p13b_1
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h1b = 1,noab
      DO h2b = h1b,noab
      DO h7b = h2b,noab
      DO h10b = h7b,noab
      DO p5b = noab+1,noab+nvab
      DO p6b = p5b,noab+nvab
      DO p9b = p6b,noab+nvab
      DO p13b = p9b,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h1b-1)+int_mb(k_spin+h2b-1
     &)+int_mb(k_spin+h7b-1)+int_mb(k_spin+h10b-1)+int_mb(k_spin+p5b-1)+
     &int_mb(k_spin+p6b-1)+int_mb(k_spin+p9b-1)+int_mb(k_spin+p13b-1).ne
     &.16)) THEN
      IF (int_mb(k_active+h1b-1)+int_mb(k_active+h2b-1)+int_mb(k_active+
     &h7b-1)+int_mb(k_active+h10b-1) .ge. numacq) THEN
      IF (int_mb(k_active+p5b-1)+int_mb(k_active+p6b-1)+int_mb(k_active+
     &p9b-1)+int_mb(k_active+p13b-1) .ge. numacq) THEN
      IF (int_mb(k_spin+h1b-1)+int_mb(k_spin+h2b-1)+int_mb(k_spin+h7b-1)
     &+int_mb(k_spin+h10b-1) .eq. int_mb(k_spin+p5b-1)+int_mb(k_spin+p6b
     &-1)+int_mb(k_spin+p9b-1)+int_mb(k_spin+p13b-1)) THEN
      IF (ieor(int_mb(k_sym+h1b-1),ieor(int_mb(k_sym+h2b-1),ieor(int_mb(
     &k_sym+h7b-1),ieor(int_mb(k_sym+h10b-1),ieor(int_mb(k_sym+p5b-1),ie
     &or(int_mb(k_sym+p6b-1),ieor(int_mb(k_sym+p9b-1),int_mb(k_sym+p13b-
     &1)))))))) .eq. irrep_y) THEN
      dimc = int_mb(k_range+h1b-1) * int_mb(k_range+h2b-1) * int_mb(k_ra
     &nge+h7b-1) * int_mb(k_range+h10b-1) * int_mb(k_range+p5b-1) * int_
     &mb(k_range+p6b-1) * int_mb(k_range+p9b-1) * int_mb(k_range+p13b-1)
      CALL TCE_RESTRICTED_8(h1b,h2b,h7b,h10b,p5b,p6b,p9b,p13b,h1b_1,h2b_
     &1,h7b_1,h10b_1,p5b_1,p6b_1,p9b_1,p13b_1)
      dim_common = 1
      dima_sort = int_mb(k_range+h1b-1) * int_mb(k_range+h2b-1) * int_mb
     &(k_range+h7b-1) * int_mb(k_range+h10b-1) * int_mb(k_range+p5b-1) *
     & int_mb(k_range+p6b-1) * int_mb(k_range+p9b-1) * int_mb(k_range+p1
     &3b-1)
      dima = dim_common * dima_sort
      IF (dima .gt. 0) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_11_4_1_2',0,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_11_4_1_2',1,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(p13b_
     &1 - noab - 1 + nvab * (p9b_1 - noab - 1 + nvab * (p6b_1 - noab - 1
     & + nvab * (p5b_1 - noab - 1 + nvab * (h10b_1 - 1 + noab * (h7b_1 -
     & 1 + noab * (h2b_1 - 1 + noab * (h1b_1 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+h1b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h7b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1),int_mb(k_range+p9b-1
     &),int_mb(k_range+p13b-1),8,7,6,5,4,3,2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_11_
     &4_1_2',2,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_11_4_1_2',3,MA_ERR)
      CALL TCE_SORT_8(dbl_mb(k_a_sort),dbl_mb(k_c),int_mb(k_range+p13b-1
     &),int_mb(k_range+p9b-1),int_mb(k_range+p6b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+h10b-1),int_mb(k_range+h7b-1),int_mb(k_range+h2b-
     &1),int_mb(k_range+h1b-1),8,7,6,5,4,3,2,1,4.0d0/5.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p13b 
     &- noab - 1 + nvab * (p9b - noab - 1 + nvab * (p6b - noab - 1 + nva
     &b * (p5b - noab - 1 + nvab * (h10b - 1 + noab * (h7b - 1 + noab * 
     &(h2b - 1 + noab * (h1b - 1)))))))))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_11_
     &4_1_2',4,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_11_4_1_2',5,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_12(d_a,k_a_offset,d_b,k_b_offset,d
     &_c,k_c_offset)
C     i1 ( p12 h11 )_ytx + = 1/4 * x ( )_x * i2 ( p12 h11 )_yt
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER p12b
      INTEGER h11b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p12b_2
      INTEGER h11b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO p12b = noab+1,noab+nvab
      DO h11b = 1,noab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+p12b-1)+int_mb(k_spin+h11b
     &-1).ne.4)) THEN
      IF (int_mb(k_spin+p12b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+p12b-1),int_mb(k_sym+h11b-1)) .eq. ieor(irre
     &p_y,ieor(irrep_t,irrep_x))) THEN
      dimc = int_mb(k_range+p12b-1) * int_mb(k_range+h11b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_12',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      IF (0 .eq. irrep_x) THEN
      CALL TCE_RESTRICTED_2(p12b,h11b,p12b_2,h11b_2)
      dim_common = 1
      dima_sort = 1
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+p12b-1) * int_mb(k_range+h11b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_12',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_12',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),0)
      CALL TCE_SORT_0(dbl_mb(k_a),dbl_mb(k_a_sort),1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_12'
     &,3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_12',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_12',5,MA_ERR)
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(h11b_
     &2 - 1 + noab * (p12b_2 - noab - 1)))
      CALL TCE_SORT_2(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+p12b-1
     &),int_mb(k_range+h11b-1),2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_12'
     &,6,MA_ERR)
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,1.0d0,dbl_mb
     &(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c
     &_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_12',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_12',8,MA_ERR)
      END IF
      END IF
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_12',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+h11b-1
     &),int_mb(k_range+p12b-1),2,1,1.0d0/4.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(h11b 
     &- 1 + noab * (p12b - noab - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_12'
     &,10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_12',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_12_1(d_a,k_a_offset,d_b,k_b_offset
     &,d_c,k_c_offset)
C     i2 ( p12 h11 )_yt + = 1 * Sum ( h6 h5 p4 p3 ) * t ( p3 p4 p12 h5 h6 h11 )_t * y ( h5 h6 p3 p4 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER p12b
      INTEGER h11b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p3b
      INTEGER p4b
      INTEGER h5b
      INTEGER h6b
      INTEGER p12b_1
      INTEGER p3b_1
      INTEGER p4b_1
      INTEGER h11b_1
      INTEGER h5b_1
      INTEGER h6b_1
      INTEGER h5b_2
      INTEGER h6b_2
      INTEGER p3b_2
      INTEGER p4b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(2)
      INTEGER isuperp
      INTEGER nsubh(2)
      INTEGER isubh
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO p12b = noab+1,noab+nvab
      DO h11b = 1,noab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+p12b-1)+int_mb(k_spin+h11b
     &-1).ne.4)) THEN
      IF (int_mb(k_spin+p12b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+p12b-1),int_mb(k_sym+h11b-1)) .eq. ieor(irre
     &p_y,irrep_t)) THEN
      dimc = int_mb(k_range+p12b-1) * int_mb(k_range+h11b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_12_1',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      DO h5b = 1,noab
      DO h6b = h5b,noab
      IF (int_mb(k_active+p12b-1)+int_mb(k_active+p3b-1)+int_mb(k_active
     &+p4b-1) .ge. numact) THEN
      IF (int_mb(k_active+h11b-1)+int_mb(k_active+h5b-1)+int_mb(k_active
     &+h6b-1) .ge. numact) THEN
      IF (int_mb(k_spin+p12b-1)+int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1
     &) .eq. int_mb(k_spin+h11b-1)+int_mb(k_spin+h5b-1)+int_mb(k_spin+h6
     &b-1)) THEN
      IF (ieor(int_mb(k_sym+p12b-1),ieor(int_mb(k_sym+p3b-1),ieor(int_mb
     &(k_sym+p4b-1),ieor(int_mb(k_sym+h11b-1),ieor(int_mb(k_sym+h5b-1),i
     &nt_mb(k_sym+h6b-1)))))) .eq. irrep_t) THEN
      CALL TCE_RESTRICTED_6(p12b,p3b,p4b,h11b,h5b,h6b,p12b_1,p3b_1,p4b_1
     &,h11b_1,h5b_1,h6b_1)
      CALL TCE_RESTRICTED_4(h5b,h6b,p3b,p4b,h5b_2,h6b_2,p3b_2,p4b_2)
      dim_common = int_mb(k_range+p3b-1) * int_mb(k_range+p4b-1) * int_m
     &b(k_range+h5b-1) * int_mb(k_range+h6b-1)
      dima_sort = int_mb(k_range+p12b-1) * int_mb(k_range+h11b-1)
      dima = dim_common * dima_sort
      dimb_sort = 1
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_12_1',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_12_1',2,MA_ERR)
      IF ((p4b .le. p12b) .and. (h6b .le. h11b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h11b_
     &1 - 1 + noab * (h6b_1 - 1 + noab * (h5b_1 - 1 + noab * (p12b_1 - n
     &oab - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))
     &))
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p12b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h11b-1),6,3,5,4,2,1,1.0d0,.
     &false.)
      END IF
      IF ((p4b .le. p12b) .and. (h5b .le. h11b) .and. (h11b .lt. h6b)) T
     &HEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h6b_1
     & - 1 + noab * (h11b_1 - 1 + noab * (h5b_1 - 1 + noab * (p12b_1 - n
     &oab - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))
     &))
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p12b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+h11b-1),int_mb(k_range+h6b-1),5,3,6,4,2,1,-1.0d0,
     &.false.)
      END IF
      IF ((p4b .le. p12b) .and. (h11b .lt. h5b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h6b_1
     & - 1 + noab * (h5b_1 - 1 + noab * (h11b_1 - 1 + noab * (p12b_1 - n
     &oab - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))
     &))
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p12b-1),int_mb(k_range+h11b-
     &1),int_mb(k_range+h5b-1),int_mb(k_range+h6b-1),4,3,6,5,2,1,1.0d0,.
     &false.)
      END IF
      IF ((p3b .le. p12b) .and. (p12b .lt. p4b) .and. (h6b .le. h11b)) T
     &HEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h11b_
     &1 - 1 + noab * (h6b_1 - 1 + noab * (h5b_1 - 1 + noab * (p4b_1 - no
     &ab - 1 + nvab * (p12b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))
     &))
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p12b-1),int_mb(k_range+p4b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h11b-1),6,2,5,4,3,1,-1.0d0,
     &.false.)
      END IF
      IF ((p3b .le. p12b) .and. (p12b .lt. p4b) .and. (h5b .le. h11b) .a
     &nd. (h11b .lt. h6b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h6b_1
     & - 1 + noab * (h11b_1 - 1 + noab * (h5b_1 - 1 + noab * (p4b_1 - no
     &ab - 1 + nvab * (p12b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))
     &))
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p12b-1),int_mb(k_range+p4b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+h11b-1),int_mb(k_range+h6b-1),5,2,6,4,3,1,1.0d0,.
     &false.)
      END IF
      IF ((p3b .le. p12b) .and. (p12b .lt. p4b) .and. (h11b .lt. h5b)) T
     &HEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h6b_1
     & - 1 + noab * (h5b_1 - 1 + noab * (h11b_1 - 1 + noab * (p4b_1 - no
     &ab - 1 + nvab * (p12b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))
     &))
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p12b-1),int_mb(k_range+p4b-1),int_mb(k_range+h11b-
     &1),int_mb(k_range+h5b-1),int_mb(k_range+h6b-1),4,2,6,5,3,1,-1.0d0,
     &.false.)
      END IF
      IF ((p12b .lt. p3b) .and. (h6b .le. h11b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h11b_
     &1 - 1 + noab * (h6b_1 - 1 + noab * (h5b_1 - 1 + noab * (p4b_1 - no
     &ab - 1 + nvab * (p3b_1 - noab - 1 + nvab * (p12b_1 - noab - 1)))))
     &))
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p12b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h11b-1),6,1,5,4,3,2,1.0d0,.
     &false.)
      END IF
      IF ((p12b .lt. p3b) .and. (h5b .le. h11b) .and. (h11b .lt. h6b)) T
     &HEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h6b_1
     & - 1 + noab * (h11b_1 - 1 + noab * (h5b_1 - 1 + noab * (p4b_1 - no
     &ab - 1 + nvab * (p3b_1 - noab - 1 + nvab * (p12b_1 - noab - 1)))))
     &))
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p12b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+h11b-1),int_mb(k_range+h6b-1),5,1,6,4,3,2,-1.0d0,
     &.false.)
      END IF
      IF ((p12b .lt. p3b) .and. (h11b .lt. h5b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h6b_1
     & - 1 + noab * (h5b_1 - 1 + noab * (h11b_1 - 1 + noab * (p4b_1 - no
     &ab - 1 + nvab * (p3b_1 - noab - 1 + nvab * (p12b_1 - noab - 1)))))
     &))
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p12b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+h11b-
     &1),int_mb(k_range+h5b-1),int_mb(k_range+h6b-1),4,1,6,5,3,2,1.0d0,.
     &false.)
      END IF
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_12_
     &1',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_12_1',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_12_1',5,MA_ERR)
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (h6b_2 - 1 + noab 
     &* (h5b_2 - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1)
     &,2,1,4,3,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_12_
     &1',6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      isuperp = 1
      IF (p3b .eq. p4b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      nsubh(1) = 1
      nsubh(2) = 1
      isubh = 1
      IF (h5b .eq. h6b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,4.0d0/FACTOR
     &IAL(nsuperp(1))/FACTORIAL(nsuperp(2))/FACTORIAL(nsubh(1))/FACTORIA
     &L(nsubh(2)),dbl_mb(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_commo
     &n,1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_12_1',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_12_1',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_12_1',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+h11b-1
     &),int_mb(k_range+p12b-1),2,1,1.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(h11b 
     &- 1 + noab * (p12b - noab - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_12_
     &1',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_12_1',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE OFFSET_eomccsdtq_density1_5_12_1(l_a_offset,k_a_offset,
     &size)
C     i2 ( p12 h11 )_yt
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER l_a_offset
      INTEGER k_a_offset
      INTEGER length
      INTEGER addr
      INTEGER p12b
      INTEGER h11b
      DOUBLE PRECISION size
      length = 0
      DO p12b = noab+1,noab+nvab
      DO h11b = 1,noab
      IF (int_mb(k_spin+p12b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+p12b-1),int_mb(k_sym+h11b-1)) .eq. ieor(irre
     &p_y,irrep_t)) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+p12b-1)+int_mb(k_spin+h11b
     &-1).ne.4)) THEN
      length = length + 1
      END IF
      END IF
      END IF
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,2*length+1,'noname',l_a_offset,k_a_off
     &set)) CALL ERRQUIT('eomccsdtq_density1_5_12_1',0,MA_ERR)
      dbl_mb(k_a_offset) = dfloat(length)
      addr = 0
      size = 0.0d0
      DO p12b = noab+1,noab+nvab
      DO h11b = 1,noab
      IF (int_mb(k_spin+p12b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+p12b-1),int_mb(k_sym+h11b-1)) .eq. ieor(irre
     &p_y,irrep_t)) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+p12b-1)+int_mb(k_spin+h11b
     &-1).ne.4)) THEN
      addr = addr + 1
      dbl_mb(k_a_offset+addr) = dfloat(h11b - 1 + noab * (p12b - noab - 
     &1))
      dbl_mb(k_a_offset+length+addr) = size
      size = size + dfloat(int_mb(k_range+p12b-1)) * dfloat(int_mb(k_ran
     &ge+h11b-1))
      END IF
      END IF
      END IF
      END DO
      END DO
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_12_2(d_a,k_a_offset,d_b,k_b_offset
     &,d_c,k_c_offset)
C     i2 ( p12 h11 )_yt + = 1/9 * Sum ( h8 h7 h6 p5 p4 p3 ) * t ( p3 p4 p5 p12 h6 h7 h8 h11 )_t * y ( h6 h7 h8 p3 p4 p5 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER p12b
      INTEGER h11b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p3b
      INTEGER p4b
      INTEGER p5b
      INTEGER h6b
      INTEGER h7b
      INTEGER h8b
      INTEGER p12b_1
      INTEGER p3b_1
      INTEGER p4b_1
      INTEGER p5b_1
      INTEGER h11b_1
      INTEGER h6b_1
      INTEGER h7b_1
      INTEGER h8b_1
      INTEGER h6b_2
      INTEGER h7b_2
      INTEGER h8b_2
      INTEGER p3b_2
      INTEGER p4b_2
      INTEGER p5b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(3)
      INTEGER isuperp
      INTEGER nsubh(3)
      INTEGER isubh
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO p12b = noab+1,noab+nvab
      DO h11b = 1,noab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+p12b-1)+int_mb(k_spin+h11b
     &-1).ne.4)) THEN
      IF (int_mb(k_spin+p12b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+p12b-1),int_mb(k_sym+h11b-1)) .eq. ieor(irre
     &p_y,irrep_t)) THEN
      dimc = int_mb(k_range+p12b-1) * int_mb(k_range+h11b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_12_2',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      DO p5b = p4b,noab+nvab
      DO h6b = 1,noab
      DO h7b = h6b,noab
      DO h8b = h7b,noab
      IF (int_mb(k_active+p12b-1)+int_mb(k_active+p3b-1)+int_mb(k_active
     &+p4b-1)+int_mb(k_active+p5b-1) .ge. numacq) THEN
      IF (int_mb(k_active+h11b-1)+int_mb(k_active+h6b-1)+int_mb(k_active
     &+h7b-1)+int_mb(k_active+h8b-1) .ge. numacq) THEN
      IF (int_mb(k_active+h6b-1)+int_mb(k_active+h7b-1)+int_mb(k_active+
     &h8b-1) .ge. numact) THEN
      IF (int_mb(k_active+p3b-1)+int_mb(k_active+p4b-1)+int_mb(k_active+
     &p5b-1) .ge. numact) THEN
      IF (int_mb(k_spin+p12b-1)+int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1
     &)+int_mb(k_spin+p5b-1) .eq. int_mb(k_spin+h11b-1)+int_mb(k_spin+h6
     &b-1)+int_mb(k_spin+h7b-1)+int_mb(k_spin+h8b-1)) THEN
      IF (ieor(int_mb(k_sym+p12b-1),ieor(int_mb(k_sym+p3b-1),ieor(int_mb
     &(k_sym+p4b-1),ieor(int_mb(k_sym+p5b-1),ieor(int_mb(k_sym+h11b-1),i
     &eor(int_mb(k_sym+h6b-1),ieor(int_mb(k_sym+h7b-1),int_mb(k_sym+h8b-
     &1)))))))) .eq. irrep_t) THEN
      CALL TCE_RESTRICTED_8(p12b,p3b,p4b,p5b,h11b,h6b,h7b,h8b,p12b_1,p3b
     &_1,p4b_1,p5b_1,h11b_1,h6b_1,h7b_1,h8b_1)
      CALL TCE_RESTRICTED_6(h6b,h7b,h8b,p3b,p4b,p5b,h6b_2,h7b_2,h8b_2,p3
     &b_2,p4b_2,p5b_2)
      dim_common = int_mb(k_range+p3b-1) * int_mb(k_range+p4b-1) * int_m
     &b(k_range+p5b-1) * int_mb(k_range+h6b-1) * int_mb(k_range+h7b-1) *
     & int_mb(k_range+h8b-1)
      dima_sort = int_mb(k_range+p12b-1) * int_mb(k_range+h11b-1)
      dima = dim_common * dima_sort
      dimb_sort = 1
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_12_2',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_12_2',2,MA_ERR)
      IF ((p5b .le. p12b) .and. (h8b .le. h11b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h11b_
     &1 - 1 + noab * (h8b_1 - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 
     &+ noab * (p12b_1 - noab - 1 + nvab * (p5b_1 - noab - 1 + nvab * (p
     &4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+p12b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h8b-1
     &),int_mb(k_range+h11b-1),8,4,7,6,5,3,2,1,1.0d0,.false.)
      END IF
      IF ((p5b .le. p12b) .and. (h7b .le. h11b) .and. (h11b .lt. h8b)) T
     &HEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h8b_1
     & - 1 + noab * (h11b_1 - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 
     &+ noab * (p12b_1 - noab - 1 + nvab * (p5b_1 - noab - 1 + nvab * (p
     &4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+p12b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h11b-
     &1),int_mb(k_range+h8b-1),7,4,8,6,5,3,2,1,-1.0d0,.false.)
      END IF
      IF ((p5b .le. p12b) .and. (h6b .le. h11b) .and. (h11b .lt. h7b)) T
     &HEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h8b_1
     & - 1 + noab * (h7b_1 - 1 + noab * (h11b_1 - 1 + noab * (h6b_1 - 1 
     &+ noab * (p12b_1 - noab - 1 + nvab * (p5b_1 - noab - 1 + nvab * (p
     &4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+p12b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h11b-1),int_mb(k_range+h7b-
     &1),int_mb(k_range+h8b-1),6,4,8,7,5,3,2,1,1.0d0,.false.)
      END IF
      IF ((p5b .le. p12b) .and. (h11b .lt. h6b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h8b_1
     & - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 + noab * (h11b_1 - 1 
     &+ noab * (p12b_1 - noab - 1 + nvab * (p5b_1 - noab - 1 + nvab * (p
     &4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+p12b-1
     &),int_mb(k_range+h11b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-
     &1),int_mb(k_range+h8b-1),5,4,8,7,6,3,2,1,-1.0d0,.false.)
      END IF
      IF ((p4b .le. p12b) .and. (p12b .lt. p5b) .and. (h8b .le. h11b)) T
     &HEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h11b_
     &1 - 1 + noab * (h8b_1 - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 
     &+ noab * (p5b_1 - noab - 1 + nvab * (p12b_1 - noab - 1 + nvab * (p
     &4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p12b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h8b-1
     &),int_mb(k_range+h11b-1),8,3,7,6,5,4,2,1,-1.0d0,.false.)
      END IF
      IF ((p4b .le. p12b) .and. (p12b .lt. p5b) .and. (h7b .le. h11b) .a
     &nd. (h11b .lt. h8b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h8b_1
     & - 1 + noab * (h11b_1 - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 
     &+ noab * (p5b_1 - noab - 1 + nvab * (p12b_1 - noab - 1 + nvab * (p
     &4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p12b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h11b-
     &1),int_mb(k_range+h8b-1),7,3,8,6,5,4,2,1,1.0d0,.false.)
      END IF
      IF ((p4b .le. p12b) .and. (p12b .lt. p5b) .and. (h6b .le. h11b) .a
     &nd. (h11b .lt. h7b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h8b_1
     & - 1 + noab * (h7b_1 - 1 + noab * (h11b_1 - 1 + noab * (h6b_1 - 1 
     &+ noab * (p5b_1 - noab - 1 + nvab * (p12b_1 - noab - 1 + nvab * (p
     &4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p12b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h11b-1),int_mb(k_range+h7b-
     &1),int_mb(k_range+h8b-1),6,3,8,7,5,4,2,1,-1.0d0,.false.)
      END IF
      IF ((p4b .le. p12b) .and. (p12b .lt. p5b) .and. (h11b .lt. h6b)) T
     &HEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h8b_1
     & - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 + noab * (h11b_1 - 1 
     &+ noab * (p5b_1 - noab - 1 + nvab * (p12b_1 - noab - 1 + nvab * (p
     &4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p12b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+h11b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-
     &1),int_mb(k_range+h8b-1),5,3,8,7,6,4,2,1,1.0d0,.false.)
      END IF
      IF ((p3b .le. p12b) .and. (p12b .lt. p4b) .and. (h8b .le. h11b)) T
     &HEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h11b_
     &1 - 1 + noab * (h8b_1 - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 
     &+ noab * (p5b_1 - noab - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p1
     &2b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p12b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h8b-1
     &),int_mb(k_range+h11b-1),8,2,7,6,5,4,3,1,1.0d0,.false.)
      END IF
      IF ((p3b .le. p12b) .and. (p12b .lt. p4b) .and. (h7b .le. h11b) .a
     &nd. (h11b .lt. h8b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h8b_1
     & - 1 + noab * (h11b_1 - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 
     &+ noab * (p5b_1 - noab - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p1
     &2b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p12b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h11b-
     &1),int_mb(k_range+h8b-1),7,2,8,6,5,4,3,1,-1.0d0,.false.)
      END IF
      IF ((p3b .le. p12b) .and. (p12b .lt. p4b) .and. (h6b .le. h11b) .a
     &nd. (h11b .lt. h7b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h8b_1
     & - 1 + noab * (h7b_1 - 1 + noab * (h11b_1 - 1 + noab * (h6b_1 - 1 
     &+ noab * (p5b_1 - noab - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p1
     &2b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p12b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h11b-1),int_mb(k_range+h7b-
     &1),int_mb(k_range+h8b-1),6,2,8,7,5,4,3,1,1.0d0,.false.)
      END IF
      IF ((p3b .le. p12b) .and. (p12b .lt. p4b) .and. (h11b .lt. h6b)) T
     &HEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h8b_1
     & - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 + noab * (h11b_1 - 1 
     &+ noab * (p5b_1 - noab - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p1
     &2b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p12b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+h11b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-
     &1),int_mb(k_range+h8b-1),5,2,8,7,6,4,3,1,-1.0d0,.false.)
      END IF
      IF ((p12b .lt. p3b) .and. (h8b .le. h11b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h11b_
     &1 - 1 + noab * (h8b_1 - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 
     &+ noab * (p5b_1 - noab - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p3
     &b_1 - noab - 1 + nvab * (p12b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p12b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h8b-1
     &),int_mb(k_range+h11b-1),8,1,7,6,5,4,3,2,-1.0d0,.false.)
      END IF
      IF ((p12b .lt. p3b) .and. (h7b .le. h11b) .and. (h11b .lt. h8b)) T
     &HEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h8b_1
     & - 1 + noab * (h11b_1 - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 
     &+ noab * (p5b_1 - noab - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p3
     &b_1 - noab - 1 + nvab * (p12b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p12b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h11b-
     &1),int_mb(k_range+h8b-1),7,1,8,6,5,4,3,2,1.0d0,.false.)
      END IF
      IF ((p12b .lt. p3b) .and. (h6b .le. h11b) .and. (h11b .lt. h7b)) T
     &HEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h8b_1
     & - 1 + noab * (h7b_1 - 1 + noab * (h11b_1 - 1 + noab * (h6b_1 - 1 
     &+ noab * (p5b_1 - noab - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p3
     &b_1 - noab - 1 + nvab * (p12b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p12b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h11b-1),int_mb(k_range+h7b-
     &1),int_mb(k_range+h8b-1),6,1,8,7,5,4,3,2,-1.0d0,.false.)
      END IF
      IF ((p12b .lt. p3b) .and. (h11b .lt. h6b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h8b_1
     & - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 + noab * (h11b_1 - 1 
     &+ noab * (p5b_1 - noab - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p3
     &b_1 - noab - 1 + nvab * (p12b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p12b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+h11b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-
     &1),int_mb(k_range+h8b-1),5,1,8,7,6,4,3,2,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_12_
     &2',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_12_2',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_12_2',5,MA_ERR)
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h8b_2 - 1 + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),3,2,1,6,5,4,1.0d0,.fa
     &lse.)
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_12_
     &2',6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      nsuperp(3) = 1
      isuperp = 1
      IF (p3b .eq. p4b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      IF (p4b .eq. p5b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      nsubh(1) = 1
      nsubh(2) = 1
      nsubh(3) = 1
      isubh = 1
      IF (h6b .eq. h7b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      IF (h7b .eq. h8b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,36.0d0/FACTO
     &RIAL(nsuperp(1))/FACTORIAL(nsuperp(2))/FACTORIAL(nsuperp(3))/FACTO
     &RIAL(nsubh(1))/FACTORIAL(nsubh(2))/FACTORIAL(nsubh(3)),dbl_mb(k_a_
     &sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c_sort
     &),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_12_2',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_12_2',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_12_2',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+h11b-1
     &),int_mb(k_range+p12b-1),2,1,1.0d0/9.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(h11b 
     &- 1 + noab * (p12b - noab - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_12_
     &2',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_12_2',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_12_3(d_a,k_a_offset,d_b,k_b_offset
     &,d_c,k_c_offset)
C     i2 ( p12 h11 )_ytt + = 2 * Sum ( h13 h2 p8 ) * t ( p8 p12 h2 h13 )_t * i3 ( h2 h13 h11 p8 )_yt
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER p12b
      INTEGER h11b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p8b
      INTEGER h2b
      INTEGER h13b
      INTEGER p12b_1
      INTEGER p8b_1
      INTEGER h2b_1
      INTEGER h13b_1
      INTEGER h2b_2
      INTEGER h13b_2
      INTEGER h11b_2
      INTEGER p8b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsubh(2)
      INTEGER isubh
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO p12b = noab+1,noab+nvab
      DO h11b = 1,noab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+p12b-1)+int_mb(k_spin+h11b
     &-1).ne.4)) THEN
      IF (int_mb(k_spin+p12b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+p12b-1),int_mb(k_sym+h11b-1)) .eq. ieor(irre
     &p_y,ieor(irrep_t,irrep_t))) THEN
      dimc = int_mb(k_range+p12b-1) * int_mb(k_range+h11b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_12_3',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p8b = noab+1,noab+nvab
      DO h2b = 1,noab
      DO h13b = h2b,noab
      IF (int_mb(k_spin+p12b-1)+int_mb(k_spin+p8b-1) .eq. int_mb(k_spin+
     &h2b-1)+int_mb(k_spin+h13b-1)) THEN
      IF (ieor(int_mb(k_sym+p12b-1),ieor(int_mb(k_sym+p8b-1),ieor(int_mb
     &(k_sym+h2b-1),int_mb(k_sym+h13b-1)))) .eq. irrep_t) THEN
      CALL TCE_RESTRICTED_4(p12b,p8b,h2b,h13b,p12b_1,p8b_1,h2b_1,h13b_1)
      CALL TCE_RESTRICTED_4(h2b,h13b,h11b,p8b,h2b_2,h13b_2,h11b_2,p8b_2)
      dim_common = int_mb(k_range+p8b-1) * int_mb(k_range+h2b-1) * int_m
     &b(k_range+h13b-1)
      dima_sort = int_mb(k_range+p12b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h11b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_12_3',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_12_3',2,MA_ERR)
      IF ((p8b .le. p12b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h13b_
     &1 - 1 + noab * (h2b_1 - 1 + noab * (p12b_1 - noab - 1 + nvab * (p8
     &b_1 - noab - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p8b-1)
     &,int_mb(k_range+p12b-1),int_mb(k_range+h2b-1),int_mb(k_range+h13b-
     &1),2,4,3,1,1.0d0,.false.)
      END IF
      IF ((p12b .lt. p8b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h13b_
     &1 - 1 + noab * (h2b_1 - 1 + noab * (p8b_1 - noab - 1 + nvab * (p12
     &b_1 - noab - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p12b-1
     &),int_mb(k_range+p8b-1),int_mb(k_range+h2b-1),int_mb(k_range+h13b-
     &1),1,4,3,2,-1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_12_
     &3',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_12_3',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_12_3',5,MA_ERR)
      IF ((h11b .le. p8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (h11b_2 - 1 + noab * (h13b_2 - 1 + noab * (h2
     &b_2 - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h13b-1),int_mb(k_range+h11b-1),int_mb(k_range+p8b-
     &1),3,2,1,4,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_12_
     &3',6,MA_ERR)
      nsubh(1) = 1
      nsubh(2) = 1
      isubh = 1
      IF (h2b .eq. h13b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,2.0d0/FACTOR
     &IAL(nsubh(1))/FACTORIAL(nsubh(2)),dbl_mb(k_a_sort),dim_common,dbl_
     &mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_12_3',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_12_3',8,MA_ERR)
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_12_3',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+h11b-1
     &),int_mb(k_range+p12b-1),2,1,2.0d0/1.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(h11b 
     &- 1 + noab * (p12b - noab - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_12_
     &3',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_12_3',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_12_3_1(d_a,k_a_offset,d_b,k_b_offs
     &et,d_c,k_c_offset)
C     i3 ( h2 h13 h11 p8 )_yt + = 1 * Sum ( p6 ) * t ( p6 h11 )_t * y ( h2 h13 p6 p8 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h2b
      INTEGER h13b
      INTEGER h11b
      INTEGER p8b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p6b
      INTEGER p6b_1
      INTEGER h11b_1
      INTEGER h2b_2
      INTEGER h13b_2
      INTEGER p8b_2
      INTEGER p6b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h2b = 1,noab
      DO h13b = h2b,noab
      DO h11b = 1,noab
      DO p8b = noab+1,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+h13b-
     &1)+int_mb(k_spin+h11b-1)+int_mb(k_spin+p8b-1).ne.8)) THEN
      IF (int_mb(k_spin+h2b-1)+int_mb(k_spin+h13b-1) .eq. int_mb(k_spin+
     &h11b-1)+int_mb(k_spin+p8b-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),ieor(int_mb(k_sym+h13b-1),ieor(int_mb
     &(k_sym+h11b-1),int_mb(k_sym+p8b-1)))) .eq. ieor(irrep_y,irrep_t)) 
     &THEN
      dimc = int_mb(k_range+h2b-1) * int_mb(k_range+h13b-1) * int_mb(k_r
     &ange+h11b-1) * int_mb(k_range+p8b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_12_3_1',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p6b = noab+1,noab+nvab
      IF (int_mb(k_spin+p6b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+p6b-1),int_mb(k_sym+h11b-1)) .eq. irrep_t) T
     &HEN
      CALL TCE_RESTRICTED_2(p6b,h11b,p6b_1,h11b_1)
      CALL TCE_RESTRICTED_4(h2b,h13b,p8b,p6b,h2b_2,h13b_2,p8b_2,p6b_2)
      dim_common = int_mb(k_range+p6b-1)
      dima_sort = int_mb(k_range+h11b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h2b-1) * int_mb(k_range+h13b-1) * int_m
     &b(k_range+p8b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_12_3_1',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_12_3_1',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h11b_
     &1 - 1 + noab * (p6b_1 - noab - 1)))
      CALL TCE_SORT_2(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p6b-1)
     &,int_mb(k_range+h11b-1),2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_12_
     &3_1',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_12_3_1',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_12_3_1',5,MA_ERR)
      IF ((p6b .le. p8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (h13b_2 - 1 + noab
     & * (h2b_2 - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h13b-1),int_mb(k_range+p6b-1),int_mb(k_range+p8b-1
     &),4,2,1,3,1.0d0,.false.)
      END IF
      IF ((p8b .lt. p6b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (h13b_2 - 1 + noab
     & * (h2b_2 - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h13b-1),int_mb(k_range+p8b-1),int_mb(k_range+p6b-1
     &),3,2,1,4,-1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_12_
     &3_1',6,MA_ERR)
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,1.0d0,dbl_mb
     &(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c
     &_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_12_3_1',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_12_3_1',8,MA_ERR)
      END IF
      END IF
      END IF
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_12_3_1',9,MA_ERR)
      CALL TCE_SORT_4(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p8b-1)
     &,int_mb(k_range+h13b-1),int_mb(k_range+h2b-1),int_mb(k_range+h11b-
     &1),3,2,4,1,1.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p8b -
     & noab - 1 + nvab * (h11b - 1 + noab * (h13b - 1 + noab * (h2b - 1)
     &))))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_12_
     &3_1',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_12_3_1',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE OFFSET_eomccsdtq_density1_5_12_3_1(l_a_offset,k_a_offse
     &t,size)
C     i3 ( h2 h13 h11 p8 )_yt
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER l_a_offset
      INTEGER k_a_offset
      INTEGER length
      INTEGER addr
      INTEGER h2b
      INTEGER h13b
      INTEGER h11b
      INTEGER p8b
      DOUBLE PRECISION size
      length = 0
      DO h2b = 1,noab
      DO h13b = h2b,noab
      DO h11b = 1,noab
      DO p8b = noab+1,noab+nvab
      IF (int_mb(k_spin+h2b-1)+int_mb(k_spin+h13b-1) .eq. int_mb(k_spin+
     &h11b-1)+int_mb(k_spin+p8b-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),ieor(int_mb(k_sym+h13b-1),ieor(int_mb
     &(k_sym+h11b-1),int_mb(k_sym+p8b-1)))) .eq. ieor(irrep_y,irrep_t)) 
     &THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+h13b-
     &1)+int_mb(k_spin+h11b-1)+int_mb(k_spin+p8b-1).ne.8)) THEN
      length = length + 1
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,2*length+1,'noname',l_a_offset,k_a_off
     &set)) CALL ERRQUIT('eomccsdtq_density1_5_12_3_1',0,MA_ERR)
      dbl_mb(k_a_offset) = dfloat(length)
      addr = 0
      size = 0.0d0
      DO h2b = 1,noab
      DO h13b = h2b,noab
      DO h11b = 1,noab
      DO p8b = noab+1,noab+nvab
      IF (int_mb(k_spin+h2b-1)+int_mb(k_spin+h13b-1) .eq. int_mb(k_spin+
     &h11b-1)+int_mb(k_spin+p8b-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),ieor(int_mb(k_sym+h13b-1),ieor(int_mb
     &(k_sym+h11b-1),int_mb(k_sym+p8b-1)))) .eq. ieor(irrep_y,irrep_t)) 
     &THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+h13b-
     &1)+int_mb(k_spin+h11b-1)+int_mb(k_spin+p8b-1).ne.8)) THEN
      addr = addr + 1
      dbl_mb(k_a_offset+addr) = dfloat(p8b - noab - 1 + nvab * (h11b - 1
     & + noab * (h13b - 1 + noab * (h2b - 1))))
      dbl_mb(k_a_offset+length+addr) = size
      size = size + dfloat(int_mb(k_range+h2b-1)) * dfloat(int_mb(k_rang
     &e+h13b-1)) * dfloat(int_mb(k_range+h11b-1)) * dfloat(int_mb(k_rang
     &e+p8b-1))
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_12_3_2(d_a,k_a_offset,d_b,k_b_offs
     &et,d_c,k_c_offset)
C     i3 ( h2 h13 h11 p8 )_yt + = -5/18 * Sum ( h7 p6 p5 ) * t ( p5 p6 h7 h11 )_t * i4 ( h2 h7 h13 p5 p6 p8 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h2b
      INTEGER h13b
      INTEGER h11b
      INTEGER p8b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p5b
      INTEGER p6b
      INTEGER h7b
      INTEGER p5b_1
      INTEGER p6b_1
      INTEGER h11b_1
      INTEGER h7b_1
      INTEGER h2b_2
      INTEGER h13b_2
      INTEGER h7b_2
      INTEGER p8b_2
      INTEGER p5b_2
      INTEGER p6b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(2)
      INTEGER isuperp
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h2b = 1,noab
      DO h13b = h2b,noab
      DO h11b = 1,noab
      DO p8b = noab+1,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+h13b-
     &1)+int_mb(k_spin+h11b-1)+int_mb(k_spin+p8b-1).ne.8)) THEN
      IF (int_mb(k_spin+h2b-1)+int_mb(k_spin+h13b-1) .eq. int_mb(k_spin+
     &h11b-1)+int_mb(k_spin+p8b-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),ieor(int_mb(k_sym+h13b-1),ieor(int_mb
     &(k_sym+h11b-1),int_mb(k_sym+p8b-1)))) .eq. ieor(irrep_y,irrep_t)) 
     &THEN
      dimc = int_mb(k_range+h2b-1) * int_mb(k_range+h13b-1) * int_mb(k_r
     &ange+h11b-1) * int_mb(k_range+p8b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_12_3_2',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p5b = noab+1,noab+nvab
      DO p6b = p5b,noab+nvab
      DO h7b = 1,noab
      IF (int_mb(k_spin+p5b-1)+int_mb(k_spin+p6b-1) .eq. int_mb(k_spin+h
     &11b-1)+int_mb(k_spin+h7b-1)) THEN
      IF (ieor(int_mb(k_sym+p5b-1),ieor(int_mb(k_sym+p6b-1),ieor(int_mb(
     &k_sym+h11b-1),int_mb(k_sym+h7b-1)))) .eq. irrep_t) THEN
      CALL TCE_RESTRICTED_4(p5b,p6b,h11b,h7b,p5b_1,p6b_1,h11b_1,h7b_1)
      CALL TCE_RESTRICTED_6(h2b,h13b,h7b,p8b,p5b,p6b,h2b_2,h13b_2,h7b_2,
     &p8b_2,p5b_2,p6b_2)
      dim_common = int_mb(k_range+p5b-1) * int_mb(k_range+p6b-1) * int_m
     &b(k_range+h7b-1)
      dima_sort = int_mb(k_range+h11b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h2b-1) * int_mb(k_range+h13b-1) * int_m
     &b(k_range+p8b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_12_3_2',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_12_3_2',2,MA_ERR)
      IF ((h7b .le. h11b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h11b_
     &1 - 1 + noab * (h7b_1 - 1 + noab * (p6b_1 - noab - 1 + nvab * (p5b
     &_1 - noab - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h11b-1
     &),4,3,2,1,1.0d0,.false.)
      END IF
      IF ((h11b .lt. h7b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h7b_1
     & - 1 + noab * (h11b_1 - 1 + noab * (p6b_1 - noab - 1 + nvab * (p5b
     &_1 - noab - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p6b-1),int_mb(k_range+h11b-1),int_mb(k_range+h7b-1
     &),3,4,2,1,-1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_12_
     &3_2',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_12_3_2',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_12_3_2',5,MA_ERR)
      IF ((h7b .lt. h2b) .and. (p6b .le. p8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p5b_2 - noab - 1 
     &+ nvab * (h13b_2 - 1 + noab * (h2b_2 - 1 + noab * (h7b_2 - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h13b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+p6b-1),int_mb(k_range+p8b-1),6,3,2,1,5,4,-1.0d0,.
     &false.)
      END IF
      IF ((h7b .lt. h2b) .and. (p5b .le. p8b) .and. (p8b .lt. p6b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p5b_2 - noab - 1 
     &+ nvab * (h13b_2 - 1 + noab * (h2b_2 - 1 + noab * (h7b_2 - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h13b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+p8b-1),int_mb(k_range+p6b-1),5,3,2,1,6,4,1.0d0,.f
     &alse.)
      END IF
      IF ((h7b .lt. h2b) .and. (p8b .lt. p5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p8b_2 - noab - 1 
     &+ nvab * (h13b_2 - 1 + noab * (h2b_2 - 1 + noab * (h7b_2 - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h13b-1),int_mb(k_range+p8b-1
     &),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1),4,3,2,1,6,5,-1.0d0,.
     &false.)
      END IF
      IF ((h2b .le. h7b) .and. (h7b .le. h13b) .and. (p6b .le. p8b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p5b_2 - noab - 1 
     &+ nvab * (h13b_2 - 1 + noab * (h7b_2 - 1 + noab * (h2b_2 - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h13b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+p6b-1),int_mb(k_range+p8b-1),6,3,1,2,5,4,1.0d0,.f
     &alse.)
      END IF
      IF ((h2b .le. h7b) .and. (h7b .le. h13b) .and. (p5b .le. p8b) .and
     &. (p8b .lt. p6b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p5b_2 - noab - 1 
     &+ nvab * (h13b_2 - 1 + noab * (h7b_2 - 1 + noab * (h2b_2 - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h13b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+p8b-1),int_mb(k_range+p6b-1),5,3,1,2,6,4,-1.0d0,.
     &false.)
      END IF
      IF ((h2b .le. h7b) .and. (h7b .le. h13b) .and. (p8b .lt. p5b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p8b_2 - noab - 1 
     &+ nvab * (h13b_2 - 1 + noab * (h7b_2 - 1 + noab * (h2b_2 - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h13b-1),int_mb(k_range+p8b-1
     &),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1),4,3,1,2,6,5,1.0d0,.f
     &alse.)
      END IF
      IF ((h13b .lt. h7b) .and. (p6b .le. p8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p5b_2 - noab - 1 
     &+ nvab * (h7b_2 - 1 + noab * (h13b_2 - 1 + noab * (h2b_2 - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h13b-1),int_mb(k_range+h7b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+p6b-1),int_mb(k_range+p8b-1),6,2,1,3,5,4,-1.0d0,.
     &false.)
      END IF
      IF ((h13b .lt. h7b) .and. (p5b .le. p8b) .and. (p8b .lt. p6b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p5b_2 - noab - 1 
     &+ nvab * (h7b_2 - 1 + noab * (h13b_2 - 1 + noab * (h2b_2 - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h13b-1),int_mb(k_range+h7b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+p8b-1),int_mb(k_range+p6b-1),5,2,1,3,6,4,1.0d0,.f
     &alse.)
      END IF
      IF ((h13b .lt. h7b) .and. (p8b .lt. p5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p8b_2 - noab - 1 
     &+ nvab * (h7b_2 - 1 + noab * (h13b_2 - 1 + noab * (h2b_2 - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h13b-1),int_mb(k_range+h7b-1),int_mb(k_range+p8b-1
     &),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1),4,2,1,3,6,5,-1.0d0,.
     &false.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_12_
     &3_2',6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      isuperp = 1
      IF (p5b .eq. p6b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,2.0d0/FACTOR
     &IAL(nsuperp(1))/FACTORIAL(nsuperp(2)),dbl_mb(k_a_sort),dim_common,
     &dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_12_3_2',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_12_3_2',8,MA_ERR)
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_12_3_2',9,MA_ERR)
      CALL TCE_SORT_4(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p8b-1)
     &,int_mb(k_range+h13b-1),int_mb(k_range+h2b-1),int_mb(k_range+h11b-
     &1),3,2,4,1,-5.0d0/18.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p8b -
     & noab - 1 + nvab * (h11b - 1 + noab * (h13b - 1 + noab * (h2b - 1)
     &))))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_12_
     &3_2',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_12_3_2',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_12_3_2_1(d_a,k_a_offset,d_c,k_c_of
     &fset)
C     i4 ( h2 h7 h13 p5 p6 p8 )_y + = 1 * y ( h2 h7 h13 p5 p6 p8 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h2b
      INTEGER h7b
      INTEGER h13b
      INTEGER p5b
      INTEGER p6b
      INTEGER p8b
      INTEGER dimc
      INTEGER h2b_1
      INTEGER h7b_1
      INTEGER h13b_1
      INTEGER p5b_1
      INTEGER p6b_1
      INTEGER p8b_1
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h2b = 1,noab
      DO h7b = h2b,noab
      DO h13b = h7b,noab
      DO p5b = noab+1,noab+nvab
      DO p6b = p5b,noab+nvab
      DO p8b = p6b,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+h7b-1
     &)+int_mb(k_spin+h13b-1)+int_mb(k_spin+p5b-1)+int_mb(k_spin+p6b-1)+
     &int_mb(k_spin+p8b-1).ne.12)) THEN
      IF (int_mb(k_active+h2b-1)+int_mb(k_active+h7b-1)+int_mb(k_active+
     &h13b-1) .ge. numact) THEN
      IF (int_mb(k_active+p5b-1)+int_mb(k_active+p6b-1)+int_mb(k_active+
     &p8b-1) .ge. numact) THEN
      IF (int_mb(k_spin+h2b-1)+int_mb(k_spin+h7b-1)+int_mb(k_spin+h13b-1
     &) .eq. int_mb(k_spin+p5b-1)+int_mb(k_spin+p6b-1)+int_mb(k_spin+p8b
     &-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),ieor(int_mb(k_sym+h7b-1),ieor(int_mb(
     &k_sym+h13b-1),ieor(int_mb(k_sym+p5b-1),ieor(int_mb(k_sym+p6b-1),in
     &t_mb(k_sym+p8b-1)))))) .eq. irrep_y) THEN
      dimc = int_mb(k_range+h2b-1) * int_mb(k_range+h7b-1) * int_mb(k_ra
     &nge+h13b-1) * int_mb(k_range+p5b-1) * int_mb(k_range+p6b-1) * int_
     &mb(k_range+p8b-1)
      CALL TCE_RESTRICTED_6(h2b,h7b,h13b,p5b,p6b,p8b,h2b_1,h7b_1,h13b_1,
     &p5b_1,p6b_1,p8b_1)
      dim_common = 1
      dima_sort = int_mb(k_range+h2b-1) * int_mb(k_range+h7b-1) * int_mb
     &(k_range+h13b-1) * int_mb(k_range+p5b-1) * int_mb(k_range+p6b-1) *
     & int_mb(k_range+p8b-1)
      dima = dim_common * dima_sort
      IF (dima .gt. 0) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_12_3_2_1',0,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_12_3_2_1',1,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(p8b_1
     & - noab - 1 + nvab * (p6b_1 - noab - 1 + nvab * (p5b_1 - noab - 1 
     &+ nvab * (h13b_1 - 1 + noab * (h7b_1 - 1 + noab * (h2b_1 - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h13b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+p6b-1),int_mb(k_range+p8b-1),6,5,4,3,2,1,1.0d0,.f
     &alse.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_12_
     &3_2_1',2,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_12_3_2_1',3,MA_ERR)
      CALL TCE_SORT_6(dbl_mb(k_a_sort),dbl_mb(k_c),int_mb(k_range+p8b-1)
     &,int_mb(k_range+p6b-1),int_mb(k_range+p5b-1),int_mb(k_range+h13b-1
     &),int_mb(k_range+h7b-1),int_mb(k_range+h2b-1),6,5,4,3,2,1,1.0d0,.f
     &alse.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p8b -
     & noab - 1 + nvab * (p6b - noab - 1 + nvab * (p5b - noab - 1 + nvab
     & * (h13b - 1 + noab * (h7b - 1 + noab * (h2b - 1)))))))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_12_
     &3_2_1',4,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_12_3_2_1',5,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE OFFSET_eomccsdtq_density1_5_12_3_2_1(l_a_offset,k_a_off
     &set,size)
C     i4 ( h2 h7 h13 p5 p6 p8 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER l_a_offset
      INTEGER k_a_offset
      INTEGER length
      INTEGER addr
      INTEGER h2b
      INTEGER h7b
      INTEGER h13b
      INTEGER p5b
      INTEGER p6b
      INTEGER p8b
      DOUBLE PRECISION size
      length = 0
      DO h2b = 1,noab
      DO h7b = h2b,noab
      DO h13b = h7b,noab
      DO p5b = noab+1,noab+nvab
      DO p6b = p5b,noab+nvab
      DO p8b = p6b,noab+nvab
      IF (int_mb(k_spin+h2b-1)+int_mb(k_spin+h7b-1)+int_mb(k_spin+h13b-1
     &) .eq. int_mb(k_spin+p5b-1)+int_mb(k_spin+p6b-1)+int_mb(k_spin+p8b
     &-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),ieor(int_mb(k_sym+h7b-1),ieor(int_mb(
     &k_sym+h13b-1),ieor(int_mb(k_sym+p5b-1),ieor(int_mb(k_sym+p6b-1),in
     &t_mb(k_sym+p8b-1)))))) .eq. irrep_y) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+h7b-1
     &)+int_mb(k_spin+h13b-1)+int_mb(k_spin+p5b-1)+int_mb(k_spin+p6b-1)+
     &int_mb(k_spin+p8b-1).ne.12)) THEN
      length = length + 1
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,2*length+1,'noname',l_a_offset,k_a_off
     &set)) CALL ERRQUIT('eomccsdtq_density1_5_12_3_2_1',0,MA_ERR)
      dbl_mb(k_a_offset) = dfloat(length)
      addr = 0
      size = 0.0d0
      DO h2b = 1,noab
      DO h7b = h2b,noab
      DO h13b = h7b,noab
      DO p5b = noab+1,noab+nvab
      DO p6b = p5b,noab+nvab
      DO p8b = p6b,noab+nvab
      IF (int_mb(k_spin+h2b-1)+int_mb(k_spin+h7b-1)+int_mb(k_spin+h13b-1
     &) .eq. int_mb(k_spin+p5b-1)+int_mb(k_spin+p6b-1)+int_mb(k_spin+p8b
     &-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),ieor(int_mb(k_sym+h7b-1),ieor(int_mb(
     &k_sym+h13b-1),ieor(int_mb(k_sym+p5b-1),ieor(int_mb(k_sym+p6b-1),in
     &t_mb(k_sym+p8b-1)))))) .eq. irrep_y) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+h7b-1
     &)+int_mb(k_spin+h13b-1)+int_mb(k_spin+p5b-1)+int_mb(k_spin+p6b-1)+
     &int_mb(k_spin+p8b-1).ne.12)) THEN
      addr = addr + 1
      dbl_mb(k_a_offset+addr) = dfloat(p8b - noab - 1 + nvab * (p6b - no
     &ab - 1 + nvab * (p5b - noab - 1 + nvab * (h13b - 1 + noab * (h7b -
     & 1 + noab * (h2b - 1))))))
      dbl_mb(k_a_offset+length+addr) = size
      size = size + dfloat(int_mb(k_range+h2b-1)) * dfloat(int_mb(k_rang
     &e+h7b-1)) * dfloat(int_mb(k_range+h13b-1)) * dfloat(int_mb(k_range
     &+p5b-1)) * dfloat(int_mb(k_range+p6b-1)) * dfloat(int_mb(k_range+p
     &8b-1))
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_12_3_2_2(d_a,k_a_offset,d_c,k_c_of
     &fset)
C     i4 ( h2 h7 h13 p5 p6 p8 )_y + = 4/5 * y ( h2 h7 h13 p5 p6 p8 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h2b
      INTEGER h7b
      INTEGER h13b
      INTEGER p5b
      INTEGER p6b
      INTEGER p8b
      INTEGER dimc
      INTEGER h2b_1
      INTEGER h7b_1
      INTEGER h13b_1
      INTEGER p5b_1
      INTEGER p6b_1
      INTEGER p8b_1
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h2b = 1,noab
      DO h7b = h2b,noab
      DO h13b = h7b,noab
      DO p5b = noab+1,noab+nvab
      DO p6b = p5b,noab+nvab
      DO p8b = p6b,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+h7b-1
     &)+int_mb(k_spin+h13b-1)+int_mb(k_spin+p5b-1)+int_mb(k_spin+p6b-1)+
     &int_mb(k_spin+p8b-1).ne.12)) THEN
      IF (int_mb(k_active+h2b-1)+int_mb(k_active+h7b-1)+int_mb(k_active+
     &h13b-1) .ge. numact) THEN
      IF (int_mb(k_active+p5b-1)+int_mb(k_active+p6b-1)+int_mb(k_active+
     &p8b-1) .ge. numact) THEN
      IF (int_mb(k_spin+h2b-1)+int_mb(k_spin+h7b-1)+int_mb(k_spin+h13b-1
     &) .eq. int_mb(k_spin+p5b-1)+int_mb(k_spin+p6b-1)+int_mb(k_spin+p8b
     &-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),ieor(int_mb(k_sym+h7b-1),ieor(int_mb(
     &k_sym+h13b-1),ieor(int_mb(k_sym+p5b-1),ieor(int_mb(k_sym+p6b-1),in
     &t_mb(k_sym+p8b-1)))))) .eq. irrep_y) THEN
      dimc = int_mb(k_range+h2b-1) * int_mb(k_range+h7b-1) * int_mb(k_ra
     &nge+h13b-1) * int_mb(k_range+p5b-1) * int_mb(k_range+p6b-1) * int_
     &mb(k_range+p8b-1)
      CALL TCE_RESTRICTED_6(h2b,h7b,h13b,p5b,p6b,p8b,h2b_1,h7b_1,h13b_1,
     &p5b_1,p6b_1,p8b_1)
      dim_common = 1
      dima_sort = int_mb(k_range+h2b-1) * int_mb(k_range+h7b-1) * int_mb
     &(k_range+h13b-1) * int_mb(k_range+p5b-1) * int_mb(k_range+p6b-1) *
     & int_mb(k_range+p8b-1)
      dima = dim_common * dima_sort
      IF (dima .gt. 0) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_12_3_2_2',0,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_12_3_2_2',1,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(p8b_1
     & - noab - 1 + nvab * (p6b_1 - noab - 1 + nvab * (p5b_1 - noab - 1 
     &+ nvab * (h13b_1 - 1 + noab * (h7b_1 - 1 + noab * (h2b_1 - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h13b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+p6b-1),int_mb(k_range+p8b-1),6,5,4,3,2,1,1.0d0,.f
     &alse.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_12_
     &3_2_2',2,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_12_3_2_2',3,MA_ERR)
      CALL TCE_SORT_6(dbl_mb(k_a_sort),dbl_mb(k_c),int_mb(k_range+p8b-1)
     &,int_mb(k_range+p6b-1),int_mb(k_range+p5b-1),int_mb(k_range+h13b-1
     &),int_mb(k_range+h7b-1),int_mb(k_range+h2b-1),6,5,4,3,2,1,4.0d0/5.
     &0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p8b -
     & noab - 1 + nvab * (p6b - noab - 1 + nvab * (p5b - noab - 1 + nvab
     & * (h13b - 1 + noab * (h7b - 1 + noab * (h2b - 1)))))))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_12_
     &3_2_2',4,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_12_3_2_2',5,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_12_3_3(d_a,k_a_offset,d_b,k_b_offs
     &et,d_c,k_c_offset)
C     i3 ( h2 h13 h11 p8 )_yt + = 1/12 * Sum ( h7 h6 p5 p4 p3 ) * t ( p3 p4 p5 h6 h7 h11 )_t * y ( h2 h6 h7 h13 p3 p4 p5 p8 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h2b
      INTEGER h13b
      INTEGER h11b
      INTEGER p8b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p3b
      INTEGER p4b
      INTEGER p5b
      INTEGER h6b
      INTEGER h7b
      INTEGER p3b_1
      INTEGER p4b_1
      INTEGER p5b_1
      INTEGER h11b_1
      INTEGER h6b_1
      INTEGER h7b_1
      INTEGER h2b_2
      INTEGER h13b_2
      INTEGER h6b_2
      INTEGER h7b_2
      INTEGER p8b_2
      INTEGER p3b_2
      INTEGER p4b_2
      INTEGER p5b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(3)
      INTEGER isuperp
      INTEGER nsubh(2)
      INTEGER isubh
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h2b = 1,noab
      DO h13b = h2b,noab
      DO h11b = 1,noab
      DO p8b = noab+1,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h2b-1)+int_mb(k_spin+h13b-
     &1)+int_mb(k_spin+h11b-1)+int_mb(k_spin+p8b-1).ne.8)) THEN
      IF (int_mb(k_spin+h2b-1)+int_mb(k_spin+h13b-1) .eq. int_mb(k_spin+
     &h11b-1)+int_mb(k_spin+p8b-1)) THEN
      IF (ieor(int_mb(k_sym+h2b-1),ieor(int_mb(k_sym+h13b-1),ieor(int_mb
     &(k_sym+h11b-1),int_mb(k_sym+p8b-1)))) .eq. ieor(irrep_y,irrep_t)) 
     &THEN
      dimc = int_mb(k_range+h2b-1) * int_mb(k_range+h13b-1) * int_mb(k_r
     &ange+h11b-1) * int_mb(k_range+p8b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_12_3_3',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      DO p5b = p4b,noab+nvab
      DO h6b = 1,noab
      DO h7b = h6b,noab
      IF (int_mb(k_active+p3b-1)+int_mb(k_active+p4b-1)+int_mb(k_active+
     &p5b-1) .ge. numact) THEN
      IF (int_mb(k_active+h11b-1)+int_mb(k_active+h6b-1)+int_mb(k_active
     &+h7b-1) .ge. numact) THEN
      IF (int_mb(k_active+h2b-1)+int_mb(k_active+h13b-1)+int_mb(k_active
     &+h6b-1)+int_mb(k_active+h7b-1) .ge. numacq) THEN
      IF (int_mb(k_active+p8b-1)+int_mb(k_active+p3b-1)+int_mb(k_active+
     &p4b-1)+int_mb(k_active+p5b-1) .ge. numacq) THEN
      IF (int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1)+int_mb(k_spin+p5b-1)
     & .eq. int_mb(k_spin+h11b-1)+int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b
     &-1)) THEN
      IF (ieor(int_mb(k_sym+p3b-1),ieor(int_mb(k_sym+p4b-1),ieor(int_mb(
     &k_sym+p5b-1),ieor(int_mb(k_sym+h11b-1),ieor(int_mb(k_sym+h6b-1),in
     &t_mb(k_sym+h7b-1)))))) .eq. irrep_t) THEN
      CALL TCE_RESTRICTED_6(p3b,p4b,p5b,h11b,h6b,h7b,p3b_1,p4b_1,p5b_1,h
     &11b_1,h6b_1,h7b_1)
      CALL TCE_RESTRICTED_8(h2b,h13b,h6b,h7b,p8b,p3b,p4b,p5b,h2b_2,h13b_
     &2,h6b_2,h7b_2,p8b_2,p3b_2,p4b_2,p5b_2)
      dim_common = int_mb(k_range+p3b-1) * int_mb(k_range+p4b-1) * int_m
     &b(k_range+p5b-1) * int_mb(k_range+h6b-1) * int_mb(k_range+h7b-1)
      dima_sort = int_mb(k_range+h11b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h2b-1) * int_mb(k_range+h13b-1) * int_m
     &b(k_range+p8b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_12_3_3',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_12_3_3',2,MA_ERR)
      IF ((h7b .le. h11b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h11b_
     &1 - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 + noab * (p5b_1 - no
     &ab - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h11b-1),6,5,4,3,2,1,1.0d0,.f
     &alse.)
      END IF
      IF ((h6b .le. h11b) .and. (h11b .lt. h7b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h7b_1
     & - 1 + noab * (h11b_1 - 1 + noab * (h6b_1 - 1 + noab * (p5b_1 - no
     &ab - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h11b-1),int_mb(k_range+h7b-1),5,6,4,3,2,1,-1.0d0,.
     &false.)
      END IF
      IF ((h11b .lt. h6b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h7b_1
     & - 1 + noab * (h6b_1 - 1 + noab * (h11b_1 - 1 + noab * (p5b_1 - no
     &ab - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+h11b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),4,6,5,3,2,1,1.0d0,.f
     &alse.)
      END IF
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_12_
     &3_3',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_12_3_3',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_12_3_3',5,MA_ERR)
      IF ((h7b .lt. h2b) .and. (p5b .le. p8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h13b_2 - 1 + noab * (h2b_2 - 
     &1 + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h2b-1),int_mb(k_range+h13b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+p8b-1),8,4,3,2,1,7,6,5,1.0d0,.false.)
      END IF
      IF ((h7b .lt. h2b) .and. (p4b .le. p8b) .and. (p8b .lt. p5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h13b_2 - 1 + noab * (h2b_2 - 
     &1 + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h2b-1),int_mb(k_range+h13b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p8b-1
     &),int_mb(k_range+p5b-1),7,4,3,2,1,8,6,5,-1.0d0,.false.)
      END IF
      IF ((h7b .lt. h2b) .and. (p3b .le. p8b) .and. (p8b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p8b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h13b_2 - 1 + noab * (h2b_2 - 
     &1 + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h2b-1),int_mb(k_range+h13b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p8b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p5b-1),6,4,3,2,1,8,7,5,1.0d0,.false.)
      END IF
      IF ((h7b .lt. h2b) .and. (p8b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p8b_2 - noab - 1 + nvab * (h13b_2 - 1 + noab * (h2b_2 - 
     &1 + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h2b-1),int_mb(k_range+h13b-1
     &),int_mb(k_range+p8b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p5b-1),5,4,3,2,1,8,7,6,-1.0d0,.false.)
      END IF
      IF ((h6b .lt. h2b) .and. (h2b .le. h7b) .and. (h7b .le. h13b) .and
     &. (p5b .le. p8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h13b_2 - 1 + noab * (h7b_2 - 
     &1 + noab * (h2b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h7b-1),int_mb(k_range+h13b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+p8b-1),8,4,2,3,1,7,6,5,-1.0d0,.false.)
      END IF
      IF ((h6b .lt. h2b) .and. (h2b .le. h7b) .and. (h7b .le. h13b) .and
     &. (p4b .le. p8b) .and. (p8b .lt. p5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h13b_2 - 1 + noab * (h7b_2 - 
     &1 + noab * (h2b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h7b-1),int_mb(k_range+h13b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p8b-1
     &),int_mb(k_range+p5b-1),7,4,2,3,1,8,6,5,1.0d0,.false.)
      END IF
      IF ((h6b .lt. h2b) .and. (h2b .le. h7b) .and. (h7b .le. h13b) .and
     &. (p3b .le. p8b) .and. (p8b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p8b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h13b_2 - 1 + noab * (h7b_2 - 
     &1 + noab * (h2b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h7b-1),int_mb(k_range+h13b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p8b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p5b-1),6,4,2,3,1,8,7,5,-1.0d0,.false.)
      END IF
      IF ((h6b .lt. h2b) .and. (h2b .le. h7b) .and. (h7b .le. h13b) .and
     &. (p8b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p8b_2 - noab - 1 + nvab * (h13b_2 - 1 + noab * (h7b_2 - 
     &1 + noab * (h2b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h7b-1),int_mb(k_range+h13b-1
     &),int_mb(k_range+p8b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p5b-1),5,4,2,3,1,8,7,6,1.0d0,.false.)
      END IF
      IF ((h6b .lt. h2b) .and. (h13b .lt. h7b) .and. (p5b .le. p8b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h13b_2 - 
     &1 + noab * (h2b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h13b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+p8b-1),8,3,2,4,1,7,6,5,1.0d0,.false.)
      END IF
      IF ((h6b .lt. h2b) .and. (h13b .lt. h7b) .and. (p4b .le. p8b) .and
     &. (p8b .lt. p5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h13b_2 - 
     &1 + noab * (h2b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h13b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p8b-1
     &),int_mb(k_range+p5b-1),7,3,2,4,1,8,6,5,-1.0d0,.false.)
      END IF
      IF ((h6b .lt. h2b) .and. (h13b .lt. h7b) .and. (p3b .le. p8b) .and
     &. (p8b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p8b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h13b_2 - 
     &1 + noab * (h2b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h13b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p8b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p5b-1),6,3,2,4,1,8,7,5,1.0d0,.false.)
      END IF
      IF ((h6b .lt. h2b) .and. (h13b .lt. h7b) .and. (p8b .lt. p3b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p8b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h13b_2 - 
     &1 + noab * (h2b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h2b-1),int_mb(k_range+h13b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p8b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p5b-1),5,3,2,4,1,8,7,6,-1.0d0,.false.)
      END IF
      IF ((h2b .le. h6b) .and. (h7b .le. h13b) .and. (p5b .le. p8b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h13b_2 - 1 + noab * (h7b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h13b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+p8b-1),8,4,1,3,2,7,6,5,1.0d0,.false.)
      END IF
      IF ((h2b .le. h6b) .and. (h7b .le. h13b) .and. (p4b .le. p8b) .and
     &. (p8b .lt. p5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h13b_2 - 1 + noab * (h7b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h13b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p8b-1
     &),int_mb(k_range+p5b-1),7,4,1,3,2,8,6,5,-1.0d0,.false.)
      END IF
      IF ((h2b .le. h6b) .and. (h7b .le. h13b) .and. (p3b .le. p8b) .and
     &. (p8b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p8b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h13b_2 - 1 + noab * (h7b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h13b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p8b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p5b-1),6,4,1,3,2,8,7,5,1.0d0,.false.)
      END IF
      IF ((h2b .le. h6b) .and. (h7b .le. h13b) .and. (p8b .lt. p3b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p8b_2 - noab - 1 + nvab * (h13b_2 - 1 + noab * (h7b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h13b-1
     &),int_mb(k_range+p8b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p5b-1),5,4,1,3,2,8,7,6,-1.0d0,.false.)
      END IF
      IF ((h2b .le. h6b) .and. (h6b .le. h13b) .and. (h13b .lt. h7b) .an
     &d. (p5b .le. p8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h13b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h13b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+p8b-1),8,3,1,4,2,7,6,5,-1.0d0,.false.)
      END IF
      IF ((h2b .le. h6b) .and. (h6b .le. h13b) .and. (h13b .lt. h7b) .an
     &d. (p4b .le. p8b) .and. (p8b .lt. p5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h13b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h13b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p8b-1
     &),int_mb(k_range+p5b-1),7,3,1,4,2,8,6,5,1.0d0,.false.)
      END IF
      IF ((h2b .le. h6b) .and. (h6b .le. h13b) .and. (h13b .lt. h7b) .an
     &d. (p3b .le. p8b) .and. (p8b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p8b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h13b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h13b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p8b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p5b-1),6,3,1,4,2,8,7,5,-1.0d0,.false.)
      END IF
      IF ((h2b .le. h6b) .and. (h6b .le. h13b) .and. (h13b .lt. h7b) .an
     &d. (p8b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p8b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h13b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h13b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p8b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p5b-1),5,3,1,4,2,8,7,6,1.0d0,.false.)
      END IF
      IF ((h13b .lt. h6b) .and. (p5b .le. p8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 1
     & + noab * (h13b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h13b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+p8b-1),8,2,1,4,3,7,6,5,1.0d0,.false.)
      END IF
      IF ((h13b .lt. h6b) .and. (p4b .le. p8b) .and. (p8b .lt. p5b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 1
     & + noab * (h13b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h13b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p8b-1
     &),int_mb(k_range+p5b-1),7,2,1,4,3,8,6,5,-1.0d0,.false.)
      END IF
      IF ((h13b .lt. h6b) .and. (p3b .le. p8b) .and. (p8b .lt. p4b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p8b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 1
     & + noab * (h13b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h13b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p8b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p5b-1),6,2,1,4,3,8,7,5,1.0d0,.false.)
      END IF
      IF ((h13b .lt. h6b) .and. (p8b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p8b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 1
     & + noab * (h13b_2 - 1 + noab * (h2b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h2b-1)
     &,int_mb(k_range+h13b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p8b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p5b-1),5,2,1,4,3,8,7,6,-1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_12_
     &3_3',6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      nsuperp(3) = 1
      isuperp = 1
      IF (p3b .eq. p4b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      IF (p4b .eq. p5b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      nsubh(1) = 1
      nsubh(2) = 1
      isubh = 1
      IF (h6b .eq. h7b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,12.0d0/FACTO
     &RIAL(nsuperp(1))/FACTORIAL(nsuperp(2))/FACTORIAL(nsuperp(3))/FACTO
     &RIAL(nsubh(1))/FACTORIAL(nsubh(2)),dbl_mb(k_a_sort),dim_common,dbl
     &_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_12_3_3',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_12_3_3',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_12_3_3',9,MA_ERR)
      CALL TCE_SORT_4(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p8b-1)
     &,int_mb(k_range+h13b-1),int_mb(k_range+h2b-1),int_mb(k_range+h11b-
     &1),3,2,4,1,1.0d0/12.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p8b -
     & noab - 1 + nvab * (h11b - 1 + noab * (h13b - 1 + noab * (h2b - 1)
     &))))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_12_
     &3_3',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_12_3_3',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_12_4(d_a,k_a_offset,d_b,k_b_offset
     &,d_c,k_c_offset)
C     i2 ( p12 h11 )_ytt + = -1/3 * Sum ( h5 h6 h7 p3 p4 ) * t ( p3 p4 p12 h5 h6 h7 )_t * i3 ( h5 h6 h7 h11 p3 p4 )_yt
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER p12b
      INTEGER h11b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p3b
      INTEGER p4b
      INTEGER h5b
      INTEGER h6b
      INTEGER h7b
      INTEGER p12b_1
      INTEGER p3b_1
      INTEGER p4b_1
      INTEGER h5b_1
      INTEGER h6b_1
      INTEGER h7b_1
      INTEGER h5b_2
      INTEGER h6b_2
      INTEGER h7b_2
      INTEGER h11b_2
      INTEGER p3b_2
      INTEGER p4b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(2)
      INTEGER isuperp
      INTEGER nsubh(3)
      INTEGER isubh
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO p12b = noab+1,noab+nvab
      DO h11b = 1,noab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+p12b-1)+int_mb(k_spin+h11b
     &-1).ne.4)) THEN
      IF (int_mb(k_spin+p12b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+p12b-1),int_mb(k_sym+h11b-1)) .eq. ieor(irre
     &p_y,ieor(irrep_t,irrep_t))) THEN
      dimc = int_mb(k_range+p12b-1) * int_mb(k_range+h11b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_12_4',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      DO h5b = 1,noab
      DO h6b = h5b,noab
      DO h7b = h6b,noab
      IF (int_mb(k_active+p12b-1)+int_mb(k_active+p3b-1)+int_mb(k_active
     &+p4b-1) .ge. numact) THEN
      IF (int_mb(k_active+h5b-1)+int_mb(k_active+h6b-1)+int_mb(k_active+
     &h7b-1) .ge. numact) THEN
      IF (int_mb(k_spin+p12b-1)+int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1
     &) .eq. int_mb(k_spin+h5b-1)+int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b
     &-1)) THEN
      IF (ieor(int_mb(k_sym+p12b-1),ieor(int_mb(k_sym+p3b-1),ieor(int_mb
     &(k_sym+p4b-1),ieor(int_mb(k_sym+h5b-1),ieor(int_mb(k_sym+h6b-1),in
     &t_mb(k_sym+h7b-1)))))) .eq. irrep_t) THEN
      CALL TCE_RESTRICTED_6(p12b,p3b,p4b,h5b,h6b,h7b,p12b_1,p3b_1,p4b_1,
     &h5b_1,h6b_1,h7b_1)
      CALL TCE_RESTRICTED_6(h5b,h6b,h7b,h11b,p3b,p4b,h5b_2,h6b_2,h7b_2,h
     &11b_2,p3b_2,p4b_2)
      dim_common = int_mb(k_range+p3b-1) * int_mb(k_range+p4b-1) * int_m
     &b(k_range+h5b-1) * int_mb(k_range+h6b-1) * int_mb(k_range+h7b-1)
      dima_sort = int_mb(k_range+p12b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h11b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_12_4',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_12_4',2,MA_ERR)
      IF ((p4b .le. p12b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h7b_1
     & - 1 + noab * (h6b_1 - 1 + noab * (h5b_1 - 1 + noab * (p12b_1 - no
     &ab - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p12b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),3,6,5,4,2,1,1.0d0,.f
     &alse.)
      END IF
      IF ((p3b .le. p12b) .and. (p12b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h7b_1
     & - 1 + noab * (h6b_1 - 1 + noab * (h5b_1 - 1 + noab * (p4b_1 - noa
     &b - 1 + nvab * (p12b_1 - noab - 1 + nvab * (p3b_1 - noab - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p12b-1),int_mb(k_range+p4b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),2,6,5,4,3,1,-1.0d0,.
     &false.)
      END IF
      IF ((p12b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h7b_1
     & - 1 + noab * (h6b_1 - 1 + noab * (h5b_1 - 1 + noab * (p4b_1 - noa
     &b - 1 + nvab * (p3b_1 - noab - 1 + nvab * (p12b_1 - noab - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p12b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),1,6,5,4,3,2,1.0d0,.f
     &alse.)
      END IF
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_12_
     &4',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_12_4',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_12_4',5,MA_ERR)
      IF ((h11b .le. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (h11b_2 - 1 + noab
     & * (h7b_2 - 1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h11b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),4,3,2,1,6,5,1.0d0,.f
     &alse.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_12_
     &4',6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      isuperp = 1
      IF (p3b .eq. p4b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      nsubh(1) = 1
      nsubh(2) = 1
      nsubh(3) = 1
      isubh = 1
      IF (h5b .eq. h6b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      IF (h6b .eq. h7b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,12.0d0/FACTO
     &RIAL(nsuperp(1))/FACTORIAL(nsuperp(2))/FACTORIAL(nsubh(1))/FACTORI
     &AL(nsubh(2))/FACTORIAL(nsubh(3)),dbl_mb(k_a_sort),dim_common,dbl_m
     &b(k_b_sort),dim_common,1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_12_4',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_12_4',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_12_4',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+h11b-1
     &),int_mb(k_range+p12b-1),2,1,-1.0d0/3.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(h11b 
     &- 1 + noab * (p12b - noab - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_12_
     &4',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_12_4',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_12_4_1(d_a,k_a_offset,d_b,k_b_offs
     &et,d_c,k_c_offset)
C     i3 ( h5 h6 h7 h11 p3 p4 )_yt + = 1 * Sum ( p8 ) * t ( p8 h11 )_t * y ( h5 h6 h7 p3 p4 p8 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h5b
      INTEGER h6b
      INTEGER h7b
      INTEGER h11b
      INTEGER p3b
      INTEGER p4b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p8b
      INTEGER p8b_1
      INTEGER h11b_1
      INTEGER h5b_2
      INTEGER h6b_2
      INTEGER h7b_2
      INTEGER p3b_2
      INTEGER p4b_2
      INTEGER p8b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h5b = 1,noab
      DO h6b = h5b,noab
      DO h7b = h6b,noab
      DO h11b = 1,noab
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h5b-1)+int_mb(k_spin+h6b-1
     &)+int_mb(k_spin+h7b-1)+int_mb(k_spin+h11b-1)+int_mb(k_spin+p3b-1)+
     &int_mb(k_spin+p4b-1).ne.12)) THEN
      IF (int_mb(k_spin+h5b-1)+int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b-1)
     & .eq. int_mb(k_spin+h11b-1)+int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b
     &-1)) THEN
      IF (ieor(int_mb(k_sym+h5b-1),ieor(int_mb(k_sym+h6b-1),ieor(int_mb(
     &k_sym+h7b-1),ieor(int_mb(k_sym+h11b-1),ieor(int_mb(k_sym+p3b-1),in
     &t_mb(k_sym+p4b-1)))))) .eq. ieor(irrep_y,irrep_t)) THEN
      dimc = int_mb(k_range+h5b-1) * int_mb(k_range+h6b-1) * int_mb(k_ra
     &nge+h7b-1) * int_mb(k_range+h11b-1) * int_mb(k_range+p3b-1) * int_
     &mb(k_range+p4b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_12_4_1',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p8b = noab+1,noab+nvab
      IF (int_mb(k_active+h5b-1)+int_mb(k_active+h6b-1)+int_mb(k_active+
     &h7b-1) .ge. numact) THEN
      IF (int_mb(k_active+p3b-1)+int_mb(k_active+p4b-1)+int_mb(k_active+
     &p8b-1) .ge. numact) THEN
      IF (int_mb(k_spin+p8b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+p8b-1),int_mb(k_sym+h11b-1)) .eq. irrep_t) T
     &HEN
      CALL TCE_RESTRICTED_2(p8b,h11b,p8b_1,h11b_1)
      CALL TCE_RESTRICTED_6(h5b,h6b,h7b,p3b,p4b,p8b,h5b_2,h6b_2,h7b_2,p3
     &b_2,p4b_2,p8b_2)
      dim_common = int_mb(k_range+p8b-1)
      dima_sort = int_mb(k_range+h11b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h5b-1) * int_mb(k_range+h6b-1) * int_mb
     &(k_range+h7b-1) * int_mb(k_range+p3b-1) * int_mb(k_range+p4b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_12_4_1',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_12_4_1',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h11b_
     &1 - 1 + noab * (p8b_1 - noab - 1)))
      CALL TCE_SORT_2(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p8b-1)
     &,int_mb(k_range+h11b-1),2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_12_
     &4_1',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_12_4_1',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_12_4_1',5,MA_ERR)
      IF ((p8b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p8b_2 - noab - 1 
     &+ nvab * (h7b_2 - 1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+p8b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),6,5,3,2,1,4,1.0d0,.fa
     &lse.)
      END IF
      IF ((p3b .le. p8b) .and. (p8b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h7b_2 - 1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p8b-1),int_mb(k_range+p4b-1),6,4,3,2,1,5,-1.0d0,.f
     &alse.)
      END IF
      IF ((p4b .le. p8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h7b_2 - 1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p8b-1),5,4,3,2,1,6,1.0d0,.fa
     &lse.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_12_
     &4_1',6,MA_ERR)
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,1.0d0,dbl_mb
     &(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c
     &_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_12_4_1',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_12_4_1',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_12_4_1',9,MA_ERR)
      CALL TCE_SORT_6(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+h7b-1),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h11b-1),5,4,3,6,2,1,1.0d0,.f
     &alse.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p4b -
     & noab - 1 + nvab * (p3b - noab - 1 + nvab * (h11b - 1 + noab * (h7
     &b - 1 + noab * (h6b - 1 + noab * (h5b - 1)))))))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_12_
     &4_1',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_12_4_1',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE OFFSET_eomccsdtq_density1_5_12_4_1(l_a_offset,k_a_offse
     &t,size)
C     i3 ( h5 h6 h7 h11 p3 p4 )_yt
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER l_a_offset
      INTEGER k_a_offset
      INTEGER length
      INTEGER addr
      INTEGER h5b
      INTEGER h6b
      INTEGER h7b
      INTEGER h11b
      INTEGER p3b
      INTEGER p4b
      DOUBLE PRECISION size
      length = 0
      DO h5b = 1,noab
      DO h6b = h5b,noab
      DO h7b = h6b,noab
      DO h11b = 1,noab
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      IF (int_mb(k_spin+h5b-1)+int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b-1)
     & .eq. int_mb(k_spin+h11b-1)+int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b
     &-1)) THEN
      IF (ieor(int_mb(k_sym+h5b-1),ieor(int_mb(k_sym+h6b-1),ieor(int_mb(
     &k_sym+h7b-1),ieor(int_mb(k_sym+h11b-1),ieor(int_mb(k_sym+p3b-1),in
     &t_mb(k_sym+p4b-1)))))) .eq. ieor(irrep_y,irrep_t)) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h5b-1)+int_mb(k_spin+h6b-1
     &)+int_mb(k_spin+h7b-1)+int_mb(k_spin+h11b-1)+int_mb(k_spin+p3b-1)+
     &int_mb(k_spin+p4b-1).ne.12)) THEN
      length = length + 1
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,2*length+1,'noname',l_a_offset,k_a_off
     &set)) CALL ERRQUIT('eomccsdtq_density1_5_12_4_1',0,MA_ERR)
      dbl_mb(k_a_offset) = dfloat(length)
      addr = 0
      size = 0.0d0
      DO h5b = 1,noab
      DO h6b = h5b,noab
      DO h7b = h6b,noab
      DO h11b = 1,noab
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      IF (int_mb(k_spin+h5b-1)+int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b-1)
     & .eq. int_mb(k_spin+h11b-1)+int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b
     &-1)) THEN
      IF (ieor(int_mb(k_sym+h5b-1),ieor(int_mb(k_sym+h6b-1),ieor(int_mb(
     &k_sym+h7b-1),ieor(int_mb(k_sym+h11b-1),ieor(int_mb(k_sym+p3b-1),in
     &t_mb(k_sym+p4b-1)))))) .eq. ieor(irrep_y,irrep_t)) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h5b-1)+int_mb(k_spin+h6b-1
     &)+int_mb(k_spin+h7b-1)+int_mb(k_spin+h11b-1)+int_mb(k_spin+p3b-1)+
     &int_mb(k_spin+p4b-1).ne.12)) THEN
      addr = addr + 1
      dbl_mb(k_a_offset+addr) = dfloat(p4b - noab - 1 + nvab * (p3b - no
     &ab - 1 + nvab * (h11b - 1 + noab * (h7b - 1 + noab * (h6b - 1 + no
     &ab * (h5b - 1))))))
      dbl_mb(k_a_offset+length+addr) = size
      size = size + dfloat(int_mb(k_range+h5b-1)) * dfloat(int_mb(k_rang
     &e+h6b-1)) * dfloat(int_mb(k_range+h7b-1)) * dfloat(int_mb(k_range+
     &h11b-1)) * dfloat(int_mb(k_range+p3b-1)) * dfloat(int_mb(k_range+p
     &4b-1))
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_12_4_2(d_a,k_a_offset,d_b,k_b_offs
     &et,d_c,k_c_offset)
C     i3 ( h5 h6 h7 h11 p3 p4 )_yt + = -1/2 * Sum ( h10 p9 p8 ) * t ( p8 p9 h10 h11 )_t * y ( h5 h6 h7 h10 p3 p4 p8 p9 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h5b
      INTEGER h6b
      INTEGER h7b
      INTEGER h11b
      INTEGER p3b
      INTEGER p4b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p8b
      INTEGER p9b
      INTEGER h10b
      INTEGER p8b_1
      INTEGER p9b_1
      INTEGER h11b_1
      INTEGER h10b_1
      INTEGER h5b_2
      INTEGER h6b_2
      INTEGER h7b_2
      INTEGER h10b_2
      INTEGER p3b_2
      INTEGER p4b_2
      INTEGER p8b_2
      INTEGER p9b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(2)
      INTEGER isuperp
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h5b = 1,noab
      DO h6b = h5b,noab
      DO h7b = h6b,noab
      DO h11b = 1,noab
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h5b-1)+int_mb(k_spin+h6b-1
     &)+int_mb(k_spin+h7b-1)+int_mb(k_spin+h11b-1)+int_mb(k_spin+p3b-1)+
     &int_mb(k_spin+p4b-1).ne.12)) THEN
      IF (int_mb(k_spin+h5b-1)+int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b-1)
     & .eq. int_mb(k_spin+h11b-1)+int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b
     &-1)) THEN
      IF (ieor(int_mb(k_sym+h5b-1),ieor(int_mb(k_sym+h6b-1),ieor(int_mb(
     &k_sym+h7b-1),ieor(int_mb(k_sym+h11b-1),ieor(int_mb(k_sym+p3b-1),in
     &t_mb(k_sym+p4b-1)))))) .eq. ieor(irrep_y,irrep_t)) THEN
      dimc = int_mb(k_range+h5b-1) * int_mb(k_range+h6b-1) * int_mb(k_ra
     &nge+h7b-1) * int_mb(k_range+h11b-1) * int_mb(k_range+p3b-1) * int_
     &mb(k_range+p4b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_12_4_2',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p8b = noab+1,noab+nvab
      DO p9b = p8b,noab+nvab
      DO h10b = 1,noab
      IF (int_mb(k_active+h5b-1)+int_mb(k_active+h6b-1)+int_mb(k_active+
     &h7b-1)+int_mb(k_active+h10b-1) .ge. numacq) THEN
      IF (int_mb(k_active+p3b-1)+int_mb(k_active+p4b-1)+int_mb(k_active+
     &p8b-1)+int_mb(k_active+p9b-1) .ge. numacq) THEN
      IF (int_mb(k_spin+p8b-1)+int_mb(k_spin+p9b-1) .eq. int_mb(k_spin+h
     &11b-1)+int_mb(k_spin+h10b-1)) THEN
      IF (ieor(int_mb(k_sym+p8b-1),ieor(int_mb(k_sym+p9b-1),ieor(int_mb(
     &k_sym+h11b-1),int_mb(k_sym+h10b-1)))) .eq. irrep_t) THEN
      CALL TCE_RESTRICTED_4(p8b,p9b,h11b,h10b,p8b_1,p9b_1,h11b_1,h10b_1)
      CALL TCE_RESTRICTED_8(h5b,h6b,h7b,h10b,p3b,p4b,p8b,p9b,h5b_2,h6b_2
     &,h7b_2,h10b_2,p3b_2,p4b_2,p8b_2,p9b_2)
      dim_common = int_mb(k_range+p8b-1) * int_mb(k_range+p9b-1) * int_m
     &b(k_range+h10b-1)
      dima_sort = int_mb(k_range+h11b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h5b-1) * int_mb(k_range+h6b-1) * int_mb
     &(k_range+h7b-1) * int_mb(k_range+p3b-1) * int_mb(k_range+p4b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_12_4_2',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_12_4_2',2,MA_ERR)
      IF ((h10b .le. h11b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h11b_
     &1 - 1 + noab * (h10b_1 - 1 + noab * (p9b_1 - noab - 1 + nvab * (p8
     &b_1 - noab - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p8b-1)
     &,int_mb(k_range+p9b-1),int_mb(k_range+h10b-1),int_mb(k_range+h11b-
     &1),4,3,2,1,1.0d0,.false.)
      END IF
      IF ((h11b .lt. h10b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h10b_
     &1 - 1 + noab * (h11b_1 - 1 + noab * (p9b_1 - noab - 1 + nvab * (p8
     &b_1 - noab - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p8b-1)
     &,int_mb(k_range+p9b-1),int_mb(k_range+h11b-1),int_mb(k_range+h10b-
     &1),3,4,2,1,-1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_12_
     &4_2',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_12_4_2',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_12_4_2',5,MA_ERR)
      IF ((h10b .lt. h5b) .and. (p9b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p9b_2 - noab - 1 
     &+ nvab * (p8b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 1
     & + noab * (h5b_2 - 1 + noab * (h10b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h10b-1
     &),int_mb(k_range+h5b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p8b-1),int_mb(k_range+p9b-1),int_mb(k_range+p3b-1
     &),int_mb(k_range+p4b-1),8,7,4,3,2,1,6,5,-1.0d0,.false.)
      END IF
      IF ((h10b .lt. h5b) .and. (p8b .lt. p3b) .and. (p3b .le. p9b) .and
     &. (p9b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p9b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p8b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 1
     & + noab * (h5b_2 - 1 + noab * (h10b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h10b-1
     &),int_mb(k_range+h5b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p8b-1),int_mb(k_range+p3b-1),int_mb(k_range+p9b-1
     &),int_mb(k_range+p4b-1),8,6,4,3,2,1,7,5,1.0d0,.false.)
      END IF
      IF ((h10b .lt. h5b) .and. (p8b .lt. p3b) .and. (p4b .le. p9b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p9b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p8b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 1
     & + noab * (h5b_2 - 1 + noab * (h10b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h10b-1
     &),int_mb(k_range+h5b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p8b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p9b-1),7,6,4,3,2,1,8,5,-1.0d0,.false.)
      END IF
      IF ((h10b .lt. h5b) .and. (p3b .le. p8b) .and. (p9b .lt. p4b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p9b_2 - noab - 1 + nvab * (p8b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 1
     & + noab * (h5b_2 - 1 + noab * (h10b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h10b-1
     &),int_mb(k_range+h5b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p8b-1),int_mb(k_range+p9b-1
     &),int_mb(k_range+p4b-1),8,5,4,3,2,1,7,6,-1.0d0,.false.)
      END IF
      IF ((h10b .lt. h5b) .and. (p3b .le. p8b) .and. (p8b .lt. p4b) .and
     &. (p4b .le. p9b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p9b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p8b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 1
     & + noab * (h5b_2 - 1 + noab * (h10b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h10b-1
     &),int_mb(k_range+h5b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p8b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p9b-1),7,5,4,3,2,1,8,6,1.0d0,.false.)
      END IF
      IF ((h10b .lt. h5b) .and. (p4b .le. p8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p9b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 1
     & + noab * (h5b_2 - 1 + noab * (h10b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h10b-1
     &),int_mb(k_range+h5b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p8b-1
     &),int_mb(k_range+p9b-1),6,5,4,3,2,1,8,7,-1.0d0,.false.)
      END IF
      IF ((h5b .le. h10b) .and. (h10b .lt. h6b) .and. (p9b .lt. p3b)) TH
     &EN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p9b_2 - noab - 1 
     &+ nvab * (p8b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 1
     & + noab * (h10b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h10b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p8b-1),int_mb(k_range+p9b-1),int_mb(k_range+p3b-1
     &),int_mb(k_range+p4b-1),8,7,4,3,1,2,6,5,1.0d0,.false.)
      END IF
      IF ((h5b .le. h10b) .and. (h10b .lt. h6b) .and. (p8b .lt. p3b) .an
     &d. (p3b .le. p9b) .and. (p9b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p9b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p8b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 1
     & + noab * (h10b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h10b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p8b-1),int_mb(k_range+p3b-1),int_mb(k_range+p9b-1
     &),int_mb(k_range+p4b-1),8,6,4,3,1,2,7,5,-1.0d0,.false.)
      END IF
      IF ((h5b .le. h10b) .and. (h10b .lt. h6b) .and. (p8b .lt. p3b) .an
     &d. (p4b .le. p9b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p9b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p8b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 1
     & + noab * (h10b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h10b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p8b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p9b-1),7,6,4,3,1,2,8,5,1.0d0,.false.)
      END IF
      IF ((h5b .le. h10b) .and. (h10b .lt. h6b) .and. (p3b .le. p8b) .an
     &d. (p9b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p9b_2 - noab - 1 + nvab * (p8b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 1
     & + noab * (h10b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h10b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p8b-1),int_mb(k_range+p9b-1
     &),int_mb(k_range+p4b-1),8,5,4,3,1,2,7,6,1.0d0,.false.)
      END IF
      IF ((h5b .le. h10b) .and. (h10b .lt. h6b) .and. (p3b .le. p8b) .an
     &d. (p8b .lt. p4b) .and. (p4b .le. p9b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p9b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p8b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 1
     & + noab * (h10b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h10b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p8b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p9b-1),7,5,4,3,1,2,8,6,-1.0d0,.false.)
      END IF
      IF ((h5b .le. h10b) .and. (h10b .lt. h6b) .and. (p4b .le. p8b)) TH
     &EN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p9b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 1
     & + noab * (h10b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h10b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p8b-1
     &),int_mb(k_range+p9b-1),6,5,4,3,1,2,8,7,1.0d0,.false.)
      END IF
      IF ((h6b .le. h10b) .and. (h10b .lt. h7b) .and. (p9b .lt. p3b)) TH
     &EN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p9b_2 - noab - 1 
     &+ nvab * (p8b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h10b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p8b-1),int_mb(k_range+p9b-1),int_mb(k_range+p3b-1
     &),int_mb(k_range+p4b-1),8,7,4,2,1,3,6,5,-1.0d0,.false.)
      END IF
      IF ((h6b .le. h10b) .and. (h10b .lt. h7b) .and. (p8b .lt. p3b) .an
     &d. (p3b .le. p9b) .and. (p9b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p9b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p8b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h10b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p8b-1),int_mb(k_range+p3b-1),int_mb(k_range+p9b-1
     &),int_mb(k_range+p4b-1),8,6,4,2,1,3,7,5,1.0d0,.false.)
      END IF
      IF ((h6b .le. h10b) .and. (h10b .lt. h7b) .and. (p8b .lt. p3b) .an
     &d. (p4b .le. p9b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p9b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p8b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h10b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p8b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p9b-1),7,6,4,2,1,3,8,5,-1.0d0,.false.)
      END IF
      IF ((h6b .le. h10b) .and. (h10b .lt. h7b) .and. (p3b .le. p8b) .an
     &d. (p9b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p9b_2 - noab - 1 + nvab * (p8b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h10b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p8b-1),int_mb(k_range+p9b-1
     &),int_mb(k_range+p4b-1),8,5,4,2,1,3,7,6,-1.0d0,.false.)
      END IF
      IF ((h6b .le. h10b) .and. (h10b .lt. h7b) .and. (p3b .le. p8b) .an
     &d. (p8b .lt. p4b) .and. (p4b .le. p9b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p9b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p8b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h10b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p8b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p9b-1),7,5,4,2,1,3,8,6,1.0d0,.false.)
      END IF
      IF ((h6b .le. h10b) .and. (h10b .lt. h7b) .and. (p4b .le. p8b)) TH
     &EN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p9b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h10b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p8b-1
     &),int_mb(k_range+p9b-1),6,5,4,2,1,3,8,7,-1.0d0,.false.)
      END IF
      IF ((h7b .le. h10b) .and. (p9b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p9b_2 - noab - 1 
     &+ nvab * (p8b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h7b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p8b-1),int_mb(k_range+p9b-1),int_mb(k_range+p3b-1
     &),int_mb(k_range+p4b-1),8,7,3,2,1,4,6,5,1.0d0,.false.)
      END IF
      IF ((h7b .le. h10b) .and. (p8b .lt. p3b) .and. (p3b .le. p9b) .and
     &. (p9b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p9b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p8b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h7b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p8b-1),int_mb(k_range+p3b-1),int_mb(k_range+p9b-1
     &),int_mb(k_range+p4b-1),8,6,3,2,1,4,7,5,-1.0d0,.false.)
      END IF
      IF ((h7b .le. h10b) .and. (p8b .lt. p3b) .and. (p4b .le. p9b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p9b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p8b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h7b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p8b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p9b-1),7,6,3,2,1,4,8,5,1.0d0,.false.)
      END IF
      IF ((h7b .le. h10b) .and. (p3b .le. p8b) .and. (p9b .lt. p4b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p9b_2 - noab - 1 + nvab * (p8b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h7b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p8b-1),int_mb(k_range+p9b-1
     &),int_mb(k_range+p4b-1),8,5,3,2,1,4,7,6,1.0d0,.false.)
      END IF
      IF ((h7b .le. h10b) .and. (p3b .le. p8b) .and. (p8b .lt. p4b) .and
     &. (p4b .le. p9b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p9b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p8b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h7b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p8b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p9b-1),7,5,3,2,1,4,8,6,-1.0d0,.false.)
      END IF
      IF ((h7b .le. h10b) .and. (p4b .le. p8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p9b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h7b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p8b-1
     &),int_mb(k_range+p9b-1),6,5,3,2,1,4,8,7,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_12_
     &4_2',6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      isuperp = 1
      IF (p8b .eq. p9b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,2.0d0/FACTOR
     &IAL(nsuperp(1))/FACTORIAL(nsuperp(2)),dbl_mb(k_a_sort),dim_common,
     &dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_12_4_2',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_12_4_2',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_12_4_2',9,MA_ERR)
      CALL TCE_SORT_6(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+h7b-1),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h11b-1),5,4,3,6,2,1,-1.0d0/2
     &.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p4b -
     & noab - 1 + nvab * (p3b - noab - 1 + nvab * (h11b - 1 + noab * (h7
     &b - 1 + noab * (h6b - 1 + noab * (h5b - 1)))))))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_12_
     &4_2',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_12_4_2',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_12_5(d_a,k_a_offset,d_b,k_b_offset
     &,d_c,k_c_offset)
C     i2 ( p12 h11 )_ytt + = -1/36 * Sum ( h6 h7 h8 h9 p3 p4 p5 ) * t ( p3 p4 p5 p12 h6 h7 h8 h9 )_t * i3 ( h6 h7 h8 h9 h11 p3 p4 p5 )_yt
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER p12b
      INTEGER h11b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p3b
      INTEGER p4b
      INTEGER p5b
      INTEGER h6b
      INTEGER h7b
      INTEGER h8b
      INTEGER h9b
      INTEGER p12b_1
      INTEGER p3b_1
      INTEGER p4b_1
      INTEGER p5b_1
      INTEGER h6b_1
      INTEGER h7b_1
      INTEGER h8b_1
      INTEGER h9b_1
      INTEGER h6b_2
      INTEGER h7b_2
      INTEGER h8b_2
      INTEGER h9b_2
      INTEGER h11b_2
      INTEGER p3b_2
      INTEGER p4b_2
      INTEGER p5b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(3)
      INTEGER isuperp
      INTEGER nsubh(4)
      INTEGER isubh
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO p12b = noab+1,noab+nvab
      DO h11b = 1,noab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+p12b-1)+int_mb(k_spin+h11b
     &-1).ne.4)) THEN
      IF (int_mb(k_spin+p12b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+p12b-1),int_mb(k_sym+h11b-1)) .eq. ieor(irre
     &p_y,ieor(irrep_t,irrep_t))) THEN
      dimc = int_mb(k_range+p12b-1) * int_mb(k_range+h11b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_12_5',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      DO p5b = p4b,noab+nvab
      DO h6b = 1,noab
      DO h7b = h6b,noab
      DO h8b = h7b,noab
      DO h9b = h8b,noab
      IF (int_mb(k_active+p12b-1)+int_mb(k_active+p3b-1)+int_mb(k_active
     &+p4b-1)+int_mb(k_active+p5b-1) .ge. numacq) THEN
      IF (int_mb(k_active+h6b-1)+int_mb(k_active+h7b-1)+int_mb(k_active+
     &h8b-1)+int_mb(k_active+h9b-1) .ge. numacq) THEN
      IF (int_mb(k_spin+p12b-1)+int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1
     &)+int_mb(k_spin+p5b-1) .eq. int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b
     &-1)+int_mb(k_spin+h8b-1)+int_mb(k_spin+h9b-1)) THEN
      IF (ieor(int_mb(k_sym+p12b-1),ieor(int_mb(k_sym+p3b-1),ieor(int_mb
     &(k_sym+p4b-1),ieor(int_mb(k_sym+p5b-1),ieor(int_mb(k_sym+h6b-1),ie
     &or(int_mb(k_sym+h7b-1),ieor(int_mb(k_sym+h8b-1),int_mb(k_sym+h9b-1
     &)))))))) .eq. irrep_t) THEN
      CALL TCE_RESTRICTED_8(p12b,p3b,p4b,p5b,h6b,h7b,h8b,h9b,p12b_1,p3b_
     &1,p4b_1,p5b_1,h6b_1,h7b_1,h8b_1,h9b_1)
      CALL TCE_RESTRICTED_8(h6b,h7b,h8b,h9b,h11b,p3b,p4b,p5b,h6b_2,h7b_2
     &,h8b_2,h9b_2,h11b_2,p3b_2,p4b_2,p5b_2)
      dim_common = int_mb(k_range+p3b-1) * int_mb(k_range+p4b-1) * int_m
     &b(k_range+p5b-1) * int_mb(k_range+h6b-1) * int_mb(k_range+h7b-1) *
     & int_mb(k_range+h8b-1) * int_mb(k_range+h9b-1)
      dima_sort = int_mb(k_range+p12b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h11b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_12_5',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_12_5',2,MA_ERR)
      IF ((p5b .le. p12b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h9b_1
     & - 1 + noab * (h8b_1 - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 +
     & noab * (p12b_1 - noab - 1 + nvab * (p5b_1 - noab - 1 + nvab * (p4
     &b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+p12b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h8b-1
     &),int_mb(k_range+h9b-1),4,8,7,6,5,3,2,1,1.0d0,.false.)
      END IF
      IF ((p4b .le. p12b) .and. (p12b .lt. p5b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h9b_1
     & - 1 + noab * (h8b_1 - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 +
     & noab * (p5b_1 - noab - 1 + nvab * (p12b_1 - noab - 1 + nvab * (p4
     &b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p12b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h8b-1
     &),int_mb(k_range+h9b-1),3,8,7,6,5,4,2,1,-1.0d0,.false.)
      END IF
      IF ((p3b .le. p12b) .and. (p12b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h9b_1
     & - 1 + noab * (h8b_1 - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 +
     & noab * (p5b_1 - noab - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p12
     &b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p12b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h8b-1
     &),int_mb(k_range+h9b-1),2,8,7,6,5,4,3,1,1.0d0,.false.)
      END IF
      IF ((p12b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h9b_1
     & - 1 + noab * (h8b_1 - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 +
     & noab * (p5b_1 - noab - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p3b
     &_1 - noab - 1 + nvab * (p12b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p12b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h8b-1
     &),int_mb(k_range+h9b-1),1,8,7,6,5,4,3,2,-1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_12_
     &5',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_12_5',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_12_5',5,MA_ERR)
      IF ((h11b .le. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h11b_2 - 1 + noab * (h9b_2 - 1 + noab * (h8b_2 - 1 + noa
     &b * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h11b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p5b-1),5,4,3,2,1,8,7,6,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_12_
     &5',6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      nsuperp(3) = 1
      isuperp = 1
      IF (p3b .eq. p4b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      IF (p4b .eq. p5b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      nsubh(1) = 1
      nsubh(2) = 1
      nsubh(3) = 1
      nsubh(4) = 1
      isubh = 1
      IF (h6b .eq. h7b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      IF (h7b .eq. h8b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      IF (h8b .eq. h9b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,144.0d0/FACT
     &ORIAL(nsuperp(1))/FACTORIAL(nsuperp(2))/FACTORIAL(nsuperp(3))/FACT
     &ORIAL(nsubh(1))/FACTORIAL(nsubh(2))/FACTORIAL(nsubh(3))/FACTORIAL(
     &nsubh(4)),dbl_mb(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,
     &1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_12_5',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_12_5',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_12_5',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+h11b-1
     &),int_mb(k_range+p12b-1),2,1,-1.0d0/36.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(h11b 
     &- 1 + noab * (p12b - noab - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_12_
     &5',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_12_5',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_12_5_1(d_a,k_a_offset,d_b,k_b_offs
     &et,d_c,k_c_offset)
C     i3 ( h6 h7 h8 h9 h11 p3 p4 p5 )_yt + = 1 * Sum ( p10 ) * t ( p10 h11 )_t * y ( h6 h7 h8 h9 p3 p4 p5 p10 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h6b
      INTEGER h7b
      INTEGER h8b
      INTEGER h9b
      INTEGER h11b
      INTEGER p3b
      INTEGER p4b
      INTEGER p5b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p10b
      INTEGER p10b_1
      INTEGER h11b_1
      INTEGER h6b_2
      INTEGER h7b_2
      INTEGER h8b_2
      INTEGER h9b_2
      INTEGER p3b_2
      INTEGER p4b_2
      INTEGER p5b_2
      INTEGER p10b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h6b = 1,noab
      DO h7b = h6b,noab
      DO h8b = h7b,noab
      DO h9b = h8b,noab
      DO h11b = 1,noab
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      DO p5b = p4b,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b-1
     &)+int_mb(k_spin+h8b-1)+int_mb(k_spin+h9b-1)+int_mb(k_spin+h11b-1)+
     &int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1)+int_mb(k_spin+p5b-1).ne.
     &16)) THEN
      IF (int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b-1)+int_mb(k_spin+h8b-1)
     &+int_mb(k_spin+h9b-1) .eq. int_mb(k_spin+h11b-1)+int_mb(k_spin+p3b
     &-1)+int_mb(k_spin+p4b-1)+int_mb(k_spin+p5b-1)) THEN
      IF (ieor(int_mb(k_sym+h6b-1),ieor(int_mb(k_sym+h7b-1),ieor(int_mb(
     &k_sym+h8b-1),ieor(int_mb(k_sym+h9b-1),ieor(int_mb(k_sym+h11b-1),ie
     &or(int_mb(k_sym+p3b-1),ieor(int_mb(k_sym+p4b-1),int_mb(k_sym+p5b-1
     &)))))))) .eq. ieor(irrep_y,irrep_t)) THEN
      dimc = int_mb(k_range+h6b-1) * int_mb(k_range+h7b-1) * int_mb(k_ra
     &nge+h8b-1) * int_mb(k_range+h9b-1) * int_mb(k_range+h11b-1) * int_
     &mb(k_range+p3b-1) * int_mb(k_range+p4b-1) * int_mb(k_range+p5b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_12_5_1',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p10b = noab+1,noab+nvab
      IF (int_mb(k_active+h6b-1)+int_mb(k_active+h7b-1)+int_mb(k_active+
     &h8b-1)+int_mb(k_active+h9b-1) .ge. numacq) THEN
      IF (int_mb(k_active+p3b-1)+int_mb(k_active+p4b-1)+int_mb(k_active+
     &p5b-1)+int_mb(k_active+p10b-1) .ge. numacq) THEN
      IF (int_mb(k_spin+p10b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+p10b-1),int_mb(k_sym+h11b-1)) .eq. irrep_t) 
     &THEN
      CALL TCE_RESTRICTED_2(p10b,h11b,p10b_1,h11b_1)
      CALL TCE_RESTRICTED_8(h6b,h7b,h8b,h9b,p3b,p4b,p5b,p10b,h6b_2,h7b_2
     &,h8b_2,h9b_2,p3b_2,p4b_2,p5b_2,p10b_2)
      dim_common = int_mb(k_range+p10b-1)
      dima_sort = int_mb(k_range+h11b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h6b-1) * int_mb(k_range+h7b-1) * int_mb
     &(k_range+h8b-1) * int_mb(k_range+h9b-1) * int_mb(k_range+p3b-1) * 
     &int_mb(k_range+p4b-1) * int_mb(k_range+p5b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_12_5_1',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_12_5_1',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h11b_
     &1 - 1 + noab * (p10b_1 - noab - 1)))
      CALL TCE_SORT_2(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p10b-1
     &),int_mb(k_range+h11b-1),2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_12_
     &5_1',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_12_5_1',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_12_5_1',5,MA_ERR)
      IF ((p10b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p10b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h8b_2 - 
     &1 + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p10b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p5b-1),8,7,6,4,3,2,1,5,-1.0d0,.false.)
      END IF
      IF ((p3b .le. p10b) .and. (p10b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p10b_2 - noab - 1
     & + nvab * (p3b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h8b_2 - 
     &1 + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p10b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p5b-1),8,7,5,4,3,2,1,6,1.0d0,.false.)
      END IF
      IF ((p4b .le. p10b) .and. (p10b .lt. p5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p10b_2 - noab - 1 + nvab * (p4b_2 - noab - 1
     & + nvab * (p3b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h8b_2 - 
     &1 + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p10b-1
     &),int_mb(k_range+p5b-1),8,6,5,4,3,2,1,7,-1.0d0,.false.)
      END IF
      IF ((p5b .le. p10b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p10b_
     &2 - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1
     & + nvab * (p3b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h8b_2 - 
     &1 + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p10b-1),7,6,5,4,3,2,1,8,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_12_
     &5_1',6,MA_ERR)
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,1.0d0,dbl_mb
     &(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c
     &_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_12_5_1',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_12_5_1',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_12_5_1',9,MA_ERR)
      CALL TCE_SORT_8(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p3b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h7b-1),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h11b-1),7,6,5,4,8,3,2,1,1.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p5b -
     & noab - 1 + nvab * (p4b - noab - 1 + nvab * (p3b - noab - 1 + nvab
     & * (h11b - 1 + noab * (h9b - 1 + noab * (h8b - 1 + noab * (h7b - 1
     & + noab * (h6b - 1)))))))))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_12_
     &5_1',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_12_5_1',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE OFFSET_eomccsdtq_density1_5_12_5_1(l_a_offset,k_a_offse
     &t,size)
C     i3 ( h6 h7 h8 h9 h11 p3 p4 p5 )_yt
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER l_a_offset
      INTEGER k_a_offset
      INTEGER length
      INTEGER addr
      INTEGER h6b
      INTEGER h7b
      INTEGER h8b
      INTEGER h9b
      INTEGER h11b
      INTEGER p3b
      INTEGER p4b
      INTEGER p5b
      DOUBLE PRECISION size
      length = 0
      DO h6b = 1,noab
      DO h7b = h6b,noab
      DO h8b = h7b,noab
      DO h9b = h8b,noab
      DO h11b = 1,noab
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      DO p5b = p4b,noab+nvab
      IF (int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b-1)+int_mb(k_spin+h8b-1)
     &+int_mb(k_spin+h9b-1) .eq. int_mb(k_spin+h11b-1)+int_mb(k_spin+p3b
     &-1)+int_mb(k_spin+p4b-1)+int_mb(k_spin+p5b-1)) THEN
      IF (ieor(int_mb(k_sym+h6b-1),ieor(int_mb(k_sym+h7b-1),ieor(int_mb(
     &k_sym+h8b-1),ieor(int_mb(k_sym+h9b-1),ieor(int_mb(k_sym+h11b-1),ie
     &or(int_mb(k_sym+p3b-1),ieor(int_mb(k_sym+p4b-1),int_mb(k_sym+p5b-1
     &)))))))) .eq. ieor(irrep_y,irrep_t)) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b-1
     &)+int_mb(k_spin+h8b-1)+int_mb(k_spin+h9b-1)+int_mb(k_spin+h11b-1)+
     &int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1)+int_mb(k_spin+p5b-1).ne.
     &16)) THEN
      length = length + 1
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,2*length+1,'noname',l_a_offset,k_a_off
     &set)) CALL ERRQUIT('eomccsdtq_density1_5_12_5_1',0,MA_ERR)
      dbl_mb(k_a_offset) = dfloat(length)
      addr = 0
      size = 0.0d0
      DO h6b = 1,noab
      DO h7b = h6b,noab
      DO h8b = h7b,noab
      DO h9b = h8b,noab
      DO h11b = 1,noab
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      DO p5b = p4b,noab+nvab
      IF (int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b-1)+int_mb(k_spin+h8b-1)
     &+int_mb(k_spin+h9b-1) .eq. int_mb(k_spin+h11b-1)+int_mb(k_spin+p3b
     &-1)+int_mb(k_spin+p4b-1)+int_mb(k_spin+p5b-1)) THEN
      IF (ieor(int_mb(k_sym+h6b-1),ieor(int_mb(k_sym+h7b-1),ieor(int_mb(
     &k_sym+h8b-1),ieor(int_mb(k_sym+h9b-1),ieor(int_mb(k_sym+h11b-1),ie
     &or(int_mb(k_sym+p3b-1),ieor(int_mb(k_sym+p4b-1),int_mb(k_sym+p5b-1
     &)))))))) .eq. ieor(irrep_y,irrep_t)) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b-1
     &)+int_mb(k_spin+h8b-1)+int_mb(k_spin+h9b-1)+int_mb(k_spin+h11b-1)+
     &int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1)+int_mb(k_spin+p5b-1).ne.
     &16)) THEN
      addr = addr + 1
      dbl_mb(k_a_offset+addr) = dfloat(p5b - noab - 1 + nvab * (p4b - no
     &ab - 1 + nvab * (p3b - noab - 1 + nvab * (h11b - 1 + noab * (h9b -
     & 1 + noab * (h8b - 1 + noab * (h7b - 1 + noab * (h6b - 1))))))))
      dbl_mb(k_a_offset+length+addr) = size
      size = size + dfloat(int_mb(k_range+h6b-1)) * dfloat(int_mb(k_rang
     &e+h7b-1)) * dfloat(int_mb(k_range+h8b-1)) * dfloat(int_mb(k_range+
     &h9b-1)) * dfloat(int_mb(k_range+h11b-1)) * dfloat(int_mb(k_range+p
     &3b-1)) * dfloat(int_mb(k_range+p4b-1)) * dfloat(int_mb(k_range+p5b
     &-1))
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_13(d_a,k_a_offset,d_b,k_b_offset,d
     &_c,k_c_offset)
C     i1 ( p12 h11 )_yxt + = -1/12 * Sum ( h5 h6 h7 p3 p4 ) * t ( p3 p4 p12 h5 h6 h7 )_t * i2 ( h5 h6 h7 h11 p3 p4 )_yx
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER p12b
      INTEGER h11b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p3b
      INTEGER p4b
      INTEGER h5b
      INTEGER h6b
      INTEGER h7b
      INTEGER p12b_1
      INTEGER p3b_1
      INTEGER p4b_1
      INTEGER h5b_1
      INTEGER h6b_1
      INTEGER h7b_1
      INTEGER h5b_2
      INTEGER h6b_2
      INTEGER h7b_2
      INTEGER h11b_2
      INTEGER p3b_2
      INTEGER p4b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(2)
      INTEGER isuperp
      INTEGER nsubh(3)
      INTEGER isubh
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO p12b = noab+1,noab+nvab
      DO h11b = 1,noab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+p12b-1)+int_mb(k_spin+h11b
     &-1).ne.4)) THEN
      IF (int_mb(k_spin+p12b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+p12b-1),int_mb(k_sym+h11b-1)) .eq. ieor(irre
     &p_y,ieor(irrep_x,irrep_t))) THEN
      dimc = int_mb(k_range+p12b-1) * int_mb(k_range+h11b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_13',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      DO h5b = 1,noab
      DO h6b = h5b,noab
      DO h7b = h6b,noab
      IF (int_mb(k_active+p12b-1)+int_mb(k_active+p3b-1)+int_mb(k_active
     &+p4b-1) .ge. numact) THEN
      IF (int_mb(k_active+h5b-1)+int_mb(k_active+h6b-1)+int_mb(k_active+
     &h7b-1) .ge. numact) THEN
      IF (int_mb(k_spin+p12b-1)+int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1
     &) .eq. int_mb(k_spin+h5b-1)+int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b
     &-1)) THEN
      IF (ieor(int_mb(k_sym+p12b-1),ieor(int_mb(k_sym+p3b-1),ieor(int_mb
     &(k_sym+p4b-1),ieor(int_mb(k_sym+h5b-1),ieor(int_mb(k_sym+h6b-1),in
     &t_mb(k_sym+h7b-1)))))) .eq. irrep_t) THEN
      CALL TCE_RESTRICTED_6(p12b,p3b,p4b,h5b,h6b,h7b,p12b_1,p3b_1,p4b_1,
     &h5b_1,h6b_1,h7b_1)
      CALL TCE_RESTRICTED_6(h5b,h6b,h7b,h11b,p3b,p4b,h5b_2,h6b_2,h7b_2,h
     &11b_2,p3b_2,p4b_2)
      dim_common = int_mb(k_range+p3b-1) * int_mb(k_range+p4b-1) * int_m
     &b(k_range+h5b-1) * int_mb(k_range+h6b-1) * int_mb(k_range+h7b-1)
      dima_sort = int_mb(k_range+p12b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h11b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_13',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_13',2,MA_ERR)
      IF ((p4b .le. p12b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h7b_1
     & - 1 + noab * (h6b_1 - 1 + noab * (h5b_1 - 1 + noab * (p12b_1 - no
     &ab - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p12b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),3,6,5,4,2,1,1.0d0,.f
     &alse.)
      END IF
      IF ((p3b .le. p12b) .and. (p12b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h7b_1
     & - 1 + noab * (h6b_1 - 1 + noab * (h5b_1 - 1 + noab * (p4b_1 - noa
     &b - 1 + nvab * (p12b_1 - noab - 1 + nvab * (p3b_1 - noab - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p12b-1),int_mb(k_range+p4b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),2,6,5,4,3,1,-1.0d0,.
     &false.)
      END IF
      IF ((p12b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h7b_1
     & - 1 + noab * (h6b_1 - 1 + noab * (h5b_1 - 1 + noab * (p4b_1 - noa
     &b - 1 + nvab * (p3b_1 - noab - 1 + nvab * (p12b_1 - noab - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p12b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),1,6,5,4,3,2,1.0d0,.f
     &alse.)
      END IF
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_13'
     &,3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_13',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_13',5,MA_ERR)
      IF ((h11b .le. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (h11b_2 - 1 + noab
     & * (h7b_2 - 1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h11b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),4,3,2,1,6,5,1.0d0,.f
     &alse.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_13'
     &,6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      isuperp = 1
      IF (p3b .eq. p4b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      nsubh(1) = 1
      nsubh(2) = 1
      nsubh(3) = 1
      isubh = 1
      IF (h5b .eq. h6b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      IF (h6b .eq. h7b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,12.0d0/FACTO
     &RIAL(nsuperp(1))/FACTORIAL(nsuperp(2))/FACTORIAL(nsubh(1))/FACTORI
     &AL(nsubh(2))/FACTORIAL(nsubh(3)),dbl_mb(k_a_sort),dim_common,dbl_m
     &b(k_b_sort),dim_common,1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_13',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_13',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_13',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+h11b-1
     &),int_mb(k_range+p12b-1),2,1,-1.0d0/12.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(h11b 
     &- 1 + noab * (p12b - noab - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_13'
     &,10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_13',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_13_1(d_a,k_a_offset,d_b,k_b_offset
     &,d_c,k_c_offset)
C     i2 ( h5 h6 h7 h11 p3 p4 )_yx + = 1 * Sum ( p8 ) * x ( p8 h11 )_x * y ( h5 h6 h7 p3 p4 p8 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h5b
      INTEGER h6b
      INTEGER h7b
      INTEGER h11b
      INTEGER p3b
      INTEGER p4b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p8b
      INTEGER p8b_1
      INTEGER h11b_1
      INTEGER h5b_2
      INTEGER h6b_2
      INTEGER h7b_2
      INTEGER p3b_2
      INTEGER p4b_2
      INTEGER p8b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h5b = 1,noab
      DO h6b = h5b,noab
      DO h7b = h6b,noab
      DO h11b = 1,noab
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h5b-1)+int_mb(k_spin+h6b-1
     &)+int_mb(k_spin+h7b-1)+int_mb(k_spin+h11b-1)+int_mb(k_spin+p3b-1)+
     &int_mb(k_spin+p4b-1).ne.12)) THEN
      IF (int_mb(k_spin+h5b-1)+int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b-1)
     & .eq. int_mb(k_spin+h11b-1)+int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b
     &-1)) THEN
      IF (ieor(int_mb(k_sym+h5b-1),ieor(int_mb(k_sym+h6b-1),ieor(int_mb(
     &k_sym+h7b-1),ieor(int_mb(k_sym+h11b-1),ieor(int_mb(k_sym+p3b-1),in
     &t_mb(k_sym+p4b-1)))))) .eq. ieor(irrep_y,irrep_x)) THEN
      dimc = int_mb(k_range+h5b-1) * int_mb(k_range+h6b-1) * int_mb(k_ra
     &nge+h7b-1) * int_mb(k_range+h11b-1) * int_mb(k_range+p3b-1) * int_
     &mb(k_range+p4b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_13_1',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p8b = noab+1,noab+nvab
      IF (int_mb(k_active+h5b-1)+int_mb(k_active+h6b-1)+int_mb(k_active+
     &h7b-1) .ge. numact) THEN
      IF (int_mb(k_active+p3b-1)+int_mb(k_active+p4b-1)+int_mb(k_active+
     &p8b-1) .ge. numact) THEN
      IF (int_mb(k_spin+p8b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+p8b-1),int_mb(k_sym+h11b-1)) .eq. irrep_x) T
     &HEN
      CALL TCE_RESTRICTED_2(p8b,h11b,p8b_1,h11b_1)
      CALL TCE_RESTRICTED_6(h5b,h6b,h7b,p3b,p4b,p8b,h5b_2,h6b_2,h7b_2,p3
     &b_2,p4b_2,p8b_2)
      dim_common = int_mb(k_range+p8b-1)
      dima_sort = int_mb(k_range+h11b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h5b-1) * int_mb(k_range+h6b-1) * int_mb
     &(k_range+h7b-1) * int_mb(k_range+p3b-1) * int_mb(k_range+p4b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_13_1',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_13_1',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h11b_
     &1 - 1 + noab * (p8b_1 - noab - 1)))
      CALL TCE_SORT_2(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p8b-1)
     &,int_mb(k_range+h11b-1),2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_13_
     &1',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_13_1',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_13_1',5,MA_ERR)
      IF ((p8b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p8b_2 - noab - 1 
     &+ nvab * (h7b_2 - 1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+p8b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),6,5,3,2,1,4,1.0d0,.fa
     &lse.)
      END IF
      IF ((p3b .le. p8b) .and. (p8b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h7b_2 - 1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p8b-1),int_mb(k_range+p4b-1),6,4,3,2,1,5,-1.0d0,.f
     &alse.)
      END IF
      IF ((p4b .le. p8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h7b_2 - 1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p8b-1),5,4,3,2,1,6,1.0d0,.fa
     &lse.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_13_
     &1',6,MA_ERR)
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,1.0d0,dbl_mb
     &(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c
     &_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_13_1',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_13_1',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_13_1',9,MA_ERR)
      CALL TCE_SORT_6(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+h7b-1),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h11b-1),5,4,3,6,2,1,1.0d0,.f
     &alse.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p4b -
     & noab - 1 + nvab * (p3b - noab - 1 + nvab * (h11b - 1 + noab * (h7
     &b - 1 + noab * (h6b - 1 + noab * (h5b - 1)))))))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_13_
     &1',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_13_1',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE OFFSET_eomccsdtq_density1_5_13_1(l_a_offset,k_a_offset,
     &size)
C     i2 ( h5 h6 h7 h11 p3 p4 )_yx
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER l_a_offset
      INTEGER k_a_offset
      INTEGER length
      INTEGER addr
      INTEGER h5b
      INTEGER h6b
      INTEGER h7b
      INTEGER h11b
      INTEGER p3b
      INTEGER p4b
      DOUBLE PRECISION size
      length = 0
      DO h5b = 1,noab
      DO h6b = h5b,noab
      DO h7b = h6b,noab
      DO h11b = 1,noab
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      IF (int_mb(k_spin+h5b-1)+int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b-1)
     & .eq. int_mb(k_spin+h11b-1)+int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b
     &-1)) THEN
      IF (ieor(int_mb(k_sym+h5b-1),ieor(int_mb(k_sym+h6b-1),ieor(int_mb(
     &k_sym+h7b-1),ieor(int_mb(k_sym+h11b-1),ieor(int_mb(k_sym+p3b-1),in
     &t_mb(k_sym+p4b-1)))))) .eq. ieor(irrep_y,irrep_x)) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h5b-1)+int_mb(k_spin+h6b-1
     &)+int_mb(k_spin+h7b-1)+int_mb(k_spin+h11b-1)+int_mb(k_spin+p3b-1)+
     &int_mb(k_spin+p4b-1).ne.12)) THEN
      length = length + 1
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,2*length+1,'noname',l_a_offset,k_a_off
     &set)) CALL ERRQUIT('eomccsdtq_density1_5_13_1',0,MA_ERR)
      dbl_mb(k_a_offset) = dfloat(length)
      addr = 0
      size = 0.0d0
      DO h5b = 1,noab
      DO h6b = h5b,noab
      DO h7b = h6b,noab
      DO h11b = 1,noab
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      IF (int_mb(k_spin+h5b-1)+int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b-1)
     & .eq. int_mb(k_spin+h11b-1)+int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b
     &-1)) THEN
      IF (ieor(int_mb(k_sym+h5b-1),ieor(int_mb(k_sym+h6b-1),ieor(int_mb(
     &k_sym+h7b-1),ieor(int_mb(k_sym+h11b-1),ieor(int_mb(k_sym+p3b-1),in
     &t_mb(k_sym+p4b-1)))))) .eq. ieor(irrep_y,irrep_x)) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h5b-1)+int_mb(k_spin+h6b-1
     &)+int_mb(k_spin+h7b-1)+int_mb(k_spin+h11b-1)+int_mb(k_spin+p3b-1)+
     &int_mb(k_spin+p4b-1).ne.12)) THEN
      addr = addr + 1
      dbl_mb(k_a_offset+addr) = dfloat(p4b - noab - 1 + nvab * (p3b - no
     &ab - 1 + nvab * (h11b - 1 + noab * (h7b - 1 + noab * (h6b - 1 + no
     &ab * (h5b - 1))))))
      dbl_mb(k_a_offset+length+addr) = size
      size = size + dfloat(int_mb(k_range+h5b-1)) * dfloat(int_mb(k_rang
     &e+h6b-1)) * dfloat(int_mb(k_range+h7b-1)) * dfloat(int_mb(k_range+
     &h11b-1)) * dfloat(int_mb(k_range+p3b-1)) * dfloat(int_mb(k_range+p
     &4b-1))
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_13_2(d_a,k_a_offset,d_b,k_b_offset
     &,d_c,k_c_offset)
C     i2 ( h5 h6 h7 h11 p3 p4 )_yx + = -1/2 * Sum ( h10 p9 p8 ) * x ( p8 p9 h10 h11 )_x * y ( h5 h6 h7 h10 p3 p4 p8 p9 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h5b
      INTEGER h6b
      INTEGER h7b
      INTEGER h11b
      INTEGER p3b
      INTEGER p4b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p8b
      INTEGER p9b
      INTEGER h10b
      INTEGER p8b_1
      INTEGER p9b_1
      INTEGER h11b_1
      INTEGER h10b_1
      INTEGER h5b_2
      INTEGER h6b_2
      INTEGER h7b_2
      INTEGER h10b_2
      INTEGER p3b_2
      INTEGER p4b_2
      INTEGER p8b_2
      INTEGER p9b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(2)
      INTEGER isuperp
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h5b = 1,noab
      DO h6b = h5b,noab
      DO h7b = h6b,noab
      DO h11b = 1,noab
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h5b-1)+int_mb(k_spin+h6b-1
     &)+int_mb(k_spin+h7b-1)+int_mb(k_spin+h11b-1)+int_mb(k_spin+p3b-1)+
     &int_mb(k_spin+p4b-1).ne.12)) THEN
      IF (int_mb(k_spin+h5b-1)+int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b-1)
     & .eq. int_mb(k_spin+h11b-1)+int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b
     &-1)) THEN
      IF (ieor(int_mb(k_sym+h5b-1),ieor(int_mb(k_sym+h6b-1),ieor(int_mb(
     &k_sym+h7b-1),ieor(int_mb(k_sym+h11b-1),ieor(int_mb(k_sym+p3b-1),in
     &t_mb(k_sym+p4b-1)))))) .eq. ieor(irrep_y,irrep_x)) THEN
      dimc = int_mb(k_range+h5b-1) * int_mb(k_range+h6b-1) * int_mb(k_ra
     &nge+h7b-1) * int_mb(k_range+h11b-1) * int_mb(k_range+p3b-1) * int_
     &mb(k_range+p4b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_13_2',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p8b = noab+1,noab+nvab
      DO p9b = p8b,noab+nvab
      DO h10b = 1,noab
      IF (int_mb(k_active+h5b-1)+int_mb(k_active+h6b-1)+int_mb(k_active+
     &h7b-1)+int_mb(k_active+h10b-1) .ge. numacq) THEN
      IF (int_mb(k_active+p3b-1)+int_mb(k_active+p4b-1)+int_mb(k_active+
     &p8b-1)+int_mb(k_active+p9b-1) .ge. numacq) THEN
      IF (int_mb(k_spin+p8b-1)+int_mb(k_spin+p9b-1) .eq. int_mb(k_spin+h
     &11b-1)+int_mb(k_spin+h10b-1)) THEN
      IF (ieor(int_mb(k_sym+p8b-1),ieor(int_mb(k_sym+p9b-1),ieor(int_mb(
     &k_sym+h11b-1),int_mb(k_sym+h10b-1)))) .eq. irrep_x) THEN
      CALL TCE_RESTRICTED_4(p8b,p9b,h11b,h10b,p8b_1,p9b_1,h11b_1,h10b_1)
      CALL TCE_RESTRICTED_8(h5b,h6b,h7b,h10b,p3b,p4b,p8b,p9b,h5b_2,h6b_2
     &,h7b_2,h10b_2,p3b_2,p4b_2,p8b_2,p9b_2)
      dim_common = int_mb(k_range+p8b-1) * int_mb(k_range+p9b-1) * int_m
     &b(k_range+h10b-1)
      dima_sort = int_mb(k_range+h11b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h5b-1) * int_mb(k_range+h6b-1) * int_mb
     &(k_range+h7b-1) * int_mb(k_range+p3b-1) * int_mb(k_range+p4b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_13_2',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_13_2',2,MA_ERR)
      IF ((h10b .le. h11b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h11b_
     &1 - 1 + noab * (h10b_1 - 1 + noab * (p9b_1 - noab - 1 + nvab * (p8
     &b_1 - noab - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p8b-1)
     &,int_mb(k_range+p9b-1),int_mb(k_range+h10b-1),int_mb(k_range+h11b-
     &1),4,3,2,1,1.0d0,.false.)
      END IF
      IF ((h11b .lt. h10b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h10b_
     &1 - 1 + noab * (h11b_1 - 1 + noab * (p9b_1 - noab - 1 + nvab * (p8
     &b_1 - noab - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p8b-1)
     &,int_mb(k_range+p9b-1),int_mb(k_range+h11b-1),int_mb(k_range+h10b-
     &1),3,4,2,1,-1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_13_
     &2',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_13_2',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_13_2',5,MA_ERR)
      IF ((h10b .lt. h5b) .and. (p9b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p9b_2 - noab - 1 
     &+ nvab * (p8b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 1
     & + noab * (h5b_2 - 1 + noab * (h10b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h10b-1
     &),int_mb(k_range+h5b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p8b-1),int_mb(k_range+p9b-1),int_mb(k_range+p3b-1
     &),int_mb(k_range+p4b-1),8,7,4,3,2,1,6,5,-1.0d0,.false.)
      END IF
      IF ((h10b .lt. h5b) .and. (p8b .lt. p3b) .and. (p3b .le. p9b) .and
     &. (p9b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p9b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p8b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 1
     & + noab * (h5b_2 - 1 + noab * (h10b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h10b-1
     &),int_mb(k_range+h5b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p8b-1),int_mb(k_range+p3b-1),int_mb(k_range+p9b-1
     &),int_mb(k_range+p4b-1),8,6,4,3,2,1,7,5,1.0d0,.false.)
      END IF
      IF ((h10b .lt. h5b) .and. (p8b .lt. p3b) .and. (p4b .le. p9b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p9b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p8b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 1
     & + noab * (h5b_2 - 1 + noab * (h10b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h10b-1
     &),int_mb(k_range+h5b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p8b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p9b-1),7,6,4,3,2,1,8,5,-1.0d0,.false.)
      END IF
      IF ((h10b .lt. h5b) .and. (p3b .le. p8b) .and. (p9b .lt. p4b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p9b_2 - noab - 1 + nvab * (p8b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 1
     & + noab * (h5b_2 - 1 + noab * (h10b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h10b-1
     &),int_mb(k_range+h5b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p8b-1),int_mb(k_range+p9b-1
     &),int_mb(k_range+p4b-1),8,5,4,3,2,1,7,6,-1.0d0,.false.)
      END IF
      IF ((h10b .lt. h5b) .and. (p3b .le. p8b) .and. (p8b .lt. p4b) .and
     &. (p4b .le. p9b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p9b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p8b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 1
     & + noab * (h5b_2 - 1 + noab * (h10b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h10b-1
     &),int_mb(k_range+h5b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p8b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p9b-1),7,5,4,3,2,1,8,6,1.0d0,.false.)
      END IF
      IF ((h10b .lt. h5b) .and. (p4b .le. p8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p9b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 1
     & + noab * (h5b_2 - 1 + noab * (h10b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h10b-1
     &),int_mb(k_range+h5b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p8b-1
     &),int_mb(k_range+p9b-1),6,5,4,3,2,1,8,7,-1.0d0,.false.)
      END IF
      IF ((h5b .le. h10b) .and. (h10b .lt. h6b) .and. (p9b .lt. p3b)) TH
     &EN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p9b_2 - noab - 1 
     &+ nvab * (p8b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 1
     & + noab * (h10b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h10b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p8b-1),int_mb(k_range+p9b-1),int_mb(k_range+p3b-1
     &),int_mb(k_range+p4b-1),8,7,4,3,1,2,6,5,1.0d0,.false.)
      END IF
      IF ((h5b .le. h10b) .and. (h10b .lt. h6b) .and. (p8b .lt. p3b) .an
     &d. (p3b .le. p9b) .and. (p9b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p9b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p8b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 1
     & + noab * (h10b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h10b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p8b-1),int_mb(k_range+p3b-1),int_mb(k_range+p9b-1
     &),int_mb(k_range+p4b-1),8,6,4,3,1,2,7,5,-1.0d0,.false.)
      END IF
      IF ((h5b .le. h10b) .and. (h10b .lt. h6b) .and. (p8b .lt. p3b) .an
     &d. (p4b .le. p9b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p9b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p8b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 1
     & + noab * (h10b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h10b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p8b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p9b-1),7,6,4,3,1,2,8,5,1.0d0,.false.)
      END IF
      IF ((h5b .le. h10b) .and. (h10b .lt. h6b) .and. (p3b .le. p8b) .an
     &d. (p9b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p9b_2 - noab - 1 + nvab * (p8b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 1
     & + noab * (h10b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h10b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p8b-1),int_mb(k_range+p9b-1
     &),int_mb(k_range+p4b-1),8,5,4,3,1,2,7,6,1.0d0,.false.)
      END IF
      IF ((h5b .le. h10b) .and. (h10b .lt. h6b) .and. (p3b .le. p8b) .an
     &d. (p8b .lt. p4b) .and. (p4b .le. p9b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p9b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p8b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 1
     & + noab * (h10b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h10b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p8b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p9b-1),7,5,4,3,1,2,8,6,-1.0d0,.false.)
      END IF
      IF ((h5b .le. h10b) .and. (h10b .lt. h6b) .and. (p4b .le. p8b)) TH
     &EN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p9b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 1
     & + noab * (h10b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h10b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p8b-1
     &),int_mb(k_range+p9b-1),6,5,4,3,1,2,8,7,1.0d0,.false.)
      END IF
      IF ((h6b .le. h10b) .and. (h10b .lt. h7b) .and. (p9b .lt. p3b)) TH
     &EN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p9b_2 - noab - 1 
     &+ nvab * (p8b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h10b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p8b-1),int_mb(k_range+p9b-1),int_mb(k_range+p3b-1
     &),int_mb(k_range+p4b-1),8,7,4,2,1,3,6,5,-1.0d0,.false.)
      END IF
      IF ((h6b .le. h10b) .and. (h10b .lt. h7b) .and. (p8b .lt. p3b) .an
     &d. (p3b .le. p9b) .and. (p9b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p9b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p8b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h10b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p8b-1),int_mb(k_range+p3b-1),int_mb(k_range+p9b-1
     &),int_mb(k_range+p4b-1),8,6,4,2,1,3,7,5,1.0d0,.false.)
      END IF
      IF ((h6b .le. h10b) .and. (h10b .lt. h7b) .and. (p8b .lt. p3b) .an
     &d. (p4b .le. p9b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p9b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p8b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h10b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p8b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p9b-1),7,6,4,2,1,3,8,5,-1.0d0,.false.)
      END IF
      IF ((h6b .le. h10b) .and. (h10b .lt. h7b) .and. (p3b .le. p8b) .an
     &d. (p9b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p9b_2 - noab - 1 + nvab * (p8b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h10b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p8b-1),int_mb(k_range+p9b-1
     &),int_mb(k_range+p4b-1),8,5,4,2,1,3,7,6,-1.0d0,.false.)
      END IF
      IF ((h6b .le. h10b) .and. (h10b .lt. h7b) .and. (p3b .le. p8b) .an
     &d. (p8b .lt. p4b) .and. (p4b .le. p9b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p9b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p8b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h10b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p8b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p9b-1),7,5,4,2,1,3,8,6,1.0d0,.false.)
      END IF
      IF ((h6b .le. h10b) .and. (h10b .lt. h7b) .and. (p4b .le. p8b)) TH
     &EN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p9b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h10b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p8b-1
     &),int_mb(k_range+p9b-1),6,5,4,2,1,3,8,7,-1.0d0,.false.)
      END IF
      IF ((h7b .le. h10b) .and. (p9b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p9b_2 - noab - 1 
     &+ nvab * (p8b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h7b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p8b-1),int_mb(k_range+p9b-1),int_mb(k_range+p3b-1
     &),int_mb(k_range+p4b-1),8,7,3,2,1,4,6,5,1.0d0,.false.)
      END IF
      IF ((h7b .le. h10b) .and. (p8b .lt. p3b) .and. (p3b .le. p9b) .and
     &. (p9b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p9b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p8b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h7b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p8b-1),int_mb(k_range+p3b-1),int_mb(k_range+p9b-1
     &),int_mb(k_range+p4b-1),8,6,3,2,1,4,7,5,-1.0d0,.false.)
      END IF
      IF ((h7b .le. h10b) .and. (p8b .lt. p3b) .and. (p4b .le. p9b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p9b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p8b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h7b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p8b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p9b-1),7,6,3,2,1,4,8,5,1.0d0,.false.)
      END IF
      IF ((h7b .le. h10b) .and. (p3b .le. p8b) .and. (p9b .lt. p4b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p9b_2 - noab - 1 + nvab * (p8b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h7b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p8b-1),int_mb(k_range+p9b-1
     &),int_mb(k_range+p4b-1),8,5,3,2,1,4,7,6,1.0d0,.false.)
      END IF
      IF ((h7b .le. h10b) .and. (p3b .le. p8b) .and. (p8b .lt. p4b) .and
     &. (p4b .le. p9b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p9b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p8b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h7b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p8b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p9b-1),7,5,3,2,1,4,8,6,-1.0d0,.false.)
      END IF
      IF ((h7b .le. h10b) .and. (p4b .le. p8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p9b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h7b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p8b-1
     &),int_mb(k_range+p9b-1),6,5,3,2,1,4,8,7,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_13_
     &2',6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      isuperp = 1
      IF (p8b .eq. p9b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,2.0d0/FACTOR
     &IAL(nsuperp(1))/FACTORIAL(nsuperp(2)),dbl_mb(k_a_sort),dim_common,
     &dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_13_2',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_13_2',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_13_2',9,MA_ERR)
      CALL TCE_SORT_6(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+h7b-1),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h11b-1),5,4,3,6,2,1,-1.0d0/2
     &.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p4b -
     & noab - 1 + nvab * (p3b - noab - 1 + nvab * (h11b - 1 + noab * (h7
     &b - 1 + noab * (h6b - 1 + noab * (h5b - 1)))))))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_13_
     &2',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_13_2',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_14(d_a,k_a_offset,d_b,k_b_offset,d
     &_c,k_c_offset)
C     i1 ( p12 h11 )_yxt + = 1/4 * Sum ( h5 h6 p3 p4 ) * t ( p3 p4 p12 h5 h6 h11 )_t * i2 ( h5 h6 p3 p4 )_yx
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER p12b
      INTEGER h11b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p3b
      INTEGER p4b
      INTEGER h5b
      INTEGER h6b
      INTEGER p12b_1
      INTEGER p3b_1
      INTEGER p4b_1
      INTEGER h11b_1
      INTEGER h5b_1
      INTEGER h6b_1
      INTEGER h5b_2
      INTEGER h6b_2
      INTEGER p3b_2
      INTEGER p4b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(2)
      INTEGER isuperp
      INTEGER nsubh(2)
      INTEGER isubh
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO p12b = noab+1,noab+nvab
      DO h11b = 1,noab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+p12b-1)+int_mb(k_spin+h11b
     &-1).ne.4)) THEN
      IF (int_mb(k_spin+p12b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+p12b-1),int_mb(k_sym+h11b-1)) .eq. ieor(irre
     &p_y,ieor(irrep_x,irrep_t))) THEN
      dimc = int_mb(k_range+p12b-1) * int_mb(k_range+h11b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_14',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      DO h5b = 1,noab
      DO h6b = h5b,noab
      IF (int_mb(k_active+p12b-1)+int_mb(k_active+p3b-1)+int_mb(k_active
     &+p4b-1) .ge. numact) THEN
      IF (int_mb(k_active+h11b-1)+int_mb(k_active+h5b-1)+int_mb(k_active
     &+h6b-1) .ge. numact) THEN
      IF (int_mb(k_spin+p12b-1)+int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1
     &) .eq. int_mb(k_spin+h11b-1)+int_mb(k_spin+h5b-1)+int_mb(k_spin+h6
     &b-1)) THEN
      IF (ieor(int_mb(k_sym+p12b-1),ieor(int_mb(k_sym+p3b-1),ieor(int_mb
     &(k_sym+p4b-1),ieor(int_mb(k_sym+h11b-1),ieor(int_mb(k_sym+h5b-1),i
     &nt_mb(k_sym+h6b-1)))))) .eq. irrep_t) THEN
      CALL TCE_RESTRICTED_6(p12b,p3b,p4b,h11b,h5b,h6b,p12b_1,p3b_1,p4b_1
     &,h11b_1,h5b_1,h6b_1)
      CALL TCE_RESTRICTED_4(h5b,h6b,p3b,p4b,h5b_2,h6b_2,p3b_2,p4b_2)
      dim_common = int_mb(k_range+p3b-1) * int_mb(k_range+p4b-1) * int_m
     &b(k_range+h5b-1) * int_mb(k_range+h6b-1)
      dima_sort = int_mb(k_range+p12b-1) * int_mb(k_range+h11b-1)
      dima = dim_common * dima_sort
      dimb_sort = 1
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_14',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_14',2,MA_ERR)
      IF ((p4b .le. p12b) .and. (h6b .le. h11b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h11b_
     &1 - 1 + noab * (h6b_1 - 1 + noab * (h5b_1 - 1 + noab * (p12b_1 - n
     &oab - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))
     &))
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p12b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h11b-1),6,3,5,4,2,1,1.0d0,.
     &false.)
      END IF
      IF ((p4b .le. p12b) .and. (h5b .le. h11b) .and. (h11b .lt. h6b)) T
     &HEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h6b_1
     & - 1 + noab * (h11b_1 - 1 + noab * (h5b_1 - 1 + noab * (p12b_1 - n
     &oab - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))
     &))
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p12b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+h11b-1),int_mb(k_range+h6b-1),5,3,6,4,2,1,-1.0d0,
     &.false.)
      END IF
      IF ((p4b .le. p12b) .and. (h11b .lt. h5b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h6b_1
     & - 1 + noab * (h5b_1 - 1 + noab * (h11b_1 - 1 + noab * (p12b_1 - n
     &oab - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))
     &))
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p12b-1),int_mb(k_range+h11b-
     &1),int_mb(k_range+h5b-1),int_mb(k_range+h6b-1),4,3,6,5,2,1,1.0d0,.
     &false.)
      END IF
      IF ((p3b .le. p12b) .and. (p12b .lt. p4b) .and. (h6b .le. h11b)) T
     &HEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h11b_
     &1 - 1 + noab * (h6b_1 - 1 + noab * (h5b_1 - 1 + noab * (p4b_1 - no
     &ab - 1 + nvab * (p12b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))
     &))
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p12b-1),int_mb(k_range+p4b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h11b-1),6,2,5,4,3,1,-1.0d0,
     &.false.)
      END IF
      IF ((p3b .le. p12b) .and. (p12b .lt. p4b) .and. (h5b .le. h11b) .a
     &nd. (h11b .lt. h6b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h6b_1
     & - 1 + noab * (h11b_1 - 1 + noab * (h5b_1 - 1 + noab * (p4b_1 - no
     &ab - 1 + nvab * (p12b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))
     &))
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p12b-1),int_mb(k_range+p4b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+h11b-1),int_mb(k_range+h6b-1),5,2,6,4,3,1,1.0d0,.
     &false.)
      END IF
      IF ((p3b .le. p12b) .and. (p12b .lt. p4b) .and. (h11b .lt. h5b)) T
     &HEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h6b_1
     & - 1 + noab * (h5b_1 - 1 + noab * (h11b_1 - 1 + noab * (p4b_1 - no
     &ab - 1 + nvab * (p12b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))
     &))
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p12b-1),int_mb(k_range+p4b-1),int_mb(k_range+h11b-
     &1),int_mb(k_range+h5b-1),int_mb(k_range+h6b-1),4,2,6,5,3,1,-1.0d0,
     &.false.)
      END IF
      IF ((p12b .lt. p3b) .and. (h6b .le. h11b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h11b_
     &1 - 1 + noab * (h6b_1 - 1 + noab * (h5b_1 - 1 + noab * (p4b_1 - no
     &ab - 1 + nvab * (p3b_1 - noab - 1 + nvab * (p12b_1 - noab - 1)))))
     &))
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p12b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h11b-1),6,1,5,4,3,2,1.0d0,.
     &false.)
      END IF
      IF ((p12b .lt. p3b) .and. (h5b .le. h11b) .and. (h11b .lt. h6b)) T
     &HEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h6b_1
     & - 1 + noab * (h11b_1 - 1 + noab * (h5b_1 - 1 + noab * (p4b_1 - no
     &ab - 1 + nvab * (p3b_1 - noab - 1 + nvab * (p12b_1 - noab - 1)))))
     &))
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p12b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+h11b-1),int_mb(k_range+h6b-1),5,1,6,4,3,2,-1.0d0,
     &.false.)
      END IF
      IF ((p12b .lt. p3b) .and. (h11b .lt. h5b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h6b_1
     & - 1 + noab * (h5b_1 - 1 + noab * (h11b_1 - 1 + noab * (p4b_1 - no
     &ab - 1 + nvab * (p3b_1 - noab - 1 + nvab * (p12b_1 - noab - 1)))))
     &))
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p12b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+h11b-
     &1),int_mb(k_range+h5b-1),int_mb(k_range+h6b-1),4,1,6,5,3,2,1.0d0,.
     &false.)
      END IF
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_14'
     &,3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_14',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_14',5,MA_ERR)
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (h6b_2 - 1 + noab 
     &* (h5b_2 - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1)
     &,2,1,4,3,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_14'
     &,6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      isuperp = 1
      IF (p3b .eq. p4b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      nsubh(1) = 1
      nsubh(2) = 1
      isubh = 1
      IF (h5b .eq. h6b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,4.0d0/FACTOR
     &IAL(nsuperp(1))/FACTORIAL(nsuperp(2))/FACTORIAL(nsubh(1))/FACTORIA
     &L(nsubh(2)),dbl_mb(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_commo
     &n,1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_14',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_14',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_14',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+h11b-1
     &),int_mb(k_range+p12b-1),2,1,1.0d0/4.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(h11b 
     &- 1 + noab * (p12b - noab - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_14'
     &,10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_14',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_14_1(d_a,k_a_offset,d_b,k_b_offset
     &,d_c,k_c_offset)
C     i2 ( h5 h6 p3 p4 )_yx + = 1 * Sum ( h8 p7 ) * x ( p7 h8 )_x * y ( h5 h6 h8 p3 p4 p7 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h5b
      INTEGER h6b
      INTEGER p3b
      INTEGER p4b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p7b
      INTEGER h8b
      INTEGER p7b_1
      INTEGER h8b_1
      INTEGER h5b_2
      INTEGER h6b_2
      INTEGER h8b_2
      INTEGER p3b_2
      INTEGER p4b_2
      INTEGER p7b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h5b = 1,noab
      DO h6b = h5b,noab
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h5b-1)+int_mb(k_spin+h6b-1
     &)+int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1).ne.8)) THEN
      IF (int_mb(k_spin+h5b-1)+int_mb(k_spin+h6b-1) .eq. int_mb(k_spin+p
     &3b-1)+int_mb(k_spin+p4b-1)) THEN
      IF (ieor(int_mb(k_sym+h5b-1),ieor(int_mb(k_sym+h6b-1),ieor(int_mb(
     &k_sym+p3b-1),int_mb(k_sym+p4b-1)))) .eq. ieor(irrep_y,irrep_x)) TH
     &EN
      dimc = int_mb(k_range+h5b-1) * int_mb(k_range+h6b-1) * int_mb(k_ra
     &nge+p3b-1) * int_mb(k_range+p4b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_14_1',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p7b = noab+1,noab+nvab
      DO h8b = 1,noab
      IF (int_mb(k_active+h5b-1)+int_mb(k_active+h6b-1)+int_mb(k_active+
     &h8b-1) .ge. numact) THEN
      IF (int_mb(k_active+p3b-1)+int_mb(k_active+p4b-1)+int_mb(k_active+
     &p7b-1) .ge. numact) THEN
      IF (int_mb(k_spin+p7b-1) .eq. int_mb(k_spin+h8b-1)) THEN
      IF (ieor(int_mb(k_sym+p7b-1),int_mb(k_sym+h8b-1)) .eq. irrep_x) TH
     &EN
      CALL TCE_RESTRICTED_2(p7b,h8b,p7b_1,h8b_1)
      CALL TCE_RESTRICTED_6(h5b,h6b,h8b,p3b,p4b,p7b,h5b_2,h6b_2,h8b_2,p3
     &b_2,p4b_2,p7b_2)
      dim_common = int_mb(k_range+p7b-1) * int_mb(k_range+h8b-1)
      dima_sort = 1
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h5b-1) * int_mb(k_range+h6b-1) * int_mb
     &(k_range+p3b-1) * int_mb(k_range+p4b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_14_1',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_14_1',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h8b_1
     & - 1 + noab * (p7b_1 - noab - 1)))
      CALL TCE_SORT_2(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p7b-1)
     &,int_mb(k_range+h8b-1),2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_14_
     &1',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_14_1',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_14_1',5,MA_ERR)
      IF ((h8b .lt. h5b) .and. (p7b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p7b_2 - noab - 1 
     &+ nvab * (h6b_2 - 1 + noab * (h5b_2 - 1 + noab * (h8b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h6b-1),int_mb(k_range+p7b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),6,5,3,2,1,4,1.0d0,.fa
     &lse.)
      END IF
      IF ((h8b .lt. h5b) .and. (p3b .le. p7b) .and. (p7b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h6b_2 - 1 + noab * (h5b_2 - 1 + noab * (h8b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h6b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p7b-1),int_mb(k_range+p4b-1),6,4,3,2,1,5,-1.0d0,.f
     &alse.)
      END IF
      IF ((h8b .lt. h5b) .and. (p4b .le. p7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h6b_2 - 1 + noab * (h5b_2 - 1 + noab * (h8b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h6b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p7b-1),5,4,3,2,1,6,1.0d0,.fa
     &lse.)
      END IF
      IF ((h5b .le. h8b) .and. (h8b .lt. h6b) .and. (p7b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p7b_2 - noab - 1 
     &+ nvab * (h6b_2 - 1 + noab * (h8b_2 - 1 + noab * (h5b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h6b-1),int_mb(k_range+p7b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),6,5,3,1,2,4,-1.0d0,.f
     &alse.)
      END IF
      IF ((h5b .le. h8b) .and. (h8b .lt. h6b) .and. (p3b .le. p7b) .and.
     & (p7b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h6b_2 - 1 + noab * (h8b_2 - 1 + noab * (h5b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h6b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p7b-1),int_mb(k_range+p4b-1),6,4,3,1,2,5,1.0d0,.fa
     &lse.)
      END IF
      IF ((h5b .le. h8b) .and. (h8b .lt. h6b) .and. (p4b .le. p7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h6b_2 - 1 + noab * (h8b_2 - 1 + noab * (h5b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h6b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p7b-1),5,4,3,1,2,6,-1.0d0,.f
     &alse.)
      END IF
      IF ((h6b .le. h8b) .and. (p7b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p7b_2 - noab - 1 
     &+ nvab * (h8b_2 - 1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h8b-1),int_mb(k_range+p7b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),6,5,2,1,3,4,1.0d0,.fa
     &lse.)
      END IF
      IF ((h6b .le. h8b) .and. (p3b .le. p7b) .and. (p7b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h8b_2 - 1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h8b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p7b-1),int_mb(k_range+p4b-1),6,4,2,1,3,5,-1.0d0,.f
     &alse.)
      END IF
      IF ((h6b .le. h8b) .and. (p4b .le. p7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h8b_2 - 1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h8b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p7b-1),5,4,2,1,3,6,1.0d0,.fa
     &lse.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_14_
     &1',6,MA_ERR)
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,1.0d0,dbl_mb
     &(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c
     &_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_14_1',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_14_1',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_14_1',9,MA_ERR)
      CALL TCE_SORT_4(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+h6b-1),int_mb(k_range+h5b-1)
     &,4,3,2,1,1.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p4b -
     & noab - 1 + nvab * (p3b - noab - 1 + nvab * (h6b - 1 + noab * (h5b
     & - 1)))))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_14_
     &1',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_14_1',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE OFFSET_eomccsdtq_density1_5_14_1(l_a_offset,k_a_offset,
     &size)
C     i2 ( h5 h6 p3 p4 )_yx
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER l_a_offset
      INTEGER k_a_offset
      INTEGER length
      INTEGER addr
      INTEGER h5b
      INTEGER h6b
      INTEGER p3b
      INTEGER p4b
      DOUBLE PRECISION size
      length = 0
      DO h5b = 1,noab
      DO h6b = h5b,noab
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      IF (int_mb(k_spin+h5b-1)+int_mb(k_spin+h6b-1) .eq. int_mb(k_spin+p
     &3b-1)+int_mb(k_spin+p4b-1)) THEN
      IF (ieor(int_mb(k_sym+h5b-1),ieor(int_mb(k_sym+h6b-1),ieor(int_mb(
     &k_sym+p3b-1),int_mb(k_sym+p4b-1)))) .eq. ieor(irrep_y,irrep_x)) TH
     &EN
      IF ((.not.restricted).or.(int_mb(k_spin+h5b-1)+int_mb(k_spin+h6b-1
     &)+int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1).ne.8)) THEN
      length = length + 1
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,2*length+1,'noname',l_a_offset,k_a_off
     &set)) CALL ERRQUIT('eomccsdtq_density1_5_14_1',0,MA_ERR)
      dbl_mb(k_a_offset) = dfloat(length)
      addr = 0
      size = 0.0d0
      DO h5b = 1,noab
      DO h6b = h5b,noab
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      IF (int_mb(k_spin+h5b-1)+int_mb(k_spin+h6b-1) .eq. int_mb(k_spin+p
     &3b-1)+int_mb(k_spin+p4b-1)) THEN
      IF (ieor(int_mb(k_sym+h5b-1),ieor(int_mb(k_sym+h6b-1),ieor(int_mb(
     &k_sym+p3b-1),int_mb(k_sym+p4b-1)))) .eq. ieor(irrep_y,irrep_x)) TH
     &EN
      IF ((.not.restricted).or.(int_mb(k_spin+h5b-1)+int_mb(k_spin+h6b-1
     &)+int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1).ne.8)) THEN
      addr = addr + 1
      dbl_mb(k_a_offset+addr) = dfloat(p4b - noab - 1 + nvab * (p3b - no
     &ab - 1 + nvab * (h6b - 1 + noab * (h5b - 1))))
      dbl_mb(k_a_offset+length+addr) = size
      size = size + dfloat(int_mb(k_range+h5b-1)) * dfloat(int_mb(k_rang
     &e+h6b-1)) * dfloat(int_mb(k_range+p3b-1)) * dfloat(int_mb(k_range+
     &p4b-1))
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_14_2(d_a,k_a_offset,d_b,k_b_offset
     &,d_c,k_c_offset)
C     i2 ( h5 h6 p3 p4 )_yx + = 1/4 * Sum ( h10 h9 p8 p7 ) * x ( p7 p8 h9 h10 )_x * y ( h5 h6 h9 h10 p3 p4 p7 p8 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h5b
      INTEGER h6b
      INTEGER p3b
      INTEGER p4b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p7b
      INTEGER p8b
      INTEGER h9b
      INTEGER h10b
      INTEGER p7b_1
      INTEGER p8b_1
      INTEGER h9b_1
      INTEGER h10b_1
      INTEGER h5b_2
      INTEGER h6b_2
      INTEGER h9b_2
      INTEGER h10b_2
      INTEGER p3b_2
      INTEGER p4b_2
      INTEGER p7b_2
      INTEGER p8b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(2)
      INTEGER isuperp
      INTEGER nsubh(2)
      INTEGER isubh
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h5b = 1,noab
      DO h6b = h5b,noab
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h5b-1)+int_mb(k_spin+h6b-1
     &)+int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1).ne.8)) THEN
      IF (int_mb(k_spin+h5b-1)+int_mb(k_spin+h6b-1) .eq. int_mb(k_spin+p
     &3b-1)+int_mb(k_spin+p4b-1)) THEN
      IF (ieor(int_mb(k_sym+h5b-1),ieor(int_mb(k_sym+h6b-1),ieor(int_mb(
     &k_sym+p3b-1),int_mb(k_sym+p4b-1)))) .eq. ieor(irrep_y,irrep_x)) TH
     &EN
      dimc = int_mb(k_range+h5b-1) * int_mb(k_range+h6b-1) * int_mb(k_ra
     &nge+p3b-1) * int_mb(k_range+p4b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_14_2',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p7b = noab+1,noab+nvab
      DO p8b = p7b,noab+nvab
      DO h9b = 1,noab
      DO h10b = h9b,noab
      IF (int_mb(k_active+h5b-1)+int_mb(k_active+h6b-1)+int_mb(k_active+
     &h9b-1)+int_mb(k_active+h10b-1) .ge. numacq) THEN
      IF (int_mb(k_active+p3b-1)+int_mb(k_active+p4b-1)+int_mb(k_active+
     &p7b-1)+int_mb(k_active+p8b-1) .ge. numacq) THEN
      IF (int_mb(k_spin+p7b-1)+int_mb(k_spin+p8b-1) .eq. int_mb(k_spin+h
     &9b-1)+int_mb(k_spin+h10b-1)) THEN
      IF (ieor(int_mb(k_sym+p7b-1),ieor(int_mb(k_sym+p8b-1),ieor(int_mb(
     &k_sym+h9b-1),int_mb(k_sym+h10b-1)))) .eq. irrep_x) THEN
      CALL TCE_RESTRICTED_4(p7b,p8b,h9b,h10b,p7b_1,p8b_1,h9b_1,h10b_1)
      CALL TCE_RESTRICTED_8(h5b,h6b,h9b,h10b,p3b,p4b,p7b,p8b,h5b_2,h6b_2
     &,h9b_2,h10b_2,p3b_2,p4b_2,p7b_2,p8b_2)
      dim_common = int_mb(k_range+p7b-1) * int_mb(k_range+p8b-1) * int_m
     &b(k_range+h9b-1) * int_mb(k_range+h10b-1)
      dima_sort = 1
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h5b-1) * int_mb(k_range+h6b-1) * int_mb
     &(k_range+p3b-1) * int_mb(k_range+p4b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_14_2',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_14_2',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h10b_
     &1 - 1 + noab * (h9b_1 - 1 + noab * (p8b_1 - noab - 1 + nvab * (p7b
     &_1 - noab - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p7b-1)
     &,int_mb(k_range+p8b-1),int_mb(k_range+h9b-1),int_mb(k_range+h10b-1
     &),4,3,2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_14_
     &2',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_14_2',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_14_2',5,MA_ERR)
      IF ((h10b .lt. h5b) .and. (p8b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p8b_2 - noab - 1 
     &+ nvab * (p7b_2 - noab - 1 + nvab * (h6b_2 - 1 + noab * (h5b_2 - 1
     & + noab * (h10b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h10b-1),int_mb(k_range+h5b-1),int_mb(k_range+h6b-1
     &),int_mb(k_range+p7b-1),int_mb(k_range+p8b-1),int_mb(k_range+p3b-1
     &),int_mb(k_range+p4b-1),8,7,4,3,2,1,6,5,1.0d0,.false.)
      END IF
      IF ((h10b .lt. h5b) .and. (p7b .lt. p3b) .and. (p3b .le. p8b) .and
     &. (p8b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p7b_2 - noab - 1 + nvab * (h6b_2 - 1 + noab * (h5b_2 - 1
     & + noab * (h10b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h10b-1),int_mb(k_range+h5b-1),int_mb(k_range+h6b-1
     &),int_mb(k_range+p7b-1),int_mb(k_range+p3b-1),int_mb(k_range+p8b-1
     &),int_mb(k_range+p4b-1),8,6,4,3,2,1,7,5,-1.0d0,.false.)
      END IF
      IF ((h10b .lt. h5b) .and. (p7b .lt. p3b) .and. (p4b .le. p8b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p7b_2 - noab - 1 + nvab * (h6b_2 - 1 + noab * (h5b_2 - 1
     & + noab * (h10b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h10b-1),int_mb(k_range+h5b-1),int_mb(k_range+h6b-1
     &),int_mb(k_range+p7b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p8b-1),7,6,4,3,2,1,8,5,1.0d0,.false.)
      END IF
      IF ((h10b .lt. h5b) .and. (p3b .le. p7b) .and. (p8b .lt. p4b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p7b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h6b_2 - 1 + noab * (h5b_2 - 1
     & + noab * (h10b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h10b-1),int_mb(k_range+h5b-1),int_mb(k_range+h6b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p7b-1),int_mb(k_range+p8b-1
     &),int_mb(k_range+p4b-1),8,5,4,3,2,1,7,6,1.0d0,.false.)
      END IF
      IF ((h10b .lt. h5b) .and. (p3b .le. p7b) .and. (p7b .lt. p4b) .and
     &. (p4b .le. p8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p7b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h6b_2 - 1 + noab * (h5b_2 - 1
     & + noab * (h10b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h10b-1),int_mb(k_range+h5b-1),int_mb(k_range+h6b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p7b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p8b-1),7,5,4,3,2,1,8,6,-1.0d0,.false.)
      END IF
      IF ((h10b .lt. h5b) .and. (p4b .le. p7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h6b_2 - 1 + noab * (h5b_2 - 1
     & + noab * (h10b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h10b-1),int_mb(k_range+h5b-1),int_mb(k_range+h6b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p7b-1
     &),int_mb(k_range+p8b-1),6,5,4,3,2,1,8,7,1.0d0,.false.)
      END IF
      IF ((h9b .lt. h5b) .and. (h5b .le. h10b) .and. (h10b .lt. h6b) .an
     &d. (p8b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p8b_2 - noab - 1 
     &+ nvab * (p7b_2 - noab - 1 + nvab * (h6b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h5b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h10b-1),int_mb(k_range+h6b-1
     &),int_mb(k_range+p7b-1),int_mb(k_range+p8b-1),int_mb(k_range+p3b-1
     &),int_mb(k_range+p4b-1),8,7,4,2,3,1,6,5,-1.0d0,.false.)
      END IF
      IF ((h9b .lt. h5b) .and. (h5b .le. h10b) .and. (h10b .lt. h6b) .an
     &d. (p7b .lt. p3b) .and. (p3b .le. p8b) .and. (p8b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p7b_2 - noab - 1 + nvab * (h6b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h5b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h10b-1),int_mb(k_range+h6b-1
     &),int_mb(k_range+p7b-1),int_mb(k_range+p3b-1),int_mb(k_range+p8b-1
     &),int_mb(k_range+p4b-1),8,6,4,2,3,1,7,5,1.0d0,.false.)
      END IF
      IF ((h9b .lt. h5b) .and. (h5b .le. h10b) .and. (h10b .lt. h6b) .an
     &d. (p7b .lt. p3b) .and. (p4b .le. p8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p7b_2 - noab - 1 + nvab * (h6b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h5b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h10b-1),int_mb(k_range+h6b-1
     &),int_mb(k_range+p7b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p8b-1),7,6,4,2,3,1,8,5,-1.0d0,.false.)
      END IF
      IF ((h9b .lt. h5b) .and. (h5b .le. h10b) .and. (h10b .lt. h6b) .an
     &d. (p3b .le. p7b) .and. (p8b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p7b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h6b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h5b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h10b-1),int_mb(k_range+h6b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p7b-1),int_mb(k_range+p8b-1
     &),int_mb(k_range+p4b-1),8,5,4,2,3,1,7,6,-1.0d0,.false.)
      END IF
      IF ((h9b .lt. h5b) .and. (h5b .le. h10b) .and. (h10b .lt. h6b) .an
     &d. (p3b .le. p7b) .and. (p7b .lt. p4b) .and. (p4b .le. p8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p7b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h6b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h5b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h10b-1),int_mb(k_range+h6b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p7b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p8b-1),7,5,4,2,3,1,8,6,1.0d0,.false.)
      END IF
      IF ((h9b .lt. h5b) .and. (h5b .le. h10b) .and. (h10b .lt. h6b) .an
     &d. (p4b .le. p7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h6b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h5b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h10b-1),int_mb(k_range+h6b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p7b-1
     &),int_mb(k_range+p8b-1),6,5,4,2,3,1,8,7,-1.0d0,.false.)
      END IF
      IF ((h9b .lt. h5b) .and. (h6b .le. h10b) .and. (p8b .lt. p3b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p8b_2 - noab - 1 
     &+ nvab * (p7b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h6b_2 - 
     &1 + noab * (h5b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h6b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p7b-1),int_mb(k_range+p8b-1),int_mb(k_range+p3b-1
     &),int_mb(k_range+p4b-1),8,7,3,2,4,1,6,5,1.0d0,.false.)
      END IF
      IF ((h9b .lt. h5b) .and. (h6b .le. h10b) .and. (p7b .lt. p3b) .and
     &. (p3b .le. p8b) .and. (p8b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p7b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h6b_2 - 
     &1 + noab * (h5b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h6b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p7b-1),int_mb(k_range+p3b-1),int_mb(k_range+p8b-1
     &),int_mb(k_range+p4b-1),8,6,3,2,4,1,7,5,-1.0d0,.false.)
      END IF
      IF ((h9b .lt. h5b) .and. (h6b .le. h10b) .and. (p7b .lt. p3b) .and
     &. (p4b .le. p8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p7b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h6b_2 - 
     &1 + noab * (h5b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h6b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p7b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p8b-1),7,6,3,2,4,1,8,5,1.0d0,.false.)
      END IF
      IF ((h9b .lt. h5b) .and. (h6b .le. h10b) .and. (p3b .le. p7b) .and
     &. (p8b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p7b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h6b_2 - 
     &1 + noab * (h5b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h6b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p7b-1),int_mb(k_range+p8b-1
     &),int_mb(k_range+p4b-1),8,5,3,2,4,1,7,6,1.0d0,.false.)
      END IF
      IF ((h9b .lt. h5b) .and. (h6b .le. h10b) .and. (p3b .le. p7b) .and
     &. (p7b .lt. p4b) .and. (p4b .le. p8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p7b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h6b_2 - 
     &1 + noab * (h5b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h6b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p7b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p8b-1),7,5,3,2,4,1,8,6,-1.0d0,.false.)
      END IF
      IF ((h9b .lt. h5b) .and. (h6b .le. h10b) .and. (p4b .le. p7b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h6b_2 - 
     &1 + noab * (h5b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h6b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p7b-1
     &),int_mb(k_range+p8b-1),6,5,3,2,4,1,8,7,1.0d0,.false.)
      END IF
      IF ((h5b .le. h9b) .and. (h10b .lt. h6b) .and. (p8b .lt. p3b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p8b_2 - noab - 1 
     &+ nvab * (p7b_2 - noab - 1 + nvab * (h6b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h9b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h10b-1),int_mb(k_range+h6b-1
     &),int_mb(k_range+p7b-1),int_mb(k_range+p8b-1),int_mb(k_range+p3b-1
     &),int_mb(k_range+p4b-1),8,7,4,1,3,2,6,5,1.0d0,.false.)
      END IF
      IF ((h5b .le. h9b) .and. (h10b .lt. h6b) .and. (p7b .lt. p3b) .and
     &. (p3b .le. p8b) .and. (p8b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p7b_2 - noab - 1 + nvab * (h6b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h9b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h10b-1),int_mb(k_range+h6b-1
     &),int_mb(k_range+p7b-1),int_mb(k_range+p3b-1),int_mb(k_range+p8b-1
     &),int_mb(k_range+p4b-1),8,6,4,1,3,2,7,5,-1.0d0,.false.)
      END IF
      IF ((h5b .le. h9b) .and. (h10b .lt. h6b) .and. (p7b .lt. p3b) .and
     &. (p4b .le. p8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p7b_2 - noab - 1 + nvab * (h6b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h9b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h10b-1),int_mb(k_range+h6b-1
     &),int_mb(k_range+p7b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p8b-1),7,6,4,1,3,2,8,5,1.0d0,.false.)
      END IF
      IF ((h5b .le. h9b) .and. (h10b .lt. h6b) .and. (p3b .le. p7b) .and
     &. (p8b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p7b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h6b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h9b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h10b-1),int_mb(k_range+h6b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p7b-1),int_mb(k_range+p8b-1
     &),int_mb(k_range+p4b-1),8,5,4,1,3,2,7,6,1.0d0,.false.)
      END IF
      IF ((h5b .le. h9b) .and. (h10b .lt. h6b) .and. (p3b .le. p7b) .and
     &. (p7b .lt. p4b) .and. (p4b .le. p8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p7b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h6b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h9b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h10b-1),int_mb(k_range+h6b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p7b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p8b-1),7,5,4,1,3,2,8,6,-1.0d0,.false.)
      END IF
      IF ((h5b .le. h9b) .and. (h10b .lt. h6b) .and. (p4b .le. p7b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h6b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h9b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h10b-1),int_mb(k_range+h6b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p7b-1
     &),int_mb(k_range+p8b-1),6,5,4,1,3,2,8,7,1.0d0,.false.)
      END IF
      IF ((h5b .le. h9b) .and. (h9b .lt. h6b) .and. (h6b .le. h10b) .and
     &. (p8b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p8b_2 - noab - 1 
     &+ nvab * (p7b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h6b_2 - 
     &1 + noab * (h9b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h6b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p7b-1),int_mb(k_range+p8b-1),int_mb(k_range+p3b-1
     &),int_mb(k_range+p4b-1),8,7,3,1,4,2,6,5,-1.0d0,.false.)
      END IF
      IF ((h5b .le. h9b) .and. (h9b .lt. h6b) .and. (h6b .le. h10b) .and
     &. (p7b .lt. p3b) .and. (p3b .le. p8b) .and. (p8b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p7b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h6b_2 - 
     &1 + noab * (h9b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h6b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p7b-1),int_mb(k_range+p3b-1),int_mb(k_range+p8b-1
     &),int_mb(k_range+p4b-1),8,6,3,1,4,2,7,5,1.0d0,.false.)
      END IF
      IF ((h5b .le. h9b) .and. (h9b .lt. h6b) .and. (h6b .le. h10b) .and
     &. (p7b .lt. p3b) .and. (p4b .le. p8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p7b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h6b_2 - 
     &1 + noab * (h9b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h6b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p7b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p8b-1),7,6,3,1,4,2,8,5,-1.0d0,.false.)
      END IF
      IF ((h5b .le. h9b) .and. (h9b .lt. h6b) .and. (h6b .le. h10b) .and
     &. (p3b .le. p7b) .and. (p8b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p7b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h6b_2 - 
     &1 + noab * (h9b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h6b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p7b-1),int_mb(k_range+p8b-1
     &),int_mb(k_range+p4b-1),8,5,3,1,4,2,7,6,-1.0d0,.false.)
      END IF
      IF ((h5b .le. h9b) .and. (h9b .lt. h6b) .and. (h6b .le. h10b) .and
     &. (p3b .le. p7b) .and. (p7b .lt. p4b) .and. (p4b .le. p8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p7b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h6b_2 - 
     &1 + noab * (h9b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h6b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p7b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p8b-1),7,5,3,1,4,2,8,6,1.0d0,.false.)
      END IF
      IF ((h5b .le. h9b) .and. (h9b .lt. h6b) .and. (h6b .le. h10b) .and
     &. (p4b .le. p7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h6b_2 - 
     &1 + noab * (h9b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h6b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p7b-1
     &),int_mb(k_range+p8b-1),6,5,3,1,4,2,8,7,-1.0d0,.false.)
      END IF
      IF ((h6b .le. h9b) .and. (p8b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p8b_2 - noab - 1 
     &+ nvab * (p7b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h9b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h9b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p7b-1),int_mb(k_range+p8b-1),int_mb(k_range+p3b-1
     &),int_mb(k_range+p4b-1),8,7,2,1,4,3,6,5,1.0d0,.false.)
      END IF
      IF ((h6b .le. h9b) .and. (p7b .lt. p3b) .and. (p3b .le. p8b) .and.
     & (p8b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p7b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h9b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h9b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p7b-1),int_mb(k_range+p3b-1),int_mb(k_range+p8b-1
     &),int_mb(k_range+p4b-1),8,6,2,1,4,3,7,5,-1.0d0,.false.)
      END IF
      IF ((h6b .le. h9b) .and. (p7b .lt. p3b) .and. (p4b .le. p8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p7b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h9b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h9b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p7b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p8b-1),7,6,2,1,4,3,8,5,1.0d0,.false.)
      END IF
      IF ((h6b .le. h9b) .and. (p3b .le. p7b) .and. (p8b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p7b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h9b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h9b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p7b-1),int_mb(k_range+p8b-1
     &),int_mb(k_range+p4b-1),8,5,2,1,4,3,7,6,1.0d0,.false.)
      END IF
      IF ((h6b .le. h9b) .and. (p3b .le. p7b) .and. (p7b .lt. p4b) .and.
     & (p4b .le. p8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p7b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h9b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h9b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p7b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p8b-1),7,5,2,1,4,3,8,6,-1.0d0,.false.)
      END IF
      IF ((h6b .le. h9b) .and. (p4b .le. p7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h9b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h9b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p7b-1
     &),int_mb(k_range+p8b-1),6,5,2,1,4,3,8,7,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_14_
     &2',6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      isuperp = 1
      IF (p7b .eq. p8b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      nsubh(1) = 1
      nsubh(2) = 1
      isubh = 1
      IF (h9b .eq. h10b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,4.0d0/FACTOR
     &IAL(nsuperp(1))/FACTORIAL(nsuperp(2))/FACTORIAL(nsubh(1))/FACTORIA
     &L(nsubh(2)),dbl_mb(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_commo
     &n,1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_14_2',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_14_2',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_14_2',9,MA_ERR)
      CALL TCE_SORT_4(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+h6b-1),int_mb(k_range+h5b-1)
     &,4,3,2,1,1.0d0/4.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p4b -
     & noab - 1 + nvab * (p3b - noab - 1 + nvab * (h6b - 1 + noab * (h5b
     & - 1)))))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_14_
     &2',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_14_2',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_15(d_a,k_a_offset,d_b,k_b_offset,d
     &_c,k_c_offset)
C     i1 ( p12 h11 )_yxt + = -1/144 * Sum ( h6 h7 h8 h9 p3 p4 p5 ) * t ( p3 p4 p5 p12 h6 h7 h8 h9 )_t * i2 ( h6 h7 h8 h9 h11 p3 p4 p5 )_yx
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER p12b
      INTEGER h11b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p3b
      INTEGER p4b
      INTEGER p5b
      INTEGER h6b
      INTEGER h7b
      INTEGER h8b
      INTEGER h9b
      INTEGER p12b_1
      INTEGER p3b_1
      INTEGER p4b_1
      INTEGER p5b_1
      INTEGER h6b_1
      INTEGER h7b_1
      INTEGER h8b_1
      INTEGER h9b_1
      INTEGER h6b_2
      INTEGER h7b_2
      INTEGER h8b_2
      INTEGER h9b_2
      INTEGER h11b_2
      INTEGER p3b_2
      INTEGER p4b_2
      INTEGER p5b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(3)
      INTEGER isuperp
      INTEGER nsubh(4)
      INTEGER isubh
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO p12b = noab+1,noab+nvab
      DO h11b = 1,noab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+p12b-1)+int_mb(k_spin+h11b
     &-1).ne.4)) THEN
      IF (int_mb(k_spin+p12b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+p12b-1),int_mb(k_sym+h11b-1)) .eq. ieor(irre
     &p_y,ieor(irrep_x,irrep_t))) THEN
      dimc = int_mb(k_range+p12b-1) * int_mb(k_range+h11b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_15',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      DO p5b = p4b,noab+nvab
      DO h6b = 1,noab
      DO h7b = h6b,noab
      DO h8b = h7b,noab
      DO h9b = h8b,noab
      IF (int_mb(k_active+p12b-1)+int_mb(k_active+p3b-1)+int_mb(k_active
     &+p4b-1)+int_mb(k_active+p5b-1) .ge. numacq) THEN
      IF (int_mb(k_active+h6b-1)+int_mb(k_active+h7b-1)+int_mb(k_active+
     &h8b-1)+int_mb(k_active+h9b-1) .ge. numacq) THEN
      IF (int_mb(k_spin+p12b-1)+int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1
     &)+int_mb(k_spin+p5b-1) .eq. int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b
     &-1)+int_mb(k_spin+h8b-1)+int_mb(k_spin+h9b-1)) THEN
      IF (ieor(int_mb(k_sym+p12b-1),ieor(int_mb(k_sym+p3b-1),ieor(int_mb
     &(k_sym+p4b-1),ieor(int_mb(k_sym+p5b-1),ieor(int_mb(k_sym+h6b-1),ie
     &or(int_mb(k_sym+h7b-1),ieor(int_mb(k_sym+h8b-1),int_mb(k_sym+h9b-1
     &)))))))) .eq. irrep_t) THEN
      CALL TCE_RESTRICTED_8(p12b,p3b,p4b,p5b,h6b,h7b,h8b,h9b,p12b_1,p3b_
     &1,p4b_1,p5b_1,h6b_1,h7b_1,h8b_1,h9b_1)
      CALL TCE_RESTRICTED_8(h6b,h7b,h8b,h9b,h11b,p3b,p4b,p5b,h6b_2,h7b_2
     &,h8b_2,h9b_2,h11b_2,p3b_2,p4b_2,p5b_2)
      dim_common = int_mb(k_range+p3b-1) * int_mb(k_range+p4b-1) * int_m
     &b(k_range+p5b-1) * int_mb(k_range+h6b-1) * int_mb(k_range+h7b-1) *
     & int_mb(k_range+h8b-1) * int_mb(k_range+h9b-1)
      dima_sort = int_mb(k_range+p12b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h11b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_15',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_15',2,MA_ERR)
      IF ((p5b .le. p12b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h9b_1
     & - 1 + noab * (h8b_1 - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 +
     & noab * (p12b_1 - noab - 1 + nvab * (p5b_1 - noab - 1 + nvab * (p4
     &b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+p12b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h8b-1
     &),int_mb(k_range+h9b-1),4,8,7,6,5,3,2,1,1.0d0,.false.)
      END IF
      IF ((p4b .le. p12b) .and. (p12b .lt. p5b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h9b_1
     & - 1 + noab * (h8b_1 - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 +
     & noab * (p5b_1 - noab - 1 + nvab * (p12b_1 - noab - 1 + nvab * (p4
     &b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p12b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h8b-1
     &),int_mb(k_range+h9b-1),3,8,7,6,5,4,2,1,-1.0d0,.false.)
      END IF
      IF ((p3b .le. p12b) .and. (p12b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h9b_1
     & - 1 + noab * (h8b_1 - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 +
     & noab * (p5b_1 - noab - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p12
     &b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p12b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h8b-1
     &),int_mb(k_range+h9b-1),2,8,7,6,5,4,3,1,1.0d0,.false.)
      END IF
      IF ((p12b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h9b_1
     & - 1 + noab * (h8b_1 - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 +
     & noab * (p5b_1 - noab - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p3b
     &_1 - noab - 1 + nvab * (p12b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p12b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h8b-1
     &),int_mb(k_range+h9b-1),1,8,7,6,5,4,3,2,-1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_15'
     &,3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_15',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_15',5,MA_ERR)
      IF ((h11b .le. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h11b_2 - 1 + noab * (h9b_2 - 1 + noab * (h8b_2 - 1 + noa
     &b * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h11b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p5b-1),5,4,3,2,1,8,7,6,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_15'
     &,6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      nsuperp(3) = 1
      isuperp = 1
      IF (p3b .eq. p4b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      IF (p4b .eq. p5b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      nsubh(1) = 1
      nsubh(2) = 1
      nsubh(3) = 1
      nsubh(4) = 1
      isubh = 1
      IF (h6b .eq. h7b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      IF (h7b .eq. h8b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      IF (h8b .eq. h9b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,144.0d0/FACT
     &ORIAL(nsuperp(1))/FACTORIAL(nsuperp(2))/FACTORIAL(nsuperp(3))/FACT
     &ORIAL(nsubh(1))/FACTORIAL(nsubh(2))/FACTORIAL(nsubh(3))/FACTORIAL(
     &nsubh(4)),dbl_mb(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,
     &1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_15',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_15',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_15',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+h11b-1
     &),int_mb(k_range+p12b-1),2,1,-1.0d0/144.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(h11b 
     &- 1 + noab * (p12b - noab - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_15'
     &,10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_15',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_15_1(d_a,k_a_offset,d_b,k_b_offset
     &,d_c,k_c_offset)
C     i2 ( h6 h7 h8 h9 h11 p3 p4 p5 )_yx + = 1 * Sum ( p10 ) * x ( p10 h11 )_x * y ( h6 h7 h8 h9 p3 p4 p5 p10 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h6b
      INTEGER h7b
      INTEGER h8b
      INTEGER h9b
      INTEGER h11b
      INTEGER p3b
      INTEGER p4b
      INTEGER p5b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p10b
      INTEGER p10b_1
      INTEGER h11b_1
      INTEGER h6b_2
      INTEGER h7b_2
      INTEGER h8b_2
      INTEGER h9b_2
      INTEGER p3b_2
      INTEGER p4b_2
      INTEGER p5b_2
      INTEGER p10b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h6b = 1,noab
      DO h7b = h6b,noab
      DO h8b = h7b,noab
      DO h9b = h8b,noab
      DO h11b = 1,noab
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      DO p5b = p4b,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b-1
     &)+int_mb(k_spin+h8b-1)+int_mb(k_spin+h9b-1)+int_mb(k_spin+h11b-1)+
     &int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1)+int_mb(k_spin+p5b-1).ne.
     &16)) THEN
      IF (int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b-1)+int_mb(k_spin+h8b-1)
     &+int_mb(k_spin+h9b-1) .eq. int_mb(k_spin+h11b-1)+int_mb(k_spin+p3b
     &-1)+int_mb(k_spin+p4b-1)+int_mb(k_spin+p5b-1)) THEN
      IF (ieor(int_mb(k_sym+h6b-1),ieor(int_mb(k_sym+h7b-1),ieor(int_mb(
     &k_sym+h8b-1),ieor(int_mb(k_sym+h9b-1),ieor(int_mb(k_sym+h11b-1),ie
     &or(int_mb(k_sym+p3b-1),ieor(int_mb(k_sym+p4b-1),int_mb(k_sym+p5b-1
     &)))))))) .eq. ieor(irrep_y,irrep_x)) THEN
      dimc = int_mb(k_range+h6b-1) * int_mb(k_range+h7b-1) * int_mb(k_ra
     &nge+h8b-1) * int_mb(k_range+h9b-1) * int_mb(k_range+h11b-1) * int_
     &mb(k_range+p3b-1) * int_mb(k_range+p4b-1) * int_mb(k_range+p5b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_15_1',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p10b = noab+1,noab+nvab
      IF (int_mb(k_active+h6b-1)+int_mb(k_active+h7b-1)+int_mb(k_active+
     &h8b-1)+int_mb(k_active+h9b-1) .ge. numacq) THEN
      IF (int_mb(k_active+p3b-1)+int_mb(k_active+p4b-1)+int_mb(k_active+
     &p5b-1)+int_mb(k_active+p10b-1) .ge. numacq) THEN
      IF (int_mb(k_spin+p10b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+p10b-1),int_mb(k_sym+h11b-1)) .eq. irrep_x) 
     &THEN
      CALL TCE_RESTRICTED_2(p10b,h11b,p10b_1,h11b_1)
      CALL TCE_RESTRICTED_8(h6b,h7b,h8b,h9b,p3b,p4b,p5b,p10b,h6b_2,h7b_2
     &,h8b_2,h9b_2,p3b_2,p4b_2,p5b_2,p10b_2)
      dim_common = int_mb(k_range+p10b-1)
      dima_sort = int_mb(k_range+h11b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h6b-1) * int_mb(k_range+h7b-1) * int_mb
     &(k_range+h8b-1) * int_mb(k_range+h9b-1) * int_mb(k_range+p3b-1) * 
     &int_mb(k_range+p4b-1) * int_mb(k_range+p5b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_15_1',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_15_1',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h11b_
     &1 - 1 + noab * (p10b_1 - noab - 1)))
      CALL TCE_SORT_2(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p10b-1
     &),int_mb(k_range+h11b-1),2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_15_
     &1',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_15_1',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_15_1',5,MA_ERR)
      IF ((p10b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p10b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h8b_2 - 
     &1 + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p10b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p5b-1),8,7,6,4,3,2,1,5,-1.0d0,.false.)
      END IF
      IF ((p3b .le. p10b) .and. (p10b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p10b_2 - noab - 1
     & + nvab * (p3b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h8b_2 - 
     &1 + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p10b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p5b-1),8,7,5,4,3,2,1,6,1.0d0,.false.)
      END IF
      IF ((p4b .le. p10b) .and. (p10b .lt. p5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p10b_2 - noab - 1 + nvab * (p4b_2 - noab - 1
     & + nvab * (p3b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h8b_2 - 
     &1 + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p10b-1
     &),int_mb(k_range+p5b-1),8,6,5,4,3,2,1,7,-1.0d0,.false.)
      END IF
      IF ((p5b .le. p10b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p10b_
     &2 - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1
     & + nvab * (p3b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h8b_2 - 
     &1 + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p10b-1),7,6,5,4,3,2,1,8,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_15_
     &1',6,MA_ERR)
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,1.0d0,dbl_mb
     &(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c
     &_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_15_1',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_15_1',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_15_1',9,MA_ERR)
      CALL TCE_SORT_8(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p3b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h7b-1),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h11b-1),7,6,5,4,8,3,2,1,1.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p5b -
     & noab - 1 + nvab * (p4b - noab - 1 + nvab * (p3b - noab - 1 + nvab
     & * (h11b - 1 + noab * (h9b - 1 + noab * (h8b - 1 + noab * (h7b - 1
     & + noab * (h6b - 1)))))))))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_15_
     &1',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_15_1',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE OFFSET_eomccsdtq_density1_5_15_1(l_a_offset,k_a_offset,
     &size)
C     i2 ( h6 h7 h8 h9 h11 p3 p4 p5 )_yx
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER l_a_offset
      INTEGER k_a_offset
      INTEGER length
      INTEGER addr
      INTEGER h6b
      INTEGER h7b
      INTEGER h8b
      INTEGER h9b
      INTEGER h11b
      INTEGER p3b
      INTEGER p4b
      INTEGER p5b
      DOUBLE PRECISION size
      length = 0
      DO h6b = 1,noab
      DO h7b = h6b,noab
      DO h8b = h7b,noab
      DO h9b = h8b,noab
      DO h11b = 1,noab
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      DO p5b = p4b,noab+nvab
      IF (int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b-1)+int_mb(k_spin+h8b-1)
     &+int_mb(k_spin+h9b-1) .eq. int_mb(k_spin+h11b-1)+int_mb(k_spin+p3b
     &-1)+int_mb(k_spin+p4b-1)+int_mb(k_spin+p5b-1)) THEN
      IF (ieor(int_mb(k_sym+h6b-1),ieor(int_mb(k_sym+h7b-1),ieor(int_mb(
     &k_sym+h8b-1),ieor(int_mb(k_sym+h9b-1),ieor(int_mb(k_sym+h11b-1),ie
     &or(int_mb(k_sym+p3b-1),ieor(int_mb(k_sym+p4b-1),int_mb(k_sym+p5b-1
     &)))))))) .eq. ieor(irrep_y,irrep_x)) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b-1
     &)+int_mb(k_spin+h8b-1)+int_mb(k_spin+h9b-1)+int_mb(k_spin+h11b-1)+
     &int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1)+int_mb(k_spin+p5b-1).ne.
     &16)) THEN
      length = length + 1
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,2*length+1,'noname',l_a_offset,k_a_off
     &set)) CALL ERRQUIT('eomccsdtq_density1_5_15_1',0,MA_ERR)
      dbl_mb(k_a_offset) = dfloat(length)
      addr = 0
      size = 0.0d0
      DO h6b = 1,noab
      DO h7b = h6b,noab
      DO h8b = h7b,noab
      DO h9b = h8b,noab
      DO h11b = 1,noab
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      DO p5b = p4b,noab+nvab
      IF (int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b-1)+int_mb(k_spin+h8b-1)
     &+int_mb(k_spin+h9b-1) .eq. int_mb(k_spin+h11b-1)+int_mb(k_spin+p3b
     &-1)+int_mb(k_spin+p4b-1)+int_mb(k_spin+p5b-1)) THEN
      IF (ieor(int_mb(k_sym+h6b-1),ieor(int_mb(k_sym+h7b-1),ieor(int_mb(
     &k_sym+h8b-1),ieor(int_mb(k_sym+h9b-1),ieor(int_mb(k_sym+h11b-1),ie
     &or(int_mb(k_sym+p3b-1),ieor(int_mb(k_sym+p4b-1),int_mb(k_sym+p5b-1
     &)))))))) .eq. ieor(irrep_y,irrep_x)) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b-1
     &)+int_mb(k_spin+h8b-1)+int_mb(k_spin+h9b-1)+int_mb(k_spin+h11b-1)+
     &int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1)+int_mb(k_spin+p5b-1).ne.
     &16)) THEN
      addr = addr + 1
      dbl_mb(k_a_offset+addr) = dfloat(p5b - noab - 1 + nvab * (p4b - no
     &ab - 1 + nvab * (p3b - noab - 1 + nvab * (h11b - 1 + noab * (h9b -
     & 1 + noab * (h8b - 1 + noab * (h7b - 1 + noab * (h6b - 1))))))))
      dbl_mb(k_a_offset+length+addr) = size
      size = size + dfloat(int_mb(k_range+h6b-1)) * dfloat(int_mb(k_rang
     &e+h7b-1)) * dfloat(int_mb(k_range+h8b-1)) * dfloat(int_mb(k_range+
     &h9b-1)) * dfloat(int_mb(k_range+h11b-1)) * dfloat(int_mb(k_range+p
     &3b-1)) * dfloat(int_mb(k_range+p4b-1)) * dfloat(int_mb(k_range+p5b
     &-1))
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_16(d_a,k_a_offset,d_b,k_b_offset,d
     &_c,k_c_offset)
C     i1 ( p12 h11 )_yxt + = 1/36 * Sum ( h6 h7 h8 p3 p4 p5 ) * t ( p3 p4 p5 p12 h6 h7 h8 h11 )_t * i2 ( h6 h7 h8 p3 p4 p5 )_yx
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER p12b
      INTEGER h11b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p3b
      INTEGER p4b
      INTEGER p5b
      INTEGER h6b
      INTEGER h7b
      INTEGER h8b
      INTEGER p12b_1
      INTEGER p3b_1
      INTEGER p4b_1
      INTEGER p5b_1
      INTEGER h11b_1
      INTEGER h6b_1
      INTEGER h7b_1
      INTEGER h8b_1
      INTEGER h6b_2
      INTEGER h7b_2
      INTEGER h8b_2
      INTEGER p3b_2
      INTEGER p4b_2
      INTEGER p5b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(3)
      INTEGER isuperp
      INTEGER nsubh(3)
      INTEGER isubh
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO p12b = noab+1,noab+nvab
      DO h11b = 1,noab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+p12b-1)+int_mb(k_spin+h11b
     &-1).ne.4)) THEN
      IF (int_mb(k_spin+p12b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+p12b-1),int_mb(k_sym+h11b-1)) .eq. ieor(irre
     &p_y,ieor(irrep_x,irrep_t))) THEN
      dimc = int_mb(k_range+p12b-1) * int_mb(k_range+h11b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_16',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      DO p5b = p4b,noab+nvab
      DO h6b = 1,noab
      DO h7b = h6b,noab
      DO h8b = h7b,noab
      IF (int_mb(k_active+p12b-1)+int_mb(k_active+p3b-1)+int_mb(k_active
     &+p4b-1)+int_mb(k_active+p5b-1) .ge. numacq) THEN
      IF (int_mb(k_active+h11b-1)+int_mb(k_active+h6b-1)+int_mb(k_active
     &+h7b-1)+int_mb(k_active+h8b-1) .ge. numacq) THEN
      IF (int_mb(k_spin+p12b-1)+int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1
     &)+int_mb(k_spin+p5b-1) .eq. int_mb(k_spin+h11b-1)+int_mb(k_spin+h6
     &b-1)+int_mb(k_spin+h7b-1)+int_mb(k_spin+h8b-1)) THEN
      IF (ieor(int_mb(k_sym+p12b-1),ieor(int_mb(k_sym+p3b-1),ieor(int_mb
     &(k_sym+p4b-1),ieor(int_mb(k_sym+p5b-1),ieor(int_mb(k_sym+h11b-1),i
     &eor(int_mb(k_sym+h6b-1),ieor(int_mb(k_sym+h7b-1),int_mb(k_sym+h8b-
     &1)))))))) .eq. irrep_t) THEN
      CALL TCE_RESTRICTED_8(p12b,p3b,p4b,p5b,h11b,h6b,h7b,h8b,p12b_1,p3b
     &_1,p4b_1,p5b_1,h11b_1,h6b_1,h7b_1,h8b_1)
      CALL TCE_RESTRICTED_6(h6b,h7b,h8b,p3b,p4b,p5b,h6b_2,h7b_2,h8b_2,p3
     &b_2,p4b_2,p5b_2)
      dim_common = int_mb(k_range+p3b-1) * int_mb(k_range+p4b-1) * int_m
     &b(k_range+p5b-1) * int_mb(k_range+h6b-1) * int_mb(k_range+h7b-1) *
     & int_mb(k_range+h8b-1)
      dima_sort = int_mb(k_range+p12b-1) * int_mb(k_range+h11b-1)
      dima = dim_common * dima_sort
      dimb_sort = 1
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_16',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_16',2,MA_ERR)
      IF ((p5b .le. p12b) .and. (h8b .le. h11b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h11b_
     &1 - 1 + noab * (h8b_1 - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 
     &+ noab * (p12b_1 - noab - 1 + nvab * (p5b_1 - noab - 1 + nvab * (p
     &4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+p12b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h8b-1
     &),int_mb(k_range+h11b-1),8,4,7,6,5,3,2,1,1.0d0,.false.)
      END IF
      IF ((p5b .le. p12b) .and. (h7b .le. h11b) .and. (h11b .lt. h8b)) T
     &HEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h8b_1
     & - 1 + noab * (h11b_1 - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 
     &+ noab * (p12b_1 - noab - 1 + nvab * (p5b_1 - noab - 1 + nvab * (p
     &4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+p12b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h11b-
     &1),int_mb(k_range+h8b-1),7,4,8,6,5,3,2,1,-1.0d0,.false.)
      END IF
      IF ((p5b .le. p12b) .and. (h6b .le. h11b) .and. (h11b .lt. h7b)) T
     &HEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h8b_1
     & - 1 + noab * (h7b_1 - 1 + noab * (h11b_1 - 1 + noab * (h6b_1 - 1 
     &+ noab * (p12b_1 - noab - 1 + nvab * (p5b_1 - noab - 1 + nvab * (p
     &4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+p12b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h11b-1),int_mb(k_range+h7b-
     &1),int_mb(k_range+h8b-1),6,4,8,7,5,3,2,1,1.0d0,.false.)
      END IF
      IF ((p5b .le. p12b) .and. (h11b .lt. h6b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h8b_1
     & - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 + noab * (h11b_1 - 1 
     &+ noab * (p12b_1 - noab - 1 + nvab * (p5b_1 - noab - 1 + nvab * (p
     &4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+p12b-1
     &),int_mb(k_range+h11b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-
     &1),int_mb(k_range+h8b-1),5,4,8,7,6,3,2,1,-1.0d0,.false.)
      END IF
      IF ((p4b .le. p12b) .and. (p12b .lt. p5b) .and. (h8b .le. h11b)) T
     &HEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h11b_
     &1 - 1 + noab * (h8b_1 - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 
     &+ noab * (p5b_1 - noab - 1 + nvab * (p12b_1 - noab - 1 + nvab * (p
     &4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p12b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h8b-1
     &),int_mb(k_range+h11b-1),8,3,7,6,5,4,2,1,-1.0d0,.false.)
      END IF
      IF ((p4b .le. p12b) .and. (p12b .lt. p5b) .and. (h7b .le. h11b) .a
     &nd. (h11b .lt. h8b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h8b_1
     & - 1 + noab * (h11b_1 - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 
     &+ noab * (p5b_1 - noab - 1 + nvab * (p12b_1 - noab - 1 + nvab * (p
     &4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p12b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h11b-
     &1),int_mb(k_range+h8b-1),7,3,8,6,5,4,2,1,1.0d0,.false.)
      END IF
      IF ((p4b .le. p12b) .and. (p12b .lt. p5b) .and. (h6b .le. h11b) .a
     &nd. (h11b .lt. h7b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h8b_1
     & - 1 + noab * (h7b_1 - 1 + noab * (h11b_1 - 1 + noab * (h6b_1 - 1 
     &+ noab * (p5b_1 - noab - 1 + nvab * (p12b_1 - noab - 1 + nvab * (p
     &4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p12b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h11b-1),int_mb(k_range+h7b-
     &1),int_mb(k_range+h8b-1),6,3,8,7,5,4,2,1,-1.0d0,.false.)
      END IF
      IF ((p4b .le. p12b) .and. (p12b .lt. p5b) .and. (h11b .lt. h6b)) T
     &HEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h8b_1
     & - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 + noab * (h11b_1 - 1 
     &+ noab * (p5b_1 - noab - 1 + nvab * (p12b_1 - noab - 1 + nvab * (p
     &4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p12b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+h11b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-
     &1),int_mb(k_range+h8b-1),5,3,8,7,6,4,2,1,1.0d0,.false.)
      END IF
      IF ((p3b .le. p12b) .and. (p12b .lt. p4b) .and. (h8b .le. h11b)) T
     &HEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h11b_
     &1 - 1 + noab * (h8b_1 - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 
     &+ noab * (p5b_1 - noab - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p1
     &2b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p12b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h8b-1
     &),int_mb(k_range+h11b-1),8,2,7,6,5,4,3,1,1.0d0,.false.)
      END IF
      IF ((p3b .le. p12b) .and. (p12b .lt. p4b) .and. (h7b .le. h11b) .a
     &nd. (h11b .lt. h8b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h8b_1
     & - 1 + noab * (h11b_1 - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 
     &+ noab * (p5b_1 - noab - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p1
     &2b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p12b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h11b-
     &1),int_mb(k_range+h8b-1),7,2,8,6,5,4,3,1,-1.0d0,.false.)
      END IF
      IF ((p3b .le. p12b) .and. (p12b .lt. p4b) .and. (h6b .le. h11b) .a
     &nd. (h11b .lt. h7b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h8b_1
     & - 1 + noab * (h7b_1 - 1 + noab * (h11b_1 - 1 + noab * (h6b_1 - 1 
     &+ noab * (p5b_1 - noab - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p1
     &2b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p12b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h11b-1),int_mb(k_range+h7b-
     &1),int_mb(k_range+h8b-1),6,2,8,7,5,4,3,1,1.0d0,.false.)
      END IF
      IF ((p3b .le. p12b) .and. (p12b .lt. p4b) .and. (h11b .lt. h6b)) T
     &HEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h8b_1
     & - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 + noab * (h11b_1 - 1 
     &+ noab * (p5b_1 - noab - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p1
     &2b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p12b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+h11b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-
     &1),int_mb(k_range+h8b-1),5,2,8,7,6,4,3,1,-1.0d0,.false.)
      END IF
      IF ((p12b .lt. p3b) .and. (h8b .le. h11b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h11b_
     &1 - 1 + noab * (h8b_1 - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 
     &+ noab * (p5b_1 - noab - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p3
     &b_1 - noab - 1 + nvab * (p12b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p12b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h8b-1
     &),int_mb(k_range+h11b-1),8,1,7,6,5,4,3,2,-1.0d0,.false.)
      END IF
      IF ((p12b .lt. p3b) .and. (h7b .le. h11b) .and. (h11b .lt. h8b)) T
     &HEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h8b_1
     & - 1 + noab * (h11b_1 - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 
     &+ noab * (p5b_1 - noab - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p3
     &b_1 - noab - 1 + nvab * (p12b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p12b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h11b-
     &1),int_mb(k_range+h8b-1),7,1,8,6,5,4,3,2,1.0d0,.false.)
      END IF
      IF ((p12b .lt. p3b) .and. (h6b .le. h11b) .and. (h11b .lt. h7b)) T
     &HEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h8b_1
     & - 1 + noab * (h7b_1 - 1 + noab * (h11b_1 - 1 + noab * (h6b_1 - 1 
     &+ noab * (p5b_1 - noab - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p3
     &b_1 - noab - 1 + nvab * (p12b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p12b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h11b-1),int_mb(k_range+h7b-
     &1),int_mb(k_range+h8b-1),6,1,8,7,5,4,3,2,-1.0d0,.false.)
      END IF
      IF ((p12b .lt. p3b) .and. (h11b .lt. h6b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h8b_1
     & - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 + noab * (h11b_1 - 1 
     &+ noab * (p5b_1 - noab - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p3
     &b_1 - noab - 1 + nvab * (p12b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p12b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+h11b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-
     &1),int_mb(k_range+h8b-1),5,1,8,7,6,4,3,2,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_16'
     &,3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_16',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_16',5,MA_ERR)
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h8b_2 - 1 + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),3,2,1,6,5,4,1.0d0,.fa
     &lse.)
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_16'
     &,6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      nsuperp(3) = 1
      isuperp = 1
      IF (p3b .eq. p4b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      IF (p4b .eq. p5b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      nsubh(1) = 1
      nsubh(2) = 1
      nsubh(3) = 1
      isubh = 1
      IF (h6b .eq. h7b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      IF (h7b .eq. h8b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,36.0d0/FACTO
     &RIAL(nsuperp(1))/FACTORIAL(nsuperp(2))/FACTORIAL(nsuperp(3))/FACTO
     &RIAL(nsubh(1))/FACTORIAL(nsubh(2))/FACTORIAL(nsubh(3)),dbl_mb(k_a_
     &sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c_sort
     &),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_16',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_16',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_16',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+h11b-1
     &),int_mb(k_range+p12b-1),2,1,1.0d0/36.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(h11b 
     &- 1 + noab * (p12b - noab - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_16'
     &,10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_16',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_16_1(d_a,k_a_offset,d_b,k_b_offset
     &,d_c,k_c_offset)
C     i2 ( h6 h7 h8 p3 p4 p5 )_yx + = 1 * Sum ( h10 p9 ) * x ( p9 h10 )_x * y ( h6 h7 h8 h10 p3 p4 p5 p9 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h6b
      INTEGER h7b
      INTEGER h8b
      INTEGER p3b
      INTEGER p4b
      INTEGER p5b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p9b
      INTEGER h10b
      INTEGER p9b_1
      INTEGER h10b_1
      INTEGER h6b_2
      INTEGER h7b_2
      INTEGER h8b_2
      INTEGER h10b_2
      INTEGER p3b_2
      INTEGER p4b_2
      INTEGER p5b_2
      INTEGER p9b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h6b = 1,noab
      DO h7b = h6b,noab
      DO h8b = h7b,noab
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      DO p5b = p4b,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b-1
     &)+int_mb(k_spin+h8b-1)+int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1)+i
     &nt_mb(k_spin+p5b-1).ne.12)) THEN
      IF (int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b-1)+int_mb(k_spin+h8b-1)
     & .eq. int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1)+int_mb(k_spin+p5b-
     &1)) THEN
      IF (ieor(int_mb(k_sym+h6b-1),ieor(int_mb(k_sym+h7b-1),ieor(int_mb(
     &k_sym+h8b-1),ieor(int_mb(k_sym+p3b-1),ieor(int_mb(k_sym+p4b-1),int
     &_mb(k_sym+p5b-1)))))) .eq. ieor(irrep_y,irrep_x)) THEN
      dimc = int_mb(k_range+h6b-1) * int_mb(k_range+h7b-1) * int_mb(k_ra
     &nge+h8b-1) * int_mb(k_range+p3b-1) * int_mb(k_range+p4b-1) * int_m
     &b(k_range+p5b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_16_1',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p9b = noab+1,noab+nvab
      DO h10b = 1,noab
      IF (int_mb(k_active+h6b-1)+int_mb(k_active+h7b-1)+int_mb(k_active+
     &h8b-1)+int_mb(k_active+h10b-1) .ge. numacq) THEN
      IF (int_mb(k_active+p3b-1)+int_mb(k_active+p4b-1)+int_mb(k_active+
     &p5b-1)+int_mb(k_active+p9b-1) .ge. numacq) THEN
      IF (int_mb(k_spin+p9b-1) .eq. int_mb(k_spin+h10b-1)) THEN
      IF (ieor(int_mb(k_sym+p9b-1),int_mb(k_sym+h10b-1)) .eq. irrep_x) T
     &HEN
      CALL TCE_RESTRICTED_2(p9b,h10b,p9b_1,h10b_1)
      CALL TCE_RESTRICTED_8(h6b,h7b,h8b,h10b,p3b,p4b,p5b,p9b,h6b_2,h7b_2
     &,h8b_2,h10b_2,p3b_2,p4b_2,p5b_2,p9b_2)
      dim_common = int_mb(k_range+p9b-1) * int_mb(k_range+h10b-1)
      dima_sort = 1
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h6b-1) * int_mb(k_range+h7b-1) * int_mb
     &(k_range+h8b-1) * int_mb(k_range+p3b-1) * int_mb(k_range+p4b-1) * 
     &int_mb(k_range+p5b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_16_1',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_16_1',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h10b_
     &1 - 1 + noab * (p9b_1 - noab - 1)))
      CALL TCE_SORT_2(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p9b-1)
     &,int_mb(k_range+h10b-1),2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_16_
     &1',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_16_1',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_16_1',5,MA_ERR)
      IF ((h10b .lt. h6b) .and. (p9b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p9b_2 - noab - 1 + nvab * (h8b_2 - 1 + noab * (h7b_2 - 1
     & + noab * (h6b_2 - 1 + noab * (h10b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h10b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h8b-1
     &),int_mb(k_range+p9b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p5b-1),8,7,6,4,3,2,1,5,1.0d0,.false.)
      END IF
      IF ((h10b .lt. h6b) .and. (p3b .le. p9b) .and. (p9b .lt. p4b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p9b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h8b_2 - 1 + noab * (h7b_2 - 1
     & + noab * (h6b_2 - 1 + noab * (h10b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h10b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h8b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p9b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p5b-1),8,7,5,4,3,2,1,6,-1.0d0,.false.)
      END IF
      IF ((h10b .lt. h6b) .and. (p4b .le. p9b) .and. (p9b .lt. p5b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p9b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h8b_2 - 1 + noab * (h7b_2 - 1
     & + noab * (h6b_2 - 1 + noab * (h10b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h10b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h8b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p9b-1
     &),int_mb(k_range+p5b-1),8,6,5,4,3,2,1,7,1.0d0,.false.)
      END IF
      IF ((h10b .lt. h6b) .and. (p5b .le. p9b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p9b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h8b_2 - 1 + noab * (h7b_2 - 1
     & + noab * (h6b_2 - 1 + noab * (h10b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h10b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h8b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+p9b-1),7,6,5,4,3,2,1,8,-1.0d0,.false.)
      END IF
      IF ((h6b .le. h10b) .and. (h10b .lt. h7b) .and. (p9b .lt. p3b)) TH
     &EN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p9b_2 - noab - 1 + nvab * (h8b_2 - 1 + noab * (h7b_2 - 1
     & + noab * (h10b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h10b-1),int_mb(k_range+h7b-1),int_mb(k_range+h8b-1
     &),int_mb(k_range+p9b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p5b-1),8,7,6,4,3,1,2,5,-1.0d0,.false.)
      END IF
      IF ((h6b .le. h10b) .and. (h10b .lt. h7b) .and. (p3b .le. p9b) .an
     &d. (p9b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p9b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h8b_2 - 1 + noab * (h7b_2 - 1
     & + noab * (h10b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h10b-1),int_mb(k_range+h7b-1),int_mb(k_range+h8b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p9b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p5b-1),8,7,5,4,3,1,2,6,1.0d0,.false.)
      END IF
      IF ((h6b .le. h10b) .and. (h10b .lt. h7b) .and. (p4b .le. p9b) .an
     &d. (p9b .lt. p5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p9b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h8b_2 - 1 + noab * (h7b_2 - 1
     & + noab * (h10b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h10b-1),int_mb(k_range+h7b-1),int_mb(k_range+h8b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p9b-1
     &),int_mb(k_range+p5b-1),8,6,5,4,3,1,2,7,-1.0d0,.false.)
      END IF
      IF ((h6b .le. h10b) .and. (h10b .lt. h7b) .and. (p5b .le. p9b)) TH
     &EN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p9b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h8b_2 - 1 + noab * (h7b_2 - 1
     & + noab * (h10b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h10b-1),int_mb(k_range+h7b-1),int_mb(k_range+h8b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+p9b-1),7,6,5,4,3,1,2,8,1.0d0,.false.)
      END IF
      IF ((h7b .le. h10b) .and. (h10b .lt. h8b) .and. (p9b .lt. p3b)) TH
     &EN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p9b_2 - noab - 1 + nvab * (h8b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h10b-1),int_mb(k_range+h8b-1
     &),int_mb(k_range+p9b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p5b-1),8,7,6,4,2,1,3,5,1.0d0,.false.)
      END IF
      IF ((h7b .le. h10b) .and. (h10b .lt. h8b) .and. (p3b .le. p9b) .an
     &d. (p9b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p9b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h8b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h10b-1),int_mb(k_range+h8b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p9b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p5b-1),8,7,5,4,2,1,3,6,-1.0d0,.false.)
      END IF
      IF ((h7b .le. h10b) .and. (h10b .lt. h8b) .and. (p4b .le. p9b) .an
     &d. (p9b .lt. p5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p9b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h8b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h10b-1),int_mb(k_range+h8b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p9b-1
     &),int_mb(k_range+p5b-1),8,6,5,4,2,1,3,7,1.0d0,.false.)
      END IF
      IF ((h7b .le. h10b) .and. (h10b .lt. h8b) .and. (p5b .le. p9b)) TH
     &EN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p9b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h8b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h10b-1),int_mb(k_range+h8b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+p9b-1),7,6,5,4,2,1,3,8,-1.0d0,.false.)
      END IF
      IF ((h8b .le. h10b) .and. (p9b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p9b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h8b_2 - 
     &1 + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p9b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p5b-1),8,7,6,3,2,1,4,5,-1.0d0,.false.)
      END IF
      IF ((h8b .le. h10b) .and. (p3b .le. p9b) .and. (p9b .lt. p4b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p9b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h8b_2 - 
     &1 + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p9b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p5b-1),8,7,5,3,2,1,4,6,1.0d0,.false.)
      END IF
      IF ((h8b .le. h10b) .and. (p4b .le. p9b) .and. (p9b .lt. p5b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p9b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h8b_2 - 
     &1 + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p9b-1
     &),int_mb(k_range+p5b-1),8,6,5,3,2,1,4,7,-1.0d0,.false.)
      END IF
      IF ((h8b .le. h10b) .and. (p5b .le. p9b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p9b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h8b_2 - 
     &1 + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1
     &),int_mb(k_range+p9b-1),7,6,5,3,2,1,4,8,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_16_
     &1',6,MA_ERR)
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,1.0d0,dbl_mb
     &(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c
     &_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_16_1',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_16_1',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_16_1',9,MA_ERR)
      CALL TCE_SORT_6(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p3b-1),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h6b-1),6,5,4,3,2,1,1.0d0,.fa
     &lse.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p5b -
     & noab - 1 + nvab * (p4b - noab - 1 + nvab * (p3b - noab - 1 + nvab
     & * (h8b - 1 + noab * (h7b - 1 + noab * (h6b - 1)))))))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_16_
     &1',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_16_1',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE OFFSET_eomccsdtq_density1_5_16_1(l_a_offset,k_a_offset,
     &size)
C     i2 ( h6 h7 h8 p3 p4 p5 )_yx
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER l_a_offset
      INTEGER k_a_offset
      INTEGER length
      INTEGER addr
      INTEGER h6b
      INTEGER h7b
      INTEGER h8b
      INTEGER p3b
      INTEGER p4b
      INTEGER p5b
      DOUBLE PRECISION size
      length = 0
      DO h6b = 1,noab
      DO h7b = h6b,noab
      DO h8b = h7b,noab
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      DO p5b = p4b,noab+nvab
      IF (int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b-1)+int_mb(k_spin+h8b-1)
     & .eq. int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1)+int_mb(k_spin+p5b-
     &1)) THEN
      IF (ieor(int_mb(k_sym+h6b-1),ieor(int_mb(k_sym+h7b-1),ieor(int_mb(
     &k_sym+h8b-1),ieor(int_mb(k_sym+p3b-1),ieor(int_mb(k_sym+p4b-1),int
     &_mb(k_sym+p5b-1)))))) .eq. ieor(irrep_y,irrep_x)) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b-1
     &)+int_mb(k_spin+h8b-1)+int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1)+i
     &nt_mb(k_spin+p5b-1).ne.12)) THEN
      length = length + 1
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,2*length+1,'noname',l_a_offset,k_a_off
     &set)) CALL ERRQUIT('eomccsdtq_density1_5_16_1',0,MA_ERR)
      dbl_mb(k_a_offset) = dfloat(length)
      addr = 0
      size = 0.0d0
      DO h6b = 1,noab
      DO h7b = h6b,noab
      DO h8b = h7b,noab
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      DO p5b = p4b,noab+nvab
      IF (int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b-1)+int_mb(k_spin+h8b-1)
     & .eq. int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1)+int_mb(k_spin+p5b-
     &1)) THEN
      IF (ieor(int_mb(k_sym+h6b-1),ieor(int_mb(k_sym+h7b-1),ieor(int_mb(
     &k_sym+h8b-1),ieor(int_mb(k_sym+p3b-1),ieor(int_mb(k_sym+p4b-1),int
     &_mb(k_sym+p5b-1)))))) .eq. ieor(irrep_y,irrep_x)) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b-1
     &)+int_mb(k_spin+h8b-1)+int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1)+i
     &nt_mb(k_spin+p5b-1).ne.12)) THEN
      addr = addr + 1
      dbl_mb(k_a_offset+addr) = dfloat(p5b - noab - 1 + nvab * (p4b - no
     &ab - 1 + nvab * (p3b - noab - 1 + nvab * (h8b - 1 + noab * (h7b - 
     &1 + noab * (h6b - 1))))))
      dbl_mb(k_a_offset+length+addr) = size
      size = size + dfloat(int_mb(k_range+h6b-1)) * dfloat(int_mb(k_rang
     &e+h7b-1)) * dfloat(int_mb(k_range+h8b-1)) * dfloat(int_mb(k_range+
     &p3b-1)) * dfloat(int_mb(k_range+p4b-1)) * dfloat(int_mb(k_range+p5
     &b-1))
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_17(d_a,k_a_offset,d_b,k_b_offset,d
     &_c,k_c_offset)
C     i1 ( p12 h11 )_yxtt + = -1/2 * Sum ( p1 ) * t ( p1 h11 )_t * i2 ( p12 p1 )_yxt
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER p12b
      INTEGER h11b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p1b
      INTEGER p1b_1
      INTEGER h11b_1
      INTEGER p12b_2
      INTEGER p1b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO p12b = noab+1,noab+nvab
      DO h11b = 1,noab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+p12b-1)+int_mb(k_spin+h11b
     &-1).ne.4)) THEN
      IF (int_mb(k_spin+p12b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+p12b-1),int_mb(k_sym+h11b-1)) .eq. ieor(irre
     &p_y,ieor(irrep_x,ieor(irrep_t,irrep_t)))) THEN
      dimc = int_mb(k_range+p12b-1) * int_mb(k_range+h11b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_17',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p1b = noab+1,noab+nvab
      IF (int_mb(k_spin+p1b-1) .eq. int_mb(k_spin+h11b-1)) THEN
      IF (ieor(int_mb(k_sym+p1b-1),int_mb(k_sym+h11b-1)) .eq. irrep_t) T
     &HEN
      CALL TCE_RESTRICTED_2(p1b,h11b,p1b_1,h11b_1)
      CALL TCE_RESTRICTED_2(p12b,p1b,p12b_2,p1b_2)
      dim_common = int_mb(k_range+p1b-1)
      dima_sort = int_mb(k_range+h11b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+p12b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_17',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_17',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h11b_
     &1 - 1 + noab * (p1b_1 - noab - 1)))
      CALL TCE_SORT_2(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p1b-1)
     &,int_mb(k_range+h11b-1),2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_17'
     &,3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_17',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_17',5,MA_ERR)
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p1b_2
     & - noab - 1 + nvab * (p12b_2 - noab - 1)))
      CALL TCE_SORT_2(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+p12b-1
     &),int_mb(k_range+p1b-1),1,2,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_17'
     &,6,MA_ERR)
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,1.0d0,dbl_mb
     &(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c
     &_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_17',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_17',8,MA_ERR)
      END IF
      END IF
      END IF
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_17',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p12b-1
     &),int_mb(k_range+h11b-1),1,2,-1.0d0/2.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(h11b 
     &- 1 + noab * (p12b - noab - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_17'
     &,10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_17',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_17_1(d_a,k_a_offset,d_b,k_b_offset
     &,d_c,k_c_offset)
C     i2 ( p12 p1 )_yxt + = 1 * Sum ( h4 h5 p3 ) * t ( p3 p12 h4 h5 )_t * i3 ( h4 h5 p1 p3 )_yx
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER p12b
      INTEGER p1b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p3b
      INTEGER h4b
      INTEGER h5b
      INTEGER p12b_1
      INTEGER p3b_1
      INTEGER h4b_1
      INTEGER h5b_1
      INTEGER h4b_2
      INTEGER h5b_2
      INTEGER p1b_2
      INTEGER p3b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsubh(2)
      INTEGER isubh
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO p12b = noab+1,noab+nvab
      DO p1b = noab+1,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+p12b-1)+int_mb(k_spin+p1b-
     &1).ne.4)) THEN
      IF (int_mb(k_spin+p12b-1) .eq. int_mb(k_spin+p1b-1)) THEN
      IF (ieor(int_mb(k_sym+p12b-1),int_mb(k_sym+p1b-1)) .eq. ieor(irrep
     &_y,ieor(irrep_x,irrep_t))) THEN
      dimc = int_mb(k_range+p12b-1) * int_mb(k_range+p1b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_17_1',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p3b = noab+1,noab+nvab
      DO h4b = 1,noab
      DO h5b = h4b,noab
      IF (int_mb(k_spin+p12b-1)+int_mb(k_spin+p3b-1) .eq. int_mb(k_spin+
     &h4b-1)+int_mb(k_spin+h5b-1)) THEN
      IF (ieor(int_mb(k_sym+p12b-1),ieor(int_mb(k_sym+p3b-1),ieor(int_mb
     &(k_sym+h4b-1),int_mb(k_sym+h5b-1)))) .eq. irrep_t) THEN
      CALL TCE_RESTRICTED_4(p12b,p3b,h4b,h5b,p12b_1,p3b_1,h4b_1,h5b_1)
      CALL TCE_RESTRICTED_4(h4b,h5b,p1b,p3b,h4b_2,h5b_2,p1b_2,p3b_2)
      dim_common = int_mb(k_range+p3b-1) * int_mb(k_range+h4b-1) * int_m
     &b(k_range+h5b-1)
      dima_sort = int_mb(k_range+p12b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+p1b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_17_1',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_17_1',2,MA_ERR)
      IF ((p3b .le. p12b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h5b_1
     & - 1 + noab * (h4b_1 - 1 + noab * (p12b_1 - noab - 1 + nvab * (p3b
     &_1 - noab - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p12b-1),int_mb(k_range+h4b-1),int_mb(k_range+h5b-1
     &),2,4,3,1,1.0d0,.false.)
      END IF
      IF ((p12b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h5b_1
     & - 1 + noab * (h4b_1 - 1 + noab * (p3b_1 - noab - 1 + nvab * (p12b
     &_1 - noab - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p12b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+h4b-1),int_mb(k_range+h5b-1
     &),1,4,3,2,-1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_17_
     &1',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_17_1',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_17_1',5,MA_ERR)
      IF ((p3b .lt. p1b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p1b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab 
     &* (h4b_2 - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+p3b-1),int_mb(k_range+p1b-1)
     &,4,2,1,3,-1.0d0,.false.)
      END IF
      IF ((p1b .le. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p1b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab 
     &* (h4b_2 - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+p1b-1),int_mb(k_range+p3b-1)
     &,3,2,1,4,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_17_
     &1',6,MA_ERR)
      nsubh(1) = 1
      nsubh(2) = 1
      isubh = 1
      IF (h4b .eq. h5b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,2.0d0/FACTOR
     &IAL(nsubh(1))/FACTORIAL(nsubh(2)),dbl_mb(k_a_sort),dim_common,dbl_
     &mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_17_1',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_17_1',8,MA_ERR)
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_17_1',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p1b-1)
     &,int_mb(k_range+p12b-1),2,1,1.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p1b -
     & noab - 1 + nvab * (p12b - noab - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_17_
     &1',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_17_1',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE OFFSET_eomccsdtq_density1_5_17_1(l_a_offset,k_a_offset,
     &size)
C     i2 ( p12 p1 )_yxt
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER l_a_offset
      INTEGER k_a_offset
      INTEGER length
      INTEGER addr
      INTEGER p12b
      INTEGER p1b
      DOUBLE PRECISION size
      length = 0
      DO p12b = noab+1,noab+nvab
      DO p1b = noab+1,noab+nvab
      IF (int_mb(k_spin+p12b-1) .eq. int_mb(k_spin+p1b-1)) THEN
      IF (ieor(int_mb(k_sym+p12b-1),int_mb(k_sym+p1b-1)) .eq. ieor(irrep
     &_y,ieor(irrep_x,irrep_t))) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+p12b-1)+int_mb(k_spin+p1b-
     &1).ne.4)) THEN
      length = length + 1
      END IF
      END IF
      END IF
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,2*length+1,'noname',l_a_offset,k_a_off
     &set)) CALL ERRQUIT('eomccsdtq_density1_5_17_1',0,MA_ERR)
      dbl_mb(k_a_offset) = dfloat(length)
      addr = 0
      size = 0.0d0
      DO p12b = noab+1,noab+nvab
      DO p1b = noab+1,noab+nvab
      IF (int_mb(k_spin+p12b-1) .eq. int_mb(k_spin+p1b-1)) THEN
      IF (ieor(int_mb(k_sym+p12b-1),int_mb(k_sym+p1b-1)) .eq. ieor(irrep
     &_y,ieor(irrep_x,irrep_t))) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+p12b-1)+int_mb(k_spin+p1b-
     &1).ne.4)) THEN
      addr = addr + 1
      dbl_mb(k_a_offset+addr) = dfloat(p1b - noab - 1 + nvab * (p12b - n
     &oab - 1))
      dbl_mb(k_a_offset+length+addr) = size
      size = size + dfloat(int_mb(k_range+p12b-1)) * dfloat(int_mb(k_ran
     &ge+p1b-1))
      END IF
      END IF
      END IF
      END DO
      END DO
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_17_1_1(d_a,k_a_offset,d_b,k_b_offs
     &et,d_c,k_c_offset)
C     i3 ( h4 h5 p1 p3 )_yx + = -1 * Sum ( h8 p7 ) * x ( p7 h8 )_x * y ( h4 h5 h8 p1 p3 p7 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h4b
      INTEGER h5b
      INTEGER p1b
      INTEGER p3b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p7b
      INTEGER h8b
      INTEGER p7b_1
      INTEGER h8b_1
      INTEGER h4b_2
      INTEGER h5b_2
      INTEGER h8b_2
      INTEGER p1b_2
      INTEGER p3b_2
      INTEGER p7b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h4b = 1,noab
      DO h5b = h4b,noab
      DO p1b = noab+1,noab+nvab
      DO p3b = p1b,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h4b-1)+int_mb(k_spin+h5b-1
     &)+int_mb(k_spin+p1b-1)+int_mb(k_spin+p3b-1).ne.8)) THEN
      IF (int_mb(k_spin+h4b-1)+int_mb(k_spin+h5b-1) .eq. int_mb(k_spin+p
     &1b-1)+int_mb(k_spin+p3b-1)) THEN
      IF (ieor(int_mb(k_sym+h4b-1),ieor(int_mb(k_sym+h5b-1),ieor(int_mb(
     &k_sym+p1b-1),int_mb(k_sym+p3b-1)))) .eq. ieor(irrep_y,irrep_x)) TH
     &EN
      dimc = int_mb(k_range+h4b-1) * int_mb(k_range+h5b-1) * int_mb(k_ra
     &nge+p1b-1) * int_mb(k_range+p3b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_17_1_1',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p7b = noab+1,noab+nvab
      DO h8b = 1,noab
      IF (int_mb(k_active+h4b-1)+int_mb(k_active+h5b-1)+int_mb(k_active+
     &h8b-1) .ge. numact) THEN
      IF (int_mb(k_active+p1b-1)+int_mb(k_active+p3b-1)+int_mb(k_active+
     &p7b-1) .ge. numact) THEN
      IF (int_mb(k_spin+p7b-1) .eq. int_mb(k_spin+h8b-1)) THEN
      IF (ieor(int_mb(k_sym+p7b-1),int_mb(k_sym+h8b-1)) .eq. irrep_x) TH
     &EN
      CALL TCE_RESTRICTED_2(p7b,h8b,p7b_1,h8b_1)
      CALL TCE_RESTRICTED_6(h4b,h5b,h8b,p1b,p3b,p7b,h4b_2,h5b_2,h8b_2,p1
     &b_2,p3b_2,p7b_2)
      dim_common = int_mb(k_range+p7b-1) * int_mb(k_range+h8b-1)
      dima_sort = 1
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h4b-1) * int_mb(k_range+h5b-1) * int_mb
     &(k_range+p1b-1) * int_mb(k_range+p3b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_17_1_1',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_17_1_1',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h8b_1
     & - 1 + noab * (p7b_1 - noab - 1)))
      CALL TCE_SORT_2(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p7b-1)
     &,int_mb(k_range+h8b-1),2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_17_
     &1_1',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_17_1_1',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_17_1_1',5,MA_ERR)
      IF ((h8b .lt. h4b) .and. (p7b .lt. p1b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p1b_2 - noab - 1 + nvab * (p7b_2 - noab - 1 
     &+ nvab * (h5b_2 - 1 + noab * (h4b_2 - 1 + noab * (h8b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h4b-1),int_mb(k_range+h5b-1),int_mb(k_range+p7b-1)
     &,int_mb(k_range+p1b-1),int_mb(k_range+p3b-1),6,5,3,2,1,4,1.0d0,.fa
     &lse.)
      END IF
      IF ((h8b .lt. h4b) .and. (p1b .le. p7b) .and. (p7b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (h5b_2 - 1 + noab * (h4b_2 - 1 + noab * (h8b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h4b-1),int_mb(k_range+h5b-1),int_mb(k_range+p1b-1)
     &,int_mb(k_range+p7b-1),int_mb(k_range+p3b-1),6,4,3,2,1,5,-1.0d0,.f
     &alse.)
      END IF
      IF ((h8b .lt. h4b) .and. (p3b .le. p7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (h5b_2 - 1 + noab * (h4b_2 - 1 + noab * (h8b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h4b-1),int_mb(k_range+h5b-1),int_mb(k_range+p1b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p7b-1),5,4,3,2,1,6,1.0d0,.fa
     &lse.)
      END IF
      IF ((h4b .le. h8b) .and. (h8b .lt. h5b) .and. (p7b .lt. p1b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p1b_2 - noab - 1 + nvab * (p7b_2 - noab - 1 
     &+ nvab * (h5b_2 - 1 + noab * (h8b_2 - 1 + noab * (h4b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h5b-1),int_mb(k_range+p7b-1)
     &,int_mb(k_range+p1b-1),int_mb(k_range+p3b-1),6,5,3,1,2,4,-1.0d0,.f
     &alse.)
      END IF
      IF ((h4b .le. h8b) .and. (h8b .lt. h5b) .and. (p1b .le. p7b) .and.
     & (p7b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (h5b_2 - 1 + noab * (h8b_2 - 1 + noab * (h4b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h5b-1),int_mb(k_range+p1b-1)
     &,int_mb(k_range+p7b-1),int_mb(k_range+p3b-1),6,4,3,1,2,5,1.0d0,.fa
     &lse.)
      END IF
      IF ((h4b .le. h8b) .and. (h8b .lt. h5b) .and. (p3b .le. p7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (h5b_2 - 1 + noab * (h8b_2 - 1 + noab * (h4b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h5b-1),int_mb(k_range+p1b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p7b-1),5,4,3,1,2,6,-1.0d0,.f
     &alse.)
      END IF
      IF ((h5b .le. h8b) .and. (p7b .lt. p1b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p1b_2 - noab - 1 + nvab * (p7b_2 - noab - 1 
     &+ nvab * (h8b_2 - 1 + noab * (h5b_2 - 1 + noab * (h4b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h8b-1),int_mb(k_range+p7b-1)
     &,int_mb(k_range+p1b-1),int_mb(k_range+p3b-1),6,5,2,1,3,4,1.0d0,.fa
     &lse.)
      END IF
      IF ((h5b .le. h8b) .and. (p1b .le. p7b) .and. (p7b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (h8b_2 - 1 + noab * (h5b_2 - 1 + noab * (h4b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h8b-1),int_mb(k_range+p1b-1)
     &,int_mb(k_range+p7b-1),int_mb(k_range+p3b-1),6,4,2,1,3,5,-1.0d0,.f
     &alse.)
      END IF
      IF ((h5b .le. h8b) .and. (p3b .le. p7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (h8b_2 - 1 + noab * (h5b_2 - 1 + noab * (h4b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h8b-1),int_mb(k_range+p1b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p7b-1),5,4,2,1,3,6,1.0d0,.fa
     &lse.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_17_
     &1_1',6,MA_ERR)
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,1.0d0,dbl_mb
     &(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c
     &_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_17_1_1',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_17_1_1',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_17_1_1',9,MA_ERR)
      CALL TCE_SORT_4(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p1b-1),int_mb(k_range+h5b-1),int_mb(k_range+h4b-1)
     &,4,3,2,1,-1.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p3b -
     & noab - 1 + nvab * (p1b - noab - 1 + nvab * (h5b - 1 + noab * (h4b
     & - 1)))))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_17_
     &1_1',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_17_1_1',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE OFFSET_eomccsdtq_density1_5_17_1_1(l_a_offset,k_a_offse
     &t,size)
C     i3 ( h4 h5 p1 p3 )_yx
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER l_a_offset
      INTEGER k_a_offset
      INTEGER length
      INTEGER addr
      INTEGER h4b
      INTEGER h5b
      INTEGER p1b
      INTEGER p3b
      DOUBLE PRECISION size
      length = 0
      DO h4b = 1,noab
      DO h5b = h4b,noab
      DO p1b = noab+1,noab+nvab
      DO p3b = p1b,noab+nvab
      IF (int_mb(k_spin+h4b-1)+int_mb(k_spin+h5b-1) .eq. int_mb(k_spin+p
     &1b-1)+int_mb(k_spin+p3b-1)) THEN
      IF (ieor(int_mb(k_sym+h4b-1),ieor(int_mb(k_sym+h5b-1),ieor(int_mb(
     &k_sym+p1b-1),int_mb(k_sym+p3b-1)))) .eq. ieor(irrep_y,irrep_x)) TH
     &EN
      IF ((.not.restricted).or.(int_mb(k_spin+h4b-1)+int_mb(k_spin+h5b-1
     &)+int_mb(k_spin+p1b-1)+int_mb(k_spin+p3b-1).ne.8)) THEN
      length = length + 1
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,2*length+1,'noname',l_a_offset,k_a_off
     &set)) CALL ERRQUIT('eomccsdtq_density1_5_17_1_1',0,MA_ERR)
      dbl_mb(k_a_offset) = dfloat(length)
      addr = 0
      size = 0.0d0
      DO h4b = 1,noab
      DO h5b = h4b,noab
      DO p1b = noab+1,noab+nvab
      DO p3b = p1b,noab+nvab
      IF (int_mb(k_spin+h4b-1)+int_mb(k_spin+h5b-1) .eq. int_mb(k_spin+p
     &1b-1)+int_mb(k_spin+p3b-1)) THEN
      IF (ieor(int_mb(k_sym+h4b-1),ieor(int_mb(k_sym+h5b-1),ieor(int_mb(
     &k_sym+p1b-1),int_mb(k_sym+p3b-1)))) .eq. ieor(irrep_y,irrep_x)) TH
     &EN
      IF ((.not.restricted).or.(int_mb(k_spin+h4b-1)+int_mb(k_spin+h5b-1
     &)+int_mb(k_spin+p1b-1)+int_mb(k_spin+p3b-1).ne.8)) THEN
      addr = addr + 1
      dbl_mb(k_a_offset+addr) = dfloat(p3b - noab - 1 + nvab * (p1b - no
     &ab - 1 + nvab * (h5b - 1 + noab * (h4b - 1))))
      dbl_mb(k_a_offset+length+addr) = size
      size = size + dfloat(int_mb(k_range+h4b-1)) * dfloat(int_mb(k_rang
     &e+h5b-1)) * dfloat(int_mb(k_range+p1b-1)) * dfloat(int_mb(k_range+
     &p3b-1))
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_17_1_2(d_a,k_a_offset,d_b,k_b_offs
     &et,d_c,k_c_offset)
C     i3 ( h4 h5 p1 p3 )_yx + = -1/4 * Sum ( h10 h9 p8 p7 ) * x ( p7 p8 h9 h10 )_x * y ( h4 h5 h9 h10 p1 p3 p7 p8 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h4b
      INTEGER h5b
      INTEGER p1b
      INTEGER p3b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p7b
      INTEGER p8b
      INTEGER h9b
      INTEGER h10b
      INTEGER p7b_1
      INTEGER p8b_1
      INTEGER h9b_1
      INTEGER h10b_1
      INTEGER h4b_2
      INTEGER h5b_2
      INTEGER h9b_2
      INTEGER h10b_2
      INTEGER p1b_2
      INTEGER p3b_2
      INTEGER p7b_2
      INTEGER p8b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(2)
      INTEGER isuperp
      INTEGER nsubh(2)
      INTEGER isubh
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h4b = 1,noab
      DO h5b = h4b,noab
      DO p1b = noab+1,noab+nvab
      DO p3b = p1b,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h4b-1)+int_mb(k_spin+h5b-1
     &)+int_mb(k_spin+p1b-1)+int_mb(k_spin+p3b-1).ne.8)) THEN
      IF (int_mb(k_spin+h4b-1)+int_mb(k_spin+h5b-1) .eq. int_mb(k_spin+p
     &1b-1)+int_mb(k_spin+p3b-1)) THEN
      IF (ieor(int_mb(k_sym+h4b-1),ieor(int_mb(k_sym+h5b-1),ieor(int_mb(
     &k_sym+p1b-1),int_mb(k_sym+p3b-1)))) .eq. ieor(irrep_y,irrep_x)) TH
     &EN
      dimc = int_mb(k_range+h4b-1) * int_mb(k_range+h5b-1) * int_mb(k_ra
     &nge+p1b-1) * int_mb(k_range+p3b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_17_1_2',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p7b = noab+1,noab+nvab
      DO p8b = p7b,noab+nvab
      DO h9b = 1,noab
      DO h10b = h9b,noab
      IF (int_mb(k_active+h4b-1)+int_mb(k_active+h5b-1)+int_mb(k_active+
     &h9b-1)+int_mb(k_active+h10b-1) .ge. numacq) THEN
      IF (int_mb(k_active+p1b-1)+int_mb(k_active+p3b-1)+int_mb(k_active+
     &p7b-1)+int_mb(k_active+p8b-1) .ge. numacq) THEN
      IF (int_mb(k_spin+p7b-1)+int_mb(k_spin+p8b-1) .eq. int_mb(k_spin+h
     &9b-1)+int_mb(k_spin+h10b-1)) THEN
      IF (ieor(int_mb(k_sym+p7b-1),ieor(int_mb(k_sym+p8b-1),ieor(int_mb(
     &k_sym+h9b-1),int_mb(k_sym+h10b-1)))) .eq. irrep_x) THEN
      CALL TCE_RESTRICTED_4(p7b,p8b,h9b,h10b,p7b_1,p8b_1,h9b_1,h10b_1)
      CALL TCE_RESTRICTED_8(h4b,h5b,h9b,h10b,p1b,p3b,p7b,p8b,h4b_2,h5b_2
     &,h9b_2,h10b_2,p1b_2,p3b_2,p7b_2,p8b_2)
      dim_common = int_mb(k_range+p7b-1) * int_mb(k_range+p8b-1) * int_m
     &b(k_range+h9b-1) * int_mb(k_range+h10b-1)
      dima_sort = 1
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h4b-1) * int_mb(k_range+h5b-1) * int_mb
     &(k_range+p1b-1) * int_mb(k_range+p3b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_17_1_2',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_17_1_2',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h10b_
     &1 - 1 + noab * (h9b_1 - 1 + noab * (p8b_1 - noab - 1 + nvab * (p7b
     &_1 - noab - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p7b-1)
     &,int_mb(k_range+p8b-1),int_mb(k_range+h9b-1),int_mb(k_range+h10b-1
     &),4,3,2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_17_
     &1_2',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_17_1_2',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_17_1_2',5,MA_ERR)
      IF ((h10b .lt. h4b) .and. (p8b .lt. p1b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p1b_2 - noab - 1 + nvab * (p8b_2 - noab - 1 
     &+ nvab * (p7b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h4b_2 - 1
     & + noab * (h10b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h10b-1),int_mb(k_range+h4b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+p7b-1),int_mb(k_range+p8b-1),int_mb(k_range+p1b-1
     &),int_mb(k_range+p3b-1),8,7,4,3,2,1,6,5,1.0d0,.false.)
      END IF
      IF ((h10b .lt. h4b) .and. (p7b .lt. p1b) .and. (p1b .le. p8b) .and
     &. (p8b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (p7b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h4b_2 - 1
     & + noab * (h10b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h10b-1),int_mb(k_range+h4b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+p7b-1),int_mb(k_range+p1b-1),int_mb(k_range+p8b-1
     &),int_mb(k_range+p3b-1),8,6,4,3,2,1,7,5,-1.0d0,.false.)
      END IF
      IF ((h10b .lt. h4b) .and. (p7b .lt. p1b) .and. (p3b .le. p8b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (p7b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h4b_2 - 1
     & + noab * (h10b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h10b-1),int_mb(k_range+h4b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+p7b-1),int_mb(k_range+p1b-1),int_mb(k_range+p3b-1
     &),int_mb(k_range+p8b-1),7,6,4,3,2,1,8,5,1.0d0,.false.)
      END IF
      IF ((h10b .lt. h4b) .and. (p1b .le. p7b) .and. (p8b .lt. p3b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p7b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h4b_2 - 1
     & + noab * (h10b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h10b-1),int_mb(k_range+h4b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+p1b-1),int_mb(k_range+p7b-1),int_mb(k_range+p8b-1
     &),int_mb(k_range+p3b-1),8,5,4,3,2,1,7,6,1.0d0,.false.)
      END IF
      IF ((h10b .lt. h4b) .and. (p1b .le. p7b) .and. (p7b .lt. p3b) .and
     &. (p3b .le. p8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p7b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h4b_2 - 1
     & + noab * (h10b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h10b-1),int_mb(k_range+h4b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+p1b-1),int_mb(k_range+p7b-1),int_mb(k_range+p3b-1
     &),int_mb(k_range+p8b-1),7,5,4,3,2,1,8,6,-1.0d0,.false.)
      END IF
      IF ((h10b .lt. h4b) .and. (p3b .le. p7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h4b_2 - 1
     & + noab * (h10b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h10b-1),int_mb(k_range+h4b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+p1b-1),int_mb(k_range+p3b-1),int_mb(k_range+p7b-1
     &),int_mb(k_range+p8b-1),6,5,4,3,2,1,8,7,1.0d0,.false.)
      END IF
      IF ((h9b .lt. h4b) .and. (h4b .le. h10b) .and. (h10b .lt. h5b) .an
     &d. (p8b .lt. p1b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p1b_2 - noab - 1 + nvab * (p8b_2 - noab - 1 
     &+ nvab * (p7b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h4b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h4b-1),int_mb(k_range+h10b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+p7b-1),int_mb(k_range+p8b-1),int_mb(k_range+p1b-1
     &),int_mb(k_range+p3b-1),8,7,4,2,3,1,6,5,-1.0d0,.false.)
      END IF
      IF ((h9b .lt. h4b) .and. (h4b .le. h10b) .and. (h10b .lt. h5b) .an
     &d. (p7b .lt. p1b) .and. (p1b .le. p8b) .and. (p8b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (p7b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h4b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h4b-1),int_mb(k_range+h10b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+p7b-1),int_mb(k_range+p1b-1),int_mb(k_range+p8b-1
     &),int_mb(k_range+p3b-1),8,6,4,2,3,1,7,5,1.0d0,.false.)
      END IF
      IF ((h9b .lt. h4b) .and. (h4b .le. h10b) .and. (h10b .lt. h5b) .an
     &d. (p7b .lt. p1b) .and. (p3b .le. p8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (p7b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h4b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h4b-1),int_mb(k_range+h10b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+p7b-1),int_mb(k_range+p1b-1),int_mb(k_range+p3b-1
     &),int_mb(k_range+p8b-1),7,6,4,2,3,1,8,5,-1.0d0,.false.)
      END IF
      IF ((h9b .lt. h4b) .and. (h4b .le. h10b) .and. (h10b .lt. h5b) .an
     &d. (p1b .le. p7b) .and. (p8b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p7b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h4b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h4b-1),int_mb(k_range+h10b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+p1b-1),int_mb(k_range+p7b-1),int_mb(k_range+p8b-1
     &),int_mb(k_range+p3b-1),8,5,4,2,3,1,7,6,-1.0d0,.false.)
      END IF
      IF ((h9b .lt. h4b) .and. (h4b .le. h10b) .and. (h10b .lt. h5b) .an
     &d. (p1b .le. p7b) .and. (p7b .lt. p3b) .and. (p3b .le. p8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p7b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h4b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h4b-1),int_mb(k_range+h10b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+p1b-1),int_mb(k_range+p7b-1),int_mb(k_range+p3b-1
     &),int_mb(k_range+p8b-1),7,5,4,2,3,1,8,6,1.0d0,.false.)
      END IF
      IF ((h9b .lt. h4b) .and. (h4b .le. h10b) .and. (h10b .lt. h5b) .an
     &d. (p3b .le. p7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h4b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h4b-1),int_mb(k_range+h10b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+p1b-1),int_mb(k_range+p3b-1),int_mb(k_range+p7b-1
     &),int_mb(k_range+p8b-1),6,5,4,2,3,1,8,7,-1.0d0,.false.)
      END IF
      IF ((h9b .lt. h4b) .and. (h5b .le. h10b) .and. (p8b .lt. p1b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p1b_2 - noab - 1 + nvab * (p8b_2 - noab - 1 
     &+ nvab * (p7b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h5b_2 - 
     &1 + noab * (h4b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h4b-1),int_mb(k_range+h5b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p7b-1),int_mb(k_range+p8b-1),int_mb(k_range+p1b-1
     &),int_mb(k_range+p3b-1),8,7,3,2,4,1,6,5,1.0d0,.false.)
      END IF
      IF ((h9b .lt. h4b) .and. (h5b .le. h10b) .and. (p7b .lt. p1b) .and
     &. (p1b .le. p8b) .and. (p8b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (p7b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h5b_2 - 
     &1 + noab * (h4b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h4b-1),int_mb(k_range+h5b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p7b-1),int_mb(k_range+p1b-1),int_mb(k_range+p8b-1
     &),int_mb(k_range+p3b-1),8,6,3,2,4,1,7,5,-1.0d0,.false.)
      END IF
      IF ((h9b .lt. h4b) .and. (h5b .le. h10b) .and. (p7b .lt. p1b) .and
     &. (p3b .le. p8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (p7b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h5b_2 - 
     &1 + noab * (h4b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h4b-1),int_mb(k_range+h5b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p7b-1),int_mb(k_range+p1b-1),int_mb(k_range+p3b-1
     &),int_mb(k_range+p8b-1),7,6,3,2,4,1,8,5,1.0d0,.false.)
      END IF
      IF ((h9b .lt. h4b) .and. (h5b .le. h10b) .and. (p1b .le. p7b) .and
     &. (p8b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p7b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h5b_2 - 
     &1 + noab * (h4b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h4b-1),int_mb(k_range+h5b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p1b-1),int_mb(k_range+p7b-1),int_mb(k_range+p8b-1
     &),int_mb(k_range+p3b-1),8,5,3,2,4,1,7,6,1.0d0,.false.)
      END IF
      IF ((h9b .lt. h4b) .and. (h5b .le. h10b) .and. (p1b .le. p7b) .and
     &. (p7b .lt. p3b) .and. (p3b .le. p8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p7b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h5b_2 - 
     &1 + noab * (h4b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h4b-1),int_mb(k_range+h5b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p1b-1),int_mb(k_range+p7b-1),int_mb(k_range+p3b-1
     &),int_mb(k_range+p8b-1),7,5,3,2,4,1,8,6,-1.0d0,.false.)
      END IF
      IF ((h9b .lt. h4b) .and. (h5b .le. h10b) .and. (p3b .le. p7b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h5b_2 - 
     &1 + noab * (h4b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h4b-1),int_mb(k_range+h5b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p1b-1),int_mb(k_range+p3b-1),int_mb(k_range+p7b-1
     &),int_mb(k_range+p8b-1),6,5,3,2,4,1,8,7,1.0d0,.false.)
      END IF
      IF ((h4b .le. h9b) .and. (h10b .lt. h5b) .and. (p8b .lt. p1b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p1b_2 - noab - 1 + nvab * (p8b_2 - noab - 1 
     &+ nvab * (p7b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h9b_2 - 1 + noab * (h4b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h10b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+p7b-1),int_mb(k_range+p8b-1),int_mb(k_range+p1b-1
     &),int_mb(k_range+p3b-1),8,7,4,1,3,2,6,5,1.0d0,.false.)
      END IF
      IF ((h4b .le. h9b) .and. (h10b .lt. h5b) .and. (p7b .lt. p1b) .and
     &. (p1b .le. p8b) .and. (p8b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (p7b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h9b_2 - 1 + noab * (h4b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h10b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+p7b-1),int_mb(k_range+p1b-1),int_mb(k_range+p8b-1
     &),int_mb(k_range+p3b-1),8,6,4,1,3,2,7,5,-1.0d0,.false.)
      END IF
      IF ((h4b .le. h9b) .and. (h10b .lt. h5b) .and. (p7b .lt. p1b) .and
     &. (p3b .le. p8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (p7b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h9b_2 - 1 + noab * (h4b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h10b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+p7b-1),int_mb(k_range+p1b-1),int_mb(k_range+p3b-1
     &),int_mb(k_range+p8b-1),7,6,4,1,3,2,8,5,1.0d0,.false.)
      END IF
      IF ((h4b .le. h9b) .and. (h10b .lt. h5b) .and. (p1b .le. p7b) .and
     &. (p8b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p7b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h9b_2 - 1 + noab * (h4b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h10b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+p1b-1),int_mb(k_range+p7b-1),int_mb(k_range+p8b-1
     &),int_mb(k_range+p3b-1),8,5,4,1,3,2,7,6,1.0d0,.false.)
      END IF
      IF ((h4b .le. h9b) .and. (h10b .lt. h5b) .and. (p1b .le. p7b) .and
     &. (p7b .lt. p3b) .and. (p3b .le. p8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p7b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h9b_2 - 1 + noab * (h4b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h10b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+p1b-1),int_mb(k_range+p7b-1),int_mb(k_range+p3b-1
     &),int_mb(k_range+p8b-1),7,5,4,1,3,2,8,6,-1.0d0,.false.)
      END IF
      IF ((h4b .le. h9b) .and. (h10b .lt. h5b) .and. (p3b .le. p7b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h9b_2 - 1 + noab * (h4b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h10b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+p1b-1),int_mb(k_range+p3b-1),int_mb(k_range+p7b-1
     &),int_mb(k_range+p8b-1),6,5,4,1,3,2,8,7,1.0d0,.false.)
      END IF
      IF ((h4b .le. h9b) .and. (h9b .lt. h5b) .and. (h5b .le. h10b) .and
     &. (p8b .lt. p1b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p1b_2 - noab - 1 + nvab * (p8b_2 - noab - 1 
     &+ nvab * (p7b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h5b_2 - 
     &1 + noab * (h9b_2 - 1 + noab * (h4b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h5b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p7b-1),int_mb(k_range+p8b-1),int_mb(k_range+p1b-1
     &),int_mb(k_range+p3b-1),8,7,3,1,4,2,6,5,-1.0d0,.false.)
      END IF
      IF ((h4b .le. h9b) .and. (h9b .lt. h5b) .and. (h5b .le. h10b) .and
     &. (p7b .lt. p1b) .and. (p1b .le. p8b) .and. (p8b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (p7b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h5b_2 - 
     &1 + noab * (h9b_2 - 1 + noab * (h4b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h5b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p7b-1),int_mb(k_range+p1b-1),int_mb(k_range+p8b-1
     &),int_mb(k_range+p3b-1),8,6,3,1,4,2,7,5,1.0d0,.false.)
      END IF
      IF ((h4b .le. h9b) .and. (h9b .lt. h5b) .and. (h5b .le. h10b) .and
     &. (p7b .lt. p1b) .and. (p3b .le. p8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (p7b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h5b_2 - 
     &1 + noab * (h9b_2 - 1 + noab * (h4b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h5b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p7b-1),int_mb(k_range+p1b-1),int_mb(k_range+p3b-1
     &),int_mb(k_range+p8b-1),7,6,3,1,4,2,8,5,-1.0d0,.false.)
      END IF
      IF ((h4b .le. h9b) .and. (h9b .lt. h5b) .and. (h5b .le. h10b) .and
     &. (p1b .le. p7b) .and. (p8b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p7b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h5b_2 - 
     &1 + noab * (h9b_2 - 1 + noab * (h4b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h5b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p1b-1),int_mb(k_range+p7b-1),int_mb(k_range+p8b-1
     &),int_mb(k_range+p3b-1),8,5,3,1,4,2,7,6,-1.0d0,.false.)
      END IF
      IF ((h4b .le. h9b) .and. (h9b .lt. h5b) .and. (h5b .le. h10b) .and
     &. (p1b .le. p7b) .and. (p7b .lt. p3b) .and. (p3b .le. p8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p7b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h5b_2 - 
     &1 + noab * (h9b_2 - 1 + noab * (h4b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h5b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p1b-1),int_mb(k_range+p7b-1),int_mb(k_range+p3b-1
     &),int_mb(k_range+p8b-1),7,5,3,1,4,2,8,6,1.0d0,.false.)
      END IF
      IF ((h4b .le. h9b) .and. (h9b .lt. h5b) .and. (h5b .le. h10b) .and
     &. (p3b .le. p7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h5b_2 - 
     &1 + noab * (h9b_2 - 1 + noab * (h4b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h5b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p1b-1),int_mb(k_range+p3b-1),int_mb(k_range+p7b-1
     &),int_mb(k_range+p8b-1),6,5,3,1,4,2,8,7,-1.0d0,.false.)
      END IF
      IF ((h5b .le. h9b) .and. (p8b .lt. p1b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p1b_2 - noab - 1 + nvab * (p8b_2 - noab - 1 
     &+ nvab * (p7b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h9b_2 - 
     &1 + noab * (h5b_2 - 1 + noab * (h4b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h9b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p7b-1),int_mb(k_range+p8b-1),int_mb(k_range+p1b-1
     &),int_mb(k_range+p3b-1),8,7,2,1,4,3,6,5,1.0d0,.false.)
      END IF
      IF ((h5b .le. h9b) .and. (p7b .lt. p1b) .and. (p1b .le. p8b) .and.
     & (p8b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (p7b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h9b_2 - 
     &1 + noab * (h5b_2 - 1 + noab * (h4b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h9b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p7b-1),int_mb(k_range+p1b-1),int_mb(k_range+p8b-1
     &),int_mb(k_range+p3b-1),8,6,2,1,4,3,7,5,-1.0d0,.false.)
      END IF
      IF ((h5b .le. h9b) .and. (p7b .lt. p1b) .and. (p3b .le. p8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (p7b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h9b_2 - 
     &1 + noab * (h5b_2 - 1 + noab * (h4b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h9b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p7b-1),int_mb(k_range+p1b-1),int_mb(k_range+p3b-1
     &),int_mb(k_range+p8b-1),7,6,2,1,4,3,8,5,1.0d0,.false.)
      END IF
      IF ((h5b .le. h9b) .and. (p1b .le. p7b) .and. (p8b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p7b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h9b_2 - 
     &1 + noab * (h5b_2 - 1 + noab * (h4b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h9b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p1b-1),int_mb(k_range+p7b-1),int_mb(k_range+p8b-1
     &),int_mb(k_range+p3b-1),8,5,2,1,4,3,7,6,1.0d0,.false.)
      END IF
      IF ((h5b .le. h9b) .and. (p1b .le. p7b) .and. (p7b .lt. p3b) .and.
     & (p3b .le. p8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p7b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h9b_2 - 
     &1 + noab * (h5b_2 - 1 + noab * (h4b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h9b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p1b-1),int_mb(k_range+p7b-1),int_mb(k_range+p3b-1
     &),int_mb(k_range+p8b-1),7,5,2,1,4,3,8,6,-1.0d0,.false.)
      END IF
      IF ((h5b .le. h9b) .and. (p3b .le. p7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h9b_2 - 
     &1 + noab * (h5b_2 - 1 + noab * (h4b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h9b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p1b-1),int_mb(k_range+p3b-1),int_mb(k_range+p7b-1
     &),int_mb(k_range+p8b-1),6,5,2,1,4,3,8,7,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_17_
     &1_2',6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      isuperp = 1
      IF (p7b .eq. p8b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      nsubh(1) = 1
      nsubh(2) = 1
      isubh = 1
      IF (h9b .eq. h10b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,4.0d0/FACTOR
     &IAL(nsuperp(1))/FACTORIAL(nsuperp(2))/FACTORIAL(nsubh(1))/FACTORIA
     &L(nsubh(2)),dbl_mb(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_commo
     &n,1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_17_1_2',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_17_1_2',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_17_1_2',9,MA_ERR)
      CALL TCE_SORT_4(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p1b-1),int_mb(k_range+h5b-1),int_mb(k_range+h4b-1)
     &,4,3,2,1,-1.0d0/4.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p3b -
     & noab - 1 + nvab * (p1b - noab - 1 + nvab * (h5b - 1 + noab * (h4b
     & - 1)))))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_17_
     &1_2',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_17_1_2',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_17_2(d_a,k_a_offset,d_b,k_b_offset
     &,d_c,k_c_offset)
C     i2 ( p12 p1 )_yxt + = 1/6 * Sum ( h5 h6 h7 p3 p4 ) * t ( p3 p4 p12 h5 h6 h7 )_t * i3 ( h5 h6 h7 p1 p3 p4 )_yx
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER p12b
      INTEGER p1b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p3b
      INTEGER p4b
      INTEGER h5b
      INTEGER h6b
      INTEGER h7b
      INTEGER p12b_1
      INTEGER p3b_1
      INTEGER p4b_1
      INTEGER h5b_1
      INTEGER h6b_1
      INTEGER h7b_1
      INTEGER h5b_2
      INTEGER h6b_2
      INTEGER h7b_2
      INTEGER p1b_2
      INTEGER p3b_2
      INTEGER p4b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(2)
      INTEGER isuperp
      INTEGER nsubh(3)
      INTEGER isubh
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO p12b = noab+1,noab+nvab
      DO p1b = noab+1,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+p12b-1)+int_mb(k_spin+p1b-
     &1).ne.4)) THEN
      IF (int_mb(k_spin+p12b-1) .eq. int_mb(k_spin+p1b-1)) THEN
      IF (ieor(int_mb(k_sym+p12b-1),int_mb(k_sym+p1b-1)) .eq. ieor(irrep
     &_y,ieor(irrep_x,irrep_t))) THEN
      dimc = int_mb(k_range+p12b-1) * int_mb(k_range+p1b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_17_2',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      DO h5b = 1,noab
      DO h6b = h5b,noab
      DO h7b = h6b,noab
      IF (int_mb(k_active+p12b-1)+int_mb(k_active+p3b-1)+int_mb(k_active
     &+p4b-1) .ge. numact) THEN
      IF (int_mb(k_active+h5b-1)+int_mb(k_active+h6b-1)+int_mb(k_active+
     &h7b-1) .ge. numact) THEN
      IF (int_mb(k_spin+p12b-1)+int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1
     &) .eq. int_mb(k_spin+h5b-1)+int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b
     &-1)) THEN
      IF (ieor(int_mb(k_sym+p12b-1),ieor(int_mb(k_sym+p3b-1),ieor(int_mb
     &(k_sym+p4b-1),ieor(int_mb(k_sym+h5b-1),ieor(int_mb(k_sym+h6b-1),in
     &t_mb(k_sym+h7b-1)))))) .eq. irrep_t) THEN
      CALL TCE_RESTRICTED_6(p12b,p3b,p4b,h5b,h6b,h7b,p12b_1,p3b_1,p4b_1,
     &h5b_1,h6b_1,h7b_1)
      CALL TCE_RESTRICTED_6(h5b,h6b,h7b,p1b,p3b,p4b,h5b_2,h6b_2,h7b_2,p1
     &b_2,p3b_2,p4b_2)
      dim_common = int_mb(k_range+p3b-1) * int_mb(k_range+p4b-1) * int_m
     &b(k_range+h5b-1) * int_mb(k_range+h6b-1) * int_mb(k_range+h7b-1)
      dima_sort = int_mb(k_range+p12b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+p1b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_17_2',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_17_2',2,MA_ERR)
      IF ((p4b .le. p12b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h7b_1
     & - 1 + noab * (h6b_1 - 1 + noab * (h5b_1 - 1 + noab * (p12b_1 - no
     &ab - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p12b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),3,6,5,4,2,1,1.0d0,.f
     &alse.)
      END IF
      IF ((p3b .le. p12b) .and. (p12b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h7b_1
     & - 1 + noab * (h6b_1 - 1 + noab * (h5b_1 - 1 + noab * (p4b_1 - noa
     &b - 1 + nvab * (p12b_1 - noab - 1 + nvab * (p3b_1 - noab - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p12b-1),int_mb(k_range+p4b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),2,6,5,4,3,1,-1.0d0,.
     &false.)
      END IF
      IF ((p12b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h7b_1
     & - 1 + noab * (h6b_1 - 1 + noab * (h5b_1 - 1 + noab * (p4b_1 - noa
     &b - 1 + nvab * (p3b_1 - noab - 1 + nvab * (p12b_1 - noab - 1))))))
     &)
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p12b-1
     &),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+h5b-1
     &),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),1,6,5,4,3,2,1.0d0,.f
     &alse.)
      END IF
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_17_
     &2',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_17_2',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_17_2',5,MA_ERR)
      IF ((p4b .lt. p1b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p1b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h7b_2 - 1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p1b-1),6,3,2,1,5,4,1.0d0,.fa
     &lse.)
      END IF
      IF ((p3b .lt. p1b) .and. (p1b .le. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p1b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h7b_2 - 1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p1b-1),int_mb(k_range+p4b-1),5,3,2,1,6,4,-1.0d0,.f
     &alse.)
      END IF
      IF ((p1b .le. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (h7b_2 - 1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+p1b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),4,3,2,1,6,5,1.0d0,.fa
     &lse.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_17_
     &2',6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      isuperp = 1
      IF (p3b .eq. p4b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      nsubh(1) = 1
      nsubh(2) = 1
      nsubh(3) = 1
      isubh = 1
      IF (h5b .eq. h6b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      IF (h6b .eq. h7b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,12.0d0/FACTO
     &RIAL(nsuperp(1))/FACTORIAL(nsuperp(2))/FACTORIAL(nsubh(1))/FACTORI
     &AL(nsubh(2))/FACTORIAL(nsubh(3)),dbl_mb(k_a_sort),dim_common,dbl_m
     &b(k_b_sort),dim_common,1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_17_2',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_17_2',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_17_2',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p1b-1)
     &,int_mb(k_range+p12b-1),2,1,1.0d0/6.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p1b -
     & noab - 1 + nvab * (p12b - noab - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_17_
     &2',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_17_2',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_5_17_2_1(d_a,k_a_offset,d_b,k_b_offs
     &et,d_c,k_c_offset)
C     i3 ( h5 h6 h7 p1 p3 p4 )_yx + = 1 * Sum ( h10 p9 ) * x ( p9 h10 )_x * y ( h5 h6 h7 h10 p1 p3 p4 p9 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h5b
      INTEGER h6b
      INTEGER h7b
      INTEGER p1b
      INTEGER p3b
      INTEGER p4b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p9b
      INTEGER h10b
      INTEGER p9b_1
      INTEGER h10b_1
      INTEGER h5b_2
      INTEGER h6b_2
      INTEGER h7b_2
      INTEGER h10b_2
      INTEGER p1b_2
      INTEGER p3b_2
      INTEGER p4b_2
      INTEGER p9b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h5b = 1,noab
      DO h6b = h5b,noab
      DO h7b = h6b,noab
      DO p1b = noab+1,noab+nvab
      DO p3b = p1b,noab+nvab
      DO p4b = p3b,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h5b-1)+int_mb(k_spin+h6b-1
     &)+int_mb(k_spin+h7b-1)+int_mb(k_spin+p1b-1)+int_mb(k_spin+p3b-1)+i
     &nt_mb(k_spin+p4b-1).ne.12)) THEN
      IF (int_mb(k_spin+h5b-1)+int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b-1)
     & .eq. int_mb(k_spin+p1b-1)+int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-
     &1)) THEN
      IF (ieor(int_mb(k_sym+h5b-1),ieor(int_mb(k_sym+h6b-1),ieor(int_mb(
     &k_sym+h7b-1),ieor(int_mb(k_sym+p1b-1),ieor(int_mb(k_sym+p3b-1),int
     &_mb(k_sym+p4b-1)))))) .eq. ieor(irrep_y,irrep_x)) THEN
      dimc = int_mb(k_range+h5b-1) * int_mb(k_range+h6b-1) * int_mb(k_ra
     &nge+h7b-1) * int_mb(k_range+p1b-1) * int_mb(k_range+p3b-1) * int_m
     &b(k_range+p4b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_17_2_1',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p9b = noab+1,noab+nvab
      DO h10b = 1,noab
      IF (int_mb(k_active+h5b-1)+int_mb(k_active+h6b-1)+int_mb(k_active+
     &h7b-1)+int_mb(k_active+h10b-1) .ge. numacq) THEN
      IF (int_mb(k_active+p1b-1)+int_mb(k_active+p3b-1)+int_mb(k_active+
     &p4b-1)+int_mb(k_active+p9b-1) .ge. numacq) THEN
      IF (int_mb(k_spin+p9b-1) .eq. int_mb(k_spin+h10b-1)) THEN
      IF (ieor(int_mb(k_sym+p9b-1),int_mb(k_sym+h10b-1)) .eq. irrep_x) T
     &HEN
      CALL TCE_RESTRICTED_2(p9b,h10b,p9b_1,h10b_1)
      CALL TCE_RESTRICTED_8(h5b,h6b,h7b,h10b,p1b,p3b,p4b,p9b,h5b_2,h6b_2
     &,h7b_2,h10b_2,p1b_2,p3b_2,p4b_2,p9b_2)
      dim_common = int_mb(k_range+p9b-1) * int_mb(k_range+h10b-1)
      dima_sort = 1
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h5b-1) * int_mb(k_range+h6b-1) * int_mb
     &(k_range+h7b-1) * int_mb(k_range+p1b-1) * int_mb(k_range+p3b-1) * 
     &int_mb(k_range+p4b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_17_2_1',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_5_17_2_1',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h10b_
     &1 - 1 + noab * (p9b_1 - noab - 1)))
      CALL TCE_SORT_2(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p9b-1)
     &,int_mb(k_range+h10b-1),2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_5_17_
     &2_1',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_5_17_2_1',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_5_17_2_1',5,MA_ERR)
      IF ((h10b .lt. h5b) .and. (p9b .lt. p1b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (p9b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 1
     & + noab * (h5b_2 - 1 + noab * (h10b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h10b-1
     &),int_mb(k_range+h5b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p9b-1),int_mb(k_range+p1b-1),int_mb(k_range+p3b-1
     &),int_mb(k_range+p4b-1),8,7,6,4,3,2,1,5,1.0d0,.false.)
      END IF
      IF ((h10b .lt. h5b) .and. (p1b .le. p9b) .and. (p9b .lt. p3b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p9b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 1
     & + noab * (h5b_2 - 1 + noab * (h10b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h10b-1
     &),int_mb(k_range+h5b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p1b-1),int_mb(k_range+p9b-1),int_mb(k_range+p3b-1
     &),int_mb(k_range+p4b-1),8,7,5,4,3,2,1,6,-1.0d0,.false.)
      END IF
      IF ((h10b .lt. h5b) .and. (p3b .le. p9b) .and. (p9b .lt. p4b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p9b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 1
     & + noab * (h5b_2 - 1 + noab * (h10b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h10b-1
     &),int_mb(k_range+h5b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p1b-1),int_mb(k_range+p3b-1),int_mb(k_range+p9b-1
     &),int_mb(k_range+p4b-1),8,6,5,4,3,2,1,7,1.0d0,.false.)
      END IF
      IF ((h10b .lt. h5b) .and. (p4b .le. p9b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p9b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 1
     & + noab * (h5b_2 - 1 + noab * (h10b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h10b-1
     &),int_mb(k_range+h5b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p1b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p9b-1),7,6,5,4,3,2,1,8,-1.0d0,.false.)
      END IF
      IF ((h5b .le. h10b) .and. (h10b .lt. h6b) .and. (p9b .lt. p1b)) TH
     &EN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (p9b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 1
     & + noab * (h10b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h10b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p9b-1),int_mb(k_range+p1b-1),int_mb(k_range+p3b-1
     &),int_mb(k_range+p4b-1),8,7,6,4,3,1,2,5,-1.0d0,.false.)
      END IF
      IF ((h5b .le. h10b) .and. (h10b .lt. h6b) .and. (p1b .le. p9b) .an
     &d. (p9b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p9b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 1
     & + noab * (h10b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h10b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p1b-1),int_mb(k_range+p9b-1),int_mb(k_range+p3b-1
     &),int_mb(k_range+p4b-1),8,7,5,4,3,1,2,6,1.0d0,.false.)
      END IF
      IF ((h5b .le. h10b) .and. (h10b .lt. h6b) .and. (p3b .le. p9b) .an
     &d. (p9b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p9b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 1
     & + noab * (h10b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h10b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p1b-1),int_mb(k_range+p3b-1),int_mb(k_range+p9b-1
     &),int_mb(k_range+p4b-1),8,6,5,4,3,1,2,7,-1.0d0,.false.)
      END IF
      IF ((h5b .le. h10b) .and. (h10b .lt. h6b) .and. (p4b .le. p9b)) TH
     &EN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p9b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 1
     & + noab * (h10b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h10b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p1b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p9b-1),7,6,5,4,3,1,2,8,1.0d0,.false.)
      END IF
      IF ((h6b .le. h10b) .and. (h10b .lt. h7b) .and. (p9b .lt. p1b)) TH
     &EN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (p9b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h10b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p9b-1),int_mb(k_range+p1b-1),int_mb(k_range+p3b-1
     &),int_mb(k_range+p4b-1),8,7,6,4,2,1,3,5,1.0d0,.false.)
      END IF
      IF ((h6b .le. h10b) .and. (h10b .lt. h7b) .and. (p1b .le. p9b) .an
     &d. (p9b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p9b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h10b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p1b-1),int_mb(k_range+p9b-1),int_mb(k_range+p3b-1
     &),int_mb(k_range+p4b-1),8,7,5,4,2,1,3,6,-1.0d0,.false.)
      END IF
      IF ((h6b .le. h10b) .and. (h10b .lt. h7b) .and. (p3b .le. p9b) .an
     &d. (p9b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p9b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h10b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p1b-1),int_mb(k_range+p3b-1),int_mb(k_range+p9b-1
     &),int_mb(k_range+p4b-1),8,6,5,4,2,1,3,7,1.0d0,.false.)
      END IF
      IF ((h6b .le. h10b) .and. (h10b .lt. h7b) .and. (p4b .le. p9b)) TH
     &EN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p9b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h10b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h10b-1),int_mb(k_range+h7b-1
     &),int_mb(k_range+p1b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p9b-1),7,6,5,4,2,1,3,8,-1.0d0,.false.)
      END IF
      IF ((h7b .le. h10b) .and. (p9b .lt. p1b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (p9b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h7b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p9b-1),int_mb(k_range+p1b-1),int_mb(k_range+p3b-1
     &),int_mb(k_range+p4b-1),8,7,6,3,2,1,4,5,-1.0d0,.false.)
      END IF
      IF ((h7b .le. h10b) .and. (p1b .le. p9b) .and. (p9b .lt. p3b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p9b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h7b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p1b-1),int_mb(k_range+p9b-1),int_mb(k_range+p3b-1
     &),int_mb(k_range+p4b-1),8,7,5,3,2,1,4,6,1.0d0,.false.)
      END IF
      IF ((h7b .le. h10b) .and. (p3b .le. p9b) .and. (p9b .lt. p4b)) THE
     &N
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p9b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h7b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p1b-1),int_mb(k_range+p3b-1),int_mb(k_range+p9b-1
     &),int_mb(k_range+p4b-1),8,6,5,3,2,1,4,7,-1.0d0,.false.)
      END IF
      IF ((h7b .le. h10b) .and. (p4b .le. p9b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p9b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h10b_2 - 1 + noab * (h7b_2 - 
     &1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h10b-1
     &),int_mb(k_range+p1b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1
     &),int_mb(k_range+p9b-1),7,6,5,3,2,1,4,8,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_5_17_
     &2_1',6,MA_ERR)
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,1.0d0,dbl_mb
     &(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c
     &_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_17_2_1',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_17_2_1',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_5_17_2_1',9,MA_ERR)
      CALL TCE_SORT_6(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p1b-1),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h5b-1),6,5,4,3,2,1,1.0d0,.fa
     &lse.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p4b -
     & noab - 1 + nvab * (p3b - noab - 1 + nvab * (p1b - noab - 1 + nvab
     & * (h7b - 1 + noab * (h6b - 1 + noab * (h5b - 1)))))))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_5_17_
     &2_1',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &5_17_2_1',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE OFFSET_eomccsdtq_density1_5_17_2_1(l_a_offset,k_a_offse
     &t,size)
C     i3 ( h5 h6 h7 p1 p3 p4 )_yx
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER l_a_offset
      INTEGER k_a_offset
      INTEGER length
      INTEGER addr
      INTEGER h5b
      INTEGER h6b
      INTEGER h7b
      INTEGER p1b
      INTEGER p3b
      INTEGER p4b
      DOUBLE PRECISION size
      length = 0
      DO h5b = 1,noab
      DO h6b = h5b,noab
      DO h7b = h6b,noab
      DO p1b = noab+1,noab+nvab
      DO p3b = p1b,noab+nvab
      DO p4b = p3b,noab+nvab
      IF (int_mb(k_spin+h5b-1)+int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b-1)
     & .eq. int_mb(k_spin+p1b-1)+int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-
     &1)) THEN
      IF (ieor(int_mb(k_sym+h5b-1),ieor(int_mb(k_sym+h6b-1),ieor(int_mb(
     &k_sym+h7b-1),ieor(int_mb(k_sym+p1b-1),ieor(int_mb(k_sym+p3b-1),int
     &_mb(k_sym+p4b-1)))))) .eq. ieor(irrep_y,irrep_x)) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h5b-1)+int_mb(k_spin+h6b-1
     &)+int_mb(k_spin+h7b-1)+int_mb(k_spin+p1b-1)+int_mb(k_spin+p3b-1)+i
     &nt_mb(k_spin+p4b-1).ne.12)) THEN
      length = length + 1
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,2*length+1,'noname',l_a_offset,k_a_off
     &set)) CALL ERRQUIT('eomccsdtq_density1_5_17_2_1',0,MA_ERR)
      dbl_mb(k_a_offset) = dfloat(length)
      addr = 0
      size = 0.0d0
      DO h5b = 1,noab
      DO h6b = h5b,noab
      DO h7b = h6b,noab
      DO p1b = noab+1,noab+nvab
      DO p3b = p1b,noab+nvab
      DO p4b = p3b,noab+nvab
      IF (int_mb(k_spin+h5b-1)+int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b-1)
     & .eq. int_mb(k_spin+p1b-1)+int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-
     &1)) THEN
      IF (ieor(int_mb(k_sym+h5b-1),ieor(int_mb(k_sym+h6b-1),ieor(int_mb(
     &k_sym+h7b-1),ieor(int_mb(k_sym+p1b-1),ieor(int_mb(k_sym+p3b-1),int
     &_mb(k_sym+p4b-1)))))) .eq. ieor(irrep_y,irrep_x)) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h5b-1)+int_mb(k_spin+h6b-1
     &)+int_mb(k_spin+h7b-1)+int_mb(k_spin+p1b-1)+int_mb(k_spin+p3b-1)+i
     &nt_mb(k_spin+p4b-1).ne.12)) THEN
      addr = addr + 1
      dbl_mb(k_a_offset+addr) = dfloat(p4b - noab - 1 + nvab * (p3b - no
     &ab - 1 + nvab * (p1b - noab - 1 + nvab * (h7b - 1 + noab * (h6b - 
     &1 + noab * (h5b - 1))))))
      dbl_mb(k_a_offset+length+addr) = size
      size = size + dfloat(int_mb(k_range+h5b-1)) * dfloat(int_mb(k_rang
     &e+h6b-1)) * dfloat(int_mb(k_range+h7b-1)) * dfloat(int_mb(k_range+
     &p1b-1)) * dfloat(int_mb(k_range+p3b-1)) * dfloat(int_mb(k_range+p4
     &b-1))
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_6(d_a,k_a_offset,d_b,k_b_offset,d_c,
     &k_c_offset)
C     i0 ( )_yxd + = -1/2 * Sum ( p2 p1 ) * d ( p1 p2 )_d * i1 ( p2 p1 )_yx
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p1b
      INTEGER p2b
      INTEGER p1b_1
      INTEGER p2b_1
      INTEGER p2b_2
      INTEGER p1b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      IF (next .eq. count) THEN
      IF (0 .eq. ieor(irrep_y,ieor(irrep_x,irrep_d))) THEN
      dimc = 1
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_6',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p1b = noab+1,noab+nvab
      DO p2b = noab+1,noab+nvab
      IF (int_mb(k_spin+p1b-1) .eq. int_mb(k_spin+p2b-1)) THEN
      IF (ieor(int_mb(k_sym+p1b-1),int_mb(k_sym+p2b-1)) .eq. irrep_d) TH
     &EN
      CALL TCE_RESTRICTED_2(p1b,p2b,p1b_1,p2b_1)
      CALL TCE_RESTRICTED_2(p2b,p1b,p2b_2,p1b_2)
      dim_common = int_mb(k_range+p1b-1) * int_mb(k_range+p2b-1)
      dima_sort = 1
      dima = dim_common * dima_sort
      dimb_sort = 1
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_6',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_6',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(p2b_1
     & - 1 + (noab+nvab) * (p1b_1 - 1)))
      CALL TCE_SORT_2(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p1b-1)
     &,int_mb(k_range+p2b-1),2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_6',3,
     &MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_6',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_6',5,MA_ERR)
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p1b_2
     & - noab - 1 + nvab * (p2b_2 - noab - 1)))
      CALL TCE_SORT_2(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+p2b-1)
     &,int_mb(k_range+p1b-1),1,2,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_6',6,
     &MA_ERR)
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,1.0d0,dbl_mb
     &(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c
     &_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &6',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &6',8,MA_ERR)
      END IF
      END IF
      END IF
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_6',9,MA_ERR)
      CALL TCE_SORT_0(dbl_mb(k_c_sort),dbl_mb(k_c),-1.0d0/2.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),0)
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_6',10
     &,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &6',11,MA_ERR)
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_6_1(d_a,k_a_offset,d_b,k_b_offset,d_
     &c,k_c_offset)
C     i1 ( p2 p1 )_yx + = -1 * Sum ( h5 h4 p3 ) * x ( p2 p3 h4 h5 )_x * y ( h4 h5 p1 p3 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER p2b
      INTEGER p1b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p3b
      INTEGER h4b
      INTEGER h5b
      INTEGER p2b_1
      INTEGER p3b_1
      INTEGER h4b_1
      INTEGER h5b_1
      INTEGER h4b_2
      INTEGER h5b_2
      INTEGER p1b_2
      INTEGER p3b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsubh(2)
      INTEGER isubh
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO p2b = noab+1,noab+nvab
      DO p1b = noab+1,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+p2b-1)+int_mb(k_spin+p1b-1
     &).ne.4)) THEN
      IF (int_mb(k_spin+p2b-1) .eq. int_mb(k_spin+p1b-1)) THEN
      IF (ieor(int_mb(k_sym+p2b-1),int_mb(k_sym+p1b-1)) .eq. ieor(irrep_
     &y,irrep_x)) THEN
      dimc = int_mb(k_range+p2b-1) * int_mb(k_range+p1b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_6_1',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p3b = noab+1,noab+nvab
      DO h4b = 1,noab
      DO h5b = h4b,noab
      IF (int_mb(k_spin+p2b-1)+int_mb(k_spin+p3b-1) .eq. int_mb(k_spin+h
     &4b-1)+int_mb(k_spin+h5b-1)) THEN
      IF (ieor(int_mb(k_sym+p2b-1),ieor(int_mb(k_sym+p3b-1),ieor(int_mb(
     &k_sym+h4b-1),int_mb(k_sym+h5b-1)))) .eq. irrep_x) THEN
      CALL TCE_RESTRICTED_4(p2b,p3b,h4b,h5b,p2b_1,p3b_1,h4b_1,h5b_1)
      CALL TCE_RESTRICTED_4(h4b,h5b,p1b,p3b,h4b_2,h5b_2,p1b_2,p3b_2)
      dim_common = int_mb(k_range+p3b-1) * int_mb(k_range+h4b-1) * int_m
     &b(k_range+h5b-1)
      dima_sort = int_mb(k_range+p2b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+p1b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_6_1',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_6_1',2,MA_ERR)
      IF ((p3b .lt. p2b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h5b_1
     & - 1 + noab * (h4b_1 - 1 + noab * (p2b_1 - noab - 1 + nvab * (p3b_
     &1 - noab - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p2b-1),int_mb(k_range+h4b-1),int_mb(k_range+h5b-1)
     &,2,4,3,1,-1.0d0,.false.)
      END IF
      IF ((p2b .le. p3b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h5b_1
     & - 1 + noab * (h4b_1 - 1 + noab * (p3b_1 - noab - 1 + nvab * (p2b_
     &1 - noab - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p2b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+h4b-1),int_mb(k_range+h5b-1)
     &,1,4,3,2,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_6_1',
     &3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_6_1',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_6_1',5,MA_ERR)
      IF ((p3b .lt. p1b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p1b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab 
     &* (h4b_2 - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+p3b-1),int_mb(k_range+p1b-1)
     &,4,2,1,3,-1.0d0,.false.)
      END IF
      IF ((p1b .le. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p1b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab 
     &* (h4b_2 - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+p1b-1),int_mb(k_range+p3b-1)
     &,3,2,1,4,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_6_1',
     &6,MA_ERR)
      nsubh(1) = 1
      nsubh(2) = 1
      isubh = 1
      IF (h4b .eq. h5b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,2.0d0/FACTOR
     &IAL(nsubh(1))/FACTORIAL(nsubh(2)),dbl_mb(k_a_sort),dim_common,dbl_
     &mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &6_1',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &6_1',8,MA_ERR)
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_6_1',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p1b-1)
     &,int_mb(k_range+p2b-1),2,1,-1.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p1b -
     & noab - 1 + nvab * (p2b - noab - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_6_1',
     &10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &6_1',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE OFFSET_eomccsdtq_density1_6_1(l_a_offset,k_a_offset,siz
     &e)
C     i1 ( p2 p1 )_yx
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER l_a_offset
      INTEGER k_a_offset
      INTEGER length
      INTEGER addr
      INTEGER p2b
      INTEGER p1b
      DOUBLE PRECISION size
      length = 0
      DO p2b = noab+1,noab+nvab
      DO p1b = noab+1,noab+nvab
      IF (int_mb(k_spin+p2b-1) .eq. int_mb(k_spin+p1b-1)) THEN
      IF (ieor(int_mb(k_sym+p2b-1),int_mb(k_sym+p1b-1)) .eq. ieor(irrep_
     &y,irrep_x)) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+p2b-1)+int_mb(k_spin+p1b-1
     &).ne.4)) THEN
      length = length + 1
      END IF
      END IF
      END IF
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,2*length+1,'noname',l_a_offset,k_a_off
     &set)) CALL ERRQUIT('eomccsdtq_density1_6_1',0,MA_ERR)
      dbl_mb(k_a_offset) = dfloat(length)
      addr = 0
      size = 0.0d0
      DO p2b = noab+1,noab+nvab
      DO p1b = noab+1,noab+nvab
      IF (int_mb(k_spin+p2b-1) .eq. int_mb(k_spin+p1b-1)) THEN
      IF (ieor(int_mb(k_sym+p2b-1),int_mb(k_sym+p1b-1)) .eq. ieor(irrep_
     &y,irrep_x)) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+p2b-1)+int_mb(k_spin+p1b-1
     &).ne.4)) THEN
      addr = addr + 1
      dbl_mb(k_a_offset+addr) = dfloat(p1b - noab - 1 + nvab * (p2b - no
     &ab - 1))
      dbl_mb(k_a_offset+length+addr) = size
      size = size + dfloat(int_mb(k_range+p2b-1)) * dfloat(int_mb(k_rang
     &e+p1b-1))
      END IF
      END IF
      END IF
      END DO
      END DO
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_6_2(d_a,k_a_offset,d_b,k_b_offset,d_
     &c,k_c_offset)
C     i1 ( p2 p1 )_yx + = -1/6 * Sum ( h7 h6 h5 p4 p3 ) * x ( p2 p3 p4 h5 h6 h7 )_x * y ( h5 h6 h7 p1 p3 p4 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER p2b
      INTEGER p1b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p3b
      INTEGER p4b
      INTEGER h5b
      INTEGER h6b
      INTEGER h7b
      INTEGER p2b_1
      INTEGER p3b_1
      INTEGER p4b_1
      INTEGER h5b_1
      INTEGER h6b_1
      INTEGER h7b_1
      INTEGER h5b_2
      INTEGER h6b_2
      INTEGER h7b_2
      INTEGER p1b_2
      INTEGER p3b_2
      INTEGER p4b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(2)
      INTEGER isuperp
      INTEGER nsubh(3)
      INTEGER isubh
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO p2b = noab+1,noab+nvab
      DO p1b = noab+1,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+p2b-1)+int_mb(k_spin+p1b-1
     &).ne.4)) THEN
      IF (int_mb(k_spin+p2b-1) .eq. int_mb(k_spin+p1b-1)) THEN
      IF (ieor(int_mb(k_sym+p2b-1),int_mb(k_sym+p1b-1)) .eq. ieor(irrep_
     &y,irrep_x)) THEN
      dimc = int_mb(k_range+p2b-1) * int_mb(k_range+p1b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_6_2',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      DO h5b = 1,noab
      DO h6b = h5b,noab
      DO h7b = h6b,noab
      IF (int_mb(k_active+p2b-1)+int_mb(k_active+p3b-1)+int_mb(k_active+
     &p4b-1) .ge. numact) THEN
      IF (int_mb(k_active+h5b-1)+int_mb(k_active+h6b-1)+int_mb(k_active+
     &h7b-1) .ge. numact) THEN
      IF (int_mb(k_active+h5b-1)+int_mb(k_active+h6b-1)+int_mb(k_active+
     &h7b-1) .ge. numact) THEN
      IF (int_mb(k_active+p1b-1)+int_mb(k_active+p3b-1)+int_mb(k_active+
     &p4b-1) .ge. numact) THEN
      IF (int_mb(k_spin+p2b-1)+int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1)
     & .eq. int_mb(k_spin+h5b-1)+int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b-
     &1)) THEN
      IF (ieor(int_mb(k_sym+p2b-1),ieor(int_mb(k_sym+p3b-1),ieor(int_mb(
     &k_sym+p4b-1),ieor(int_mb(k_sym+h5b-1),ieor(int_mb(k_sym+h6b-1),int
     &_mb(k_sym+h7b-1)))))) .eq. irrep_x) THEN
      CALL TCE_RESTRICTED_6(p2b,p3b,p4b,h5b,h6b,h7b,p2b_1,p3b_1,p4b_1,h5
     &b_1,h6b_1,h7b_1)
      CALL TCE_RESTRICTED_6(h5b,h6b,h7b,p1b,p3b,p4b,h5b_2,h6b_2,h7b_2,p1
     &b_2,p3b_2,p4b_2)
      dim_common = int_mb(k_range+p3b-1) * int_mb(k_range+p4b-1) * int_m
     &b(k_range+h5b-1) * int_mb(k_range+h6b-1) * int_mb(k_range+h7b-1)
      dima_sort = int_mb(k_range+p2b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+p1b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_6_2',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_6_2',2,MA_ERR)
      IF ((p4b .lt. p2b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h7b_1
     & - 1 + noab * (h6b_1 - 1 + noab * (h5b_1 - 1 + noab * (p2b_1 - noa
     &b - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p2b-1),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),3,6,5,4,2,1,1.0d0,.fa
     &lse.)
      END IF
      IF ((p3b .lt. p2b) .and. (p2b .le. p4b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h7b_1
     & - 1 + noab * (h6b_1 - 1 + noab * (h5b_1 - 1 + noab * (p4b_1 - noa
     &b - 1 + nvab * (p2b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p2b-1),int_mb(k_range+p4b-1),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),2,6,5,4,3,1,-1.0d0,.f
     &alse.)
      END IF
      IF ((p2b .le. p3b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h7b_1
     & - 1 + noab * (h6b_1 - 1 + noab * (h5b_1 - 1 + noab * (p4b_1 - noa
     &b - 1 + nvab * (p3b_1 - noab - 1 + nvab * (p2b_1 - noab - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p2b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),1,6,5,4,3,2,1.0d0,.fa
     &lse.)
      END IF
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_6_2',
     &3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_6_2',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_6_2',5,MA_ERR)
      IF ((p4b .lt. p1b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p1b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h7b_2 - 1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p1b-1),6,3,2,1,5,4,1.0d0,.fa
     &lse.)
      END IF
      IF ((p3b .lt. p1b) .and. (p1b .le. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p1b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h7b_2 - 1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p1b-1),int_mb(k_range+p4b-1),5,3,2,1,6,4,-1.0d0,.f
     &alse.)
      END IF
      IF ((p1b .le. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (h7b_2 - 1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+p1b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),4,3,2,1,6,5,1.0d0,.fa
     &lse.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_6_2',
     &6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      isuperp = 1
      IF (p3b .eq. p4b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      nsubh(1) = 1
      nsubh(2) = 1
      nsubh(3) = 1
      isubh = 1
      IF (h5b .eq. h6b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      IF (h6b .eq. h7b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,12.0d0/FACTO
     &RIAL(nsuperp(1))/FACTORIAL(nsuperp(2))/FACTORIAL(nsubh(1))/FACTORI
     &AL(nsubh(2))/FACTORIAL(nsubh(3)),dbl_mb(k_a_sort),dim_common,dbl_m
     &b(k_b_sort),dim_common,1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &6_2',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &6_2',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_6_2',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p1b-1)
     &,int_mb(k_range+p2b-1),2,1,-1.0d0/6.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p1b -
     & noab - 1 + nvab * (p2b - noab - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_6_2',
     &10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &6_2',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_6_3(d_a,k_a_offset,d_b,k_b_offset,d_
     &c,k_c_offset)
C     i1 ( p2 p1 )_yx + = -1/72 * Sum ( h9 h8 h7 h6 p5 p4 p3 ) * x ( p2 p3 p4 p5 h6 h7 h8 h9 )_x * y ( h6 h7 h8 h9 p1 p3 p4 p5 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER p2b
      INTEGER p1b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p3b
      INTEGER p4b
      INTEGER p5b
      INTEGER h6b
      INTEGER h7b
      INTEGER h8b
      INTEGER h9b
      INTEGER p2b_1
      INTEGER p3b_1
      INTEGER p4b_1
      INTEGER p5b_1
      INTEGER h6b_1
      INTEGER h7b_1
      INTEGER h8b_1
      INTEGER h9b_1
      INTEGER h6b_2
      INTEGER h7b_2
      INTEGER h8b_2
      INTEGER h9b_2
      INTEGER p1b_2
      INTEGER p3b_2
      INTEGER p4b_2
      INTEGER p5b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(3)
      INTEGER isuperp
      INTEGER nsubh(4)
      INTEGER isubh
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO p2b = noab+1,noab+nvab
      DO p1b = noab+1,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+p2b-1)+int_mb(k_spin+p1b-1
     &).ne.4)) THEN
      IF (int_mb(k_spin+p2b-1) .eq. int_mb(k_spin+p1b-1)) THEN
      IF (ieor(int_mb(k_sym+p2b-1),int_mb(k_sym+p1b-1)) .eq. ieor(irrep_
     &y,irrep_x)) THEN
      dimc = int_mb(k_range+p2b-1) * int_mb(k_range+p1b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_6_3',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      DO p5b = p4b,noab+nvab
      DO h6b = 1,noab
      DO h7b = h6b,noab
      DO h8b = h7b,noab
      DO h9b = h8b,noab
      IF (int_mb(k_active+p2b-1)+int_mb(k_active+p3b-1)+int_mb(k_active+
     &p4b-1)+int_mb(k_active+p5b-1) .ge. numacq) THEN
      IF (int_mb(k_active+h6b-1)+int_mb(k_active+h7b-1)+int_mb(k_active+
     &h8b-1)+int_mb(k_active+h9b-1) .ge. numacq) THEN
      IF (int_mb(k_active+h6b-1)+int_mb(k_active+h7b-1)+int_mb(k_active+
     &h8b-1)+int_mb(k_active+h9b-1) .ge. numacq) THEN
      IF (int_mb(k_active+p1b-1)+int_mb(k_active+p3b-1)+int_mb(k_active+
     &p4b-1)+int_mb(k_active+p5b-1) .ge. numacq) THEN
      IF (int_mb(k_spin+p2b-1)+int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1)
     &+int_mb(k_spin+p5b-1) .eq. int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b-
     &1)+int_mb(k_spin+h8b-1)+int_mb(k_spin+h9b-1)) THEN
      IF (ieor(int_mb(k_sym+p2b-1),ieor(int_mb(k_sym+p3b-1),ieor(int_mb(
     &k_sym+p4b-1),ieor(int_mb(k_sym+p5b-1),ieor(int_mb(k_sym+h6b-1),ieo
     &r(int_mb(k_sym+h7b-1),ieor(int_mb(k_sym+h8b-1),int_mb(k_sym+h9b-1)
     &))))))) .eq. irrep_x) THEN
      CALL TCE_RESTRICTED_8(p2b,p3b,p4b,p5b,h6b,h7b,h8b,h9b,p2b_1,p3b_1,
     &p4b_1,p5b_1,h6b_1,h7b_1,h8b_1,h9b_1)
      CALL TCE_RESTRICTED_8(h6b,h7b,h8b,h9b,p1b,p3b,p4b,p5b,h6b_2,h7b_2,
     &h8b_2,h9b_2,p1b_2,p3b_2,p4b_2,p5b_2)
      dim_common = int_mb(k_range+p3b-1) * int_mb(k_range+p4b-1) * int_m
     &b(k_range+p5b-1) * int_mb(k_range+h6b-1) * int_mb(k_range+h7b-1) *
     & int_mb(k_range+h8b-1) * int_mb(k_range+h9b-1)
      dima_sort = int_mb(k_range+p2b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+p1b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_6_3',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_6_3',2,MA_ERR)
      IF ((p5b .lt. p2b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h9b_1
     & - 1 + noab * (h8b_1 - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 +
     & noab * (p2b_1 - noab - 1 + nvab * (p5b_1 - noab - 1 + nvab * (p4b
     &_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+p2b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h9b-1),4,8,7,6,5,3,2,1,-1.0d0,.false.)
      END IF
      IF ((p4b .lt. p2b) .and. (p2b .le. p5b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h9b_1
     & - 1 + noab * (h8b_1 - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 +
     & noab * (p5b_1 - noab - 1 + nvab * (p2b_1 - noab - 1 + nvab * (p4b
     &_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p2b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h9b-1),3,8,7,6,5,4,2,1,1.0d0,.false.)
      END IF
      IF ((p3b .lt. p2b) .and. (p2b .le. p4b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h9b_1
     & - 1 + noab * (h8b_1 - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 +
     & noab * (p5b_1 - noab - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p2b
     &_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p2b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h9b-1),2,8,7,6,5,4,3,1,-1.0d0,.false.)
      END IF
      IF ((p2b .le. p3b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h9b_1
     & - 1 + noab * (h8b_1 - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 +
     & noab * (p5b_1 - noab - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p3b
     &_1 - noab - 1 + nvab * (p2b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p2b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h9b-1),1,8,7,6,5,4,3,2,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_6_3',
     &3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_6_3',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_6_3',5,MA_ERR)
      IF ((p5b .lt. p1b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p1b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h8b_2 - 1
     & + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p1b-1),8,4,3,2,1,7,6,5,-1.0d0,.false.)
      END IF
      IF ((p4b .lt. p1b) .and. (p1b .le. p5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p1b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h8b_2 - 1
     & + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p1b-1)
     &,int_mb(k_range+p5b-1),7,4,3,2,1,8,6,5,1.0d0,.false.)
      END IF
      IF ((p3b .lt. p1b) .and. (p1b .le. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h8b_2 - 1
     & + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p1b-1),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p5b-1),6,4,3,2,1,8,7,5,-1.0d0,.false.)
      END IF
      IF ((p1b .le. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h8b_2 - 1
     & + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p1b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p5b-1),5,4,3,2,1,8,7,6,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_6_3',
     &6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      nsuperp(3) = 1
      isuperp = 1
      IF (p3b .eq. p4b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      IF (p4b .eq. p5b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      nsubh(1) = 1
      nsubh(2) = 1
      nsubh(3) = 1
      nsubh(4) = 1
      isubh = 1
      IF (h6b .eq. h7b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      IF (h7b .eq. h8b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      IF (h8b .eq. h9b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,144.0d0/FACT
     &ORIAL(nsuperp(1))/FACTORIAL(nsuperp(2))/FACTORIAL(nsuperp(3))/FACT
     &ORIAL(nsubh(1))/FACTORIAL(nsubh(2))/FACTORIAL(nsubh(3))/FACTORIAL(
     &nsubh(4)),dbl_mb(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,
     &1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &6_3',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &6_3',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_6_3',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p1b-1)
     &,int_mb(k_range+p2b-1),2,1,-1.0d0/72.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p1b -
     & noab - 1 + nvab * (p2b - noab - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_6_3',
     &10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &6_3',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_6_4(d_a,k_a_offset,d_b,k_b_offset,d_
     &c,k_c_offset)
C     i1 ( p2 p1 )_yxt + = -2 * Sum ( h3 ) * t ( p2 h3 )_t * i2 ( h3 p1 )_yx
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER p2b
      INTEGER p1b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER h3b
      INTEGER p2b_1
      INTEGER h3b_1
      INTEGER h3b_2
      INTEGER p1b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO p2b = noab+1,noab+nvab
      DO p1b = noab+1,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+p2b-1)+int_mb(k_spin+p1b-1
     &).ne.4)) THEN
      IF (int_mb(k_spin+p2b-1) .eq. int_mb(k_spin+p1b-1)) THEN
      IF (ieor(int_mb(k_sym+p2b-1),int_mb(k_sym+p1b-1)) .eq. ieor(irrep_
     &y,ieor(irrep_x,irrep_t))) THEN
      dimc = int_mb(k_range+p2b-1) * int_mb(k_range+p1b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_6_4',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO h3b = 1,noab
      IF (int_mb(k_spin+p2b-1) .eq. int_mb(k_spin+h3b-1)) THEN
      IF (ieor(int_mb(k_sym+p2b-1),int_mb(k_sym+h3b-1)) .eq. irrep_t) TH
     &EN
      CALL TCE_RESTRICTED_2(p2b,h3b,p2b_1,h3b_1)
      CALL TCE_RESTRICTED_2(h3b,p1b,h3b_2,p1b_2)
      dim_common = int_mb(k_range+h3b-1)
      dima_sort = int_mb(k_range+p2b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+p1b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_6_4',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_6_4',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h3b_1
     & - 1 + noab * (p2b_1 - noab - 1)))
      CALL TCE_SORT_2(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p2b-1)
     &,int_mb(k_range+h3b-1),1,2,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_6_4',
     &3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_6_4',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_6_4',5,MA_ERR)
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p1b_2
     & - noab - 1 + nvab * (h3b_2 - 1)))
      CALL TCE_SORT_2(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h3b-1)
     &,int_mb(k_range+p1b-1),2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_6_4',
     &6,MA_ERR)
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,1.0d0,dbl_mb
     &(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c
     &_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &6_4',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &6_4',8,MA_ERR)
      END IF
      END IF
      END IF
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_6_4',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p1b-1)
     &,int_mb(k_range+p2b-1),2,1,-2.0d0/1.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p1b -
     & noab - 1 + nvab * (p2b - noab - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_6_4',
     &10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &6_4',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_6_4_1(d_a,k_a_offset,d_b,k_b_offset,
     &d_c,k_c_offset)
C     i2 ( h3 p1 )_yx + = 1 * Sum ( h5 p4 ) * x ( p4 h5 )_x * y ( h3 h5 p1 p4 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h3b
      INTEGER p1b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p4b
      INTEGER h5b
      INTEGER p4b_1
      INTEGER h5b_1
      INTEGER h3b_2
      INTEGER h5b_2
      INTEGER p1b_2
      INTEGER p4b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h3b = 1,noab
      DO p1b = noab+1,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h3b-1)+int_mb(k_spin+p1b-1
     &).ne.4)) THEN
      IF (int_mb(k_spin+h3b-1) .eq. int_mb(k_spin+p1b-1)) THEN
      IF (ieor(int_mb(k_sym+h3b-1),int_mb(k_sym+p1b-1)) .eq. ieor(irrep_
     &y,irrep_x)) THEN
      dimc = int_mb(k_range+h3b-1) * int_mb(k_range+p1b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_6_4_1',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p4b = noab+1,noab+nvab
      DO h5b = 1,noab
      IF (int_mb(k_spin+p4b-1) .eq. int_mb(k_spin+h5b-1)) THEN
      IF (ieor(int_mb(k_sym+p4b-1),int_mb(k_sym+h5b-1)) .eq. irrep_x) TH
     &EN
      CALL TCE_RESTRICTED_2(p4b,h5b,p4b_1,h5b_1)
      CALL TCE_RESTRICTED_4(h3b,h5b,p1b,p4b,h3b_2,h5b_2,p1b_2,p4b_2)
      dim_common = int_mb(k_range+p4b-1) * int_mb(k_range+h5b-1)
      dima_sort = 1
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h3b-1) * int_mb(k_range+p1b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_6_4_1',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_6_4_1',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h5b_1
     & - 1 + noab * (p4b_1 - noab - 1)))
      CALL TCE_SORT_2(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p4b-1)
     &,int_mb(k_range+h5b-1),2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_6_4_1
     &',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_6_4_1',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_6_4_1',5,MA_ERR)
      IF ((h5b .lt. h3b) .and. (p4b .lt. p1b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p1b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (h3b_2 - 1 + noab 
     &* (h5b_2 - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p1b-1)
     &,4,2,1,3,1.0d0,.false.)
      END IF
      IF ((h5b .lt. h3b) .and. (p1b .le. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p1b_2 - noab - 1 + nvab * (h3b_2 - 1 + noab 
     &* (h5b_2 - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h3b-1),int_mb(k_range+p1b-1),int_mb(k_range+p4b-1)
     &,3,2,1,4,-1.0d0,.false.)
      END IF
      IF ((h3b .le. h5b) .and. (p4b .lt. p1b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p1b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab 
     &* (h3b_2 - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h3b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+p4b-1),int_mb(k_range+p1b-1)
     &,4,1,2,3,-1.0d0,.false.)
      END IF
      IF ((h3b .le. h5b) .and. (p1b .le. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p1b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab 
     &* (h3b_2 - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h3b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+p1b-1),int_mb(k_range+p4b-1)
     &,3,1,2,4,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_6_4_1
     &',6,MA_ERR)
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,1.0d0,dbl_mb
     &(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c
     &_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &6_4_1',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &6_4_1',8,MA_ERR)
      END IF
      END IF
      END IF
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_6_4_1',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p1b-1)
     &,int_mb(k_range+h3b-1),2,1,1.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p1b -
     & noab - 1 + nvab * (h3b - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_6_4_1
     &',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &6_4_1',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE OFFSET_eomccsdtq_density1_6_4_1(l_a_offset,k_a_offset,s
     &ize)
C     i2 ( h3 p1 )_yx
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER l_a_offset
      INTEGER k_a_offset
      INTEGER length
      INTEGER addr
      INTEGER h3b
      INTEGER p1b
      DOUBLE PRECISION size
      length = 0
      DO h3b = 1,noab
      DO p1b = noab+1,noab+nvab
      IF (int_mb(k_spin+h3b-1) .eq. int_mb(k_spin+p1b-1)) THEN
      IF (ieor(int_mb(k_sym+h3b-1),int_mb(k_sym+p1b-1)) .eq. ieor(irrep_
     &y,irrep_x)) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h3b-1)+int_mb(k_spin+p1b-1
     &).ne.4)) THEN
      length = length + 1
      END IF
      END IF
      END IF
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,2*length+1,'noname',l_a_offset,k_a_off
     &set)) CALL ERRQUIT('eomccsdtq_density1_6_4_1',0,MA_ERR)
      dbl_mb(k_a_offset) = dfloat(length)
      addr = 0
      size = 0.0d0
      DO h3b = 1,noab
      DO p1b = noab+1,noab+nvab
      IF (int_mb(k_spin+h3b-1) .eq. int_mb(k_spin+p1b-1)) THEN
      IF (ieor(int_mb(k_sym+h3b-1),int_mb(k_sym+p1b-1)) .eq. ieor(irrep_
     &y,irrep_x)) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h3b-1)+int_mb(k_spin+p1b-1
     &).ne.4)) THEN
      addr = addr + 1
      dbl_mb(k_a_offset+addr) = dfloat(p1b - noab - 1 + nvab * (h3b - 1)
     &)
      dbl_mb(k_a_offset+length+addr) = size
      size = size + dfloat(int_mb(k_range+h3b-1)) * dfloat(int_mb(k_rang
     &e+p1b-1))
      END IF
      END IF
      END IF
      END DO
      END DO
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_6_4_2(d_a,k_a_offset,d_b,k_b_offset,
     &d_c,k_c_offset)
C     i2 ( h3 p1 )_yx + = 1/4 * Sum ( h7 h6 p5 p4 ) * x ( p4 p5 h6 h7 )_x * y ( h3 h6 h7 p1 p4 p5 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h3b
      INTEGER p1b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p4b
      INTEGER p5b
      INTEGER h6b
      INTEGER h7b
      INTEGER p4b_1
      INTEGER p5b_1
      INTEGER h6b_1
      INTEGER h7b_1
      INTEGER h3b_2
      INTEGER h6b_2
      INTEGER h7b_2
      INTEGER p1b_2
      INTEGER p4b_2
      INTEGER p5b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(2)
      INTEGER isuperp
      INTEGER nsubh(2)
      INTEGER isubh
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h3b = 1,noab
      DO p1b = noab+1,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h3b-1)+int_mb(k_spin+p1b-1
     &).ne.4)) THEN
      IF (int_mb(k_spin+h3b-1) .eq. int_mb(k_spin+p1b-1)) THEN
      IF (ieor(int_mb(k_sym+h3b-1),int_mb(k_sym+p1b-1)) .eq. ieor(irrep_
     &y,irrep_x)) THEN
      dimc = int_mb(k_range+h3b-1) * int_mb(k_range+p1b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_6_4_2',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p4b = noab+1,noab+nvab
      DO p5b = p4b,noab+nvab
      DO h6b = 1,noab
      DO h7b = h6b,noab
      IF (int_mb(k_active+h3b-1)+int_mb(k_active+h6b-1)+int_mb(k_active+
     &h7b-1) .ge. numact) THEN
      IF (int_mb(k_active+p1b-1)+int_mb(k_active+p4b-1)+int_mb(k_active+
     &p5b-1) .ge. numact) THEN
      IF (int_mb(k_spin+p4b-1)+int_mb(k_spin+p5b-1) .eq. int_mb(k_spin+h
     &6b-1)+int_mb(k_spin+h7b-1)) THEN
      IF (ieor(int_mb(k_sym+p4b-1),ieor(int_mb(k_sym+p5b-1),ieor(int_mb(
     &k_sym+h6b-1),int_mb(k_sym+h7b-1)))) .eq. irrep_x) THEN
      CALL TCE_RESTRICTED_4(p4b,p5b,h6b,h7b,p4b_1,p5b_1,h6b_1,h7b_1)
      CALL TCE_RESTRICTED_6(h3b,h6b,h7b,p1b,p4b,p5b,h3b_2,h6b_2,h7b_2,p1
     &b_2,p4b_2,p5b_2)
      dim_common = int_mb(k_range+p4b-1) * int_mb(k_range+p5b-1) * int_m
     &b(k_range+h6b-1) * int_mb(k_range+h7b-1)
      dima_sort = 1
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h3b-1) * int_mb(k_range+p1b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_6_4_2',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_6_4_2',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h7b_1
     & - 1 + noab * (h6b_1 - 1 + noab * (p5b_1 - noab - 1 + nvab * (p4b_
     &1 - noab - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p5b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1)
     &,4,3,2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_6_4_2
     &',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_6_4_2',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_6_4_2',5,MA_ERR)
      IF ((h7b .lt. h3b) .and. (p5b .lt. p1b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p1b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (h3b_2 - 1 + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h3b-1),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p5b-1),int_mb(k_range+p1b-1),6,3,2,1,5,4,1.0d0,.fa
     &lse.)
      END IF
      IF ((h7b .lt. h3b) .and. (p4b .lt. p1b) .and. (p1b .le. p5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p1b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (h3b_2 - 1 + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h3b-1),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p1b-1),int_mb(k_range+p5b-1),5,3,2,1,6,4,-1.0d0,.f
     &alse.)
      END IF
      IF ((h7b .lt. h3b) .and. (p1b .le. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (h3b_2 - 1 + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h3b-1),int_mb(k_range+p1b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),4,3,2,1,6,5,1.0d0,.fa
     &lse.)
      END IF
      IF ((h6b .lt. h3b) .and. (h3b .le. h7b) .and. (p5b .lt. p1b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p1b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (h7b_2 - 1 + noab * (h3b_2 - 1 + noab * (h6b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h3b-1),int_mb(k_range+h7b-1),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p5b-1),int_mb(k_range+p1b-1),6,2,3,1,5,4,-1.0d0,.f
     &alse.)
      END IF
      IF ((h6b .lt. h3b) .and. (h3b .le. h7b) .and. (p4b .lt. p1b) .and.
     & (p1b .le. p5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p1b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (h7b_2 - 1 + noab * (h3b_2 - 1 + noab * (h6b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h3b-1),int_mb(k_range+h7b-1),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p1b-1),int_mb(k_range+p5b-1),5,2,3,1,6,4,1.0d0,.fa
     &lse.)
      END IF
      IF ((h6b .lt. h3b) .and. (h3b .le. h7b) .and. (p1b .le. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (h7b_2 - 1 + noab * (h3b_2 - 1 + noab * (h6b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h3b-1),int_mb(k_range+h7b-1),int_mb(k_range+p1b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),4,2,3,1,6,5,-1.0d0,.f
     &alse.)
      END IF
      IF ((h3b .le. h6b) .and. (p5b .lt. p1b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p1b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (h7b_2 - 1 + noab * (h6b_2 - 1 + noab * (h3b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h3b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p5b-1),int_mb(k_range+p1b-1),6,1,3,2,5,4,1.0d0,.fa
     &lse.)
      END IF
      IF ((h3b .le. h6b) .and. (p4b .lt. p1b) .and. (p1b .le. p5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p1b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (h7b_2 - 1 + noab * (h6b_2 - 1 + noab * (h3b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h3b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p1b-1),int_mb(k_range+p5b-1),5,1,3,2,6,4,-1.0d0,.f
     &alse.)
      END IF
      IF ((h3b .le. h6b) .and. (p1b .le. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (h7b_2 - 1 + noab * (h6b_2 - 1 + noab * (h3b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h3b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+p1b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),4,1,3,2,6,5,1.0d0,.fa
     &lse.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_6_4_2
     &',6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      isuperp = 1
      IF (p4b .eq. p5b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      nsubh(1) = 1
      nsubh(2) = 1
      isubh = 1
      IF (h6b .eq. h7b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,4.0d0/FACTOR
     &IAL(nsuperp(1))/FACTORIAL(nsuperp(2))/FACTORIAL(nsubh(1))/FACTORIA
     &L(nsubh(2)),dbl_mb(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_commo
     &n,1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &6_4_2',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &6_4_2',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_6_4_2',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p1b-1)
     &,int_mb(k_range+h3b-1),2,1,1.0d0/4.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p1b -
     & noab - 1 + nvab * (h3b - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_6_4_2
     &',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &6_4_2',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_6_4_3(d_a,k_a_offset,d_b,k_b_offset,
     &d_c,k_c_offset)
C     i2 ( h3 p1 )_yx + = 1/36 * Sum ( h9 h8 h7 p6 p5 p4 ) * x ( p4 p5 p6 h7 h8 h9 )_x * y ( h3 h7 h8 h9 p1 p4 p5 p6 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h3b
      INTEGER p1b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p4b
      INTEGER p5b
      INTEGER p6b
      INTEGER h7b
      INTEGER h8b
      INTEGER h9b
      INTEGER p4b_1
      INTEGER p5b_1
      INTEGER p6b_1
      INTEGER h7b_1
      INTEGER h8b_1
      INTEGER h9b_1
      INTEGER h3b_2
      INTEGER h7b_2
      INTEGER h8b_2
      INTEGER h9b_2
      INTEGER p1b_2
      INTEGER p4b_2
      INTEGER p5b_2
      INTEGER p6b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(3)
      INTEGER isuperp
      INTEGER nsubh(3)
      INTEGER isubh
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h3b = 1,noab
      DO p1b = noab+1,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h3b-1)+int_mb(k_spin+p1b-1
     &).ne.4)) THEN
      IF (int_mb(k_spin+h3b-1) .eq. int_mb(k_spin+p1b-1)) THEN
      IF (ieor(int_mb(k_sym+h3b-1),int_mb(k_sym+p1b-1)) .eq. ieor(irrep_
     &y,irrep_x)) THEN
      dimc = int_mb(k_range+h3b-1) * int_mb(k_range+p1b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_6_4_3',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p4b = noab+1,noab+nvab
      DO p5b = p4b,noab+nvab
      DO p6b = p5b,noab+nvab
      DO h7b = 1,noab
      DO h8b = h7b,noab
      DO h9b = h8b,noab
      IF (int_mb(k_active+p4b-1)+int_mb(k_active+p5b-1)+int_mb(k_active+
     &p6b-1) .ge. numact) THEN
      IF (int_mb(k_active+h7b-1)+int_mb(k_active+h8b-1)+int_mb(k_active+
     &h9b-1) .ge. numact) THEN
      IF (int_mb(k_active+h3b-1)+int_mb(k_active+h7b-1)+int_mb(k_active+
     &h8b-1)+int_mb(k_active+h9b-1) .ge. numacq) THEN
      IF (int_mb(k_active+p1b-1)+int_mb(k_active+p4b-1)+int_mb(k_active+
     &p5b-1)+int_mb(k_active+p6b-1) .ge. numacq) THEN
      IF (int_mb(k_spin+p4b-1)+int_mb(k_spin+p5b-1)+int_mb(k_spin+p6b-1)
     & .eq. int_mb(k_spin+h7b-1)+int_mb(k_spin+h8b-1)+int_mb(k_spin+h9b-
     &1)) THEN
      IF (ieor(int_mb(k_sym+p4b-1),ieor(int_mb(k_sym+p5b-1),ieor(int_mb(
     &k_sym+p6b-1),ieor(int_mb(k_sym+h7b-1),ieor(int_mb(k_sym+h8b-1),int
     &_mb(k_sym+h9b-1)))))) .eq. irrep_x) THEN
      CALL TCE_RESTRICTED_6(p4b,p5b,p6b,h7b,h8b,h9b,p4b_1,p5b_1,p6b_1,h7
     &b_1,h8b_1,h9b_1)
      CALL TCE_RESTRICTED_8(h3b,h7b,h8b,h9b,p1b,p4b,p5b,p6b,h3b_2,h7b_2,
     &h8b_2,h9b_2,p1b_2,p4b_2,p5b_2,p6b_2)
      dim_common = int_mb(k_range+p4b-1) * int_mb(k_range+p5b-1) * int_m
     &b(k_range+p6b-1) * int_mb(k_range+h7b-1) * int_mb(k_range+h8b-1) *
     & int_mb(k_range+h9b-1)
      dima_sort = 1
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h3b-1) * int_mb(k_range+p1b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_6_4_3',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_6_4_3',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h9b_1
     & - 1 + noab * (h8b_1 - 1 + noab * (h7b_1 - 1 + noab * (p6b_1 - noa
     &b - 1 + nvab * (p5b_1 - noab - 1 + nvab * (p4b_1 - noab - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p5b-1),int_mb(k_range+p6b-1),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h9b-1),6,5,4,3,2,1,1.0d0,.fa
     &lse.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_6_4_3
     &',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_6_4_3',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_6_4_3',5,MA_ERR)
      IF ((h9b .lt. h3b) .and. (p6b .lt. p1b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p1b_2
     & - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p5b_2 - noab - 1 
     &+ nvab * (p4b_2 - noab - 1 + nvab * (h3b_2 - 1 + noab * (h9b_2 - 1
     & + noab * (h8b_2 - 1 + noab * (h7b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h9b-1),int_mb(k_range+h3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1)
     &,int_mb(k_range+p1b-1),8,4,3,2,1,7,6,5,1.0d0,.false.)
      END IF
      IF ((h9b .lt. h3b) .and. (p5b .lt. p1b) .and. (p1b .le. p6b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p1b_2 - noab - 1 + nvab * (p5b_2 - noab - 1 
     &+ nvab * (p4b_2 - noab - 1 + nvab * (h3b_2 - 1 + noab * (h9b_2 - 1
     & + noab * (h8b_2 - 1 + noab * (h7b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h9b-1),int_mb(k_range+h3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+p1b-1)
     &,int_mb(k_range+p6b-1),7,4,3,2,1,8,6,5,-1.0d0,.false.)
      END IF
      IF ((h9b .lt. h3b) .and. (p4b .lt. p1b) .and. (p1b .le. p5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (p4b_2 - noab - 1 + nvab * (h3b_2 - 1 + noab * (h9b_2 - 1
     & + noab * (h8b_2 - 1 + noab * (h7b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h9b-1),int_mb(k_range+h3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p1b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p6b-1),6,4,3,2,1,8,7,5,1.0d0,.false.)
      END IF
      IF ((h9b .lt. h3b) .and. (p1b .le. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h3b_2 - 1 + noab * (h9b_2 - 1
     & + noab * (h8b_2 - 1 + noab * (h7b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h9b-1),int_mb(k_range+h3b-1)
     &,int_mb(k_range+p1b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p6b-1),5,4,3,2,1,8,7,6,-1.0d0,.false.)
      END IF
      IF ((h8b .lt. h3b) .and. (h3b .le. h9b) .and. (p6b .lt. p1b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p1b_2
     & - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p5b_2 - noab - 1 
     &+ nvab * (p4b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h3b_2 - 1
     & + noab * (h8b_2 - 1 + noab * (h7b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h3b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1)
     &,int_mb(k_range+p1b-1),8,3,4,2,1,7,6,5,-1.0d0,.false.)
      END IF
      IF ((h8b .lt. h3b) .and. (h3b .le. h9b) .and. (p5b .lt. p1b) .and.
     & (p1b .le. p6b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p1b_2 - noab - 1 + nvab * (p5b_2 - noab - 1 
     &+ nvab * (p4b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h3b_2 - 1
     & + noab * (h8b_2 - 1 + noab * (h7b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h3b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+p1b-1)
     &,int_mb(k_range+p6b-1),7,3,4,2,1,8,6,5,1.0d0,.false.)
      END IF
      IF ((h8b .lt. h3b) .and. (h3b .le. h9b) .and. (p4b .lt. p1b) .and.
     & (p1b .le. p5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (p4b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h3b_2 - 1
     & + noab * (h8b_2 - 1 + noab * (h7b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h3b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p1b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p6b-1),6,3,4,2,1,8,7,5,-1.0d0,.false.)
      END IF
      IF ((h8b .lt. h3b) .and. (h3b .le. h9b) .and. (p1b .le. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h3b_2 - 1
     & + noab * (h8b_2 - 1 + noab * (h7b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h3b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p1b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p6b-1),5,3,4,2,1,8,7,6,1.0d0,.false.)
      END IF
      IF ((h7b .lt. h3b) .and. (h3b .le. h8b) .and. (p6b .lt. p1b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p1b_2
     & - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p5b_2 - noab - 1 
     &+ nvab * (p4b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h8b_2 - 1
     & + noab * (h3b_2 - 1 + noab * (h7b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h3b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1)
     &,int_mb(k_range+p1b-1),8,2,4,3,1,7,6,5,1.0d0,.false.)
      END IF
      IF ((h7b .lt. h3b) .and. (h3b .le. h8b) .and. (p5b .lt. p1b) .and.
     & (p1b .le. p6b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p1b_2 - noab - 1 + nvab * (p5b_2 - noab - 1 
     &+ nvab * (p4b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h8b_2 - 1
     & + noab * (h3b_2 - 1 + noab * (h7b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h3b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+p1b-1)
     &,int_mb(k_range+p6b-1),7,2,4,3,1,8,6,5,-1.0d0,.false.)
      END IF
      IF ((h7b .lt. h3b) .and. (h3b .le. h8b) .and. (p4b .lt. p1b) .and.
     & (p1b .le. p5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (p4b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h8b_2 - 1
     & + noab * (h3b_2 - 1 + noab * (h7b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h3b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p1b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p6b-1),6,2,4,3,1,8,7,5,1.0d0,.false.)
      END IF
      IF ((h7b .lt. h3b) .and. (h3b .le. h8b) .and. (p1b .le. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h8b_2 - 1
     & + noab * (h3b_2 - 1 + noab * (h7b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h3b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p1b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p6b-1),5,2,4,3,1,8,7,6,-1.0d0,.false.)
      END IF
      IF ((h3b .le. h7b) .and. (p6b .lt. p1b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p1b_2
     & - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p5b_2 - noab - 1 
     &+ nvab * (p4b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h8b_2 - 1
     & + noab * (h7b_2 - 1 + noab * (h3b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h3b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1)
     &,int_mb(k_range+p1b-1),8,1,4,3,2,7,6,5,-1.0d0,.false.)
      END IF
      IF ((h3b .le. h7b) .and. (p5b .lt. p1b) .and. (p1b .le. p6b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p1b_2 - noab - 1 + nvab * (p5b_2 - noab - 1 
     &+ nvab * (p4b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h8b_2 - 1
     & + noab * (h7b_2 - 1 + noab * (h3b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h3b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+p1b-1)
     &,int_mb(k_range+p6b-1),7,1,4,3,2,8,6,5,1.0d0,.false.)
      END IF
      IF ((h3b .le. h7b) .and. (p4b .lt. p1b) .and. (p1b .le. p5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (p4b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h8b_2 - 1
     & + noab * (h7b_2 - 1 + noab * (h3b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h3b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p1b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p6b-1),6,1,4,3,2,8,7,5,-1.0d0,.false.)
      END IF
      IF ((h3b .le. h7b) .and. (p1b .le. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h8b_2 - 1
     & + noab * (h7b_2 - 1 + noab * (h3b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h3b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p1b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p6b-1),5,1,4,3,2,8,7,6,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_6_4_3
     &',6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      nsuperp(3) = 1
      isuperp = 1
      IF (p4b .eq. p5b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      IF (p5b .eq. p6b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      nsubh(1) = 1
      nsubh(2) = 1
      nsubh(3) = 1
      isubh = 1
      IF (h7b .eq. h8b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      IF (h8b .eq. h9b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,36.0d0/FACTO
     &RIAL(nsuperp(1))/FACTORIAL(nsuperp(2))/FACTORIAL(nsuperp(3))/FACTO
     &RIAL(nsubh(1))/FACTORIAL(nsubh(2))/FACTORIAL(nsubh(3)),dbl_mb(k_a_
     &sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c_sort
     &),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &6_4_3',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &6_4_3',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_6_4_3',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p1b-1)
     &,int_mb(k_range+h3b-1),2,1,1.0d0/36.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p1b -
     & noab - 1 + nvab * (h3b - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_6_4_3
     &',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &6_4_3',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_6_5(d_a,k_a_offset,d_b,k_b_offset,d_
     &c,k_c_offset)
C     i1 ( p2 p1 )_ytx + = 1 * x ( )_x * i2 ( p2 p1 )_yt
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER p2b
      INTEGER p1b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p2b_2
      INTEGER p1b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO p2b = noab+1,noab+nvab
      DO p1b = noab+1,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+p2b-1)+int_mb(k_spin+p1b-1
     &).ne.4)) THEN
      IF (int_mb(k_spin+p2b-1) .eq. int_mb(k_spin+p1b-1)) THEN
      IF (ieor(int_mb(k_sym+p2b-1),int_mb(k_sym+p1b-1)) .eq. ieor(irrep_
     &y,ieor(irrep_t,irrep_x))) THEN
      dimc = int_mb(k_range+p2b-1) * int_mb(k_range+p1b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_6_5',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      IF (0 .eq. irrep_x) THEN
      CALL TCE_RESTRICTED_2(p2b,p1b,p2b_2,p1b_2)
      dim_common = 1
      dima_sort = 1
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+p2b-1) * int_mb(k_range+p1b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_6_5',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_6_5',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),0)
      CALL TCE_SORT_0(dbl_mb(k_a),dbl_mb(k_a_sort),1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_6_5',
     &3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_6_5',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_6_5',5,MA_ERR)
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p1b_2
     & - noab - 1 + nvab * (p2b_2 - noab - 1)))
      CALL TCE_SORT_2(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+p2b-1)
     &,int_mb(k_range+p1b-1),2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_6_5',
     &6,MA_ERR)
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,1.0d0,dbl_mb
     &(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c
     &_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &6_5',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &6_5',8,MA_ERR)
      END IF
      END IF
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_6_5',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p1b-1)
     &,int_mb(k_range+p2b-1),2,1,1.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p1b -
     & noab - 1 + nvab * (p2b - noab - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_6_5',
     &10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &6_5',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_6_5_1(d_a,k_a_offset,d_b,k_b_offset,
     &d_c,k_c_offset)
C     i2 ( p2 p1 )_yt + = -1 * Sum ( h5 h4 p3 ) * t ( p2 p3 h4 h5 )_t * y ( h4 h5 p1 p3 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER p2b
      INTEGER p1b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p3b
      INTEGER h4b
      INTEGER h5b
      INTEGER p2b_1
      INTEGER p3b_1
      INTEGER h4b_1
      INTEGER h5b_1
      INTEGER h4b_2
      INTEGER h5b_2
      INTEGER p1b_2
      INTEGER p3b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsubh(2)
      INTEGER isubh
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO p2b = noab+1,noab+nvab
      DO p1b = noab+1,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+p2b-1)+int_mb(k_spin+p1b-1
     &).ne.4)) THEN
      IF (int_mb(k_spin+p2b-1) .eq. int_mb(k_spin+p1b-1)) THEN
      IF (ieor(int_mb(k_sym+p2b-1),int_mb(k_sym+p1b-1)) .eq. ieor(irrep_
     &y,irrep_t)) THEN
      dimc = int_mb(k_range+p2b-1) * int_mb(k_range+p1b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_6_5_1',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p3b = noab+1,noab+nvab
      DO h4b = 1,noab
      DO h5b = h4b,noab
      IF (int_mb(k_spin+p2b-1)+int_mb(k_spin+p3b-1) .eq. int_mb(k_spin+h
     &4b-1)+int_mb(k_spin+h5b-1)) THEN
      IF (ieor(int_mb(k_sym+p2b-1),ieor(int_mb(k_sym+p3b-1),ieor(int_mb(
     &k_sym+h4b-1),int_mb(k_sym+h5b-1)))) .eq. irrep_t) THEN
      CALL TCE_RESTRICTED_4(p2b,p3b,h4b,h5b,p2b_1,p3b_1,h4b_1,h5b_1)
      CALL TCE_RESTRICTED_4(h4b,h5b,p1b,p3b,h4b_2,h5b_2,p1b_2,p3b_2)
      dim_common = int_mb(k_range+p3b-1) * int_mb(k_range+h4b-1) * int_m
     &b(k_range+h5b-1)
      dima_sort = int_mb(k_range+p2b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+p1b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_6_5_1',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_6_5_1',2,MA_ERR)
      IF ((p3b .lt. p2b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h5b_1
     & - 1 + noab * (h4b_1 - 1 + noab * (p2b_1 - noab - 1 + nvab * (p3b_
     &1 - noab - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p2b-1),int_mb(k_range+h4b-1),int_mb(k_range+h5b-1)
     &,2,4,3,1,-1.0d0,.false.)
      END IF
      IF ((p2b .le. p3b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h5b_1
     & - 1 + noab * (h4b_1 - 1 + noab * (p3b_1 - noab - 1 + nvab * (p2b_
     &1 - noab - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p2b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+h4b-1),int_mb(k_range+h5b-1)
     &,1,4,3,2,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_6_5_1
     &',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_6_5_1',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_6_5_1',5,MA_ERR)
      IF ((p3b .lt. p1b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p1b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab 
     &* (h4b_2 - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+p3b-1),int_mb(k_range+p1b-1)
     &,4,2,1,3,-1.0d0,.false.)
      END IF
      IF ((p1b .le. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p1b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab 
     &* (h4b_2 - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+p1b-1),int_mb(k_range+p3b-1)
     &,3,2,1,4,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_6_5_1
     &',6,MA_ERR)
      nsubh(1) = 1
      nsubh(2) = 1
      isubh = 1
      IF (h4b .eq. h5b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,2.0d0/FACTOR
     &IAL(nsubh(1))/FACTORIAL(nsubh(2)),dbl_mb(k_a_sort),dim_common,dbl_
     &mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &6_5_1',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &6_5_1',8,MA_ERR)
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_6_5_1',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p1b-1)
     &,int_mb(k_range+p2b-1),2,1,-1.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p1b -
     & noab - 1 + nvab * (p2b - noab - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_6_5_1
     &',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &6_5_1',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE OFFSET_eomccsdtq_density1_6_5_1(l_a_offset,k_a_offset,s
     &ize)
C     i2 ( p2 p1 )_yt
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER l_a_offset
      INTEGER k_a_offset
      INTEGER length
      INTEGER addr
      INTEGER p2b
      INTEGER p1b
      DOUBLE PRECISION size
      length = 0
      DO p2b = noab+1,noab+nvab
      DO p1b = noab+1,noab+nvab
      IF (int_mb(k_spin+p2b-1) .eq. int_mb(k_spin+p1b-1)) THEN
      IF (ieor(int_mb(k_sym+p2b-1),int_mb(k_sym+p1b-1)) .eq. ieor(irrep_
     &y,irrep_t)) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+p2b-1)+int_mb(k_spin+p1b-1
     &).ne.4)) THEN
      length = length + 1
      END IF
      END IF
      END IF
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,2*length+1,'noname',l_a_offset,k_a_off
     &set)) CALL ERRQUIT('eomccsdtq_density1_6_5_1',0,MA_ERR)
      dbl_mb(k_a_offset) = dfloat(length)
      addr = 0
      size = 0.0d0
      DO p2b = noab+1,noab+nvab
      DO p1b = noab+1,noab+nvab
      IF (int_mb(k_spin+p2b-1) .eq. int_mb(k_spin+p1b-1)) THEN
      IF (ieor(int_mb(k_sym+p2b-1),int_mb(k_sym+p1b-1)) .eq. ieor(irrep_
     &y,irrep_t)) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+p2b-1)+int_mb(k_spin+p1b-1
     &).ne.4)) THEN
      addr = addr + 1
      dbl_mb(k_a_offset+addr) = dfloat(p1b - noab - 1 + nvab * (p2b - no
     &ab - 1))
      dbl_mb(k_a_offset+length+addr) = size
      size = size + dfloat(int_mb(k_range+p2b-1)) * dfloat(int_mb(k_rang
     &e+p1b-1))
      END IF
      END IF
      END IF
      END DO
      END DO
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_6_5_2(d_a,k_a_offset,d_b,k_b_offset,
     &d_c,k_c_offset)
C     i2 ( p2 p1 )_yt + = -1/6 * Sum ( h7 h6 h5 p4 p3 ) * t ( p2 p3 p4 h5 h6 h7 )_t * y ( h5 h6 h7 p1 p3 p4 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER p2b
      INTEGER p1b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p3b
      INTEGER p4b
      INTEGER h5b
      INTEGER h6b
      INTEGER h7b
      INTEGER p2b_1
      INTEGER p3b_1
      INTEGER p4b_1
      INTEGER h5b_1
      INTEGER h6b_1
      INTEGER h7b_1
      INTEGER h5b_2
      INTEGER h6b_2
      INTEGER h7b_2
      INTEGER p1b_2
      INTEGER p3b_2
      INTEGER p4b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(2)
      INTEGER isuperp
      INTEGER nsubh(3)
      INTEGER isubh
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO p2b = noab+1,noab+nvab
      DO p1b = noab+1,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+p2b-1)+int_mb(k_spin+p1b-1
     &).ne.4)) THEN
      IF (int_mb(k_spin+p2b-1) .eq. int_mb(k_spin+p1b-1)) THEN
      IF (ieor(int_mb(k_sym+p2b-1),int_mb(k_sym+p1b-1)) .eq. ieor(irrep_
     &y,irrep_t)) THEN
      dimc = int_mb(k_range+p2b-1) * int_mb(k_range+p1b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_6_5_2',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      DO h5b = 1,noab
      DO h6b = h5b,noab
      DO h7b = h6b,noab
      IF (int_mb(k_active+p2b-1)+int_mb(k_active+p3b-1)+int_mb(k_active+
     &p4b-1) .ge. numact) THEN
      IF (int_mb(k_active+h5b-1)+int_mb(k_active+h6b-1)+int_mb(k_active+
     &h7b-1) .ge. numact) THEN
      IF (int_mb(k_active+h5b-1)+int_mb(k_active+h6b-1)+int_mb(k_active+
     &h7b-1) .ge. numact) THEN
      IF (int_mb(k_active+p1b-1)+int_mb(k_active+p3b-1)+int_mb(k_active+
     &p4b-1) .ge. numact) THEN
      IF (int_mb(k_spin+p2b-1)+int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1)
     & .eq. int_mb(k_spin+h5b-1)+int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b-
     &1)) THEN
      IF (ieor(int_mb(k_sym+p2b-1),ieor(int_mb(k_sym+p3b-1),ieor(int_mb(
     &k_sym+p4b-1),ieor(int_mb(k_sym+h5b-1),ieor(int_mb(k_sym+h6b-1),int
     &_mb(k_sym+h7b-1)))))) .eq. irrep_t) THEN
      CALL TCE_RESTRICTED_6(p2b,p3b,p4b,h5b,h6b,h7b,p2b_1,p3b_1,p4b_1,h5
     &b_1,h6b_1,h7b_1)
      CALL TCE_RESTRICTED_6(h5b,h6b,h7b,p1b,p3b,p4b,h5b_2,h6b_2,h7b_2,p1
     &b_2,p3b_2,p4b_2)
      dim_common = int_mb(k_range+p3b-1) * int_mb(k_range+p4b-1) * int_m
     &b(k_range+h5b-1) * int_mb(k_range+h6b-1) * int_mb(k_range+h7b-1)
      dima_sort = int_mb(k_range+p2b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+p1b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_6_5_2',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_6_5_2',2,MA_ERR)
      IF ((p4b .lt. p2b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h7b_1
     & - 1 + noab * (h6b_1 - 1 + noab * (h5b_1 - 1 + noab * (p2b_1 - noa
     &b - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p2b-1),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),3,6,5,4,2,1,1.0d0,.fa
     &lse.)
      END IF
      IF ((p3b .lt. p2b) .and. (p2b .le. p4b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h7b_1
     & - 1 + noab * (h6b_1 - 1 + noab * (h5b_1 - 1 + noab * (p4b_1 - noa
     &b - 1 + nvab * (p2b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p2b-1),int_mb(k_range+p4b-1),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),2,6,5,4,3,1,-1.0d0,.f
     &alse.)
      END IF
      IF ((p2b .le. p3b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h7b_1
     & - 1 + noab * (h6b_1 - 1 + noab * (h5b_1 - 1 + noab * (p4b_1 - noa
     &b - 1 + nvab * (p3b_1 - noab - 1 + nvab * (p2b_1 - noab - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p2b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),1,6,5,4,3,2,1.0d0,.fa
     &lse.)
      END IF
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_6_5_2
     &',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_6_5_2',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_6_5_2',5,MA_ERR)
      IF ((p4b .lt. p1b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p1b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h7b_2 - 1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p1b-1),6,3,2,1,5,4,1.0d0,.fa
     &lse.)
      END IF
      IF ((p3b .lt. p1b) .and. (p1b .le. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p1b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h7b_2 - 1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p1b-1),int_mb(k_range+p4b-1),5,3,2,1,6,4,-1.0d0,.f
     &alse.)
      END IF
      IF ((p1b .le. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (h7b_2 - 1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+p1b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),4,3,2,1,6,5,1.0d0,.fa
     &lse.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_6_5_2
     &',6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      isuperp = 1
      IF (p3b .eq. p4b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      nsubh(1) = 1
      nsubh(2) = 1
      nsubh(3) = 1
      isubh = 1
      IF (h5b .eq. h6b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      IF (h6b .eq. h7b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,12.0d0/FACTO
     &RIAL(nsuperp(1))/FACTORIAL(nsuperp(2))/FACTORIAL(nsubh(1))/FACTORI
     &AL(nsubh(2))/FACTORIAL(nsubh(3)),dbl_mb(k_a_sort),dim_common,dbl_m
     &b(k_b_sort),dim_common,1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &6_5_2',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &6_5_2',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_6_5_2',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p1b-1)
     &,int_mb(k_range+p2b-1),2,1,-1.0d0/6.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p1b -
     & noab - 1 + nvab * (p2b - noab - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_6_5_2
     &',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &6_5_2',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_6_5_3(d_a,k_a_offset,d_b,k_b_offset,
     &d_c,k_c_offset)
C     i2 ( p2 p1 )_yt + = -1/72 * Sum ( h9 h8 h7 h6 p5 p4 p3 ) * t ( p2 p3 p4 p5 h6 h7 h8 h9 )_t * y ( h6 h7 h8 h9 p1 p3 p4 p5 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER p2b
      INTEGER p1b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p3b
      INTEGER p4b
      INTEGER p5b
      INTEGER h6b
      INTEGER h7b
      INTEGER h8b
      INTEGER h9b
      INTEGER p2b_1
      INTEGER p3b_1
      INTEGER p4b_1
      INTEGER p5b_1
      INTEGER h6b_1
      INTEGER h7b_1
      INTEGER h8b_1
      INTEGER h9b_1
      INTEGER h6b_2
      INTEGER h7b_2
      INTEGER h8b_2
      INTEGER h9b_2
      INTEGER p1b_2
      INTEGER p3b_2
      INTEGER p4b_2
      INTEGER p5b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(3)
      INTEGER isuperp
      INTEGER nsubh(4)
      INTEGER isubh
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO p2b = noab+1,noab+nvab
      DO p1b = noab+1,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+p2b-1)+int_mb(k_spin+p1b-1
     &).ne.4)) THEN
      IF (int_mb(k_spin+p2b-1) .eq. int_mb(k_spin+p1b-1)) THEN
      IF (ieor(int_mb(k_sym+p2b-1),int_mb(k_sym+p1b-1)) .eq. ieor(irrep_
     &y,irrep_t)) THEN
      dimc = int_mb(k_range+p2b-1) * int_mb(k_range+p1b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_6_5_3',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      DO p5b = p4b,noab+nvab
      DO h6b = 1,noab
      DO h7b = h6b,noab
      DO h8b = h7b,noab
      DO h9b = h8b,noab
      IF (int_mb(k_active+p2b-1)+int_mb(k_active+p3b-1)+int_mb(k_active+
     &p4b-1)+int_mb(k_active+p5b-1) .ge. numacq) THEN
      IF (int_mb(k_active+h6b-1)+int_mb(k_active+h7b-1)+int_mb(k_active+
     &h8b-1)+int_mb(k_active+h9b-1) .ge. numacq) THEN
      IF (int_mb(k_active+h6b-1)+int_mb(k_active+h7b-1)+int_mb(k_active+
     &h8b-1)+int_mb(k_active+h9b-1) .ge. numacq) THEN
      IF (int_mb(k_active+p1b-1)+int_mb(k_active+p3b-1)+int_mb(k_active+
     &p4b-1)+int_mb(k_active+p5b-1) .ge. numacq) THEN
      IF (int_mb(k_spin+p2b-1)+int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1)
     &+int_mb(k_spin+p5b-1) .eq. int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b-
     &1)+int_mb(k_spin+h8b-1)+int_mb(k_spin+h9b-1)) THEN
      IF (ieor(int_mb(k_sym+p2b-1),ieor(int_mb(k_sym+p3b-1),ieor(int_mb(
     &k_sym+p4b-1),ieor(int_mb(k_sym+p5b-1),ieor(int_mb(k_sym+h6b-1),ieo
     &r(int_mb(k_sym+h7b-1),ieor(int_mb(k_sym+h8b-1),int_mb(k_sym+h9b-1)
     &))))))) .eq. irrep_t) THEN
      CALL TCE_RESTRICTED_8(p2b,p3b,p4b,p5b,h6b,h7b,h8b,h9b,p2b_1,p3b_1,
     &p4b_1,p5b_1,h6b_1,h7b_1,h8b_1,h9b_1)
      CALL TCE_RESTRICTED_8(h6b,h7b,h8b,h9b,p1b,p3b,p4b,p5b,h6b_2,h7b_2,
     &h8b_2,h9b_2,p1b_2,p3b_2,p4b_2,p5b_2)
      dim_common = int_mb(k_range+p3b-1) * int_mb(k_range+p4b-1) * int_m
     &b(k_range+p5b-1) * int_mb(k_range+h6b-1) * int_mb(k_range+h7b-1) *
     & int_mb(k_range+h8b-1) * int_mb(k_range+h9b-1)
      dima_sort = int_mb(k_range+p2b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+p1b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_6_5_3',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_6_5_3',2,MA_ERR)
      IF ((p5b .lt. p2b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h9b_1
     & - 1 + noab * (h8b_1 - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 +
     & noab * (p2b_1 - noab - 1 + nvab * (p5b_1 - noab - 1 + nvab * (p4b
     &_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+p2b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h9b-1),4,8,7,6,5,3,2,1,-1.0d0,.false.)
      END IF
      IF ((p4b .lt. p2b) .and. (p2b .le. p5b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h9b_1
     & - 1 + noab * (h8b_1 - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 +
     & noab * (p5b_1 - noab - 1 + nvab * (p2b_1 - noab - 1 + nvab * (p4b
     &_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p2b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h9b-1),3,8,7,6,5,4,2,1,1.0d0,.false.)
      END IF
      IF ((p3b .lt. p2b) .and. (p2b .le. p4b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h9b_1
     & - 1 + noab * (h8b_1 - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 +
     & noab * (p5b_1 - noab - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p2b
     &_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p2b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h9b-1),2,8,7,6,5,4,3,1,-1.0d0,.false.)
      END IF
      IF ((p2b .le. p3b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h9b_1
     & - 1 + noab * (h8b_1 - 1 + noab * (h7b_1 - 1 + noab * (h6b_1 - 1 +
     & noab * (p5b_1 - noab - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p3b
     &_1 - noab - 1 + nvab * (p2b_1 - noab - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p2b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h9b-1),1,8,7,6,5,4,3,2,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_6_5_3
     &',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_6_5_3',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_6_5_3',5,MA_ERR)
      IF ((p5b .lt. p1b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p1b_2
     & - noab - 1 + nvab * (p5b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h8b_2 - 1
     & + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p1b-1),8,4,3,2,1,7,6,5,-1.0d0,.false.)
      END IF
      IF ((p4b .lt. p1b) .and. (p1b .le. p5b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p1b_2 - noab - 1 + nvab * (p4b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h8b_2 - 1
     & + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+p1b-1)
     &,int_mb(k_range+p5b-1),7,4,3,2,1,8,6,5,1.0d0,.false.)
      END IF
      IF ((p3b .lt. p1b) .and. (p1b .le. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (p3b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h8b_2 - 1
     & + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p1b-1),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p5b-1),6,4,3,2,1,8,7,5,-1.0d0,.false.)
      END IF
      IF ((p1b .le. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p5b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h8b_2 - 1
     & + noab * (h7b_2 - 1 + noab * (h6b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h6b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p1b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p5b-1),5,4,3,2,1,8,7,6,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_6_5_3
     &',6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      nsuperp(3) = 1
      isuperp = 1
      IF (p3b .eq. p4b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      IF (p4b .eq. p5b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      nsubh(1) = 1
      nsubh(2) = 1
      nsubh(3) = 1
      nsubh(4) = 1
      isubh = 1
      IF (h6b .eq. h7b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      IF (h7b .eq. h8b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      IF (h8b .eq. h9b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,144.0d0/FACT
     &ORIAL(nsuperp(1))/FACTORIAL(nsuperp(2))/FACTORIAL(nsuperp(3))/FACT
     &ORIAL(nsubh(1))/FACTORIAL(nsubh(2))/FACTORIAL(nsubh(3))/FACTORIAL(
     &nsubh(4)),dbl_mb(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,
     &1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &6_5_3',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &6_5_3',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_6_5_3',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p1b-1)
     &,int_mb(k_range+p2b-1),2,1,-1.0d0/72.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p1b -
     & noab - 1 + nvab * (p2b - noab - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_6_5_3
     &',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &6_5_3',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_6_6(d_a,k_a_offset,d_b,k_b_offset,d_
     &c,k_c_offset)
C     i1 ( p2 p1 )_yxt + = -1 * Sum ( h4 h5 p3 ) * t ( p2 p3 h4 h5 )_t * i2 ( h4 h5 p1 p3 )_yx
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER p2b
      INTEGER p1b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p3b
      INTEGER h4b
      INTEGER h5b
      INTEGER p2b_1
      INTEGER p3b_1
      INTEGER h4b_1
      INTEGER h5b_1
      INTEGER h4b_2
      INTEGER h5b_2
      INTEGER p1b_2
      INTEGER p3b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsubh(2)
      INTEGER isubh
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO p2b = noab+1,noab+nvab
      DO p1b = noab+1,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+p2b-1)+int_mb(k_spin+p1b-1
     &).ne.4)) THEN
      IF (int_mb(k_spin+p2b-1) .eq. int_mb(k_spin+p1b-1)) THEN
      IF (ieor(int_mb(k_sym+p2b-1),int_mb(k_sym+p1b-1)) .eq. ieor(irrep_
     &y,ieor(irrep_x,irrep_t))) THEN
      dimc = int_mb(k_range+p2b-1) * int_mb(k_range+p1b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_6_6',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p3b = noab+1,noab+nvab
      DO h4b = 1,noab
      DO h5b = h4b,noab
      IF (int_mb(k_spin+p2b-1)+int_mb(k_spin+p3b-1) .eq. int_mb(k_spin+h
     &4b-1)+int_mb(k_spin+h5b-1)) THEN
      IF (ieor(int_mb(k_sym+p2b-1),ieor(int_mb(k_sym+p3b-1),ieor(int_mb(
     &k_sym+h4b-1),int_mb(k_sym+h5b-1)))) .eq. irrep_t) THEN
      CALL TCE_RESTRICTED_4(p2b,p3b,h4b,h5b,p2b_1,p3b_1,h4b_1,h5b_1)
      CALL TCE_RESTRICTED_4(h4b,h5b,p1b,p3b,h4b_2,h5b_2,p1b_2,p3b_2)
      dim_common = int_mb(k_range+p3b-1) * int_mb(k_range+h4b-1) * int_m
     &b(k_range+h5b-1)
      dima_sort = int_mb(k_range+p2b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+p1b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_6_6',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_6_6',2,MA_ERR)
      IF ((p3b .lt. p2b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h5b_1
     & - 1 + noab * (h4b_1 - 1 + noab * (p2b_1 - noab - 1 + nvab * (p3b_
     &1 - noab - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p2b-1),int_mb(k_range+h4b-1),int_mb(k_range+h5b-1)
     &,2,4,3,1,-1.0d0,.false.)
      END IF
      IF ((p2b .le. p3b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h5b_1
     & - 1 + noab * (h4b_1 - 1 + noab * (p3b_1 - noab - 1 + nvab * (p2b_
     &1 - noab - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p2b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+h4b-1),int_mb(k_range+h5b-1)
     &,1,4,3,2,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_6_6',
     &3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_6_6',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_6_6',5,MA_ERR)
      IF ((p3b .lt. p1b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p1b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab 
     &* (h4b_2 - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+p3b-1),int_mb(k_range+p1b-1)
     &,4,2,1,3,-1.0d0,.false.)
      END IF
      IF ((p1b .le. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p1b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab 
     &* (h4b_2 - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+p1b-1),int_mb(k_range+p3b-1)
     &,3,2,1,4,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_6_6',
     &6,MA_ERR)
      nsubh(1) = 1
      nsubh(2) = 1
      isubh = 1
      IF (h4b .eq. h5b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,2.0d0/FACTOR
     &IAL(nsubh(1))/FACTORIAL(nsubh(2)),dbl_mb(k_a_sort),dim_common,dbl_
     &mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &6_6',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &6_6',8,MA_ERR)
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_6_6',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p1b-1)
     &,int_mb(k_range+p2b-1),2,1,-1.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p1b -
     & noab - 1 + nvab * (p2b - noab - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_6_6',
     &10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &6_6',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_6_6_1(d_a,k_a_offset,d_b,k_b_offset,
     &d_c,k_c_offset)
C     i2 ( h4 h5 p1 p3 )_yx + = 1 * Sum ( h7 p6 ) * x ( p6 h7 )_x * y ( h4 h5 h7 p1 p3 p6 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h4b
      INTEGER h5b
      INTEGER p1b
      INTEGER p3b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p6b
      INTEGER h7b
      INTEGER p6b_1
      INTEGER h7b_1
      INTEGER h4b_2
      INTEGER h5b_2
      INTEGER h7b_2
      INTEGER p1b_2
      INTEGER p3b_2
      INTEGER p6b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h4b = 1,noab
      DO h5b = h4b,noab
      DO p1b = noab+1,noab+nvab
      DO p3b = p1b,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h4b-1)+int_mb(k_spin+h5b-1
     &)+int_mb(k_spin+p1b-1)+int_mb(k_spin+p3b-1).ne.8)) THEN
      IF (int_mb(k_spin+h4b-1)+int_mb(k_spin+h5b-1) .eq. int_mb(k_spin+p
     &1b-1)+int_mb(k_spin+p3b-1)) THEN
      IF (ieor(int_mb(k_sym+h4b-1),ieor(int_mb(k_sym+h5b-1),ieor(int_mb(
     &k_sym+p1b-1),int_mb(k_sym+p3b-1)))) .eq. ieor(irrep_y,irrep_x)) TH
     &EN
      dimc = int_mb(k_range+h4b-1) * int_mb(k_range+h5b-1) * int_mb(k_ra
     &nge+p1b-1) * int_mb(k_range+p3b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_6_6_1',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p6b = noab+1,noab+nvab
      DO h7b = 1,noab
      IF (int_mb(k_active+h4b-1)+int_mb(k_active+h5b-1)+int_mb(k_active+
     &h7b-1) .ge. numact) THEN
      IF (int_mb(k_active+p1b-1)+int_mb(k_active+p3b-1)+int_mb(k_active+
     &p6b-1) .ge. numact) THEN
      IF (int_mb(k_spin+p6b-1) .eq. int_mb(k_spin+h7b-1)) THEN
      IF (ieor(int_mb(k_sym+p6b-1),int_mb(k_sym+h7b-1)) .eq. irrep_x) TH
     &EN
      CALL TCE_RESTRICTED_2(p6b,h7b,p6b_1,h7b_1)
      CALL TCE_RESTRICTED_6(h4b,h5b,h7b,p1b,p3b,p6b,h4b_2,h5b_2,h7b_2,p1
     &b_2,p3b_2,p6b_2)
      dim_common = int_mb(k_range+p6b-1) * int_mb(k_range+h7b-1)
      dima_sort = 1
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h4b-1) * int_mb(k_range+h5b-1) * int_mb
     &(k_range+p1b-1) * int_mb(k_range+p3b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_6_6_1',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_6_6_1',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h7b_1
     & - 1 + noab * (p6b_1 - noab - 1)))
      CALL TCE_SORT_2(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p6b-1)
     &,int_mb(k_range+h7b-1),2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_6_6_1
     &',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_6_6_1',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_6_6_1',5,MA_ERR)
      IF ((h7b .lt. h4b) .and. (p6b .lt. p1b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p1b_2 - noab - 1 + nvab * (p6b_2 - noab - 1 
     &+ nvab * (h5b_2 - 1 + noab * (h4b_2 - 1 + noab * (h7b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h4b-1),int_mb(k_range+h5b-1),int_mb(k_range+p6b-1)
     &,int_mb(k_range+p1b-1),int_mb(k_range+p3b-1),6,5,3,2,1,4,1.0d0,.fa
     &lse.)
      END IF
      IF ((h7b .lt. h4b) .and. (p1b .le. p6b) .and. (p6b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (h5b_2 - 1 + noab * (h4b_2 - 1 + noab * (h7b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h4b-1),int_mb(k_range+h5b-1),int_mb(k_range+p1b-1)
     &,int_mb(k_range+p6b-1),int_mb(k_range+p3b-1),6,4,3,2,1,5,-1.0d0,.f
     &alse.)
      END IF
      IF ((h7b .lt. h4b) .and. (p3b .le. p6b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (h5b_2 - 1 + noab * (h4b_2 - 1 + noab * (h7b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h4b-1),int_mb(k_range+h5b-1),int_mb(k_range+p1b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p6b-1),5,4,3,2,1,6,1.0d0,.fa
     &lse.)
      END IF
      IF ((h4b .le. h7b) .and. (h7b .lt. h5b) .and. (p6b .lt. p1b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p1b_2 - noab - 1 + nvab * (p6b_2 - noab - 1 
     &+ nvab * (h5b_2 - 1 + noab * (h7b_2 - 1 + noab * (h4b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h5b-1),int_mb(k_range+p6b-1)
     &,int_mb(k_range+p1b-1),int_mb(k_range+p3b-1),6,5,3,1,2,4,-1.0d0,.f
     &alse.)
      END IF
      IF ((h4b .le. h7b) .and. (h7b .lt. h5b) .and. (p1b .le. p6b) .and.
     & (p6b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (h5b_2 - 1 + noab * (h7b_2 - 1 + noab * (h4b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h5b-1),int_mb(k_range+p1b-1)
     &,int_mb(k_range+p6b-1),int_mb(k_range+p3b-1),6,4,3,1,2,5,1.0d0,.fa
     &lse.)
      END IF
      IF ((h4b .le. h7b) .and. (h7b .lt. h5b) .and. (p3b .le. p6b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (h5b_2 - 1 + noab * (h7b_2 - 1 + noab * (h4b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h7b-1),int_mb(k_range+h5b-1),int_mb(k_range+p1b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p6b-1),5,4,3,1,2,6,-1.0d0,.f
     &alse.)
      END IF
      IF ((h5b .le. h7b) .and. (p6b .lt. p1b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p1b_2 - noab - 1 + nvab * (p6b_2 - noab - 1 
     &+ nvab * (h7b_2 - 1 + noab * (h5b_2 - 1 + noab * (h4b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h7b-1),int_mb(k_range+p6b-1)
     &,int_mb(k_range+p1b-1),int_mb(k_range+p3b-1),6,5,2,1,3,4,1.0d0,.fa
     &lse.)
      END IF
      IF ((h5b .le. h7b) .and. (p1b .le. p6b) .and. (p6b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (h7b_2 - 1 + noab * (h5b_2 - 1 + noab * (h4b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h7b-1),int_mb(k_range+p1b-1)
     &,int_mb(k_range+p6b-1),int_mb(k_range+p3b-1),6,4,2,1,3,5,-1.0d0,.f
     &alse.)
      END IF
      IF ((h5b .le. h7b) .and. (p3b .le. p6b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p6b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (h7b_2 - 1 + noab * (h5b_2 - 1 + noab * (h4b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h7b-1),int_mb(k_range+p1b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p6b-1),5,4,2,1,3,6,1.0d0,.fa
     &lse.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_6_6_1
     &',6,MA_ERR)
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,1.0d0,dbl_mb
     &(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c
     &_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &6_6_1',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &6_6_1',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_6_6_1',9,MA_ERR)
      CALL TCE_SORT_4(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p1b-1),int_mb(k_range+h5b-1),int_mb(k_range+h4b-1)
     &,4,3,2,1,1.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p3b -
     & noab - 1 + nvab * (p1b - noab - 1 + nvab * (h5b - 1 + noab * (h4b
     & - 1)))))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_6_6_1
     &',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &6_6_1',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE OFFSET_eomccsdtq_density1_6_6_1(l_a_offset,k_a_offset,s
     &ize)
C     i2 ( h4 h5 p1 p3 )_yx
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER l_a_offset
      INTEGER k_a_offset
      INTEGER length
      INTEGER addr
      INTEGER h4b
      INTEGER h5b
      INTEGER p1b
      INTEGER p3b
      DOUBLE PRECISION size
      length = 0
      DO h4b = 1,noab
      DO h5b = h4b,noab
      DO p1b = noab+1,noab+nvab
      DO p3b = p1b,noab+nvab
      IF (int_mb(k_spin+h4b-1)+int_mb(k_spin+h5b-1) .eq. int_mb(k_spin+p
     &1b-1)+int_mb(k_spin+p3b-1)) THEN
      IF (ieor(int_mb(k_sym+h4b-1),ieor(int_mb(k_sym+h5b-1),ieor(int_mb(
     &k_sym+p1b-1),int_mb(k_sym+p3b-1)))) .eq. ieor(irrep_y,irrep_x)) TH
     &EN
      IF ((.not.restricted).or.(int_mb(k_spin+h4b-1)+int_mb(k_spin+h5b-1
     &)+int_mb(k_spin+p1b-1)+int_mb(k_spin+p3b-1).ne.8)) THEN
      length = length + 1
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,2*length+1,'noname',l_a_offset,k_a_off
     &set)) CALL ERRQUIT('eomccsdtq_density1_6_6_1',0,MA_ERR)
      dbl_mb(k_a_offset) = dfloat(length)
      addr = 0
      size = 0.0d0
      DO h4b = 1,noab
      DO h5b = h4b,noab
      DO p1b = noab+1,noab+nvab
      DO p3b = p1b,noab+nvab
      IF (int_mb(k_spin+h4b-1)+int_mb(k_spin+h5b-1) .eq. int_mb(k_spin+p
     &1b-1)+int_mb(k_spin+p3b-1)) THEN
      IF (ieor(int_mb(k_sym+h4b-1),ieor(int_mb(k_sym+h5b-1),ieor(int_mb(
     &k_sym+p1b-1),int_mb(k_sym+p3b-1)))) .eq. ieor(irrep_y,irrep_x)) TH
     &EN
      IF ((.not.restricted).or.(int_mb(k_spin+h4b-1)+int_mb(k_spin+h5b-1
     &)+int_mb(k_spin+p1b-1)+int_mb(k_spin+p3b-1).ne.8)) THEN
      addr = addr + 1
      dbl_mb(k_a_offset+addr) = dfloat(p3b - noab - 1 + nvab * (p1b - no
     &ab - 1 + nvab * (h5b - 1 + noab * (h4b - 1))))
      dbl_mb(k_a_offset+length+addr) = size
      size = size + dfloat(int_mb(k_range+h4b-1)) * dfloat(int_mb(k_rang
     &e+h5b-1)) * dfloat(int_mb(k_range+p1b-1)) * dfloat(int_mb(k_range+
     &p3b-1))
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_6_6_2(d_a,k_a_offset,d_b,k_b_offset,
     &d_c,k_c_offset)
C     i2 ( h4 h5 p1 p3 )_yx + = 1/4 * Sum ( h9 h8 p7 p6 ) * x ( p6 p7 h8 h9 )_x * y ( h4 h5 h8 h9 p1 p3 p6 p7 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h4b
      INTEGER h5b
      INTEGER p1b
      INTEGER p3b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p6b
      INTEGER p7b
      INTEGER h8b
      INTEGER h9b
      INTEGER p6b_1
      INTEGER p7b_1
      INTEGER h8b_1
      INTEGER h9b_1
      INTEGER h4b_2
      INTEGER h5b_2
      INTEGER h8b_2
      INTEGER h9b_2
      INTEGER p1b_2
      INTEGER p3b_2
      INTEGER p6b_2
      INTEGER p7b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(2)
      INTEGER isuperp
      INTEGER nsubh(2)
      INTEGER isubh
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h4b = 1,noab
      DO h5b = h4b,noab
      DO p1b = noab+1,noab+nvab
      DO p3b = p1b,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h4b-1)+int_mb(k_spin+h5b-1
     &)+int_mb(k_spin+p1b-1)+int_mb(k_spin+p3b-1).ne.8)) THEN
      IF (int_mb(k_spin+h4b-1)+int_mb(k_spin+h5b-1) .eq. int_mb(k_spin+p
     &1b-1)+int_mb(k_spin+p3b-1)) THEN
      IF (ieor(int_mb(k_sym+h4b-1),ieor(int_mb(k_sym+h5b-1),ieor(int_mb(
     &k_sym+p1b-1),int_mb(k_sym+p3b-1)))) .eq. ieor(irrep_y,irrep_x)) TH
     &EN
      dimc = int_mb(k_range+h4b-1) * int_mb(k_range+h5b-1) * int_mb(k_ra
     &nge+p1b-1) * int_mb(k_range+p3b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_6_6_2',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p6b = noab+1,noab+nvab
      DO p7b = p6b,noab+nvab
      DO h8b = 1,noab
      DO h9b = h8b,noab
      IF (int_mb(k_active+h4b-1)+int_mb(k_active+h5b-1)+int_mb(k_active+
     &h8b-1)+int_mb(k_active+h9b-1) .ge. numacq) THEN
      IF (int_mb(k_active+p1b-1)+int_mb(k_active+p3b-1)+int_mb(k_active+
     &p6b-1)+int_mb(k_active+p7b-1) .ge. numacq) THEN
      IF (int_mb(k_spin+p6b-1)+int_mb(k_spin+p7b-1) .eq. int_mb(k_spin+h
     &8b-1)+int_mb(k_spin+h9b-1)) THEN
      IF (ieor(int_mb(k_sym+p6b-1),ieor(int_mb(k_sym+p7b-1),ieor(int_mb(
     &k_sym+h8b-1),int_mb(k_sym+h9b-1)))) .eq. irrep_x) THEN
      CALL TCE_RESTRICTED_4(p6b,p7b,h8b,h9b,p6b_1,p7b_1,h8b_1,h9b_1)
      CALL TCE_RESTRICTED_8(h4b,h5b,h8b,h9b,p1b,p3b,p6b,p7b,h4b_2,h5b_2,
     &h8b_2,h9b_2,p1b_2,p3b_2,p6b_2,p7b_2)
      dim_common = int_mb(k_range+p6b-1) * int_mb(k_range+p7b-1) * int_m
     &b(k_range+h8b-1) * int_mb(k_range+h9b-1)
      dima_sort = 1
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h4b-1) * int_mb(k_range+h5b-1) * int_mb
     &(k_range+p1b-1) * int_mb(k_range+p3b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_6_6_2',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_6_6_2',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h9b_1
     & - 1 + noab * (h8b_1 - 1 + noab * (p7b_1 - noab - 1 + nvab * (p6b_
     &1 - noab - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p6b-1)
     &,int_mb(k_range+p7b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1)
     &,4,3,2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_6_6_2
     &',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_6_6_2',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_6_6_2',5,MA_ERR)
      IF ((h9b .lt. h4b) .and. (p7b .lt. p1b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p1b_2 - noab - 1 + nvab * (p7b_2 - noab - 1 
     &+ nvab * (p6b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h4b_2 - 1
     & + noab * (h9b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h4b-1),int_mb(k_range+h5b-1)
     &,int_mb(k_range+p6b-1),int_mb(k_range+p7b-1),int_mb(k_range+p1b-1)
     &,int_mb(k_range+p3b-1),8,7,4,3,2,1,6,5,1.0d0,.false.)
      END IF
      IF ((h9b .lt. h4b) .and. (p6b .lt. p1b) .and. (p1b .le. p7b) .and.
     & (p7b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (p6b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h4b_2 - 1
     & + noab * (h9b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h4b-1),int_mb(k_range+h5b-1)
     &,int_mb(k_range+p6b-1),int_mb(k_range+p1b-1),int_mb(k_range+p7b-1)
     &,int_mb(k_range+p3b-1),8,6,4,3,2,1,7,5,-1.0d0,.false.)
      END IF
      IF ((h9b .lt. h4b) .and. (p6b .lt. p1b) .and. (p3b .le. p7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (p6b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h4b_2 - 1
     & + noab * (h9b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h4b-1),int_mb(k_range+h5b-1)
     &,int_mb(k_range+p6b-1),int_mb(k_range+p1b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p7b-1),7,6,4,3,2,1,8,5,1.0d0,.false.)
      END IF
      IF ((h9b .lt. h4b) .and. (p1b .le. p6b) .and. (p7b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p6b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h4b_2 - 1
     & + noab * (h9b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h4b-1),int_mb(k_range+h5b-1)
     &,int_mb(k_range+p1b-1),int_mb(k_range+p6b-1),int_mb(k_range+p7b-1)
     &,int_mb(k_range+p3b-1),8,5,4,3,2,1,7,6,1.0d0,.false.)
      END IF
      IF ((h9b .lt. h4b) .and. (p1b .le. p6b) .and. (p6b .lt. p3b) .and.
     & (p3b .le. p7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p6b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h4b_2 - 1
     & + noab * (h9b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h4b-1),int_mb(k_range+h5b-1)
     &,int_mb(k_range+p1b-1),int_mb(k_range+p6b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p7b-1),7,5,4,3,2,1,8,6,-1.0d0,.false.)
      END IF
      IF ((h9b .lt. h4b) .and. (p3b .le. p6b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h4b_2 - 1
     & + noab * (h9b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h4b-1),int_mb(k_range+h5b-1)
     &,int_mb(k_range+p1b-1),int_mb(k_range+p3b-1),int_mb(k_range+p6b-1)
     &,int_mb(k_range+p7b-1),6,5,4,3,2,1,8,7,1.0d0,.false.)
      END IF
      IF ((h8b .lt. h4b) .and. (h4b .le. h9b) .and. (h9b .lt. h5b) .and.
     & (p7b .lt. p1b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p1b_2 - noab - 1 + nvab * (p7b_2 - noab - 1 
     &+ nvab * (p6b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h9b_2 - 1
     & + noab * (h4b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h4b-1),int_mb(k_range+h9b-1),int_mb(k_range+h5b-1)
     &,int_mb(k_range+p6b-1),int_mb(k_range+p7b-1),int_mb(k_range+p1b-1)
     &,int_mb(k_range+p3b-1),8,7,4,2,3,1,6,5,-1.0d0,.false.)
      END IF
      IF ((h8b .lt. h4b) .and. (h4b .le. h9b) .and. (h9b .lt. h5b) .and.
     & (p6b .lt. p1b) .and. (p1b .le. p7b) .and. (p7b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (p6b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h9b_2 - 1
     & + noab * (h4b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h4b-1),int_mb(k_range+h9b-1),int_mb(k_range+h5b-1)
     &,int_mb(k_range+p6b-1),int_mb(k_range+p1b-1),int_mb(k_range+p7b-1)
     &,int_mb(k_range+p3b-1),8,6,4,2,3,1,7,5,1.0d0,.false.)
      END IF
      IF ((h8b .lt. h4b) .and. (h4b .le. h9b) .and. (h9b .lt. h5b) .and.
     & (p6b .lt. p1b) .and. (p3b .le. p7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (p6b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h9b_2 - 1
     & + noab * (h4b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h4b-1),int_mb(k_range+h9b-1),int_mb(k_range+h5b-1)
     &,int_mb(k_range+p6b-1),int_mb(k_range+p1b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p7b-1),7,6,4,2,3,1,8,5,-1.0d0,.false.)
      END IF
      IF ((h8b .lt. h4b) .and. (h4b .le. h9b) .and. (h9b .lt. h5b) .and.
     & (p1b .le. p6b) .and. (p7b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p6b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h9b_2 - 1
     & + noab * (h4b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h4b-1),int_mb(k_range+h9b-1),int_mb(k_range+h5b-1)
     &,int_mb(k_range+p1b-1),int_mb(k_range+p6b-1),int_mb(k_range+p7b-1)
     &,int_mb(k_range+p3b-1),8,5,4,2,3,1,7,6,-1.0d0,.false.)
      END IF
      IF ((h8b .lt. h4b) .and. (h4b .le. h9b) .and. (h9b .lt. h5b) .and.
     & (p1b .le. p6b) .and. (p6b .lt. p3b) .and. (p3b .le. p7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p6b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h9b_2 - 1
     & + noab * (h4b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h4b-1),int_mb(k_range+h9b-1),int_mb(k_range+h5b-1)
     &,int_mb(k_range+p1b-1),int_mb(k_range+p6b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p7b-1),7,5,4,2,3,1,8,6,1.0d0,.false.)
      END IF
      IF ((h8b .lt. h4b) .and. (h4b .le. h9b) .and. (h9b .lt. h5b) .and.
     & (p3b .le. p6b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h9b_2 - 1
     & + noab * (h4b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h4b-1),int_mb(k_range+h9b-1),int_mb(k_range+h5b-1)
     &,int_mb(k_range+p1b-1),int_mb(k_range+p3b-1),int_mb(k_range+p6b-1)
     &,int_mb(k_range+p7b-1),6,5,4,2,3,1,8,7,-1.0d0,.false.)
      END IF
      IF ((h8b .lt. h4b) .and. (h5b .le. h9b) .and. (p7b .lt. p1b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p1b_2 - noab - 1 + nvab * (p7b_2 - noab - 1 
     &+ nvab * (p6b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h5b_2 - 1
     & + noab * (h4b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h4b-1),int_mb(k_range+h5b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p6b-1),int_mb(k_range+p7b-1),int_mb(k_range+p1b-1)
     &,int_mb(k_range+p3b-1),8,7,3,2,4,1,6,5,1.0d0,.false.)
      END IF
      IF ((h8b .lt. h4b) .and. (h5b .le. h9b) .and. (p6b .lt. p1b) .and.
     & (p1b .le. p7b) .and. (p7b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (p6b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h5b_2 - 1
     & + noab * (h4b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h4b-1),int_mb(k_range+h5b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p6b-1),int_mb(k_range+p1b-1),int_mb(k_range+p7b-1)
     &,int_mb(k_range+p3b-1),8,6,3,2,4,1,7,5,-1.0d0,.false.)
      END IF
      IF ((h8b .lt. h4b) .and. (h5b .le. h9b) .and. (p6b .lt. p1b) .and.
     & (p3b .le. p7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (p6b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h5b_2 - 1
     & + noab * (h4b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h4b-1),int_mb(k_range+h5b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p6b-1),int_mb(k_range+p1b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p7b-1),7,6,3,2,4,1,8,5,1.0d0,.false.)
      END IF
      IF ((h8b .lt. h4b) .and. (h5b .le. h9b) .and. (p1b .le. p6b) .and.
     & (p7b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p6b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h5b_2 - 1
     & + noab * (h4b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h4b-1),int_mb(k_range+h5b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p1b-1),int_mb(k_range+p6b-1),int_mb(k_range+p7b-1)
     &,int_mb(k_range+p3b-1),8,5,3,2,4,1,7,6,1.0d0,.false.)
      END IF
      IF ((h8b .lt. h4b) .and. (h5b .le. h9b) .and. (p1b .le. p6b) .and.
     & (p6b .lt. p3b) .and. (p3b .le. p7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p6b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h5b_2 - 1
     & + noab * (h4b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h4b-1),int_mb(k_range+h5b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p1b-1),int_mb(k_range+p6b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p7b-1),7,5,3,2,4,1,8,6,-1.0d0,.false.)
      END IF
      IF ((h8b .lt. h4b) .and. (h5b .le. h9b) .and. (p3b .le. p6b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h5b_2 - 1
     & + noab * (h4b_2 - 1 + noab * (h8b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h8b-1)
     &,int_mb(k_range+h4b-1),int_mb(k_range+h5b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p1b-1),int_mb(k_range+p3b-1),int_mb(k_range+p6b-1)
     &,int_mb(k_range+p7b-1),6,5,3,2,4,1,8,7,1.0d0,.false.)
      END IF
      IF ((h4b .le. h8b) .and. (h9b .lt. h5b) .and. (p7b .lt. p1b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p1b_2 - noab - 1 + nvab * (p7b_2 - noab - 1 
     &+ nvab * (p6b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h9b_2 - 1
     & + noab * (h8b_2 - 1 + noab * (h4b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h9b-1),int_mb(k_range+h5b-1)
     &,int_mb(k_range+p6b-1),int_mb(k_range+p7b-1),int_mb(k_range+p1b-1)
     &,int_mb(k_range+p3b-1),8,7,4,1,3,2,6,5,1.0d0,.false.)
      END IF
      IF ((h4b .le. h8b) .and. (h9b .lt. h5b) .and. (p6b .lt. p1b) .and.
     & (p1b .le. p7b) .and. (p7b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (p6b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h9b_2 - 1
     & + noab * (h8b_2 - 1 + noab * (h4b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h9b-1),int_mb(k_range+h5b-1)
     &,int_mb(k_range+p6b-1),int_mb(k_range+p1b-1),int_mb(k_range+p7b-1)
     &,int_mb(k_range+p3b-1),8,6,4,1,3,2,7,5,-1.0d0,.false.)
      END IF
      IF ((h4b .le. h8b) .and. (h9b .lt. h5b) .and. (p6b .lt. p1b) .and.
     & (p3b .le. p7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (p6b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h9b_2 - 1
     & + noab * (h8b_2 - 1 + noab * (h4b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h9b-1),int_mb(k_range+h5b-1)
     &,int_mb(k_range+p6b-1),int_mb(k_range+p1b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p7b-1),7,6,4,1,3,2,8,5,1.0d0,.false.)
      END IF
      IF ((h4b .le. h8b) .and. (h9b .lt. h5b) .and. (p1b .le. p6b) .and.
     & (p7b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p6b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h9b_2 - 1
     & + noab * (h8b_2 - 1 + noab * (h4b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h9b-1),int_mb(k_range+h5b-1)
     &,int_mb(k_range+p1b-1),int_mb(k_range+p6b-1),int_mb(k_range+p7b-1)
     &,int_mb(k_range+p3b-1),8,5,4,1,3,2,7,6,1.0d0,.false.)
      END IF
      IF ((h4b .le. h8b) .and. (h9b .lt. h5b) .and. (p1b .le. p6b) .and.
     & (p6b .lt. p3b) .and. (p3b .le. p7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p6b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h9b_2 - 1
     & + noab * (h8b_2 - 1 + noab * (h4b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h9b-1),int_mb(k_range+h5b-1)
     &,int_mb(k_range+p1b-1),int_mb(k_range+p6b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p7b-1),7,5,4,1,3,2,8,6,-1.0d0,.false.)
      END IF
      IF ((h4b .le. h8b) .and. (h9b .lt. h5b) .and. (p3b .le. p6b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h5b_2 - 1 + noab * (h9b_2 - 1
     & + noab * (h8b_2 - 1 + noab * (h4b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h9b-1),int_mb(k_range+h5b-1)
     &,int_mb(k_range+p1b-1),int_mb(k_range+p3b-1),int_mb(k_range+p6b-1)
     &,int_mb(k_range+p7b-1),6,5,4,1,3,2,8,7,1.0d0,.false.)
      END IF
      IF ((h4b .le. h8b) .and. (h8b .lt. h5b) .and. (h5b .le. h9b) .and.
     & (p7b .lt. p1b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p1b_2 - noab - 1 + nvab * (p7b_2 - noab - 1 
     &+ nvab * (p6b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h5b_2 - 1
     & + noab * (h8b_2 - 1 + noab * (h4b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h5b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p6b-1),int_mb(k_range+p7b-1),int_mb(k_range+p1b-1)
     &,int_mb(k_range+p3b-1),8,7,3,1,4,2,6,5,-1.0d0,.false.)
      END IF
      IF ((h4b .le. h8b) .and. (h8b .lt. h5b) .and. (h5b .le. h9b) .and.
     & (p6b .lt. p1b) .and. (p1b .le. p7b) .and. (p7b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (p6b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h5b_2 - 1
     & + noab * (h8b_2 - 1 + noab * (h4b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h5b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p6b-1),int_mb(k_range+p1b-1),int_mb(k_range+p7b-1)
     &,int_mb(k_range+p3b-1),8,6,3,1,4,2,7,5,1.0d0,.false.)
      END IF
      IF ((h4b .le. h8b) .and. (h8b .lt. h5b) .and. (h5b .le. h9b) .and.
     & (p6b .lt. p1b) .and. (p3b .le. p7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (p6b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h5b_2 - 1
     & + noab * (h8b_2 - 1 + noab * (h4b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h5b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p6b-1),int_mb(k_range+p1b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p7b-1),7,6,3,1,4,2,8,5,-1.0d0,.false.)
      END IF
      IF ((h4b .le. h8b) .and. (h8b .lt. h5b) .and. (h5b .le. h9b) .and.
     & (p1b .le. p6b) .and. (p7b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p6b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h5b_2 - 1
     & + noab * (h8b_2 - 1 + noab * (h4b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h5b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p1b-1),int_mb(k_range+p6b-1),int_mb(k_range+p7b-1)
     &,int_mb(k_range+p3b-1),8,5,3,1,4,2,7,6,-1.0d0,.false.)
      END IF
      IF ((h4b .le. h8b) .and. (h8b .lt. h5b) .and. (h5b .le. h9b) .and.
     & (p1b .le. p6b) .and. (p6b .lt. p3b) .and. (p3b .le. p7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p6b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h5b_2 - 1
     & + noab * (h8b_2 - 1 + noab * (h4b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h5b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p1b-1),int_mb(k_range+p6b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p7b-1),7,5,3,1,4,2,8,6,1.0d0,.false.)
      END IF
      IF ((h4b .le. h8b) .and. (h8b .lt. h5b) .and. (h5b .le. h9b) .and.
     & (p3b .le. p6b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h5b_2 - 1
     & + noab * (h8b_2 - 1 + noab * (h4b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h8b-1),int_mb(k_range+h5b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p1b-1),int_mb(k_range+p3b-1),int_mb(k_range+p6b-1)
     &,int_mb(k_range+p7b-1),6,5,3,1,4,2,8,7,-1.0d0,.false.)
      END IF
      IF ((h5b .le. h8b) .and. (p7b .lt. p1b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p1b_2 - noab - 1 + nvab * (p7b_2 - noab - 1 
     &+ nvab * (p6b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h8b_2 - 1
     & + noab * (h5b_2 - 1 + noab * (h4b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p6b-1),int_mb(k_range+p7b-1),int_mb(k_range+p1b-1)
     &,int_mb(k_range+p3b-1),8,7,2,1,4,3,6,5,1.0d0,.false.)
      END IF
      IF ((h5b .le. h8b) .and. (p6b .lt. p1b) .and. (p1b .le. p7b) .and.
     & (p7b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (p6b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h8b_2 - 1
     & + noab * (h5b_2 - 1 + noab * (h4b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p6b-1),int_mb(k_range+p1b-1),int_mb(k_range+p7b-1)
     &,int_mb(k_range+p3b-1),8,6,2,1,4,3,7,5,-1.0d0,.false.)
      END IF
      IF ((h5b .le. h8b) .and. (p6b .lt. p1b) .and. (p3b .le. p7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (p6b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h8b_2 - 1
     & + noab * (h5b_2 - 1 + noab * (h4b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p6b-1),int_mb(k_range+p1b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p7b-1),7,6,2,1,4,3,8,5,1.0d0,.false.)
      END IF
      IF ((h5b .le. h8b) .and. (p1b .le. p6b) .and. (p7b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p3b_2
     & - noab - 1 + nvab * (p7b_2 - noab - 1 + nvab * (p6b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h8b_2 - 1
     & + noab * (h5b_2 - 1 + noab * (h4b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p1b-1),int_mb(k_range+p6b-1),int_mb(k_range+p7b-1)
     &,int_mb(k_range+p3b-1),8,5,2,1,4,3,7,6,1.0d0,.false.)
      END IF
      IF ((h5b .le. h8b) .and. (p1b .le. p6b) .and. (p6b .lt. p3b) .and.
     & (p3b .le. p7b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p6b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h8b_2 - 1
     & + noab * (h5b_2 - 1 + noab * (h4b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p1b-1),int_mb(k_range+p6b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p7b-1),7,5,2,1,4,3,8,6,-1.0d0,.false.)
      END IF
      IF ((h5b .le. h8b) .and. (p3b .le. p6b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p7b_2
     & - noab - 1 + nvab * (p6b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h8b_2 - 1
     & + noab * (h5b_2 - 1 + noab * (h4b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h4b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h8b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p1b-1),int_mb(k_range+p3b-1),int_mb(k_range+p6b-1)
     &,int_mb(k_range+p7b-1),6,5,2,1,4,3,8,7,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_6_6_2
     &',6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      isuperp = 1
      IF (p6b .eq. p7b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      nsubh(1) = 1
      nsubh(2) = 1
      isubh = 1
      IF (h8b .eq. h9b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,4.0d0/FACTOR
     &IAL(nsuperp(1))/FACTORIAL(nsuperp(2))/FACTORIAL(nsubh(1))/FACTORIA
     &L(nsubh(2)),dbl_mb(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_commo
     &n,1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &6_6_2',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &6_6_2',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_6_6_2',9,MA_ERR)
      CALL TCE_SORT_4(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p1b-1),int_mb(k_range+h5b-1),int_mb(k_range+h4b-1)
     &,4,3,2,1,1.0d0/4.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p3b -
     & noab - 1 + nvab * (p1b - noab - 1 + nvab * (h5b - 1 + noab * (h4b
     & - 1)))))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_6_6_2
     &',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &6_6_2',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_6_7(d_a,k_a_offset,d_b,k_b_offset,d_
     &c,k_c_offset)
C     i1 ( p2 p1 )_yxt + = -1/6 * Sum ( h5 h6 h7 p3 p4 ) * t ( p2 p3 p4 h5 h6 h7 )_t * i2 ( h5 h6 h7 p1 p3 p4 )_yx
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER p2b
      INTEGER p1b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p3b
      INTEGER p4b
      INTEGER h5b
      INTEGER h6b
      INTEGER h7b
      INTEGER p2b_1
      INTEGER p3b_1
      INTEGER p4b_1
      INTEGER h5b_1
      INTEGER h6b_1
      INTEGER h7b_1
      INTEGER h5b_2
      INTEGER h6b_2
      INTEGER h7b_2
      INTEGER p1b_2
      INTEGER p3b_2
      INTEGER p4b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(2)
      INTEGER isuperp
      INTEGER nsubh(3)
      INTEGER isubh
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      DOUBLE PRECISION FACTORIAL
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO p2b = noab+1,noab+nvab
      DO p1b = noab+1,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+p2b-1)+int_mb(k_spin+p1b-1
     &).ne.4)) THEN
      IF (int_mb(k_spin+p2b-1) .eq. int_mb(k_spin+p1b-1)) THEN
      IF (ieor(int_mb(k_sym+p2b-1),int_mb(k_sym+p1b-1)) .eq. ieor(irrep_
     &y,ieor(irrep_x,irrep_t))) THEN
      dimc = int_mb(k_range+p2b-1) * int_mb(k_range+p1b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_6_7',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      DO h5b = 1,noab
      DO h6b = h5b,noab
      DO h7b = h6b,noab
      IF (int_mb(k_active+p2b-1)+int_mb(k_active+p3b-1)+int_mb(k_active+
     &p4b-1) .ge. numact) THEN
      IF (int_mb(k_active+h5b-1)+int_mb(k_active+h6b-1)+int_mb(k_active+
     &h7b-1) .ge. numact) THEN
      IF (int_mb(k_spin+p2b-1)+int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1)
     & .eq. int_mb(k_spin+h5b-1)+int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b-
     &1)) THEN
      IF (ieor(int_mb(k_sym+p2b-1),ieor(int_mb(k_sym+p3b-1),ieor(int_mb(
     &k_sym+p4b-1),ieor(int_mb(k_sym+h5b-1),ieor(int_mb(k_sym+h6b-1),int
     &_mb(k_sym+h7b-1)))))) .eq. irrep_t) THEN
      CALL TCE_RESTRICTED_6(p2b,p3b,p4b,h5b,h6b,h7b,p2b_1,p3b_1,p4b_1,h5
     &b_1,h6b_1,h7b_1)
      CALL TCE_RESTRICTED_6(h5b,h6b,h7b,p1b,p3b,p4b,h5b_2,h6b_2,h7b_2,p1
     &b_2,p3b_2,p4b_2)
      dim_common = int_mb(k_range+p3b-1) * int_mb(k_range+p4b-1) * int_m
     &b(k_range+h5b-1) * int_mb(k_range+h6b-1) * int_mb(k_range+h7b-1)
      dima_sort = int_mb(k_range+p2b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+p1b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_6_7',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_6_7',2,MA_ERR)
      IF ((p4b .lt. p2b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h7b_1
     & - 1 + noab * (h6b_1 - 1 + noab * (h5b_1 - 1 + noab * (p2b_1 - noa
     &b - 1 + nvab * (p4b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p2b-1),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),3,6,5,4,2,1,1.0d0,.fa
     &lse.)
      END IF
      IF ((p3b .lt. p2b) .and. (p2b .le. p4b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h7b_1
     & - 1 + noab * (h6b_1 - 1 + noab * (h5b_1 - 1 + noab * (p4b_1 - noa
     &b - 1 + nvab * (p2b_1 - noab - 1 + nvab * (p3b_1 - noab - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p2b-1),int_mb(k_range+p4b-1),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),2,6,5,4,3,1,-1.0d0,.f
     &alse.)
      END IF
      IF ((p2b .le. p3b)) THEN
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h7b_1
     & - 1 + noab * (h6b_1 - 1 + noab * (h5b_1 - 1 + noab * (p4b_1 - noa
     &b - 1 + nvab * (p3b_1 - noab - 1 + nvab * (p2b_1 - noab - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p2b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),1,6,5,4,3,2,1.0d0,.fa
     &lse.)
      END IF
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_6_7',
     &3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_6_7',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_6_7',5,MA_ERR)
      IF ((p4b .lt. p1b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p1b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h7b_2 - 1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p1b-1),6,3,2,1,5,4,1.0d0,.fa
     &lse.)
      END IF
      IF ((p3b .lt. p1b) .and. (p1b .le. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p1b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (h7b_2 - 1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p1b-1),int_mb(k_range+p4b-1),5,3,2,1,6,4,-1.0d0,.f
     &alse.)
      END IF
      IF ((p1b .le. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (h7b_2 - 1 + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))
      CALL TCE_SORT_6(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+p1b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),4,3,2,1,6,5,1.0d0,.fa
     &lse.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_6_7',
     &6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      isuperp = 1
      IF (p3b .eq. p4b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      nsubh(1) = 1
      nsubh(2) = 1
      nsubh(3) = 1
      isubh = 1
      IF (h5b .eq. h6b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      IF (h6b .eq. h7b) THEN
      nsubh(isubh) = nsubh(isubh) + 1
      ELSE
      isubh = isubh + 1
      END IF
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,12.0d0/FACTO
     &RIAL(nsuperp(1))/FACTORIAL(nsuperp(2))/FACTORIAL(nsubh(1))/FACTORI
     &AL(nsubh(2))/FACTORIAL(nsubh(3)),dbl_mb(k_a_sort),dim_common,dbl_m
     &b(k_b_sort),dim_common,1.0d0,dbl_mb(k_c_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &6_7',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &6_7',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_6_7',9,MA_ERR)
      CALL TCE_SORT_2(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p1b-1)
     &,int_mb(k_range+p2b-1),2,1,-1.0d0/6.0d0,.false.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p1b -
     & noab - 1 + nvab * (p2b - noab - 1)))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_6_7',
     &10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &6_7',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE eomccsdtq_density1_6_7_1(d_a,k_a_offset,d_b,k_b_offset,
     &d_c,k_c_offset)
C     i2 ( h5 h6 h7 p1 p3 p4 )_yx + = 1 * Sum ( h9 p8 ) * x ( p8 h9 )_x * y ( h5 h6 h7 h9 p1 p3 p4 p8 )_y
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER h5b
      INTEGER h6b
      INTEGER h7b
      INTEGER p1b
      INTEGER p3b
      INTEGER p4b
      INTEGER dimc
      INTEGER l_c_sort
      INTEGER k_c_sort
      INTEGER p8b
      INTEGER h9b
      INTEGER p8b_1
      INTEGER h9b_1
      INTEGER h5b_2
      INTEGER h6b_2
      INTEGER h7b_2
      INTEGER h9b_2
      INTEGER p1b_2
      INTEGER p3b_2
      INTEGER p4b_2
      INTEGER p8b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_a_sort
      INTEGER k_a_sort
      INTEGER l_a
      INTEGER k_a
      INTEGER l_b_sort
      INTEGER k_b_sort
      INTEGER l_b
      INTEGER k_b
      INTEGER l_c
      INTEGER k_c
      INTEGER NXTVAL
      EXTERNAL NXTVAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTVAL(nprocs)
      DO h5b = 1,noab
      DO h6b = h5b,noab
      DO h7b = h6b,noab
      DO p1b = noab+1,noab+nvab
      DO p3b = p1b,noab+nvab
      DO p4b = p3b,noab+nvab
      IF (next .eq. count) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h5b-1)+int_mb(k_spin+h6b-1
     &)+int_mb(k_spin+h7b-1)+int_mb(k_spin+p1b-1)+int_mb(k_spin+p3b-1)+i
     &nt_mb(k_spin+p4b-1).ne.12)) THEN
      IF (int_mb(k_spin+h5b-1)+int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b-1)
     & .eq. int_mb(k_spin+p1b-1)+int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-
     &1)) THEN
      IF (ieor(int_mb(k_sym+h5b-1),ieor(int_mb(k_sym+h6b-1),ieor(int_mb(
     &k_sym+h7b-1),ieor(int_mb(k_sym+p1b-1),ieor(int_mb(k_sym+p3b-1),int
     &_mb(k_sym+p4b-1)))))) .eq. ieor(irrep_y,irrep_x)) THEN
      dimc = int_mb(k_range+h5b-1) * int_mb(k_range+h6b-1) * int_mb(k_ra
     &nge+h7b-1) * int_mb(k_range+p1b-1) * int_mb(k_range+p3b-1) * int_m
     &b(k_range+p4b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c_sort,k_c_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_6_7_1',0,MA_ERR)
      CALL DFILL(two*dimc,0.0d0,dbl_mb(k_c_sort),1)
      DO p8b = noab+1,noab+nvab
      DO h9b = 1,noab
      IF (int_mb(k_active+h5b-1)+int_mb(k_active+h6b-1)+int_mb(k_active+
     &h7b-1)+int_mb(k_active+h9b-1) .ge. numacq) THEN
      IF (int_mb(k_active+p1b-1)+int_mb(k_active+p3b-1)+int_mb(k_active+
     &p4b-1)+int_mb(k_active+p8b-1) .ge. numacq) THEN
      IF (int_mb(k_spin+p8b-1) .eq. int_mb(k_spin+h9b-1)) THEN
      IF (ieor(int_mb(k_sym+p8b-1),int_mb(k_sym+h9b-1)) .eq. irrep_x) TH
     &EN
      CALL TCE_RESTRICTED_2(p8b,h9b,p8b_1,h9b_1)
      CALL TCE_RESTRICTED_8(h5b,h6b,h7b,h9b,p1b,p3b,p4b,p8b,h5b_2,h6b_2,
     &h7b_2,h9b_2,p1b_2,p3b_2,p4b_2,p8b_2)
      dim_common = int_mb(k_range+p8b-1) * int_mb(k_range+h9b-1)
      dima_sort = 1
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+h5b-1) * int_mb(k_range+h6b-1) * int_mb
     &(k_range+h7b-1) * int_mb(k_range+p1b-1) * int_mb(k_range+p3b-1) * 
     &int_mb(k_range+p4b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a_sort,k_a_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_6_7_1',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dima,'noname',l_a,k_a)) CALL ERRQU
     &IT('eomccsdtq_density1_6_7_1',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,dbl_mb(k_a_offset),(h9b_1
     & - 1 + noab * (p8b_1 - noab - 1)))
      CALL TCE_SORT_2(dbl_mb(k_a),dbl_mb(k_a_sort),int_mb(k_range+p8b-1)
     &,int_mb(k_range+h9b-1),2,1,1.0d0,.false.)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('eomccsdtq_density1_6_7_1
     &',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b_sort,k_b_sort)) 
     &CALL ERRQUIT('eomccsdtq_density1_6_7_1',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimb,'noname',l_b,k_b)) CALL ERRQU
     &IT('eomccsdtq_density1_6_7_1',5,MA_ERR)
      IF ((h9b .lt. h5b) .and. (p8b .lt. p1b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (p8b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 1
     & + noab * (h5b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1)
     &,int_mb(k_range+p8b-1),int_mb(k_range+p1b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),8,7,6,4,3,2,1,5,1.0d0,.false.)
      END IF
      IF ((h9b .lt. h5b) .and. (p1b .le. p8b) .and. (p8b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p8b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 1
     & + noab * (h5b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1)
     &,int_mb(k_range+p1b-1),int_mb(k_range+p8b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),8,7,5,4,3,2,1,6,-1.0d0,.false.)
      END IF
      IF ((h9b .lt. h5b) .and. (p3b .le. p8b) .and. (p8b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 1
     & + noab * (h5b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1)
     &,int_mb(k_range+p1b-1),int_mb(k_range+p3b-1),int_mb(k_range+p8b-1)
     &,int_mb(k_range+p4b-1),8,6,5,4,3,2,1,7,1.0d0,.false.)
      END IF
      IF ((h9b .lt. h5b) .and. (p4b .le. p8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 1
     & + noab * (h5b_2 - 1 + noab * (h9b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h9b-1)
     &,int_mb(k_range+h5b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1)
     &,int_mb(k_range+p1b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p8b-1),7,6,5,4,3,2,1,8,-1.0d0,.false.)
      END IF
      IF ((h5b .le. h9b) .and. (h9b .lt. h6b) .and. (p8b .lt. p1b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (p8b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 1
     & + noab * (h9b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1)
     &,int_mb(k_range+p8b-1),int_mb(k_range+p1b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),8,7,6,4,3,1,2,5,-1.0d0,.false.)
      END IF
      IF ((h5b .le. h9b) .and. (h9b .lt. h6b) .and. (p1b .le. p8b) .and.
     & (p8b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p8b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 1
     & + noab * (h9b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1)
     &,int_mb(k_range+p1b-1),int_mb(k_range+p8b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),8,7,5,4,3,1,2,6,1.0d0,.false.)
      END IF
      IF ((h5b .le. h9b) .and. (h9b .lt. h6b) .and. (p3b .le. p8b) .and.
     & (p8b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 1
     & + noab * (h9b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1)
     &,int_mb(k_range+p1b-1),int_mb(k_range+p3b-1),int_mb(k_range+p8b-1)
     &,int_mb(k_range+p4b-1),8,6,5,4,3,1,2,7,-1.0d0,.false.)
      END IF
      IF ((h5b .le. h9b) .and. (h9b .lt. h6b) .and. (p4b .le. p8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h6b_2 - 1
     & + noab * (h9b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h9b-1),int_mb(k_range+h6b-1),int_mb(k_range+h7b-1)
     &,int_mb(k_range+p1b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p8b-1),7,6,5,4,3,1,2,8,1.0d0,.false.)
      END IF
      IF ((h6b .le. h9b) .and. (h9b .lt. h7b) .and. (p8b .lt. p1b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (p8b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h9b_2 - 1
     & + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h9b-1),int_mb(k_range+h7b-1)
     &,int_mb(k_range+p8b-1),int_mb(k_range+p1b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),8,7,6,4,2,1,3,5,1.0d0,.false.)
      END IF
      IF ((h6b .le. h9b) .and. (h9b .lt. h7b) .and. (p1b .le. p8b) .and.
     & (p8b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p8b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h9b_2 - 1
     & + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h9b-1),int_mb(k_range+h7b-1)
     &,int_mb(k_range+p1b-1),int_mb(k_range+p8b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),8,7,5,4,2,1,3,6,-1.0d0,.false.)
      END IF
      IF ((h6b .le. h9b) .and. (h9b .lt. h7b) .and. (p3b .le. p8b) .and.
     & (p8b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h9b_2 - 1
     & + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h9b-1),int_mb(k_range+h7b-1)
     &,int_mb(k_range+p1b-1),int_mb(k_range+p3b-1),int_mb(k_range+p8b-1)
     &,int_mb(k_range+p4b-1),8,6,5,4,2,1,3,7,1.0d0,.false.)
      END IF
      IF ((h6b .le. h9b) .and. (h9b .lt. h7b) .and. (p4b .le. p8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h7b_2 - 1 + noab * (h9b_2 - 1
     & + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h9b-1),int_mb(k_range+h7b-1)
     &,int_mb(k_range+p1b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p8b-1),7,6,5,4,2,1,3,8,-1.0d0,.false.)
      END IF
      IF ((h7b .le. h9b) .and. (p8b .lt. p1b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p1b_2 - noab - 1 
     &+ nvab * (p8b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h7b_2 - 1
     & + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p8b-1),int_mb(k_range+p1b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),8,7,6,3,2,1,4,5,-1.0d0,.false.)
      END IF
      IF ((h7b .le. h9b) .and. (p1b .le. p8b) .and. (p8b .lt. p3b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p3b_2 - noab - 1 + nvab * (p8b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h7b_2 - 1
     & + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p1b-1),int_mb(k_range+p8b-1),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),8,7,5,3,2,1,4,6,1.0d0,.false.)
      END IF
      IF ((h7b .le. h9b) .and. (p3b .le. p8b) .and. (p8b .lt. p4b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p4b_2
     & - noab - 1 + nvab * (p8b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h7b_2 - 1
     & + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p1b-1),int_mb(k_range+p3b-1),int_mb(k_range+p8b-1)
     &,int_mb(k_range+p4b-1),8,6,5,3,2,1,4,7,-1.0d0,.false.)
      END IF
      IF ((h7b .le. h9b) .and. (p4b .le. p8b)) THEN
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,dbl_mb(k_b_offset),(p8b_2
     & - noab - 1 + nvab * (p4b_2 - noab - 1 + nvab * (p3b_2 - noab - 1 
     &+ nvab * (p1b_2 - noab - 1 + nvab * (h9b_2 - 1 + noab * (h7b_2 - 1
     & + noab * (h6b_2 - 1 + noab * (h5b_2 - 1)))))))))
      CALL TCE_SORT_8(dbl_mb(k_b),dbl_mb(k_b_sort),int_mb(k_range+h5b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h7b-1),int_mb(k_range+h9b-1)
     &,int_mb(k_range+p1b-1),int_mb(k_range+p3b-1),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p8b-1),7,6,5,3,2,1,4,8,1.0d0,.false.)
      END IF
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('eomccsdtq_density1_6_7_1
     &',6,MA_ERR)
      CALL TCE_DGEMM('T','N',dima_sort,dimb_sort,dim_common,1.0d0,dbl_mb
     &(k_a_sort),dim_common,dbl_mb(k_b_sort),dim_common,1.0d0,dbl_mb(k_c
     &_sort),dima_sort)
      IF (.not.MA_POP_STACK(l_b_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &6_7_1',7,MA_ERR)
      IF (.not.MA_POP_STACK(l_a_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &6_7_1',8,MA_ERR)
      END IF
      END IF
      END IF
      END IF
      END IF
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,two*dimc,'noname',l_c,k_c)) CALL ERRQU
     &IT('eomccsdtq_density1_6_7_1',9,MA_ERR)
      CALL TCE_SORT_6(dbl_mb(k_c_sort),dbl_mb(k_c),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+p1b-1),int_mb(k_range+h7b-1)
     &,int_mb(k_range+h6b-1),int_mb(k_range+h5b-1),6,5,4,3,2,1,1.0d0,.fa
     &lse.)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,dbl_mb(k_c_offset),(p4b -
     & noab - 1 + nvab * (p3b - noab - 1 + nvab * (p1b - noab - 1 + nvab
     & * (h7b - 1 + noab * (h6b - 1 + noab * (h5b - 1)))))))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('eomccsdtq_density1_6_7_1
     &',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_c_sort)) CALL ERRQUIT('eomccsdtq_density1_
     &6_7_1',11,MA_ERR)
      END IF
      END IF
      END IF
      next = NXTVAL(nprocs)
      END IF
      count = count + 1
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      next = NXTVAL(-nprocs)
      call GA_SYNC()
      RETURN
      END
      SUBROUTINE OFFSET_eomccsdtq_density1_6_7_1(l_a_offset,k_a_offset,s
     &ize)
C     i2 ( h5 h6 h7 p1 p3 p4 )_yx
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER l_a_offset
      INTEGER k_a_offset
      INTEGER length
      INTEGER addr
      INTEGER h5b
      INTEGER h6b
      INTEGER h7b
      INTEGER p1b
      INTEGER p3b
      INTEGER p4b
      DOUBLE PRECISION size
      length = 0
      DO h5b = 1,noab
      DO h6b = h5b,noab
      DO h7b = h6b,noab
      DO p1b = noab+1,noab+nvab
      DO p3b = p1b,noab+nvab
      DO p4b = p3b,noab+nvab
      IF (int_mb(k_spin+h5b-1)+int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b-1)
     & .eq. int_mb(k_spin+p1b-1)+int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-
     &1)) THEN
      IF (ieor(int_mb(k_sym+h5b-1),ieor(int_mb(k_sym+h6b-1),ieor(int_mb(
     &k_sym+h7b-1),ieor(int_mb(k_sym+p1b-1),ieor(int_mb(k_sym+p3b-1),int
     &_mb(k_sym+p4b-1)))))) .eq. ieor(irrep_y,irrep_x)) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h5b-1)+int_mb(k_spin+h6b-1
     &)+int_mb(k_spin+h7b-1)+int_mb(k_spin+p1b-1)+int_mb(k_spin+p3b-1)+i
     &nt_mb(k_spin+p4b-1).ne.12)) THEN
      length = length + 1
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,2*length+1,'noname',l_a_offset,k_a_off
     &set)) CALL ERRQUIT('eomccsdtq_density1_6_7_1',0,MA_ERR)
      dbl_mb(k_a_offset) = dfloat(length)
      addr = 0
      size = 0.0d0
      DO h5b = 1,noab
      DO h6b = h5b,noab
      DO h7b = h6b,noab
      DO p1b = noab+1,noab+nvab
      DO p3b = p1b,noab+nvab
      DO p4b = p3b,noab+nvab
      IF (int_mb(k_spin+h5b-1)+int_mb(k_spin+h6b-1)+int_mb(k_spin+h7b-1)
     & .eq. int_mb(k_spin+p1b-1)+int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-
     &1)) THEN
      IF (ieor(int_mb(k_sym+h5b-1),ieor(int_mb(k_sym+h6b-1),ieor(int_mb(
     &k_sym+h7b-1),ieor(int_mb(k_sym+p1b-1),ieor(int_mb(k_sym+p3b-1),int
     &_mb(k_sym+p4b-1)))))) .eq. ieor(irrep_y,irrep_x)) THEN
      IF ((.not.restricted).or.(int_mb(k_spin+h5b-1)+int_mb(k_spin+h6b-1
     &)+int_mb(k_spin+h7b-1)+int_mb(k_spin+p1b-1)+int_mb(k_spin+p3b-1)+i
     &nt_mb(k_spin+p4b-1).ne.12)) THEN
      addr = addr + 1
      dbl_mb(k_a_offset+addr) = dfloat(p4b - noab - 1 + nvab * (p3b - no
     &ab - 1 + nvab * (p1b - noab - 1 + nvab * (h7b - 1 + noab * (h6b - 
     &1 + noab * (h5b - 1))))))
      dbl_mb(k_a_offset+length+addr) = size
      size = size + dfloat(int_mb(k_range+h5b-1)) * dfloat(int_mb(k_rang
     &e+h6b-1)) * dfloat(int_mb(k_range+h7b-1)) * dfloat(int_mb(k_range+
     &p1b-1)) * dfloat(int_mb(k_range+p3b-1)) * dfloat(int_mb(k_range+p4
     &b-1))
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      END DO
      END DO
      RETURN
      END
